using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using Config;
using Config.ConfigCells;
using Config.ConfigCells.Character;
using Config.EventConfig;
using GameData.ArchiveData;
using GameData.Common;
using GameData.DLC;
using GameData.DLC.FiveLoong;
using GameData.DLC.Shared;
using GameData.DomainEvents;
using GameData.Domains.Adventure;
using GameData.Domains.Building;
using GameData.Domains.Character;
using GameData.Domains.Character.Ai;
using GameData.Domains.Character.Ai.GeneralAction;
using GameData.Domains.Character.Ai.GeneralAction.HealthDemand;
using GameData.Domains.Character.Ai.GeneralAction.StudyDemand;
using GameData.Domains.Character.Ai.GeneralAction.WealthDemand;
using GameData.Domains.Character.Ai.PrioritizedAction;
using GameData.Domains.Character.AvatarSystem;
using GameData.Domains.Character.AvatarSystem.AvatarRes;
using GameData.Domains.Character.Creation;
using GameData.Domains.Character.Display;
using GameData.Domains.Character.Filters;
using GameData.Domains.Character.Relation;
using GameData.Domains.Character.Relation.RelationTree;
using GameData.Domains.Character.SortFilter;
using GameData.Domains.Character.TemporaryModification;
using GameData.Domains.Combat;
using GameData.Domains.CombatSkill;
using GameData.Domains.Extra;
using GameData.Domains.Global;
using GameData.Domains.Information;
using GameData.Domains.Information.Collection;
using GameData.Domains.Item;
using GameData.Domains.Item.Display;
using GameData.Domains.Item.Filters;
using GameData.Domains.LifeRecord;
using GameData.Domains.Map;
using GameData.Domains.Map.Filters;
using GameData.Domains.Merchant;
using GameData.Domains.Organization;
using GameData.Domains.Organization.Display;
using GameData.Domains.Organization.SettlementPrisonRecord;
using GameData.Domains.Organization.SettlementTreasuryRecord;
using GameData.Domains.SpecialEffect;
using GameData.Domains.SpecialEffect.CombatSkill.Xuehoujiao.BreakBodyEffect;
using GameData.Domains.Taiwu;
using GameData.Domains.Taiwu.Profession;
using GameData.Domains.Taiwu.Profession.SkillsData;
using GameData.Domains.Taiwu.VillagerRole;
using GameData.Domains.TaiwuEvent.DisplayEvent;
using GameData.Domains.TaiwuEvent.Enum;
using GameData.Domains.TaiwuEvent.EventManager;
using GameData.Domains.TaiwuEvent.InteractOfLoveEventHelper;
using GameData.Domains.TaiwuEvent.MonthlyEventActions;
using GameData.Domains.TaiwuEvent.MonthlyEventActions.CustomActions;
using GameData.Domains.World;
using GameData.Domains.World.MonthlyEvent;
using GameData.Domains.World.Notification;
using GameData.Domains.World.SectMainStory;
using GameData.Domains.World.TravelingEvent;
using GameData.GameDataBridge;
using GameData.Serializer;
using GameData.Utilities;
using Redzen.Random;

namespace GameData.Domains.TaiwuEvent.EventHelper;

public static class EventHelper
{
	public static Dictionary<short, string> MoveRandomEnemyJumpEventGuid = new Dictionary<short, string>
	{
		{ 228, "e4835244-9901-4c8d-80ba-18b9c7310c18" },
		{ 229, "de29ec19-84b5-4cc9-9859-23b2ec0d255f" },
		{ 230, "829bb8f6-966a-4a47-814f-6b4f2729ef17" },
		{ 231, "cb6bb616-b5c1-4902-998d-8d65610f482f" },
		{ 233, "b8e15a2b-f3f4-4e80-a2d7-99ae248fc66c" },
		{ 234, "3ccb3e23-7f9d-4392-bc60-fffcd7e4d1cd" },
		{ 235, "130836b5-c9bc-4800-b961-b8cbd739eac5" },
		{ 236, "1fb6a1d3-1084-45b4-8423-ef8acb2d8e38" },
		{ 238, "9b94e8de-80e0-4105-a068-489dc1e6e9cc" },
		{ 239, "fb48449c-9336-4801-b13c-06c38e46e740" },
		{ 240, "4f2b9c83-c19f-44ee-99f6-ed3cc86c9815" },
		{ 241, "7f04ed2f-9a9e-4164-b98f-1c9590562eca" },
		{ 243, "35b50c60-a724-4a63-813f-580d52977872" },
		{ 244, "68a8d5bd-166f-48bb-a41e-f8d109f1b19b" },
		{ 245, "26395e58-566f-4e3c-8d4e-5495dbc0632f" },
		{ 246, "a90dabd3-8f6d-4d43-99c2-4d46bc4af808" },
		{ 247, "297fb526-281c-40a2-b1eb-ecb51b1c459c" },
		{ 248, "2556aec4-2638-41ea-b11f-46a4a04e8757" },
		{ 249, "f475e2cf-ffbc-4780-afbc-fb8eeb9479c7" },
		{ 250, "ea9e1517-87a3-4023-ba69-2034c85b74db" },
		{ 251, "c5d0e1ad-f16a-4615-9ecb-05f2986c6091" },
		{ 252, "97e3c5d3-7e0b-450f-bd57-f938f0d5201b" },
		{ 253, "01e3ec80-7be1-4b43-bc31-4699628c5539" },
		{ 254, "5274d441-83ec-48d6-aa4c-f2c94aebf913" },
		{ 255, "b68c2d72-1081-4d60-85ca-8b2b07094d71" },
		{ 256, "79f11d66-2972-4560-ade3-a23633ed1a08" },
		{ 257, "34333c2e-df18-49ec-abd4-62146d7411dc" },
		{ 258, "e4e70a33-751a-4fd4-a82c-d123f93260b1" },
		{ 259, "d40e27db-8de3-4874-9dd2-af9bf537a4f6" },
		{ 260, "baa6f5a6-4801-4b2f-87a9-0c5fd6a3cb9a" },
		{ 261, "25a5a5df-fb89-46f4-8afe-f7bdac9bb468" },
		{ 263, "dea34223-b90b-491d-899b-5b1bc716dc19" },
		{ 264, "36c988e9-e1d3-47f6-98be-3d08f491d183" },
		{ 265, "73435956-f499-45e2-ad45-1988f2b32fe0" },
		{ 266, "209d8830-03d3-4a61-ae61-b36e430f1e00" },
		{ 268, "5344eab2-a231-45e8-86bf-ff76688b6727" },
		{ 269, "dd4efbce-acfd-440c-84c7-a959309cfe32" },
		{ 270, "e0bc2771-2dfa-4245-81c0-c3beab54026d" },
		{ 271, "710beedf-f267-4567-9867-6b022f5dca82" },
		{ 273, "0b60dc6e-5269-479d-b857-37028c1b3462" },
		{ 274, "fdfa2398-cdcd-4033-b52f-48c78a47e472" },
		{ 275, "0766c278-5762-4fbf-b7da-59ee346d424c" },
		{ 276, "a5b95af9-e510-4bbc-a91e-900999ff114e" },
		{ 278, "a0aeaebf-7ac0-48aa-9f87-aff6e739123a" },
		{ 279, "00779153-0248-48bb-a6aa-19845461a846" },
		{ 280, "fed9a143-e07f-490f-83b5-55ee4eadd176" },
		{ 281, "0e181bbf-53ac-47a3-8e01-9692c939cc5b" },
		{ 283, "1611f230-a7c8-4613-bf7a-5ac62030b650" },
		{ 284, "7900eb84-d6e5-4e2b-a1bc-2b5bbdbbda82" },
		{ 285, "a3dcc57b-5d6a-4ecf-8727-906e6028f181" },
		{ 286, "06ba173d-350c-41f8-a8b9-5660714f4ef0" },
		{ 288, "d7171b6c-fc38-4098-8252-c36bc635b0ab" },
		{ 289, "a7dfb021-9bf7-4241-8dc8-ff09ea47b494" },
		{ 290, "9973b56c-ea97-4097-a21d-15d980d26ff7" },
		{ 291, "1c7cb340-8653-4427-b8de-161b7a70f7f4" },
		{ 293, "cde022ea-9573-40f9-9965-e2da41554974" },
		{ 294, "2ca5e8b1-ac45-4720-a484-15c69319707b" },
		{ 295, "5be0620b-b17f-4b1c-b27b-84b3af5f82e8" },
		{ 296, "3748d1c3-e3ea-407c-895f-5d53066ad9d4" },
		{ 298, "08d266e5-6626-4471-aa4d-4f165b5ac285" },
		{ 299, "08d266e5-6626-4471-aa4d-4f165b5ac285" },
		{ 300, "08d266e5-6626-4471-aa4d-4f165b5ac285" },
		{ 301, "08d266e5-6626-4471-aa4d-4f165b5ac285" },
		{ 302, "08d266e5-6626-4471-aa4d-4f165b5ac285" },
		{ 303, "08d266e5-6626-4471-aa4d-4f165b5ac285" },
		{ 304, "08d266e5-6626-4471-aa4d-4f165b5ac285" },
		{ 305, "08d266e5-6626-4471-aa4d-4f165b5ac285" },
		{ 306, "08d266e5-6626-4471-aa4d-4f165b5ac285" },
		{ 455, "3d5434be-60ec-4395-8360-cee1a6629915" },
		{ 456, "3d5434be-60ec-4395-8360-cee1a6629915" },
		{ 457, "3d5434be-60ec-4395-8360-cee1a6629915" },
		{ 458, "3d5434be-60ec-4395-8360-cee1a6629915" },
		{ 459, "3d5434be-60ec-4395-8360-cee1a6629915" },
		{ 460, "3d5434be-60ec-4395-8360-cee1a6629915" },
		{ 461, "3d5434be-60ec-4395-8360-cee1a6629915" },
		{ 462, "3d5434be-60ec-4395-8360-cee1a6629915" },
		{ 307, "20f2d380-e446-4aba-b685-5beb0b04c806" },
		{ 308, "23098923-d2e5-4589-ab35-dda6fdd21453" },
		{ 309, "8e0d6d2d-0667-48e4-ac2b-8cc5cb84a363" },
		{ 310, "bbbd3f55-d037-436f-8faa-8607ea99a5f3" },
		{ 311, "714e4b64-f05e-4551-852e-a8e214c5aaa2" },
		{ 312, "61f1f95f-a493-44f0-b01b-4a36837b6c7a" },
		{ 313, "feb54d11-1b6e-426b-9315-b7a50a0df31f" },
		{ 314, "a9bbb4d5-b2ea-46d8-b961-58adb6c6cbd4" },
		{ 315, "d93da011-275e-44e4-a100-a4ad55c0c64d" }
	};

	public static Dictionary<short, string> TravelRandomEnemyJumpEventGuid = new Dictionary<short, string>
	{
		{ 228, "82487bbe-c4bd-43a4-9c56-64834582fab8" },
		{ 229, "2baf9294-db88-44f3-ac08-98380984bbd3" },
		{ 230, "d5375f1e-c96c-4e62-a215-e5748fa1eea7" },
		{ 231, "bbd727a0-14a2-4d7a-a64d-9428c583ca0a" },
		{ 232, "348cb8ac-add6-4f67-884d-c80aa00a9da8" },
		{ 233, "b99394fc-922c-4102-98e7-f44553067c22" },
		{ 234, "b451a178-d349-470a-84f1-b0f81401667b" },
		{ 235, "493a8fc8-8d0d-4587-b206-28012df94099" },
		{ 236, "6ff13787-0f11-4117-9dfd-9b6da70215e7" },
		{ 237, "9e2a0bb6-a6da-48b1-92e6-08e3868c7d42" },
		{ 238, "407c3e01-b306-4dde-ad7c-876dd49dfad2" },
		{ 239, "4e66f7b1-ff06-46db-b783-ab80a8c1315e" },
		{ 240, "7dfdc0c8-6959-4279-8151-224e88a7454d" },
		{ 241, "f17c0842-0dd9-4e3e-95f5-b59c99126a00" },
		{ 242, "597f4046-f138-458e-b0ec-4041de64c4e4" },
		{ 243, "60db4f2a-05e7-46d1-807c-0b7bd92b092b" },
		{ 244, "5296013e-af33-43d8-9ef6-1433c66e8861" },
		{ 245, "e4d7db34-b135-4be0-b4db-3697e0634b56" },
		{ 246, "8499c645-10ed-4747-904b-266241c25e81" },
		{ 247, "065b4f72-1bd4-432c-8e7a-cdd64941c115" },
		{ 248, "c3bc1477-02d6-48ac-a79d-89f500a8ca78" },
		{ 249, "5eb05594-c8ec-4a2a-86c1-484be16be030" },
		{ 250, "1a9376f8-f362-4193-8955-668bf736e4d5" },
		{ 251, "0d306c78-84ef-4976-9d37-d97b407c2c5a" },
		{ 252, "20d0a144-b9de-4386-a0b8-ad56953463d4" },
		{ 253, "46363ac7-6006-41d0-9135-62a043cbdee7" },
		{ 254, "8005a96b-70c6-435d-aa57-7f988070566b" },
		{ 255, "f8f75d81-c5ee-4376-ac3e-536abfbd87ad" },
		{ 256, "1a1aaedd-349f-4a86-9036-d83fbe6625dd" },
		{ 257, "be1ffe07-81d7-44cc-81c0-9536e2bdb483" },
		{ 258, "c92c786a-d764-406d-a7e8-ec6992c540f3" },
		{ 259, "2efe7a51-34bd-4fe7-85c6-b94493f4af4f" },
		{ 260, "2a314ada-02e5-4444-a322-c661794f8e2a" },
		{ 261, "f3dc3376-406b-4d5a-a78a-5e7aff3dff99" },
		{ 262, "c63b51c0-5f98-4bec-80f1-239251c03e7a" },
		{ 263, "931b90f9-b937-453e-8403-1ec96d3115fe" },
		{ 264, "468ffb0f-cd13-4bb3-9170-64ae8e1bca80" },
		{ 265, "8c4716e3-99f3-44ce-93ea-2e5da4b46c89" },
		{ 266, "a211c835-637c-4149-973f-3d14c5bbed5d" },
		{ 267, "49b7a8cf-a710-4cd2-b9aa-eddc43e78f27" },
		{ 268, "4f9b56bd-ada6-4edf-a25a-089199e1356d" },
		{ 269, "8b24e21b-180c-476f-9bc4-8aa4281e4585" },
		{ 270, "7bb229f8-a788-4124-b151-29dc56a3fc96" },
		{ 271, "76df44a2-a73e-4050-b349-b1c489fcb498" },
		{ 272, "ad496d2a-5456-40c8-a19d-cd7bbaaf866c" },
		{ 273, "0ee6aaaa-2b16-4f1e-a00a-4402ac0418d9" },
		{ 274, "4f7f342b-7540-48ee-8c9c-79a996efaf0b" },
		{ 275, "8658de65-1f86-4948-951e-dbf467803244" },
		{ 276, "ff4490b0-da25-49af-a4a7-be6052cde425" },
		{ 277, "a67f4e47-aea3-4fca-a05f-5c4ca7d81487" },
		{ 278, "d140a8df-9cfb-4a29-b7a6-0cb780b852d8" },
		{ 279, "f34bff58-028d-43ed-bdaa-5c9e3881384a" },
		{ 280, "0f416dfe-ca75-447d-ac61-db4d7ed48851" },
		{ 281, "92e0624b-74aa-4a9c-8ee8-db580046ccec" },
		{ 282, "4ec27b24-6ae3-4202-bd7d-dc5bafc3dff9" },
		{ 283, "082993b7-22ec-4c96-ac66-bac581098cba" },
		{ 284, "c9eb98e5-8dae-4ff2-b6f9-a068401ca1c1" },
		{ 285, "d88ea862-f862-4dce-98ed-999eb04d470a" },
		{ 286, "b30f1cb9-4e15-4308-990d-665070a989e0" },
		{ 287, "8ac28f4f-f89a-4e14-99d9-a846e5aef1c5" },
		{ 288, "1fd57a7a-e488-4e84-87e3-073afe98f824" },
		{ 289, "c5afe457-4e20-4e52-a10e-c36af959edba" },
		{ 290, "bf2ad4cd-8cb1-4dfe-9e0d-ccc74f426065" },
		{ 291, "23519bbc-337f-46ee-bf10-0c50e95920a5" },
		{ 292, "c4401489-24a7-4469-99a1-d7212d6ec2a2" },
		{ 293, "e2142814-17a3-4075-8b11-6679361487bf" },
		{ 294, "8fff4bd2-d1e9-402c-beb9-a42c25dc5e66" },
		{ 295, "60d7d120-2396-4244-b80d-8d573630e2ed" },
		{ 296, "3403934a-7aee-4c17-837b-88e785d8848e" },
		{ 297, "28062193-c6bd-4b51-a445-7190c098c872" },
		{ 298, "4e712350-5cd0-423a-9e90-5ae781d4a92c" },
		{ 299, "4e712350-5cd0-423a-9e90-5ae781d4a92c" },
		{ 300, "4e712350-5cd0-423a-9e90-5ae781d4a92c" },
		{ 301, "4e712350-5cd0-423a-9e90-5ae781d4a92c" },
		{ 302, "4e712350-5cd0-423a-9e90-5ae781d4a92c" },
		{ 303, "4e712350-5cd0-423a-9e90-5ae781d4a92c" },
		{ 304, "4e712350-5cd0-423a-9e90-5ae781d4a92c" },
		{ 305, "4e712350-5cd0-423a-9e90-5ae781d4a92c" },
		{ 306, "4e712350-5cd0-423a-9e90-5ae781d4a92c" },
		{ 307, "f85322ab-1de3-41e6-a271-ac5f50f66a7a" },
		{ 308, "f3de3e3f-52f4-4745-a736-55928656a2b7" },
		{ 309, "91e43627-e2b3-49da-92f4-5327826e492a" },
		{ 310, "9ca0406c-488a-41bc-bee5-ef569fc9a198" },
		{ 311, "6cc429b2-e535-4cfa-a945-073b030fedfe" },
		{ 312, "e108b11e-fdbe-4183-9bf7-065d3baf66aa" },
		{ 313, "828afb1e-6d6d-477d-8ca8-0d57ffcd6319" },
		{ 314, "b71bb8c5-e608-461b-94e4-0f33038359a5" },
		{ 315, "3ad57e1e-c89b-41bf-8692-d4e3d75a6e00" }
	};

	public static List<string> TravelRandomEnemySectEventGuid = new List<string> { "2b76fef8-3491-47d9-9360-9d72a6b3354b", "f5687014-4ef5-4233-af25-05e55b1012ef", "e504bf16-5f6f-4960-ae85-abea51e87e52", "84b18c01-154b-4235-b288-0d3e2697a741", "5a2f3450-4d04-4a01-b669-617628338e16", "333fa625-5773-4b50-9056-562a6f2002d2", "72e08263-ae2c-49ca-8d4a-7dd302f02756", "e92b0a4b-1478-4b24-b107-588c220d6a6b", "2cab1ae2-59b2-4486-adb5-256ed3364651", "f54cdc32-f58f-40ab-93b9-aa926c71ad46" };

	public static Dictionary<short, string> AnimalJumpEventGuid = new Dictionary<short, string>
	{
		{ 210, "0dd523c7-ee08-4de7-9b9c-ecd5c037bbc0" },
		{ 211, "6c617525-85b8-4a66-9f36-f384645428cd" },
		{ 212, "8a0c32b7-9c45-497d-8718-a1bdf698880e" },
		{ 213, "f7a80a81-8119-4ad7-b1ff-1d1565d60ba4" },
		{ 214, "1c630462-6280-4d4e-b720-5bf8a1af798d" },
		{ 215, "bda72b1b-7e0e-4979-9896-f604ebf31ab8" },
		{ 216, "f4515062-ca08-40cf-92d8-675fff26549d" },
		{ 217, "8a21fd69-229e-4670-a672-89797e88587b" },
		{ 218, "02d42ee2-5a2d-48d7-89e8-34bff3c5723e" },
		{ 219, "fbaae3f9-1e04-470d-85a1-325f6415bc15" },
		{ 220, "709046aa-6149-4201-804a-d08420f21acb" },
		{ 221, "b649c809-5f99-4a04-b606-95eea8c5218c" },
		{ 222, "f0cc9fdc-bc40-483b-bc54-58a09f4f2f1c" },
		{ 223, "fbef6554-87ca-45d3-aa93-b7a27a688cfc" },
		{ 224, "7ff3b7de-2662-4327-9854-0ce8fb43992c" },
		{ 225, "6e9f8658-2c54-4876-8fca-8384ede42f03" },
		{ 226, "ef68b0f8-28a6-4fdd-838a-1f502c3946c5" },
		{ 227, "db24b591-a655-43d0-a72d-52225cfcae76" }
	};

	private static readonly int[] WriteOffDebtsByThreatenDebtsBehaviorTypeParam = new int[5] { 14, 18, 20, 16, 12 };

	private static readonly int[] LeadToGoodAiBehaviorTypeParam = new int[5] { 40, 30, 20, 10, 0 };

	private static readonly int[] LeadToEvilAiBehaviorTypeParam = new int[5] { 0, 10, 20, 30, 40 };

	private static readonly string[] LegendaryBookConsumedBookTypeToEvent = new string[14]
	{
		"9446309a-506c-42dc-831f-5d869036cf23", "f838c1f2-3a66-435c-8abf-5c57f58cfd82", "e6403f48-29b1-43ac-9ad9-8f69a6a66c1d", "0f94a061-5684-4ee9-bb07-43c2b345d8d1", "386c3747-2f73-474d-b82f-5eef7e11d2a9", "bd4de433-d370-49e2-aa1a-4224b8f73f8e", "51fe6f61-3e99-482b-830a-e46eb42205a4", "9732eab5-9ffa-4fbc-80d9-682de333dde4", "679650c9-cf09-4ff1-9e52-ed8b35becd1f", "b6117b95-6a03-429b-ac9e-aee10faa6179",
		"008ee5f0-dfe7-46d1-a6d9-9b3b6404cf2b", "663c1b6c-1eb6-4500-b301-cd975f912ea6", "d3cf9cf1-2ced-4f8c-99d0-7c1582752caf", "5d2ecac4-1a3c-4b55-8bb7-103898238a52"
	};

	public static int IdentityExtendFavorResourceCost = 2000;

	public static int IdentityMakeLineAndBridgeAuthorityCost = 1000;

	public static int IdentitySafetyAndCultureMoneyCost = 10000;

	public static int IdentityPoemAndImageAuthorityCost = 1000;

	public static int IdentityMoneyCharityMoneyCost = 100;

	public static int GiveExchangeToolAmount = 3;

	public const int HiringUsedCountAdded = 3;

	public const int SwordTombNormalEffectDivider = 2;

	private static TaiwuEventDomain Domain => DomainManager.TaiwuEvent;

	public static bool CheckRoleBehavior(GameData.Domains.Character.Character character, sbyte behaviorType)
	{
		if (character != null)
		{
			return character.GetBehaviorType() == behaviorType;
		}
		return false;
	}

	public static bool CheckRoleInjured(GameData.Domains.Character.Character character)
	{
		return character?.GetInjuries().HasAnyInjury() ?? false;
	}

	public static bool CheckRoleInnerInjured(GameData.Domains.Character.Character character)
	{
		return character?.GetInjuries().HasAnyInjury(isInnerInjury: true) ?? false;
	}

	public static bool CheckRoleWounded(GameData.Domains.Character.Character character)
	{
		return character?.GetInjuries().HasAnyInjury(isInnerInjury: false) ?? false;
	}

	public static bool CheckRoleBodyPartInjured(GameData.Domains.Character.Character character, sbyte bodyPartType)
	{
		if (character == null)
		{
			return false;
		}
		if (bodyPartType <= -1 || bodyPartType > 7)
		{
			throw new Exception("invalid body part to check injury !");
		}
		(sbyte, sbyte) tuple = character.GetInjuries().Get(bodyPartType);
		return tuple.Item1 > 0 || tuple.Item2 > 0;
	}

	public static bool CheckRoleBodyPartHasTypeInjury(GameData.Domains.Character.Character character, sbyte bodyPartType, bool inner)
	{
		if (character == null)
		{
			return false;
		}
		if (bodyPartType <= -1 || bodyPartType > 7)
		{
			throw new Exception("invalid body part to check injury !");
		}
		(sbyte, sbyte) tuple = character.GetInjuries().Get(bodyPartType);
		return inner ? (tuple.Item2 > 0) : (tuple.Item1 > 0);
	}

	public unsafe static bool CheckCharacterIsPoisoning(GameData.Domains.Character.Character character)
	{
		if (character == null)
		{
			return false;
		}
		for (int i = 0; i < 6; i++)
		{
			if (character.GetPoisoned().Items[i] > 0)
			{
				return true;
			}
		}
		return false;
	}

	public static bool CheckCharacterHasDisorderOfQi(GameData.Domains.Character.Character character)
	{
		if (character == null)
		{
			return false;
		}
		return character.GetDisorderOfQi() > 0;
	}

	public static sbyte GetCharacterInjuryCount(GameData.Domains.Character.Character character)
	{
		Injuries injuries = character.GetInjuries();
		sbyte b = 0;
		for (sbyte b2 = 0; b2 < 7; b2++)
		{
			(sbyte, sbyte) tuple = injuries.Get(b2);
			b += tuple.Item1;
			b += tuple.Item2;
		}
		return b;
	}

	public unsafe static int GetCharacterPoisonCount(GameData.Domains.Character.Character character)
	{
		PoisonInts poisoned = character.GetPoisoned();
		int num = 0;
		for (int i = 0; i < 6; i++)
		{
			num += poisoned.Items[i];
		}
		return num;
	}

	public unsafe static bool CheckCharacterIsPoisoningByType(GameData.Domains.Character.Character character, sbyte type)
	{
		if (character == null)
		{
			return false;
		}
		if (character.GetPoisoned().Items[type] > 0)
		{
			return true;
		}
		return false;
	}

	public static bool CheckHasLeftArm(GameData.Domains.Character.Character character)
	{
		return character?.GetHaveLeftArm() ?? false;
	}

	public static bool CheckHasRightArm(GameData.Domains.Character.Character character)
	{
		return character?.GetHaveRightArm() ?? false;
	}

	public static bool CheckHasLeftLeg(GameData.Domains.Character.Character character)
	{
		return character?.GetHaveLeftLeg() ?? false;
	}

	public static bool CheckHasRightLeg(GameData.Domains.Character.Character character)
	{
		return character?.GetHaveRightLeg() ?? false;
	}

	public static bool CheckHasRelationship(GameData.Domains.Character.Character characterA, GameData.Domains.Character.Character characterB, ushort relationType)
	{
		if (characterA == null || characterB == null)
		{
			return false;
		}
		return DomainManager.Character.HasRelation(characterA.GetId(), characterB.GetId(), relationType);
	}

	public static bool CheckRoleDied(GameData.Domains.Character.Character character)
	{
		if (character == null)
		{
			return false;
		}
		GameData.Domains.Character.Character element;
		return !DomainManager.Character.TryGetElement_Objects(character.GetId(), out element);
	}

	public static bool CheckRoleInfection(GameData.Domains.Character.Character character, sbyte infectionType)
	{
		if (character == null)
		{
			return false;
		}
		short item = -1;
		switch (infectionType)
		{
		case 1:
			item = 217;
			break;
		case 2:
			item = 218;
			break;
		}
		return character.GetFeatureIds().Contains(item);
	}

	public static bool CheckRoleHasVirginity(GameData.Domains.Character.Character character)
	{
		return character?.HasVirginity() ?? false;
	}

	public static bool CheckRoleIsInfertile(GameData.Domains.Character.Character character)
	{
		if (character == null)
		{
			return false;
		}
		return character.GetFertility() <= 0;
	}

	public static bool CheckRoleHasFeature(GameData.Domains.Character.Character character, short templateId)
	{
		if (character == null)
		{
			return false;
		}
		List<short> featureIds = character.GetFeatureIds();
		return featureIds.Contains(templateId);
	}

	public static bool CheckRoleHasTwoWayAdored(int characterId)
	{
		return DomainManager.Character.HasTwoWayRelation(characterId, 16384);
	}

	public static bool CharacterHasConditionToBeShaving(int charId)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			AvatarData avatar = element.GetAvatar();
			bool flag = avatar.GetGrowableElementShowingState(0) && (avatar.FrontHairId != 1 || avatar.BackHairId != 1);
			bool flag2 = avatar.GetGrowableElementShowingState(1) && avatar.GetGrowableElementShowingAbility(1) && avatar.Beard1Id != 1;
			bool flag3 = avatar.GetGrowableElementShowingState(2) && avatar.GetGrowableElementShowingAbility(2) && avatar.Beard2Id != 1;
			bool flag4 = avatar.GetGrowableElementShowingState(6) && avatar.GetGrowableElementShowingAbility(6) && avatar.EyebrowId != 1;
			return flag || flag2 || flag3 || flag4;
		}
		return false;
	}

	public static bool IsGrowableElementShowing(int charId, sbyte growableElementType)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			AvatarData avatar = element.GetAvatar();
			return avatar.GetGrowableElementShowingAbility(growableElementType) && avatar.GetGrowableElementShowingState(growableElementType);
		}
		return false;
	}

	public static bool CanCharacterBeShaved(int charId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return false;
		}
		if (element.GetPhysiologicalAge() < 16)
		{
			return false;
		}
		return true;
	}

	public static bool IsIntelligentCharacter(int charId)
	{
		GameData.Domains.Character.Character element;
		return DomainManager.Character.TryGetElement_Objects(charId, out element) && element.GetCreatingType() == 1;
	}

	public static bool RoleHasAliveSpouse(int charId)
	{
		return DomainManager.Character.GetAliveSpouse(charId) >= 0;
	}

	public static bool IsCharacterNaked(int charId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return false;
		}
		if (element.GetAgeGroup() != 2)
		{
			return false;
		}
		return DomainManager.Character.GetClothingDisplayId(charId) == 0;
	}

	public static bool CanInteractWithType(GameData.Domains.Character.Character character, sbyte type)
	{
		return OrganizationDomain.CanInteractWithType(character, type);
	}

	public static bool IsMeetGender(GameData.Domains.Character.Character character, sbyte gender)
	{
		return character.CheckGenderMeetsRequirement(gender);
	}

	public static bool IsOppositeGender(GameData.Domains.Character.Character characterA, GameData.Domains.Character.Character characterB)
	{
		return GameData.Domains.Character.Character.IsOppositeGender(characterA, characterB);
	}

	public static bool CheckRoleHasGroup(GameData.Domains.Character.Character character)
	{
		if (character == null)
		{
			return false;
		}
		List<int> groupSet = DomainManager.Character.GetGroupSet(Domain.MainThreadDataContext, character.GetId());
		return groupSet.Count > 1;
	}

	public static bool IsParentOfSomeTeammate(GameData.Domains.Character.Character character)
	{
		if (character == null)
		{
			return false;
		}
		foreach (int item in DomainManager.Taiwu.GetGroupCharIds().GetCollection())
		{
			if (DomainManager.Character.TryGetElement_Objects(item, out var element) && element.GetAgeGroup() == 0 && DomainManager.Character.HasRelation(item, character.GetId(), 1))
			{
				return true;
			}
		}
		return false;
	}

	public static bool CanCharacterBeKilled(int charId)
	{
		return charId != DomainManager.Character.GetAvoidDeathCharId();
	}

	public static bool IsCharacterAvoidDeath(EventArgBox argBox, int charId)
	{
		if (argBox == null)
		{
			return false;
		}
		return argBox.GetInt("ProtectedByWeiQiCharacter") == charId;
	}

	public static bool IsXiangshuMinion(int charId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return false;
		}
		return GameData.Domains.Character.Character.IsXiangshuMinion(element.GetTemplateId());
	}

	public static bool IsLocationCanTransferChickenBySpiritualDebt(Location location)
	{
		return DomainManager.Extra.GetAreaSpiritualDebt(location.AreaId) >= 1000;
	}

	public static bool IsBuildingAreaHasBuilding(Location location, short buildingTemplateId, int level = -1)
	{
		List<BuildingBlockData> buildingBlockList = DomainManager.Building.GetBuildingBlockList(location);
		if (buildingBlockList == null || buildingBlockList.Count <= 0)
		{
			return false;
		}
		foreach (BuildingBlockData item in buildingBlockList)
		{
			if (item.TemplateId == buildingTemplateId && item.OperationType != 0 && item.OperationType != 1 && DomainManager.Extra.TryGetElement_BuildingBlockDataEx((ulong)new BuildingBlockKey(location.AreaId, location.BlockId, item.BlockIndex), out var value) && (level == -1 || value.CalcUnlockedLevelCount() == level))
			{
				return true;
			}
		}
		return false;
	}

	public static bool CharacterIsIntelligentCharacter(int charId)
	{
		GameData.Domains.Character.Character element;
		return DomainManager.Character.TryGetElement_Objects(charId, out element) && element.GetCreatingType() == 1;
	}

	public static bool GetCharacterVeilShowState(int charId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		if (element_Objects == null)
		{
			throw new Exception($"can not find character {charId} to GetCharacterVeilShowState");
		}
		return element_Objects.GetAvatar().ShowVeil;
	}

	public static bool HasGuard(GameData.Domains.Character.Character character)
	{
		return DomainManager.Character.HasGuard(character.GetId(), character);
	}

	public static bool IsGraveProtected(int graveId)
	{
		Grave element_Graves = DomainManager.Character.GetElement_Graves(graveId);
		return DomainManager.Character.IsGraveProtected(element_Graves);
	}

	public static bool CheckParentAbandonNewbornChild(int motherCharId, int fatherCharId)
	{
		bool flag = DomainManager.Character.OrgAndMonkTypeAllowMarriage(motherCharId);
		int aliveSpouse = DomainManager.Character.GetAliveSpouse(fatherCharId);
		bool flag2 = DomainManager.Character.OrgAndMonkTypeAllowMarriage(fatherCharId) && (aliveSpouse < 0 || aliveSpouse == motherCharId);
		GameData.Domains.Character.Character element;
		GameData.Domains.Character.Character element2;
		return (!flag || !DomainManager.Character.TryGetElement_Objects(motherCharId, out element) || element.GetKidnapperId() >= 0 || element.IsCompletelyInfected()) && (!flag2 || !DomainManager.Character.TryGetElement_Objects(fatherCharId, out element2) || element2.GetKidnapperId() >= 0 || element2.IsCompletelyInfected());
	}

	public static bool HasBloodGrandParentRelations(int charId, int relatedCharId)
	{
		return DomainManager.Character.HasBloodGrandParentRelations(charId, relatedCharId);
	}

	public static bool CanStartRelation(int charId, int relatedCharId, ushort relationType)
	{
		if (relationType != 16384 && !RelationTypeHelper.AllowAddingRelation(charId, relatedCharId, relationType))
		{
			return false;
		}
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(relatedCharId);
		RelatedCharacter relation = DomainManager.Character.GetRelation(charId, relatedCharId);
		RelatedCharacter relation2 = DomainManager.Character.GetRelation(relatedCharId, charId);
		relation.Favorability = 30000;
		return relationType switch
		{
			32768 => AiHelper.Relation.CanStartRelation_Enemy(relation, element_Objects.GetBehaviorType()), 
			16384 => AiHelper.Relation.CanStartRelation_BoyOrGirlFriend(relation, element_Objects.GetBehaviorType(), relation2, element_Objects2.GetBehaviorType()), 
			1024 => AiHelper.Relation.CanStartRelation_HusbandOrWife(charId, relation, element_Objects.GetBehaviorType(), relatedCharId, relation2, element_Objects2.GetBehaviorType()), 
			8192 => AiHelper.Relation.CanStartRelation_Friend(relation, element_Objects.GetBehaviorType(), relation2, element_Objects2.GetBehaviorType()), 
			512 => AiHelper.Relation.CanStartRelation_SwornBrotherOrSister(relation, element_Objects.GetBehaviorType(), relation2, element_Objects2.GetBehaviorType()), 
			64 => AiHelper.Relation.CanStartRelation_AdoptiveParent(charId, relation, element_Objects.GetCurrAge(), relatedCharId, relation2, element_Objects2.GetCurrAge()), 
			128 => AiHelper.Relation.CanStartRelation_AdoptiveChild(charId, relation, element_Objects.GetCurrAge(), relatedCharId, relation2, element_Objects2.GetCurrAge()), 
			_ => throw new Exception($"Unsupported relation type for starting in event: {relationType}"), 
		};
	}

	public static bool CanEndRelation(int charId, int relatedCharId, ushort relationType)
	{
		RelatedCharacter relation = DomainManager.Character.GetRelation(charId, relatedCharId);
		RelatedCharacter relation2 = DomainManager.Character.GetRelation(relatedCharId, charId);
		return relationType switch
		{
			16384 => RelationType.HasRelation(relation.RelationType, 16384) && RelationType.HasRelation(relation2.RelationType, 16384), 
			32768 => RelationType.HasRelation(relation2.RelationType, 32768), 
			8192 => RelationType.HasRelation(relation.RelationType, 8192), 
			512 => RelationType.HasRelation(relation.RelationType, 512), 
			_ => throw new Exception($"Unsupported relation type for ending in event: {relationType}"), 
		};
	}

	public static bool HasAnyRelation(int charId, int relatedCharId, bool includeGeneral)
	{
		RelatedCharacter relation;
		return DomainManager.Character.TryGetRelation(charId, relatedCharId, out relation) && (includeGeneral || relation.RelationType != 0);
	}

	public static bool HasNominalBloodRelation(int charId, int relatedCharId)
	{
		if (!DomainManager.Character.TryGetRelation(charId, relatedCharId, out var relation))
		{
			return false;
		}
		return DomainManager.Character.HasNominalBloodRelation(charId, relatedCharId, relation);
	}

	public static bool HasBloodExclusionRelation(int charId, int relatedCharId)
	{
		if (!DomainManager.Character.TryGetRelation(charId, relatedCharId, out var relation))
		{
			return false;
		}
		return RelationType.ContainBloodExclusionRelations(relation.RelationType);
	}

	public static bool HasRelationBetweenCharacters(int charId, int relatedCharId, ushort relationType)
	{
		return DomainManager.Character.HasRelation(charId, relatedCharId, relationType);
	}

	public static bool RelationExistsForCharacter(int charId, ushort relationType, bool aliveOnly)
	{
		HashSet<int> relatedCharIds = DomainManager.Character.GetRelatedCharIds(charId, relationType);
		foreach (int item in relatedCharIds)
		{
			if (!aliveOnly || DomainManager.Character.IsCharacterAlive(item))
			{
				return true;
			}
		}
		return false;
	}

	public static bool CheckConfessLoveSucceed(int charId, int relatedCharId)
	{
		DomainManager.Character.TryGetElement_Objects(charId, out var element);
		DomainManager.Character.TryGetElement_Objects(relatedCharId, out var element2);
		if (CheckHasRelationship(element2, element, 16384))
		{
			return true;
		}
		int confessLoveSucceedProb = GetConfessLoveSucceedProb(charId, relatedCharId);
		bool flag = Domain.MainThreadDataContext.Random.CheckPercentProb(confessLoveSucceedProb);
		if (!flag && DomainManager.TaiwuEvent.InteractCheckData != null)
		{
			DomainManager.TaiwuEvent.InteractCheckData.FailPhase = 0;
		}
		return flag;
	}

	public static int GetConfessLoveSucceedProb(int charId, int relatedCharId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(relatedCharId);
		RelatedCharacter relation = DomainManager.Character.GetRelation(charId, relatedCharId);
		RelatedCharacter relation2 = DomainManager.Character.GetRelation(relatedCharId, charId);
		return AiHelper.Relation.GetStartRelationSuccessRate_BoyOrGirlFriend(element_Objects, element_Objects2, relation, relation2, showCheckAnim: true);
	}

	public static bool CheckProposeMarriageSucceed(int charId, int relatedCharId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(relatedCharId);
		RelatedCharacter relation = DomainManager.Character.GetRelation(charId, relatedCharId);
		RelatedCharacter relation2 = DomainManager.Character.GetRelation(relatedCharId, charId);
		int startRelationSuccessRate_HusbandOrWife = AiHelper.Relation.GetStartRelationSuccessRate_HusbandOrWife(element_Objects, element_Objects2, relation, relation2);
		return Domain.MainThreadDataContext.Random.CheckPercentProb(startRelationSuccessRate_HusbandOrWife);
	}

	public unsafe static bool CheckLearnLifeSkillWithInstructionSucceed(GameData.Domains.Character.Character selfChar, short lifeSkillTemplateId)
	{
		Config.LifeSkillItem lifeSkillItem = LifeSkill.Instance[lifeSkillTemplateId];
		LifeSkillShorts lifeSkillAttainments = selfChar.GetLifeSkillAttainments();
		LifeSkillShorts lifeSkillQualifications = selfChar.GetLifeSkillQualifications();
		Personalities personalities = selfChar.GetPersonalities();
		int taughtNewSkillSuccessRate = GameData.Domains.Character.Character.GetTaughtNewSkillSuccessRate(lifeSkillItem.Grade, lifeSkillQualifications.Items[lifeSkillItem.Type], lifeSkillAttainments.Items[lifeSkillItem.Type], personalities.Items[1]);
		return Domain.MainThreadDataContext.Random.CheckPercentProb(taughtNewSkillSuccessRate);
	}

	public unsafe static bool CheckLearnCombatSkillWithInstructionSucceed(GameData.Domains.Character.Character selfChar, short combatSkillTemplateId)
	{
		CombatSkillItem combatSkillItem = Config.CombatSkill.Instance[combatSkillTemplateId];
		CombatSkillShorts combatSkillAttainments = selfChar.GetCombatSkillAttainments();
		CombatSkillShorts combatSkillQualifications = selfChar.GetCombatSkillQualifications();
		Personalities personalities = selfChar.GetPersonalities();
		int taughtNewSkillSuccessRate = GameData.Domains.Character.Character.GetTaughtNewSkillSuccessRate(combatSkillItem.Grade, combatSkillQualifications.Items[combatSkillItem.Type], combatSkillAttainments.Items[combatSkillItem.Type], personalities.Items[1]);
		return Domain.MainThreadDataContext.Random.CheckPercentProb(taughtNewSkillSuccessRate);
	}

	public static void ChangeCombatResources(int charId, sbyte healingCountAdd, sbyte detoxCountAdd)
	{
		CombatResources usableCombatResources = DomainManager.Character.GetUsableCombatResources(charId);
		CombatResources usedCombatResources = DomainManager.Character.GetUsedCombatResources(charId);
		healingCountAdd = (sbyte)Math.Clamp(healingCountAdd, -usedCombatResources.HealingCount, usableCombatResources.HealingCount);
		detoxCountAdd = (sbyte)Math.Clamp(detoxCountAdd, -usedCombatResources.DetoxCount, usableCombatResources.DetoxCount);
		DomainManager.Character.UseCombatResources(Domain.MainThreadDataContext, charId, EHealActionType.Healing, healingCountAdd);
		DomainManager.Character.UseCombatResources(Domain.MainThreadDataContext, charId, EHealActionType.Detox, detoxCountAdd);
	}

	public static void RecoverHealCombatResources(int charId)
	{
		DomainManager.Character.RecoverHealCombatResources(Domain.MainThreadDataContext, charId);
	}

	public static void RecoverDetoxCombatResources(int charId)
	{
		DomainManager.Character.RecoverDetoxCombatResources(Domain.MainThreadDataContext, charId);
	}

	public static void RandomChangeEquipmentDurability(GameData.Domains.Character.Character character, sbyte itemType, bool isAdd, float percent)
	{
		DomainManager.Character.RandomChangeEquipmentDurability(Domain.MainThreadDataContext, character, itemType, isAdd, percent);
	}

	public static bool CheckConfessionLoveOptionIsVisible(int charId)
	{
		if (!CheckMainStoryLineProgress(6))
		{
			return false;
		}
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(DomainManager.Taiwu.GetTaiwuCharId());
		GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(charId);
		if (element_Objects == null || element_Objects2 == null)
		{
			return false;
		}
		if (CheckRespondLoveOptionIsVisible(charId))
		{
			return false;
		}
		if (GetRoleAgeAvailableForLove(element_Objects) && GetRoleAgeAvailableForLove(element_Objects2) && CheckHasRelationship(element_Objects, element_Objects2, 8192))
		{
			if (CheckHasRelationship(element_Objects, element_Objects2, 16384) && CheckHasRelationship(element_Objects2, element_Objects, 16384))
			{
				return false;
			}
			if (CheckHasRelationship(element_Objects, element_Objects2, 2048) || CheckHasRelationship(element_Objects2, element_Objects, 2048))
			{
				return false;
			}
			if (HasNominalBloodRelation(element_Objects.GetId(), element_Objects2.GetId()))
			{
				return false;
			}
			if (HasBloodExclusionRelation(element_Objects.GetId(), element_Objects2.GetId()) && !CheckHasRelationship(element_Objects, element_Objects2, 1024))
			{
				return false;
			}
			return true;
		}
		return false;
	}

	public static bool CheckRespondLoveOptionIsVisible(int charId)
	{
		if (!CheckMainStoryLineProgress(6))
		{
			return false;
		}
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(DomainManager.Taiwu.GetTaiwuCharId());
		if (element_Objects2 == null || element_Objects == null)
		{
			return false;
		}
		if (!CheckHasRelationship(element_Objects, element_Objects2, 16384))
		{
			return false;
		}
		if (CheckHasRelationship(element_Objects2, element_Objects, 16384) && CheckHasRelationship(element_Objects, element_Objects2, 16384))
		{
			return false;
		}
		return true;
	}

	public static bool CheckCharacterNearYixiang(GameData.Domains.Character.Character character)
	{
		Location forceKindLocation = DomainManager.Character.GetForceKindLocation();
		if (character.IsNearbyLocation(forceKindLocation, 3))
		{
			return true;
		}
		Location forceRebelLocation = DomainManager.Character.GetForceRebelLocation();
		if (character.IsNearbyLocation(forceRebelLocation, 3))
		{
			return true;
		}
		return false;
	}

	public static bool CheckCharacterIsXiangshuInfected(GameData.Domains.Character.Character character)
	{
		List<short> featureIds = character.GetFeatureIds();
		if (featureIds.Contains(217) || featureIds.Contains(218))
		{
			return true;
		}
		return false;
	}

	public static bool CheckCharacterIsLegendaryInfected(GameData.Domains.Character.Character character)
	{
		sbyte legendaryBookOwnerState = character.GetLegendaryBookOwnerState();
		if (legendaryBookOwnerState == 1 || legendaryBookOwnerState == 2)
		{
			return true;
		}
		return false;
	}

	public static bool IsCharacterHealthFull(GameData.Domains.Character.Character character)
	{
		short leftMaxHealth = DomainManager.Character.GetLeftMaxHealth(character.GetId());
		short health = character.GetHealth();
		return leftMaxHealth == health;
	}

	public static bool IsCharacterRefuseAppointment(GameData.Domains.Character.Character character)
	{
		BasePrioritizedAction action;
		return DomainManager.Character.TryGetCharacterPrioritizedAction(character.GetId(), out action) && action.ActionType >= 0 && !string.IsNullOrEmpty(PrioritizedActions.Instance[action.ActionType].RefuseAppointment);
	}

	public static bool IsCharacterMatchAgeGroup(int charId, sbyte ageGroup)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element) && element.GetAgeGroup() == ageGroup)
		{
			return true;
		}
		return false;
	}

	public static bool CheckStartRelationSucceed(int charIdA, int charIdB, ushort relationType, bool isBothWayRelation = true)
	{
		CharacterDomain character = DomainManager.Character;
		if (!character.TryGetElement_Objects(charIdA, out var element) || !character.TryGetElement_Objects(charIdB, out var element2))
		{
			throw new Exception($"Wrong Checking Request Between {charIdA} & {charIdB}!");
		}
		if (element.GetCreatingType() != 1 || element2.GetCreatingType() != 1)
		{
			return false;
		}
		if (charIdB == EventArgBox.TaiwuCharacterId)
		{
			return true;
		}
		if (!character.TryGetRelation(charIdA, charIdB, out var relation))
		{
			character.TryCreateGeneralRelation(DomainManager.TaiwuEvent.MainThreadDataContext, element, element2);
			relation = character.GetRelation(charIdA, charIdB);
		}
		if (!character.TryGetRelation(charIdB, charIdA, out var relation2))
		{
			character.TryCreateGeneralRelation(DomainManager.TaiwuEvent.MainThreadDataContext, element2, element);
			relation2 = character.GetRelation(charIdB, charIdA);
		}
		switch (relationType)
		{
		case 512:
		case 8192:
			return true;
		case 64:
		case 128:
			if (FavorabilityType.GetFavorabilityType(relation.Favorability) >= 4 && FavorabilityType.GetFavorabilityType(relation2.Favorability) >= 4)
			{
				return true;
			}
			return false;
		case 2048:
			return true;
		case 16384:
		{
			int startRelationSuccessRate_HusbandOrWife;
			if (isBothWayRelation)
			{
				startRelationSuccessRate_HusbandOrWife = AiHelper.Relation.GetStartRelationSuccessRate_BoyOrGirlFriend(element, element2, relation, relation2);
				if (CheckProbability(startRelationSuccessRate_HusbandOrWife))
				{
					return true;
				}
				return false;
			}
			if (CheckHasRelationship(element2, element, 16384))
			{
				return false;
			}
			startRelationSuccessRate_HusbandOrWife = AiHelper.Relation.GetStartRelationSuccessRate_Adored(element, element2, relation, relation2);
			if (CheckProbability(startRelationSuccessRate_HusbandOrWife))
			{
				return true;
			}
			return false;
		}
		case 32768:
		{
			sbyte behaviorType = element2.GetBehaviorType();
			sbyte value = AiHelper.RelationsRelatedConstants.SeverEnemyNotMutuallyChance[behaviorType];
			return CheckProbability(value);
		}
		case 1024:
		{
			int startRelationSuccessRate_HusbandOrWife = AiHelper.Relation.GetStartRelationSuccessRate_HusbandOrWife(element, element2, relation, relation2);
			if (CheckProbability(startRelationSuccessRate_HusbandOrWife))
			{
				return true;
			}
			return false;
		}
		default:
			return false;
		}
	}

	public static bool CheckEndRelationSucceed(int charIdA, int charIdB, ushort relationType, bool isBothWayRelation = true)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charIdA, out var _) || !DomainManager.Character.TryGetElement_Objects(charIdB, out var element2))
		{
			throw new Exception($"Wrong Checking Request Between {charIdA} & {charIdB}!");
		}
		if (charIdB == EventArgBox.TaiwuCharacterId)
		{
			return true;
		}
		sbyte behaviorType = element2.GetBehaviorType();
		switch (relationType)
		{
		case 512:
		case 8192:
			return true;
		case 64:
		case 128:
		case 1024:
		case 2048:
			return true;
		case 32768:
		{
			bool flag2 = CheckProbability(AiHelper.RelationsRelatedConstants.SeverEnemyNotMutuallyChance[behaviorType]);
			return !flag2;
		}
		case 16384:
			if (isBothWayRelation)
			{
				bool flag = CheckProbability(AiHelper.RelationsRelatedConstants.BreakupMutuallyChance[behaviorType]);
				return !flag;
			}
			return true;
		default:
			return false;
		}
	}

	public static bool HasCombatSkillExchangedSpecialWeapon(short skillTemplateId)
	{
		return DomainManager.Extra.HasCombatSkillExchangedSpecialWeapon(Domain.MainThreadDataContext, skillTemplateId);
	}

	public static bool IsInteractOfLoveInstalled()
	{
		return DlcManager.IsDlcInstalled(2305890uL);
	}

	public static bool IsGiftFromConchShip1Installed()
	{
		return DlcManager.IsDlcInstalled(2241120uL);
	}

	public static bool IsGiftFromConchShip2Installed()
	{
		return DlcManager.IsDlcInstalled(2172690uL);
	}

	public static bool IsFiveLoongDlcInstalled()
	{
		return DlcManager.IsDlcInstalled(2764950uL);
	}

	public static bool IsHappyNewYear2024Installed()
	{
		return DlcManager.IsDlcInstalled(2764960uL);
	}

	public static bool IsYearOfSnakeClothInstalled()
	{
		return DlcManager.IsDlcInstalled(3464590uL);
	}

	public static bool IsHappyNewYar2026DlcInstalled()
	{
		return DlcManager.IsDlcInstalled(4395170uL);
	}

	public static bool AbleToCricketBattle()
	{
		return AbleToCricketBattleWithGivenLimit(3);
	}

	public static bool AbleToCricketBattleWithGivenLimit(int limit)
	{
		return DomainManager.Taiwu.GetTaiwu().GetInventory().Items.Count(delegate(KeyValuePair<ItemKey, int> a)
		{
			ItemBase baseItem = DomainManager.Item.GetBaseItem(a.Key);
			return baseItem.GetItemType() == 11 && baseItem.GetCurrDurability() > 0;
		}) >= limit;
	}

	public static bool CharacterHasAnyCricketWager(int charId)
	{
		return DomainManager.Item.NpcHasAnyCricketWager(charId);
	}

	public static bool CharacterHasItemMatchFilterRule(int charId, short filterRuleTemplateId, bool searchEquipment = false)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			List<(ItemKey, int)> list = new List<(ItemKey, int)>();
			CharacterItemFilterWrappers.FindByItemFilterRule(element, filterRuleTemplateId, list, searchInventory: true, searchEquipment);
			return list.Count > 0;
		}
		return false;
	}

	public static bool CharacterHasPrisoner(int charId, int prisonerId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(prisonerId);
		if (element_Objects == null)
		{
			throw new Exception($"can not find character {prisonerId} to check CharacterHasPrisoner");
		}
		return element_Objects.GetKidnapperId() == charId;
	}

	public static bool IsItemPoisoned(ItemKey itemKey)
	{
		byte modificationState = DomainManager.Item.GetBaseItem(itemKey).GetModificationState();
		return ModificationStateHelper.IsActive(modificationState, 1);
	}

	public static bool IsItemPoisonedAndIdentified(ItemKey itemKey)
	{
		if (IsItemPoisoned(itemKey))
		{
			FullPoisonEffects poisonEffects = DomainManager.Item.GetPoisonEffects(itemKey);
			return poisonEffects.IsIdentified;
		}
		return false;
	}

	public static bool IsEquippingItem(int charId, sbyte itemType, short templateId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"can not find character {charId} to check IsEquipItem");
		}
		ItemKey[] equipment = element.GetEquipment();
		ItemKey[] array = equipment;
		for (int i = 0; i < array.Length; i++)
		{
			ItemKey itemKey = array[i];
			if (itemKey.ItemType == itemType && itemKey.TemplateId == templateId)
			{
				return true;
			}
		}
		return false;
	}

	public static bool IsTaiwuHasItem(sbyte itemType, short templateId, bool searchEquipment = true, bool searchWarehouse = false)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Inventory inventory = taiwu.GetInventory();
		foreach (ItemKey key in inventory.Items.Keys)
		{
			if (key.ItemType == itemType && key.TemplateId == templateId)
			{
				return true;
			}
		}
		if (searchEquipment)
		{
			ItemKey[] equipment = taiwu.GetEquipment();
			ItemKey[] array = equipment;
			for (int i = 0; i < array.Length; i++)
			{
				ItemKey itemKey = array[i];
				if (itemKey.ItemType == itemType && itemKey.TemplateId == templateId)
				{
					return true;
				}
			}
		}
		if (searchWarehouse)
		{
			List<ItemKey> warehouseAllItemKey = DomainManager.Taiwu.GetWarehouseAllItemKey();
			foreach (ItemKey item in warehouseAllItemKey)
			{
				if (item.ItemType == itemType && item.TemplateId == templateId)
				{
					return true;
				}
			}
		}
		return false;
	}

	public static bool CheckCharacterHasLegendaryBook(int charId)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			sbyte legendaryBookOwnerState = element.GetLegendaryBookOwnerState();
			return legendaryBookOwnerState > -1 && legendaryBookOwnerState < 3;
		}
		return false;
	}

	public static bool CheckCharacterWillAcceptLegendaryBookAsGift(int charId)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			int topThousandCharacterRanking = DomainManager.Character.GetTopThousandCharacterRanking(charId);
			if (topThousandCharacterRanking == -1)
			{
				return false;
			}
			sbyte behaviorType = element.GetBehaviorType();
			return topThousandCharacterRanking < GlobalConfig.Instance.AcceptLegendaryBookAsGiftRequireRank[behaviorType];
		}
		return false;
	}

	public static List<int> GetTaiwuAdultGroupsHasLegendaryBook()
	{
		List<int> taiwuAdultGroups = GetTaiwuAdultGroups();
		List<int> list = new List<int>();
		foreach (int item in taiwuAdultGroups)
		{
			if (DomainManager.Character.TryGetElement_Objects(item, out var element) && element.GetLegendaryBookOwnerState() >= 1)
			{
				list.Add(item);
			}
		}
		return list;
	}

	public static bool IsRandomEnemyNeedDieCombat(short characterTemplateId)
	{
		return (characterTemplateId >= 283 && characterTemplateId <= 306) || (characterTemplateId >= 313 && characterTemplateId <= 315);
	}

	public static bool CheckAdventureSiteState(Location location, short adventureId, sbyte adventureSiteState)
	{
		if (!location.IsValid())
		{
			return false;
		}
		AreaAdventureData adventuresInArea = DomainManager.Adventure.GetAdventuresInArea(location.AreaId);
		if (!adventuresInArea.AdventureSites.TryGetValue(location.BlockId, out var value))
		{
			return false;
		}
		return adventureId == value.TemplateId && adventureSiteState == value.SiteState;
	}

	public static bool CheckBlockHasAdventure(Location location)
	{
		return DomainManager.Adventure.GetAdventuresInArea(location.AreaId).AdventureSites.ContainsKey(location.BlockId);
	}

	public static bool CheckBlockMatchTemplate(Location location, short templateId, EMapBlockType blockType = EMapBlockType.Invalid, EMapBlockSubType blockSubType = EMapBlockSubType.None)
	{
		MapBlockData mapBlockData = GetMapBlockData(location.AreaId, location.BlockId);
		MapBlockItem config = mapBlockData.GetConfig();
		if (blockSubType != EMapBlockSubType.None)
		{
			return config.SubType == blockSubType;
		}
		if (blockType != EMapBlockType.Invalid)
		{
			return config.Type == blockType;
		}
		return config.TemplateId == templateId;
	}

	public static bool CheckBlockHasCricket(Location location)
	{
		return DomainManager.Map.LocationHasCricket(Domain.MainThreadDataContext, location);
	}

	public static bool CheckBlockHasAdventure(MapBlockData mapBlock)
	{
		if (mapBlock == null)
		{
			return false;
		}
		return CheckBlockHasAdventure(new Location(mapBlock.AreaId, mapBlock.BlockId));
	}

	public static bool CheckBlockHasRandomEnemy(MapBlockData mapBlock)
	{
		return mapBlock != null && mapBlock.TemplateEnemyList != null && mapBlock.TemplateEnemyList.Count > 0;
	}

	public static bool CheckBlockHasXiangshuAvatar(MapBlockData mapBlock)
	{
		if (mapBlock == null || mapBlock.FixedCharacterSet == null)
		{
			return false;
		}
		foreach (int item in mapBlock.FixedCharacterSet)
		{
			GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(item);
			if (element_Objects.GetXiangshuType() == 1)
			{
				return true;
			}
		}
		return false;
	}

	public static bool CheckBlockHasPurpleBambooAvatar(MapBlockData mapBlock)
	{
		if (mapBlock == null || mapBlock.FixedCharacterSet == null)
		{
			return false;
		}
		foreach (int item in mapBlock.FixedCharacterSet)
		{
			GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(item);
			if (element_Objects.GetXiangshuType() == 3)
			{
				return true;
			}
		}
		return false;
	}

	public static bool CheckBlockHasEnemyCharacter(MapBlockData mapBlock)
	{
		return mapBlock != null && mapBlock.EnemyCharacterSet != null && mapBlock.EnemyCharacterSet.Count > 0;
	}

	public static (sbyte, int) CheckBlockHasConsumedCharacter(MapBlockData mapBlockData)
	{
		if (mapBlockData != null && mapBlockData.CharacterSet != null && mapBlockData.CharacterSet.Count > 0)
		{
			foreach (int item in mapBlockData.CharacterSet)
			{
				GameData.Domains.Character.Character characterById = GetCharacterById(item);
				if (characterById != null && DomainManager.Extra.IsLegendaryBookConsumed(item))
				{
					sbyte consumedCharacterLegendaryBookType = DomainManager.LegendaryBook.GetConsumedCharacterLegendaryBookType(characterById);
					return (consumedCharacterLegendaryBookType, item);
				}
			}
		}
		return (-1, -1);
	}

	public static bool CheckBlockHasAnimal(MapBlockData mapBlock)
	{
		return DomainManager.Extra.IsLocationContainsAnimal(new Location(mapBlock.AreaId, mapBlock.BlockId));
	}

	[Obsolete]
	public static int GetTaiwuChickenRemainEmptySlot()
	{
		return int.MaxValue;
	}

	public static bool CheckBlockHasInfectedCharacter(MapBlockData mapBlock)
	{
		return mapBlock != null && mapBlock.InfectedCharacterSet != null && mapBlock.InfectedCharacterSet.Count > 0;
	}

	public static int CheckEnemyEscapeRateFromTaiwu(short enemyTemplateId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		CharacterItem characterItem = Config.Character.Instance[enemyTemplateId];
		return CharacterDomain.CalcEscapeSuccessRate(characterItem.ConsummateLevel, taiwu.GetConsummateLevel());
	}

	public static int CheckTaiwuEscapeRateFromEnemy(short enemyTemplateId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		CharacterItem characterItem = Config.Character.Instance[enemyTemplateId];
		return CharacterDomain.CalcEscapeSuccessRate(taiwu.GetConsummateLevel(), characterItem.ConsummateLevel);
	}

	public static int CheckEscapeSuccessRate(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar)
	{
		return CharacterDomain.CalcEscapeSuccessRate(selfChar.GetConsummateLevel(), targetChar.GetConsummateLevel());
	}

	[Obsolete]
	public static short GetBlockAnimalCharacterTemplateId(MapBlockData mapBlock)
	{
		return -1;
	}

	public static GameData.Domains.Character.Character GetBlockXiangshuAvatar(MapBlockData mapBlock)
	{
		if (mapBlock == null || mapBlock.FixedCharacterSet == null)
		{
			return null;
		}
		foreach (int item in mapBlock.FixedCharacterSet)
		{
			GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(item);
			if (element_Objects.GetXiangshuType() == 1)
			{
				return element_Objects;
			}
		}
		return null;
	}

	public static GameData.Domains.Character.Character GetBlockPurpleBambooAvatar(MapBlockData mapBlock)
	{
		if (mapBlock == null || mapBlock.FixedCharacterSet == null)
		{
			return null;
		}
		foreach (int item in mapBlock.FixedCharacterSet)
		{
			GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(item);
			if (element_Objects.GetXiangshuType() == 3)
			{
				return element_Objects;
			}
		}
		return null;
	}

	public static bool IsTaiwuAvoidMapBlockEnemies()
	{
		return DomainManager.Taiwu.IsTaiwuAvoidMapBlockEnemies();
	}

	public static bool LocationIsAtSettlementOfArea(Location location, short areaId)
	{
		if (location.AreaId != areaId)
		{
			return false;
		}
		MapAreaData element_Areas = DomainManager.Map.GetElement_Areas(areaId);
		for (int i = 0; i < element_Areas.SettlementInfos.Length; i++)
		{
			SettlementInfo settlementInfo = element_Areas.SettlementInfos[i];
			MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
			Location location2 = blockData.GetRootBlock().GetLocation();
			if (settlementInfo.BlockId == location2.BlockId)
			{
				return true;
			}
		}
		return false;
	}

	public static bool LocationIsAtSettlementOfState(Location location, short stateTemplateId)
	{
		sbyte stateIdByStateTemplateId = DomainManager.Map.GetStateIdByStateTemplateId(stateTemplateId);
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		DomainManager.Map.GetAllAreaInState(stateIdByStateTemplateId, list);
		if (!list.Contains(location.AreaId))
		{
			ObjectPool<List<short>>.Instance.Return(list);
			return false;
		}
		for (int i = 0; i < list.Count; i++)
		{
			if (LocationIsAtSettlementOfArea(location, list[i]))
			{
				ObjectPool<List<short>>.Instance.Return(list);
				return true;
			}
		}
		ObjectPool<List<short>>.Instance.Return(list);
		return false;
	}

	public static bool IsSecretInformationBroadcast(int metaDataId)
	{
		return DomainManager.Information.IsSecretInformationInBroadcast(metaDataId);
	}

	public static bool IsSecretInformationCharacterAlive(int metaDataId, int partyIndex)
	{
		if (DomainManager.Information.TryGetElement_SecretInformationMetaData(metaDataId, out var element))
		{
			EventArgBox eventArgBox = DomainManager.TaiwuEvent.GetEventArgBox();
			DomainManager.Information.MakeSecretInformationEventArgBox(element, eventArgBox);
			short num = eventArgBox.GetShort("templateId");
			SecretInformationItem item = SecretInformation.Instance.GetItem(num);
			if (item == null)
			{
				throw new Exception($"metaDataId has invalid templateId {num}");
			}
			if (item.Parameters[partyIndex] != "Character")
			{
				return false;
			}
			bool result = false;
			string key = $"arg{partyIndex}";
			if (eventArgBox.Contains<int>(key))
			{
				int charId = eventArgBox.GetInt(key);
				result = DomainManager.Character.IsCharacterAlive(charId);
			}
			DomainManager.TaiwuEvent.ReturnArgBox(eventArgBox);
			return result;
		}
		return false;
	}

	private static void AddAdmonishSucceed(int charId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		lifeRecordCollection.AddAdmonishSucceed(taiwu.GetId(), currDate, charId, location);
	}

	private static void AddChangeBehaviorTypeByAdmonishedGood(int charId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		lifeRecordCollection.AddChangeBehaviorTypeByAdmonishedGood(charId, currDate, taiwu.GetId(), location);
	}

	private static void AddChangeBehaviorTypeByAdmonishedBad(int charId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		lifeRecordCollection.AddChangeBehaviorTypeByAdmonishedBad(charId, currDate, taiwu.GetId(), location);
	}

	private static void AddReduceDebtByAdmonished(int charId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		lifeRecordCollection.AddReduceDebtByAdmonished(charId, currDate, taiwu.GetId(), location);
	}

	public static void ApplyLeadToGoodByCombatFavorabilityChange(int charId, int metaDataId)
	{
		int leadToGoodByCombatFavorabilityChange = SecretInformationConfig.GetLeadToGoodByCombatFavorabilityChange(charId, metaDataId);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		ChangeFavorabilityOptional(element_Objects, taiwu, (short)leadToGoodByCombatFavorabilityChange, 3);
	}

	public static void ApplyLeadToGoodByCombatBehaviorTypeOffset(int charId, int metaDataId)
	{
		int leadToGoodByCombatBehaviorTypeOffset = SecretInformationConfig.GetLeadToGoodByCombatBehaviorTypeOffset(metaDataId);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		ChangeRoleBaseBehaviorValue(element_Objects, leadToGoodByCombatBehaviorTypeOffset);
		LeadToGoodSuccess(charId, metaDataId, leadToGoodByCombatBehaviorTypeOffset);
	}

	public static void ApplyLeadToEvilByCombatBehaviorTypeOffset(int charId, int metaDataId)
	{
		int leadToEvilByCombatBehaviorTypeOffset = SecretInformationConfig.GetLeadToEvilByCombatBehaviorTypeOffset(metaDataId);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		ChangeRoleBaseBehaviorValue(element_Objects, leadToEvilByCombatBehaviorTypeOffset);
		LeadToEvilSuccess(charId, metaDataId, leadToEvilByCombatBehaviorTypeOffset);
	}

	public static void ApplyWriteOffDebtsByCombat(int charId, int metaDataId)
	{
		int worth = SecretInformationConfig.WriteOffDebtsByCombatDebtsWorth(charId, metaDataId);
		DirectlyReduceDebt(charId, worth, isEquivalent: true);
		AddReduceDebtByAdmonished(charId);
	}

	public static void ApplyLeadToGoodByRationalityFavorabilityChange(int charId, int metaDataId)
	{
		int leadToGoodByRationalityFavorabilityChange = SecretInformationConfig.GetLeadToGoodByRationalityFavorabilityChange(charId, metaDataId);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		ChangeFavorabilityOptional(element_Objects, taiwu, (short)leadToGoodByRationalityFavorabilityChange, 3);
	}

	public static void ApplyLeadToGoodByRationalityBehaviorTypeOffset(int charId, int metaDataId)
	{
		int leadToGoodByRationalityBehaviorTypeOffset = SecretInformationConfig.GetLeadToGoodByRationalityBehaviorTypeOffset(metaDataId);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		ChangeRoleBaseBehaviorValue(element_Objects, leadToGoodByRationalityBehaviorTypeOffset);
		LeadToGoodSuccess(charId, metaDataId, leadToGoodByRationalityBehaviorTypeOffset);
	}

	public static void ApplyLeadToEvilByRationalityBehaviorTypeOffset(int charId, int metaDataId)
	{
		int leadToEvilByRationalityBehaviorTypeOffset = SecretInformationConfig.GetLeadToEvilByRationalityBehaviorTypeOffset(metaDataId);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		ChangeRoleBaseBehaviorValue(element_Objects, leadToEvilByRationalityBehaviorTypeOffset);
		LeadToEvilSuccess(charId, metaDataId, leadToEvilByRationalityBehaviorTypeOffset);
	}

	public static void ApplyWriteOffDebtsByRationality(int charId, int metaDataId)
	{
		int worth = SecretInformationConfig.WriteOffDebtsByRationalityDebtsWorth(charId, metaDataId);
		DirectlyReduceDebt(charId, worth, isEquivalent: true);
		AddReduceDebtByAdmonished(charId);
	}

	public static bool GetByEmotionResult(int charId, int metaDataId)
	{
		return SecretInformationConfig.GetLeadToGoodByEmotionEffectValue(charId, metaDataId) >= SecretInformationConfig.GetLeadToGoodByEmotionDifficultyValue(charId);
	}

	public static void ApplyLeadToGoodByEmotionBehaviorTypeOffset(int charId, int metaDataId)
	{
		int leadToGoodByEmotionBehaviorTypeOffset = SecretInformationConfig.GetLeadToGoodByEmotionBehaviorTypeOffset(metaDataId);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		ChangeRoleBaseBehaviorValue(element_Objects, leadToGoodByEmotionBehaviorTypeOffset);
		LeadToGoodSuccess(charId, metaDataId, leadToGoodByEmotionBehaviorTypeOffset);
	}

	public static void ApplyLeadToEvilByEmotionBehaviorTypeOffset(int charId, int metaDataId)
	{
		int leadToEvilByEmotionBehaviorTypeOffset = SecretInformationConfig.GetLeadToEvilByEmotionBehaviorTypeOffset(metaDataId);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		ChangeRoleBaseBehaviorValue(element_Objects, leadToEvilByEmotionBehaviorTypeOffset);
		LeadToEvilSuccess(charId, metaDataId, leadToEvilByEmotionBehaviorTypeOffset);
	}

	public static void ApplyWriteOffDebtsByEmotion(int charId, int metaDataId)
	{
		int worth = SecretInformationConfig.WriteOffDebtsByEmotionDebtsWorth(charId, metaDataId);
		DirectlyReduceDebt(charId, worth, isEquivalent: true);
		AddReduceDebtByAdmonished(charId);
	}

	private static void LeadToGoodSuccess(int charId, int metaDataId, int offset)
	{
		AddAdmonishSucceed(charId);
		AddChangeBehaviorTypeByAdmonishedGood(charId);
		ApplyLeadToGoodAiEffect(charId, metaDataId, offset);
		if (SecretInformationProcessor_Event.Instance.IsContentAskKeepContent())
		{
			DiscardSecretInformation(DomainManager.Taiwu.GetTaiwuCharId(), metaDataId);
		}
	}

	private static void LeadToEvilSuccess(int charId, int metaDataId, int offset)
	{
		AddAdmonishSucceed(charId);
		AddChangeBehaviorTypeByAdmonishedBad(charId);
		ApplyLeadToEvilAiEffect(charId, metaDataId, offset);
		if (SecretInformationProcessor_Event.Instance.IsContentAskKeepContent())
		{
			DiscardSecretInformation(DomainManager.Taiwu.GetTaiwuCharId(), metaDataId);
		}
	}

	private static int WriteOffDebtsByThreatenDebtsWorth(int charId, int metaDataId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		SecretInformationItem secretInformationConfig = DomainManager.Information.GetSecretInformationConfig(metaDataId);
		return (secretInformationConfig.SortValue - 1) * 50 * WriteOffDebtsByThreatenDebtsBehaviorTypeParam[element_Objects.GetBehaviorType()] + 2000;
	}

	private static void ApplyWriteOffDebtsByThreaten(int charId, int metaDataId)
	{
		int worth = WriteOffDebtsByThreatenDebtsWorth(charId, metaDataId);
		DirectlyReduceDebt(charId, worth, isEquivalent: true);
	}

	public static bool CanWriteOffDebts(int charId)
	{
		Debts debts = DomainManager.Character.GetDebts(charId);
		if (debts != null)
		{
			return debts.GetTotalWorthLentToTaiwu() > 0;
		}
		return false;
	}

	private static int GetLeadToGoodAiEffectTime(int charId, int metaDataId, int offsetValue)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		SecretInformationItem secretInformationConfig = DomainManager.Information.GetSecretInformationConfig(metaDataId);
		return secretInformationConfig.SortValue * 12 / 2 + offsetValue / 10 + LeadToGoodAiBehaviorTypeParam[element_Objects.GetBehaviorType()];
	}

	private static int GetLeadToEvilAiEffectTime(int charId, int metaDataId, int offsetValue)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		SecretInformationItem secretInformationConfig = DomainManager.Information.GetSecretInformationConfig(metaDataId);
		return secretInformationConfig.SortValue * 12 / 2 + Math.Abs(offsetValue) / 10 + LeadToEvilAiBehaviorTypeParam[element_Objects.GetBehaviorType()];
	}

	private static void ApplyLeadToGoodAiEffect(int charId, int metaDataId, int offset)
	{
		SecretInformationItem secretInformationConfig = DomainManager.Information.GetSecretInformationConfig(metaDataId);
		(sbyte, sbyte) secretInformationType = GetSecretInformationType(secretInformationConfig);
		int leadToGoodAiEffectTime = GetLeadToGoodAiEffectTime(charId, metaDataId, offset);
		ForbidCharacterAiAction(charId, secretInformationType.Item1, secretInformationType.Item2, leadToGoodAiEffectTime);
	}

	private static void ApplyLeadToEvilAiEffect(int charId, int metaDataId, int offset)
	{
		SecretInformationItem secretInformationConfig = DomainManager.Information.GetSecretInformationConfig(metaDataId);
		(sbyte, sbyte) secretInformationType = GetSecretInformationType(secretInformationConfig);
		int leadToEvilAiEffectTime = GetLeadToEvilAiEffectTime(charId, metaDataId, offset);
		AddCharacterAiActionRateAdjust(charId, secretInformationType.Item1, secretInformationType.Item2, 20, leadToEvilAiEffectTime);
	}

	private static (sbyte, sbyte) GetSecretInformationType(SecretInformationItem config)
	{
		if (config.TemplateId == 87)
		{
			return (1, 4);
		}
		if (config.TemplateId == 88)
		{
			return (1, 1);
		}
		if (config.TemplateId == 89)
		{
			return (1, 2);
		}
		if (config.TemplateId == 90)
		{
			return (1, 3);
		}
		if (config.TemplateId == 91)
		{
			return (0, 4);
		}
		if (config.TemplateId == 92)
		{
			return (0, 1);
		}
		if (config.TemplateId == 93)
		{
			return (0, 2);
		}
		if (config.TemplateId == 94)
		{
			return (0, 3);
		}
		if (config.TemplateId == 95)
		{
			return (7, -1);
		}
		if (config.TemplateId == 96)
		{
			return (8, -1);
		}
		if (config.TemplateId == 97)
		{
			return (5, 1);
		}
		if (config.TemplateId == 98)
		{
			return (5, 2);
		}
		if (config.TemplateId == 99)
		{
			return (3, 1);
		}
		if (config.TemplateId == 100)
		{
			return (3, 2);
		}
		if (config.TemplateId == 101)
		{
			return (2, 1);
		}
		if (config.TemplateId == 102)
		{
			return (2, 2);
		}
		if (config.TemplateId == 103)
		{
			return (9, -1);
		}
		if (config.TemplateId == 104)
		{
			return (6, -1);
		}
		if (config.TemplateId == 105)
		{
			return (4, 1);
		}
		if (config.TemplateId == 106)
		{
			return (4, 3);
		}
		if (config.TemplateId == 110)
		{
			return (11, -1);
		}
		throw new Exception($"Wrong SecretInformation TemplateId: {config.TemplateId}");
	}

	public static bool IsInAnySect(int charId)
	{
		return DomainManager.Organization.IsInAnySect(charId);
	}

	public static bool IsInTargetOrganization(GameData.Domains.Character.Character character, sbyte targetOrganizationTemplateId)
	{
		if (character == null)
		{
			throw new Exception("null character to check IsInTargetOrganization!");
		}
		return character.GetOrganizationInfo().OrgTemplateId == targetOrganizationTemplateId;
	}

	public static bool IsCharactersInHostileSects(GameData.Domains.Character.Character charA, GameData.Domains.Character.Character charB)
	{
		sbyte orgTemplateId = charA.GetOrganizationInfo().OrgTemplateId;
		sbyte orgTemplateId2 = charB.GetOrganizationInfo().OrgTemplateId;
		return DomainManager.Organization.GetSectFavorability(orgTemplateId, orgTemplateId2) == -1;
	}

	public static bool IsHostileSects(sbyte orgTemplateIdA, sbyte orgTemplateIdB)
	{
		return DomainManager.Organization.GetSectFavorability(orgTemplateIdA, orgTemplateIdB) == -1;
	}

	public static sbyte GetHostileSect(sbyte orgTemplateId)
	{
		for (sbyte b = 1; b < 15; b++)
		{
			if (orgTemplateId != b && IsHostileSects(orgTemplateId, b))
			{
				return b;
			}
		}
		return -1;
	}

	public static bool IsCharacterAtTargetSectLocation(GameData.Domains.Character.Character character, sbyte sectTemplateId)
	{
		if (character == null)
		{
			throw new Exception("null character to check IsCharacterAtTargetSectLocation!");
		}
		if (!character.GetLocation().IsValid())
		{
			return false;
		}
		short settlementIdByOrgTemplateId = DomainManager.Organization.GetSettlementIdByOrgTemplateId(sectTemplateId);
		return DomainManager.Map.IsLocationOnSettlementBlock(character.GetLocation(), settlementIdByOrgTemplateId);
	}

	public static bool IsCharacterAtTargetSectLocation(GameData.Domains.Character.Character character, short settlementId)
	{
		if (character == null)
		{
			throw new Exception("null character to check IsCharacterAtTargetSectLocation!");
		}
		if (!character.GetLocation().IsValid())
		{
			return false;
		}
		return DomainManager.Map.IsLocationOnSettlementBlock(character.GetLocation(), settlementId);
	}

	public static bool IsCharacterAtOrganizationRange(GameData.Domains.Character.Character character, sbyte orgTemplateId)
	{
		Location location = character.GetLocation();
		if (!location.IsValid())
		{
			return false;
		}
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId);
		return IsLocationAtSettlementRange(location, settlementByOrgTemplateId.GetId());
	}

	public static bool IsCharacterAtOrganizationRange(GameData.Domains.Character.Character character, short settlementId)
	{
		Location location = character.GetLocation();
		if (!location.IsValid())
		{
			return false;
		}
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		return IsLocationAtSettlementRange(location, settlement.GetId());
	}

	public static bool IsLocationAtOrganizationRange(Location currLocation, sbyte orgTemplateId)
	{
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId);
		return IsLocationAtSettlementRange(currLocation, settlementByOrgTemplateId.GetId());
	}

	public static bool IsLocationAtSettlementRange(Location currLocation, short settlementId)
	{
		return DomainManager.Map.IsLocationInSettlementInfluenceRange(currLocation, settlementId);
	}

	public static bool IsSectCharApprovedTaiwu(int charId)
	{
		return DomainManager.Organization.GetElement_SectCharacters(charId).GetApprovedTaiwu();
	}

	public static bool IsSectAllowLearning(sbyte sectId)
	{
		short id = DomainManager.Organization.GetSettlementByOrgTemplateId(sectId).GetId();
		return DomainManager.Organization.GetElement_Sects(id).GetTaiwuExploreStatus() == 2;
	}

	public static bool HasSectSpiritualDebtInteractionOccurred(sbyte sectId)
	{
		short id = DomainManager.Organization.GetSettlementByOrgTemplateId(sectId).GetId();
		return DomainManager.Organization.GetElement_Sects(id).GetSpiritualDebtInteractionOccurred();
	}

	public static bool IsSectNoMeatEating(sbyte sectId)
	{
		return Config.Organization.Instance[sectId].NoMeatEating;
	}

	public static bool IsSectNoDrinking(sbyte sectId)
	{
		return Config.Organization.Instance[sectId].NoDrinking;
	}

	public static bool HasCurrentTaiwuSendWorshipPostToSect(sbyte orgTemplateId)
	{
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId);
		return DomainManager.Organization.GetElement_Sects(settlementByOrgTemplateId.GetId()).GetTaiwuExploreStatus() > 0;
	}

	public static bool IsPrincipal(int charId)
	{
		return DomainManager.Character.GetElement_Objects(charId).GetOrganizationInfo().Principal;
	}

	public static bool CharacterInjuryPoisonDisorderOfQiLess(GameData.Domains.Character.Character character, int value)
	{
		int num = 0;
		num += character.GetInjuries().GetSum();
		num += character.GetPoisonMarkCount();
		num += DefeatMarkCollection.CalcQiDisorderMarkCount(character.GetDisorderOfQi());
		return num < value;
	}

	public static bool HasTeammates(bool ignoreBaby = false)
	{
		if (!ignoreBaby)
		{
			return DomainManager.Taiwu.GetGroupCharIds().GetCount() > 1;
		}
		return GetValidGroupCharacterCount(ignoreBaby: true, ignoreChild: false, ignoreTaiwu: true) > 0;
	}

	[Obsolete]
	public static bool IsInGroup(int characterId)
	{
		return DomainManager.Taiwu.IsInGroup(characterId);
	}

	public static bool IsTaiwuGroupFull()
	{
		return GetValidGroupCharacterCount(ignoreBaby: true, ignoreChild: false, ignoreTaiwu: true) >= DomainManager.Taiwu.GetTaiwuGroupMaxCount();
	}

	[Obsolete("OptionAvailableConditions")]
	public static bool TaiwuHasShavingCondition(int characterId)
	{
		int leftDaysInCurrMonth = DomainManager.World.GetLeftDaysInCurrMonth();
		int resource = DomainManager.Taiwu.GetTaiwu().GetResource(6);
		short favorability = DomainManager.Character.GetFavorability(characterId, DomainManager.Taiwu.GetTaiwuCharId());
		sbyte favorabilityType = FavorabilityType.GetFavorabilityType(favorability);
		return leftDaysInCurrMonth >= 3 && resource >= 500 && favorabilityType >= 1;
	}

	[Obsolete("OptionAvailableConditions/TaiwuGroupHaveAdult")]
	public static bool HasMatchTeammate(short ruleTemplateId)
	{
		List<Predicate<GameData.Domains.Character.Character>> predicates = new List<Predicate<GameData.Domains.Character.Character>>();
		GameData.Domains.Character.Filters.CharacterFilterRules.ToPredicates(ruleTemplateId, predicates, -1);
		foreach (int item in DomainManager.Taiwu.GetGroupCharIds().GetCollection())
		{
			if (DomainManager.Character.TryGetElement_Objects(item, out var element) && CharacterMatchers.MatchAll(element, predicates))
			{
				return true;
			}
		}
		return false;
	}

	[Obsolete("OptionAvailableConditions/TaiwuPrisonerHaveInfectedCharacter")]
	public static bool RoleHasMatchPrisoner(short ruleTemplateId, int charId = -1)
	{
		if (charId == -1)
		{
			charId = EventArgBox.TaiwuCharacterId;
		}
		List<Predicate<GameData.Domains.Character.Character>> predicates = new List<Predicate<GameData.Domains.Character.Character>>();
		GameData.Domains.Character.Filters.CharacterFilterRules.ToPredicates(ruleTemplateId, predicates, -1);
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element) || !element.IsActiveExternalRelationState(2))
		{
			return false;
		}
		KidnappedCharacterList kidnappedCharacters = DomainManager.Character.GetKidnappedCharacters(charId);
		foreach (KidnappedCharacter item in kidnappedCharacters.GetCollection())
		{
			if (DomainManager.Character.TryGetElement_Objects(item.CharId, out var element2) && CharacterMatchers.MatchAll(element2, predicates))
			{
				return true;
			}
		}
		return false;
	}

	public static bool IsTaiwuAwayForeverLover(int charId)
	{
		return Domain.GetAwayForeverLoverCharId() == charId;
	}

	[Obsolete]
	public static bool HasSeizedCharacterInCombat(EventArgBox eventArgBox)
	{
		if (eventArgBox == null)
		{
			return false;
		}
		int arg = -1;
		return eventArgBox.Get("CharIdSeizedInCombat", ref arg);
	}

	public static bool IsTaiwuTraveling()
	{
		return DomainManager.Map.IsTraveling;
	}

	public static bool NeedTriggerReincarnation()
	{
		bool flag = IsTaiwuHasItem(12, 199, searchEquipment: true, searchWarehouse: true);
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		bool flag2 = IsBuildingAreaHasBuilding(taiwuVillageLocation, 50);
		return !flag && !flag2;
	}

	public static bool NeedTriggerTeaHorseStory()
	{
		bool flag = IsTaiwuHasItem(12, 198, searchEquipment: true, searchWarehouse: true);
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		bool flag2 = IsBuildingAreaHasBuilding(taiwuVillageLocation, 51);
		return !flag && !flag2;
	}

	public static void ExpelVillager(int charId)
	{
		DomainManager.Taiwu.ExpelVillager(Domain.MainThreadDataContext, charId);
	}

	public static bool IsLegacyPassingUnlocked()
	{
		return DomainManager.World.GetMainStoryLineProgress() > 10;
	}

	public static bool HasLeftBornArea()
	{
		return DomainManager.World.GetMainStoryLineProgress() > 2;
	}

	public static bool CheckMainStoryLineProgress(short progress)
	{
		if (progress < 29)
		{
			return DomainManager.World.GetMainStoryLineProgress() >= progress;
		}
		return DomainManager.World.GetMainStoryLineProgress() == progress;
	}

	public static bool IsInMainStoryLineProgress(short progress)
	{
		return DomainManager.World.GetMainStoryLineProgress() == progress;
	}

	public static bool GetAllowRandomTaiwuHeir()
	{
		return DomainManager.World.GetAllowRandomTaiwuHeir();
	}

	public static void FinishAdventureEvent()
	{
		DomainManager.Adventure.OnEventHandleFinished(Domain.MainThreadDataContext);
	}

	public static void SelectAdventureBranch(string branchKey)
	{
		DomainManager.Adventure.SelectBranch(Domain.MainThreadDataContext, branchKey);
	}

	public static void SwitchToSiblingBranch(string branchKey)
	{
		DomainManager.Adventure.SelectBranch(Domain.MainThreadDataContext, branchKey);
		DomainManager.Adventure.SetAdventureState(4, Domain.MainThreadDataContext);
	}

	public static string GetCurAdventureBranchKey()
	{
		int branchIndex = DomainManager.Adventure.GetCurMapTrunk().BranchIndex;
		if (branchIndex < DomainManager.Adventure.AdventureCfg.BaseBranches.Count)
		{
			return DomainManager.Adventure.AdventureCfg.BaseBranches[branchIndex].BranchKey;
		}
		branchIndex = DomainManager.Adventure.AdventureCfg.AdvancedBranches[branchIndex].ParentBranchId;
		return DomainManager.Adventure.AdventureCfg.BaseBranches[branchIndex].BranchKey;
	}

	public static void GenerateAdventureMap(string startNodeKey)
	{
		DomainManager.Adventure.GenerateAdventureMap(Domain.MainThreadDataContext, startNodeKey);
	}

	public static short GetCurAdventureId()
	{
		return DomainManager.Adventure.GetCurAdventureId();
	}

	public static int GetAdventureParameter(string parameterName)
	{
		return DomainManager.Adventure.GetAdvParameter(parameterName);
	}

	public static void AddNextBranchExtraEvent(string eventGuid, sbyte personality, short weight)
	{
		DomainManager.Adventure.AddNextBranchExtraEvent(eventGuid, personality, weight);
	}

	public static void AddNextBranchEmptyNode(short weight)
	{
		DomainManager.Adventure.AddNextBranchExtraEvent("", -1, weight);
	}

	public static void SetAdventureParameter(string parameterName, int val)
	{
		DomainManager.Adventure.SetAdvParameter(parameterName, val, Domain.MainThreadDataContext);
	}

	public static void SetAllowExitAdventure(bool allowExitAdventure)
	{
		DomainManager.Adventure.SetAllowExitAdventure(allowExitAdventure, Domain.MainThreadDataContext);
	}

	public static void SetCurrentAdventureSiteInitData(int val)
	{
		short curAdventureId = DomainManager.Adventure.GetCurAdventureId();
		if (curAdventureId >= 0)
		{
			Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
			DomainManager.Adventure.SetAdventureSiteInitData(Domain.MainThreadDataContext, location.AreaId, location.BlockId, val);
		}
	}

	public static int GetCurrentAdventureSiteInitData()
	{
		short curAdventureId = DomainManager.Adventure.GetCurAdventureId();
		if (curAdventureId < 0)
		{
			return int.MinValue;
		}
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		return DomainManager.Adventure.GetAdventureSiteInitData(location.AreaId, location.BlockId);
	}

	public static bool IsCurrLegendaryBookAdventureCreatedByConsumedCharacter()
	{
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		AreaAdventureData adventuresInArea = DomainManager.Adventure.GetAdventuresInArea(location.AreaId);
		AdventureSiteData adventureSiteData = adventuresInArea.AdventureSites[location.BlockId];
		LegendaryBookMonthlyAction legendaryBookMonthlyAction = (LegendaryBookMonthlyAction)DomainManager.TaiwuEvent.GetMonthlyAction(adventureSiteData.MonthlyActionKey);
		return legendaryBookMonthlyAction.BookAppearType == 1;
	}

	public static int GetXDistanceToNextTransferNode()
	{
		return DomainManager.Adventure.GetXDistanceToNextTransferNode();
	}

	public static void ExitAdventure(bool isAdventureCompleted = false)
	{
		if (DomainManager.Adventure.GetCurAdventureId() >= 0)
		{
			DomainManager.Adventure.ExitAdventure(Domain.MainThreadDataContext, isAdventureCompleted);
			GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.ExitAdventure);
		}
	}

	public static List<ItemKey> GetAdventureEnterItems()
	{
		return DomainManager.Adventure.GetEnterItems();
	}

	public static void SetHealingInnerInjuryRestriction(bool val)
	{
		DomainManager.Taiwu.SetHealingInnerInjuryRestriction(val, Domain.MainThreadDataContext);
	}

	public static void SetHealingOuterInjuryRestriction(bool val)
	{
		DomainManager.Taiwu.SetHealingOuterInjuryRestriction(val, Domain.MainThreadDataContext);
	}

	public static void SetNeiliAllocationTypeRestriction(byte neiliAllocationType, bool isRestricted)
	{
		DomainManager.Taiwu.SetNeiliAllocationTypeRestriction(Domain.MainThreadDataContext, neiliAllocationType, isRestricted);
	}

	public static void ClearAllTemporaryRestrictions()
	{
		DomainManager.Taiwu.ClearAllTemporaryRestrictions(Domain.MainThreadDataContext);
	}

	public static bool IsHealingInnerInjuryRestricted()
	{
		return DomainManager.Taiwu.GetHealingInnerInjuryRestriction();
	}

	public static bool IsHealingOuterInjuryRestricted()
	{
		return DomainManager.Taiwu.GetHealingOuterInjuryRestriction();
	}

	public static bool IsNeiliAllocationTypeRestricted(byte neiliAllocationType)
	{
		return DomainManager.Taiwu.IsNeiliAllocationTypeRestricted(neiliAllocationType);
	}

	public static bool IsTemporaryIntelligentCharacter(int charId)
	{
		return DomainManager.Character.IsTemporaryIntelligentCharacter(charId);
	}

	public static void KeepTemporaryCharacterAfterAdventure(GameData.Domains.Character.Character character)
	{
		DomainManager.Character.ConvertTemporaryIntelligentCharacter(Domain.MainThreadDataContext, character);
	}

	public static EventActorData CreateAdventureActor(short templateId, string key, EventArgBox argBox)
	{
		EventActorData eventActorData = EventActorDataHelper.CreateActor(Domain.MainThreadDataContext.Random, templateId);
		argBox.Set(key, (ISerializableGameData)(object)eventActorData);
		return eventActorData;
	}

	public static void SortAdventureCharacters(EventArgBox eventArgBox, bool isMajorChar, int groupId, CharacterSortType characterSortType, bool ascendingOrder)
	{
		AdventureCharacterSortUtils.Sort(eventArgBox, isMajorChar, groupId, characterSortType, ascendingOrder);
	}

	public static bool AddHusbandOrWifeRelationsInAdventure(int charId, int relatedCharId)
	{
		if (!RelationTypeHelper.AllowAddingHusbandOrWifeRelation(charId, relatedCharId))
		{
			return false;
		}
		if (IsTemporaryIntelligentCharacter(charId))
		{
			KeepTemporaryCharacterAfterAdventure(DomainManager.Character.GetElement_Objects(charId));
		}
		if (IsTemporaryIntelligentCharacter(relatedCharId))
		{
			KeepTemporaryCharacterAfterAdventure(DomainManager.Character.GetElement_Objects(relatedCharId));
		}
		DomainManager.Character.AddHusbandOrWifeRelations(Domain.MainThreadDataContext, charId, relatedCharId);
		AddLegacyPoint(3);
		DomainManager.Character.AddRelation(Domain.MainThreadDataContext, charId, relatedCharId, 16384);
		DomainManager.Character.AddRelation(Domain.MainThreadDataContext, relatedCharId, charId, 16384);
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		if (taiwuCharId == charId)
		{
			DomainManager.Taiwu.JoinGroup(Domain.MainThreadDataContext, relatedCharId);
			ShowGetItemPageForCharacters(new List<int> { relatedCharId }, isVillager: false);
			DomainManager.Adventure.AddCharacterToResultDisplay(relatedCharId);
		}
		else if (taiwuCharId == relatedCharId)
		{
			DomainManager.Taiwu.JoinGroup(Domain.MainThreadDataContext, charId);
			ShowGetItemPageForCharacters(new List<int> { charId }, isVillager: false);
			DomainManager.Adventure.AddCharacterToResultDisplay(charId);
		}
		else
		{
			GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
			GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(relatedCharId);
			DomainManager.Organization.UpdateOrganizationAfterMarriage(Domain.MainThreadDataContext, element_Objects, element_Objects2);
		}
		return true;
	}

	public static void KillCharacterInAdventure(GameData.Domains.Character.Character character)
	{
		if (character.GetCreatingType() == 1)
		{
			DomainManager.Adventure.KillIntelligentCharacterInAdventure(Domain.MainThreadDataContext, character);
		}
	}

	public static void DestroyEnemyNest(EventArgBox argBox, sbyte behaviorType)
	{
		argBox.Get("AdventureSite", out AdventureSiteData siteData);
		argBox.Get<Location>("AdventureLocation", out Location arg);
		short templateId = EnemyNest.Instance.First((EnemyNestItem nest) => nest.AdventureId == siteData.TemplateId).TemplateId;
		DomainManager.Adventure.DestroyEnemyNest(Domain.MainThreadDataContext, arg.AreaId, templateId, behaviorType);
	}

	public static GameData.Domains.Character.Character CreateForcedToFollowCharacter(short areaId, sbyte gender, short adventureId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		sbyte enemyNestTemplateId = AdventureDomain.GetEnemyNestTemplateId(adventureId);
		EnemyNestItem enemyNestItem = EnemyNest.Instance[enemyNestTemplateId];
		sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(areaId);
		sbyte sectID = MapState.Instance[stateTemplateIdByAreaId].SectID;
		short characterTemplateId = OrganizationDomain.GetCharacterTemplateId(sectID, stateTemplateIdByAreaId, gender);
		int index = ((adventureId == 33) ? (sectID - 1) : (enemyNestItem.Members.Count - 1));
		CharacterItem characterItem = Config.Character.Instance[enemyNestItem.Members[index]];
		OrganizationInfo organizationInfo = taiwu.GetOrganizationInfo();
		organizationInfo.Grade = 0;
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		IntelligentCharacterCreationInfo info = new IntelligentCharacterCreationInfo(taiwu.GetLocation(), organizationInfo, characterTemplateId);
		info.BaseAttraction = (short)mainThreadDataContext.Random.Next(characterItem.BaseAttraction / 2, characterItem.BaseAttraction + 1);
		info.Age = (short)mainThreadDataContext.Random.Next(12, 25);
		GameData.Domains.Character.Character character = DomainManager.Character.CreateIntelligentCharacter(mainThreadDataContext, ref info);
		DomainManager.Character.CompleteCreatingCharacter(character.GetId());
		character.AddFeature(mainThreadDataContext, 198);
		DomainManager.Character.ChangeFavorabilityOptional(mainThreadDataContext, character, taiwu, -10000, 0);
		return character;
	}

	public static bool CheckEscapingRandomEnemy(short templateId)
	{
		return DomainManager.Adventure.GetEscapingRandomEnemies().Contains(templateId);
	}

	public static void ConquerEnemyNest(EventArgBox argBox)
	{
		argBox.Get<Location>("AdventureLocation", out Location arg);
		DomainManager.Adventure.ConquerEnemyNest(Domain.MainThreadDataContext, arg.AreaId, arg.BlockId);
	}

	public unsafe static ItemKey GetTraitorsGangTributeCombatSkillBook(sbyte orgTemplateId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		sbyte* pWeightedElements = stackalloc sbyte[9] { 0, 0, 30, 40, 30, 0, 0, 0, 0 };
		sbyte grade = (sbyte)CollectionUtils.GetRandomWeightedElement(mainThreadDataContext.Random, pWeightedElements, 9, 100);
		short templateId = Config.CombatSkill.Instance.Where((CombatSkillItem skill) => skill.SectId == orgTemplateId && skill.Grade == grade).ToList().GetRandom(mainThreadDataContext.Random)
			.TemplateId;
		short bookId = Config.CombatSkill.Instance[templateId].BookId;
		ItemKey itemKey = DomainManager.Item.CreateSkillBook(mainThreadDataContext, bookId, -1, -1, -1, 50);
		taiwu.AddInventoryItem(mainThreadDataContext, itemKey, 1);
		return itemKey;
	}

	public static void TaiwuCollectTribute()
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		DomainManager.Adventure.CollectTribute(Domain.MainThreadDataContext, taiwuCharId, location.AreaId, location.BlockId);
	}

	public static bool TriggerBrideOpenContest(short settlementId)
	{
		MonthlyActionKey key = MonthlyEventActionsManager.PredefinedKeys["BrideOpenContestDefault"];
		ConfigWrapperAction configWrapperAction = (ConfigWrapperAction)Domain.GetMonthlyAction(key);
		if (configWrapperAction.CurrConfigMonthlyAction != null)
		{
			return false;
		}
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(settlement.GetLocation().AreaId);
		configWrapperAction.CreateWrappedAction(ConfigMonthlyActionDefines.OrgTemplateIdToContestForTaiwuBride[stateTemplateIdByAreaId], -1);
		return configWrapperAction.CurrConfigMonthlyAction != null;
	}

	public static bool IsAnyBrideOpenContestTriggered()
	{
		MonthlyActionKey key = MonthlyEventActionsManager.PredefinedKeys["BrideOpenContestDefault"];
		ConfigWrapperAction configWrapperAction = (ConfigWrapperAction)Domain.GetMonthlyAction(key);
		return configWrapperAction.CurrConfigMonthlyAction != null;
	}

	public static MonthlyActionKey TriggerTaiwuWeddingAdventure(int spouseCharId, Location location)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		MarriageTriggerAction marriageTriggerAction = new MarriageTriggerAction
		{
			SpouseCharId = spouseCharId,
			Location = location
		};
		DomainManager.TaiwuEvent.AddTempDynamicAction(mainThreadDataContext, marriageTriggerAction);
		return marriageTriggerAction.Key;
	}

	public static void SetCharacterMarriageStyle1(int charId, bool isShowMarriageStyle1)
	{
		if (isShowMarriageStyle1)
		{
			Domain.AppendMarriageLook1CharId(charId);
		}
		else
		{
			Domain.RemoveMarriageLook1CharId(charId);
		}
	}

	public static void SetCharacterMarriageStyle2(int charId, bool isShowMarriageStyle1)
	{
		if (isShowMarriageStyle1)
		{
			Domain.AppendMarriageLook2CharId(charId);
		}
		else
		{
			Domain.RemoveMarriageLook2CharId(charId);
		}
	}

	public static ItemKey RandomGiftForTaiwuMarriageAdventure(int charId, bool firstMarriage)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"{charId} is not an exist character id for RandomGiftForTaiwuMarriageAdventure");
		}
		Inventory inventory = element.GetInventory();
		List<ItemKey> bestItemList = new List<ItemKey>();
		List<ItemKey> midItemList = new List<ItemKey>();
		List<ItemKey> lowItemList = new List<ItemKey>();
		foreach (KeyValuePair<ItemKey, int> item in inventory.Items)
		{
			short itemSubType = ItemTemplateHelper.GetItemSubType(item.Key.ItemType, item.Key.TemplateId);
			if (itemSubType != 1203 && ItemTemplateHelper.IsTransferable(item.Key.ItemType, item.Key.TemplateId) && !IsItemPoisoned(item.Key))
			{
				sbyte grade = ItemTemplateHelper.GetGrade(item.Key.ItemType, item.Key.TemplateId);
				if (grade >= 6)
				{
					bestItemList.Add(item.Key);
				}
				else if (grade >= 3)
				{
					midItemList.Add(item.Key);
				}
				else
				{
					lowItemList.Add(item.Key);
				}
			}
		}
		if (lowItemList.Count + midItemList.Count + bestItemList.Count <= 0)
		{
			return ItemKey.Invalid;
		}
		sbyte favorabilityType = GetFavorabilityType(element, DomainManager.Taiwu.GetTaiwu());
		List<ItemKey> list = null;
		switch (favorabilityType)
		{
		case 6:
			list = ((!firstMarriage) ? GetRandomResult(25, 75, 0, midItemList) : GetRandomResult(0, 75, 25, midItemList));
			if (list.Count <= 0)
			{
				list.AddRange(bestItemList);
			}
			if (list.Count <= 0)
			{
				list.AddRange(midItemList);
			}
			if (list.Count <= 0)
			{
				list.AddRange(lowItemList);
			}
			return list.Sample();
		case 5:
			list = ((!firstMarriage) ? GetRandomResult(50, 50, 0, lowItemList) : GetRandomResult(25, 75, 0, midItemList));
			if (list.Count <= 0)
			{
				list.AddRange(midItemList);
			}
			if (list.Count <= 0)
			{
				list.AddRange(lowItemList);
			}
			if (list.Count <= 0)
			{
				list.AddRange(bestItemList);
			}
			return list.Sample();
		case 4:
			list = ((!firstMarriage) ? GetRandomResult(75, 25, 0, lowItemList) : GetRandomResult(50, 50, 0, lowItemList));
			if (list.Count <= 0)
			{
				list.AddRange(lowItemList);
			}
			if (list.Count <= 0)
			{
				list.AddRange(midItemList);
			}
			if (list.Count <= 0)
			{
				list.AddRange(bestItemList);
			}
			return list.Sample();
		default:
			list = ((!firstMarriage) ? GetRandomResult(100, 0, 0, lowItemList) : GetRandomResult(75, 25, 0, lowItemList));
			if (list.Count <= 0)
			{
				list.AddRange(lowItemList);
			}
			if (list.Count <= 0)
			{
				list.AddRange(midItemList);
			}
			if (list.Count <= 0)
			{
				list.AddRange(bestItemList);
			}
			return list.Sample();
		}
		List<ItemKey> GetRandomResult(int obbLow, int obbMid, int obbHigh, List<ItemKey> baseList)
		{
			List<ItemKey> list2 = new List<ItemKey>();
			list2.AddRange(baseList);
			if (baseList != bestItemList && Domain.MainThreadDataContext.Random.CheckPercentProb(obbHigh))
			{
				list2.AddRange(bestItemList);
			}
			if (baseList != midItemList && Domain.MainThreadDataContext.Random.CheckPercentProb(obbMid))
			{
				list2.AddRange(midItemList);
			}
			if (baseList != lowItemList && Domain.MainThreadDataContext.Random.CheckPercentProb(obbLow))
			{
				list2.AddRange(lowItemList);
			}
			return list2;
		}
	}

	public static Location CreateJuniorXiangshuAdventure(int juniorXiangshuCharId, short adventureId, Location bestLocation)
	{
		if (CheckMainStoryLineProgress(28))
		{
			return bestLocation;
		}
		if (!CheckBlockHasAdventure(bestLocation) && TryCreateAdventureSite(bestLocation.AreaId, bestLocation.BlockId, adventureId, setBlockVisible: true))
		{
			return bestLocation;
		}
		Location adventureGenerateRandomLocation = GetAdventureGenerateRandomLocation(bestLocation, 1, 4, 118, 119, 120, 121, 122, 123);
		if (DomainManager.Character.TryGetElement_Objects(juniorXiangshuCharId, out var element))
		{
			MoveFixedCharacter(element, adventureGenerateRandomLocation);
		}
		TryCreateAdventureSite(adventureGenerateRandomLocation.AreaId, adventureGenerateRandomLocation.BlockId, adventureId, setBlockVisible: true);
		return adventureGenerateRandomLocation;
	}

	public static void CreateAndEnterAdventure(Location location, short templateId)
	{
		if (TryCreateAdventureSite(location.AreaId, location.BlockId, templateId, setBlockVisible: false))
		{
			EnterAdventureFromEvent(templateId, location.BlockId);
		}
	}

	public static void EnterAdventureFromEvent(short templateId, short blockId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Adventure.EnterAdventure(mainThreadDataContext, templateId, null);
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.EnterAdventureFromEvent, templateId, blockId);
	}

	public static short GetXiangshuAvatarTemplateIdByXiangshuProgress(short startTemplateId)
	{
		sbyte xiangshuProgress = GetXiangshuProgress();
		int num = Math.Clamp(xiangshuProgress / 2, 0, 8);
		return (short)(startTemplateId + num);
	}

	public static void AddElopeLifeRecord(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("Lover");
		sbyte b = argBox.GetSbyte("SuccessLifeRecordBehaviorType");
		LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int currDate = DomainManager.World.GetCurrDate();
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(character.GetOrganizationInfo().OrgTemplateId);
		if (settlementByOrgTemplateId != null)
		{
			switch (b)
			{
			case 0:
				lifeRecordCollection.AddSectPunishElopeSucceedJust(taiwuCharId, currDate, character.GetId(), settlementByOrgTemplateId.GetId());
				break;
			case 1:
				lifeRecordCollection.AddSectPunishElopeSucceedKind(taiwuCharId, currDate, character.GetId(), settlementByOrgTemplateId.GetId());
				break;
			case 2:
				lifeRecordCollection.AddSectPunishElopeSucceedEven(taiwuCharId, currDate, character.GetId(), settlementByOrgTemplateId.GetId());
				break;
			default:
				lifeRecordCollection.AddSectPunishElopeSucceed(taiwuCharId, currDate, character.GetId(), settlementByOrgTemplateId.GetId());
				break;
			}
		}
	}

	public static string MartialArtContestSetChiefNeutral(EventArgBox argBox)
	{
		short sectApprovingRate = GetSectApprovingRate(6);
		short sectApprovingRate2 = GetSectApprovingRate(7);
		short sectApprovingRate3 = GetSectApprovingRate(8);
		short sectApprovingRate4 = GetSectApprovingRate(9);
		short sectApprovingRate5 = GetSectApprovingRate(10);
		short num = 0;
		int num2 = 0;
		List<short> list = new List<short> { sectApprovingRate, sectApprovingRate2, sectApprovingRate3, sectApprovingRate4, sectApprovingRate5 };
		for (int i = 0; i < list.Count; i++)
		{
			if (list[i] > num || (list[i] == num && CheckProbability(50)))
			{
				num2 = i;
				num = list[i];
			}
		}
		SetAdventureParameter("SectsPraise", num / 10);
		switch (num2)
		{
		case 0:
		{
			SetChief(argBox, 6);
			GameData.Domains.Character.Character character2 = argBox.GetCharacter("Chief");
			if (GetRoleAge(character2) >= GlobalConfig.Instance.AgeBaby)
			{
				return "757f180a-7c43-4d89-ae08-a5866d1858e9";
			}
			return "d92b0bf9-3530-4289-aaa8-15cf285e8313";
		}
		case 1:
		{
			SetChief(argBox, 7);
			GameData.Domains.Character.Character character5 = argBox.GetCharacter("Chief");
			if (GetRoleAge(character5) >= GlobalConfig.Instance.AgeBaby)
			{
				return "2bfa3320-4508-4913-bfdf-fe5270cb5960";
			}
			return "0ae8b931-82e9-4fb6-b8e5-ec07783b4d5b";
		}
		case 2:
		{
			SetChief(argBox, 8);
			GameData.Domains.Character.Character character3 = argBox.GetCharacter("Chief");
			if (GetRoleAge(character3) >= GlobalConfig.Instance.AgeBaby)
			{
				return "de2c394a-9b06-4f2d-8b25-dd9b3ed2e751";
			}
			return "02af8062-5582-4581-873e-c5a089652dc6";
		}
		case 3:
		{
			SetChief(argBox, 9);
			GameData.Domains.Character.Character character4 = argBox.GetCharacter("Chief");
			if (GetRoleAge(character4) >= GlobalConfig.Instance.AgeBaby)
			{
				return "b854ab03-2bdd-4cc1-8c3a-14f3bdcbd28d";
			}
			return "ce4700fc-3e12-4fab-8244-84251a1f9197";
		}
		case 4:
		{
			SetChief(argBox, 10);
			GameData.Domains.Character.Character character = argBox.GetCharacter("Chief");
			if (GetRoleAge(character) >= GlobalConfig.Instance.AgeBaby)
			{
				return "154273d8-e744-4653-8def-22e05b95a12d";
			}
			return "54c81ea6-e9a0-494a-8560-34b0b3e453c6";
		}
		default:
			return string.Empty;
		}
	}

	private static void SetChief(EventArgBox argBox, sbyte sectTemplateId)
	{
		int adventureParticipateCharacterCount = argBox.GetAdventureParticipateCharacterCount(1);
		for (int i = 0; i < adventureParticipateCharacterCount; i++)
		{
			GameData.Domains.Character.Character adventureParticipateCharacter = argBox.GetAdventureParticipateCharacter(1, i);
			if (adventureParticipateCharacter.GetOrganizationInfo().OrgTemplateId == sectTemplateId)
			{
				argBox.Set("Chief", adventureParticipateCharacter.GetId());
				break;
			}
		}
	}

	public static string MartialArtContestSetChiefEvil(EventArgBox argBox)
	{
		short sectApprovingRate = GetSectApprovingRate(11);
		short sectApprovingRate2 = GetSectApprovingRate(12);
		short sectApprovingRate3 = GetSectApprovingRate(13);
		short sectApprovingRate4 = GetSectApprovingRate(14);
		short sectApprovingRate5 = GetSectApprovingRate(15);
		Log("Approve0" + sectApprovingRate);
		Log("Approve1" + sectApprovingRate2);
		Log("Approve2" + sectApprovingRate3);
		Log("Approve3" + sectApprovingRate4);
		Log("Approve4" + sectApprovingRate5);
		short num = 0;
		int num2 = 0;
		List<short> list = new List<short> { sectApprovingRate, sectApprovingRate2, sectApprovingRate3, sectApprovingRate4, sectApprovingRate5 };
		for (int i = 0; i < list.Count; i++)
		{
			if (list[i] > num || (list[i] == num && CheckProbability(50)))
			{
				num2 = i;
				num = list[i];
			}
		}
		SetAdventureParameter("SectsPraise", num / 10);
		switch (num2)
		{
		case 0:
		{
			SetChief(argBox, 11);
			GameData.Domains.Character.Character character2 = argBox.GetCharacter("Chief");
			if (GetRoleAge(character2) >= GlobalConfig.Instance.AgeBaby)
			{
				return "4cc81136-f946-454c-bcd1-c1d7feddad31";
			}
			return "f97291aa-1e31-4d20-ac16-62ac2fadcc80";
		}
		case 1:
		{
			SetChief(argBox, 12);
			GameData.Domains.Character.Character character5 = argBox.GetCharacter("Chief");
			if (GetRoleAge(character5) >= GlobalConfig.Instance.AgeBaby)
			{
				return "40035a37-511d-46ad-a9c8-653440b61374";
			}
			return "67b309e2-83e5-499e-9d9f-4af56d276812";
		}
		case 2:
		{
			SetChief(argBox, 13);
			GameData.Domains.Character.Character character3 = argBox.GetCharacter("Chief");
			if (GetRoleAge(character3) >= GlobalConfig.Instance.AgeBaby)
			{
				return "3cec2064-5218-4a0e-958e-99f2eb8d919b";
			}
			return "737b38ae-723f-44ce-9e26-1a270c5f5081";
		}
		case 3:
		{
			SetChief(argBox, 14);
			GameData.Domains.Character.Character character4 = argBox.GetCharacter("Chief");
			if (GetRoleAge(character4) >= GlobalConfig.Instance.AgeBaby)
			{
				return "ee3c872f-560f-4093-a263-75fda1a81a89";
			}
			return "5dc62583-38f1-4dfd-a681-5e563bd9b0d4";
		}
		case 4:
		{
			SetChief(argBox, 15);
			GameData.Domains.Character.Character character = argBox.GetCharacter("Chief");
			if (GetRoleAge(character) >= GlobalConfig.Instance.AgeBaby)
			{
				return "ca44d23e-a8e5-47cc-971c-5cb60645de85";
			}
			return "eec59f50-30d7-4378-9881-a48ea7879686";
		}
		default:
			return string.Empty;
		}
	}

	public static string MartialArtContestSetChiefGood(EventArgBox argBox)
	{
		short sectApprovingRate = GetSectApprovingRate(1);
		short sectApprovingRate2 = GetSectApprovingRate(2);
		short sectApprovingRate3 = GetSectApprovingRate(3);
		short sectApprovingRate4 = GetSectApprovingRate(4);
		short sectApprovingRate5 = GetSectApprovingRate(5);
		short num = 0;
		int num2 = 0;
		List<short> list = new List<short> { sectApprovingRate, sectApprovingRate2, sectApprovingRate3, sectApprovingRate4, sectApprovingRate5 };
		for (int i = 0; i < list.Count; i++)
		{
			if (list[i] > num || (list[i] == num && CheckProbability(50)))
			{
				num2 = i;
				num = list[i];
			}
		}
		SetAdventureParameter("SectsPraise", num / 10);
		switch (num2)
		{
		case 0:
		{
			SetChief(argBox, 1);
			GameData.Domains.Character.Character character2 = argBox.GetCharacter("Chief");
			if (GetRoleAge(character2) >= GlobalConfig.Instance.AgeBaby)
			{
				return "d6842127-784f-4916-96f7-16dab9ad999a";
			}
			return "c98e04bb-03de-4064-86f7-df74f9168d4b";
		}
		case 1:
		{
			SetChief(argBox, 2);
			GameData.Domains.Character.Character character5 = argBox.GetCharacter("Chief");
			if (GetRoleAge(character5) >= GlobalConfig.Instance.AgeBaby)
			{
				return "3a9022cf-278b-409d-94da-b3c827b4cb71";
			}
			return "446ef9c7-f48f-48d4-bbcc-5c27b607f450";
		}
		case 2:
		{
			SetChief(argBox, 3);
			GameData.Domains.Character.Character character3 = argBox.GetCharacter("Chief");
			if (GetRoleAge(character3) >= GlobalConfig.Instance.AgeBaby)
			{
				return "e8f45ddc-6e92-407b-9a32-81aa188d9b09";
			}
			return "06de1b1d-bbd1-4503-bead-a7806f9f1381";
		}
		case 3:
		{
			SetChief(argBox, 4);
			GameData.Domains.Character.Character character4 = argBox.GetCharacter("Chief");
			if (GetRoleAge(character4) >= GlobalConfig.Instance.AgeBaby)
			{
				return "c73f9c93-18ce-4a8e-bccf-ead376d4c4a8";
			}
			return "4c2b723c-18c1-4202-a6d4-b7bfaf38dfad";
		}
		case 4:
		{
			SetChief(argBox, 5);
			GameData.Domains.Character.Character character = argBox.GetCharacter("Chief");
			if (GetRoleAge(character) >= GlobalConfig.Instance.AgeBaby)
			{
				return "f6aa3b41-0f1d-4387-96f6-abc74ff691fc";
			}
			return "b8e9c419-b4a1-4269-bb36-08a81c13c974";
		}
		default:
			return string.Empty;
		}
	}

	public static GameData.Domains.Character.Animal TryGetAnimal(int id)
	{
		if (DomainManager.Extra.TryGetAnimal(id, out var animal))
		{
			return animal;
		}
		throw new Exception($"Cannot find animal,animalId: {id}");
	}

	public static void RemoveAnimal(GameData.Domains.Character.Animal animal)
	{
		DomainManager.Extra.RemoveAnimal(Domain.MainThreadDataContext, animal);
	}

	public static GameData.Domains.Character.Animal GetOrCreateAnimalByItemKey(ItemKey itemKey)
	{
		return DomainManager.Extra.GetOrCreateAnimalByItemKey(Domain.MainThreadDataContext, itemKey);
	}

	public static int GetAnimalByLocationAndTemplateId(Location location, short characterTemplateId)
	{
		return DomainManager.Extra.GetAnimalByLocationAndTemplateId(Domain.MainThreadDataContext, location, characterTemplateId);
	}

	public static void RemoveSingleMapAnimalOnBlock(Location location, short animalCharacterId)
	{
		if (location.IsValid())
		{
			DomainManager.Extra.RemoveAnimalByLocationAndTemplateId(Domain.MainThreadDataContext, location, animalCharacterId);
		}
	}

	public static void MapAnimalEscapeToNearbyBlock(Location location)
	{
		if (!location.IsValid() || !DomainManager.Extra.TryGetAnimalsByLocation(location, out var animals))
		{
			return;
		}
		MapBlockData block = DomainManager.Map.GetBlock(location);
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Adventure.GetValidBlocksForRandomEnemy(location.AreaId, block.BlockId, 2, onAdventureSite: false, onSettlement: false, nearTaiwu: true, list);
		foreach (GameData.Domains.Character.Animal item in animals)
		{
			MapBlockData random = list.GetRandom(mainThreadDataContext.Random);
			Location location2 = random.GetLocation();
			DomainManager.Extra.SetAnimalLocation(mainThreadDataContext, item, location2);
		}
		ObjectPool<List<MapBlockData>>.Instance.Return(list);
	}

	public static void RemoveFleeCarrierLocation(ItemKey itemKey)
	{
		DomainManager.Extra.RemoveFleeCarrierLocation(Domain.MainThreadDataContext, itemKey);
	}

	public static string HandleAnimalCombatResult(EventArgBox argBox, bool isDieCombat)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		int arg = -1;
		argBox.Get("AnimalId", ref arg);
		GameData.Domains.Character.Animal animal = TryGetAnimal(arg);
		short arg2 = -1;
		argBox.Get("AnimalCharacterTemplateId", ref arg2);
		CharacterItem characterItem = Config.Character.Instance[arg2];
		ItemKey itemKey = animal.ItemKey;
		bool arg3 = false;
		if (argBox.Get<ItemKey>("CarrierItemKeyGotInCombat", out ItemKey arg4))
		{
			argBox.Get<ItemKey>("ItemKeySeizeCarrierInCombat", out ItemKey arg5);
			argBox.Remove<ItemKey>("CarrierItemKeyGotInCombat");
			argBox.Remove<ItemKey>("ItemKeySeizeCharacterInCombat");
			ProfessionFormulaItem formulaCfg = ProfessionFormula.Instance[10];
			ChangeProfessionSeniority(1, formulaCfg.Calculate(characterItem.ConsummateLevel));
			string afterEvent = "";
			if (itemKey.IsValid())
			{
				RemoveInventoryOrEquipItem(character, arg4);
				arg4 = itemKey;
				RemoveFleeCarrierLocation(arg4);
				argBox.Set("EscapeCarriers", Config.Carrier.Instance[arg4.TemplateId].Name);
				AddItemToRole(character, itemKey, 1, -1);
				ApplyAnimalTamingResult(character, animal, isWin: true, character.GetLocation(), arg5);
				LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
				int gameDate = GetGameDate();
				lifeRecordCollection.AddTameCarrierSucceed(character.GetId(), gameDate, itemKey.ItemType, itemKey.TemplateId, character.GetLocation());
				afterEvent = "33fb78b2-c124-4919-96d6-6b98d4ce3712";
			}
			ShowGetItemPageForItems(new List<(ItemKey, int)> { (arg4, 1) }, afterEvent, argBox);
			RemoveAnimal(animal);
			SetOnHandlingMonthlyEventBlock(blockOperation: false);
			return string.Empty;
		}
		ProfessionFormulaItem formulaCfg2 = ProfessionFormula.Instance[9];
		int arg6 = 0;
		if (argBox.Get("CombatResult", ref arg6))
		{
			switch (arg6)
			{
			case 0:
			case 5:
				ChangeProfessionSeniority(1, formulaCfg2.Calculate(characterItem.ConsummateLevel));
				if (argBox.Get("UseHunterSkill1", ref arg3) && arg3)
				{
					Dictionary<Location, List<short>> dictionary = new Dictionary<Location, List<short>>();
					dictionary.Add(character.GetLocation(), new List<short> { arg2 });
					List<ItemKey> escapeCarriers = new List<ItemKey>();
					List<(ItemKey, int)> itemList = HunterGetCarriers(dictionary, ref escapeCarriers);
					if (escapeCarriers.Count > 0)
					{
						string text = "";
						for (int i = 0; i < escapeCarriers.Count; i++)
						{
							CarrierItem carrierItem = Config.Carrier.Instance[escapeCarriers[i].TemplateId];
							text += carrierItem.Name;
							if (i != escapeCarriers.Count - 1)
							{
								text += "";
							}
						}
						argBox.Set("EscapeCarriers", text);
					}
					string afterEvent2 = ((escapeCarriers.Count > 0) ? "33fb78b2-c124-4919-96d6-6b98d4ce3712" : string.Empty);
					ShowGetItemPageForItems(itemList, afterEvent2, argBox);
				}
				else if (itemKey.IsValid())
				{
					string afterEvent3 = "33fb78b2-c124-4919-96d6-6b98d4ce3712";
					RemoveFleeCarrierLocation(itemKey);
					argBox.Set("EscapeCarriers", Config.Carrier.Instance[itemKey.TemplateId].Name);
					AddItemToRole(character, itemKey, 1, -1);
					ApplyAnimalTamingResult(character, animal, isWin: true, character.GetLocation(), ItemKey.Invalid);
					LifeRecordCollection lifeRecordCollection3 = GetLifeRecordCollection();
					int gameDate3 = GetGameDate();
					lifeRecordCollection3.AddTameCarrierSucceed(character.GetId(), gameDate3, itemKey.ItemType, itemKey.TemplateId, character.GetLocation());
					ShowGetItemPageForItems(new List<(ItemKey, int)> { (itemKey, 1) }, afterEvent3, argBox);
				}
				RemoveAnimal(animal);
				SetOnHandlingMonthlyEventBlock(blockOperation: false);
				return string.Empty;
			case 1:
			case 2:
			case 4:
				if (arg6 != 2 && isDieCombat)
				{
					return "36747168-c095-4365-8f5c-69795b1c216c";
				}
				if (itemKey.IsValid())
				{
					LifeRecordCollection lifeRecordCollection4 = GetLifeRecordCollection();
					int gameDate4 = GetGameDate();
					lifeRecordCollection4.AddTameCarrierFail(character.GetId(), gameDate4, itemKey.ItemType, itemKey.TemplateId, character.GetLocation());
				}
				return "91afe2cb-ae83-4167-a834-811b7dcf7008";
			case 3:
				ChangeProfessionSeniority(1, formulaCfg2.Calculate(characterItem.ConsummateLevel));
				if (itemKey.IsValid())
				{
					LifeRecordCollection lifeRecordCollection2 = GetLifeRecordCollection();
					int gameDate2 = GetGameDate();
					lifeRecordCollection2.AddTameCarrierFail(character.GetId(), gameDate2, itemKey.ItemType, itemKey.TemplateId, character.GetLocation());
				}
				return "3a863e8f-5dc2-46d5-8f20-d405c7dcd98b";
			default:
				return string.Empty;
			}
		}
		SetOnHandlingMonthlyEventBlock(blockOperation: false);
		return string.Empty;
	}

	[Obsolete]
	public static void RemoveFleeCarrierLocation(int itemId)
	{
		ItemKey itemKey = ItemKey.Invalid;
		GameData.Domains.Item.Material element2;
		GameData.Domains.Item.Medicine element3;
		if (DomainManager.Item.TryGetElement_Carriers(itemId, out var element))
		{
			itemKey = element.GetItemKey();
		}
		else if (DomainManager.Item.TryGetElement_Materials(itemId, out element2))
		{
			itemKey = element2.GetItemKey();
		}
		else if (DomainManager.Item.TryGetElement_Medicines(itemId, out element3))
		{
			itemKey = element3.GetItemKey();
		}
		if (DomainManager.Extra.TryGetAnimalByItemKey(itemKey, out var _))
		{
			DomainManager.Extra.RemoveFleeCarrierLocation(Domain.MainThreadDataContext, itemKey);
		}
	}

	[Obsolete]
	public static ItemKey GetFleeCarrierByLocation(short templateId, Location location)
	{
		return DomainManager.Extra.GetFleeCarrierByLocation(templateId, location);
	}

	[Obsolete]
	public static void RemoveMapAnimalOnBlock(Location location)
	{
		DomainManager.Map.RemoveBlockAnimal(location, Domain.MainThreadDataContext);
	}

	public static EventArgBox GetGlobalArgBox()
	{
		return Domain.GetGlobalEventArgumentBox();
	}

	public static void SaveGlobalArg<T>(string key, T value)
	{
		Domain.SaveArgToGlobalArgBox(key, value);
	}

	public static void ClearGlobalArgBox()
	{
		Domain.ClearGlobalEventArgumentBox();
	}

	public static bool GlobalArgBoxContainsKey<T>(string key)
	{
		return GetGlobalArgBox().Contains<T>(key);
	}

	public static void RemoveFromGlobalArgBox<T>(string key)
	{
		GetGlobalArgBox().Remove<T>(key);
		Domain.SaveGlobalEventArgumentBox();
	}

	public static byte GetByteFromGlobalArgBox(string key)
	{
		byte arg = 0;
		GetGlobalArgBox().Get(key, ref arg);
		return arg;
	}

	public static sbyte GetSbyteFromGlobalArgBox(string key)
	{
		sbyte arg = 0;
		GetGlobalArgBox().Get(key, ref arg);
		return arg;
	}

	public static short GetShortFromGlobalArgBox(string key)
	{
		short arg = 0;
		GetGlobalArgBox().Get(key, ref arg);
		return arg;
	}

	public static ushort GetUshortFromGlobalArgBox(string key)
	{
		ushort arg = 0;
		GetGlobalArgBox().Get(key, ref arg);
		return arg;
	}

	public static int GetIntFromGlobalArgBox(string key)
	{
		int arg = 0;
		GetGlobalArgBox().Get(key, ref arg);
		return arg;
	}

	public static float GetFloatFromGlobalArgBox(string key)
	{
		float arg = 0f;
		GetGlobalArgBox().Get(key, ref arg);
		return arg;
	}

	public static bool GetBoolFromGlobalArgBox(string key)
	{
		bool arg = false;
		GetGlobalArgBox().Get(key, ref arg);
		return arg;
	}

	public static string GetStringFromGlobalArgBox(string key)
	{
		string arg = string.Empty;
		GetGlobalArgBox().Get(key, ref arg);
		return arg;
	}

	public static T GetObjectFromGlobalArgBox<T>(string key) where T : ISerializableGameData
	{
		GetGlobalArgBox().Get(key, out T arg);
		return arg;
	}

	public unsafe static short GetRoleCurrentMainAttributes(GameData.Domains.Character.Character character, sbyte attrType)
	{
		if (character == null)
		{
			return 0;
		}
		MainAttributes currMainAttributes = character.GetCurrMainAttributes();
		return currMainAttributes.Items[attrType];
	}

	public unsafe static int GetRoleHitValue(GameData.Domains.Character.Character character, sbyte attackHitType)
	{
		if (character == null)
		{
			throw new Exception("null character to change GetRoleHitValue!");
		}
		HitOrAvoidInts hitValues = character.GetHitValues();
		return hitValues.Items[attackHitType];
	}

	public unsafe static int GetRoleAvoidValue(GameData.Domains.Character.Character character, sbyte attackHitType)
	{
		if (character == null)
		{
			throw new Exception("null character to change GetRoleAvoidValue!");
		}
		HitOrAvoidInts avoidValues = character.GetAvoidValues();
		return avoidValues.Items[attackHitType];
	}

	public static int GetRolePenetrationValue(GameData.Domains.Character.Character character, bool inner)
	{
		if (character == null)
		{
			throw new Exception("null character to change GetRoleAvoidValue!");
		}
		OuterAndInnerInts penetrations = character.GetPenetrations();
		return inner ? penetrations.Inner : penetrations.Outer;
	}

	public static int GetRolePenetrationResistValue(GameData.Domains.Character.Character character, bool inner)
	{
		if (character == null)
		{
			throw new Exception("null character to change GetRolePenetrationResistValue!");
		}
		OuterAndInnerInts penetrationResists = character.GetPenetrationResists();
		return inner ? penetrationResists.Inner : penetrationResists.Outer;
	}

	public unsafe static short GetRoleMaxMainAttributes(GameData.Domains.Character.Character character, sbyte attrType)
	{
		if (character == null)
		{
			return 0;
		}
		MainAttributes maxMainAttributes = character.GetMaxMainAttributes();
		return maxMainAttributes.Items[attrType];
	}

	public unsafe static int GetRolePoisonByType(GameData.Domains.Character.Character character, sbyte poisonType)
	{
		if (character == null)
		{
			return 0;
		}
		return character.GetPoisoned().Items[poisonType];
	}

	public unsafe static int GetRolePoisonResistByType(GameData.Domains.Character.Character character, sbyte poisonType)
	{
		if (character == null)
		{
			return 0;
		}
		if (character.HasPoisonImmunity(poisonType))
		{
			return -1;
		}
		return character.GetPoisonResists().Items[poisonType];
	}

	public static short GetRoleDisorderOfQiMaxValue()
	{
		return DisorderLevelOfQi.MaxValue;
	}

	public static short GetRoleDisorderOfQi(GameData.Domains.Character.Character character)
	{
		return character?.GetDisorderOfQi() ?? 0;
	}

	public static sbyte GetDisorderLevelOfQi(GameData.Domains.Character.Character character)
	{
		return DisorderLevelOfQi.GetDisorderLevelOfQi(GetRoleDisorderOfQi(character));
	}

	public static void ChangeBaseMainAttribute(GameData.Domains.Character.Character character, sbyte mainAttributeType, short delta)
	{
		character.ChangeBaseMainAttribute(Domain.MainThreadDataContext, mainAttributeType, delta);
	}

	public static void PrenatalEducateForMainAttribute(short bonus)
	{
		DomainManager.Taiwu.PrenatalEducateForMainAttribute(Domain.MainThreadDataContext, bonus);
	}

	public static void PrenatalEducateForLifeSkill(short bonus)
	{
		DomainManager.Taiwu.PrenatalEducateForLifeSkill(Domain.MainThreadDataContext, bonus);
	}

	public static void PrenatalEducateForCombatSkill(short bonus)
	{
		DomainManager.Taiwu.PrenatalEducateForCombatSkill(Domain.MainThreadDataContext, bonus);
	}

	public static void ChangeRoleDisorderOfQi(GameData.Domains.Character.Character character, short delta)
	{
		if (character == null)
		{
			throw new Exception("null character to change DisorderOfQi!");
		}
		short disorderOfQi = character.GetDisorderOfQi();
		character.ChangeDisorderOfQi(Domain.MainThreadDataContext, delta);
		if (character.GetId() == DomainManager.Taiwu.GetTaiwuCharId() && DomainManager.Taiwu.IsInGroup(character.GetId()))
		{
			short disorderOfQi2 = character.GetDisorderOfQi();
			int num = disorderOfQi2 - disorderOfQi;
			InstantNotificationCollection instantNotificationCollection = DomainManager.World.GetInstantNotificationCollection();
			if (num > 0)
			{
				instantNotificationCollection.AddDisorderOfQiIncreased(character.GetId(), num / 10);
			}
			else if (num < 0)
			{
				instantNotificationCollection.AddDisorderOfQiDecreased(character.GetId(), -num / 10);
			}
		}
	}

	public unsafe static short GetRoleLifeSkillQualificationByType(GameData.Domains.Character.Character character, sbyte skillType)
	{
		if (character == null)
		{
			return 0;
		}
		return character.GetLifeSkillQualifications().Items[skillType];
	}

	public unsafe static short GetRoleBaseLifeSkillQualificationByType(GameData.Domains.Character.Character character, sbyte skillType)
	{
		if (character == null)
		{
			return 0;
		}
		return character.GetBaseLifeSkillQualifications().Items[skillType];
	}

	public static short GetRoleLifeSkillAttainmentByType(GameData.Domains.Character.Character character, sbyte skillType)
	{
		return character?.GetLifeSkillAttainment(skillType) ?? 0;
	}

	public static short GetRoleLifeSkillAttainmentWithQualification(GameData.Domains.Character.Character character, sbyte skillType)
	{
		return character?.GetLifeSkillAttainment(skillType) ?? 0;
	}

	public unsafe static short GetRoleCombatSkillQualificationByType(GameData.Domains.Character.Character character, sbyte skillType)
	{
		if (character == null)
		{
			return 0;
		}
		return character.GetCombatSkillQualifications().Items[skillType];
	}

	public unsafe static short GetRoleBaseCombatSkillQualificationByType(GameData.Domains.Character.Character character, sbyte skillType)
	{
		if (character == null)
		{
			return 0;
		}
		return character.GetBaseCombatSkillQualifications().Items[skillType];
	}

	public static short GetRoleCombatSkillAttainmentByType(GameData.Domains.Character.Character character, sbyte skillType)
	{
		return character?.GetCombatSkillAttainment(skillType) ?? 0;
	}

	public static short GetRoleCombatSkillAttainmentWithQualification(GameData.Domains.Character.Character character, sbyte skillType)
	{
		return character?.GetCombatSkillAttainment(skillType) ?? 0;
	}

	public static short GetRoleAge(GameData.Domains.Character.Character character)
	{
		return character?.GetPhysiologicalAge() ?? 0;
	}

	public static short GetRoleCurrAge(GameData.Domains.Character.Character character)
	{
		return character?.GetCurrAge() ?? 0;
	}

	public static short GetRoleActualAge(GameData.Domains.Character.Character character)
	{
		return character?.GetActualAge() ?? 0;
	}

	public static bool GetRoleAgeAvailableForLove(GameData.Domains.Character.Character character)
	{
		if (character == null)
		{
			return false;
		}
		return AgeGroup.GetAgeGroup(GetRoleAge(character)) == 2 && AgeGroup.GetAgeGroup(GetRoleActualAge(character)) == 2;
	}

	public static short GetRoleHealthMax(GameData.Domains.Character.Character character)
	{
		return character?.GetMaxHealth() ?? 0;
	}

	public static short GetRoleLeftMaxHealth(GameData.Domains.Character.Character character)
	{
		return character?.GetLeftMaxHealth() ?? 0;
	}

	public static void ChangeRoleBaseHealth(GameData.Domains.Character.Character character, short delta)
	{
		if (delta != 0)
		{
			if (character == null)
			{
				throw new Exception("null character to ChangeRoleBaseHealth!");
			}
			short baseMaxHealth = (short)Math.Clamp(character.GetBaseMaxHealth() + delta, -32768, 32767);
			character.SetBaseMaxHealth(baseMaxHealth, Domain.MainThreadDataContext);
		}
	}

	public static short GetRoleBirthMonth(GameData.Domains.Character.Character character)
	{
		return character?.GetBirthMonth() ?? 0;
	}

	public static sbyte GetRoleGender(GameData.Domains.Character.Character character)
	{
		return character?.GetGender() ?? (-1);
	}

	public static sbyte GetRoleBehavior(GameData.Domains.Character.Character character)
	{
		return character?.GetBehaviorType() ?? (-1);
	}

	public static void ChangeRoleBaseBehaviorValue(GameData.Domains.Character.Character character, int delta)
	{
		if (delta != 0)
		{
			if (character == null)
			{
				throw new Exception("null character to ChangeRoleBaseBehaviorValue!");
			}
			sbyte behaviorType = character.GetBehaviorType();
			character.ChangeBaseMorality(Domain.MainThreadDataContext, delta);
			sbyte behaviorType2 = character.GetBehaviorType();
			if (behaviorType != behaviorType2 && DomainManager.Taiwu.IsInGroup(character.GetId()))
			{
				InstantNotificationCollection instantNotificationCollection = DomainManager.World.GetInstantNotificationCollection();
				instantNotificationCollection.AddBehaviorTypeChanged(character.GetId(), behaviorType2);
			}
		}
	}

	public static void ChangeRoleBehaviorType(GameData.Domains.Character.Character character, sbyte behaviorType)
	{
		sbyte behaviorType2 = character.GetBehaviorType();
		int num = (GameData.Domains.Character.BehaviorType.Ranges[behaviorType].max + GameData.Domains.Character.BehaviorType.Ranges[behaviorType].min) / 2;
		character.SetBaseMorality((short)num, Domain.MainThreadDataContext);
		sbyte behaviorType3 = character.GetBehaviorType();
		if (behaviorType2 != behaviorType3 && DomainManager.Taiwu.IsInGroup(character.GetId()))
		{
			InstantNotificationCollection instantNotificationCollection = DomainManager.World.GetInstantNotificationCollection();
			instantNotificationCollection.AddBehaviorTypeChanged(character.GetId(), behaviorType3);
		}
	}

	public static sbyte GetRoleFameType(GameData.Domains.Character.Character character)
	{
		return character?.GetFameType() ?? (-1);
	}

	public static sbyte GetRoleFame(GameData.Domains.Character.Character character)
	{
		return character?.GetFame() ?? 0;
	}

	public static int GetRoleResource(GameData.Domains.Character.Character character, sbyte resourceType)
	{
		return character?.GetResource(resourceType) ?? 0;
	}

	public static void ChangeRoleResource(GameData.Domains.Character.Character character, sbyte resourceType, int delta, bool addNotification = true)
	{
		if (character == null)
		{
			throw new Exception("null character to change resource!");
		}
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		if (taiwuCharId == character.GetId())
		{
			character.ChangeResource(Domain.MainThreadDataContext, resourceType, delta);
			if (addNotification && DomainManager.Taiwu.IsInGroup(character.GetId()))
			{
				InstantNotificationCollection instantNotificationCollection = DomainManager.World.GetInstantNotificationCollection();
				if (delta > 0)
				{
					instantNotificationCollection.AddResourceIncreased(character.GetId(), resourceType, delta);
				}
				else if (delta < 0)
				{
					instantNotificationCollection.AddResourceDecreased(character.GetId(), resourceType, -delta);
				}
			}
		}
		else
		{
			character.ChangeResource(Domain.MainThreadDataContext, resourceType, delta);
		}
	}

	public static int CalcResourceChangeByWorldResourceAmount(int delta)
	{
		if (DomainManager.Adventure.GetCurAdventureId() >= 0)
		{
			delta = delta * DomainManager.World.GetGainResourcePercent(5) / 100;
		}
		return delta;
	}

	public static void ChangeRoleExp(GameData.Domains.Character.Character character, int delta)
	{
		character.ChangeExp(Domain.MainThreadDataContext, delta);
		if (character.GetId() != DomainManager.Taiwu.GetTaiwuCharId())
		{
			return;
		}
		InstantNotificationCollection instantNotificationCollection = DomainManager.World.GetInstantNotificationCollection();
		if (DomainManager.Taiwu.IsInGroup(character.GetId()))
		{
			if (delta > 0)
			{
				instantNotificationCollection.AddExpIncreased(character.GetId(), delta);
			}
			else if (delta < 0)
			{
				instantNotificationCollection.AddExpDecreased(character.GetId(), -delta);
			}
		}
	}

	public static int GetRoleExp(GameData.Domains.Character.Character character)
	{
		return character.GetExp();
	}

	public unsafe static sbyte GetRolePersonality(GameData.Domains.Character.Character character, sbyte personalityType)
	{
		if (character == null)
		{
			return 0;
		}
		Personalities personalities = character.GetPersonalities();
		return personalities.Items[personalityType];
	}

	public static byte GetRoleMonkType(GameData.Domains.Character.Character character)
	{
		return character?.GetMonkType() ?? 0;
	}

	public static short GetRoleCharm(GameData.Domains.Character.Character character)
	{
		return character?.GetAttraction() ?? 0;
	}

	public static sbyte GetRoleCharmType(GameData.Domains.Character.Character character)
	{
		if (character == null)
		{
			return 3;
		}
		return AttractionType.GetAttractionType(character.GetAttraction());
	}

	public static sbyte GetRoleHappiness(GameData.Domains.Character.Character character)
	{
		return character?.GetHappiness() ?? 0;
	}

	public static sbyte GetRoleHappinessType(GameData.Domains.Character.Character character)
	{
		return character?.GetHappinessType() ?? (-1);
	}

	public static int GetRoleSamsaraCount(GameData.Domains.Character.Character character)
	{
		return character?.GetPreexistenceCharIds().Count ?? 0;
	}

	public static sbyte GetRoleGrade(GameData.Domains.Character.Character character)
	{
		return character?.GetInteractionGrade() ?? 0;
	}

	public static short GetFavorability(GameData.Domains.Character.Character characterA, GameData.Domains.Character.Character characterB)
	{
		if (characterA == null || characterB == null)
		{
			return short.MinValue;
		}
		return DomainManager.Character.GetFavorability(characterA.GetId(), characterB.GetId());
	}

	[Obsolete("Use ChangeFavorabilityOptional instead")]
	public static void ChangeFavorability(GameData.Domains.Character.Character characterA, GameData.Domains.Character.Character characterB, short changeValue, sbyte personalityType = -1, sbyte requiredPersonality = 0)
	{
		ChangeFavorabilityOptional(characterA, characterB, changeValue, -1);
	}

	public static void ChangeFavorabilityOptional(GameData.Domains.Character.Character characterA, GameData.Domains.Character.Character characterB, short changeValue, short type)
	{
		if (characterA == null || characterB == null)
		{
			throw new Exception("can not set character favorability for null character!");
		}
		int id = characterA.GetId();
		int id2 = characterB.GetId();
		if (id != id2)
		{
			short favorability = DomainManager.Character.GetFavorability(id, id2);
			if (favorability == short.MinValue)
			{
				DomainManager.Character.TryCreateGeneralRelation(Domain.MainThreadDataContext, characterA, characterB);
				favorability = DomainManager.Character.GetFavorability(id, id2);
			}
			DomainManager.Character.ChangeFavorabilityOptional(Domain.MainThreadDataContext, characterA, characterB, changeValue, type);
			if (id2 == DomainManager.Taiwu.GetTaiwuCharId())
			{
				DomainManager.TaiwuEvent.RecordFavorabilityToTaiwuChanged(id, changeValue);
			}
			DomainManager.Character.AddFavorabilityChangeInstantNotification(characterA, characterB, changeValue > 0);
		}
	}

	public static short ClampFavorabilityChangeValue(int changeValue)
	{
		return (short)Math.Clamp(changeValue, -32768, 32767);
	}

	public static void ChangeFavorabilityOptionalFirstSightFavorability(GameData.Domains.Character.Character characterA, GameData.Domains.Character.Character characterB, short changeValue)
	{
		ChangeFavorabilityOptional(characterA, characterB, changeValue, 0);
	}

	public static void ChangeFavorabilityOptionalGiftItem(GameData.Domains.Character.Character characterA, GameData.Domains.Character.Character characterB, short changeValue)
	{
		ChangeFavorabilityOptional(characterA, characterB, changeValue, 1);
	}

	public static void ChangeFavorabilityOptionalShareInformation(GameData.Domains.Character.Character characterA, GameData.Domains.Character.Character characterB, short changeValue)
	{
		ChangeFavorabilityOptional(characterA, characterB, changeValue, 2);
	}

	public static void ChangeFavorabilityOptionalRepeatedEvent(GameData.Domains.Character.Character characterA, GameData.Domains.Character.Character characterB, short changeValue)
	{
		ChangeFavorabilityOptional(characterA, characterB, changeValue, 3);
	}

	public static void ChangeFavorabilityOptionalStoryEvent(GameData.Domains.Character.Character characterA, GameData.Domains.Character.Character characterB, short changeValue)
	{
		ChangeFavorabilityOptional(characterA, characterB, changeValue, 4);
	}

	public static void ChangeFavorabilityOptionalMonthlyEvolution(GameData.Domains.Character.Character characterA, GameData.Domains.Character.Character characterB, short changeValue)
	{
		ChangeFavorabilityOptional(characterA, characterB, changeValue, 5);
	}

	[Obsolete("Use ChangeFavorabilityWithMergeOptional instead")]
	public static void ChangeFavorabilityWithMerge(GameData.Domains.Character.Character characterA, GameData.Domains.Character.Character characterB, short changeValue, sbyte personalityType = -1, sbyte requiredPersonality = 0, bool isMerge = false)
	{
		ChangeFavorabilityWithMergeOptional(characterA, characterB, changeValue, -1, isMerge);
	}

	public static void ChangeFavorabilityWithMergeOptional(GameData.Domains.Character.Character characterA, GameData.Domains.Character.Character characterB, short changeValue, short type, bool isMerge = false)
	{
		if (characterA == null || characterB == null)
		{
			throw new Exception("can not set character favorability for null character!");
		}
		int id = characterA.GetId();
		int id2 = characterB.GetId();
		if (id != id2)
		{
			DomainManager.Character.ChangeFavorabilityOptional(Domain.MainThreadDataContext, characterA, characterB, changeValue, type);
			if (id2 == DomainManager.Taiwu.GetTaiwuCharId())
			{
				DomainManager.TaiwuEvent.RecordFavorabilityToTaiwuChanged(id, changeValue);
			}
			DomainManager.Character.AddFavorabilityChangeInstantNotification(characterA, characterB, changeValue > 0);
		}
	}

	[Obsolete("Use DirectlyChangeFavorabilityOptional instead")]
	public static void DirectlyChangeFavorability(GameData.Domains.Character.Character character, GameData.Domains.Character.Character relatedChar, int delta)
	{
		DirectlyChangeFavorabilityOptional(character, relatedChar, delta, -1);
	}

	public static void DirectlyChangeFavorabilityOptional(GameData.Domains.Character.Character character, GameData.Domains.Character.Character relatedChar, int delta, short type = -1)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Character.DirectlyChangeFavorabilityOptional(mainThreadDataContext, character, relatedChar, delta, type);
	}

	public static void DirectlyChangeFavorabilityOptionalStoryEvent(GameData.Domains.Character.Character character, GameData.Domains.Character.Character relatedChar, int delta)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Character.DirectlyChangeFavorabilityOptional(mainThreadDataContext, character, relatedChar, delta, 4);
	}

	public static void DirectlySetFavorabilities(int charId, int relatedCharId, short value, short relatedValue)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Character.DirectlySetFavorabilities(mainThreadDataContext, charId, relatedCharId, value, relatedValue);
	}

	public static void DirectlyUpgradeFavorability(int charA, int charB)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Character.DirectlyUpgradeFavorability(mainThreadDataContext, charA, charB);
	}

	public static sbyte GetFavorabilityType(GameData.Domains.Character.Character characterA, GameData.Domains.Character.Character characterB)
	{
		if (characterA == null || characterB == null)
		{
			return sbyte.MinValue;
		}
		return FavorabilityType.GetFavorabilityType(DomainManager.Character.GetFavorability(characterA.GetId(), characterB.GetId()));
	}

	public static void ChangeXiangshuAvatarFavorability(sbyte xiangshuAvatarId, int delta)
	{
		DomainManager.World.ChangeXiangshuAvatarFavorability(Domain.MainThreadDataContext, xiangshuAvatarId, delta);
	}

	public static sbyte GetXiangshuAvatarFavorabilityType(sbyte xiangshuAvatarId)
	{
		return DomainManager.World.GetXiangshuAvatarFavorabilityType(xiangshuAvatarId);
	}

	public static void RecordRoleFameAction(GameData.Domains.Character.Character character, short fameActionId, int targetCharId = -1, short fameMultiplier = 1)
	{
		character.RecordFameAction(Domain.MainThreadDataContext, fameActionId, targetCharId, fameMultiplier);
		if (character.GetId() == DomainManager.Taiwu.GetTaiwuCharId())
		{
			InstantNotificationCollection instantNotificationCollection = DomainManager.World.GetInstantNotificationCollection();
			sbyte fame = FameAction.Instance[fameActionId].Fame;
			if (fame > 0)
			{
				instantNotificationCollection.AddFameIncreased(character.GetId());
			}
			else if (fame < 0)
			{
				instantNotificationCollection.AddFameDecreased(character.GetId());
			}
		}
	}

	public static void RecordRoleFameActionJumpByFameType(GameData.Domains.Character.Character character, short fameActionId, sbyte targetFameType = -1, short fameMultiplier = 1)
	{
		character.RecordFameAction(Domain.MainThreadDataContext, fameActionId, targetFameType, fameMultiplier);
		if (character.GetId() == DomainManager.Taiwu.GetTaiwuCharId())
		{
			InstantNotificationCollection instantNotificationCollection = DomainManager.World.GetInstantNotificationCollection();
			sbyte fame = FameAction.Instance[fameActionId].Fame;
			if (fame > 0)
			{
				instantNotificationCollection.AddFameIncreased(character.GetId());
			}
			else if (fame < 0)
			{
				instantNotificationCollection.AddFameDecreased(character.GetId());
			}
		}
	}

	public unsafe static void SetRoleMainAttribute(GameData.Domains.Character.Character character, sbyte attrType, short attrValue)
	{
		if (character == null)
		{
			throw new Exception("null character to set MainAttributes!");
		}
		MainAttributes maxMainAttributes = character.GetMaxMainAttributes();
		MainAttributes currMainAttributes = character.GetCurrMainAttributes();
		attrValue = (short)((maxMainAttributes.Items[attrType] > 0) ? Math.Clamp(attrValue, (short)0, maxMainAttributes.Items[attrType]) : 0);
		currMainAttributes.Items[attrType] = attrValue;
		character.SetCurrMainAttributes(currMainAttributes, Domain.MainThreadDataContext);
	}

	public static void ChangeRoleMainAttribute(GameData.Domains.Character.Character character, sbyte attrType, int changeValue)
	{
		if (character == null)
		{
			throw new Exception("null character to change MainAttributes!");
		}
		character.ChangeCurrMainAttribute(Domain.MainThreadDataContext, attrType, changeValue);
		InstantNotificationCollection instantNotificationCollection = DomainManager.World.GetInstantNotificationCollection();
		short characterPropertyReferencedType = (short)(attrType + 0);
		if (changeValue > 0)
		{
			instantNotificationCollection.AddMainAttributeRecovered(character.GetId(), characterPropertyReferencedType, changeValue);
		}
		else if (changeValue < 0)
		{
			instantNotificationCollection.AddMainAttributeConsumed(character.GetId(), characterPropertyReferencedType, -changeValue);
		}
	}

	public static void SetRoleHappiness(GameData.Domains.Character.Character character, sbyte newValue)
	{
		if (character == null)
		{
			throw new Exception("null character to set Happiness!");
		}
		newValue = Math.Clamp(newValue, -119, 119);
		character.SetHappiness(newValue, Domain.MainThreadDataContext);
	}

	public static void ChangeRoleHappiness(GameData.Domains.Character.Character character, int deltaValue)
	{
		if (character == null)
		{
			throw new Exception("null character to change Happiness!");
		}
		character.ChangeHappiness(Domain.MainThreadDataContext, deltaValue);
		if (DomainManager.Taiwu.IsInGroup(character.GetId()))
		{
			InstantNotificationCollection instantNotificationCollection = DomainManager.World.GetInstantNotificationCollection();
			if (deltaValue > 0)
			{
				instantNotificationCollection.AddHappinessIncreased(character.GetId());
			}
			else if (deltaValue < 0)
			{
				instantNotificationCollection.AddHappinessDecreased(character.GetId());
			}
		}
	}

	public static void ChangeRoleBodyPartInjuryByLevel(GameData.Domains.Character.Character character, bool isInnerInjury, sbyte deltaLevel, sbyte bodyPart = -1)
	{
		if (character == null)
		{
			throw new Exception("null character to add injury value!");
		}
		if (bodyPart == -1)
		{
			bodyPart = BodyPartType.GetRandomBodyPartType(Domain.MainThreadDataContext.Random);
		}
		character.ChangeInjury(Domain.MainThreadDataContext, bodyPart, isInnerInjury, deltaLevel);
		if (DomainManager.Taiwu.IsInGroup(character.GetId()))
		{
			InstantNotificationCollection instantNotificationCollection = DomainManager.World.GetInstantNotificationCollection();
			if (deltaLevel > 0)
			{
				instantNotificationCollection.AddInjuryIncreased(character.GetId(), bodyPart, (sbyte)(isInnerInjury ? 1 : 0));
			}
			else if (deltaLevel < 0)
			{
				instantNotificationCollection.AddInjuryDecreased(character.GetId(), bodyPart, (sbyte)(isInnerInjury ? 1 : 0));
			}
		}
	}

	public static void ChangePoisonByType(GameData.Domains.Character.Character character, sbyte poisonType, int changeValue, sbyte poisonLevel = 3)
	{
		if (character == null)
		{
			throw new Exception("null character to change poison value!");
		}
		character.ChangePoisoned(Domain.MainThreadDataContext, poisonType, poisonLevel, changeValue);
		InstantNotificationCollection instantNotificationCollection = DomainManager.World.GetInstantNotificationCollection();
		if (DomainManager.Taiwu.IsInGroup(character.GetId()) && !character.HasPoisonImmunity(poisonType))
		{
			if (changeValue > 0)
			{
				instantNotificationCollection.AddPoisonIncreased(character.GetId(), poisonType, changeValue);
			}
			else if (changeValue < 0)
			{
				instantNotificationCollection.AddPoisonDecreased(character.GetId(), poisonType, -changeValue);
			}
		}
	}

	public static void RandomChangePoison(GameData.Domains.Character.Character character, int poisonPoint)
	{
		IRandomSource random = Domain.MainThreadDataContext.Random;
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		list.Clear();
		while (list.Count < 5)
		{
			int item = random.Next(0, poisonPoint);
			list.Add(item);
		}
		list.Add(0);
		list.Add(poisonPoint);
		list.Sort((int l, int r) => l.CompareTo(r));
		for (sbyte b = 0; b < 6; b++)
		{
			if (list[b + 1] > list[b])
			{
				ChangePoisonByType(character, b, list[b + 1] - list[b], 3);
			}
		}
		ObjectPool<List<int>>.Instance.Return(list);
	}

	public static void RandomChangeInjury(GameData.Domains.Character.Character character, int injuryPoint, bool isInner)
	{
		IRandomSource random = Domain.MainThreadDataContext.Random;
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		list.Clear();
		while (list.Count < 6)
		{
			int item = random.Next(0, injuryPoint + 1);
			list.Add(item);
		}
		list.Add(0);
		list.Add(injuryPoint);
		list.Sort((int l, int r) => l.CompareTo(r));
		for (sbyte b = 0; b < 6; b++)
		{
			if (list[b + 1] > list[b])
			{
				ChangeRoleBodyPartInjuryByLevel(character, isInner, (sbyte)(list[b + 1] - list[b]), b);
			}
		}
		ObjectPool<List<int>>.Instance.Return(list);
	}

	public unsafe static short GetCharacterNeiliAllocationTypeValue(GameData.Domains.Character.Character character, sbyte neiliType)
	{
		if (character == null)
		{
			throw new Exception("null character to get NeiliAllocation type value!");
		}
		NeiliAllocation neiliAllocation = character.GetNeiliAllocation();
		return neiliAllocation.Items[neiliType];
	}

	public static short GetRoleWearingCloth(GameData.Domains.Character.Character character)
	{
		if (character == null)
		{
			throw new Exception("null character to get Wearing Cloth!");
		}
		short clothingDisplayId = character.GetClothingDisplayId();
		return ItemTemplateHelper.GetClothingTemplateIdByDisplayId((byte)clothingDisplayId);
	}

	public static byte GetRoleInfectedValue(GameData.Domains.Character.Character character)
	{
		if (character == null)
		{
			throw new Exception("null character to GetRoleInfectedValue!");
		}
		return character.GetXiangshuInfection();
	}

	public static void ChangeRoleInfectedValue(GameData.Domains.Character.Character character, int delta)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		if (character == null)
		{
			throw new Exception("null character to ChangeRoleInfectedValue!");
		}
		character.ChangeXiangshuInfection(mainThreadDataContext, delta);
		character.UpdateXiangshuInfectionState(mainThreadDataContext);
	}

	public static void SetRoleInfectedValue(GameData.Domains.Character.Character character, int setValue)
	{
		byte roleInfectedValue = GetRoleInfectedValue(character);
		ChangeRoleInfectedValue(character, -(roleInfectedValue - setValue));
	}

	public static void SetRoleInfectionValue(GameData.Domains.Character.Character character, byte infectionValue)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		if (character == null)
		{
			throw new Exception("null character to SetRoleInfectionType!");
		}
		character.SetXiangshuInfection(infectionValue, mainThreadDataContext);
		character.UpdateXiangshuInfectionState(mainThreadDataContext);
	}

	public static int GetSpiritualDebtChangeByInfected(GameData.Domains.Character.Character character)
	{
		if (character == null)
		{
			throw new Exception("null character to GetCharacterAvatarDataCopy!");
		}
		return DomainManager.Character.GetSpiritualDebtChangeByInfected(character);
	}

	public static AvatarData GetCharacterAvatarDataCopy(GameData.Domains.Character.Character character)
	{
		if (character == null)
		{
			throw new Exception("null character to GetCharacterAvatarDataCopy!");
		}
		return new AvatarData(character.GetAvatar());
	}

	public static void HandleEffect_YuJingChenSi(GameData.Domains.Character.Character character, bool isGoodFeature)
	{
		if (character == null)
		{
			throw new Exception("null character to HandleEffect_YuJingChenSi!");
		}
		List<short> featureIds = character.GetFeatureIds();
		List<short[]> list = new List<short[]>();
		for (int i = 0; i < featureIds.Count; i++)
		{
			CharacterFeatureItem item = CharacterFeature.Instance.GetItem(featureIds[i]);
			if (!item.Mergeable)
			{
				continue;
			}
			if (isGoodFeature)
			{
				sbyte level = item.Level;
				if (level > 0 && level < 3)
				{
					list.Add(new short[2] { item.TemplateId, item.AppearProb });
				}
			}
			if (!isGoodFeature && item.Level < -1)
			{
				list.Add(new short[2] { item.TemplateId, item.AppearProb });
			}
		}
		if (list.Count <= 0)
		{
			return;
		}
		short[] randomCellFromWeightCore = GetRandomCellFromWeightCore(list);
		CharacterFeatureItem targetFeatureConfig = CharacterFeature.Instance.GetItem(randomCellFromWeightCore[0]);
		short replaceFeatureId = targetFeatureConfig.TemplateId;
		CharacterFeature.Instance.Iterate(delegate(CharacterFeatureItem config)
		{
			if (config.MutexGroupId == targetFeatureConfig.MutexGroupId && config.Level == targetFeatureConfig.Level + 1)
			{
				replaceFeatureId = config.TemplateId;
				return false;
			}
			return true;
		});
		if (replaceFeatureId == targetFeatureConfig.TemplateId)
		{
			return;
		}
		for (int num = 0; num < featureIds.Count; num++)
		{
			if (featureIds[num] == targetFeatureConfig.TemplateId)
			{
				featureIds[num] = replaceFeatureId;
				break;
			}
		}
		character.SetFeatureIds(featureIds, Domain.MainThreadDataContext);
	}

	public unsafe static List<(ItemKey, short, bool)> GetCharacterEatingItems(GameData.Domains.Character.Character character)
	{
		if (character == null)
		{
			throw new Exception("null character to GetCharacterEatingItems!");
		}
		EatingItems eatingItems = character.GetEatingItems();
		List<(ItemKey, short, bool)> list = new List<(ItemKey, short, bool)>(9);
		for (int i = 0; i < 9; i++)
		{
			ItemKey itemKey = (ItemKey)eatingItems.ItemKeys[i];
			short item = eatingItems.Durations[i];
			bool item2 = EatingItems.IsWug(itemKey);
			list.Add((itemKey, item, item2));
		}
		return list;
	}

	public static void HealCharacterRandomInjury(GameData.Domains.Character.Character character)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		List<sbyte> list = ObjectPool<List<sbyte>>.Instance.Get();
		for (sbyte b = 0; b < 7; b++)
		{
			if (CheckRoleBodyPartInjured(character, b))
			{
				list.Add(b);
			}
		}
		if (list.Count != 0)
		{
			sbyte random = list.GetRandom(mainThreadDataContext.Random);
			ChangeRoleBodyPartInjuryByLevel(character, isInnerInjury: true, -6, random);
			ChangeRoleBodyPartInjuryByLevel(character, isInnerInjury: false, -6, random);
			ObjectPool<List<sbyte>>.Instance.Return(list);
		}
	}

	public static void HealCharacterAllInjury(GameData.Domains.Character.Character character)
	{
		for (sbyte b = 0; b < 7; b++)
		{
			ChangeRoleBodyPartInjuryByLevel(character, isInnerInjury: true, -6, b);
			ChangeRoleBodyPartInjuryByLevel(character, isInnerInjury: false, -6, b);
		}
	}

	public unsafe static void HealCharacterAllPoison(GameData.Domains.Character.Character character)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		PoisonInts poisoned = character.GetPoisoned();
		for (sbyte b = 0; b < 6; b++)
		{
			if (poisoned.Items[b] > 0)
			{
				character.ChangePoisoned(mainThreadDataContext, b, 3, -poisoned.Items[b]);
			}
		}
	}

	public static void RecoverCharacterDisorderOfQi(GameData.Domains.Character.Character character)
	{
		character.ChangeDisorderOfQi(Domain.MainThreadDataContext, -character.GetDisorderOfQi());
	}

	public static void TemporarilyModifyHappiness(GameData.Domains.Character.Character character, sbyte targetValue)
	{
		DomainManager.Character.TemporarilyModifyHappiness(Domain.MainThreadDataContext, character, targetValue);
	}

	public static void TemporarilyModifyBaseMorality(GameData.Domains.Character.Character character, short targetValue)
	{
		DomainManager.Character.TemporarilyModifyBaseMorality(Domain.MainThreadDataContext, character, targetValue);
	}

	public static void TemporarilyModifyFeatureIds(GameData.Domains.Character.Character character, List<short> targetValue)
	{
		DomainManager.Character.TemporarilyModifyFeatureIds(Domain.MainThreadDataContext, character, targetValue);
	}

	public static void TemporarilyModifyBaseMainAttributes(GameData.Domains.Character.Character character, MainAttributes targetValue)
	{
		DomainManager.Character.TemporarilyModifyBaseMainAttributes(Domain.MainThreadDataContext, character, targetValue);
	}

	public static void TemporarilyModifyDisorderOfQi(GameData.Domains.Character.Character character, short targetValue)
	{
		DomainManager.Character.TemporarilyModifyDisorderOfQi(Domain.MainThreadDataContext, character, targetValue);
	}

	public static void TemporarilyModifyInjuries(GameData.Domains.Character.Character character, Injuries targetValue)
	{
		DomainManager.Character.TemporarilyModifyInjuries(Domain.MainThreadDataContext, character, targetValue);
	}

	public static void TemporarilyModifyExtraNeili(GameData.Domains.Character.Character character, int targetValue)
	{
		DomainManager.Character.TemporarilyModifyExtraNeili(Domain.MainThreadDataContext, character, targetValue);
	}

	public static void TemporarilyModifyConsummateLevel(GameData.Domains.Character.Character character, sbyte targetValue)
	{
		DomainManager.Character.TemporarilyModifyConsummateLevel(Domain.MainThreadDataContext, character, targetValue);
	}

	public static void TemporarilyModifyBaseLifeSkillQualifications(GameData.Domains.Character.Character character, ref LifeSkillShorts targetValue)
	{
		DomainManager.Character.TemporarilyModifyBaseLifeSkillQualifications(Domain.MainThreadDataContext, character, ref targetValue);
	}

	public static void TemporarilyModifyBaseCombatSkillQualifications(GameData.Domains.Character.Character character, ref CombatSkillShorts targetValue)
	{
		DomainManager.Character.TemporarilyModifyBaseCombatSkillQualifications(Domain.MainThreadDataContext, character, ref targetValue);
	}

	public static void TemporarilyModifyResources(GameData.Domains.Character.Character character, ref ResourceInts targetValue)
	{
		DomainManager.Character.TemporarilyModifyResources(Domain.MainThreadDataContext, character, ref targetValue);
	}

	public static void TemporarilyModifyCurrMainAttributes(GameData.Domains.Character.Character character, MainAttributes targetValue)
	{
		DomainManager.Character.TemporarilyModifyCurrMainAttributes(Domain.MainThreadDataContext, character, targetValue);
	}

	public static void TemporarilyModifyPoisoned(GameData.Domains.Character.Character character, ref PoisonInts targetValue)
	{
		DomainManager.Character.TemporarilyModifyPoisoned(Domain.MainThreadDataContext, character, ref targetValue);
	}

	public static void TemporarilyModifyCurrNeili(GameData.Domains.Character.Character character, int targetValue)
	{
		DomainManager.Character.TemporarilyModifyCurrNeili(Domain.MainThreadDataContext, character, targetValue);
	}

	public static void TemporarilyModifyExtraNeiliAllocation(GameData.Domains.Character.Character character, NeiliAllocation targetValue)
	{
		DomainManager.Character.TemporarilyModifyExtraNeiliAllocation(Domain.MainThreadDataContext, character, targetValue);
	}

	public static void TemporarilyModifyXiangshuInfection(GameData.Domains.Character.Character character, byte targetValue)
	{
		DomainManager.Character.TemporarilyModifyXiangshuInfection(Domain.MainThreadDataContext, character, targetValue);
	}

	public static void TemporarilyChangeInjury(GameData.Domains.Character.Character character, sbyte bodyPartType, bool isInnerInjury, sbyte delta)
	{
		DomainManager.Character.BeginTemporaryModification(character, RevertibleCharacterPropertyType.Injuries);
		character.ChangeInjury(Domain.MainThreadDataContext, bodyPartType, isInnerInjury, delta);
		DomainManager.Character.RecordTemporaryModification();
	}

	public unsafe static void TemporarilyChangeBaseLifeSkillQualification(GameData.Domains.Character.Character character, sbyte lifeSkillType, short delta)
	{
		LifeSkillShorts delta2 = default(LifeSkillShorts);
		delta2.Initialize();
		delta2.Items[lifeSkillType] = delta;
		DomainManager.Character.BeginTemporaryModification(character, RevertibleCharacterPropertyType.BaseLifeSkillQualifications);
		character.ChangeBaseLifeSkillQualifications(Domain.MainThreadDataContext, ref delta2);
		DomainManager.Character.RecordTemporaryModification();
	}

	public unsafe static void TemporarilyChangeBaseCombatSkillQualification(GameData.Domains.Character.Character character, sbyte combatSkillType, short delta)
	{
		CombatSkillShorts delta2 = default(CombatSkillShorts);
		delta2.Initialize();
		delta2.Items[combatSkillType] = delta;
		DomainManager.Character.BeginTemporaryModification(character, RevertibleCharacterPropertyType.BaseCombatSkillQualifications);
		character.ChangeBaseCombatSkillQualifications(Domain.MainThreadDataContext, ref delta2);
		DomainManager.Character.RecordTemporaryModification();
	}

	public static void TemporarilyChangeResource(GameData.Domains.Character.Character character, sbyte resourceType, int delta)
	{
		DomainManager.Character.BeginTemporaryModification(character, RevertibleCharacterPropertyType.Resources);
		character.ChangeResource(Domain.MainThreadDataContext, resourceType, delta);
		DomainManager.Character.RecordTemporaryModification();
	}

	public unsafe static void TemporarilyChangeBaseMainAttribute(GameData.Domains.Character.Character character, sbyte mainAttributeType, short delta)
	{
		DomainManager.Character.BeginTemporaryModification(character, RevertibleCharacterPropertyType.BaseMainAttributes);
		MainAttributes delta2 = default(MainAttributes);
		delta2.Initialize();
		delta2.Items[mainAttributeType] = delta;
		character.ChangeBaseMainAttributes(Domain.MainThreadDataContext, delta2);
		DomainManager.Character.RecordTemporaryModification();
	}

	public static void TemporarilyChangeCurrMainAttribute(GameData.Domains.Character.Character character, sbyte mainAttributeType, short delta)
	{
		DomainManager.Character.BeginTemporaryModification(character, RevertibleCharacterPropertyType.CurrMainAttributes);
		character.ChangeCurrMainAttribute(Domain.MainThreadDataContext, mainAttributeType, delta);
		DomainManager.Character.RecordTemporaryModification();
	}

	public unsafe static void TemporarilyChangeExtraNeiliAllocation(GameData.Domains.Character.Character character, byte neiliAllocationType, short delta)
	{
		DomainManager.Character.BeginTemporaryModification(character, RevertibleCharacterPropertyType.ExtraNeiliAllocation);
		NeiliAllocation delta2 = default(NeiliAllocation);
		delta2.Initialize();
		delta2.Items[(int)neiliAllocationType] = delta;
		character.ChangeExtraNeiliAllocation(Domain.MainThreadDataContext, delta2);
		DomainManager.Character.RecordTemporaryModification();
	}

	public static void TemporarilyAddFeatureId(GameData.Domains.Character.Character character, short featureId)
	{
		DomainManager.Character.BeginTemporaryModification(character, RevertibleCharacterPropertyType.FeatureIds);
		character.AddFeature(Domain.MainThreadDataContext, featureId);
		DomainManager.Character.RecordTemporaryModification();
	}

	public static void TemporarilyChangePoisoned(GameData.Domains.Character.Character character, sbyte poisonType, int delta)
	{
		DomainManager.Character.BeginTemporaryModification(character, RevertibleCharacterPropertyType.Poisoned);
		DomainManager.Character.RecordTemporaryModification();
	}

	public static void ClearAllTemporaryModifications()
	{
		DomainManager.Character.RevertAllTemporaryModificationsOfAllCharacters(Domain.MainThreadDataContext);
	}

	public static List<int> GetCharacterManagedChickenList(int characterId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(characterId);
		OrganizationInfo organizationInfo = element_Objects.GetOrganizationInfo();
		if (organizationInfo.Grade == 8 && organizationInfo.SettlementId >= 0)
		{
			return DomainManager.Building.GetSettlementChickenList(organizationInfo.SettlementId);
		}
		return new List<int>();
	}

	public static void TransferChickenToTaiwuVillageBySpiritualDebt(int chickenId)
	{
		GameData.Domains.Building.Chicken element_Chicken = DomainManager.Building.GetElement_Chicken(chickenId);
		short areaId = DomainManager.Organization.GetSettlement((short)element_Chicken.CurrentSettlementId).GetLocation().AreaId;
		DomainManager.Extra.ChangeAreaSpiritualDebt(Domain.MainThreadDataContext, areaId, -1000);
		DomainManager.Building.TransferChicken(Domain.MainThreadDataContext, chickenId, DomainManager.Taiwu.GetTaiwuVillageSettlementId());
	}

	public static int GetChickenTemplateIdByChickenId(int chickenId)
	{
		return DomainManager.Building.GetChickenData(chickenId).TemplateId;
	}

	public static void ApplyEffect_WuShengMiYu(int charId)
	{
		ClearCharPoison(charId);
		RemoveRandomNormalWugs(charId, GlobalConfig.Instance.WuxianSpiritualDebtInteractionRemoveWugCount);
		ChangeWugKingDurations(charId, GlobalConfig.Instance.WuxianSpiritualDebtInteractionChangeWugKingDuration);
	}

	public static void ApplyEffect_TianfuGuilve()
	{
		DomainManager.Building.TaiwuResourceGrow(Domain.MainThreadDataContext);
	}

	public static void TaiwuVillageBuildingMaxLevelUp(sbyte addCount)
	{
		DomainManager.Taiwu.AddBuildingSpaceExtra(Domain.MainThreadDataContext, addCount);
	}

	public static void HideBuildingArea()
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.HideBuildingArea);
	}

	public static void AddStoneRoomCharacter(GameData.Domains.Character.Character character)
	{
		DomainManager.Extra.AddStoneRoomCharacter(Domain.MainThreadDataContext, character);
	}

	public static int GetMonthEventCaravanId()
	{
		return DomainManager.Merchant.GetMonthEventCaravanId(Domain.MainThreadDataContext);
	}

	public static void CaravanFilterGiftForCharacter(int caravanId, int getGiftCharId, EventArgBox argBox)
	{
		MerchantData caravanMerchantData = DomainManager.Merchant.GetCaravanMerchantData(Domain.MainThreadDataContext, caravanId);
		Tester.Assert(caravanMerchantData != null);
		if (!DomainManager.Character.TryGetElement_Objects(getGiftCharId, out var _))
		{
			throw new Exception($"can not get character to getGift,Id = {getGiftCharId}");
		}
		if (!argBox.Get("SelectItemInfo", out EventSelectItemData arg))
		{
			arg = new EventSelectItemData();
			arg.CanSelectItemList = new List<ItemDisplayData>();
			arg.FilterList = new List<SelectItemFilter>();
			argBox.Set("SelectItemInfo", (ISerializableGameData)(object)arg);
		}
		SelectItemFilter item = new SelectItemFilter
		{
			Key = "GiftKey1",
			DisplayDataFilterId = 0,
			FilterTemplateId = -1
		};
		SelectItemFilter item2 = new SelectItemFilter
		{
			Key = "GiftKey2",
			DisplayDataFilterId = 0,
			FilterTemplateId = -1
		};
		Inventory goodsList = caravanMerchantData.GetGoodsList(1);
		foreach (KeyValuePair<ItemKey, int> item3 in goodsList.Items)
		{
			arg.CanSelectItemList.Add(DomainManager.Item.GetItemDisplayData(item3.Key));
		}
		arg.LoveAndHateItemInfo = DomainManager.Character.GetCharacterLoveAndHateItemInfo(Domain.MainThreadDataContext, getGiftCharId);
		arg.FilterList.Add(item);
		arg.FilterList.Add(item2);
	}

	public static void DeleteCaravanItem(int caravanId, int index, ItemKey itemKey)
	{
		DomainManager.Merchant.DeleteCaravanItem(Domain.MainThreadDataContext, caravanId, index, itemKey);
	}

	public static bool IsCaravanRobbed(int caravanId)
	{
		CaravanExtraData caravanExtraData;
		CaravanState caravanState = (CaravanState)(DomainManager.Extra.TryGetCaravanExtraData(caravanId, out caravanExtraData) ? caravanExtraData.State : 0);
		return caravanState == CaravanState.Robbed;
	}

	public static int CreateRobCaravanEnemy(int caravanId)
	{
		MerchantData caravanMerchantData = DomainManager.Merchant.GetCaravanMerchantData(Domain.MainThreadDataContext, caravanId);
		return CreateNonIntelligentCharacter(caravanMerchantData.MerchantConfig.Enemy);
	}

	public static void ApplyMerchantRobbedResult(int caravanId, bool win)
	{
		DomainManager.Merchant.ApplyMerchantRobbedResult(Domain.MainThreadDataContext, caravanId, win, refresh: true);
	}

	public static void RemovePrisonerFromCharacter(int prisonerCharId, int charId, bool isEscaped)
	{
		DomainManager.Character.RemoveKidnappedCharacter(Domain.MainThreadDataContext, prisonerCharId, charId, isEscaped);
	}

	public static KidnappedCharacter GetKidnappedCharacter(int kidnapperId, int kidnappedCharId)
	{
		KidnappedCharacterList kidnappedCharacters = DomainManager.Character.GetKidnappedCharacters(kidnapperId);
		int index = kidnappedCharacters.IndexOf(kidnappedCharId);
		return kidnappedCharacters.Get(index);
	}

	public static void AddPrisonerToCharacter(int prisonerCharId, int charId, ItemKey ropeItemKey)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		if (element_Objects.IsActiveExternalRelationState(2))
		{
			KidnappedCharacterList kidnappedCharacters = DomainManager.Character.GetKidnappedCharacters(charId);
			if (kidnappedCharacters.IndexOf(prisonerCharId) > 0)
			{
				DomainManager.Character.ChangeKidnappedCharacterRope(Domain.MainThreadDataContext, charId, prisonerCharId, ropeItemKey);
			}
			else
			{
				DomainManager.Character.AddKidnappedCharacter(Domain.MainThreadDataContext, charId, prisonerCharId, ropeItemKey);
			}
		}
		else
		{
			DomainManager.Character.AddKidnappedCharacter(Domain.MainThreadDataContext, charId, prisonerCharId, ropeItemKey);
		}
		if (charId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			TryInterruptCharacterPrioritizedAction(prisonerCharId, 22);
		}
	}

	public static int GetPrisonerResistance(int prisonerCharId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(prisonerCharId, out var element))
		{
			throw new Exception($"failed get character of id {prisonerCharId} to GetPrisonerResistance");
		}
		int kidnapperId = element.GetKidnapperId();
		if (kidnapperId < 0)
		{
			return 0;
		}
		KidnappedCharacterList kidnappedCharacters = DomainManager.Character.GetKidnappedCharacters(kidnapperId);
		int num = kidnappedCharacters.IndexOf(prisonerCharId);
		if (num < 0)
		{
			return 0;
		}
		KidnappedCharacter kidnappedChar = kidnappedCharacters.Get(num);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(kidnapperId);
		return DomainManager.Character.CalcKidnappedCharacterTotalResistance(element_Objects, kidnappedChar);
	}

	public static void ChangePrisonerResistance(int prisonerCharId, sbyte delta)
	{
		if (!DomainManager.Character.TryGetElement_Objects(prisonerCharId, out var element))
		{
			throw new Exception($"failed get character of id {prisonerCharId} to ChangePrisonerResistance");
		}
		int kidnapperId = element.GetKidnapperId();
		if (kidnapperId < 0)
		{
			throw new Exception($"character {prisonerCharId} not kidnapped,can not change resistance");
		}
		KidnappedCharacterList kidnappedCharacters = DomainManager.Character.GetKidnappedCharacters(kidnapperId);
		int num = kidnappedCharacters.IndexOf(prisonerCharId);
		if (num < 0)
		{
			throw new Exception($"character {prisonerCharId} 's kidnapper do not has prisoner {prisonerCharId},can not change resistance");
		}
		KidnappedCharacter kidnappedCharacter = kidnappedCharacters.Get(num);
		kidnappedCharacter.ExtraResistance = (sbyte)Math.Clamp(kidnappedCharacter.ExtraResistance + delta, 0, 127);
	}

	public static void TransferPrisoner(int prisonerCharId, int newKidnapperCharId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(prisonerCharId, out var element))
		{
			throw new Exception($"failed get character of id {prisonerCharId} to TransferPrisoner");
		}
		int kidnapperId = element.GetKidnapperId();
		if (kidnapperId < 0)
		{
			throw new Exception($"character {prisonerCharId} not kidnapped,can not transfer prisoner");
		}
		KidnappedCharacterList kidnappedCharacters = DomainManager.Character.GetKidnappedCharacters(kidnapperId);
		int num = kidnappedCharacters.IndexOf(prisonerCharId);
		if (num < 0)
		{
			throw new Exception($"character {prisonerCharId} 's kidnapper do not has prisoner {prisonerCharId},can not transfer prisoner");
		}
		KidnappedCharacter kidnappedCharData = kidnappedCharacters.Get(num);
		DomainManager.Character.TransferKidnappedCharacter(Domain.MainThreadDataContext, newKidnapperCharId, kidnapperId, kidnappedCharData);
	}

	public static void HandleCombatResultKidnapEnemy(GameData.Domains.Character.Character winner, GameData.Domains.Character.Character loser, bool isInPublic)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Character.CombatResultHandle_KidnapEnemy(mainThreadDataContext, winner, loser, isInPublic);
	}

	public static void HandleCombatResultReleaseEnemy(GameData.Domains.Character.Character winner, GameData.Domains.Character.Character loser)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Character.CombatResultHandle_ReleaseEnemy(mainThreadDataContext, winner, loser);
	}

	public static void HandleCombatResultKillEnemy(GameData.Domains.Character.Character winner, GameData.Domains.Character.Character loser, bool isInPublic)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Character.CombatResultHandle_KillEnemy(mainThreadDataContext, winner, loser, isInPublic);
		if (winner.GetId() == DomainManager.Taiwu.GetTaiwuCharId())
		{
			TryInterruptCharacterPrioritizedAction(loser.GetId(), 22);
		}
	}

	public static void MoveFixedCharacter(GameData.Domains.Character.Character character, Location targetLocation)
	{
		Tester.Assert(character.GetCreatingType() == 0, $"character-{character.GetId()}.GetCreatingType() == CreatingType.FixedCharacter");
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Events.RaiseFixedCharacterLocationChanged(mainThreadDataContext, character.GetId(), character.GetLocation(), targetLocation);
		character.SetLocation(targetLocation, mainThreadDataContext);
	}

	public static void MoveFixedEnemy(GameData.Domains.Character.Character character, Location targetLocation)
	{
		Tester.Assert(character.GetCreatingType() == 3, $"character-{character.GetId()}.GetCreatingType() == CreatingType.FixedEnemy");
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Events.RaiseEnemyCharacterLocationChanged(mainThreadDataContext, character.GetId(), character.GetLocation(), targetLocation);
		character.SetLocation(targetLocation, mainThreadDataContext);
	}

	public static void MoveIntelligentCharacter(GameData.Domains.Character.Character character, Location targetLocation)
	{
		Tester.Assert(character.GetCreatingType() == 1, $"character-{character.GetId()}.GetCreatingType() == CreatingType.IntelligentCharacter");
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		character.DeactivateExternalRelationState(mainThreadDataContext, 16);
		DomainManager.Character.GroupMove(mainThreadDataContext, character, targetLocation);
	}

	public static void HideIntelligentCharacter(GameData.Domains.Character.Character character)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Character.HideCharacterOnMap(mainThreadDataContext, character, 16);
	}

	public static byte GetDiffRandomHairColor(byte prevHairColorId)
	{
		AvatarHairColorsItem config = AvatarHairColors.Instance.GetItem(prevHairColorId);
		List<byte> canUseTemplateIdList = new List<byte>();
		AvatarHairColors.Instance.Iterate(delegate(AvatarHairColorsItem e)
		{
			if (config != null && e.DisplayDesc != config.DisplayDesc)
			{
				canUseTemplateIdList.Add(e.TemplateId);
			}
			return true;
		});
		return canUseTemplateIdList.GetRandom(Domain.MainThreadDataContext.Random);
	}

	public static byte GetDiffRandomEyeballColor(byte prevEyeballColorId)
	{
		AvatarEyeballColorsItem config = AvatarEyeballColors.Instance.GetItem(prevEyeballColorId);
		List<byte> canUseTemplateIdList = new List<byte>();
		AvatarEyeballColors.Instance.Iterate(delegate(AvatarEyeballColorsItem e)
		{
			if (config != null && e.DisplayDesc != config.DisplayDesc)
			{
				canUseTemplateIdList.Add(e.TemplateId);
			}
			return true;
		});
		return canUseTemplateIdList.GetRandom(Domain.MainThreadDataContext.Random);
	}

	public static byte GetDiffRandomSkinColor(byte prevSkinColorId)
	{
		AvatarSkinColorsItem config = AvatarSkinColors.Instance.GetItem(prevSkinColorId);
		List<byte> canUseTemplateIdList = new List<byte>();
		AvatarSkinColors.Instance.Iterate(delegate(AvatarSkinColorsItem e)
		{
			if (config != null && e.DisplayDesc != config.DisplayDesc)
			{
				canUseTemplateIdList.Add(e.TemplateId);
			}
			return true;
		});
		return canUseTemplateIdList.GetRandom(Domain.MainThreadDataContext.Random);
	}

	public static byte GetDiffRandomClothColor(byte prevClothColorId)
	{
		AvatarClothColorsItem config = AvatarClothColors.Instance.GetItem(prevClothColorId);
		List<byte> canUseTemplateIdList = new List<byte>();
		AvatarClothColors.Instance.Iterate(delegate(AvatarClothColorsItem e)
		{
			if (config != null && e.DisplayDesc != config.DisplayDesc)
			{
				canUseTemplateIdList.Add(e.TemplateId);
			}
			return true;
		});
		return canUseTemplateIdList.GetRandom(Domain.MainThreadDataContext.Random);
	}

	public static byte GetDiffRandomAvatarId(byte prevAvatarId)
	{
		List<byte> list = new List<byte>();
		List<byte> allKeys = AvatarHead.Instance.GetAllKeys();
		for (int i = 0; i < allKeys.Count && allKeys[i] < 6; i++)
		{
			AvatarHeadItem item = AvatarHead.Instance.GetItem(allKeys[i]);
			if (item != null && prevAvatarId != item.AvatarId && item.AvatarId % 2 == prevAvatarId % 2)
			{
				list.Add(item.AvatarId);
			}
		}
		return list.GetRandom(Domain.MainThreadDataContext.Random);
	}

	public static string GetCharacterDisplayName(GameData.Domains.Character.Character character)
	{
		if (character == null)
		{
			throw new Exception("null character can not GetCharacterDisplayName");
		}
		var (text, text2) = DomainManager.Character.GetNameRelatedData(character.GetId()).GetDisplayName(character.GetId() == DomainManager.Taiwu.GetTaiwuCharId());
		return text + text2;
	}

	public static (string, string) GetRandomCharacterHanName(sbyte gender)
	{
		return CharacterDomain.GenerateRandomHanName(Domain.MainThreadDataContext.Random, -1, -1, gender, -1).GetName(gender, DomainManager.World.GetCustomTexts());
	}

	public static short GetCharacterOrganizationAreaId(GameData.Domains.Character.Character character)
	{
		short settlementId = character.GetOrganizationInfo().SettlementId;
		if (settlementId < 0)
		{
			return -1;
		}
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		return settlement.GetLocation().AreaId;
	}

	public static short GetCharacterInfluencePower(int charId)
	{
		SettlementCharacter settlementChar;
		return (short)(DomainManager.Organization.TryGetSettlementCharacter(charId, out settlementChar) ? settlementChar.GetInfluencePower() : 0);
	}

	[Obsolete("need to change influence power to cache data before setting it in events")]
	public static void SetCharacterInfluencePower(int charId, short influencePower)
	{
		if (DomainManager.Organization.TryGetSettlementCharacter(charId, out var settlementChar))
		{
			settlementChar.SetInfluencePower(influencePower, Domain.MainThreadDataContext);
		}
	}

	public static short GetApprovingRate(int charId)
	{
		SettlementCharacter settlementChar;
		return (short)(DomainManager.Organization.TryGetSettlementCharacter(charId, out settlementChar) ? settlementChar.GetApprovingRate() : 0);
	}

	public static sbyte GetCharacterChildGrade(GameData.Domains.Character.Character character)
	{
		return OrganizationDomain.GetOrgMemberConfig(character.GetOrganizationInfo()).ChildGrade;
	}

	public static void KillCharacter(int killerId, int victimId, EKillCharacterType killType)
	{
		if (!DomainManager.Character.TryGetElement_Objects(victimId, out var element))
		{
			throw new Exception($"can not find character {victimId} to be killed in KillCharacter");
		}
		KillAddTianJieFuLu(killerId, element);
		if (1 == 0)
		{
		}
		short num = killType switch
		{
			EKillCharacterType.KillInPublic => 4, 
			EKillCharacterType.KillInPrivate => 3, 
			_ => 0, 
		};
		if (1 == 0)
		{
		}
		short deathType = num;
		if (DomainManager.Character.TryGetElement_Objects(killerId, out var element2) && element2.GetTemplateId() == 446)
		{
			deathType = 11;
		}
		DomainManager.Character.MakeCharacterDead(Domain.MainThreadDataContext, element, deathType, new CharacterDeathInfo(element.GetValidLocation())
		{
			KillerId = killerId,
			AdventureId = DomainManager.Adventure.GetCurAdventureId()
		});
	}

	public static void KillAddTianJieFuLu(int killerId, GameData.Domains.Character.Character victim, bool needCompletelyInfected = true)
	{
		bool flag = CheckRoleInfection(victim, 2);
		if (!needCompletelyInfected)
		{
			flag = true;
		}
		bool flag2 = DomainManager.Extra.IsProfessionalSkillUnlocked(5, 2);
		if (killerId == DomainManager.Taiwu.GetTaiwuCharId() && flag && flag2)
		{
			int num = Math.Min(victim.GetConsummateLevel(), ProfessionRelatedConstants.TaoistMonkSkill2GetSecretSignCount.Length - 1);
			int num2 = ProfessionRelatedConstants.TaoistMonkSkill2GetSecretSignCount[num];
			ItemKey arg = AddItemToRole(DomainManager.Taiwu.GetTaiwu(), 12, 234, num2, -1);
			DomainManager.World.GetInstantNotificationCollection().AddGetItem(DomainManager.Taiwu.GetTaiwuCharId(), 12, 234);
			Domain.OnEvent_TaiwuGotTianjieFulu(victim.GetId(), arg, num2);
		}
	}

	public static void SaveInfected(GameData.Domains.Character.Character victim)
	{
		SaveInfectedAddTianJieFuLu(victim);
		victim.SavedFromInfected(Domain.MainThreadDataContext);
	}

	public static void SaveInfectedAddTianJieFuLu(GameData.Domains.Character.Character victim)
	{
		if (DomainManager.Extra.IsProfessionalSkillUnlocked(5, 2))
		{
			int num = Math.Min(victim.GetConsummateLevel(), ProfessionRelatedConstants.TaoistMonkSkill2GetSecretSignCount.Length - 1);
			int num2 = ProfessionRelatedConstants.TaoistMonkSkill2GetSecretSignCountBySave[num];
			ItemKey arg = AddItemToRole(DomainManager.Taiwu.GetTaiwu(), 12, 234, num2, -1);
			DomainManager.World.GetInstantNotificationCollection().AddGetItem(DomainManager.Taiwu.GetTaiwuCharId(), 12, 234);
			Domain.OnEvent_TaiwuGotTianjieFulu(victim.GetId(), arg, num2);
		}
	}

	public static bool IsCharacterAlive(int charId)
	{
		return DomainManager.Character.IsCharacterAlive(charId);
	}

	public static void CharacterDie(int victimId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(victimId, out var element))
		{
			throw new Exception($"can not find character {victimId} to be killed in KillCharacter");
		}
		DomainManager.Character.MakeCharacterDead(Domain.MainThreadDataContext, element, 0);
	}

	public static void SetCharacterVeilShowState(int charId, bool showVeil)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		if (element_Objects == null)
		{
			throw new Exception($"can not find character {charId} to SetCharacterVeilShowState");
		}
		AvatarData avatar = element_Objects.GetAvatar();
		avatar.ShowVeil = showVeil;
		element_Objects.SetAvatar(avatar, Domain.MainThreadDataContext);
	}

	public static bool SetGrowableElementShowingAbility(int charId, sbyte growableElementType, bool showable)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return false;
		}
		AvatarData avatar = element.GetAvatar();
		avatar.SetGrowableElementShowingAbility(growableElementType, showable);
		element.SetAvatar(avatar, Domain.MainThreadDataContext);
		return true;
	}

	public static void ClearCharInjury(int charId)
	{
		DomainManager.Character.GetElement_Objects(charId).SetInjuries(default(Injuries), Domain.MainThreadDataContext);
	}

	public static void SetInjury(int charId, Injuries injuries)
	{
		DomainManager.Character.GetElement_Objects(charId).SetInjuries(injuries, Domain.MainThreadDataContext);
	}

	public static (Injuries, sbyte) HealInjury(int patientId, int doctorCharId)
	{
		int allHealMarkCount;
		int maxHealMarkCount;
		int maxRequireAttainment;
		Injuries item = DomainManager.Combat.HealInjury(patientId, DomainManager.Character.GetElement_Objects(doctorCharId), out allHealMarkCount, out maxHealMarkCount, out maxRequireAttainment);
		return (item, (sbyte)allHealMarkCount);
	}

	public static void SetPoisoned(int charId, PoisonInts poison)
	{
		DomainManager.Character.GetElement_Objects(charId).SetPoisoned(ref poison, Domain.MainThreadDataContext);
	}

	public static (PoisonInts, sbyte, int) HealPoison(int patientId, int doctorCharId)
	{
		int healMarkCount;
		int healPoisonValue;
		int maxRequireAttainment;
		PoisonInts item = DomainManager.Combat.HealPoison(patientId, DomainManager.Character.GetElement_Objects(doctorCharId), out healMarkCount, out healPoisonValue, out maxRequireAttainment);
		return (item, (sbyte)healMarkCount, healPoisonValue);
	}

	public static (bool, sbyte) GetMedicineTopicalEffectResult(GameData.Domains.Character.Character targetChar, ItemKey medicineItemKey)
	{
		if (medicineItemKey.ItemType != 8)
		{
			throw new Exception($"Invalid item type: {medicineItemKey.ItemType}");
		}
		MedicineItem medicineItem = Config.Medicine.Instance[medicineItemKey.TemplateId];
		if (medicineItem.EffectType != EMedicineEffectType.RecoverOuterInjury && medicineItem.EffectType != EMedicineEffectType.RecoverInnerInjury)
		{
			throw new Exception($"Invalid EffectType: {medicineItem.EffectType}");
		}
		bool isInnerInjury = medicineItem.EffectType == EMedicineEffectType.RecoverInnerInjury;
		Injuries injuries = targetChar.GetInjuries();
		sbyte b = sbyte.MaxValue;
		sbyte b2 = -1;
		for (sbyte b3 = 0; b3 < 7; b3++)
		{
			sbyte b4 = injuries.Get(b3, isInnerInjury);
			if (b4 > 0 && b4 < b)
			{
				b = b4;
				b2 = b3;
			}
		}
		return (b2 == -1) ? (false, b2) : (true, b2);
	}

	public static bool CanMedicineApplyInstantEffect(GameData.Domains.Character.Character targetChar, ItemKey medicineItemKey)
	{
		if (medicineItemKey.ItemType != 8)
		{
			throw new Exception($"Invalid item type: {medicineItemKey.ItemType}");
		}
		MedicineItem medicineItem = Config.Medicine.Instance[medicineItemKey.TemplateId];
		if (medicineItem.EffectType != EMedicineEffectType.RecoverOuterInjury && medicineItem.EffectType != EMedicineEffectType.RecoverInnerInjury)
		{
			throw new Exception($"Invalid EffectType: {medicineItem.EffectType}");
		}
		bool isInnerInjury = medicineItem.EffectType == EMedicineEffectType.RecoverInnerInjury;
		Injuries injuries = targetChar.GetInjuries();
		for (sbyte b = 0; b < 7; b++)
		{
			sbyte b2 = injuries.Get(b, isInnerInjury);
			if (b2 > 0)
			{
				return true;
			}
		}
		return false;
	}

	public unsafe static bool TopicalConsumeIsSatisfy(GameData.Domains.Character.Character targetChar, ItemKey medicineItemKey)
	{
		MainAttributes currMainAttributes = targetChar.GetCurrMainAttributes();
		MedicineItem medicineItem = Config.Medicine.Instance[medicineItemKey.TemplateId];
		sbyte requiredMainAttributeType = medicineItem.RequiredMainAttributeType;
		sbyte requiredMainAttributeValue = medicineItem.RequiredMainAttributeValue;
		return requiredMainAttributeType < 0 || currMainAttributes.Items[requiredMainAttributeType] >= requiredMainAttributeValue;
	}

	public static bool CanEatItem(GameData.Domains.Character.Character targetChar, ItemKey itemKey)
	{
		EatingItems eatingItems = targetChar.GetEatingItems();
		sbyte currMaxEatingSlotsCount = targetChar.GetCurrMaxEatingSlotsCount();
		sbyte availableEatingSlot = eatingItems.GetAvailableEatingSlot(currMaxEatingSlotsCount);
		if (itemKey.ItemType == 8)
		{
			MedicineItem medicineItem = Config.Medicine.Instance[itemKey.TemplateId];
			if (medicineItem != null && medicineItem.RequiredMainAttributeType >= 0 && targetChar.GetCurrMainAttributes()[medicineItem.RequiredMainAttributeType] < medicineItem.RequiredMainAttributeValue)
			{
				return false;
			}
			if (Config.Medicine.Instance[itemKey.TemplateId].Duration == 0)
			{
				return true;
			}
		}
		return itemKey.ItemType == 12 || availableEatingSlot >= 0;
	}

	public static bool CanEatItemExceptMisc(GameData.Domains.Character.Character targetChar)
	{
		EatingItems eatingItems = targetChar.GetEatingItems();
		sbyte currMaxEatingSlotsCount = targetChar.GetCurrMaxEatingSlotsCount();
		sbyte availableEatingSlot = eatingItems.GetAvailableEatingSlot(currMaxEatingSlotsCount);
		if (availableEatingSlot < 0)
		{
			return false;
		}
		return true;
	}

	public static void ClearCharPoison(int charId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		PoisonInts poisoned = element_Objects.GetPoisoned();
		poisoned.Initialize();
		element_Objects.SetPoisoned(ref poisoned, Domain.MainThreadDataContext);
	}

	public static void RemoveRandomNormalWugs(int charId, int count)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		List<short> list2 = ObjectPool<List<short>>.Instance.Get();
		list.Clear();
		list2.Clear();
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		EatingItems eatingItems = element_Objects.GetEatingItems();
		for (int i = 0; i < 9; i++)
		{
			ItemKey itemKey = eatingItems.Get(i);
			if (EatingItems.IsWug(itemKey) && !EatingItems.IsWugKing(itemKey))
			{
				MedicineItem medicineItem = Config.Medicine.Instance[itemKey.TemplateId];
				if (WugGrowthType.IsBad(medicineItem.WugGrowthType))
				{
					list.Add(itemKey.TemplateId);
				}
				else
				{
					list2.Add(itemKey.TemplateId);
				}
			}
		}
		foreach (short item in RandomUtils.GetRandomUnrepeated(mainThreadDataContext.Random, count, list, list2))
		{
			element_Objects.RemoveWug(mainThreadDataContext, item);
		}
		ObjectPool<List<short>>.Instance.Return(list);
		ObjectPool<List<short>>.Instance.Return(list2);
	}

	public static void ChangeWugKingDurations(int charId, short deltaDuration)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		EatingItems eatingItems = element_Objects.GetEatingItems();
		int num = eatingItems.IndexOfWugKing();
		if (num < 0)
		{
			return;
		}
		ItemKey itemKey = eatingItems.Get(num);
		short templateId = itemKey.TemplateId;
		eatingItems.ChangeDuration(mainThreadDataContext, num, deltaDuration);
		element_Objects.SetEatingItems(ref eatingItems, mainThreadDataContext);
		if (!(eatingItems.Get(num) != ItemKey.Invalid))
		{
			Events.RaiseRemoveWug(mainThreadDataContext, charId, templateId);
			InstantNotificationCollection instantNotificationCollection = DomainManager.World.GetInstantNotificationCollection();
			if (element_Objects.ChangeFeatureByWugKing(mainThreadDataContext.Random))
			{
				element_Objects.SetFeatureIds(element_Objects.GetFeatureIds(), mainThreadDataContext);
				instantNotificationCollection.AddWugKingDead(charId, itemKey.ItemType, itemKey.TemplateId);
			}
			else
			{
				instantNotificationCollection.AddWugKingDeadSpecial(charId, itemKey.ItemType, itemKey.TemplateId);
			}
		}
	}

	public static long GetTotalDebtWorth(int targetCharId)
	{
		return DomainManager.Character.GetDebts(targetCharId)?.GetTotalWorthLentToTaiwu() ?? 0;
	}

	public static long GetDebtWorth(int targetCharId, bool isEquivalent)
	{
		if (isEquivalent)
		{
			return DomainManager.Character.GetDebts(targetCharId)?.GetEquivalentWorth() ?? 0;
		}
		return DomainManager.Character.GetDebts(targetCharId)?.GetTotalNonEquivalentWorth() ?? 0;
	}

	public static void DirectlyAddDebt(int targetCharId, int worth, bool isEquivalent)
	{
		if (worth != 0)
		{
			DomainManager.Character.DirectlyAddDebt(Domain.MainThreadDataContext, targetCharId, worth, isEquivalent);
		}
	}

	public static void DirectlyReduceDebt(int targetCharId, int worth, bool isEquivalent)
	{
		DomainManager.Character.DirectlyReduceDebt(Domain.MainThreadDataContext, targetCharId, worth, isEquivalent);
	}

	public static int GetAvailableEatingSlotsCount(int charId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		return element_Objects.GetEatingItems().GetAvailableEatingSlotsCount(element_Objects.GetCurrMaxEatingSlotsCount());
	}

	public static short GetRandomEnemyCharTemplateId(sbyte orgTemplateId, sbyte expectedGrade)
	{
		IRandomSource random = Domain.MainThreadDataContext.Random;
		return CharacterDomain.GetRandomEnemyCharTemplateId(random, orgTemplateId, expectedGrade);
	}

	public static sbyte GetInteractionGrade(GameData.Domains.Character.Character character)
	{
		return character.GetInteractionGrade();
	}

	public static GameData.Domains.Character.Character GetOrCreateFixedCharacterByTemplateId(short templateId)
	{
		return DomainManager.Character.GetOrCreateFixedCharacterByTemplateId(Domain.MainThreadDataContext, templateId);
	}

	public static GameData.Domains.Character.Character CreateAnimal(short templateId, ItemKey itemKey)
	{
		sbyte b = Config.Character.Instance[templateId].Gender;
		if (b == -1)
		{
			b = Gender.GetRandom(Domain.MainThreadDataContext.Random);
		}
		if (itemKey.IsValid())
		{
			int id2;
			ChildrenOfLoong childOfLoong;
			if (DomainManager.Extra.TryGetJiaoIdByItemKey(itemKey, out var id) && DomainManager.Extra.TryGetJiao(id, out var jiao))
			{
				b = (sbyte)(jiao.Gender ? 1 : 0);
			}
			else if (DomainManager.Extra.TryGetChildrenOfLoongIdByItemKey(itemKey, out id2) && DomainManager.Extra.TryGetLoong(id2, out childOfLoong))
			{
				b = (sbyte)(childOfLoong.Gender ? 1 : 0);
			}
		}
		FixedEnemyCreationInfo fixedEnemyCreationInfo = new FixedEnemyCreationInfo();
		fixedEnemyCreationInfo.Gender = b;
		FixedEnemyCreationInfo creationInfo = fixedEnemyCreationInfo;
		GameData.Domains.Character.Character character = DomainManager.Character.CreateFixedEnemyWithCreationInfo(Domain.MainThreadDataContext, templateId, ref creationInfo);
		int id3 = character.GetId();
		DomainManager.Character.CompleteCreatingCharacter(id3);
		DomainManager.Adventure.AddTemporaryEnemyId(id3);
		return character;
	}

	public static void ConvertFixedCharacter(GameData.Domains.Character.Character character, Location location, bool recreateAttributesAndQualifications)
	{
		DomainManager.Character.ConvertFixedCharacter(Domain.MainThreadDataContext, character, location, recreateAttributesAndQualifications);
	}

	public static void ConvertRandomEnemy(GameData.Domains.Character.Character fixedChar, Location location)
	{
		DomainManager.Character.ConvertRandomEnemy(Domain.MainThreadDataContext, fixedChar, location);
	}

	public static int CreateFixedCharacterGrave(short templateId, Location location, sbyte level, int deathDate = int.MinValue)
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(templateId);
		int id = orCreateFixedCharacterByTemplateId.GetId();
		DomainManager.Character.CreateGraveForFixedCharacter(Domain.MainThreadDataContext, orCreateFixedCharacterByTemplateId, location, level, deathDate);
		return id;
	}

	public static void RemoveGrave(int graveId)
	{
		if (DomainManager.Character.TryGetElement_Graves(graveId, out var element))
		{
			DomainManager.Character.RemoveGrave(Domain.MainThreadDataContext, element);
		}
	}

	public static int GetFixedCharacterIdByTemplateId(short templateId)
	{
		return DomainManager.Character.GetFixedCharacterIdByTemplateId(templateId);
	}

	public static GameData.Domains.Character.Character GetCharacterById(int charId)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return element;
		}
		return null;
	}

	public static DeadCharacter GetDeadCharacterById(int charId)
	{
		return DomainManager.Character.TryGetDeadCharacter(charId);
	}

	public static void JoinGroup(int charId, int targetCharId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(targetCharId, out var element))
		{
			throw new Exception($"target character not found exception : {targetCharId}");
		}
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element2))
		{
			throw new Exception($"source character not found exception : {charId}");
		}
		DomainManager.Character.JoinGroup(Domain.MainThreadDataContext, element2, element);
	}

	public static void StartSelectFrame(int charId, EventArgBox argBox)
	{
		if (charId < 0)
		{
			throw new Exception("wrong argument received : charId is not a valid character id!");
		}
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"source character not found exception : {charId}");
		}
		EventSelectFameData eventSelectFameData = new EventSelectFameData();
		List<FameActionRecord> list = new List<FameActionRecord>();
		foreach (FameActionRecord fameActionRecord in element.GetFameActionRecords())
		{
			FameActionItem fameActionItem = FameAction.Instance[fameActionRecord.Id];
			if (fameActionItem.ReductionTime > 0)
			{
				list.Add(fameActionRecord);
			}
		}
		eventSelectFameData.fameActionRecords = list;
		argBox.Set("SelectFameData", (ISerializableGameData)(object)eventSelectFameData);
	}

	public static void ChangeFameActionDuration(GameData.Domains.Character.Character character, short fameActionTemplateId, int deltaTime, bool isCostAuthority)
	{
		int currDate = DomainManager.World.GetCurrDate();
		List<FameActionRecord> fameActionRecords = character.GetFameActionRecords();
		for (int num = fameActionRecords.Count - 1; num >= 0; num--)
		{
			FameActionRecord value = fameActionRecords[num];
			if (value.Id == fameActionTemplateId)
			{
				value.EndDate += deltaTime;
				fameActionRecords[num] = value;
				if (fameActionRecords[num].EndDate < currDate)
				{
					CollectionUtils.SwapAndRemove(fameActionRecords, num);
				}
				if (isCostAuthority)
				{
					character.ChangeResource(Domain.MainThreadDataContext, 7, Math.Abs(value.Value) * deltaTime * 20);
				}
			}
		}
		character.SetFameActionRecords(fameActionRecords, Domain.MainThreadDataContext);
	}

	public static void RemoveAllInventoryAndEquippedItems(GameData.Domains.Character.Character character)
	{
		DomainManager.Character.RemoveAllInventoryAndEquippedItems(Domain.MainThreadDataContext, character);
	}

	public static void RevokeAllCombatSkills(GameData.Domains.Character.Character character)
	{
		List<short> learnedCombatSkills = character.GetLearnedCombatSkills();
		foreach (short item in learnedCombatSkills)
		{
			DomainManager.Character.RevokeCombatSkill(Domain.MainThreadDataContext, character, item);
		}
	}

	public static void RevokeNeiliAndConsummateLevel(GameData.Domains.Character.Character character)
	{
		character.SetCurrNeili(0, Domain.MainThreadDataContext);
		character.SetExtraNeili(0, Domain.MainThreadDataContext);
		character.SetConsummateLevel(0, Domain.MainThreadDataContext);
	}

	public static void JoinNearbyVillageTownAsBeggar(GameData.Domains.Character.Character character, short settlementId = -1)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Organization.JoinNearbyVillageTownAsBeggar(mainThreadDataContext, character, settlementId);
	}

	public static void AddSectPunishmentFeature(GameData.Domains.Character.Character character, short orgTemplateId)
	{
		short punishmentFeature = Config.Organization.Instance[orgTemplateId].PunishmentFeature;
		if (punishmentFeature >= 0)
		{
			character.AddFeature(Domain.MainThreadDataContext, punishmentFeature);
		}
	}

	public static bool AddFeature(GameData.Domains.Character.Character character, short featureId, bool removeMutexFeature = false)
	{
		return character.AddFeature(Domain.MainThreadDataContext, featureId, removeMutexFeature);
	}

	public static void RemoveFeature(GameData.Domains.Character.Character character, short featureId)
	{
		List<short> featureIds = character.GetFeatureIds();
		if (featureIds.Contains(featureId))
		{
			character.RemoveFeature(Domain.MainThreadDataContext, featureId);
		}
	}

	public static short GetRandomOneYearOldCatchFeature()
	{
		return CharacterDomain.GenerateOneYearOldCatchFeature(Domain.MainThreadDataContext.Random);
	}

	public static void AddCharacterExtraTitle(GameData.Domains.Character.Character character, short titleTemplateId, int expireDate = -1)
	{
		DomainManager.Extra.AddCharacterExtraTitle(Domain.MainThreadDataContext, character.GetId(), titleTemplateId, expireDate);
	}

	public static Grave GetGrave(int graveId)
	{
		Grave element;
		return DomainManager.Character.TryGetElement_Graves(graveId, out element) ? element : null;
	}

	public static void UpgradeGrave(int targetGraveId, sbyte targetLevel)
	{
		Grave element_Graves = DomainManager.Character.GetElement_Graves(targetGraveId);
		element_Graves.SetLevel(targetLevel, Domain.MainThreadDataContext);
		short durability = GlobalConfig.Instance.GraveDurabilities[targetLevel];
		element_Graves.SetDurability(durability, Domain.MainThreadDataContext);
	}

	public static GameData.Domains.Character.Character CreateSkeletonCharacter(int graveId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Grave element_Graves = DomainManager.Character.GetElement_Graves(graveId);
		GameData.Domains.Character.Character character = DomainManager.Character.CreateSkeletonCharacter(mainThreadDataContext, element_Graves);
		DomainManager.Adventure.AddTemporaryEnemyId(character.GetId());
		return character;
	}

	public static sbyte GetGraveLevel(int targetGraveId)
	{
		Grave element_Graves = DomainManager.Character.GetElement_Graves(targetGraveId);
		return element_Graves.GetLevel();
	}

	public static int GetBloodParentId(int charId, sbyte gender)
	{
		return DomainManager.Character.GetBloodParent(charId, gender);
	}

	public static int GetOtherBloodParent(int charId, int parentId)
	{
		return DomainManager.Character.GetOtherBloodParent(charId, parentId);
	}

	public static ItemKey AddCricketToInventory(GameData.Domains.Character.Character character, short colorId, short partId)
	{
		ItemKey itemKey = DomainManager.Item.CreateCricket(Domain.MainThreadDataContext, colorId, partId);
		character.AddInventoryItem(Domain.MainThreadDataContext, itemKey, 1);
		return itemKey;
	}

	public static ItemKey AddSmartCricketToInventory(GameData.Domains.Character.Character character, short colorId, short partId)
	{
		if (ItemTemplateHelper.GetCricketGrade(colorId, partId) >= 7 || CricketParts.Instance[colorId].Type == ECricketPartsType.Trash)
		{
			return ItemKey.Invalid;
		}
		ItemKey itemKey = AddCricketToInventory(character, colorId, partId);
		DomainManager.Extra.ForceCricketSmart(Domain.MainThreadDataContext, itemKey);
		GameData.Domains.Item.Cricket element_Crickets = DomainManager.Item.GetElement_Crickets(itemKey.Id);
		element_Crickets.SetWinsCount(15, Domain.MainThreadDataContext);
		return itemKey;
	}

	public static ItemKey AddRandomCricketKingToInventory(GameData.Domains.Character.Character character)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		List<(short, short)> obj = mainThreadDataContext.AdvanceMonthRelatedData.WeightTable.Occupy();
		foreach (CricketPartsItem item in (IEnumerable<CricketPartsItem>)CricketParts.Instance)
		{
			if (item.Type == ECricketPartsType.King)
			{
				obj.Add((item.TemplateId, item.Rate));
			}
		}
		short randomResult = RandomUtils.GetRandomResult(obj, mainThreadDataContext.Random);
		ItemKey itemKey = DomainManager.Item.CreateCricket(mainThreadDataContext, randomResult, 0);
		character.AddInventoryItem(mainThreadDataContext, itemKey, 1);
		mainThreadDataContext.AdvanceMonthRelatedData.WeightTable.Release(ref obj);
		return itemKey;
	}

	public static void AddEatingItem(GameData.Domains.Character.Character itemOwner, GameData.Domains.Character.Character itemEater, ItemKey itemKey)
	{
		itemOwner.RemoveInventoryItem(Domain.MainThreadDataContext, itemKey, 1, deleteItem: false);
		itemEater.AddEatingItem(Domain.MainThreadDataContext, itemKey);
	}

	public static void ApplyTopicalMedicine(GameData.Domains.Character.Character itemOwner, GameData.Domains.Character.Character itemUser, ItemKey itemKey)
	{
		itemUser.ApplyTopicalMedicine(Domain.MainThreadDataContext, itemKey);
		itemOwner.RemoveInventoryItem(Domain.MainThreadDataContext, itemKey, 1, deleteItem: true);
	}

	public static void ApplyGeneralActionChanges(IGeneralAction generalAction, GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar)
	{
		generalAction.ApplyChanges(Domain.MainThreadDataContext, selfChar, targetChar);
		CommitLifeRecords();
	}

	public static void AllocateNeili(int charId, byte neiliAllocationType)
	{
		DomainManager.Character.GetElement_Objects(charId).AllocateNeili(Domain.MainThreadDataContext, neiliAllocationType);
	}

	public static short AddExtraNeiliAllocationProgressToGainExtraNeiliAllocation(GameData.Domains.Character.Character character, byte neiliAllocationType, int deltaNeiliAllocation)
	{
		return DomainManager.CombatSkill.AddExtraNeiliAllocationProgressToGainExtraNeiliAllocation(Domain.MainThreadDataContext, character, neiliAllocationType, deltaNeiliAllocation);
	}

	[Obsolete]
	public static void SetCombatSkillSlot(int charId, sbyte equipType, int index, short skillTemplateId)
	{
		AddEquippedCombatSkill(charId, skillTemplateId);
	}

	public static void AddEquippedCombatSkill(int charId, short skillTemplateId)
	{
		DomainManager.Character.AddEquippedCombatSkill(Domain.MainThreadDataContext, charId, skillTemplateId);
	}

	public static void CreateCombatSkillSelectRequestOfCharacter(TaiwuEventItem eventItem, int optionIndex, int charId, string resultSaveKey, List<short> combatSKillIdList)
	{
		if (eventItem == null)
		{
			throw new Exception("wrong argument received : null eventItem!");
		}
		if (!eventItem.EventOptions.CheckIndex(optionIndex))
		{
			throw new Exception("wrong argument received : optionIndex is out of range!");
		}
		if (charId < 0)
		{
			throw new Exception("wrong argument received : charId is not a valid character id!");
		}
		if (string.IsNullOrEmpty(resultSaveKey))
		{
			throw new Exception("wrong argument received : resultSaveKey can not empty!");
		}
		if (combatSKillIdList == null || combatSKillIdList.Count <= 0)
		{
			throw new Exception("wrong argument received : combatSKillIdList can not be null and must has at least one element!");
		}
		EventSelectCombatSkillData value = new EventSelectCombatSkillData
		{
			CharId = charId,
			OptionKey = eventItem.EventOptions[optionIndex].OptionKey,
			ResultSaveKey = resultSaveKey,
			CanSelectCombatSkillIdList = combatSKillIdList
		};
		Domain.SetSelectCombatSkillData(value, Domain.MainThreadDataContext);
	}

	public static void StartSelectCombatSkill(int charId, List<short> combatSKillIdList, string nextEventGuid, EventArgBox argBox)
	{
		if (charId < 0)
		{
			throw new Exception("wrong argument received : charId is not a valid character id!");
		}
		if (!string.IsNullOrEmpty(nextEventGuid))
		{
			AddEventInListenWithActionName(nextEventGuid, argBox, "FinishSelectCombatSkill");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.SelectCombatSkill, charId, combatSKillIdList);
	}

	public static void CreateLifeSkillSelectRequestOfCharacter(TaiwuEventItem eventItem, int optionIndex, int charId, string resultSaveKey, List<short> lifeSKillIdList)
	{
		if (eventItem == null)
		{
			throw new Exception("wrong argument received : null eventItem!");
		}
		if (!eventItem.EventOptions.CheckIndex(optionIndex))
		{
			throw new Exception("wrong argument received : optionIndex is out of range!");
		}
		if (charId < 0)
		{
			throw new Exception("wrong argument received : charId is not a valid character id!");
		}
		if (string.IsNullOrEmpty(resultSaveKey))
		{
			throw new Exception("wrong argument received : resultSaveKey can not empty!");
		}
		if (lifeSKillIdList == null || lifeSKillIdList.Count <= 0)
		{
			throw new Exception("wrong argument received : combatSKillIdList can not be null and must has at least one element!");
		}
		EventSelectLifeSkillData value = new EventSelectLifeSkillData
		{
			CharId = charId,
			OptionKey = eventItem.EventOptions[optionIndex].OptionKey,
			ResultSaveKey = resultSaveKey,
			CanSelectLifeSkillIdList = lifeSKillIdList
		};
		Domain.SetSelectLifeSkillData(value, Domain.MainThreadDataContext);
	}

	public static void ChangeEquipment(int charId, sbyte srcSlot, sbyte destSlot, ItemKey srcItemKey)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		element_Objects.ChangeEquipment(Domain.MainThreadDataContext, srcSlot, destSlot, srcItemKey);
	}

	public static string GetNpcRandomWord(GameData.Domains.Character.Character npcChar)
	{
		return GetNpcRandomWordByType(npcChar, ENpcRandomWordsType.Normal);
	}

	public static string GetNpcRandomWordByType(GameData.Domains.Character.Character npcChar, ENpcRandomWordsType type)
	{
		if (npcChar == null)
		{
			throw new Exception("null character can not get random word");
		}
		return type.RandomContent(Domain.MainThreadDataContext.Random, npcChar);
	}

	public static string GetNpcRandomWordByTypeWithNormal(GameData.Domains.Character.Character npcChar, ENpcRandomWordsType type)
	{
		if (npcChar == null)
		{
			throw new Exception("null character can not get random word");
		}
		return type.RandomContent(Domain.MainThreadDataContext.Random, npcChar, ENpcRandomWordsType.Normal);
	}

	public static string GetNpcRandomWordFirstInType(GameData.Domains.Character.Character npcChar, ENpcRandomWordsType type)
	{
		string npcRandomWordByType = GetNpcRandomWordByType(npcChar, type);
		return string.IsNullOrEmpty(npcRandomWordByType) ? GetNpcRandomWord(npcChar) : npcRandomWordByType;
	}

	public static sbyte GetMaxLifeSkillAttainmentType(int charId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		return element_Objects.GetMaxLifeSkillAttainmentType(DomainManager.TaiwuEvent.MainThreadDataContext);
	}

	public static GameData.Domains.Character.Character GetMaxCombatPowerCharacter(List<GameData.Domains.Character.Character> characters)
	{
		if (characters == null || characters.Count == 0)
		{
			return null;
		}
		int num = -1;
		int num2 = -1;
		for (int i = 0; i < characters.Count; i++)
		{
			if (characters[i].GetCombatPower() > num2)
			{
				num2 = characters[i].GetCombatPower();
				num = i;
			}
		}
		if (num == -1)
		{
			return null;
		}
		return characters[num];
	}

	public static bool CompareCombatPower(int charIdA, int charIdB)
	{
		return AdventureCharacterSortUtils.CompareCombatPower(charIdA, charIdB) >= 0;
	}

	public static int GetSimulateCharacterCombatWinRate(GameData.Domains.Character.Character charA, GameData.Domains.Character.Character charB)
	{
		return DomainManager.Character.GetSimulateCharacterCombatWinRate(Domain.MainThreadDataContext, charA, charB);
	}

	public static int GetSimulateCharacterCombatWinRate(GameData.Domains.Character.Character charA, GameData.Domains.Character.Character charB, int powerA, int powerB)
	{
		bool charAInvincible = charA.IsInvincibleInNpcCombat();
		bool charBInvincible = charB.IsInvincibleInNpcCombat();
		return DomainManager.Character.GetSimulateCharacterCombatWinRate(powerA, powerB, charAInvincible, charBInvincible, Domain.MainThreadDataContext.Random.NextBool());
	}

	public static bool TryGetFixedCharacterByTemplateId(short templateId, out GameData.Domains.Character.Character character)
	{
		return DomainManager.Character.TryGetFixedCharacterByTemplateId(templateId, out character);
	}

	public static void StartSelectChar(string selectCompleteEvent, EventArgBox argBox, Predicate<GameData.Domains.Character.Character> predicate = null)
	{
		CharacterSet groupCharIds = DomainManager.Taiwu.GetGroupCharIds();
		groupCharIds.Remove(DomainManager.Taiwu.GetTaiwuCharId());
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		list.Clear();
		foreach (int item in groupCharIds.GetCollection())
		{
			GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(item);
			if (element_Objects.GetAgeGroup() > 1 && (predicate == null || predicate(element_Objects)))
			{
				list.Add(item);
			}
		}
		List<CharacterDisplayData> characterDisplayDataList = DomainManager.Character.GetCharacterDisplayDataList(list);
		Domain.SetListenerWithActionName(selectCompleteEvent, argBox, "SelectCharOver");
		if (characterDisplayDataList.Count == 0)
		{
			throw new Exception("no available teammate can selected !");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.SelectCharSoul, list, characterDisplayDataList);
		ObjectPool<List<int>>.Instance.Return(list);
	}

	public static void StartUltimateSelectCharacterForDirectSamsaraMother(string selectCompleteEvent, EventArgBox argBox)
	{
		Domain.SetListenerWithActionName(selectCompleteEvent, argBox, " UltimateSelectCharOver");
		CharacterSortFilterSettings characterSortFilterSettings = new CharacterSortFilterSettings();
		characterSortFilterSettings.FilterType = 0;
		characterSortFilterSettings.FilterSubType = 0;
		DomainManager.Character.InitializeCharacterSortFilter(characterSortFilterSettings);
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.UltimateSelectCharacterForDirectSamsaraMother, characterSortFilterSettings);
	}

	public static void StartSelectChar(string selectCompleteEvent, EventArgBox argBox, List<GameData.Domains.Character.Character> characters)
	{
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		list.Clear();
		for (int i = 0; i < characters.Count; i++)
		{
			list.Add(characters[i].GetId());
		}
		List<CharacterDisplayData> characterDisplayDataList = DomainManager.Character.GetCharacterDisplayDataList(list);
		Domain.SetListenerWithActionName(selectCompleteEvent, argBox, "SelectCharOver");
		if (characterDisplayDataList.Count == 0)
		{
			throw new Exception("no available teammate can selected !");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.SelectCharSoul, list, characterDisplayDataList);
		ObjectPool<List<int>>.Instance.Return(list);
	}

	public static void StartSelectSoul(string selectCompleteEvent, EventArgBox argBox)
	{
		HashSet<int> hashSet = ObjectPool<HashSet<int>>.Instance.Get();
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		list.Clear();
		DomainManager.Character.GetAllWaitingReincarnationCharIds(hashSet);
		foreach (int item in hashSet)
		{
			if (CanSelectSoul(item))
			{
				list.Add(item);
			}
			if (list.Count >= 12)
			{
				break;
			}
		}
		Domain.SetListenerWithActionName(selectCompleteEvent, argBox, "SelectCharOver");
		if (list.Count == 0)
		{
			throw new Exception("no available teammate can selected !");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.SelectCharSoul, list, (sbyte)12, arg3: true);
		ObjectPool<List<int>>.Instance.Return(list);
		ObjectPool<HashSet<int>>.Instance.Return(hashSet);
	}

	private static bool CanSelectSoul(int charId)
	{
		if (DomainManager.Building.IsCharOnSamsaraPlatform(charId))
		{
			return false;
		}
		if (DomainManager.Extra.IsSavedSoul(charId))
		{
			return false;
		}
		if (DomainManager.Character.TryGetDeadCharacter(charId, out var character) && character.IsCompletelyInfected())
		{
			return false;
		}
		return true;
	}

	public static bool HasSoulToSelect()
	{
		HashSet<int> hashSet = ObjectPool<HashSet<int>>.Instance.Get();
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		DomainManager.Character.GetAllWaitingReincarnationCharIds(hashSet);
		foreach (int item in hashSet)
		{
			if (CanSelectSoul(item))
			{
				list.Add(item);
			}
		}
		int count = list.Count;
		ObjectPool<HashSet<int>>.Instance.Return(hashSet);
		ObjectPool<List<int>>.Instance.Return(list);
		return count > 0;
	}

	public static CharacterSet GetGroup(int leaderId)
	{
		return DomainManager.Character.GetGroup(leaderId);
	}

	public static List<int> GetTaiwuAdultGroups()
	{
		List<int> list = new List<int>();
		HashSet<int> collection = DomainManager.Taiwu.GetGroupCharIds().GetCollection();
		foreach (int item in collection)
		{
			if (item != DomainManager.Taiwu.GetTaiwuCharId() && DomainManager.Character.TryGetElement_Objects(item, out var element) && element.GetAgeGroup() >= 2)
			{
				list.Add(item);
			}
		}
		return list;
	}

	public static bool IsCharacterAdult(int id)
	{
		GameData.Domains.Character.Character element;
		return DomainManager.Character.TryGetElement_Objects(id, out element) && element.GetAgeGroup() == 2;
	}

	public static sbyte GetEnemyConsummateLevelByTemplateId(short charTemplateId)
	{
		return Config.Character.Instance[charTemplateId].ConsummateLevel;
	}

	public static bool IsCharacterAllPoisonImmune(GameData.Domains.Character.Character character)
	{
		for (sbyte b = 0; b < 6; b++)
		{
			if (character.GetPoisonResist(b) < 1000)
			{
				return false;
			}
		}
		return true;
	}

	public static CharacterLoveAndHateItemInfo GetCharacterLoveAndHateItemInfo(int charId)
	{
		return DomainManager.Character.GetCharacterLoveAndHateItemInfo(Domain.MainThreadDataContext, charId);
	}

	public static void SetFixedCharacterNonOrganization(GameData.Domains.Character.Character character)
	{
		Tester.Assert(Config.Character.Instance[character.GetTemplateId()].CreatingType == 0);
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		character.SetOrganizationInfo(OrganizationInfo.None, mainThreadDataContext);
	}

	public unsafe static bool CheckCharacterSamsara(int charA, int charB)
	{
		CharacterSamsaraData characterSamsaraData = DomainManager.Character.GetCharacterSamsaraData(charA);
		PreexistenceCharIds preexistenceCharIds = characterSamsaraData.PreexistenceCharIds;
		for (int i = 0; i < preexistenceCharIds.Count; i++)
		{
			if (preexistenceCharIds.CharIds[i] == charB)
			{
				return true;
			}
		}
		return false;
	}

	public static string GetRefuseAppointmentText(GameData.Domains.Character.Character character)
	{
		BasePrioritizedAction action;
		return (DomainManager.Character.TryGetCharacterPrioritizedAction(character.GetId(), out action) && action.ActionType >= 0) ? PrioritizedActions.Instance[action.ActionType].RefuseAppointment : string.Empty;
	}

	public static GameData.Domains.CombatSkill.CombatSkill CharacterLearnNewCombatSkill(GameData.Domains.Character.Character character, short combatSkillTemplateId, ushort readingState)
	{
		return character.LearnNewCombatSkill(Domain.MainThreadDataContext, combatSkillTemplateId, readingState);
	}

	public static GameData.Domains.Character.Character CreateCloseFriend(sbyte gender = -1)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		if (gender == -1)
		{
			gender = Gender.Flip(taiwu.GetGender());
		}
		sbyte randomSectOrgTemplateId = OrganizationDomain.GetRandomSectOrgTemplateId(mainThreadDataContext.Random, gender);
		sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(taiwu.GetLocation().AreaId);
		short characterTemplateId = OrganizationDomain.GetCharacterTemplateId(randomSectOrgTemplateId, stateTemplateIdByAreaId, gender);
		short morality = taiwu.GetMorality();
		GameData.Domains.Character.Character character = DomainManager.Character.CreateCloseFriend(mainThreadDataContext, characterTemplateId, morality, taiwu);
		int id = character.GetId();
		DomainManager.Taiwu.JoinGroup(mainThreadDataContext, id);
		ShowGetItemPageForCharacters(new List<int> { id }, isVillager: false);
		return character;
	}

	public static GameData.Domains.Character.Character CreateIntelligentCharacter(Location location, sbyte gender, short age, short baseAttraction, short settlementId, sbyte grade)
	{
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		sbyte orgTemplateId = settlement.GetOrgTemplateId();
		OrganizationInfo orgInfo = new OrganizationInfo(orgTemplateId, grade, principal: true, settlementId);
		sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(location.AreaId);
		short characterTemplateId = OrganizationDomain.GetCharacterTemplateId(orgTemplateId, stateTemplateIdByAreaId, gender);
		IntelligentCharacterCreationInfo intelligentCharacterCreationInfo = new IntelligentCharacterCreationInfo(location, orgInfo, characterTemplateId);
		intelligentCharacterCreationInfo.BaseAttraction = baseAttraction;
		intelligentCharacterCreationInfo.Age = age;
		IntelligentCharacterCreationInfo info = intelligentCharacterCreationInfo;
		GameData.Domains.Character.Character character = DomainManager.Character.CreateIntelligentCharacter(Domain.MainThreadDataContext, ref info);
		DomainManager.Character.CompleteCreatingCharacter(character.GetId());
		return character;
	}

	public static GameData.Domains.Character.Character CreateTemporaryIntelligentCharacter(Location location, sbyte gender, short age, short baseAttraction, short settlementId, sbyte grade)
	{
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		sbyte orgTemplateId = settlement.GetOrgTemplateId();
		OrganizationInfo orgInfo = new OrganizationInfo(orgTemplateId, grade, principal: true, settlementId);
		sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(location.AreaId);
		short characterTemplateId = OrganizationDomain.GetCharacterTemplateId(orgTemplateId, stateTemplateIdByAreaId, gender);
		TemporaryIntelligentCharacterCreationInfo tmpInfo = new TemporaryIntelligentCharacterCreationInfo
		{
			Location = location,
			OrgInfo = orgInfo,
			CharTemplateId = characterTemplateId,
			BaseAttraction = baseAttraction,
			ActualAge = age
		};
		GameData.Domains.Character.Character character = DomainManager.Character.CreateTemporaryIntelligentCharacter(Domain.MainThreadDataContext, ref tmpInfo);
		int id = character.GetId();
		DomainManager.Adventure.AddTemporaryIntelligentCharacter(id);
		return character;
	}

	public static GameData.Domains.Character.Character CreateMissNingOfTaiwuVillage()
	{
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		short taiwuVillageSettlementId = DomainManager.Taiwu.GetTaiwuVillageSettlementId();
		OrganizationInfo orgInfo = new OrganizationInfo(16, 0, principal: true, taiwuVillageSettlementId);
		sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(taiwuVillageLocation.AreaId);
		sbyte sectID = MapState.Instance[stateTemplateIdByAreaId].SectID;
		short characterTemplateId = OrganizationDomain.GetCharacterTemplateId(sectID, stateTemplateIdByAreaId, 0);
		IntelligentCharacterCreationInfo intelligentCharacterCreationInfo = new IntelligentCharacterCreationInfo(taiwuVillageLocation, orgInfo, characterTemplateId);
		intelligentCharacterCreationInfo.Age = 13;
		intelligentCharacterCreationInfo.BaseAttraction = 750;
		intelligentCharacterCreationInfo.GrowingSectId = sectID;
		intelligentCharacterCreationInfo.GrowingSectGrade = 3;
		intelligentCharacterCreationInfo.ReferenceFullName = new FullName(-1, -1, 1303, -1, -1, -1);
		intelligentCharacterCreationInfo.Race = 0;
		IntelligentCharacterCreationInfo info = intelligentCharacterCreationInfo;
		GameData.Domains.Character.Character character = DomainManager.Character.CreateIntelligentCharacter(Domain.MainThreadDataContext, ref info);
		int id = character.GetId();
		DomainManager.Character.CompleteCreatingCharacter(id);
		return character;
	}

	[Obsolete]
	public static void CreateIntelligentCharacterWithQualificationBonus(sbyte gender, bool hasLifeSkillAdjustBonus, bool hasCombatSkillAdjustBonus)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		OrganizationInfo organizationInfo = taiwu.GetOrganizationInfo();
		organizationInfo.Grade = 0;
		if (gender < 0)
		{
			gender = Gender.GetRandom(mainThreadDataContext.Random);
		}
		short age = (short)mainThreadDataContext.Random.Next(12, 25);
		sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(location.AreaId);
		sbyte sectID = MapState.Instance[stateTemplateIdByAreaId].SectID;
		short characterTemplateId = OrganizationDomain.GetCharacterTemplateId(sectID, stateTemplateIdByAreaId, gender);
		short[] array = null;
		if (hasLifeSkillAdjustBonus)
		{
			Span<int> resultIndices = stackalloc int[GlobalConfig.Instance.MixiangzhenLifeSkillAdjustTypeCount];
			RandomUtils.GetRandomUnrepeated(mainThreadDataContext.Random, 0, 15, resultIndices);
			array = new short[16];
			for (int i = 0; i < GlobalConfig.Instance.MixiangzhenLifeSkillAdjustTypeCount; i++)
			{
				int num = resultIndices[i];
				array[num] = GlobalConfig.Instance.MixiangzhenLifeSkillAdjustBonus;
			}
		}
		short[] array2 = null;
		if (hasCombatSkillAdjustBonus)
		{
			Span<int> resultIndices2 = stackalloc int[GlobalConfig.Instance.XiuluochangCombatSkillAdjustTypeCount];
			RandomUtils.GetRandomUnrepeated(mainThreadDataContext.Random, 0, 13, resultIndices2);
			array2 = new short[16];
			for (int j = 0; j < GlobalConfig.Instance.XiuluochangCombatSkillAdjustTypeCount; j++)
			{
				int num2 = resultIndices2[j];
				array2[num2] = GlobalConfig.Instance.XiuluochangCombatSkillAdjustBonus;
			}
		}
		IntelligentCharacterCreationInfo intelligentCharacterCreationInfo = new IntelligentCharacterCreationInfo(location, organizationInfo, characterTemplateId);
		intelligentCharacterCreationInfo.Age = age;
		intelligentCharacterCreationInfo.LifeSkillsLowerBound = array;
		intelligentCharacterCreationInfo.CombatSkillsLowerBound = array2;
		intelligentCharacterCreationInfo.InitializeSectSkills = false;
		IntelligentCharacterCreationInfo info = intelligentCharacterCreationInfo;
		GameData.Domains.Character.Character character = DomainManager.Character.CreateIntelligentCharacter(Domain.MainThreadDataContext, ref info);
		int id = character.GetId();
		DomainManager.Character.CompleteCreatingCharacter(id);
		DomainManager.Taiwu.JoinGroup(mainThreadDataContext, id);
		ShowGetItemPageForCharacters(new List<int> { id }, isVillager: false);
		DomainManager.Adventure.AddCharacterToResultDisplay(id);
	}

	public static int CreateIntelligentCharacterWithQualificationBonusWithReturn(sbyte gender, bool hasLifeSkillAdjustBonus, bool hasCombatSkillAdjustBonus)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		OrganizationInfo organizationInfo = taiwu.GetOrganizationInfo();
		organizationInfo.Grade = 0;
		if (gender < 0)
		{
			gender = Gender.GetRandom(mainThreadDataContext.Random);
		}
		short age = (short)mainThreadDataContext.Random.Next(12, 25);
		sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(location.AreaId);
		sbyte sectID = MapState.Instance[stateTemplateIdByAreaId].SectID;
		short characterTemplateId = OrganizationDomain.GetCharacterTemplateId(sectID, stateTemplateIdByAreaId, gender);
		short[] array = null;
		if (hasLifeSkillAdjustBonus)
		{
			Span<int> resultIndices = stackalloc int[GlobalConfig.Instance.MixiangzhenLifeSkillAdjustTypeCount];
			RandomUtils.GetRandomUnrepeated(mainThreadDataContext.Random, 0, 15, resultIndices);
			array = new short[16];
			for (int i = 0; i < GlobalConfig.Instance.MixiangzhenLifeSkillAdjustTypeCount; i++)
			{
				int num = resultIndices[i];
				array[num] = GlobalConfig.Instance.MixiangzhenLifeSkillAdjustBonus;
			}
		}
		short[] array2 = null;
		if (hasCombatSkillAdjustBonus)
		{
			Span<int> resultIndices2 = stackalloc int[GlobalConfig.Instance.XiuluochangCombatSkillAdjustTypeCount];
			RandomUtils.GetRandomUnrepeated(mainThreadDataContext.Random, 0, 13, resultIndices2);
			array2 = new short[16];
			for (int j = 0; j < GlobalConfig.Instance.XiuluochangCombatSkillAdjustTypeCount; j++)
			{
				int num2 = resultIndices2[j];
				array2[num2] = GlobalConfig.Instance.XiuluochangCombatSkillAdjustBonus;
			}
		}
		IntelligentCharacterCreationInfo intelligentCharacterCreationInfo = new IntelligentCharacterCreationInfo(location, organizationInfo, characterTemplateId);
		intelligentCharacterCreationInfo.Age = age;
		intelligentCharacterCreationInfo.LifeSkillsLowerBound = array;
		intelligentCharacterCreationInfo.CombatSkillsLowerBound = array2;
		intelligentCharacterCreationInfo.InitializeSectSkills = false;
		IntelligentCharacterCreationInfo info = intelligentCharacterCreationInfo;
		GameData.Domains.Character.Character character = DomainManager.Character.CreateIntelligentCharacter(Domain.MainThreadDataContext, ref info);
		int id = character.GetId();
		DomainManager.Character.CompleteCreatingCharacter(id);
		DomainManager.Taiwu.JoinGroup(mainThreadDataContext, id);
		ShowGetItemPageForCharacters(new List<int> { id }, isVillager: false);
		return id;
	}

	public static void MakeLove(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, bool isRape)
	{
		selfChar.MakeLove(Domain.MainThreadDataContext, targetChar, isRape);
	}

	public static void ConvertPregnantWithCricketToHuman(int motherId)
	{
		DomainManager.Character.ConvertPregnantWithCricketToHuman(Domain.MainThreadDataContext, motherId);
	}

	public static void DefaultHandleNewbornChild(int babyCharId, int motherCharId, int fatherCharId, int actualFatherCharId)
	{
		if (babyCharId >= 0)
		{
			DataContext mainThreadDataContext = Domain.MainThreadDataContext;
			GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(babyCharId);
			bool createMotherRelation = DomainManager.Character.OrgAndMonkTypeAllowMarriage(motherCharId);
			int aliveSpouse = DomainManager.Character.GetAliveSpouse(fatherCharId);
			bool createFatherRelation = DomainManager.Character.OrgAndMonkTypeAllowMarriage(fatherCharId) && (aliveSpouse < 0 || aliveSpouse == motherCharId);
			bool isMotherAlive = DomainManager.Character.IsCharacterAlive(motherCharId);
			bool isFatherAlive = DomainManager.Character.IsCharacterAlive(fatherCharId);
			if (CheckParentAbandonNewbornChild(motherCharId, fatherCharId))
			{
				AbandonNewbornChild(babyCharId, motherCharId, (actualFatherCharId >= 0) ? actualFatherCharId : fatherCharId);
			}
			else
			{
				DomainManager.Character.HandleNotAbandonedNewbornChildRelationsAndGroup(mainThreadDataContext, element_Objects, motherCharId, fatherCharId, actualFatherCharId, createMotherRelation, createFatherRelation, isMotherAlive, isFatherAlive);
			}
		}
	}

	public static void AdoptAbandonedNewbornChild(int adopterCharId, int babyCharId, int motherCharId, int fatherCharId)
	{
		if (babyCharId >= 0)
		{
			DataContext mainThreadDataContext = Domain.MainThreadDataContext;
			GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(adopterCharId);
			GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(babyCharId);
			DomainManager.Character.AbandonNewbornChild(mainThreadDataContext, element_Objects2, element_Objects, motherCharId, fatherCharId);
		}
	}

	public static void AbandonNewbornChild(int babyCharId, int motherCharId, int fatherCharId)
	{
		if (babyCharId >= 0)
		{
			DataContext mainThreadDataContext = Domain.MainThreadDataContext;
			GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(babyCharId);
			DomainManager.Character.RemoveAllRelations(mainThreadDataContext, babyCharId, removeRelatedRelations: true);
			DomainManager.Character.AbandonNewbornChild(mainThreadDataContext, element_Objects, null, motherCharId, fatherCharId);
		}
	}

	public static void SetCharacterCustomName(GameData.Domains.Character.Character character, int parentId, string customGivenName)
	{
		GameData.Domains.Character.Character element;
		FullName fullName = (DomainManager.Character.TryGetElement_Objects(parentId, out element) ? element.GetFullName() : DomainManager.Character.GetDeadCharacter(parentId).FullName);
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		int customGivenNameId = DomainManager.World.RegisterCustomText(mainThreadDataContext, customGivenName);
		FullName fullName2 = new FullName(fullName.CustomSurnameId, customGivenNameId, fullName.SurnameId, -1, -1, -1);
		character.SetFullName(fullName2, mainThreadDataContext);
	}

	public static void SetCharacterSurname(GameData.Domains.Character.Character character, int parentId)
	{
		GameData.Domains.Character.Character element;
		FullName otherName = (DomainManager.Character.TryGetElement_Objects(parentId, out element) ? element.GetFullName() : DomainManager.Character.GetDeadCharacter(parentId).FullName);
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		FullName fullName = character.GetFullName();
		if ((fullName.Type | 2) != fullName.Type)
		{
			if ((otherName.Type | 2) == otherName.Type)
			{
				fullName = CharacterDomain.GenerateRandomZangName(mainThreadDataContext.Random, character.GetGender());
			}
			else
			{
				fullName.InheritSurname(otherName);
			}
		}
		else if ((otherName.Type | 2) != otherName.Type)
		{
			(string, string) realName = CharacterDomain.GetRealName(character);
			int customGivenName = DomainManager.World.RegisterCustomText(mainThreadDataContext, realName.Item2);
			fullName.InheritSurname(otherName);
			fullName.SetCustomGivenName(customGivenName);
		}
		character.SetFullName(fullName, mainThreadDataContext);
	}

	public static void SetCharacterGivenName(GameData.Domains.Character.Character character, string customGivenName)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		int customGivenName2 = DomainManager.World.RegisterCustomText(mainThreadDataContext, customGivenName);
		FullName fullName = character.GetFullName();
		fullName.SetCustomGivenName(customGivenName2);
		character.SetFullName(fullName, mainThreadDataContext);
	}

	public static void ApplyRelationBecomeEnemy(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		bool selfIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(selfChar.GetId());
		GameData.Domains.Character.Character.ApplyAddRelation_Enemy(mainThreadDataContext, selfChar, targetChar, selfIsTaiwuPeople, 0);
		if (DomainManager.Character.HasRelation(selfChar.GetId(), targetChar.GetId(), 32768))
		{
			DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: false, selfChar.GetId(), targetChar.GetId(), 32768);
		}
	}

	public static void ApplyRelationSeverEnemy(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte behaviorType = selfChar.GetBehaviorType();
		bool selfIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(selfChar.GetId());
		GameData.Domains.Character.Character.ApplySeverEnemy(mainThreadDataContext, selfChar, targetChar, behaviorType, selfIsTaiwuPeople);
		DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: true, selfChar.GetId(), targetChar.GetId(), 32768);
	}

	public static void ApplyRelationBecomeFriend(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte behaviorType = selfChar.GetBehaviorType();
		bool selfIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(selfChar.GetId());
		bool targetIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(targetChar.GetId());
		GameData.Domains.Character.Character.ApplyBecomeFriend(mainThreadDataContext, selfChar, targetChar, behaviorType, selfIsTaiwuPeople, targetIsTaiwuPeople);
		if (DomainManager.Character.HasRelation(targetChar.GetId(), selfChar.GetId(), 8192))
		{
			DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: false, selfChar.GetId(), targetChar.GetId(), 8192);
		}
	}

	public static void ApplyRelationSeverFriend(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte behaviorType = selfChar.GetBehaviorType();
		bool selfIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(selfChar.GetId());
		bool targetIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(targetChar.GetId());
		GameData.Domains.Character.Character.ApplySeverFriend(mainThreadDataContext, selfChar, targetChar, behaviorType, selfIsTaiwuPeople, targetIsTaiwuPeople);
		if (!DomainManager.Character.HasRelation(targetChar.GetId(), selfChar.GetId(), 8192))
		{
			DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: true, selfChar.GetId(), targetChar.GetId(), 8192);
		}
	}

	public static void ApplyRelationBecomeAdore(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, bool targetLoveBack)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte behaviorType = selfChar.GetBehaviorType();
		bool selfIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(selfChar.GetId());
		bool targetIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(targetChar.GetId());
		GameData.Domains.Character.Character.ApplyAddRelation_Adore(mainThreadDataContext, selfChar, targetChar, behaviorType, targetLoveBack, selfIsTaiwuPeople, targetIsTaiwuPeople);
		if (DomainManager.Character.HasRelation(selfChar.GetId(), targetChar.GetId(), 16384))
		{
			DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: false, selfChar.GetId(), targetChar.GetId(), 16384);
		}
	}

	public static void ApplyRelationBecomeBoyOrGirlFriend(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, bool succeed)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte behaviorType = selfChar.GetBehaviorType();
		bool selfIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(selfChar.GetId());
		bool targetIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(targetChar.GetId());
		GameData.Domains.Character.Character.ApplyBecomeBoyOrGirlFriend(mainThreadDataContext, selfChar, targetChar, behaviorType, succeed, selfIsTaiwuPeople, targetIsTaiwuPeople);
		if (succeed)
		{
			if (DomainManager.Character.HasRelation(targetChar.GetId(), selfChar.GetId(), 16384))
			{
				DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: false, selfChar.GetId(), targetChar.GetId(), 16384);
			}
		}
		else if (DomainManager.Character.HasRelation(selfChar.GetId(), targetChar.GetId(), 32768))
		{
			DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: false, selfChar.GetId(), targetChar.GetId(), 32768);
		}
	}

	public static void ApplyRelationBreakupWithBoyOrGirlFriend(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, bool targetStillLoveSelf)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte behaviorType = selfChar.GetBehaviorType();
		bool selfIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(selfChar.GetId());
		bool targetIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(targetChar.GetId());
		GameData.Domains.Character.Character.ApplyBreakupWithBoyOrGirlFriend(mainThreadDataContext, selfChar, targetChar, behaviorType, targetStillLoveSelf, selfIsTaiwuPeople, targetIsTaiwuPeople);
		if (!DomainManager.Character.HasRelation(selfChar.GetId(), targetChar.GetId(), 16384))
		{
			DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: true, selfChar.GetId(), targetChar.GetId(), 16384);
			if (DomainManager.Character.HasRelation(targetChar.GetId(), selfChar.GetId(), 32768))
			{
				DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: false, selfChar.GetId(), targetChar.GetId(), 32768);
			}
		}
	}

	public static void ApplyRelationBecomeSwornBrotherOrSister(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte behaviorType = selfChar.GetBehaviorType();
		bool selfIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(selfChar.GetId());
		bool targetIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(targetChar.GetId());
		GameData.Domains.Character.Character.ApplyBecomeSwornBrotherOrSister(mainThreadDataContext, selfChar, targetChar, behaviorType, selfIsTaiwuPeople, targetIsTaiwuPeople);
		AddLegacyPoint(5);
		if (DomainManager.Character.HasRelation(targetChar.GetId(), selfChar.GetId(), 512))
		{
			DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: false, selfChar.GetId(), targetChar.GetId(), 512);
		}
	}

	public static void ApplyRelationSeverSwornBrotherOrSister(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte behaviorType = selfChar.GetBehaviorType();
		bool selfIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(selfChar.GetId());
		bool targetIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(targetChar.GetId());
		GameData.Domains.Character.Character.ApplySeverSwornBrotherOrSister(mainThreadDataContext, selfChar, targetChar, behaviorType, selfIsTaiwuPeople, targetIsTaiwuPeople);
		if (!DomainManager.Character.HasRelation(targetChar.GetId(), selfChar.GetId(), 512))
		{
			DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: true, selfChar.GetId(), targetChar.GetId(), 512);
		}
	}

	public static void ApplyRelationBecomeHusbandOrWife(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, bool succeed)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte behaviorType = selfChar.GetBehaviorType();
		bool selfIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(selfChar.GetId());
		bool targetIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(targetChar.GetId());
		GameData.Domains.Character.Character.ApplyBecomeHusbandOrWife(mainThreadDataContext, selfChar, targetChar, behaviorType, succeed, selfIsTaiwuPeople, targetIsTaiwuPeople);
		if (succeed)
		{
			if (DomainManager.Character.HasRelation(targetChar.GetId(), selfChar.GetId(), 1024))
			{
				AddLegacyPoint(3);
				DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: false, selfChar.GetId(), targetChar.GetId(), 1024);
			}
		}
		else if (DomainManager.Character.HasRelation(selfChar.GetId(), targetChar.GetId(), 32768))
		{
			DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: false, selfChar.GetId(), targetChar.GetId(), 32768);
		}
	}

	public static void ApplyRelationSeverHusbandOrWife(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte behaviorType = selfChar.GetBehaviorType();
		bool selfIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(selfChar.GetId());
		bool targetIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(targetChar.GetId());
		GameData.Domains.Character.Character.ApplySeverHusbandOrWife(mainThreadDataContext, selfChar, targetChar, behaviorType, selfIsTaiwuPeople, targetIsTaiwuPeople);
		if (!DomainManager.Character.HasRelation(targetChar.GetId(), selfChar.GetId(), 1024))
		{
			DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: true, selfChar.GetId(), targetChar.GetId(), 1024);
		}
	}

	public static void ApplyRelationAdoptChild(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte behaviorType = selfChar.GetBehaviorType();
		bool selfIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(selfChar.GetId());
		bool targetIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(targetChar.GetId());
		GameData.Domains.Character.Character.ApplyAddRelation_AdoptiveChild(mainThreadDataContext, selfChar, targetChar, behaviorType, selfIsTaiwuPeople, targetIsTaiwuPeople);
		if (DomainManager.Character.HasRelation(selfChar.GetId(), targetChar.GetId(), 128))
		{
			DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: false, selfChar.GetId(), targetChar.GetId(), 128);
		}
	}

	public static void ApplyRelationSeverAdoptedChild(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte behaviorType = selfChar.GetBehaviorType();
		bool selfIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(selfChar.GetId());
		bool targetIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(targetChar.GetId());
		GameData.Domains.Character.Character.ApplyEndRelation_AdoptiveChild(mainThreadDataContext, selfChar, targetChar, behaviorType, selfIsTaiwuPeople, targetIsTaiwuPeople);
		if (!DomainManager.Character.HasRelation(selfChar.GetId(), targetChar.GetId(), 128))
		{
			DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: true, selfChar.GetId(), targetChar.GetId(), 128);
		}
	}

	public static void ApplyRelationGetAdopted(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte behaviorType = selfChar.GetBehaviorType();
		bool selfIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(selfChar.GetId());
		bool targetIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(targetChar.GetId());
		GameData.Domains.Character.Character.ApplyAddRelation_AdoptiveParent(mainThreadDataContext, selfChar, targetChar, behaviorType, selfIsTaiwuPeople, targetIsTaiwuPeople);
		if (DomainManager.Character.HasRelation(selfChar.GetId(), targetChar.GetId(), 64))
		{
			DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: false, selfChar.GetId(), targetChar.GetId(), 64);
			if (selfChar.GetId() == DomainManager.Taiwu.GetTaiwuCharId())
			{
				AddLegacyPoint(7);
			}
		}
	}

	public static void ApplyRelationSeverAdoptiveParent(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte behaviorType = selfChar.GetBehaviorType();
		bool selfIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(selfChar.GetId());
		bool targetIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(targetChar.GetId());
		GameData.Domains.Character.Character.ApplyEndRelation_AdoptiveParent(mainThreadDataContext, selfChar, targetChar, behaviorType, selfIsTaiwuPeople, targetIsTaiwuPeople);
		if (!DomainManager.Character.HasRelation(selfChar.GetId(), targetChar.GetId(), 64))
		{
			DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: true, selfChar.GetId(), targetChar.GetId(), 64);
		}
	}

	public static void ApplyRelationBecomeMentor(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte behaviorType = selfChar.GetBehaviorType();
		bool selfIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(selfChar.GetId());
		bool targetIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(targetChar.GetId());
		GameData.Domains.Character.Character.ApplyAddRelation_Mentor(mainThreadDataContext, selfChar, targetChar, behaviorType, selfIsTaiwuPeople, targetIsTaiwuPeople);
		if (DomainManager.Character.HasRelation(selfChar.GetId(), targetChar.GetId(), 2048))
		{
			DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: false, selfChar.GetId(), targetChar.GetId(), 2048);
		}
	}

	public static void ApplyRelationSeverMentor(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte behaviorType = selfChar.GetBehaviorType();
		bool selfIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(selfChar.GetId());
		bool targetIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(targetChar.GetId());
		GameData.Domains.Character.Character.ApplyEndRelation_Mentor(mainThreadDataContext, selfChar, targetChar, behaviorType, selfIsTaiwuPeople, targetIsTaiwuPeople);
		if (!DomainManager.Character.HasRelation(selfChar.GetId(), targetChar.GetId(), 2048))
		{
			DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: true, selfChar.GetId(), targetChar.GetId(), 2048);
		}
	}

	public static void ClearHatredTowardTaiwu()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int id = taiwu.GetId();
		CharacterSet reversedRelatedCharIds = DomainManager.Character.GetReversedRelatedCharIds(id, 32768);
		if (reversedRelatedCharIds.GetCount() == 0)
		{
			return;
		}
		HashSet<int> collection = reversedRelatedCharIds.GetCollection();
		foreach (int item in collection)
		{
			DomainManager.Character.ChangeRelationType(mainThreadDataContext, item, id, 32768, 0);
			DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: true, item, id, 32768);
		}
		reversedRelatedCharIds.Clear();
	}

	public static void AddRelation(int charId, int relatedCharId, ushort relationType)
	{
		if (RelationType.ContainBloodRelatedRelations(relationType))
		{
			throw new Exception($"Unable to add blood related relations {relationType} in event.");
		}
		DomainManager.Character.AddRelation(Domain.MainThreadDataContext, charId, relatedCharId, relationType);
		DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: false, charId, relatedCharId, relationType);
		if (relationType == 16384)
		{
			AddLegacyPoint(2);
		}
	}

	public static void AddAdoptiveParent(int charId, int relatedCharId)
	{
		DomainManager.Character.AddAdoptiveParentRelations(Domain.MainThreadDataContext, charId, relatedCharId);
		DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: false, charId, relatedCharId, 64);
	}

	public static void AddHusbandOrWifeRelations(int charId, int relatedCharId)
	{
		DomainManager.Character.AddHusbandOrWifeRelations(Domain.MainThreadDataContext, charId, relatedCharId);
		DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: false, charId, relatedCharId, 1024);
	}

	public static void RestoreActualParentRelation(int childId, int parentId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		List<ParentAndChild> nominalBloodParentRelations = DomainManager.Character.GetNominalBloodParentRelations(parentId);
		DomainManager.Character.TryCreateRelation(mainThreadDataContext, childId, parentId);
		RelatedCharacter relation = DomainManager.Character.GetRelation(childId, parentId);
		for (int i = 0; i < nominalBloodParentRelations.Count; i++)
		{
			ParentAndChild parentAndChild = nominalBloodParentRelations[i];
			if (parentAndChild.ChildId == childId)
			{
				if (RelationType.HasRelation(relation.RelationType, 64))
				{
					DomainManager.Character.ChangeRelationType(mainThreadDataContext, childId, parentId, 64, 0);
				}
				if (RelationType.HasRelation(relation.RelationType, 8))
				{
					DomainManager.Character.ChangeRelationType(mainThreadDataContext, childId, parentId, 8, 0);
				}
				if (RelationType.HasRelation(relation.RelationType, 512))
				{
					DomainManager.Character.ChangeRelationType(mainThreadDataContext, childId, parentId, 512, 0);
				}
				if (parentAndChild.ParentId >= 0)
				{
				}
				DomainManager.Character.AddRelation(mainThreadDataContext, childId, parentId, 1);
				break;
			}
		}
	}

	public static void EndRelation(int charId, int relatedCharId, ushort relationType)
	{
		if (RelationType.ContainsNonRemovableRelations(relationType))
		{
			throw new Exception($"Unable to end blood related relation {relationType} in event.");
		}
		DomainManager.Character.ChangeRelationType(Domain.MainThreadDataContext, charId, relatedCharId, relationType, 0);
		DomainManager.TaiwuEvent.RecordCharacterRelationChanged(isRemove: true, charId, relatedCharId, relationType);
	}

	public static HashSet<int> GetRelatedCharacters(int charId, ushort relationType, bool aliveOnly)
	{
		HashSet<int> hashSet = new HashSet<int>();
		HashSet<int> relatedCharIds = DomainManager.Character.GetRelatedCharIds(charId, relationType);
		if (aliveOnly)
		{
			foreach (int item in relatedCharIds)
			{
				if (DomainManager.Character.IsCharacterAlive(item))
				{
					hashSet.Add(item);
				}
			}
		}
		else
		{
			hashSet.UnionWith(relatedCharIds);
		}
		return hashSet;
	}

	public static HashSet<int> GetRelatedToTaiwuCharacters(bool includeTaiwu = true, bool excludeDead = true)
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		RelatedCharacters relatedCharacters = DomainManager.Character.GetRelatedCharacters(taiwuCharId);
		HashSet<int> hashSet = new HashSet<int>();
		if (includeTaiwu)
		{
			hashSet.Add(taiwuCharId);
		}
		if (relatedCharacters.BloodParents.GetCount() > 0)
		{
			hashSet.UnionWith(relatedCharacters.BloodParents.GetCollection());
		}
		if (relatedCharacters.BloodChildren.GetCount() > 0)
		{
			hashSet.UnionWith(relatedCharacters.BloodChildren.GetCollection());
		}
		if (relatedCharacters.BloodBrothersAndSisters.GetCount() > 0)
		{
			hashSet.UnionWith(relatedCharacters.BloodBrothersAndSisters.GetCollection());
		}
		if (relatedCharacters.StepParents.GetCount() > 0)
		{
			hashSet.UnionWith(relatedCharacters.StepParents.GetCollection());
		}
		if (relatedCharacters.StepChildren.GetCount() > 0)
		{
			hashSet.UnionWith(relatedCharacters.StepChildren.GetCollection());
		}
		if (relatedCharacters.StepBrothersAndSisters.GetCount() > 0)
		{
			hashSet.UnionWith(relatedCharacters.StepBrothersAndSisters.GetCollection());
		}
		if (relatedCharacters.AdoptiveParents.GetCount() > 0)
		{
			hashSet.UnionWith(relatedCharacters.AdoptiveParents.GetCollection());
		}
		if (relatedCharacters.AdoptiveChildren.GetCount() > 0)
		{
			hashSet.UnionWith(relatedCharacters.AdoptiveChildren.GetCollection());
		}
		if (relatedCharacters.AdoptiveBrothersAndSisters.GetCount() > 0)
		{
			hashSet.UnionWith(relatedCharacters.AdoptiveBrothersAndSisters.GetCollection());
		}
		if (relatedCharacters.SwornBrothersAndSisters.GetCount() > 0)
		{
			hashSet.UnionWith(relatedCharacters.SwornBrothersAndSisters.GetCollection());
		}
		if (relatedCharacters.HusbandsAndWives.GetCount() > 0)
		{
			hashSet.UnionWith(relatedCharacters.HusbandsAndWives.GetCollection());
		}
		if (relatedCharacters.Mentors.GetCount() > 0)
		{
			hashSet.UnionWith(relatedCharacters.Mentors.GetCollection());
		}
		if (relatedCharacters.Mentees.GetCount() > 0)
		{
			hashSet.UnionWith(relatedCharacters.Mentees.GetCollection());
		}
		if (relatedCharacters.Friends.GetCount() > 0)
		{
			hashSet.UnionWith(relatedCharacters.Friends.GetCollection());
		}
		if (relatedCharacters.Adored.GetCount() > 0)
		{
			hashSet.UnionWith(relatedCharacters.Adored.GetCollection());
		}
		if (relatedCharacters.Enemies.GetCount() > 0)
		{
			hashSet.UnionWith(relatedCharacters.Enemies.GetCollection());
		}
		if (excludeDead)
		{
			hashSet.RemoveWhere((int e) => !DomainManager.Character.IsCharacterAlive(e));
		}
		return hashSet;
	}

	public static void RemoveCharactersOfRelationsFromCore(int mainCharId, List<int> charIdCore, ushort relationFlag)
	{
		if (charIdCore == null || charIdCore.Count <= 0 || mainCharId < 0)
		{
			return;
		}
		for (int num = charIdCore.Count - 1; num >= 0; num--)
		{
			int charId = charIdCore[num];
			if (DomainManager.Character.TryGetRelation(charId, mainCharId, out var relation) && (relation.RelationType & relationFlag) != 0)
			{
				charIdCore.RemoveAt(num);
			}
		}
	}

	public static GameData.Domains.Character.Character GetAliveSpouse(int charId)
	{
		int aliveSpouse = DomainManager.Character.GetAliveSpouse(charId);
		return (aliveSpouse >= 0) ? DomainManager.Character.GetElement_Objects(aliveSpouse) : null;
	}

	public static sbyte GetCharacterSettlementStateSectTemplateId(int charId)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			short settlementId = element.GetOrganizationInfo().SettlementId;
			if (settlementId < 0)
			{
				return -1;
			}
			Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
			sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(settlement.GetLocation().AreaId);
			return MapState.Instance[stateTemplateIdByAreaId].SectID;
		}
		return -1;
	}

	public static sbyte GetStealActionPhase(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, ItemKey itemKey, int amount, bool showCheckAnimation = false)
	{
		sbyte miscResourceType = ItemTemplateHelper.GetMiscResourceType(itemKey.ItemType, itemKey.TemplateId);
		int alertFactor = ((miscResourceType == -1) ? targetChar.GetItemAlertFactor(itemKey, amount) : targetChar.GetResourceAlertFactor(miscResourceType));
		return GetStealActionPhase(selfChar, targetChar, alertFactor, showCheckAnimation);
	}

	public static sbyte GetStealActionPhase(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, sbyte resourceType, int amount)
	{
		int resourceAlertFactor = targetChar.GetResourceAlertFactor(resourceType);
		return GetStealActionPhase(selfChar, targetChar, resourceAlertFactor);
	}

	public static sbyte GetStealActionPhase(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, GameData.Domains.Character.Character prisoner)
	{
		int gradeAlertFactor = targetChar.GetGradeAlertFactor(prisoner.GetInteractionGrade(), 1);
		return GetStealActionPhase(selfChar, targetChar, gradeAlertFactor);
	}

	public static sbyte GetStealActionPhase(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, int alertFactor = 100, bool showCheckAnim = false)
	{
		IRandomSource random = Domain.MainThreadDataContext.Random;
		targetChar = targetChar.GetGuardForCalculation(random);
		return selfChar.GetStealActionPhase(random, targetChar, alertFactor, showCheckAnim);
	}

	public static sbyte GetScamActionPhase(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, ItemKey itemKey, int amount, bool showCheckAnim = false)
	{
		sbyte miscResourceType = ItemTemplateHelper.GetMiscResourceType(itemKey.ItemType, itemKey.TemplateId);
		int alertFactor = ((miscResourceType == -1) ? targetChar.GetItemAlertFactor(itemKey, amount) : targetChar.GetResourceAlertFactor(miscResourceType));
		return GetScamActionPhase(selfChar, targetChar, alertFactor, showCheckAnim);
	}

	public static sbyte GetScamActionPhase(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, sbyte resourceType, int amount, bool showCheckAnim = false)
	{
		int resourceAlertFactor = targetChar.GetResourceAlertFactor(resourceType);
		return GetScamActionPhase(selfChar, targetChar, resourceAlertFactor, showCheckAnim);
	}

	public static sbyte GetScamActionPhase(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, GameData.Domains.Character.Character prisoner)
	{
		int gradeAlertFactor = targetChar.GetGradeAlertFactor(prisoner.GetInteractionGrade(), 1);
		return GetScamActionPhase(selfChar, targetChar, gradeAlertFactor);
	}

	public static sbyte GetScamActionPhase(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, int alertFactor = 100, bool showCheckAnim = false)
	{
		IRandomSource random = Domain.MainThreadDataContext.Random;
		targetChar = targetChar.GetGuardForCalculation(random);
		return selfChar.GetScamActionPhase(random, targetChar, alertFactor, showCheckAnim);
	}

	public static sbyte GetRobActionPhase(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, ItemKey itemKey, int amount, bool showCheckAnim = false)
	{
		sbyte miscResourceType = ItemTemplateHelper.GetMiscResourceType(itemKey.ItemType, itemKey.TemplateId);
		int alertFactor = ((miscResourceType == -1) ? targetChar.GetItemAlertFactor(itemKey, amount) : targetChar.GetResourceAlertFactor(miscResourceType));
		return GetRobActionPhase(selfChar, targetChar, alertFactor, showCheckAnim);
	}

	public static sbyte GetRobActionPhase(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, sbyte resourceType, int amount)
	{
		int resourceAlertFactor = targetChar.GetResourceAlertFactor(resourceType);
		return GetRobActionPhase(selfChar, targetChar, resourceAlertFactor);
	}

	public static sbyte GetRobActionPhase(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, GameData.Domains.Character.Character prisoner)
	{
		int gradeAlertFactor = targetChar.GetGradeAlertFactor(prisoner.GetInteractionGrade(), 1);
		return GetRobActionPhase(selfChar, targetChar, gradeAlertFactor);
	}

	public static sbyte GetRobActionPhase(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, int alertFactor = 100, bool showCheckAnim = false)
	{
		IRandomSource random = Domain.MainThreadDataContext.Random;
		targetChar = targetChar.GetGuardForCalculation(random);
		return selfChar.GetRobActionPhase(random, targetChar, alertFactor, showCheckAnim);
	}

	public static sbyte GetPoisonActionPhase(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, int alertFactor = 100, bool showCheckAnim = false)
	{
		IRandomSource random = Domain.MainThreadDataContext.Random;
		targetChar = targetChar.GetGuardForCalculation(random);
		return selfChar.GetPoisonActionPhase(random, targetChar, alertFactor, showCheckAnim);
	}

	public static sbyte GetPlotHarmActionPhase(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, int alertFactor = 100, bool showCheckAnim = false)
	{
		IRandomSource random = Domain.MainThreadDataContext.Random;
		targetChar = targetChar.GetGuardForCalculation(random);
		return selfChar.GetPlotHarmActionPhase(random, targetChar, alertFactor, showCheckAnim);
	}

	public static sbyte GetStealCombatSkillActionPhase(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, short combatSkillTemplateId, bool showCheckAnim = false)
	{
		IRandomSource random = Domain.MainThreadDataContext.Random;
		sbyte type = Config.CombatSkill.Instance[combatSkillTemplateId].Type;
		sbyte grade = Config.CombatSkill.Instance[combatSkillTemplateId].Grade;
		targetChar = targetChar.GetGuardForCalculation(random);
		return selfChar.GetStealCombatSkillActionPhase(random, targetChar, type, grade, showCheckAnim);
	}

	public static sbyte GetStealLifeSkillActionPhase(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, short lifeSkillTemplateId, bool showCheckAnim = false)
	{
		IRandomSource random = Domain.MainThreadDataContext.Random;
		sbyte type = LifeSkill.Instance[lifeSkillTemplateId].Type;
		sbyte grade = LifeSkill.Instance[lifeSkillTemplateId].Grade;
		targetChar = targetChar.GetGuardForCalculation(random);
		return selfChar.GetStealLifeSkillActionPhase(random, targetChar, type, grade, showCheckAnim);
	}

	public static void HandlePoisonAction(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, ItemKey itemKey, sbyte actionPhase)
	{
		DomainManager.Character.HandlePoisonAction(Domain.MainThreadDataContext, selfChar, targetChar, itemKey, actionPhase);
	}

	public static void HandlePlotHarmAction(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, ItemKey itemKey, sbyte actionPhase)
	{
		DomainManager.Character.HandlePlotHarmAction(Domain.MainThreadDataContext, selfChar, targetChar, itemKey, actionPhase);
	}

	public static void AddNpcTravelTarget(int selfCharId, int targetCharId, int maxDuration = 3)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(selfCharId);
		element_Objects.AddTravelTarget(Domain.MainThreadDataContext, new NpcTravelTarget(targetCharId, maxDuration));
	}

	public static void AddNpcTravelTarget(int selfCharId, Location targetLocation, int maxDuration = 3)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(selfCharId);
		element_Objects.AddTravelTarget(Domain.MainThreadDataContext, new NpcTravelTarget(targetLocation, maxDuration));
	}

	public static void AddNeedForRevenge(int selfCharId, int targetCharId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(selfCharId);
		GameData.Domains.Character.Ai.PersonalNeed personalNeed = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(21, targetCharId);
		element_Objects.AddPersonalNeed(Domain.MainThreadDataContext, personalNeed);
	}

	public static void RemovePersonalNeed(int charId, sbyte templateId, sbyte type)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		GameData.Domains.Character.Ai.PersonalNeed personalNeed = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(templateId, type);
		element_Objects.RemovePersonalNeed(Domain.MainThreadDataContext, personalNeed);
	}

	public static void RemovePersonalNeed(int charId, sbyte templateId, ushort relationType)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		GameData.Domains.Character.Ai.PersonalNeed personalNeed = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(templateId, relationType);
		element_Objects.RemovePersonalNeed(Domain.MainThreadDataContext, personalNeed);
	}

	public static int SelectRandomBlockTarget(Location location, Predicate<GameData.Domains.Character.Character> predicate = null, bool includeBaby = false)
	{
		if (!location.IsValid())
		{
			return -1;
		}
		MapBlockData block = DomainManager.Map.GetBlock(location);
		if (block.CharacterSet == null || block.CharacterSet.Count == 0)
		{
			return -1;
		}
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		list.Clear();
		foreach (int item in block.CharacterSet)
		{
			if (DomainManager.Character.TryGetElement_Objects(item, out var element) && (includeBaby || element.GetAgeGroup() != 0) && (predicate == null || predicate(element)))
			{
				list.Add(item);
			}
		}
		if (list.Count == 0)
		{
			return -1;
		}
		IRandomSource random = Domain.MainThreadDataContext.Random;
		int random2 = list.GetRandom(random);
		ObjectPool<List<int>>.Instance.Return(list);
		return random2;
	}

	public static AiHelper.NpcCombatResultType SimulateNpcCombat(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character targetChar, CombatType combatType, int killBaseChance, int kidnapBaseChance, int releaseBaseChance)
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		Tester.Assert(selfChar.GetId() != taiwuCharId);
		Tester.Assert(targetChar.GetId() != taiwuCharId);
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		AiHelper.NpcCombatResultType npcCombatResultType = DomainManager.Character.SimulateCharacterCombat(mainThreadDataContext, selfChar, targetChar, CombatType.Die);
		if ((uint)npcCombatResultType <= 1u)
		{
			DomainManager.Character.SimulateCharacterCombatResult(mainThreadDataContext, selfChar, targetChar, killBaseChance, kidnapBaseChance, releaseBaseChance);
		}
		else
		{
			DomainManager.Character.SimulateCharacterCombatResult(mainThreadDataContext, targetChar, selfChar, killBaseChance, kidnapBaseChance, releaseBaseChance);
		}
		return npcCombatResultType;
	}

	public static void SimulateNpcCombatOthers(GameData.Domains.Character.Character selfChar)
	{
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		Location location = selfChar.GetLocation();
		Predicate<GameData.Domains.Character.Character> predicate = (GameData.Domains.Character.Character character) => character.GetAgeGroup() != 1 && character.GetId() != DomainManager.Taiwu.GetTaiwuCharId() && character.GetId() != selfChar.GetId();
		int num = -1;
		num = SelectRandomBlockTarget(location, predicate);
		if (-1 == num)
		{
			for (int num2 = 3; num2 < 30; num2 += 2)
			{
				DomainManager.Map.GetNeighborBlocks(location.AreaId, location.BlockId, list, num2);
				for (int num3 = 0; num3 < list.Count; num3++)
				{
					Location location2 = new Location(list[num3].AreaId, list[num3].BlockId);
					num = SelectRandomBlockTarget(location2, predicate);
					if (num != -1)
					{
						break;
					}
				}
				if (num != -1)
				{
					break;
				}
			}
		}
		if (num != -1 && DomainManager.Character.TryGetElement_Objects(num, out var element))
		{
			selfChar.SetLocation(element.GetLocation(), Domain.MainThreadDataContext);
			SimulateNpcCombat(selfChar, element, CombatType.Die, 60, 60, 60);
		}
		ObjectPool<List<MapBlockData>>.Instance.Return(list);
	}

	public static void AddCharacterAiActionRateAdjust(int charId, sbyte aiActionType, sbyte actionSubType, short rateAdjust, int duration)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Tester.Assert(DomainManager.Character.IsCharacterAlive(charId));
		DomainManager.Extra.AddAiActionRateAdjust(mainThreadDataContext, charId, aiActionType, actionSubType, rateAdjust, duration);
	}

	public static void ForbidCharacterAiAction(int charId, sbyte aiActionType, sbyte actionSubType, int duration)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Tester.Assert(DomainManager.Character.IsCharacterAlive(charId));
		DomainManager.Extra.AddAiActionRateAdjust(mainThreadDataContext, charId, aiActionType, actionSubType, short.MinValue, duration);
	}

	public static string GetCharacterClickedSpecialNextEvent(GameData.Domains.Character.Character character, EventArgBox argBox, bool createRelation)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int id = character.GetId();
		short roleAge = GetRoleAge(character);
		if (createRelation && character.GetCreatingType() == 1)
		{
			DomainManager.Character.TryCreateRelation(Domain.MainThreadDataContext, EventArgBox.TaiwuCharacterId, character.GetId());
		}
		if (DomainManager.Extra.IsSpecialGroupMember(character))
		{
			return "f65f0df8-60e2-476e-b9cc-3298cd3d4d9e";
		}
		if (character.IsCompletelyInfected())
		{
			return "b268b0c6-0704-41e7-bbb4-d4faf244ebfc";
		}
		if (DomainManager.Extra.IsLegendaryBookConsumed(id))
		{
			sbyte consumedCharacterLegendaryBookType = DomainManager.LegendaryBook.GetConsumedCharacterLegendaryBookType(character);
			return LegendaryBookConsumedBookTypeToEvent[consumedCharacterLegendaryBookType];
		}
		if (roleAge < GlobalConfig.Instance.AgeBaby)
		{
			return "0f6a8d46-c065-4d8d-b4cc-2a85be694bd8";
		}
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		if (GlobalArgBoxContainsKey<int>("ForeverLoverId") && GetIntFromGlobalArgBox("ForeverLoverId") == id)
		{
			if (GetCharacterChildGrade(character) < 0)
			{
				return "dc4047f7-f266-4d2f-a2e1-37694c3c3247";
			}
			RemoveFromGlobalArgBox<int>("ForeverLoverId");
		}
		else
		{
			if (CanTriggerHuntFugitiveInteraction(character))
			{
				return "d742c92c-470a-496c-8b4a-eccddcc8baee";
			}
			if (CheckHasRelationship(character, taiwu, 32768))
			{
				return "3fd8291d-6f22-4b24-88ff-e11e9c5dbc6b";
			}
			if (CanTriggerTaiwuWantedInteraction(character.GetId(), argBox))
			{
				return "2dc9389a-1341-4671-bc01-d7881a59e432";
			}
			if (TryGetAppointmentOfCharacter(id, out var settlementId))
			{
				AdaptableLog.Info($"settlementId = {settlementId}");
				Location settlementLocation = GetSettlementLocation(settlementId);
				MapBlockData block = DomainManager.Map.GetBlock(settlementLocation);
				short blockId = block.BlockId;
				if (block.RootBlockId >= 0)
				{
					blockId = block.RootBlockId;
				}
				List<short> list = new List<short>();
				DomainManager.Map.GetSettlementBlocks(settlementLocation.AreaId, blockId, list);
				Location location = taiwu.GetLocation();
				for (int i = 0; i < list.Count; i++)
				{
					if (settlementLocation.AreaId == location.AreaId && list[i] == location.BlockId)
					{
						return "629311a9-de4e-4189-81b3-cc837948c2ce";
					}
				}
			}
			else if (CharacterIsOrganizationLeader(character, 10))
			{
				if (IsCharacterAtTargetSectLocation(character, 10))
				{
					EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(10);
					bool arg = false;
					sectMainStoryEventArgBox.Get("ConchShip_PresetKey_KongsangStoryParyOneTriggered", ref arg);
					if (!arg && GetSectApprovingRate(10) >= 500 && !sectMainStoryEventArgBox.Contains<int>(SectMainStoryEventArgKeys.TriggeringStatus))
					{
						argBox.Set("SectLeader", id);
						CreateAdventureActor(71, "SectGuideKongsang", argBox);
						GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(668);
						DirectlySetFavorabilities(orCreateFixedCharacterByTemplateId.GetId(), taiwu.GetId(), 9999, 9999);
						AddPoisonToLiaoWuming(orCreateFixedCharacterByTemplateId);
						argBox.Set("LiaoWuming", orCreateFixedCharacterByTemplateId.GetId());
						return "cde605ed-0bc1-4b0b-ae72-cb0247d09da2";
					}
					bool arg2 = false;
					if (arg && IsExtraTaskInProgress(105) && sectMainStoryEventArgBox.Get("ConchShip_PresetKey_MissionUnacceptedEventTriggeredSameMonth", ref arg2) && arg2)
					{
						argBox.Set("SectLeader", id);
						SaveArgToSectMainStory(10, "ConchShip_PresetKey_MissionUnacceptedEventTriggeredSameMonth", value: false);
						return "b474ca28-4cd8-46bf-8abb-e808c0d67de7";
					}
				}
			}
			else if (IsExtraTaskInProgress(154))
			{
				if (character.GetOrganizationInfo().OrgTemplateId == 4)
				{
					return "c8c836eb-4fa4-4f4e-bbd2-caed35028969";
				}
			}
			else if (CharacterIsOrganizationLeader(character, 5))
			{
				if (IsExtraTaskInProgress(158))
				{
					return "d33119ef-9896-455d-b8e5-b911830452bc";
				}
				if (IsExtraTaskInProgress(161))
				{
					return "d33119ef-9896-455d-b8e5-b911830452bc";
				}
				if (IsExtraTaskInProgress(166))
				{
					return "fc9306e4-f0fe-4d93-aede-e6919e1e9ead";
				}
			}
		}
		if (GetIsDreamBack() && !IsDejaVuEventCharacter(id) && (IsPastRelationship(id) || IsPastTaiwu(id)))
		{
			AddDejaVuEventCharacter(id);
			return "7abe76fd-ad0c-4d7e-ad04-6d2c75f89367";
		}
		if (GetIsDreamBack() && !IsDejaVuEventCharacter(id) && TryGetDreamBackLifeRecordByRelatedCharId(id, out var _))
		{
			AddDejaVuEventCharacter(id);
			return "bfa202f2-0d5e-4ed4-a709-5f200eee3bb0";
		}
		if (DomainManager.Extra.IsExtraTaskInProgress(338))
		{
			short settlementId2 = character.GetOrganizationInfo().SettlementId;
			if (settlementId2 >= 0 && character.GetOrganizationInfo().Grade == 8)
			{
				EventArgBox sectMainStoryEventArgBox2 = DomainManager.Extra.GetSectMainStoryEventArgBox(14);
				GameData.Utilities.ShortList shortList = sectMainStoryEventArgBox2.Get<GameData.Utilities.ShortList>("ConchShip_PresetKey_FulongLoseChickenFeatherInteractionSettlements");
				if (shortList.Items == null || !shortList.Items.Contains(settlementId2))
				{
					Settlement settlement = DomainManager.Organization.GetSettlement(settlementId2);
					Location location2 = settlement.GetLocation();
					List<int> locationChicken = DomainManager.Building.GetLocationChicken(location2);
					List<int> sectFulongLoseFeatherChickens = DomainManager.Extra.GetSectFulongLoseFeatherChickens();
					for (int j = 0; j < locationChicken.Count; j++)
					{
						if (sectFulongLoseFeatherChickens.Contains(locationChicken[j]))
						{
							return "eb4f0e4d-8fed-474b-960a-df783a915a5b";
						}
					}
				}
			}
		}
		return string.Empty;
	}

	public static bool IsSpecialGroupMember(GameData.Domains.Character.Character character)
	{
		return DomainManager.Extra.IsSpecialGroupMember(character);
	}

	public static void GearMateJoinGroup(int charId)
	{
		DomainManager.Extra.GearMateJoinGroup(Domain.MainThreadDataContext, charId);
	}

	public static void GearMateLeaveGroup(int charId)
	{
		DomainManager.Extra.GearMateLeaveGroup(Domain.MainThreadDataContext, charId);
	}

	public static void TryInterruptCharacterPrioritizedAction(int charId, short templateId)
	{
		if (DomainManager.Character.TryGetCharacterPrioritizedAction(charId, out var action) && action.ActionType == templateId && DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			action.OnInterrupt(Domain.MainThreadDataContext, element);
			DomainManager.Character.RemoveCharacterPrioritizedAction(Domain.MainThreadDataContext, charId);
			element.ResetPrioritizedActionCooldown(Domain.MainThreadDataContext, templateId, isFailToCreate: false);
		}
	}

	public static void StartEnemyInteractionEscapeCheck()
	{
		DomainManager.TaiwuEvent.ShowInteractCheckAnimation = true;
		DomainManager.TaiwuEvent.InteractCheckData.IsEscape = true;
	}

	public static string ExecuteScamAction_Item(EventArgBox argBox)
	{
		argBox.Get<ItemKey>("GetItemKey", out ItemKey arg);
		int arg2 = 0;
		if (!argBox.Get("GetItemKeyCount", ref arg2))
		{
			arg2 = 1;
		}
		if (ItemTemplateHelper.IsMiscResource(arg.ItemType, arg.TemplateId))
		{
			sbyte miscResourceType = ItemTemplateHelper.GetMiscResourceType(arg.ItemType, arg.TemplateId);
			argBox.Set("GetResType", miscResourceType);
			argBox.Set("InputResult", arg2);
			if (miscResourceType != -1)
			{
				return ExecuteScamAction_ItemResource(argBox);
			}
			return string.Empty;
		}
		AdvanceDays(5);
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		ChangeRoleMainAttribute(character, 2, -20);
		int arg3 = -1;
		argBox.Get("CharacterId", ref arg3);
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		sbyte scamActionPhase = GetScamActionPhase(character, character2, arg, arg2, showCheckAnim: true);
		argBox.Set("ActionThenState", scamActionPhase);
		if (scamActionPhase == 0)
		{
			return "84cc0e2c-7fe1-43cf-becf-f19d9681a92f";
		}
		if (scamActionPhase == 1)
		{
			return "e5459805-135e-4c3d-b7a7-677cc2668df3";
		}
		if (scamActionPhase == 2)
		{
			return "66f62a92-372a-43e4-ad3f-6e66cb13f2f2";
		}
		if (scamActionPhase >= 3)
		{
			return "7e580097-a8a6-4807-986f-d6a49391b8dd";
		}
		return string.Empty;
	}

	public static string ExecuteScamAction_ItemResource(EventArgBox argBox)
	{
		AdvanceDays(5);
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		ChangeRoleMainAttribute(character, 2, -20);
		int arg = -1;
		argBox.Get("CharacterId", ref arg);
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		sbyte arg2 = -1;
		argBox.Get("GetResType", ref arg2);
		int arg3 = 0;
		argBox.Get("InputResult", ref arg3);
		sbyte scamActionPhase = GetScamActionPhase(character, character2, arg2, arg3, showCheckAnim: true);
		argBox.Set("ActionThenState", scamActionPhase);
		if (scamActionPhase == 0)
		{
			return "e8324e2b-39d1-44c1-9461-cdd58612bc14";
		}
		if (scamActionPhase == 1)
		{
			return "b6ed0819-9baf-45b3-a464-b88d80d3505c";
		}
		if (scamActionPhase == 2)
		{
			return "f47397bf-9e91-46f4-ac0e-226ac1c288d7";
		}
		if (scamActionPhase >= 3)
		{
			return "86222c08-a464-4408-a3f3-fb736fa58f8e";
		}
		return string.Empty;
	}

	public static string ExecuteScamAction_NormalInformation(EventArgBox argBox)
	{
		AdvanceDays(5);
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		ChangeRoleMainAttribute(character, 2, -20);
		int arg = -1;
		argBox.Get("CharacterId", ref arg);
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		IEnumerable<NormalInformation> exceptedCharacterNormalInformation = GetExceptedCharacterNormalInformation(EventArgBox.TaiwuCharacterId, arg);
		if (!exceptedCharacterNormalInformation.Any())
		{
			return "081fe73b-e498-432c-a4f5-d94fb13ce478";
		}
		sbyte scamActionPhase = GetScamActionPhase(character, character2, 100, showCheckAnim: true);
		argBox.Set("ActionThenState", scamActionPhase);
		if (scamActionPhase == 0)
		{
			return "57d71fe2-d264-4eaa-a89e-1b833f9ae8b8";
		}
		if (scamActionPhase == 1)
		{
			return "3515a7f6-32d7-472c-b399-8c6c5c5bf9c3";
		}
		if (scamActionPhase == 2)
		{
			return "7ecef08c-89ac-4d76-8ac4-34e6b625bd2b";
		}
		if (scamActionPhase >= 3)
		{
			return "2c8ff1e0-3d05-43b1-8f62-b2feaa848f13";
		}
		return string.Empty;
	}

	public static string ExecuteScamAction_SecretInformation(EventArgBox argBox)
	{
		AdvanceDays(5);
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		ChangeRoleMainAttribute(character, 2, -20);
		int arg = -1;
		argBox.Get("CharacterId", ref arg);
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		List<int> secretInformationOfCharacter = GetSecretInformationOfCharacter(arg, includeBroadcast: false);
		bool flag = false;
		if (secretInformationOfCharacter != null && secretInformationOfCharacter.Count > 0)
		{
			ICollection<int> secretInformationKnownDiff = GetSecretInformationKnownDiff(arg, EventArgBox.TaiwuCharacterId);
			if (secretInformationKnownDiff != null && secretInformationKnownDiff.Count > 0)
			{
				flag = true;
			}
		}
		if (!flag)
		{
			return "2d12dfba-0dfb-4b64-affc-2c2e55d27954";
		}
		sbyte scamActionPhase = GetScamActionPhase(character, character2, 100, showCheckAnim: true);
		argBox.Set("ActionThenState", scamActionPhase);
		if (scamActionPhase == 0)
		{
			return "aa204ed4-52f2-43c3-bebe-dd0d6de0d5e2";
		}
		if (scamActionPhase == 1)
		{
			return "1b40413d-c806-401e-883e-9508a4952701";
		}
		if (scamActionPhase == 2)
		{
			return "c070f96b-099a-40f8-9f9e-6d2e447906c0";
		}
		if (scamActionPhase >= 3)
		{
			return "9c143b43-9c19-47dd-a1f8-8fcc911addf8";
		}
		return string.Empty;
	}

	public static string ExecuteScamAction_LifeSkill(EventArgBox argBox)
	{
		int arg = -1;
		argBox.Get("CharacterId", ref arg);
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		ChangeRoleMainAttribute(character, 2, -20);
		sbyte b = (sbyte)(GetXiangshuLevel() + 1);
		if (b < 0)
		{
			return "cead9ba5-d26d-4c83-8ca5-0101c31d72ad";
		}
		List<short> charLifeSkillList = GetCharLifeSkillList(arg, -1, 0, b, 3, requireTaiwuNotLearn: true);
		if (charLifeSkillList.Count <= 0)
		{
			return "cead9ba5-d26d-4c83-8ca5-0101c31d72ad";
		}
		List<short> minGradeLifeSkillList = GetMinGradeLifeSkillList(charLifeSkillList);
		int random = GetRandom(0, minGradeLifeSkillList.Count);
		argBox.Set("SkillCanLearn", charLifeSkillList[random]);
		sbyte scamActionPhase = GetScamActionPhase(character, character2, 100, showCheckAnim: true);
		argBox.Set("ThenState", scamActionPhase);
		return scamActionPhase switch
		{
			0 => "c8925ce9-a92e-4352-9e3d-3bbf796bfd29", 
			1 => "d69c33c4-c436-4ffa-9606-63e84fa3a3b2", 
			2 => "b867e9ce-4515-4397-ad71-3e19f2994d46", 
			_ => "9cf3c423-085e-48e7-9330-6b2e58c1e011", 
		};
	}

	public static string ExecuteScamAction_CombatSkill(EventArgBox argBox)
	{
		int arg = -1;
		argBox.Get("CharacterId", ref arg);
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		ChangeRoleMainAttribute(character, 2, -20);
		sbyte b = (sbyte)(GetXiangshuLevel() + 1);
		if (b < 0)
		{
			return "74a98aab-8afb-4a7d-b205-840408a2098c";
		}
		List<short> charCombatSkillList = GetCharCombatSkillList(arg, -1, -1, 0, b, needBreak: false, requireTaiwuNotLearnAndRead: true);
		if (charCombatSkillList.Count <= 0)
		{
			return "74a98aab-8afb-4a7d-b205-840408a2098c";
		}
		List<short> minGradeCombatSkillList = GetMinGradeCombatSkillList(charCombatSkillList);
		int random = GetRandom(0, minGradeCombatSkillList.Count);
		argBox.Set("TeachCombat", minGradeCombatSkillList[random]);
		sbyte scamActionPhase = GetScamActionPhase(character, character2, 100, showCheckAnim: true);
		argBox.Set("ThenState", scamActionPhase);
		return scamActionPhase switch
		{
			0 => "54f7b9d8-2d97-4807-863d-dd52d6ba4b9e", 
			1 => "ec834371-5f74-4f50-bd15-1aee198e1240", 
			2 => "90b660fb-6354-4cfa-aec9-09a5bff0b522", 
			_ => "e3306c1f-0d4d-408b-afdc-dcbb67c8459d", 
		};
	}

	public static string ExecuteStealAction_Item(EventArgBox argBox)
	{
		argBox.Get<ItemKey>("GetItemKey", out ItemKey arg);
		int arg2 = 0;
		if (!argBox.Get("GetItemKeyCount", ref arg2))
		{
			arg2 = 1;
		}
		bool flag = ItemTemplateHelper.IsMiscResource(arg.ItemType, arg.TemplateId);
		AdvanceDays(5);
		if (flag)
		{
			sbyte miscResourceType = ItemTemplateHelper.GetMiscResourceType(arg.ItemType, arg.TemplateId);
			argBox.Set("GetResType", miscResourceType);
			argBox.Set("InputResult", arg2);
			if (miscResourceType != -1)
			{
				return ExecuteStealAction_ItemResource(argBox);
			}
			return string.Empty;
		}
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		ChangeRoleMainAttribute(character, 1, -20);
		argBox.Set("ConchShip_PresetKey_ConfirmWaitOptionSignal", "SteelItem");
		int arg3 = -1;
		argBox.Get("CharacterId", ref arg3);
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		sbyte stealActionPhase = GetStealActionPhase(character, character2, arg, arg2, showCheckAnimation: true);
		argBox.Set("ActionThenState", stealActionPhase);
		return stealActionPhase switch
		{
			0 => "e9c9b536-0e1c-45b3-b870-1a45f83f7cd5", 
			1 => "db843c3a-a090-4aae-903d-6025fc8d51e8", 
			2 => "9331fbd0-d888-4772-b9d5-3e871390fed7", 
			3 => "36b3a30c-17dc-4e39-bba6-d36a86a36526", 
			_ => "d3806f6b-5445-4e86-86a8-cf9686646320", 
		};
	}

	public static string ExecuteStealAction_ItemResource(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		ChangeRoleMainAttribute(character, 1, -20);
		argBox.Set("ConchShip_PresetKey_ConfirmWaitOptionSignal", "SteelResource");
		int arg = -1;
		argBox.Get("CharacterId", ref arg);
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		sbyte stealActionPhase = GetStealActionPhase(character, character2, 100, showCheckAnim: true);
		argBox.Set("ActionThenState", stealActionPhase);
		return stealActionPhase switch
		{
			0 => "88160cf5-7c56-42c6-bf8a-c5cc4d95b1be", 
			1 => "763bc615-e708-4746-8324-aec76e0f5546", 
			2 => "be24ac56-d7e8-4ba9-85fa-f0235b4d5097", 
			3 => "f213fb6c-3cb9-4432-8bde-46da6bb0f633", 
			_ => "69418696-d98e-424c-b12d-deb179b25344", 
		};
	}

	public static string ExecuteRobAction_Item(EventArgBox argBox)
	{
		argBox.Get<ItemKey>("GetItemKey", out ItemKey arg);
		int arg2 = 0;
		if (!argBox.Get("GetItemKeyCount", ref arg2))
		{
			arg2 = 1;
		}
		if (ItemTemplateHelper.IsMiscResource(arg.ItemType, arg.TemplateId))
		{
			sbyte miscResourceType = ItemTemplateHelper.GetMiscResourceType(arg.ItemType, arg.TemplateId);
			argBox.Set("GetResType", miscResourceType);
			argBox.Set("InputResult", arg2);
			if (miscResourceType != -1)
			{
				return ExecuteRobAction_ItemResource(argBox);
			}
			return string.Empty;
		}
		AdvanceDays(5);
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		ChangeRoleMainAttribute(character, 0, -20);
		argBox.Set("ConchShip_PresetKey_ConfirmWaitOptionSignal", "RobItem");
		int arg3 = -1;
		argBox.Get("CharacterId", ref arg3);
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		sbyte robActionPhase = GetRobActionPhase(character, character2, arg, arg2, showCheckAnim: true);
		argBox.Set("ActionThenState", robActionPhase);
		return robActionPhase switch
		{
			0 => "350e2536-df08-484b-9a69-75a1e30803e7", 
			1 => "9acc1344-cb7c-4cc2-8643-9a63a9c13903", 
			2 => "87814d6f-6953-4e03-bc6f-60ad975e1783", 
			3 => "893cef33-efac-4c23-aae8-9af20d19b7cf", 
			_ => "0cb877f7-0b08-4e47-9e18-e774a3f981a1", 
		};
	}

	public static string ExecuteRobAction_ItemResource(EventArgBox argBox)
	{
		AdvanceDays(5);
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		ChangeRoleMainAttribute(character, 0, -20);
		argBox.Set("ConchShip_PresetKey_ConfirmWaitOptionSignal", "RobResource");
		int arg = -1;
		argBox.Get("CharacterId", ref arg);
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		sbyte robActionPhase = GetRobActionPhase(character, character2, 100, showCheckAnim: true);
		argBox.Set("ActionThenState", robActionPhase);
		return robActionPhase switch
		{
			0 => "90f19f43-2454-46da-b8b8-dccd052d067d", 
			1 => "a90c339c-e10d-4b67-9c61-a60a86603117", 
			2 => "425ef556-2dd9-4585-acf7-6cd39fd5743c", 
			3 => "1b04b65a-7751-4df9-b9a2-e97175ac87c2", 
			_ => "88b05e12-7e7a-46c8-9c9e-fe5224586cde", 
		};
	}

	public static string ExecutePoisonAction(EventArgBox argBox)
	{
		AdvanceDays(3);
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		ChangeRoleMainAttribute(character, 4, -20);
		argBox.Set("ConchShip_PresetKey_ConfirmWaitOptionSignal", "UsePoison");
		int arg = -1;
		argBox.Get("CharacterId", ref arg);
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		sbyte poisonActionPhase = GetPoisonActionPhase(character, character2, 100, showCheckAnim: true);
		argBox.Set("ActionThenState", poisonActionPhase);
		if (poisonActionPhase < 4)
		{
			HandlePoisonAction(argBox.GetCharacter("RoleTaiwu"), argBox.GetCharacter("CharacterId"), argBox.Get<ItemKey>("GiftKey", out ItemKey arg2) ? arg2 : ItemKey.Invalid, poisonActionPhase);
		}
		switch (poisonActionPhase)
		{
		case 0:
			return "b42e0309-4791-47fb-a569-9b68292bce74";
		case 1:
			return "2a338104-5aa4-4640-94d4-5b671cf015c2";
		case 2:
			return "c3cc6fe7-b9cb-4a13-acf9-90a06cbc47fe";
		case 3:
			return "ed802fcb-73a7-4fe8-a7c1-9bec9be09d45";
		default:
		{
			if (argBox.Get<ItemKey>("GiftKey", out ItemKey _))
			{
				return "c9dc4592-afe6-4402-9592-a5b8bb99b840";
			}
			return "619d2917-6f3b-4a42-b37c-7903225b968e";
		}
		}
	}

	public static string ExecutePlotHarmAction(EventArgBox argBox)
	{
		AdvanceDays(5);
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		ChangeRoleMainAttribute(character, 4, -20);
		argBox.Set("ConchShip_PresetKey_ConfirmWaitOptionSignal", "UseMedicine");
		int arg = -1;
		argBox.Get("CharacterId", ref arg);
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		sbyte plotHarmActionPhase = GetPlotHarmActionPhase(character, character2, 100, showCheckAnim: true);
		argBox.Set("ActionThenState", plotHarmActionPhase);
		if (plotHarmActionPhase < 4)
		{
			HandlePlotHarmAction(argBox.GetCharacter("RoleTaiwu"), argBox.GetCharacter("CharacterId"), argBox.Get<ItemKey>("GiftKey", out ItemKey arg2) ? arg2 : ItemKey.Invalid, plotHarmActionPhase);
		}
		switch (plotHarmActionPhase)
		{
		case 0:
			return "6d95cbd1-3fb3-4d8a-9f5c-10705d5059e3";
		case 1:
			return "b05de8bf-b755-48cf-97f9-568fa385ce73";
		case 2:
			return "01841986-a003-4bad-b465-f753f9c31a4f";
		case 3:
			return "f5db0121-1039-4ff9-8a6a-b217a3c5fd37";
		default:
		{
			if (argBox.Get<ItemKey>("GiftKey", out ItemKey _))
			{
				return "e3f3995f-82aa-4dd9-b73f-5242ba268a20";
			}
			return "b68d2a56-34eb-4194-a065-06955ccd100a";
		}
		}
	}

	public static string ExecuteConfessionLove(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		if (CheckConfessLoveSucceed(character.GetId(), character2.GetId()))
		{
			if (IsDlcInstalled(2305890u))
			{
				GameData.Domains.TaiwuEvent.InteractOfLoveEventHelper.InteractOfLoveEventHelper.SetConfessionLoveResult(character2.GetId(), 2);
				GameData.Domains.TaiwuEvent.InteractOfLoveEventHelper.InteractOfLoveEventHelper.AddStartRelationSuccessRate(character.GetId(), character2.GetId(), 10, RelationType.GetTypeId(16384), 0, 1);
			}
			if (!CheckHasRelationship(character2, character, 16384))
			{
				ApplyRelationBecomeBoyOrGirlFriend(character, character2, succeed: true);
			}
			AddRelation(character.GetId(), character2.GetId(), 16384);
			if (GetRoleBehavior(character2) == 0)
			{
				if (IsDlcInstalled(2305890u))
				{
					return "a51ee3fc-bcbb-4f25-b3f4-dd9c3b9a05fa";
				}
				return "2b3a082e-d12b-492a-9539-634aa80bbca7";
			}
			if (GetRoleBehavior(character2) == 1)
			{
				if (IsDlcInstalled(2305890u))
				{
					return "3df07665-f907-45e5-99cd-1c67cdc87186";
				}
				return "8b83baba-3429-41c8-baee-832e8af04349";
			}
			if (GetRoleBehavior(character2) == 2)
			{
				if (IsDlcInstalled(2305890u))
				{
					return "255a434c-5c9a-4f65-bd1b-6e9db5143186";
				}
				return "ace4423d-fc88-4a9a-8b3a-c715b3f1e29f";
			}
			if (GetRoleBehavior(character2) == 3)
			{
				if (IsDlcInstalled(2305890u))
				{
					return "8ecdbe26-a61e-49ab-80e9-248a899f709b";
				}
				return "97afbfce-3251-465e-a566-9bad8ddffa46";
			}
			if (GetRoleBehavior(character2) == 4)
			{
				if (IsDlcInstalled(2305890u))
				{
					return "f375d1a2-2450-4794-b58f-6939569b179f";
				}
				return "4e13a531-ff44-4b63-b996-df654f81b9dd";
			}
		}
		else
		{
			if (IsDlcInstalled(2305890u))
			{
				GameData.Domains.TaiwuEvent.InteractOfLoveEventHelper.InteractOfLoveEventHelper.SetConfessionLoveResult(character2.GetId(), 1);
			}
			ApplyRelationBecomeBoyOrGirlFriend(character, character2, succeed: false);
			AddRelation(character.GetId(), character2.GetId(), 16384);
			if (GetRoleBehavior(character2) == 0)
			{
				return "dab05150-6700-4b1f-8454-818901a79dd8";
			}
			if (GetRoleBehavior(character2) == 1)
			{
				return "a7c4ac21-8924-4d9b-a69c-95673082220e";
			}
			if (GetRoleBehavior(character2) == 2)
			{
				return "d521f555-ea0a-40c6-8327-1a24aaccaa26";
			}
			if (GetRoleBehavior(character2) == 3)
			{
				return "8c2a24f4-333c-4f14-a12f-703cc3586e47";
			}
			if (GetRoleBehavior(character2) == 4)
			{
				return "1ee6cc38-a32c-4c1f-9fb4-3f62b593fd4f";
			}
		}
		return string.Empty;
	}

	public static string ExecuteStealLifeSkill(EventArgBox argBox)
	{
		int arg = -1;
		argBox.Get("CharacterId", ref arg);
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		ChangeRoleMainAttribute(character, 5, -20);
		sbyte b = (sbyte)(GetXiangshuLevel() + 1);
		if (b < 0)
		{
			return "9758c896-0972-41d6-9a9c-7c1ff3a88d3b";
		}
		List<short> charLifeSkillList = GetCharLifeSkillList(arg, -1, 0, b, 3, requireTaiwuNotLearn: true);
		if (charLifeSkillList.Count <= 0)
		{
			return "9758c896-0972-41d6-9a9c-7c1ff3a88d3b";
		}
		List<short> minGradeLifeSkillList = GetMinGradeLifeSkillList(charLifeSkillList);
		int random = GetRandom(0, minGradeLifeSkillList.Count);
		argBox.Set("SkillCanLearn", charLifeSkillList[random]);
		sbyte stealLifeSkillActionPhase = GetStealLifeSkillActionPhase(character, character2, charLifeSkillList[0], showCheckAnim: true);
		argBox.Set("ThenState", stealLifeSkillActionPhase);
		return stealLifeSkillActionPhase switch
		{
			0 => "8de6c99c-bf5b-4557-a7a3-148a4ae85f33", 
			1 => "d69c33c4-c436-4ffa-9606-63e84fa3a3b2", 
			2 => "a33c2d04-0f48-4869-b7df-2994a002f94e", 
			3 => "87d09a27-2393-4558-b8b8-bdc225dbe8b6", 
			_ => "79697f58-62b1-4b03-b9b0-8f4ed49733b3", 
		};
	}

	public static string ExecuteStealCombatSkill(EventArgBox argBox)
	{
		int arg = -1;
		argBox.Get("CharacterId", ref arg);
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		ChangeRoleMainAttribute(character, 5, -20);
		sbyte b = (sbyte)(GetXiangshuLevel() + 1);
		if (b < 0)
		{
			return "37a585d2-dabd-4e00-a6ea-68138beb6838";
		}
		List<short> charCombatSkillList = GetCharCombatSkillList(arg, -1, -1, 0, b, needBreak: false, requireTaiwuNotLearnAndRead: true);
		if (charCombatSkillList.Count <= 0)
		{
			return "37a585d2-dabd-4e00-a6ea-68138beb6838";
		}
		List<short> minGradeCombatSkillList = GetMinGradeCombatSkillList(charCombatSkillList);
		int random = GetRandom(0, minGradeCombatSkillList.Count);
		argBox.Set("TeachCombat", minGradeCombatSkillList[random]);
		sbyte stealCombatSkillActionPhase = GetStealCombatSkillActionPhase(character, character2, minGradeCombatSkillList[random], showCheckAnim: true);
		argBox.Set("ThenState", stealCombatSkillActionPhase);
		return stealCombatSkillActionPhase switch
		{
			0 => "9d5a6366-bf7f-4b54-8169-50a8f00102df", 
			1 => "df9672e7-141e-4252-a57e-34434dab5d60", 
			2 => "cee84f58-6280-4623-88b4-5983bb46abd9", 
			3 => "e36f9751-7d67-4d50-abf1-22001fcec70e", 
			_ => "302979ca-c086-4616-af00-1468288f07e6", 
		};
	}

	public static GameData.Domains.Character.Character CreateFulongServant(string nextEventGuid, EventArgBox argBox)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		OrganizationInfo organizationInfo = taiwu.GetOrganizationInfo();
		organizationInfo.Grade = 0;
		sbyte gender = Gender.GetRandom(mainThreadDataContext.Random);
		if (argBox.Contains<sbyte>("FulongServantSetGender"))
		{
			gender = argBox.GetSbyte("FulongServantSetGender");
		}
		bool arg = false;
		argBox.Get("FulongServantSetTransgender", ref arg);
		sbyte randomSectOrgTemplateId = OrganizationDomain.GetRandomSectOrgTemplateId(mainThreadDataContext.Random, gender);
		sbyte growingSectGrade = (sbyte)mainThreadDataContext.Random.Next(6);
		sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(location.AreaId);
		short characterTemplateId = OrganizationDomain.GetCharacterTemplateId(randomSectOrgTemplateId, stateTemplateIdByAreaId, gender);
		short age = (short)mainThreadDataContext.Random.Next(12, 25);
		IntelligentCharacterCreationInfo intelligentCharacterCreationInfo = new IntelligentCharacterCreationInfo(location, organizationInfo, characterTemplateId);
		intelligentCharacterCreationInfo.Age = age;
		intelligentCharacterCreationInfo.GrowingSectId = randomSectOrgTemplateId;
		intelligentCharacterCreationInfo.GrowingSectGrade = growingSectGrade;
		intelligentCharacterCreationInfo.InitializeSectSkills = false;
		intelligentCharacterCreationInfo.Gender = gender;
		intelligentCharacterCreationInfo.Transgender = arg;
		IntelligentCharacterCreationInfo info = intelligentCharacterCreationInfo;
		if (argBox.Contains<sbyte>("FulongServantSetGender"))
		{
			info.BaseAttraction = (short)mainThreadDataContext.Random.Next((int)GlobalConfig.Instance.FulongServantBaseAttraction, 900);
		}
		GameData.Domains.Character.Character character = DomainManager.Character.CreateIntelligentCharacter(mainThreadDataContext, ref info);
		int id = character.GetId();
		DomainManager.Character.CompleteCreatingCharacter(id);
		character.AddFeature(Domain.MainThreadDataContext, 199);
		character.SetIdealSect(randomSectOrgTemplateId, mainThreadDataContext);
		DomainManager.Character.TryCreateGeneralRelation(mainThreadDataContext, taiwu, character);
		DomainManager.Character.ChangeFavorabilityOptional(mainThreadDataContext, character, taiwu, 10000, 0);
		if (argBox.Contains<sbyte>("FulongServantSetBehaviorType"))
		{
			sbyte behaviorType = argBox.GetSbyte("FulongServantSetBehaviorType");
			ChangeRoleBehaviorType(character, behaviorType);
		}
		if (argBox.Contains<sbyte>("FulongServantSetMainAttributeType"))
		{
			sbyte b = argBox.GetSbyte("FulongServantSetMainAttributeType");
			short[] array = new short[6];
			for (int i = 0; i < array.Length; i++)
			{
				if (i == b)
				{
					array[i] = 12;
				}
				else
				{
					array[i] = -1;
				}
			}
			MainAttributes baseMainAttributes = CharacterCreation.CreateMainAttributes(mainThreadDataContext.Random, 7, array, null, 0, 0);
			character.SetBaseMainAttributes(baseMainAttributes, mainThreadDataContext);
			MainAttributes maxMainAttributes = character.GetMaxMainAttributes();
			character.SetCurrMainAttributes(maxMainAttributes, mainThreadDataContext);
		}
		if (argBox.Contains<sbyte>("FulongServantSetLifeSkillType"))
		{
			int num = argBox.GetInt("FulongServantSetLifeSkillType");
			short[] array2 = new short[16];
			for (int j = 0; j < array2.Length; j++)
			{
				if ((num & (1 << j)) != 0)
				{
					array2[j] = 12;
				}
				else
				{
					array2[j] = -1;
				}
			}
			LifeSkillShorts baseLifeSkillQualifications = CharacterCreation.CreateLifeSkillQualifications(mainThreadDataContext.Random, 7, array2, null, 0, 0);
			character.SetBaseLifeSkillQualifications(ref baseLifeSkillQualifications, mainThreadDataContext);
		}
		if (argBox.Contains<sbyte>("FulongServantSetCombatSkillType"))
		{
			int num2 = argBox.GetInt("FulongServantSetCombatSkillType");
			short[] array3 = new short[14];
			for (int k = 0; k < array3.Length; k++)
			{
				if ((num2 & (1 << k)) != 0)
				{
					array3[k] = 12;
				}
				else
				{
					array3[k] = -1;
				}
			}
			CombatSkillShorts baseCombatSkillQualifications = CharacterCreation.CreateCombatSkillQualifications(mainThreadDataContext.Random, 7, array3, null, 0, 0);
			character.SetBaseCombatSkillQualifications(ref baseCombatSkillQualifications, mainThreadDataContext);
		}
		DomainManager.Taiwu.JoinGroup(mainThreadDataContext, id);
		ShowGetItemPageForCharacters(new List<int> { id }, isVillager: false, nextEventGuid, argBox);
		return character;
	}

	public static bool FulongServantHasAnySet(EventArgBox argBox)
	{
		return FulongServantIsSetGenderAndTransgender(argBox) || FulongServantIsSetBehaviorType(argBox) || FulongServantIsSetLifeSkillType(argBox) || FulongServantIsSetCombatSkillType(argBox) || FulongServantIsSetMainAttributeType(argBox);
	}

	public static void FulongServantSetGender(EventArgBox argBox, sbyte gender)
	{
		argBox.Set("FulongServantSetGender", gender);
	}

	public static void FulongServantSetTransgender(EventArgBox argBox, bool transgender)
	{
		argBox.Set("FulongServantSetTransgender", transgender);
	}

	public static void FulongServantClearSetGenderAndTransgender(EventArgBox argBox)
	{
		argBox.Remove<sbyte>("FulongServantSetGender");
		argBox.Remove<bool>("FulongServantSetTransgender");
	}

	public static bool FulongServantIsSetGenderAndTransgender(EventArgBox argBox)
	{
		return argBox.Contains<sbyte>("FulongServantSetGender") || argBox.Contains<bool>("FulongServantSetTransgender");
	}

	public static bool FulongServantIsSetGenderAndTransgender(EventArgBox argBox, sbyte gender, bool transgender)
	{
		sbyte arg = -1;
		bool arg2 = false;
		if (argBox.Get("FulongServantSetGender", ref arg) && argBox.Get("FulongServantSetTransgender", ref arg2))
		{
			return arg == gender && arg2 == transgender;
		}
		return false;
	}

	public static void FulongServantSetBehaviorType(EventArgBox argBox, sbyte behaviorType)
	{
		argBox.Set("FulongServantSetBehaviorType", behaviorType);
	}

	public static bool FulongServantIsSetBehaviorType(EventArgBox argBox)
	{
		return argBox.Contains<sbyte>("FulongServantSetBehaviorType");
	}

	public static bool FulongServantIsSetBehaviorType(EventArgBox argBox, sbyte behaviorType)
	{
		sbyte arg = -1;
		if (argBox.Get("FulongServantSetBehaviorType", ref arg))
		{
			return behaviorType == arg;
		}
		return false;
	}

	public static void FulongServantClearSetBehaviorType(EventArgBox argBox)
	{
		argBox.Remove<sbyte>("FulongServantSetBehaviorType");
	}

	public static void FulongServantSetLifeSkillType(EventArgBox argBox, sbyte lifeSkillType)
	{
		int arg = 0;
		if (argBox.Contains<int>("FulongServantSetLifeSkillType"))
		{
			argBox.Get("FulongServantSetLifeSkillType", ref arg);
		}
		arg |= 1 << (int)lifeSkillType;
		argBox.Set("FulongServantSetLifeSkillType", arg);
	}

	public static void FulongServantClearSetLifeSkillType(EventArgBox argBox)
	{
		argBox.Remove<int>("FulongServantSetLifeSkillType");
	}

	public static bool FulongServantIsSetLifeSkillType(EventArgBox argBox)
	{
		return argBox.Contains<int>("FulongServantSetLifeSkillType");
	}

	public static bool FulongServantIsSetLifeSkillType(EventArgBox argBox, sbyte lifeSkillType)
	{
		int arg = 0;
		if (argBox.Get("FulongServantSetLifeSkillType", ref arg))
		{
			return (arg & (1 << (int)lifeSkillType)) != 0;
		}
		return false;
	}

	public static void FulongServantSetCombatSkillType(EventArgBox argBox, sbyte combatSkillType)
	{
		int arg = 0;
		if (argBox.Contains<int>("FulongServantSetCombatSkillType"))
		{
			argBox.Get("FulongServantSetCombatSkillType", ref arg);
		}
		arg |= 1 << (int)combatSkillType;
		argBox.Set("FulongServantSetCombatSkillType", arg);
	}

	public static void FulongServantClearSetCombatSkillType(EventArgBox argBox)
	{
		argBox.Remove<int>("FulongServantSetCombatSkillType");
	}

	public static bool FulongServantIsSetCombatSkillType(EventArgBox argBox)
	{
		return argBox.Contains<int>("FulongServantSetCombatSkillType");
	}

	public static bool FulongServantIsSetCombatSkillType(EventArgBox argBox, sbyte lifeSkillType)
	{
		int arg = 0;
		if (argBox.Get("FulongServantSetCombatSkillType", ref arg))
		{
			return (arg & (1 << (int)lifeSkillType)) != 0;
		}
		return false;
	}

	public static void FulongServantSetMainAttributeType(EventArgBox argBox, sbyte attributeType)
	{
		argBox.Set("FulongServantSetMainAttributeType", attributeType);
	}

	public static void FulongServantClearSetMainAttributeType(EventArgBox argBox)
	{
		argBox.Remove<sbyte>("FulongServantSetMainAttributeType");
	}

	public static bool FulongServantIsSetMainAttributeType(EventArgBox argBox)
	{
		return argBox.Contains<sbyte>("FulongServantSetMainAttributeType");
	}

	public static bool FulongServantIsSetMainAttributeType(EventArgBox argBox, sbyte attributeType)
	{
		sbyte arg = -1;
		if (argBox.Get("FulongServantSetMainAttributeType", ref arg))
		{
			return attributeType == arg;
		}
		return false;
	}

	public static string FulongServantGetGenderDesc(EventArgBox argBox)
	{
		string text = "";
		sbyte arg = -1;
		bool arg2 = false;
		if (argBox.Get("FulongServantSetGender", ref arg) && argBox.Get("FulongServantSetTransgender", ref arg2))
		{
			if (arg == 0 && !arg2)
			{
				text = "<Language Key=LK_FulongServant_GenderFemale_NoTransgender/>";
			}
			if (arg == 1 && !arg2)
			{
				text = "<Language Key=LK_FulongServant_GenderMale_NoTransgender/>";
			}
			if (arg == 0 && arg2)
			{
				text = "<Language Key=LK_FulongServant_GenderFemale_Transgender/>";
			}
			if (arg == 1 && arg2)
			{
				text = "<Language Key=LK_FulongServant_GenderMale_Transgender/>";
			}
			if (!FulongServantGetBehaviorTypeDesc(argBox).Equals("") || !FulongServantGetLifeSKillTypeDesc(argBox).Equals("") || !FulongServantGetCombatSKillTypeDesc(argBox).Equals("") || !FulongServantGetMainAttributeTypeDesc(argBox).Equals(""))
			{
				text += "";
			}
		}
		return text;
	}

	public static string FulongServantGetBehaviorTypeDesc(EventArgBox argBox)
	{
		string text = "";
		sbyte arg = -1;
		if (argBox.Get("FulongServantSetBehaviorType", ref arg))
		{
			text = $"<Language Key=LK_FulongServant_BehaviorType_{arg}/>";
			if (!FulongServantGetLifeSKillTypeDesc(argBox).Equals("") || !FulongServantGetCombatSKillTypeDesc(argBox).Equals("") || !FulongServantGetMainAttributeTypeDesc(argBox).Equals(""))
			{
				text += "";
			}
		}
		return text;
	}

	public static string FulongServantGetLifeSKillTypeDesc(EventArgBox argBox)
	{
		string text = "";
		int arg = -1;
		if (argBox.Get("FulongServantSetLifeSkillType", ref arg))
		{
			if ((arg & 1) != 0)
			{
				text = "<Language Key=LK_FulongServant_LifeSkillType_Music/>";
			}
			if ((arg & 0x2000) != 0)
			{
				text = "<Language Key=LK_FulongServant_LifeSkillType_Buddhism/>";
			}
			if ((arg & 0x100) != 0)
			{
				text = "<Language Key=LK_FulongServant_LifeSkillType_Medicine/>";
			}
			if ((arg & 0x40) != 0)
			{
				text = "<Language Key=LK_FulongServant_LifeSkillType_Forging/>";
			}
			if ((arg & 0x10) != 0)
			{
				text = "<Language Key=LK_FulongServant_LifeSkillType_Math/>";
			}
			if (!FulongServantGetCombatSKillTypeDesc(argBox).Equals("") || !FulongServantGetMainAttributeTypeDesc(argBox).Equals(""))
			{
				text += "";
			}
		}
		return text;
	}

	public static string FulongServantGetCombatSKillTypeDesc(EventArgBox argBox)
	{
		string text = "";
		int arg = -1;
		if (argBox.Get("FulongServantSetCombatSkillType", ref arg))
		{
			if ((arg & 1) != 0)
			{
				text = "<Language Key=LK_FulongServant_CombatSkillType_Neigong/>";
			}
			if ((arg & 8) != 0)
			{
				text = "<Language Key=LK_FulongServant_CombatSkillType_FistAndPalm/>";
			}
			if ((arg & 0x80) != 0)
			{
				text = "<Language Key=LK_FulongServant_CombatSkillType_Sword/>";
			}
			if ((arg & 0x40) != 0)
			{
				text = "<Language Key=LK_FulongServant_CombatSkillType_Throw/>";
			}
			if (!FulongServantGetMainAttributeTypeDesc(argBox).Equals(""))
			{
				text += "";
			}
		}
		return text;
	}

	public static string FulongServantGetMainAttributeTypeDesc(EventArgBox argBox)
	{
		string result = "";
		sbyte arg = 0;
		if (argBox.Get("FulongServantSetMainAttributeType", ref arg))
		{
			result = $"<Language Key=LK_FulongServant_MainAttributeType_{arg}/>";
		}
		return result;
	}

	public static void SetGraveLevel(int targetGraveId, sbyte targetLevel)
	{
		if (targetLevel < 0)
		{
			RemoveGrave(targetGraveId);
		}
		else if (targetLevel <= 3)
		{
			Grave element_Graves = DomainManager.Character.GetElement_Graves(targetGraveId);
			element_Graves.SetLevel(targetLevel, Domain.MainThreadDataContext);
			short durability = GlobalConfig.Instance.GraveDurabilities[targetLevel];
			element_Graves.SetDurability(durability, Domain.MainThreadDataContext);
			MapBlockData block = DomainManager.Map.GetBlock(element_Graves.GetLocation());
			DomainManager.Map.SetBlockData(Domain.MainThreadDataContext, block);
		}
	}

	public static sbyte GetGraveRobMeetSkeletonRate(int targetCharId)
	{
		DeadCharacter deadCharacter = DomainManager.Character.GetDeadCharacter(targetCharId);
		if (deadCharacter == null)
		{
			return 0;
		}
		CharacterItem item = Config.Character.Instance.GetItem(deadCharacter.TemplateId);
		if (item == null || !string.IsNullOrEmpty(item.FixedAvatarName))
		{
			return 0;
		}
		sbyte consummateLevel = DomainManager.Taiwu.GetTaiwu().GetConsummateLevel();
		sbyte consummateLevel2 = deadCharacter.GetConsummateLevel();
		return (sbyte)Math.Clamp(GlobalConfig.Instance.RobGraveEventWeight[2] + Math.Max(consummateLevel2 - consummateLevel, 0) * 5, -128, 127);
	}

	public unsafe static bool ApplyRobResourceFromGrave(int selfCharId, int targetGraveId, out sbyte gainedResourceType, out int gainedResourceCount)
	{
		gainedResourceType = -1;
		gainedResourceCount = 0;
		if (!DomainManager.Character.TryGetElement_Graves(targetGraveId, out var element))
		{
			return false;
		}
		if (!DomainManager.Character.TryGetElement_Objects(selfCharId, out var element2))
		{
			return false;
		}
		ResourceInts resources = element.GetResources();
		List<sbyte> list = new List<sbyte>();
		for (sbyte b = 0; b < 8; b++)
		{
			if (b != 7 && resources.Items[b] > 0)
			{
				list.Add(b);
			}
		}
		if (list.Count == 0)
		{
			return false;
		}
		sbyte b2 = list.Sample();
		int num = resources.Items[b2];
		int num2 = num / 4;
		if (num2 == 0)
		{
			num2 = 1;
		}
		ChangeRoleResource(element2, b2, num2);
		ref int reference = ref resources.Items[b2];
		reference -= num2;
		element.SetResources(ref resources, Domain.MainThreadDataContext);
		gainedResourceCount = num2;
		gainedResourceType = b2;
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		Location location = element2.GetLocation();
		lifeRecordCollection.AddRobResourceFromGraveSucceed(selfCharId, currDate, targetGraveId, location, b2, num2);
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		int dataOffset = secretInformationCollection.AddRobGraveResource(selfCharId, targetGraveId, gainedResourceType);
		DomainManager.Information.AddSecretInformationMetaData(Domain.MainThreadDataContext, dataOffset);
		return true;
	}

	public static bool ApplyRobItemFromGrave(int selfCharId, int targetGraveId, out ItemKey targetItemKey)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		targetItemKey = ItemKey.Invalid;
		if (!DomainManager.Character.TryGetElement_Graves(targetGraveId, out var element))
		{
			return false;
		}
		if (!DomainManager.Character.TryGetElement_Objects(selfCharId, out var element2))
		{
			return false;
		}
		targetItemKey = GetRandomItemFromGrave(mainThreadDataContext.Random, element);
		if (!targetItemKey.IsValid())
		{
			return false;
		}
		int amount = element.GetInventory().Items[targetItemKey];
		element.RemoveInventoryItem(mainThreadDataContext, targetItemKey, amount);
		element2.AddInventoryItem(mainThreadDataContext, targetItemKey, amount);
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		Location location = element2.GetLocation();
		lifeRecordCollection.AddRobItemFromGraveSucceed(selfCharId, currDate, targetGraveId, location, targetItemKey.ItemType, targetItemKey.TemplateId);
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		int dataOffset = secretInformationCollection.AddRobGraveItem(selfCharId, targetGraveId, (ulong)targetItemKey);
		DomainManager.Information.AddSecretInformationMetaData(mainThreadDataContext, dataOffset);
		return true;
	}

	private static ItemKey GetRandomItemFromGrave(IRandomSource random, Grave grave)
	{
		Inventory inventory = grave.GetInventory();
		if (inventory.Items.Count <= 0)
		{
			return ItemKey.Invalid;
		}
		List<ItemKey> list = ObjectPool<List<ItemKey>>.Instance.Get();
		List<ItemKey> list2 = ObjectPool<List<ItemKey>>.Instance.Get();
		List<ItemKey> list3 = ObjectPool<List<ItemKey>>.Instance.Get();
		List<ItemKey> list4 = ObjectPool<List<ItemKey>>.Instance.Get();
		list.Clear();
		list2.Clear();
		list3.Clear();
		list4.Clear();
		foreach (ItemKey key in inventory.Items.Keys)
		{
			sbyte grade = ItemTemplateHelper.GetGrade(key.ItemType, key.TemplateId);
			if (EatingItems.IsWugKing(key))
			{
				list.Add(key);
			}
			else if (grade <= 2)
			{
				list2.Add(key);
			}
			else if (grade <= 5)
			{
				list3.Add(key);
			}
			else
			{
				list4.Add(key);
			}
		}
		ItemKey result = ItemKey.Invalid;
		if (list.Count > 0)
		{
			result = list.GetRandom(random);
		}
		else if (list2.Count > 0)
		{
			result = list2.GetRandom(random);
		}
		else if (list3.Count > 0 && CheckProbability(50))
		{
			result = list3.GetRandom(random);
		}
		else if (list4.Count > 0 && CheckProbability(50))
		{
			result = list4.GetRandom(random);
		}
		ObjectPool<List<ItemKey>>.Instance.Return(list);
		ObjectPool<List<ItemKey>>.Instance.Return(list2);
		ObjectPool<List<ItemKey>>.Instance.Return(list3);
		ObjectPool<List<ItemKey>>.Instance.Return(list4);
		return result;
	}

	public static void DiscardSecretInformationInThreatenEvent(EventArgBox argBox)
	{
		int taiwuCharacterId = EventArgBox.TaiwuCharacterId;
		int arg = -1;
		if (argBox.Get("metaDataId", ref arg))
		{
			List<int> secretInformationOfCharacter = GetSecretInformationOfCharacter(taiwuCharacterId, includeBroadcast: false);
			if (secretInformationOfCharacter.Contains(arg))
			{
				DiscardSecretInformation(taiwuCharacterId, arg);
			}
		}
	}

	public static void ApplyBecomeSwornSiblingsByThreatening(int selfCharId, int threatenedCharId, int nominatedCharId)
	{
		if (DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var _) && DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element2) && RelationTypeHelper.AllowAddingSwornBrotherOrSisterRelation(threatenedCharId, nominatedCharId))
		{
			int taiwuCharacterId = EventArgBox.TaiwuCharacterId;
			Location location = element2.GetLocation();
			int currDate = DomainManager.World.GetCurrDate();
			LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
			DomainManager.Character.AddRelation(Domain.MainThreadDataContext, threatenedCharId, nominatedCharId, 512, currDate);
			lifeRecordCollection.AddBecomeSwornSiblingByThreatened(threatenedCharId, currDate, nominatedCharId, location, taiwuCharacterId);
			lifeRecordCollection.AddThreatenSucceed(selfCharId, currDate, threatenedCharId, location);
			SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
			int dataOffset = secretInformationCollection.AddBecomeSwornBrothersAndSisters(threatenedCharId, nominatedCharId);
			int num = DomainManager.Information.AddSecretInformationMetaData(Domain.MainThreadDataContext, dataOffset);
			if (!GetSecretInformationOfCharacter(taiwuCharacterId).Contains(num))
			{
				DistributeSecretInformationToCharacter(num, taiwuCharacterId);
			}
			ApplyDebtHappinessAndMoodChangeOfAddingRelationByThreaten(selfCharId, threatenedCharId, nominatedCharId);
		}
	}

	public static void ApplyBecomeHusbandOrWifeByThreatening(int selfCharId, int threatenedCharId, int nominatedCharId)
	{
		if (DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var _) && DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element2) && RelationTypeHelper.AllowAddingHusbandOrWifeRelation(threatenedCharId, nominatedCharId))
		{
			Location location = element2.GetLocation();
			int currDate = DomainManager.World.GetCurrDate();
			LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
			DomainManager.Character.AddHusbandOrWifeRelations(Domain.MainThreadDataContext, threatenedCharId, nominatedCharId, currDate);
			lifeRecordCollection.AddMarriedByThreatened(threatenedCharId, currDate, nominatedCharId, location, selfCharId);
			lifeRecordCollection.AddThreatenSucceed(selfCharId, currDate, threatenedCharId, location);
			SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
			int dataOffset = secretInformationCollection.AddBecomeHusbandAndWife(threatenedCharId, nominatedCharId);
			int num = DomainManager.Information.AddSecretInformationMetaData(Domain.MainThreadDataContext, dataOffset);
			if (!GetSecretInformationOfCharacter(selfCharId).Contains(num))
			{
				DistributeSecretInformationToCharacter(num, selfCharId);
			}
			ApplyDebtHappinessAndMoodChangeOfAddingRelationByThreaten(selfCharId, threatenedCharId, nominatedCharId);
		}
	}

	public static void ApplyAddMentorByThreatening(int selfCharId, int threatenedCharId, int nominatedCharId)
	{
		if (DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var _) && DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element2) && RelationTypeHelper.AllowAddingMentorRelation(threatenedCharId, nominatedCharId))
		{
			int taiwuCharacterId = EventArgBox.TaiwuCharacterId;
			Location location = element2.GetLocation();
			int currDate = DomainManager.World.GetCurrDate();
			LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
			DomainManager.Character.AddRelation(Domain.MainThreadDataContext, threatenedCharId, nominatedCharId, 2048, currDate);
			lifeRecordCollection.AddAddMentorByThreatened(threatenedCharId, currDate, nominatedCharId, location, taiwuCharacterId);
			lifeRecordCollection.AddThreatenSucceed(selfCharId, currDate, threatenedCharId, location);
			ApplyDebtHappinessAndMoodChangeOfAddingRelationByThreaten(selfCharId, threatenedCharId, nominatedCharId);
		}
	}

	public static void ApplyAddMenteeByThreatening(int selfCharId, int threatenedCharId, int nominatedCharId)
	{
		if (DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var _) && DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element2) && RelationTypeHelper.AllowAddingMenteeRelation(threatenedCharId, nominatedCharId))
		{
			Location location = element2.GetLocation();
			int currDate = DomainManager.World.GetCurrDate();
			LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
			DomainManager.Character.AddRelation(Domain.MainThreadDataContext, threatenedCharId, nominatedCharId, 4096, currDate);
			ApplyDebtHappinessAndMoodChangeOfAddingRelationByThreaten(selfCharId, threatenedCharId, nominatedCharId);
		}
	}

	public static void ApplyAddAdoptiveChildByThreatening(int selfCharId, int threatenedCharId, int nominatedCharId)
	{
		if (DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var element) && DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element2) && RelationTypeHelper.AllowAddingAdoptiveChildRelation(threatenedCharId, nominatedCharId))
		{
			Location location = element2.GetLocation();
			int currDate = DomainManager.World.GetCurrDate();
			LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
			DomainManager.Character.AddAdoptiveParentRelations(Domain.MainThreadDataContext, nominatedCharId, threatenedCharId, currDate);
			int aliveSpouse = DomainManager.Character.GetAliveSpouse(threatenedCharId);
			if (aliveSpouse >= 0)
			{
				DomainManager.Character.AddAdoptiveParentRelations(Domain.MainThreadDataContext, nominatedCharId, aliveSpouse, currDate);
			}
			short relatedRecordId = (short)((element2.GetGender() == 1) ? 459 : 460);
			if (element.GetGender() == 1)
			{
				lifeRecordCollection.AddGetAdoptedSonByThreatened(threatenedCharId, currDate, nominatedCharId, location, selfCharId, relatedRecordId);
			}
			else
			{
				lifeRecordCollection.AddGetAdoptedDaughterByThreatened(threatenedCharId, currDate, nominatedCharId, location, selfCharId, relatedRecordId);
			}
			lifeRecordCollection.AddThreatenSucceed(selfCharId, currDate, threatenedCharId, location);
			SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
			int dataOffset = secretInformationCollection.AddAdoptChild(threatenedCharId, nominatedCharId);
			int num = DomainManager.Information.AddSecretInformationMetaData(Domain.MainThreadDataContext, dataOffset);
			dataOffset = secretInformationCollection.AddGetAdopted(nominatedCharId, threatenedCharId);
			int num2 = DomainManager.Information.AddSecretInformationMetaData(Domain.MainThreadDataContext, dataOffset);
			if (!GetSecretInformationOfCharacter(selfCharId).Contains(num))
			{
				DistributeSecretInformationToCharacter(num, selfCharId);
			}
			if (!GetSecretInformationOfCharacter(selfCharId).Contains(num2))
			{
				DistributeSecretInformationToCharacter(num2, selfCharId);
			}
			ApplyDebtHappinessAndMoodChangeOfAddingRelationByThreaten(selfCharId, threatenedCharId, nominatedCharId);
		}
	}

	public static void ApplyAddAdoptiveParentByThreatening(int selfCharId, int threatenedCharId, int nominatedCharId)
	{
		if (DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var element) && DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element2) && RelationTypeHelper.AllowAddingAdoptiveParentRelation(threatenedCharId, nominatedCharId))
		{
			Location location = element2.GetLocation();
			int currDate = DomainManager.World.GetCurrDate();
			LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
			DomainManager.Character.AddAdoptiveParentRelations(Domain.MainThreadDataContext, threatenedCharId, nominatedCharId, currDate);
			int aliveSpouse = DomainManager.Character.GetAliveSpouse(nominatedCharId);
			if (aliveSpouse >= 0)
			{
				DomainManager.Character.AddAdoptiveParentRelations(Domain.MainThreadDataContext, threatenedCharId, aliveSpouse, currDate);
			}
			short relatedRecordId = (short)((element2.GetGender() == 1) ? 461 : 462);
			if (element.GetGender() == 1)
			{
				lifeRecordCollection.AddGetAdoptedFatherByThreatened(threatenedCharId, currDate, nominatedCharId, location, selfCharId, relatedRecordId);
			}
			else
			{
				lifeRecordCollection.AddGetAdoptedMotherByThreatened(threatenedCharId, currDate, nominatedCharId, location, selfCharId, relatedRecordId);
			}
			lifeRecordCollection.AddThreatenSucceed(selfCharId, currDate, threatenedCharId, location);
			SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
			int dataOffset = secretInformationCollection.AddGetAdopted(threatenedCharId, nominatedCharId);
			int num = DomainManager.Information.AddSecretInformationMetaData(Domain.MainThreadDataContext, dataOffset);
			dataOffset = secretInformationCollection.AddAdoptChild(nominatedCharId, threatenedCharId);
			int num2 = DomainManager.Information.AddSecretInformationMetaData(Domain.MainThreadDataContext, dataOffset);
			if (!GetSecretInformationOfCharacter(selfCharId).Contains(num))
			{
				DistributeSecretInformationToCharacter(num, selfCharId);
			}
			if (!GetSecretInformationOfCharacter(selfCharId).Contains(num2))
			{
				DistributeSecretInformationToCharacter(num2, selfCharId);
			}
			ApplyDebtHappinessAndMoodChangeOfAddingRelationByThreaten(selfCharId, threatenedCharId, nominatedCharId);
		}
	}

	public static void ApplySeverSwornSiblingsByThreatening(int selfCharId, int threatenedCharId, int nominatedCharId)
	{
		if (DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element) && DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var _) && DomainManager.Character.HasRelation(threatenedCharId, nominatedCharId, 512))
		{
			Location location = element.GetLocation();
			int currDate = DomainManager.World.GetCurrDate();
			LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
			DomainManager.Character.ChangeRelationType(Domain.MainThreadDataContext, threatenedCharId, nominatedCharId, 512, 0);
			DomainManager.Character.ChangeRelationType(Domain.MainThreadDataContext, threatenedCharId, nominatedCharId, 512, 0);
			lifeRecordCollection.AddSeverSwornSiblingByThreatened(threatenedCharId, currDate, nominatedCharId, location, selfCharId);
			lifeRecordCollection.AddThreatenSucceed(selfCharId, currDate, threatenedCharId, location);
			SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
			int dataOffset = secretInformationCollection.AddSeverSwornBrothersAndSisters(threatenedCharId, nominatedCharId);
			int num = DomainManager.Information.AddSecretInformationMetaData(Domain.MainThreadDataContext, dataOffset);
			if (!GetSecretInformationOfCharacter(selfCharId).Contains(num))
			{
				DistributeSecretInformationToCharacter(num, selfCharId);
			}
			ApplyDebtHappinessAndMoodChangeOfEndingRelationByThreaten(selfCharId, threatenedCharId, nominatedCharId);
		}
	}

	public static void ApplyDivorceByThreatening(int selfCharId, int threatenedCharId, int nominatedCharId)
	{
		if (DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element) && DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var element2) && DomainManager.Character.HasRelation(threatenedCharId, nominatedCharId, 1024) && DomainManager.Character.HasRelation(nominatedCharId, threatenedCharId, 1024))
		{
			EndRelation(threatenedCharId, nominatedCharId, 1024);
			EndRelation(nominatedCharId, threatenedCharId, 1024);
			DataContext mainThreadDataContext = Domain.MainThreadDataContext;
			OrganizationInfo organizationInfo = element.GetOrganizationInfo();
			OrganizationInfo organizationInfo2 = element2.GetOrganizationInfo();
			if (organizationInfo.Principal)
			{
				DomainManager.Organization.TryDowngradeDeputySpouse(mainThreadDataContext, threatenedCharId, organizationInfo, nominatedCharId);
			}
			else
			{
				DomainManager.Organization.TryDowngradeDeputySpouse(mainThreadDataContext, nominatedCharId, organizationInfo2, threatenedCharId);
			}
			Location location = element.GetLocation();
			int currDate = DomainManager.World.GetCurrDate();
			LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
			lifeRecordCollection.AddDivorceByThreatened(threatenedCharId, currDate, nominatedCharId, location, selfCharId);
			lifeRecordCollection.AddThreatenSucceed(selfCharId, currDate, threatenedCharId, location);
			ApplyDebtHappinessAndMoodChangeOfEndingRelationByThreaten(selfCharId, threatenedCharId, nominatedCharId);
		}
	}

	public static void ApplySeverMentorByThreatening(int selfCharId, int threatenedCharId, int nominatedCharId)
	{
		if (DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element) && DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var _) && DomainManager.Character.HasRelation(threatenedCharId, nominatedCharId, 2048) && DomainManager.Character.HasRelation(nominatedCharId, threatenedCharId, 4096))
		{
			EndRelation(threatenedCharId, nominatedCharId, 2048);
			EndRelation(nominatedCharId, threatenedCharId, 4096);
			Location location = element.GetLocation();
			int currDate = DomainManager.World.GetCurrDate();
			LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
			lifeRecordCollection.AddSeverMentorByThreatened(threatenedCharId, currDate, nominatedCharId, location, selfCharId);
			lifeRecordCollection.AddThreatenSucceed(selfCharId, currDate, threatenedCharId, location);
			ApplyDebtHappinessAndMoodChangeOfEndingRelationByThreaten(selfCharId, threatenedCharId, nominatedCharId);
		}
	}

	public static void ApplySeverMenteeByThreatening(int selfCharId, int threatenedCharId, int nominatedCharId)
	{
		if (DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element) && DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var _) && DomainManager.Character.HasRelation(threatenedCharId, nominatedCharId, 4096) && DomainManager.Character.HasRelation(nominatedCharId, threatenedCharId, 2048))
		{
			EndRelation(threatenedCharId, nominatedCharId, 4096);
			EndRelation(nominatedCharId, threatenedCharId, 2048);
			int taiwuCharacterId = EventArgBox.TaiwuCharacterId;
			Location location = element.GetLocation();
			int currDate = DomainManager.World.GetCurrDate();
			LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
			ApplyDebtHappinessAndMoodChangeOfEndingRelationByThreaten(selfCharId, threatenedCharId, nominatedCharId);
		}
	}

	public static void ApplySeverAdoptiveParentByThreatening(int selfCharId, int threatenedCharId, int nominatedCharId)
	{
		if (DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element) && DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var element2) && DomainManager.Character.HasRelation(threatenedCharId, nominatedCharId, 64) && DomainManager.Character.HasRelation(nominatedCharId, threatenedCharId, 128))
		{
			EndRelation(threatenedCharId, nominatedCharId, 64);
			EndRelation(nominatedCharId, threatenedCharId, 128);
			Location location = element.GetLocation();
			int currDate = DomainManager.World.GetCurrDate();
			LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
			if (element2.GetGender() == 1)
			{
				lifeRecordCollection.AddSeverAdoptiveFatherByThreatened(threatenedCharId, currDate, nominatedCharId, location, selfCharId);
			}
			else
			{
				lifeRecordCollection.AddSeverAdoptiveMotherByThreatened(threatenedCharId, currDate, nominatedCharId, location, selfCharId);
			}
			lifeRecordCollection.AddThreatenSucceed(selfCharId, currDate, threatenedCharId, location);
			ApplyDebtHappinessAndMoodChangeOfEndingRelationByThreaten(selfCharId, threatenedCharId, nominatedCharId);
		}
	}

	public static void ApplySeverAdoptiveChildByThreatening(int selfCharId, int threatenedCharId, int nominatedCharId)
	{
		if (DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element) && DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var element2) && DomainManager.Character.HasRelation(threatenedCharId, nominatedCharId, 128) && DomainManager.Character.HasRelation(nominatedCharId, threatenedCharId, 64))
		{
			EndRelation(threatenedCharId, nominatedCharId, 128);
			EndRelation(nominatedCharId, threatenedCharId, 64);
			Location location = element.GetLocation();
			int currDate = DomainManager.World.GetCurrDate();
			LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
			if (element2.GetGender() == 1)
			{
				lifeRecordCollection.AddSeverAdoptiveSonByThreatened(threatenedCharId, currDate, nominatedCharId, location, selfCharId);
			}
			else
			{
				lifeRecordCollection.AddSeverAdoptiveDaughterByThreatened(threatenedCharId, currDate, nominatedCharId, location, selfCharId);
			}
			lifeRecordCollection.AddThreatenSucceed(selfCharId, currDate, threatenedCharId, location);
			ApplyDebtHappinessAndMoodChangeOfEndingRelationByThreaten(selfCharId, threatenedCharId, nominatedCharId);
		}
	}

	public static void ApplyTransferItemByThreaten(int nominatedCharId, int threatenedCharId, ItemKey itemKey)
	{
		if (DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element) && DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var _))
		{
			TransferInventoryItemWithDebt(threatenedCharId, nominatedCharId, itemKey, 1, changeFavor: true);
			ChangeCharacterHappinessByItemChange(itemKey, threatenedCharId, isGetItem: false);
			Location location = element.GetLocation();
			int currDate = DomainManager.World.GetCurrDate();
			LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
			lifeRecordCollection.AddScamItemSucceed(nominatedCharId, currDate, threatenedCharId, location, itemKey.ItemType, itemKey.TemplateId);
			lifeRecordCollection.AddThreatenSucceed(nominatedCharId, currDate, threatenedCharId, location);
			int num = CreateSecretInformationMetaData(GetSecretInformationCollection().AddScamItem(nominatedCharId, threatenedCharId, (ulong)itemKey));
		}
	}

	public static void ApplyTransferResourceByThreaten(int nominatedCharId, int threatenedCharId, sbyte resourceType, int amount)
	{
		if (DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element) && DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var _))
		{
			TransferResourcesWithDebt(threatenedCharId, nominatedCharId, resourceType, amount, changeFavor: true);
			short resourceHappinessChange = GetResourceHappinessChange(resourceType, amount);
			ChangeRoleHappiness(element, resourceHappinessChange);
			Location location = element.GetLocation();
			int currDate = DomainManager.World.GetCurrDate();
			LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
			lifeRecordCollection.AddScamResourceSucceed(nominatedCharId, currDate, threatenedCharId, location, resourceType, amount);
			lifeRecordCollection.AddThreatenSucceed(nominatedCharId, currDate, threatenedCharId, location);
			int num = CreateSecretInformationMetaData(GetSecretInformationCollection().AddScamResource(nominatedCharId, threatenedCharId, resourceType));
		}
	}

	public static void SetSectCharApprovedTaiwuWithDebt(int nominatedCharId, int threatenedCharId)
	{
		if (DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element) && DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var element2) && IsInAnySect(threatenedCharId) && !IsSectCharApprovedTaiwu(threatenedCharId))
		{
			SetSectCharApprovedTaiwu(threatenedCharId);
			short characterInfluencePower = GetCharacterInfluencePower(threatenedCharId);
			short num = (short)(characterInfluencePower * 50);
			ChangeFavorabilityOptional(element, element2, num, 3);
			int num2 = element.GetOrganizationInfo().Grade + 1;
			ChangeRoleHappiness(element, -num2);
			int num3 = num * 10;
			if (num3 > 0)
			{
				DirectlyAddDebt(threatenedCharId, num3, isEquivalent: false);
			}
			Location location = element.GetLocation();
			int currDate = DomainManager.World.GetCurrDate();
			LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
			lifeRecordCollection.AddApproveTaiwuByThreatened(threatenedCharId, currDate, nominatedCharId, location);
			lifeRecordCollection.AddThreatenSucceed(nominatedCharId, currDate, threatenedCharId, location);
		}
	}

	public static void ReduceDebtByThreaten(int selfCharId, int threatenedCharId, int metaDataId)
	{
		if (DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element) && DomainManager.Character.TryGetElement_Objects(selfCharId, out var _))
		{
			SecretInformationProcessor secretInformationProcessor = DomainManager.Information.SecretInformationProcessorPool.Get();
			if (!secretInformationProcessor.Initialize(metaDataId))
			{
				throw new Exception("Can not Initialize Processor of (metaDataId)!)");
			}
			ApplyWriteOffDebtsByThreaten(threatenedCharId, metaDataId);
			Location location = element.GetLocation();
			int currDate = DomainManager.World.GetCurrDate();
			LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
			lifeRecordCollection.AddReduceDebtByThreatened(threatenedCharId, currDate, selfCharId, location);
			lifeRecordCollection.AddThreatenSucceed(selfCharId, currDate, threatenedCharId, location);
		}
	}

	public static void ApplyDebtHappinessAndMoodChangeOfAddingRelationByThreaten(int selfCharId, int threatenedCharId, int nominatedCharId)
	{
		if (DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element) && DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var _) && DomainManager.Character.TryGetElement_Objects(selfCharId, out var element3))
		{
			short favorability = DomainManager.Character.GetFavorability(threatenedCharId, nominatedCharId);
			sbyte favorabilityType = FavorabilityType.GetFavorabilityType(favorability);
			short num = (short)(9000 - Math.Max(favorabilityType, 0) * 1000);
			ChangeFavorabilityOptional(element, element3, (short)(-num), 3);
			int num2 = num * 10;
			if (num2 > 0)
			{
				DirectlyAddDebt(threatenedCharId, num2, isEquivalent: false);
			}
			int deltaValue = 9 - Math.Max(favorabilityType, 0);
			ChangeRoleHappiness(element, deltaValue);
		}
	}

	public static void ApplyDebtHappinessAndMoodChangeOfEndingRelationByThreaten(int selfCharId, int threatenedCharId, int nominatedCharId)
	{
		if (DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element) && DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var _) && DomainManager.Character.TryGetElement_Objects(selfCharId, out var element3))
		{
			short favorability = DomainManager.Character.GetFavorability(threatenedCharId, nominatedCharId);
			sbyte favorabilityType = FavorabilityType.GetFavorabilityType(favorability);
			short num = (short)(3000 + Math.Max(favorabilityType, 0) * 1500);
			ChangeFavorabilityOptional(element, element3, (short)(-num), 3);
			int num2 = num * 10;
			if (num2 > 0)
			{
				DirectlyAddDebt(threatenedCharId, num2, isEquivalent: false);
			}
			int num3 = 3 + Math.Max(favorabilityType, 0);
			ChangeRoleHappiness(element, -num3);
		}
	}

	public static bool AllowAddingRelationByThreadNeedle(EventArgBox argBox, ushort relationType)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		int id = character.GetId();
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("SelectedCharIdForThreadNeedleAdding");
		int id2 = character2.GetId();
		return RelationTypeHelper.AllowAddingRelation(id, id2, relationType);
	}

	public static bool AllowEndingRelationByThreadNeedle(EventArgBox argBox, ushort relationType)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		int id = character.GetId();
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("SelectedCharIdForThreadNeedleEnding");
		int id2 = character2.GetId();
		switch (relationType)
		{
		case 512:
		case 8192:
		case 16384:
			return CanEndRelation(id, id2, relationType);
		case 32768:
			return CanEndRelation(id2, id, relationType);
		case 64:
		case 128:
		case 1024:
		case 2048:
		case 4096:
			return CheckHasRelationship(character, character2, relationType);
		default:
			throw new Exception($"Unsupported relation type for ending in event: {relationType}");
		}
	}

	public static void ApplyStartRelationByThreadNeedle(int charIdA, int charIdB, ushort relationType, bool succeed, bool isBothWayRelation = true)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charIdA, out var element) || !DomainManager.Character.TryGetElement_Objects(charIdB, out var element2))
		{
			return;
		}
		switch (relationType)
		{
		case 16384:
			if (isBothWayRelation)
			{
				AddRelation(charIdA, charIdB, 16384);
				ApplyRelationBecomeBoyOrGirlFriend(element, element2, succeed);
			}
			else
			{
				ApplyRelationBecomeAdore(element, element2, succeed);
			}
			break;
		case 8192:
			if (succeed)
			{
				ApplyRelationBecomeFriend(element, element2);
			}
			break;
		case 512:
			if (succeed)
			{
				ApplyRelationBecomeSwornBrotherOrSister(element, element2);
			}
			break;
		case 64:
			if (succeed)
			{
				ApplyRelationGetAdopted(element, element2);
			}
			break;
		case 128:
			if (succeed)
			{
				ApplyRelationAdoptChild(element, element2);
			}
			break;
		case 1024:
			ApplyRelationBecomeHusbandOrWife(element, element2, succeed);
			break;
		case 2048:
			if (succeed)
			{
				ApplyRelationBecomeMentor(element, element2);
			}
			break;
		case 32768:
			ApplyRelationBecomeEnemy(element, element2);
			if (succeed)
			{
				ApplyRelationBecomeEnemy(element2, element);
			}
			break;
		default:
			throw new Exception($"Wrong Adding Relation Quest: {relationType}");
		}
	}

	public static void ApplyEndRelationByThreadNeedle(int charIdA, int charIdB, ushort relationType, bool succeed, bool isBothWayRelation = true)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charIdA, out var element) || !DomainManager.Character.TryGetElement_Objects(charIdB, out var element2))
		{
			return;
		}
		switch (relationType)
		{
		case 16384:
		{
			if (isBothWayRelation)
			{
				ApplyRelationBreakupWithBoyOrGirlFriend(element, element2, !succeed);
				break;
			}
			sbyte behaviorType = element.GetBehaviorType();
			bool selfIsTaiwuPeople = DomainManager.Character.IsTaiwuPeople(charIdA);
			bool flag = DomainManager.Character.IsTaiwuPeople(charIdB);
			GameData.Domains.Character.Character.ApplySeverAdore(Domain.MainThreadDataContext, element, element2, behaviorType, selfIsTaiwuPeople);
			break;
		}
		case 8192:
			if (succeed)
			{
				ApplyRelationSeverFriend(element, element2);
			}
			break;
		case 512:
			if (succeed)
			{
				ApplyRelationSeverSwornBrotherOrSister(element, element2);
			}
			break;
		case 64:
			if (succeed)
			{
				ApplyRelationSeverAdoptiveParent(element, element2);
			}
			break;
		case 128:
			if (succeed)
			{
				ApplyRelationSeverAdoptedChild(element, element2);
			}
			break;
		case 1024:
			if (succeed)
			{
				ApplyRelationSeverHusbandOrWife(element, element2);
			}
			break;
		case 2048:
			if (succeed)
			{
				ApplyRelationSeverMentor(element, element2);
			}
			break;
		case 32768:
			ApplyRelationSeverEnemy(element, element2);
			if (succeed)
			{
				ApplyRelationSeverEnemy(element2, element);
			}
			break;
		default:
			throw new Exception($"Wrong Ending Relation Quest: {relationType}");
		}
	}

	public static void RemoveCannotSwornCharacters(int charId, HashSet<int> charIdCore)
	{
		charIdCore.RemoveWhere((int charIdElem) => charId == charIdElem || !IsIntelligentCharacter(charIdElem) || !RelationTypeHelper.AllowAddingRelation(charId, charIdElem, 512));
	}

	public static void RemoveCannotMarriageCharacters(int charId, HashSet<int> charIdCore)
	{
		charIdCore.RemoveWhere(delegate(int charIdElem)
		{
			GameData.Domains.Character.Character characterById = GetCharacterById(charIdElem);
			return charId == charIdElem || !IsIntelligentCharacter(charIdElem) || characterById.GetAgeGroup() != 2 || !RelationTypeHelper.AllowAddingRelation(charId, charIdElem, 1024);
		});
	}

	public static void RemoveCannotAcknowledgeCharacters(int charId, HashSet<int> charIdCore)
	{
		GameData.Domains.Character.Character character = GetCharacterById(charId);
		charIdCore.RemoveWhere(delegate(int charIdElem)
		{
			GameData.Domains.Character.Character characterById = GetCharacterById(charIdElem);
			return charId == charIdElem || !IsIntelligentCharacter(charIdElem) || CheckHasRelationship(character, characterById, 2048) || CheckHasRelationship(characterById, character, 2048);
		});
	}

	public static void RemoveCannotAdoptiveChildCharacters(int charId, HashSet<int> charIdCore)
	{
		charIdCore.RemoveWhere((int charIdElem) => charId == charIdElem || !IsIntelligentCharacter(charIdElem) || !RelationTypeHelper.AllowAddingRelation(charIdElem, charId, 64));
	}

	public static void RemoveCannotAdoptiveParentCharacters(int charId, HashSet<int> charIdCore)
	{
		charIdCore.RemoveWhere((int charIdElem) => charId == charIdElem || !IsIntelligentCharacter(charIdElem) || !RelationTypeHelper.AllowAddingRelation(charId, charIdElem, 64));
	}

	public static void RemoveCannotSplitAdoptiveCharacters(int charId, HashSet<int> charIdCore)
	{
		GameData.Domains.Character.Character character = GetCharacterById(charId);
		charIdCore.RemoveWhere(delegate(int charIdElem)
		{
			GameData.Domains.Character.Character characterById = GetCharacterById(charIdElem);
			return characterById == null || charId == charIdElem || !IsIntelligentCharacter(charIdElem) || !CheckHasRelationship(character, characterById, 512);
		});
	}

	public static void RemoveCannotDivorceCharacters(int charId, HashSet<int> charIdCore)
	{
		GameData.Domains.Character.Character character = GetCharacterById(charId);
		charIdCore.RemoveWhere(delegate(int charIdElem)
		{
			GameData.Domains.Character.Character characterById = GetCharacterById(charIdElem);
			return charId == charIdElem || !IsIntelligentCharacter(charIdElem) || !CheckHasRelationship(character, characterById, 1024);
		});
	}

	public static void RemoveCannotSplitAdoptiveParentCharacters(int charId, HashSet<int> charIdCore)
	{
		GameData.Domains.Character.Character character = GetCharacterById(charId);
		charIdCore.RemoveWhere(delegate(int charIdElem)
		{
			GameData.Domains.Character.Character characterById = GetCharacterById(charIdElem);
			return charId == charIdElem || !IsIntelligentCharacter(charIdElem) || !CheckHasRelationship(character, characterById, 64);
		});
	}

	public static void RemoveCannotSplitAdoptiveChildCharacters(int charId, HashSet<int> charIdCore)
	{
		GameData.Domains.Character.Character character = GetCharacterById(charId);
		charIdCore.RemoveWhere(delegate(int charIdElem)
		{
			GameData.Domains.Character.Character characterById = GetCharacterById(charIdElem);
			return charId == charIdElem || !IsIntelligentCharacter(charIdElem) || !CheckHasRelationship(character, characterById, 128);
		});
	}

	public static List<int> PrepareCombatEnemy(int charId, short combatConfigId, bool noGuard = false)
	{
		List<int> list = new List<int>();
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		if (DomainManager.TaiwuEvent.GetGlobalEventArgumentBox().GetBool("IsGuardCombat") && element_Objects.IsTreasuryGuard())
		{
			list.Add(charId);
			OrganizationInfo organizationInfo = element_Objects.GetOrganizationInfo();
			short templateId = ((organizationInfo.SettlementId >= 0 && DomainManager.Organization.GetSettlement(organizationInfo.SettlementId) is Sect sect) ? GameData.Domains.Character.Character.GetSectRandomEnemyTemplateIdByGrade(sect.GetOrgTemplateId(), organizationInfo.Grade) : CivilianSettlement.GetTreasuryGuardTemplateId(organizationInfo.Grade));
			int num = 3;
			while (num-- > 0)
			{
				list.Add(CreateNonIntelligentCharacter(templateId));
			}
		}
		else if (element_Objects.GetCreatingType() == 1)
		{
			CombatConfigItem combatConfigItem = CombatConfig.Instance[combatConfigId];
			CombatType combatType = (CombatType)combatConfigItem.CombatType;
			if (DomainManager.Taiwu.IsInGroup(charId) && combatConfigItem != null && combatConfigItem.IsGroupMemberLeave)
			{
				DomainManager.Taiwu.LeaveGroup(Domain.MainThreadDataContext, charId, bringWards: true, showNotification: true, moveToRandomAdjacentBlock: false);
			}
			if (noGuard)
			{
				list.Add(charId);
			}
			else
			{
				DomainManager.Character.GetTaiwuCombatEnemyTeam(mainThreadDataContext, element_Objects, combatType, list);
			}
		}
		else
		{
			list.Add(element_Objects.GetId());
			CharacterItem characterItem = Config.Character.Instance[element_Objects.GetTemplateId()];
			if (characterItem.MinionGroupId >= 0)
			{
				MinionGroupItem minionGroupItem = MinionGroup.Instance[characterItem.MinionGroupId];
				foreach (short minion in minionGroupItem.Minions)
				{
					list.Add(CreateNonIntelligentCharacter(minion));
				}
			}
		}
		return list;
	}

	public static void CharacterLoseGuard(int charId, int combatType)
	{
		if ((uint)(combatType - 1) <= 1u)
		{
			DomainManager.Character.LoseGuard(Domain.MainThreadDataContext, charId, null);
		}
	}

	public static void StartCombat(int charId, short combatConfigId, string combatCompleteEvent, EventArgBox argBox, bool noGuard = false)
	{
		List<int> enemyTeam = PrepareCombatEnemy(charId, combatConfigId, noGuard);
		StartCombat(enemyTeam, combatConfigId, combatCompleteEvent, argBox);
	}

	public static void StartCombat(List<int> enemyTeam, short combatConfigId, string combatCompleteEvent, EventArgBox argBox)
	{
		if (enemyTeam == null || enemyTeam.Count <= 0)
		{
			throw new Exception("no available enemyTeam passed !");
		}
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		argBox?.Set("ProtectedByWeiQiCharacter", DomainManager.Character.GetAvoidDeathCharId());
		Domain.SetListenerWithActionName(combatCompleteEvent, argBox, "CombatOver");
		DomainManager.TaiwuEvent.RecordCharacterEnterCombat();
		DomainManager.Combat.CombatEntry(mainThreadDataContext, enemyTeam, combatConfigId);
	}

	public static int CreateNonIntelligentCharacter(short templateId)
	{
		return DomainManager.Character.CreateNonIntelligentCharacter(Domain.MainThreadDataContext, templateId);
	}

	public static int GetDefeatMarksCountOutOfCombat(int charId)
	{
		return CombatDomain.GetDefeatMarksCountOutOfCombat(DomainManager.Character.GetElement_Objects(charId));
	}

	public static bool IsCharacterDirectFallenInCombat(int charId, CombatType combatType)
	{
		return DomainManager.Character.GetElement_Objects(charId).ReachFallenInCombat(combatType);
	}

	public static bool CheckRopeHitOutOfCombat(GameData.Domains.Character.Character useChar, GameData.Domains.Character.Character targetChar, sbyte combatType, ItemKey ropeKey, bool useMaxMarkCount = true)
	{
		return CombatDomain.CheckRopeHitOutOfCombat(Domain.MainThreadDataContext.Random, useChar, targetChar, combatType, useMaxMarkCount, ItemTemplateHelper.GetGrade(ropeKey.ItemType, ropeKey.TemplateId));
	}

	public static void GetExpAndAuthorityAndAreaSpiritualDebtOutOfCombat(List<short> enemyTemplateIdList)
	{
		DomainManager.Combat.GetExpAndAuthorityAndAreaSpiritualDebtOutOfCombat(Domain.MainThreadDataContext, enemyTemplateIdList);
	}

	public static bool CanWipeOut(short enemyLeaderId)
	{
		return CheckEscapingRandomEnemy(enemyLeaderId) || DomainManager.Combat.CanWipeOut(enemyLeaderId);
	}

	public static bool CanAutoWipeOut(short enemyLeaderId)
	{
		WipeOutType type;
		return CanWipeOut(enemyLeaderId) && DomainManager.Combat.TryGetWipeOutType(enemyLeaderId, out type) && GlobalDomain.Settings.IsTypeAutoWipeOutOn(type);
	}

	public static string GetTriggeringRandomEnemyEventGuid(short enemyLeaderId)
	{
		if (!DomainManager.Combat.TryGetWipeOutType(enemyLeaderId, out var type))
		{
			return "e5ecfaee-b6bc-4d5a-a15b-71b633b5a17a";
		}
		if (CanWipeOut(enemyLeaderId))
		{
			return (type == WipeOutType.Righteous) ? "9cc242b6-e839-4c95-8100-ce948847533e" : "bcece724-0aa5-4fde-bb58-c820d648e03b";
		}
		return (type == WipeOutType.Righteous) ? "00be2f9c-1215-4cca-a308-699664e60de3" : "e5ecfaee-b6bc-4d5a-a15b-71b633b5a17a";
	}

	public static bool TryTriggerRandomEnemy(EventArgBox argBox)
	{
		if (IsTaiwuAvoidMapBlockEnemies())
		{
			return false;
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		if (!location.IsValid())
		{
			return false;
		}
		MapBlockData block = DomainManager.Map.GetBlock(location);
		List<MapTemplateEnemyInfo> templateEnemyList = block.TemplateEnemyList;
		if (templateEnemyList == null || templateEnemyList.Count <= 0)
		{
			return false;
		}
		List<MapTemplateEnemyInfo> mapRandomEnemyGroupForChar = GetMapRandomEnemyGroupForChar(block, EventArgBox.TaiwuCharacterId, avoidRandomEnemy: true);
		if (mapRandomEnemyGroupForChar == null || mapRandomEnemyGroupForChar.Count == 0)
		{
			return false;
		}
		SetMapRandomEnemyListToArgBox(argBox, "EnemyGroup", mapRandomEnemyGroupForChar);
		short templateId = mapRandomEnemyGroupForChar[0].TemplateId;
		if (templateId >= 307 && templateId <= 315 && taiwu.GetFameType() > 1)
		{
			return false;
		}
		if (CanWipeOut(templateId) && !CanAutoWipeOut(templateId))
		{
			return false;
		}
		if (GlobalArgBoxContainsKey<bool>("BattleWithXiangshuMinion") && templateId == 298 && SmallVillageXiangshu(Config.Character.Instance[templateId].OrganizationInfo.OrgTemplateId))
		{
			argBox.Set("EnemyLeader", templateId);
			argBox.Set("NextEventGuid", "a114a545-3e31-49d7-b856-2a8940570a66");
			return true;
		}
		if (MoveRandomEnemyJumpEventGuid.TryGetValue(templateId, out var value))
		{
			argBox.Set("EnemyLeader", templateId);
			argBox.Set("NextEventGuid", CanAutoWipeOut(templateId) ? "c83b76cc-e844-49dd-bdd3-52c45ef93a45" : value);
			return true;
		}
		return false;
	}

	public static string GetTriggeringRandomBeastEventGuid(short enemyLeaderId)
	{
		if (CanWipeOut(enemyLeaderId))
		{
			return "99527a50-a51b-45bd-924a-cb8b10b91c78";
		}
		return enemyLeaderId switch
		{
			210 => "b6d3eb2f-b14a-4bd7-b9a6-7c59fe541390", 
			211 => "e877affa-a263-4856-9499-7d73aa18d5d4", 
			212 => "50d7e804-472a-413b-8a5a-1cbfa5e697ce", 
			213 => "6af7af8c-05dc-4cec-a95c-4f9bd8f48713", 
			214 => "6bd15afb-582f-4f2f-a437-72b9a93a54a2", 
			215 => "03cac70f-52cf-44dc-81d5-d0a831c6ed1a", 
			216 => "da84e74c-7b69-4b40-ad57-5c5dd81bf8bb", 
			217 => "6e13473d-03fa-45c0-83ed-4d9927e89abf", 
			218 => "c121bee9-0aff-44a2-8fe5-6aca0f27d239", 
			219 => "19cccc52-6989-4d95-9037-f45bccf6b09a", 
			220 => "d1ec8917-2add-4801-bf42-bbe3c08e02e0", 
			221 => "e0da94b7-94a7-41ca-be8e-188150fa5c3c", 
			222 => "d5ec35d6-e453-46d2-8fe5-cc5a44d32944", 
			223 => "26e43789-35c6-4f06-a48b-b1f360351f14", 
			224 => "92189a76-df7c-4758-8d8f-8f60f642426a", 
			225 => "53241e52-4492-472b-aa62-b7a7e992352d", 
			226 => "d2a7ce78-ac75-496f-b3b3-4a4352feb9d9", 
			227 => "31a3349e-5246-4b97-be46-8eb990eeb49d", 
			_ => string.Empty, 
		};
	}

	public static string WipeOut(EventArgBox argBox)
	{
		short arg = -1;
		argBox.Get("EnemyLeader", ref arg);
		if (GlobalArgBoxContainsKey<int>("DefeatXiangshuMinion") && (uint)(arg - 304) <= 2u)
		{
			int intFromGlobalArgBox = GetIntFromGlobalArgBox("DefeatXiangshuMinion");
			SaveGlobalArg("DefeatXiangshuMinion", ++intFromGlobalArgBox);
			Log("amount of DefeatXiangshuMinion:" + intFromGlobalArgBox);
		}
		GetMapRandomEnemyListFromArgBox(argBox, "EnemyGroup", out var randEnemyList);
		int arg2 = -1;
		if (argBox.Get("AnimalId", ref arg2) && DomainManager.Extra.TryGetAnimal(arg2, out var animal))
		{
			WipeOutAnimals(new List<GameData.Domains.Character.Animal> { animal });
		}
		else
		{
			List<short> list = new List<short>();
			foreach (MapTemplateEnemyInfo item in randEnemyList)
			{
				list.Add(item.TemplateId);
			}
			DomainManager.Combat.WipeOut(Domain.MainThreadDataContext, list);
			Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
			RemoveMapRandomEnemiesOnBlock(location, randEnemyList);
			MapRandomEnemiesEscapeByCharacter(location, EventArgBox.TaiwuCharacterId);
		}
		SetOnHandlingMonthlyEventBlock(blockOperation: false);
		if (IsExtraTaskInProgress(173) && IsShixiangSettlementEnemyClean())
		{
			argBox.Set("EnemyTemplateId", arg);
			return "1010bcdb-c7eb-4667-a085-efbcdb104135";
		}
		if ((IsExtraTaskInProgress(236) || IsExtraTaskInProgress(405)) && GameData.Domains.Character.Character.IsXiangshuMinion(arg))
		{
			argBox.Set("EnemyTemplateId", arg);
			if (IsRandomEnemyBelongHeavenlyTree(argBox))
			{
				EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(4);
				if (!sectMainStoryEventArgBox.Contains<bool>("ConchShip_PresetKey_WudangKillRandomEnemyTriggered"))
				{
					return "6134ab9d-cb0a-419b-8c07-727997310fa5";
				}
				GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
				HeavenlyTreeGrewUp(character, 20, argBox);
			}
		}
		return string.Empty;
	}

	public static void WipeOutInTravel(EventArgBox argBox)
	{
		short arg = -1;
		argBox.Get("EnemyLeader", ref arg);
		List<short> list = new List<short> { arg };
		CharacterItem characterItem = Config.Character.Instance[arg];
		if (characterItem.MinionGroupId >= 0)
		{
			MinionGroupItem minionGroupItem = MinionGroup.Instance[characterItem.MinionGroupId];
			foreach (short minion in minionGroupItem.Minions)
			{
				list.Add(minion);
			}
		}
		DomainManager.Combat.WipeOut(Domain.MainThreadDataContext, list);
		TravelingEventCollection travelingEventCollection = GetTravelingEventCollection();
		travelingEventCollection.AddTravelBattlePerfectWin(DomainManager.Taiwu.GetTaiwuCharId(), arg);
		SetEventSeriesTexture(string.Empty);
		SetOnHandlingTravelingEventBlock(blockOperation: false);
	}

	public static void TryWipeOutAnimals()
	{
		if (!GlobalDomain.Settings.IsTypeAutoWipeOutOn(WipeOutType.Beast))
		{
			return;
		}
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		if (!DomainManager.Extra.TryGetAnimalsByLocation(location, out var animals))
		{
			return;
		}
		List<GameData.Domains.Character.Animal> list = new List<GameData.Domains.Character.Animal>();
		foreach (GameData.Domains.Character.Animal item in animals)
		{
			if (CanAutoWipeOut(item.CharacterTemplateId))
			{
				list.Add(item);
			}
		}
		WipeOutAnimals(list);
	}

	public static void WipeOutAnimals(List<GameData.Domains.Character.Animal> animals)
	{
		List<short> list = new List<short>();
		foreach (GameData.Domains.Character.Animal animal in animals)
		{
			ProfessionFormulaItem formulaCfg = ProfessionFormula.Instance[9];
			sbyte consummateLevel = Config.Character.Instance[animal.CharacterTemplateId].ConsummateLevel;
			int value = formulaCfg.Calculate(consummateLevel);
			RemoveAnimal(animal);
			list.Add(animal.CharacterTemplateId);
			ChangeProfessionSeniority(1, value);
		}
		DomainManager.Combat.WipeOut(Domain.MainThreadDataContext, list);
	}

	public static bool GetAllowExecute()
	{
		return DomainManager.World.GetAllowExecute();
	}

	[Obsolete]
	public static sbyte GetRoleCombatSkillPracticeLevel(int roleId, short skillId)
	{
		return 100;
	}

	public static sbyte GetRoleCombatSkillDirection(int roleId, short skillId)
	{
		GameData.Domains.CombatSkill.CombatSkill element_CombatSkills = DomainManager.CombatSkill.GetElement_CombatSkills(new CombatSkillKey(roleId, skillId));
		return CombatSkillStateHelper.GetCombatSkillDirection(element_CombatSkills.GetActivationState());
	}

	[Obsolete]
	public static void SetCharCombatSkillPracticeLevel(int charId, short skillId, sbyte practiceLevel)
	{
	}

	public static void ChangeCharBaseCombatSkillQualification(int charId, sbyte skillType, int delta)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		element_Objects.ChangeBaseCombatSkillQualification(Domain.MainThreadDataContext, skillType, delta);
	}

	public unsafe static void SetCharBaseCombatSkillQualification(int charId, sbyte skillType, short qualification)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		CombatSkillShorts baseCombatSkillQualifications = element_Objects.GetBaseCombatSkillQualifications();
		baseCombatSkillQualifications.Items[skillType] = qualification;
		element_Objects.SetBaseCombatSkillQualifications(ref baseCombatSkillQualifications, Domain.MainThreadDataContext);
	}

	public static sbyte GetCharCombatSkillBehaviorType(int charId, short skillId)
	{
		GameData.Domains.CombatSkill.CombatSkill element_CombatSkills = DomainManager.CombatSkill.GetElement_CombatSkills(new CombatSkillKey(charId, skillId));
		return CombatSkillStateHelper.GetActiveOutlinePageType(element_CombatSkills.GetActivationState());
	}

	public static sbyte GetCombatSkillGrade(short skillId)
	{
		return Config.CombatSkill.Instance[skillId].Grade;
	}

	public static List<short> GetCharCombatSkillList(int charId, sbyte type = -1, sbyte sectId = -1, sbyte minGrade = 0, sbyte maxGrade = 8, bool needBreak = false, bool requireTaiwuNotLearnAndRead = false)
	{
		List<short> list = new List<short>();
		list.AddRange(DomainManager.Character.GetElement_Objects(charId).GetLearnedCombatSkills());
		list.RemoveAll(delegate(short skillId)
		{
			CombatSkillItem combatSkillItem = Config.CombatSkill.Instance[skillId];
			GameData.Domains.CombatSkill.CombatSkill element_CombatSkills = DomainManager.CombatSkill.GetElement_CombatSkills(new CombatSkillKey(charId, skillId));
			bool flag = (type >= 0 && combatSkillItem.Type != type) || (sectId >= 0 && combatSkillItem.SectId != sectId) || combatSkillItem.Grade < minGrade || combatSkillItem.Grade > maxGrade || (needBreak && !CombatSkillStateHelper.IsBrokenOut(element_CombatSkills.GetActivationState()));
			if (!flag && requireTaiwuNotLearnAndRead)
			{
				flag = DomainManager.Taiwu.TryGetTaiwuCombatSkill(skillId, out var combatSkill) || DomainManager.Taiwu.TryGetNotLearnCombatSkillReadingProgress(skillId, out combatSkill);
			}
			return flag;
		});
		return list;
	}

	public static bool CheckCharCombatSkill(int charId, short skillId)
	{
		GameData.Domains.CombatSkill.CombatSkill element;
		return DomainManager.CombatSkill.TryGetElement_CombatSkills(new CombatSkillKey(charId, skillId), out element);
	}

	public static List<short> GetMinGradeCombatSkillList(List<short> skillIdList)
	{
		List<short> list = new List<short>();
		sbyte b = sbyte.MaxValue;
		for (int i = 0; i < skillIdList.Count; i++)
		{
			short num = skillIdList[i];
			sbyte grade = Config.CombatSkill.Instance[num].Grade;
			if (grade < b)
			{
				list.Clear();
				list.Add(num);
				b = grade;
			}
			else if (grade == b)
			{
				list.Add(num);
			}
		}
		return list;
	}

	public static short GetCombatSkillId(sbyte type, sbyte sectId, sbyte grade)
	{
		for (int i = 0; i < Config.CombatSkill.Instance.Count; i++)
		{
			CombatSkillItem combatSkillItem = Config.CombatSkill.Instance[i];
			if (combatSkillItem.Type == type && combatSkillItem.SectId == sectId && combatSkillItem.Grade == grade)
			{
				return combatSkillItem.TemplateId;
			}
		}
		return -1;
	}

	public static void LearnCombatSkill(int charId, short skillId)
	{
		DomainManager.Character.LearnCombatSkill(Domain.MainThreadDataContext, charId, skillId, 0);
	}

	public static ItemKey GetCombatSkillBook(int charId, short skillId, sbyte outlinePageType, bool[] pageIsDirect, sbyte completePagesCount = -1)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		byte pageTypes = 0;
		pageTypes = SkillBookStateHelper.SetOutlinePageType(pageTypes, outlinePageType);
		for (byte b = 1; b < 6; b++)
		{
			pageTypes = SkillBookStateHelper.SetNormalPageType(pageTypes, b, (!pageIsDirect[b - 1]) ? ((sbyte)1) : ((sbyte)0));
		}
		ItemKey itemKey = DomainManager.Item.CreateSkillBook(mainThreadDataContext, Config.CombatSkill.Instance[skillId].BookId, pageTypes, completePagesCount, -1);
		DomainManager.Character.GetElement_Objects(charId).AddInventoryItem(mainThreadDataContext, itemKey, 1);
		return itemKey;
	}

	public static void RevokeSectCombatSkill(int charId, sbyte sectId, bool onlyRemoveGradeAboveChar = false)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		List<short> learnedCombatSkills = element_Objects.GetLearnedCombatSkills();
		sbyte grade = element_Objects.GetOrganizationInfo().Grade;
		for (int i = 0; i < learnedCombatSkills.Count; i++)
		{
			short num = learnedCombatSkills[i];
			CombatSkillItem combatSkillItem = Config.CombatSkill.Instance[num];
			if (combatSkillItem.SectId == sectId && (!onlyRemoveGradeAboveChar || combatSkillItem.Grade > grade))
			{
				DomainManager.Character.RevokeCombatSkill(mainThreadDataContext, element_Objects, num);
			}
		}
	}

	public static ItemKey ExchangeSpecialWeaponByCombatSkillIdForTaiwu(short skillTemplateId)
	{
		return DomainManager.Extra.ExchangeSpecialWeaponByCombatSkillIdForTaiwu(Domain.MainThreadDataContext, skillTemplateId);
	}

	public static List<short> FilterDirectCombatSkillOfCharacter(int charId, sbyte equipType = -1, sbyte type = -1, sbyte sectId = -1)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return null;
		}
		List<short> learnedCombatSkills = element.GetLearnedCombatSkills();
		List<short> list = new List<short>();
		for (int i = 0; i < learnedCombatSkills.Count; i++)
		{
			short num = learnedCombatSkills[i];
			if (DomainManager.CombatSkill.GetSkillDirection(charId, num) == 0)
			{
				CombatSkillItem item = Config.CombatSkill.Instance.GetItem(num);
				if ((equipType < 0 || item.EquipType == equipType) && (type < 0 || item.Type == type) && (sectId < 0 || item.SectId == sectId))
				{
					list.Add(num);
				}
			}
		}
		return list;
	}

	public static List<short> GetNorLearnCombatSkillList(int charId, sbyte grade, sbyte type = -1, sbyte sectId = -1)
	{
		List<short> list = new List<short>();
		List<short> learnedCombatSkills = DomainManager.Character.GetElement_Objects(charId).GetLearnedCombatSkills();
		for (int i = 0; i < Config.CombatSkill.Instance.Count; i++)
		{
			CombatSkillItem combatSkillItem = Config.CombatSkill.Instance[i];
			if (combatSkillItem.Grade == grade && combatSkillItem.BookId > 0 && (type < 0 || combatSkillItem.Type == type) && (sectId < 0 || combatSkillItem.SectId == sectId) && !learnedCombatSkills.Contains(combatSkillItem.TemplateId))
			{
				list.Add(combatSkillItem.TemplateId);
			}
		}
		return list;
	}

	public static (ItemKey, byte, byte, byte) GetTeachCombatSkillBook(int charId, short combatSkillTemplateId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(charId);
		short bookId = Config.CombatSkill.Instance[combatSkillTemplateId].BookId;
		ushort readingState = charCombatSkills[combatSkillTemplateId].GetReadingState();
		byte b = CombatSkillStateHelper.GeneratePageTypesFromReadingState(mainThreadDataContext.Random, readingState);
		byte b2 = 0;
		while (b2 < 15 && !CombatSkillStateHelper.IsPageRead(readingState, b2))
		{
			b2++;
		}
		ItemKey item = DomainManager.Item.CreateDemandedSkillBook(mainThreadDataContext, bookId, b2, b);
		GameData.Domains.Item.SkillBook element_SkillBooks = DomainManager.Item.GetElement_SkillBooks(item.Id);
		return (item, b2, b, element_SkillBooks.GetPageTypes());
	}

	public static List<short> GetTeachTaiwuCombatSkillList(int charId)
	{
		GameData.Utilities.ShortList value;
		return DomainManager.Taiwu.TryGetElement_TeachTaiwuCombatSkillDict(charId, out value) ? value.Items : null;
	}

	public static void ClearTeachTaiwuCombatSkillList(int charId)
	{
		DomainManager.Taiwu.ClearTeachTaiwuCombatSkillList(Domain.MainThreadDataContext, charId);
	}

	public static void AddTeachTaiwuCombatSkill(int charId, short skillId)
	{
		DomainManager.Taiwu.AddTeachTaiwuCombatSkill(Domain.MainThreadDataContext, charId, skillId);
	}

	[Obsolete]
	public static sbyte GetLearnCombatSkillPracticeLevel(short combatSkillTemplateId)
	{
		return 0;
	}

	public static string LearnTargetCombatSkillDependSectApprovingRate(sbyte combatSkillType, EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		sbyte orgTemplateId = character2.GetOrganizationInfo().OrgTemplateId;
		List<short> charCombatSkillList = GetCharCombatSkillList(character2.GetId(), combatSkillType, orgTemplateId, 0, 8, needBreak: false, requireTaiwuNotLearnAndRead: true);
		if (charCombatSkillList == null || charCombatSkillList.Count == 0)
		{
			return argBox.GetString("CombatSkillNoneTeachEventGuid");
		}
		short num = GetMinGradeCombatSkillList(charCombatSkillList).Sample();
		sbyte b = (sbyte)Math.Max(0, GetSectApprovingRate(orgTemplateId) / 100 - 1);
		sbyte combatSkillGrade = GetCombatSkillGrade(num);
		List<short> charCombatSkillList2 = GetCharCombatSkillList(character.GetId(), combatSkillType, orgTemplateId, 0, 8);
		if (combatSkillGrade > b)
		{
			argBox.Set("CantTeachCombat", num);
			return argBox.GetString("CombatSkillBeyondApprovingEventGuid");
		}
		if (GetCombatSkillGrade(num) == 0)
		{
			argBox.Set("TeachCombat", num);
			return argBox.GetString("CombatSkillTeachEventGuid");
		}
		for (sbyte b2 = 0; b2 < combatSkillGrade; b2++)
		{
			short combatSkillId = GetCombatSkillId(combatSkillType, orgTemplateId, b2);
			if (!charCombatSkillList2.Contains(combatSkillId) || !TaiwuCanLearnCombatSkill(combatSkillId))
			{
				argBox.Set("TeachCombatBefore", combatSkillId);
				return argBox.GetString("CombatSkillTeachBeforeEventGuid");
			}
		}
		argBox.Set("TeachCombat", num);
		return argBox.GetString("CombatSkillTeachEventGuid");
	}

	public static void LearnCombatSkillInSectCompetition(GameData.Domains.Character.Character teacher, GameData.Domains.Character.Character student, short combatSkillId)
	{
		sbyte b = GetCharCombatSkillBehaviorType(teacher.GetId(), combatSkillId);
		if (b < 0)
		{
			b = GetRoleBehavior(teacher);
		}
		bool[] array = new bool[5] { true, true, true, true, true };
		sbyte completePagesCount = (sbyte)((13 - GetCombatSkillGrade(combatSkillId)) / 3);
		sbyte b2 = GetRoleCombatSkillDirection(teacher.GetId(), combatSkillId);
		if (b2 == -2)
		{
			b2 = -1;
		}
		short num = GlobalConfig.CombatSkillPageReverseProb[b2 + 1];
		for (int i = 0; i < 5; i++)
		{
			if (GetRandom() < num)
			{
				array[i] = false;
			}
		}
		GetCombatSkillBook(student.GetId(), combatSkillId, b, array, completePagesCount);
		short bookId = Config.CombatSkill.Instance[combatSkillId].BookId;
		ChangeRoleHappiness(student, ItemTemplateHelper.GetBaseHappinessChange(10, bookId) / 2);
		short changeValue = (short)ItemTemplateHelper.GetBaseFavorabilityChange(10, bookId);
		ChangeFavorabilityOptional(student, teacher, changeValue, 3);
		List<short> charCombatSkillList = GetCharCombatSkillList(student.GetId(), -1, -1, 0, 8);
		if (!charCombatSkillList.Contains(combatSkillId))
		{
			LearnCombatSkill(student.GetId(), combatSkillId);
		}
	}

	public static ItemKey TaiwuLearnCombatSkillInSectCompetition(GameData.Domains.Character.Character teacher, short combatSkillTemplateId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		List<short> charCombatSkillList = GetCharCombatSkillList(taiwu.GetId(), -1, -1, 0, 8);
		if (!charCombatSkillList.Contains(combatSkillTemplateId))
		{
			LearnCombatSkill(EventArgBox.TaiwuCharacterId, combatSkillTemplateId);
		}
		sbyte outlinePageType = (sbyte)GetRandom(0, 5);
		bool[] array = new bool[5] { true, true, true, true, true };
		for (int i = 0; i < 5; i++)
		{
			if (GetRandom() < GlobalConfig.CombatSkillPageReverseProb[0])
			{
				array[i] = false;
			}
		}
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		ProfessionFormulaItem formulaCfg = ProfessionFormula.Instance[50];
		int baseDelta = formulaCfg.Calculate(Config.CombatSkill.Instance[combatSkillTemplateId].Grade);
		DomainManager.Extra.ChangeProfessionSeniority(mainThreadDataContext, 7, baseDelta);
		return GetCombatSkillBook(EventArgBox.TaiwuCharacterId, combatSkillTemplateId, outlinePageType, array, 5);
	}

	public static ItemKey LearnCombatSkillFromNpc(GameData.Domains.Character.Character character, short combatSkillId)
	{
		LearnCombatSkill(EventArgBox.TaiwuCharacterId, combatSkillId);
		sbyte completePagesCount = (sbyte)((13 - GetCombatSkillGrade(combatSkillId)) / 3);
		sbyte roleBehavior = GetRoleBehavior(character);
		bool[] array = new bool[5] { true, true, true, true, true };
		sbyte b = GetRoleCombatSkillDirection(character.GetId(), combatSkillId);
		if (b == -2)
		{
			b = -1;
		}
		short num = GlobalConfig.CombatSkillPageReverseProb[b + 1];
		for (int i = 0; i < 5; i++)
		{
			if (GetRandom() < num)
			{
				array[i] = false;
			}
		}
		ItemKey combatSkillBook = GetCombatSkillBook(EventArgBox.TaiwuCharacterId, combatSkillId, roleBehavior, array, completePagesCount);
		AddTeachTaiwuCombatSkill(character.GetId(), combatSkillId);
		short bookId = Config.CombatSkill.Instance[combatSkillId].BookId;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		Location location = taiwu.GetLocation();
		lifeRecordCollection.AddRequestInstructionOnCombatSkillSucceed(taiwu.GetId(), currDate, character.GetId(), location, 10, Config.CombatSkill.Instance[combatSkillId].BookId, 1);
		ChangeRoleHappiness(taiwu, ItemTemplateHelper.GetBaseHappinessChange(10, bookId) / 2);
		short changeValue = (short)ItemTemplateHelper.GetBaseFavorabilityChange(10, bookId);
		ChangeFavorabilityOptional(taiwu, character, changeValue, 3);
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		ProfessionFormulaItem formulaCfg = ProfessionFormula.Instance[50];
		int baseDelta = formulaCfg.Calculate(Config.CombatSkill.Instance[combatSkillId].Grade);
		DomainManager.Extra.ChangeProfessionSeniority(mainThreadDataContext, 7, baseDelta);
		return combatSkillBook;
	}

	public static bool TaiwuCanLearnCombatSkill(short templateId)
	{
		GameData.Domains.CombatSkill.CombatSkill element_CombatSkills = DomainManager.CombatSkill.GetElement_CombatSkills(new CombatSkillKey(DomainManager.Taiwu.GetTaiwuCharId(), templateId));
		return CombatSkillStateHelper.GetReadNormalPagesCount(element_CombatSkills.GetReadingState()) >= 3;
	}

	public static bool XuannvTaiwuCanLearnCombatSkill(short templateId)
	{
		GameData.Domains.CombatSkill.CombatSkill element_CombatSkills = DomainManager.CombatSkill.GetElement_CombatSkills(new CombatSkillKey(DomainManager.Taiwu.GetTaiwuCharId(), templateId));
		return CombatSkillStateHelper.IsBrokenOut(element_CombatSkills.GetActivationState());
	}

	public static string MartialArtTournamentTeachCombatSkill(EventArgBox argBox, sbyte combatSkillType)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		sbyte orgTemplateId = character2.GetOrganizationInfo().OrgTemplateId;
		List<short> charCombatSkillList = GetCharCombatSkillList(character2.GetId(), combatSkillType, orgTemplateId, 0, 8, needBreak: false, requireTaiwuNotLearnAndRead: true);
		if (charCombatSkillList == null || charCombatSkillList.Count == 0)
		{
			return "9c406637-b6b7-40f0-b43d-4f5090df8d8d";
		}
		short num = GetMinGradeCombatSkillList(charCombatSkillList)[0];
		sbyte b = (sbyte)Math.Max(0, GetSectApprovingRate(orgTemplateId) / 100 - 1);
		sbyte combatSkillGrade = GetCombatSkillGrade(num);
		List<short> charCombatSkillList2 = GetCharCombatSkillList(character.GetId(), combatSkillType, orgTemplateId, 0, 8);
		if (combatSkillGrade > b)
		{
			argBox.Set("CantTeachCombat", num);
			return "a26405b7-1714-4ddf-8c85-6e774e04eb29";
		}
		if (GetCombatSkillGrade(num) == 0)
		{
			argBox.Set("TeachCombat", num);
			return "2885a46f-6727-4ae1-baae-3512849b443a";
		}
		for (sbyte b2 = 0; b2 < combatSkillGrade; b2++)
		{
			short combatSkillId = GetCombatSkillId(combatSkillType, orgTemplateId, b2);
			if (!charCombatSkillList2.Contains(combatSkillId) || !TaiwuCanLearnCombatSkill(combatSkillId))
			{
				argBox.Set("TeachCombatBefore", combatSkillId);
				return "c76a1871-e087-4009-b557-91ce2177defe";
			}
		}
		argBox.Set("TeachCombat", num);
		return "2885a46f-6727-4ae1-baae-3512849b443a";
	}

	public static bool CanPerformIdentityExtendFavor(sbyte resourceType, int charId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		return taiwu.GetResource(resourceType) >= IdentityExtendFavorResourceCost;
	}

	public static int CalcIdentityExtendFavorValue(sbyte resourceType, int charId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		Settlement settlement = DomainManager.Organization.GetSettlement(element_Objects.GetOrganizationInfo().SettlementId);
		MapAreaData areaByAreaId = DomainManager.Map.GetAreaByAreaId(settlement.GetLocation().AreaId);
		MapAreaItem config = areaByAreaId.GetConfig();
		short templateId = config.TemplateId;
		int num;
		if (templateId >= 1 && templateId <= 15)
		{
			num = GlobalConfig.Instance.ExtendFavorSafetyAndCultureAreaFactor[0];
		}
		else
		{
			sbyte[] organizationId = config.OrganizationId;
			num = ((organizationId == null || organizationId.Length <= 0 || !Config.Organization.Instance[config.OrganizationId[0]].IsSect) ? GlobalConfig.Instance.ExtendFavorSafetyAndCultureAreaFactor[2] : GlobalConfig.Instance.ExtendFavorSafetyAndCultureAreaFactor[1]);
		}
		return (150 + element_Objects.GetFame()) * num / 10;
	}

	public static void PerformIdentityExtendFavor(sbyte resourceType, int charId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		taiwu.ChangeResource(mainThreadDataContext, resourceType, -IdentityExtendFavorResourceCost);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		Settlement settlement = DomainManager.Organization.GetSettlement(element_Objects.GetOrganizationInfo().SettlementId);
		MapAreaData areaByAreaId = DomainManager.Map.GetAreaByAreaId(settlement.GetLocation().AreaId);
		DomainManager.Extra.ChangeAreaSpiritualDebt(mainThreadDataContext, areaByAreaId.GetAreaId(), CalcIdentityExtendFavorValue(resourceType, charId));
	}

	public static bool CanPerformIdentityMakeLineAndBridge(int charId, int targetId, bool isIncrease)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		return taiwu.GetResource(7) >= IdentityMakeLineAndBridgeAuthorityCost;
	}

	public static HashSet<int> CalcIdentityMakeLineAndBridgeTargetCharacterIds(int charId)
	{
		CharacterDomain domainCharacter = DomainManager.Character;
		MapDomain domainMap = DomainManager.Map;
		OrganizationDomain domainOrg = DomainManager.Organization;
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		GameData.Domains.Character.Character element_Objects = domainCharacter.GetElement_Objects(charId);
		sbyte stateId = domainMap.GetStateIdByAreaId(domainOrg.GetSettlement(element_Objects.GetOrganizationInfo().SettlementId).GetLocation().AreaId);
		HashSet<int> hashSet = new HashSet<int>();
		domainCharacter.GetRelatedCharacters(taiwuCharId).GetAllRelatedCharIds(hashSet);
		hashSet.Remove(taiwuCharId);
		hashSet.Remove(charId);
		hashSet.RemoveWhere(delegate(int id)
		{
			if (!domainCharacter.TryGetElement_Objects(id, out var element))
			{
				return false;
			}
			OrganizationInfo organizationInfo = element.GetOrganizationInfo();
			if (organizationInfo.SettlementId < 0)
			{
				return true;
			}
			Location location = domainOrg.GetSettlement(organizationInfo.SettlementId).GetLocation();
			return !location.IsValid() || domainMap.GetStateIdByAreaId(location.AreaId) != stateId;
		});
		hashSet.RemoveWhere((int id) => !IsIntelligentCharacter(id));
		return hashSet;
	}

	public static void PerformIdentityMakeLineAndBridge(int charId, int targetId, bool isIncrease)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		taiwu.ChangeResource(mainThreadDataContext, 7, -IdentityMakeLineAndBridgeAuthorityCost);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(targetId);
		int num = 0;
		num = ((!isIncrease) ? (num + (element_Objects.GetFame() - 150) * 50) : (num + (150 + element_Objects.GetFame()) * 50));
		DomainManager.Character.ChangeFavorabilityOptional(mainThreadDataContext, element_Objects2, taiwu, num, 3);
		DomainManager.Character.AddFavorabilityChangeInstantNotification(element_Objects2, taiwu, num > 0);
	}

	public static bool CanPerformIdentitySafetyAndCulture(int charId, bool isSafetyElseCulture, bool isIncrease)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		Settlement settlement = DomainManager.Organization.GetSettlement(element_Objects.GetOrganizationInfo().SettlementId);
		if (isIncrease)
		{
			if (isSafetyElseCulture)
			{
				if (settlement.GetSafety() >= settlement.GetMaxSafety())
				{
					return false;
				}
			}
			else if (settlement.GetCulture() >= settlement.GetMaxCulture())
			{
				return false;
			}
		}
		else if (isSafetyElseCulture)
		{
			if (settlement.GetSafety() <= 0)
			{
				return false;
			}
		}
		else if (settlement.GetCulture() <= 0)
		{
			return false;
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		return taiwu.GetResource(6) >= IdentitySafetyAndCultureMoneyCost;
	}

	public static void PerformIdentitySafetyAndCulture(int charId, bool isSafetyElseCulture, bool isIncrease)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		taiwu.ChangeResource(mainThreadDataContext, 6, -IdentitySafetyAndCultureMoneyCost);
		Settlement settlement = DomainManager.Organization.GetSettlement(element_Objects.GetOrganizationInfo().SettlementId);
		MapAreaData areaByAreaId = DomainManager.Map.GetAreaByAreaId(settlement.GetLocation().AreaId);
		MapAreaItem config = areaByAreaId.GetConfig();
		short templateId = config.TemplateId;
		int num;
		if (templateId >= 1 && templateId <= 15)
		{
			num = GlobalConfig.Instance.ExtendFavorSafetyAndCultureAreaFactor[0];
		}
		else
		{
			sbyte[] organizationId = config.OrganizationId;
			num = ((organizationId == null || organizationId.Length <= 0 || !Config.Organization.Instance[config.OrganizationId[0]].IsSect) ? GlobalConfig.Instance.ExtendFavorSafetyAndCultureAreaFactor[2] : GlobalConfig.Instance.ExtendFavorSafetyAndCultureAreaFactor[1]);
		}
		int num2 = 0;
		num2 = ((!isIncrease) ? (num2 + (element_Objects.GetFame() - 150) * num / 100) : (num2 + (150 + element_Objects.GetFame()) * num / 100));
		InstantNotificationCollection instantNotificationCollection = DomainManager.World.GetInstantNotificationCollection();
		if (isSafetyElseCulture)
		{
			settlement.SetSafety((short)Math.Clamp(settlement.GetSafety() + num2, 0, settlement.GetMaxSafety()), mainThreadDataContext);
			if (isIncrease)
			{
				instantNotificationCollection.AddSecurityUp(settlement.GetId(), num2);
			}
			else
			{
				instantNotificationCollection.AddSecurityDown(settlement.GetId(), -num2);
			}
		}
		else
		{
			settlement.SetCulture((short)Math.Clamp(settlement.GetCulture() + num2, 0, settlement.GetMaxCulture()), mainThreadDataContext);
			if (isIncrease)
			{
				instantNotificationCollection.AddCultureUp(settlement.GetId(), num2);
			}
			else
			{
				instantNotificationCollection.AddCultureDown(settlement.GetId(), -num2);
			}
		}
	}

	public static bool CanPerformIdentityPoemAndImage(int charId, int targetId, bool isIncrease)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		return taiwu.GetResource(7) >= IdentityPoemAndImageAuthorityCost;
	}

	public static void PerformIdentityPoemAndImage(int charId, int targetId, bool isIncrease)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		taiwu.ChangeResource(mainThreadDataContext, 7, -IdentityPoemAndImageAuthorityCost);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(targetId);
		int num = element_Objects.GetMaxLifeSkillAttainment() / 10;
		if (!isIncrease)
		{
			num *= -1;
		}
		element_Objects2.ChangeHappiness(mainThreadDataContext, num);
		if (num != 0)
		{
			InstantNotificationCollection instantNotificationCollection = DomainManager.World.GetInstantNotificationCollection();
			if (isIncrease)
			{
				instantNotificationCollection.AddHappinessIncreased(targetId);
			}
			else
			{
				instantNotificationCollection.AddHappinessDecreased(targetId);
			}
		}
	}

	public static bool CanPerformIdentityMoneyCharity(int charId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		return taiwu.GetResource(6) >= IdentityMoneyCharityMoneyCost;
	}

	public static void PerformIdentityMoneyCharity(int charId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		taiwu.ChangeResource(mainThreadDataContext, 6, -IdentityMoneyCharityMoneyCost);
		Settlement settlement = DomainManager.Organization.GetSettlement(element_Objects.GetOrganizationInfo().SettlementId);
		MapAreaData areaByAreaId = DomainManager.Map.GetAreaByAreaId(settlement.GetLocation().AreaId);
		DomainManager.Extra.ChangeAreaSpiritualDebt(mainThreadDataContext, areaByAreaId.GetAreaId(), 10);
	}

	public static void PerformIdentityMerchantPraise(int charId, sbyte merchantType)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		Settlement settlement = DomainManager.Organization.GetSettlement(element_Objects.GetOrganizationInfo().SettlementId);
		MapAreaData areaByAreaId = DomainManager.Map.GetAreaByAreaId(settlement.GetLocation().AreaId);
		MapAreaItem config = areaByAreaId.GetConfig();
		int num;
		if (config.TemplateId >= 1 && config.TemplateId <= 15)
		{
			num = 20;
		}
		else
		{
			sbyte[] organizationId = config.OrganizationId;
			num = ((organizationId == null || organizationId.Length <= 0 || !Config.Organization.Instance[config.OrganizationId[0]].IsSect) ? 5 : 10);
		}
		int delta = (150 + element_Objects.GetFame()) * 50 * num / 5;
		ChangeMerchantFavorability(merchantType, delta);
		DomainManager.Extra.ChangeAreaSpiritualDebt(mainThreadDataContext, areaByAreaId.GetAreaId(), -InteractionEventOption.Instance[(short)130].SpiritualDebtCost);
		DomainManager.Merchant.RefreshCaravanInTaiwuState(mainThreadDataContext);
	}

	public unsafe static void PerformIdentityFixLandResource(int charId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		Settlement settlement = DomainManager.Organization.GetSettlement(element_Objects.GetOrganizationInfo().SettlementId);
		MapAreaData areaByAreaId = DomainManager.Map.GetAreaByAreaId(settlement.GetLocation().AreaId);
		List<MapBlockData> list = new List<MapBlockData>();
		MapBlockData block = DomainManager.Map.GetBlock(settlement.GetLocation());
		Span<MapBlockData> areaBlocks = DomainManager.Map.GetAreaBlocks(areaByAreaId.GetAreaId());
		for (int i = 0; i < areaBlocks.Length; i++)
		{
			MapBlockData mapBlockData = areaBlocks[i];
			if (mapBlockData.BelongBlockId == block.BlockId)
			{
				list.Add(mapBlockData);
			}
		}
		if (list.Count > 1)
		{
			CollectionUtils.Shuffle(mainThreadDataContext.Random, list);
			list.RemoveRange(0, list.Count / 2);
		}
		foreach (MapBlockData item in list)
		{
			for (sbyte b = 0; b < 6; b++)
			{
				short num = item.MaxResources.Items[b];
				item.CurrResources.Items[b] = (short)Math.Clamp(item.CurrResources.Items[b] + num * 33 / 100, 0, num);
			}
			DomainManager.Map.SetBlockData(mainThreadDataContext, item);
		}
		DomainManager.Extra.ChangeAreaSpiritualDebt(mainThreadDataContext, areaByAreaId.GetAreaId(), -InteractionEventOption.Instance[(short)131].SpiritualDebtCost);
	}

	public static int RequiredAreaDebtToPerformGiveExchangeTool(int charId, List<ItemKey> itemKeys)
	{
		ItemKey itemKey = itemKeys[0];
		sbyte grade = ItemTemplateHelper.GetGrade(itemKey.ItemType, itemKey.TemplateId);
		return GameData.Domains.Extra.SharedMethods.GetExchangeToolSpiritualDebtCost(grade);
	}

	public static void PerformGiveExchangeTool(int charId, List<ItemKey> itemKeys)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		taiwu.RemoveInventoryItemList(mainThreadDataContext, itemKeys, deleteItem: true);
		ItemKey itemKey = itemKeys[0];
		ItemKey itemKey2 = CreateItem(itemKey.ItemType, itemKey.TemplateId);
		short baseMaxDurability = ItemTemplateHelper.GetBaseMaxDurability(itemKey2.ItemType, itemKey2.TemplateId);
		ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey2);
		baseItem.SetMaxDurability(baseMaxDurability, Domain.MainThreadDataContext);
		baseItem.SetCurrDurability(baseMaxDurability, Domain.MainThreadDataContext);
		AddInventoryItem(taiwu, itemKey2);
		Settlement settlement = DomainManager.Organization.GetSettlement(element_Objects.GetOrganizationInfo().SettlementId);
		MapAreaData areaByAreaId = DomainManager.Map.GetAreaByAreaId(settlement.GetLocation().AreaId);
		DomainManager.Extra.ChangeAreaSpiritualDebt(mainThreadDataContext, areaByAreaId.GetAreaId(), -RequiredAreaDebtToPerformGiveExchangeTool(charId, itemKeys));
		ShowGetItemPageForSingleItem(itemKey2);
	}

	private static string GiveExchangeToolSelectionKey(int index)
	{
		return $"ToolKey{index}";
	}

	public static void TaiwuSelectItemForGiveExchangeTool(EventArgBox argBox)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		if (!argBox.Get("SelectItemInfo", out EventSelectItemData arg))
		{
			arg = new EventSelectItemData();
			argBox.Set("SelectItemInfo", (ISerializableGameData)(object)arg);
		}
		EventSelectItemData eventSelectItemData = arg;
		if (eventSelectItemData.CanSelectItemList == null)
		{
			eventSelectItemData.CanSelectItemList = new List<ItemDisplayData>();
		}
		eventSelectItemData = arg;
		if (eventSelectItemData.FilterList == null)
		{
			eventSelectItemData.FilterList = new List<SelectItemFilter>();
		}
		arg.ItemOperationType = 9;
		for (int i = 0; i < GiveExchangeToolAmount; i++)
		{
			SelectItemFilter item = new SelectItemFilter
			{
				FilterTemplateId = -1,
				DisplayDataFilterId = 0,
				Key = GiveExchangeToolSelectionKey(i)
			};
			arg.FilterList.Add(item);
		}
		List<(ItemKey, int)> items = new List<(ItemKey, int)>();
		taiwu.FindItems((ItemBase _) => true, items, searchInventory: true, searchEquipment: false);
		List<ItemDisplayData> itemDisplayData = CharacterDomain.GetItemDisplayData(taiwu.GetId(), items, ItemSourceType.Inventory);
		foreach (ItemDisplayData itemDisplayData2 in itemDisplayData)
		{
			if (!arg.CanSelectItemList.Exists((ItemDisplayData d) => d.Key.Equals(itemDisplayData2.Key)) && itemDisplayData2.Key.ItemType == 6)
			{
				arg.CanSelectItemList.Add(itemDisplayData2);
			}
		}
	}

	public static List<ItemKey> GetGiveExchangeToolSelections(EventArgBox argBox)
	{
		List<ItemKey> list = new List<ItemKey>();
		for (int i = 0; i < GiveExchangeToolAmount; i++)
		{
			if (argBox.Get<ItemKey>(GiveExchangeToolSelectionKey(i), out ItemKey arg))
			{
				list.Add(arg);
			}
		}
		return list;
	}

	public static void StartFixItem(EventArgBox argBox)
	{
		SelectCharacterItemRequest(filter: new SelectItemFilter
		{
			DisplayDataFilterId = 1,
			Key = "RepairKey"
		}, charId: EventArgBox.TaiwuCharacterId, argBox: argBox);
		argBox.Get("SelectItemInfo", out EventSelectItemData arg);
		arg.ItemOperationType = 10;
	}

	public static EventArgBox GetDlcArgBox()
	{
		return DomainManager.Extra.DlcArgBox;
	}

	public static void SaveDlcArgBox()
	{
		DomainManager.Extra.SaveDlcArgBox(Domain.MainThreadDataContext);
	}

	public static EventArgBox GetDreamBackDlcEventArgBox()
	{
		return DomainManager.Extra.GetDreamBackDlcEventArgBoxPublic();
	}

	public static bool IsDlcYearOfHorseClothCanEnter()
	{
		if (!IsHappyNewYar2026DlcInstalled())
		{
			return false;
		}
		if (DomainManager.World.GetMainStoryLineProgress() < 1)
		{
			return false;
		}
		if (GetBoolFromGlobalArgBox("ConchShip_PresetKey_FuyuHiltGuiding"))
		{
			return false;
		}
		return !GetDlcArgBoxBool(HappyNewYear2026Constants.ClothGetFlag);
	}

	public static void AddDlcYearOfHorseCloth(string afterEvent, EventArgBox argBox)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		List<(ItemKey, int)> list = new List<(ItemKey, int)>();
		if (!GetDlcArgBoxBool(HappyNewYear2026Constants.ClothGetFlag))
		{
			ItemKey itemKey = CreateItem(3, 95);
			list.Add((itemKey, 1));
			AddInventoryItem(taiwu, itemKey);
			InstantNotificationCollection instantNotifications = DomainManager.World.GetInstantNotifications();
			instantNotifications.AddGetItem(taiwu.GetId(), itemKey.ItemType, itemKey.TemplateId);
		}
		bool arg = false;
		argBox.Get("DefaultHandleFlag", ref arg);
		if (!arg)
		{
			ShowGetItemPageForItems(list, afterEvent, argBox);
		}
	}

	public static void OnExitDlcYearOfHorseCloth()
	{
		EventArgBox dlcArgBox = GetDlcArgBox();
		dlcArgBox.Set(HappyNewYear2026Constants.ClothGetFlag, arg: true);
		SaveDlcArgBox();
	}

	public static bool GetDlcArgBoxBool(string key)
	{
		return GetDlcArgBox().GetBool(key) || GetDreamBackDlcEventArgBox().GetBool(key);
	}

	public static bool IsDlcYearOfSnakeClothCanEnter()
	{
		if (!IsYearOfSnakeClothInstalled())
		{
			return false;
		}
		if (GetBoolFromGlobalArgBox("ConchShip_PresetKey_FuyuHiltGuiding"))
		{
			return false;
		}
		return !GetDlcArgBoxBool(YearOfSnakeClothConstants.ClothGetFlag) || !GetDlcArgBoxBool(YearOfSnakeClothConstants.ClothGetFlagExtra);
	}

	public static void AddDlcYearOfSnakeCloth(string afterEvent, EventArgBox argBox)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		List<(ItemKey, int)> list = new List<(ItemKey, int)>();
		if (!GetDlcArgBoxBool(YearOfSnakeClothConstants.ClothGetFlag))
		{
			ItemKey itemKey = CreateItem(3, 92);
			list.Add((itemKey, 1));
			AddInventoryItem(taiwu, itemKey);
		}
		if (!GetDlcArgBoxBool(YearOfSnakeClothConstants.ClothGetFlagExtra))
		{
			ItemKey itemKey2 = CreateItem(3, 93);
			ItemKey itemKey3 = CreateItem(3, 94);
			list.Add((itemKey2, 1));
			list.Add((itemKey3, 1));
			AddInventoryItem(taiwu, itemKey2);
			AddInventoryItem(taiwu, itemKey3);
		}
		ShowGetItemPageForItems(list, afterEvent, argBox);
	}

	public static void OnExitDlcYearOfSnakeCloth()
	{
		EventArgBox dlcArgBox = GetDlcArgBox();
		dlcArgBox.Set(YearOfSnakeClothConstants.ClothGetFlag, arg: true);
		dlcArgBox.Set(YearOfSnakeClothConstants.ClothGetFlagExtra, arg: true);
		SaveDlcArgBox();
	}

	public static void TriggerExtraTask(int taskChainId, int taskInfoId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.TriggerExtraTask(mainThreadDataContext, taskChainId, taskInfoId);
	}

	public static void FinishExtraTask(int taskChainId, int taskInfoId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.FinishTriggeredExtraTask(mainThreadDataContext, taskChainId, taskInfoId);
	}

	public static void FinishAllTaskInChain(int taskChainId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.FinishAllTaskInChain(mainThreadDataContext, taskChainId);
	}

	public static bool IsExtraTaskInProgress(int taskInfoId)
	{
		return DomainManager.Extra.IsExtraTaskInProgress(taskInfoId);
	}

	public static bool IsExtraTaskChainInProgress(int taskChainId)
	{
		return DomainManager.Extra.IsExtraTaskChainInProgress(taskChainId);
	}

	public static int GetExtraTaskChainCurrentTask(int taskChainId)
	{
		return DomainManager.Extra.GetExtraTaskChainCurrentTask(taskChainId);
	}

	public static ItemKey AddEquipmentItemToRole(GameData.Domains.Character.Character character, sbyte itemType, short itemTemplateId, short equipmentEffectId = -1, bool tryEquipOn = true)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		ItemKey itemKey = DomainManager.Item.CreateItem(mainThreadDataContext, itemType, itemTemplateId);
		EquipmentBase baseEquipment = DomainManager.Item.GetBaseEquipment(itemKey);
		if (equipmentEffectId >= 0)
		{
			if (equipmentEffectId == 54)
			{
				short num = (short)(baseEquipment.GetMaxDurability() * 2);
				baseEquipment.SetMaxDurability(num, mainThreadDataContext);
				baseEquipment.SetCurrDurability(num, mainThreadDataContext);
			}
			baseEquipment.SetEquipmentEffectId(equipmentEffectId, mainThreadDataContext);
		}
		AddInventoryItem(character, itemKey);
		if (tryEquipOn)
		{
			ItemKey[] equipment = character.GetEquipment();
			bool flag = false;
			sbyte equipmentType = baseEquipment.GetEquipmentType();
			sbyte[] array = EquipmentSlot.EquipmentType2Slots[equipmentType];
			for (int i = 0; i < array.Length; i++)
			{
				if (!equipment[array[i]].IsValid())
				{
					character.ChangeEquipment(Domain.MainThreadDataContext, -1, array[i], itemKey);
					flag = true;
				}
				if (flag)
				{
					break;
				}
			}
		}
		return itemKey;
	}

	public static ItemKey AddItemToRole(GameData.Domains.Character.Character character, sbyte itemType, short itemTemplateId, int amount, short currDurability = -1)
	{
		if (character == null)
		{
			throw new Exception("null character to add item");
		}
		ItemKey itemKey = DomainManager.Item.CreateItem(Domain.MainThreadDataContext, itemType, itemTemplateId);
		AddInventoryItem(character, itemKey, amount);
		if (currDurability >= 0)
		{
			List<(ItemKey, int)> list = new List<(ItemKey, int)>();
			CharacterItemFilterWrappers.FindByTemplateId(character, itemType, itemTemplateId, list, searchInventory: true, searchEquipment: false);
			DomainManager.Item.GetBaseItem(list[0].Item1).SetCurrDurability(currDurability, Domain.MainThreadDataContext);
		}
		AddSeniorityOnFindMaterialAdventure(itemKey);
		return itemKey;
	}

	public static ItemKey AddItemToRole(GameData.Domains.Character.Character character, ItemKey itemKey, int amount, short currDurability = -1)
	{
		if (character == null)
		{
			throw new Exception("null character to add item");
		}
		AddInventoryItem(character, itemKey, amount);
		if (currDurability >= 0)
		{
			List<(ItemKey, int)> list = new List<(ItemKey, int)>();
			CharacterItemFilterWrappers.FindByTemplateId(character, itemKey.ItemType, itemKey.TemplateId, list, searchInventory: true, searchEquipment: false);
			DomainManager.Item.GetBaseItem(list[0].Item1).SetCurrDurability(currDurability, Domain.MainThreadDataContext);
		}
		AddSeniorityOnFindMaterialAdventure(itemKey);
		return itemKey;
	}

	public static ItemKey CreateItem(sbyte itemType, short itemTemplateId)
	{
		return DomainManager.Item.CreateItem(Domain.MainThreadDataContext, itemType, itemTemplateId);
	}

	public static ItemKey AddRandomMedicineToRole(GameData.Domains.Character.Character character, short itemSubType, int amount, sbyte expectedGrade = -1)
	{
		Tester.Assert(ItemSubType.GetType(itemSubType) == 8);
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		IRandomSource random = Domain.MainThreadDataContext.Random;
		if (expectedGrade < 0)
		{
			expectedGrade = (sbyte)random.Next(8);
		}
		sbyte generatedGrade = ItemDomain.GenerateRandomItemGrade(random, expectedGrade);
		generatedGrade = ItemDomain.GetRandomMedicineGrade(generatedGrade);
		short randomItemIdInSubType = ItemDomain.GetRandomItemIdInSubType(random, itemSubType, generatedGrade);
		ItemKey itemKey = DomainManager.Item.CreateMedicine(mainThreadDataContext, randomItemIdInSubType);
		AddInventoryItem(character, itemKey, amount);
		return itemKey;
	}

	public static ItemKey GetRandomItemByGrade(sbyte grade, short itemSubType = -1)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		return DomainManager.Building.GetRandomItemByGrade(mainThreadDataContext.Random, grade, itemSubType);
	}

	public static ItemKey GetRandomItemByGradeAndSubType(sbyte grade, List<short> itemSubTypeList)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		if (itemSubTypeList == null || itemSubTypeList.Count == 0)
		{
			return ItemKey.Invalid;
		}
		short itemSubType = itemSubTypeList[mainThreadDataContext.Random.Next(itemSubTypeList.Count)];
		return DomainManager.Building.GetRandomItemByGrade(mainThreadDataContext.Random, grade, itemSubType);
	}

	public static ItemKey GetWestRandomItemByGarde(sbyte grade)
	{
		return DomainManager.Building.GetWestRandomItemByGarde(Domain.MainThreadDataContext, grade);
	}

	public static ItemKey GetInventoryItem(GameData.Domains.Character.Character character, sbyte itemType, short itemTemplateId)
	{
		return character.GetInventory().GetInventoryItemKey(itemType, itemTemplateId);
	}

	public static bool InventoryHasItem(GameData.Domains.Character.Character character, ItemKey itemKey)
	{
		Inventory inventory = character.GetInventory();
		foreach (KeyValuePair<ItemKey, int> item in inventory.Items)
		{
			if (item.Key.Equals(itemKey))
			{
				return true;
			}
		}
		return false;
	}

	public static bool InventoryHasItem(GameData.Domains.Character.Character character, sbyte itemType, short templateId)
	{
		Inventory inventory = character.GetInventory();
		foreach (KeyValuePair<ItemKey, int> item in inventory.Items)
		{
			if (item.Key.ItemType == itemType && item.Key.TemplateId == templateId)
			{
				return true;
			}
		}
		return false;
	}

	public static void TransferInventoryItem(GameData.Domains.Character.Character srcChar, GameData.Domains.Character.Character destChar, ItemKey itemKey, int amount = 1)
	{
		DomainManager.Character.TransferInventoryItem(Domain.MainThreadDataContext, srcChar, destChar, itemKey, amount);
	}

	public static void TransferInventoryItemWithDebt(int srcCharId, int destCharId, ItemKey itemKey, int amount, bool changeFavor = false)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character characterById = GetCharacterById(srcCharId);
		GameData.Domains.Character.Character characterById2 = GetCharacterById(destCharId);
		ItemKey[] equipment = characterById.GetEquipment();
		int num = equipment.IndexOf(itemKey);
		if (num >= 0)
		{
			characterById.ChangeEquipment(Domain.MainThreadDataContext, (sbyte)num, -1, ItemKey.Invalid);
		}
		DomainManager.Character.TransferInventoryItem(Domain.MainThreadDataContext, characterById, characterById2, itemKey, amount);
		DomainManager.Character.UpdateDebtByItemTransfer(Domain.MainThreadDataContext, characterById, characterById2, itemKey, amount, changeFavor);
		InteractOfLove.SetLoveTokenHolder(mainThreadDataContext, itemKey, destCharId);
	}

	public unsafe static void TransferResourcesWithDebt(int srcCharId, int destCharId, sbyte resourceType, int amount, bool changeFavor = false)
	{
		Tester.Assert(resourceType >= 0 && resourceType < 8);
		ResourceInts resources = default(ResourceInts);
		resources.Initialize();
		resources.Items[resourceType] = amount;
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character characterById = GetCharacterById(srcCharId);
		GameData.Domains.Character.Character characterById2 = GetCharacterById(destCharId);
		DomainManager.Character.UpdateDebtByResourceTransfer(mainThreadDataContext, characterById, characterById2, resources, changeFavor);
		DomainManager.Character.TransferResource(mainThreadDataContext, characterById, characterById2, ref resources);
	}

	public static void TransferInventoryOrEquipItem(GameData.Domains.Character.Character srcChar, GameData.Domains.Character.Character destChar, ItemKey itemKey, int amount = 1)
	{
		ItemKey[] equipment = srcChar.GetEquipment();
		int num = equipment.IndexOf(itemKey);
		if (num >= 0)
		{
			srcChar.ChangeEquipment(Domain.MainThreadDataContext, (sbyte)num, -1, ItemKey.Invalid);
		}
		TransferInventoryItem(srcChar, destChar, itemKey, amount);
	}

	public static void RemoveInventoryItem(GameData.Domains.Character.Character character, ItemKey itemKey, int amount = 1, bool deleteItem = true)
	{
		if (character == null)
		{
			throw new Exception("Character is null when removing inventory item");
		}
		if (itemKey == ItemKey.Invalid)
		{
			throw new Exception("ItemKey is Invalid");
		}
		character.RemoveInventoryItem(Domain.MainThreadDataContext, itemKey, amount, deleteItem);
	}

	public static void RemoveInventoryOrEquipItem(GameData.Domains.Character.Character character, ItemKey itemKey, int amount = 1, bool deleteItem = true)
	{
		int equipmentsSlotIndex = GetEquipmentsSlotIndex(character, itemKey);
		if (equipmentsSlotIndex >= 0)
		{
			character.ChangeEquipment(Domain.MainThreadDataContext, (sbyte)equipmentsSlotIndex, -1, ItemKey.Invalid);
		}
		Inventory inventory = character.GetInventory();
		if (inventory.Items.ContainsKey(itemKey))
		{
			character.RemoveInventoryItem(Domain.MainThreadDataContext, itemKey, amount, deleteItem);
		}
	}

	public static void AddInventoryItem(GameData.Domains.Character.Character character, ItemKey itemKey, int amount = 1)
	{
		if (character == null)
		{
			throw new Exception("Character is null when adding inventory item");
		}
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		character.AddInventoryItem(mainThreadDataContext, itemKey, amount);
		if (character == DomainManager.Taiwu.GetTaiwu())
		{
			InstantNotificationCollection instantNotifications = DomainManager.World.GetInstantNotifications();
			instantNotifications.AddGetItem(character.GetId(), itemKey.ItemType, itemKey.TemplateId);
		}
	}

	public static void TransformInventoryItem(GameData.Domains.Character.Character fromCharacter, GameData.Domains.Character.Character toCharacter, ItemKey itemKey, int amount = 1)
	{
		if (fromCharacter == null)
		{
			throw new Exception("fromCharacter is null when transform inventory item");
		}
		if (toCharacter == null)
		{
			throw new Exception("toCharacter is null when transform inventory item");
		}
		if (fromCharacter.GetId() != toCharacter.GetId())
		{
			RemoveInventoryItem(fromCharacter, itemKey, amount, deleteItem: false);
			AddInventoryItem(toCharacter, itemKey, amount);
		}
	}

	public static void RemoveItem(ItemKey itemKey)
	{
		DomainManager.Item.RemoveItem(Domain.MainThreadDataContext, itemKey);
	}

	public static ItemKey GetLegendaryBookItem(sbyte combatSkillType)
	{
		return DomainManager.LegendaryBook.GetLegendaryBookItem(combatSkillType);
	}

	public static sbyte GetItemGrade(ItemKey itemKey)
	{
		return ItemTemplateHelper.GetGrade(itemKey.ItemType, itemKey.TemplateId);
	}

	public static short GetItemCurrDurability(ItemKey itemKey)
	{
		return DomainManager.Item.GetBaseItem(itemKey).GetCurrDurability();
	}

	public static void SetItemCurrDurability(ItemKey itemKey, short durability)
	{
		ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey);
		baseItem.SetCurrDurability(durability, Domain.MainThreadDataContext);
		if (baseItem is EquipmentBase equipmentBase && equipmentBase.GetEquippedCharId() >= 0 && DomainManager.Character.TryGetElement_Objects(equipmentBase.GetEquippedCharId(), out var element))
		{
			element.SetEquipment(element.GetEquipment(), Domain.MainThreadDataContext);
		}
	}

	public static short GetItemMaxDurability(ItemKey itemKey)
	{
		return DomainManager.Item.GetBaseItem(itemKey).GetMaxDurability();
	}

	public static int GetRepairItemNeedResourceCount(ItemKey itemKey, short targetDurability = -1)
	{
		return DomainManager.Item.GetRepairItemNeedResourceCount(itemKey, targetDurability);
	}

	public static sbyte GetItemRequireLifeSkillType(ItemKey itemKey)
	{
		return GameData.Domains.Extra.SharedMethods.GetItemRequireLifeSkillType(itemKey);
	}

	public static void AddEatingItem(int charId, ItemKey itemKey)
	{
		DomainManager.Character.AddEatingItem(Domain.MainThreadDataContext, charId, itemKey);
	}

	public static int GetItemFavorabilityChange(ItemKey itemKey)
	{
		return DomainManager.Item.GetBaseItem(itemKey).GetFavorabilityChange();
	}

	public static int GetGiftItemFavorabilityChange(ItemKey itemKey, GameData.Domains.Character.Character character)
	{
		int favorabilityChange = DomainManager.Item.GetBaseItem(itemKey).GetFavorabilityChange();
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		OrganizationItem orgCfg = Config.Organization.Instance[organizationInfo.OrgTemplateId];
		if (DomainManager.Extra.MartialArtistSkill0Useful(orgCfg))
		{
			ProfessionData professionData = DomainManager.Extra.GetProfessionData(3);
			return (int)((float)favorabilityChange + (float)favorabilityChange * ((float)professionData.GetSeniorityFavorAddPercent() / 100f));
		}
		if (DomainManager.Extra.CivilianSkill0Useful(orgCfg))
		{
			ProfessionData professionData2 = DomainManager.Extra.GetProfessionData(10);
			return (int)((float)favorabilityChange + (float)favorabilityChange * ((float)professionData2.GetSeniorityFavorAddPercent() / 100f));
		}
		return favorabilityChange;
	}

	[Obsolete]
	public static void AddSeniorityByGiftItem(short favorChange, GameData.Domains.Character.Character targetChar)
	{
		OrganizationInfo organizationInfo = targetChar.GetOrganizationInfo();
		OrganizationItem orgCfg = Config.Organization.Instance[organizationInfo.OrgTemplateId];
		if (DomainManager.Extra.MartialArtistSkill0Useful(orgCfg) || DomainManager.Extra.CivilianSkill0Useful(orgCfg))
		{
			int value = favorChange / 200;
			OnSkillExecutedAddExpSpecial(value);
		}
	}

	public static sbyte GetItemHappinessChange(ItemKey itemKey)
	{
		return DomainManager.Item.GetBaseItem(itemKey).GetHappinessChange();
	}

	public static short GetCharLovingItemSubType(int charId)
	{
		return DomainManager.Character.GetElement_Objects(charId).GetLovingItemSubType();
	}

	public static void SetCharLovingItemSubTypeRevealed(int charId, bool revealed = true)
	{
		DomainManager.Character.GetElement_Objects(charId).SetLovingItemRevealed(revealed, Domain.MainThreadDataContext);
	}

	public static short GetCharHatingItemSubType(int charId)
	{
		return DomainManager.Character.GetElement_Objects(charId).GetHatingItemSubType();
	}

	public static void SetCharHatingItemSubTypeRevealed(int charId, bool revealed = true)
	{
		DomainManager.Character.GetElement_Objects(charId).SetHatingItemRevealed(revealed, Domain.MainThreadDataContext);
	}

	public static bool ConfiscateMaxGradeItem(int charId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		OrganizationInfo organizationInfo = element_Objects.GetOrganizationInfo();
		if (!OrganizationDomain.IsSect(organizationInfo.OrgTemplateId) || organizationInfo.SettlementId < 0)
		{
			return false;
		}
		List<ItemKey> list = ObjectPool<List<ItemKey>>.Instance.Get();
		ItemKey maxGradeItemToLose = element_Objects.GetMaxGradeItemToLose(mainThreadDataContext.Random);
		list.Clear();
		if (maxGradeItemToLose.IsValid())
		{
			list.Add(maxGradeItemToLose);
		}
		Settlement settlement = DomainManager.Organization.GetSettlement(organizationInfo.SettlementId);
		settlement.ConfiscateItem(mainThreadDataContext, element_Objects, list);
		ObjectPool<List<ItemKey>>.Instance.Return(list);
		return false;
	}

	public static void ConfiscateAllItems(int charId, bool onlyTakeGradeAboveChar = false)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		OrganizationInfo organizationInfo = element_Objects.GetOrganizationInfo();
		if (OrganizationDomain.IsSect(organizationInfo.OrgTemplateId) && organizationInfo.SettlementId >= 0)
		{
			List<ItemKey> list = ObjectPool<List<ItemKey>>.Instance.Get();
			sbyte minGrade = (sbyte)(onlyTakeGradeAboveChar ? ((sbyte)(element_Objects.GetOrganizationInfo().Grade + 1)) : 0);
			element_Objects.GetItemsToLose(list, minGrade, 8);
			Settlement settlement = DomainManager.Organization.GetSettlement(organizationInfo.SettlementId);
			settlement.ConfiscateItem(mainThreadDataContext, element_Objects, list);
			ObjectPool<List<ItemKey>>.Instance.Return(list);
		}
	}

	public static void GenerateSectClothing(int charId, sbyte orgTemplateId, sbyte grade)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		OrganizationMemberItem orgMemberConfig = OrganizationDomain.GetOrgMemberConfig(new OrganizationInfo(orgTemplateId, grade, principal: true, -1));
		short num = orgMemberConfig.Clothing.TemplateId;
		if (num < 0)
		{
			num = 9;
		}
		ItemKey itemKey = DomainManager.Item.CreateItem(mainThreadDataContext, 3, num);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		AddInventoryItem(element_Objects, itemKey);
	}

	public static void SelectAndEquipClothing(int charId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		if (!element_Objects.GetEquipment()[4].IsValid())
		{
			DataContext mainThreadDataContext = Domain.MainThreadDataContext;
			ItemKey srcItemKey = mainThreadDataContext.Equipping.SelectClothing(mainThreadDataContext, element_Objects);
			if (srcItemKey.IsValid())
			{
				element_Objects.ChangeEquipment(mainThreadDataContext, -1, 4, srcItemKey);
			}
		}
	}

	public static void FilterGiftForCharacter(int sendGiftCharId, int getGiftCharId, EventArgBox argBox)
	{
		if (!DomainManager.Character.TryGetElement_Objects(sendGiftCharId, out var element))
		{
			throw new Exception($"can not get character to sendGift,Id = {sendGiftCharId}");
		}
		if (!DomainManager.Character.TryGetElement_Objects(getGiftCharId, out var element2))
		{
			throw new Exception($"can not get character to getGift,Id = {getGiftCharId}");
		}
		OrganizationItem item = Config.Organization.Instance.GetItem(element2.GetOrganizationInfo().OrgTemplateId);
		sbyte b = element2.GetInteractionGrade();
		if (DomainManager.Extra.MartialArtistSkill0Useful(item))
		{
			ProfessionData professionData = DomainManager.Extra.GetProfessionData(3);
			b -= professionData.GetSeniorityGiftLevelReduce();
			if (b < 0)
			{
				b = 0;
			}
		}
		if (DomainManager.Extra.CivilianSkill0Useful(item))
		{
			ProfessionData professionData2 = DomainManager.Extra.GetProfessionData(10);
			b -= professionData2.GetSeniorityGiftLevelReduce();
			if (b < 0)
			{
				b = 0;
			}
		}
		if (!argBox.Get("SelectItemInfo", out EventSelectItemData arg))
		{
			arg = new EventSelectItemData();
			arg.CanSelectItemList = new List<ItemDisplayData>();
			arg.FilterList = new List<SelectItemFilter>();
			argBox.Set("SelectItemInfo", (ISerializableGameData)(object)arg);
		}
		SelectItemFilter item2 = new SelectItemFilter
		{
			Key = "GiftKey",
			DisplayDataFilterId = 0,
			FilterTemplateId = -1
		};
		List<ItemDisplayData> allInventoryItems = DomainManager.Character.GetAllInventoryItems(element.GetId());
		foreach (ItemDisplayData item3 in allInventoryItems)
		{
			ItemKey key = item3.Key;
			short itemSubType = ItemTemplateHelper.GetItemSubType(key.ItemType, key.TemplateId);
			if (itemSubType != 1202 && !ItemTemplateHelper.IsTransferable(key.ItemType, key.TemplateId))
			{
				continue;
			}
			short itemSubType2 = ItemTemplateHelper.GetItemSubType(key.ItemType, key.TemplateId);
			if (item != null)
			{
				if (item.NoMeatEating && itemSubType2 == 701)
				{
					item3.UnavailableType = ItemDisplayData.ItemUnavailableType.NoMeat;
				}
				if (item.NoDrinking && itemSubType2 == 901)
				{
					item3.UnavailableType = ItemDisplayData.ItemUnavailableType.NoAlcohol;
				}
			}
			if (b > ItemTemplateHelper.GetGiftLevel(key.ItemType, key.TemplateId))
			{
				item3.UnavailableType = ItemDisplayData.ItemUnavailableType.HighGrade;
			}
			arg.CanSelectItemList.Add(item3);
		}
		arg.LoveAndHateItemInfo = DomainManager.Character.GetCharacterLoveAndHateItemInfo(Domain.MainThreadDataContext, getGiftCharId);
		arg.FilterList.Add(item2);
	}

	public static void FilterAllItemForCharacter(int charId, string itemNameKey, EventArgBox argBox)
	{
		FilterAllItemForCharacterWithParam(charId, itemNameKey, argBox, -1);
	}

	public static void FilterAllItemForCharacterWithParam(int charId, string itemNameKey, EventArgBox argBox, sbyte maxGrade = -1, bool includeEquipment = false)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var _))
		{
			throw new Exception($"can not get character,Id = {charId}");
		}
		if (!argBox.Get("SelectItemInfo", out EventSelectItemData selectItemData))
		{
			selectItemData = new EventSelectItemData();
			selectItemData.CanSelectItemList = new List<ItemDisplayData>();
			selectItemData.FilterList = new List<SelectItemFilter>();
			argBox.Set("SelectItemInfo", (ISerializableGameData)(object)selectItemData);
		}
		List<ItemDisplayData> allInventoryItems = DomainManager.Character.GetAllInventoryItems(charId);
		foreach (ItemDisplayData item2 in allInventoryItems)
		{
			Add(item2);
		}
		if (includeEquipment)
		{
			List<ItemDisplayData> allEquipmentItems = DomainManager.Character.GetAllEquipmentItems(charId);
			foreach (ItemDisplayData item3 in allEquipmentItems)
			{
				Add(item3);
			}
		}
		SelectItemFilter item = new SelectItemFilter
		{
			Key = itemNameKey,
			DisplayDataFilterId = 0,
			FilterTemplateId = -1
		};
		selectItemData.FilterList.Add(item);
		void Add(ItemDisplayData itemDisplayData)
		{
			ItemKey key = itemDisplayData.Key;
			if (key.IsValid() && ItemTemplateHelper.IsTransferable(key.ItemType, key.TemplateId) && (!InteractOfLove.IsInstalled() || charId == DomainManager.Taiwu.GetTaiwuCharId() || !GameData.Domains.TaiwuEvent.InteractOfLoveEventHelper.InteractOfLoveEventHelper.IsCurrentLoveToken(key, charId)))
			{
				sbyte grade = ItemTemplateHelper.GetGrade(key.ItemType, key.TemplateId);
				if (maxGrade <= -1 || grade <= maxGrade)
				{
					selectItemData.CanSelectItemList.Add(itemDisplayData);
				}
			}
		}
	}

	public static void FilterItemForCharacterByType(int charId, string itemNameKey, EventArgBox argBox, sbyte itemType = -1, short itemSubType = -1, bool includeTransferable = false, List<Predicate<ItemKey>> predicates = null)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var _))
		{
			throw new Exception($"can not get character,Id = {charId}");
		}
		if (!argBox.Get("SelectItemInfo", out EventSelectItemData arg))
		{
			arg = new EventSelectItemData();
			argBox.Set("SelectItemInfo", (ISerializableGameData)(object)arg);
		}
		SelectItemFilter item = new SelectItemFilter
		{
			Key = itemNameKey,
			DisplayDataFilterId = 0,
			FilterTemplateId = -1
		};
		List<ItemDisplayData> allInventoryItems = DomainManager.Character.GetAllInventoryItems(charId);
		foreach (ItemDisplayData item2 in allInventoryItems)
		{
			ItemKey itemKey = item2.Key;
			if ((includeTransferable || ItemTemplateHelper.IsTransferable(itemKey.ItemType, itemKey.TemplateId)) && (itemKey.ItemType == itemType || itemType == -1))
			{
				short itemSubType2 = ItemTemplateHelper.GetItemSubType(itemKey.ItemType, itemKey.TemplateId);
				if ((itemSubType2 == itemSubType || itemSubType == -1) && (!InteractOfLove.IsInstalled() || charId == DomainManager.Taiwu.GetTaiwuCharId() || !GameData.Domains.TaiwuEvent.InteractOfLoveEventHelper.InteractOfLoveEventHelper.IsCurrentLoveToken(itemKey, charId)) && ((!(predicates?.Any((Predicate<ItemKey> predicate) => !predicate(itemKey)))) ?? true))
				{
					arg.CanSelectItemList.Add(item2);
				}
			}
		}
		arg.FilterList.Add(item);
	}

	public static List<ItemKey> GetCharacterItemByPredicates(int charId, List<Predicate<ItemKey>> predicates)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"can not get character,Id = {charId}");
		}
		List<ItemKey> list = new List<ItemKey>();
		Inventory inventory = element.GetInventory();
		foreach (KeyValuePair<ItemKey, int> item in inventory.Items)
		{
			ItemKey itemKey = item.Key;
			if ((!(predicates?.Any((Predicate<ItemKey> predicate) => !predicate(itemKey)))) ?? true)
			{
				list.Add(itemKey);
			}
		}
		return list;
	}

	public static ItemKey SelectCharacterItemByGrade(int charId, sbyte minGrade, sbyte maxGrade, bool includeTransferable = false, sbyte itemType = -1, short itemSubType = -1, List<Predicate<ItemKey>> predicates = null)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"can not get character,Id = {charId}");
		}
		Inventory inventory = element.GetInventory();
		List<ItemKey> list = ObjectPool<List<ItemKey>>.Instance.Get();
		foreach (KeyValuePair<ItemKey, int> item in inventory.Items)
		{
			ItemKey itemKey = item.Key;
			if ((!includeTransferable && !ItemTemplateHelper.IsTransferable(itemKey.ItemType, itemKey.TemplateId)) || (itemKey.ItemType != itemType && itemType != -1))
			{
				continue;
			}
			short itemSubType2 = ItemTemplateHelper.GetItemSubType(itemKey.ItemType, itemKey.TemplateId);
			if (itemSubType2 == itemSubType || itemSubType == -1)
			{
				sbyte grade = ItemTemplateHelper.GetGrade(itemKey.ItemType, itemKey.TemplateId);
				if (grade >= minGrade && grade <= maxGrade && ((!(predicates?.Any((Predicate<ItemKey> predicate) => !predicate(itemKey)))) ?? true) && (!InteractOfLove.IsInstalled() || charId == DomainManager.Taiwu.GetTaiwuCharId() || !GameData.Domains.TaiwuEvent.InteractOfLoveEventHelper.InteractOfLoveEventHelper.IsCurrentLoveToken(itemKey, charId)))
				{
					list.Add(itemKey);
				}
			}
		}
		if (list.Count == 0)
		{
			ObjectPool<List<ItemKey>>.Instance.Return(list);
			return ItemKey.Invalid;
		}
		ItemKey result = list[Domain.MainThreadDataContext.Random.Next(list.Count)];
		ObjectPool<List<ItemKey>>.Instance.Return(list);
		return result;
	}

	public static ItemKey SelectCharacterTopGradeItem(int charId, bool includeTransferable = false)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"can not get character,Id = {charId}");
		}
		sbyte characterTopGradeOfItem = GetCharacterTopGradeOfItem(charId, includeTransferable);
		if (characterTopGradeOfItem == -1)
		{
			return ItemKey.Invalid;
		}
		Inventory inventory = element.GetInventory();
		List<ItemKey> list = ObjectPool<List<ItemKey>>.Instance.Get();
		foreach (KeyValuePair<ItemKey, int> item in inventory.Items)
		{
			ItemKey key = item.Key;
			if (includeTransferable || ItemTemplateHelper.IsTransferable(key.ItemType, key.TemplateId))
			{
				sbyte grade = ItemTemplateHelper.GetGrade(key.ItemType, key.TemplateId);
				if (grade == characterTopGradeOfItem && (!InteractOfLove.IsInstalled() || charId == DomainManager.Taiwu.GetTaiwuCharId() || !GameData.Domains.TaiwuEvent.InteractOfLoveEventHelper.InteractOfLoveEventHelper.IsCurrentLoveToken(key, charId)))
				{
					list.Add(key);
				}
			}
		}
		if (list.Count == 0)
		{
			ObjectPool<List<ItemKey>>.Instance.Return(list);
			return ItemKey.Invalid;
		}
		ItemKey result = list[Domain.MainThreadDataContext.Random.Next(list.Count)];
		ObjectPool<List<ItemKey>>.Instance.Return(list);
		return result;
	}

	public static sbyte GetCharacterTopGradeOfItem(int charId, bool includeTransferable = false)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"can not get character,Id = {charId}");
		}
		Inventory inventory = element.GetInventory();
		sbyte b = -1;
		foreach (KeyValuePair<ItemKey, int> item in inventory.Items)
		{
			ItemKey key = item.Key;
			if ((includeTransferable || ItemTemplateHelper.IsTransferable(key.ItemType, key.TemplateId)) && (!InteractOfLove.IsInstalled() || charId == DomainManager.Taiwu.GetTaiwuCharId() || !GameData.Domains.TaiwuEvent.InteractOfLoveEventHelper.InteractOfLoveEventHelper.IsCurrentLoveToken(key, charId)))
			{
				sbyte grade = ItemTemplateHelper.GetGrade(key.ItemType, key.TemplateId);
				if (grade > b)
				{
					b = grade;
				}
			}
		}
		return b;
	}

	public static void StartSelectReadingBookCount(EventArgBox argBox, string selectItemKey)
	{
		if (argBox.Get<ItemKey>(selectItemKey, out ItemKey arg))
		{
			if (!argBox.Get("SelectReadingBookCount", out EventSelectReadingBookCountData arg2))
			{
				arg2 = new EventSelectReadingBookCountData();
			}
			ItemDisplayData itemDisplayData = (arg2.SelectedBookData = DomainManager.Item.GetItemDisplayData(arg));
			arg2.MaxReadingBookCount = Math.Min(itemDisplayData.Durability, GlobalConfig.Instance.SpiritualDebtInteractionRanshanMaxReadingCount);
			argBox.Set("SelectReadingBookCount", (ISerializableGameData)(object)arg2);
		}
	}

	public static void StartSelectNeigongLoopingCount(EventArgBox argBox, int charId, short combatSkillTemplateId)
	{
		if (!argBox.Get("SelectNeigongLoopingCount", out EventSelectNeigongLoopingCountData arg))
		{
			arg = new EventSelectNeigongLoopingCountData();
		}
		CombatSkillDisplayData combatSkillDisplayDataOnce = DomainManager.CombatSkill.GetCombatSkillDisplayDataOnce(charId, combatSkillTemplateId);
		arg.SelectedCombatSkill = combatSkillDisplayDataOnce;
		arg.MaxLoopingCount = GlobalConfig.Instance.SpiritualDebtInteractionRanshanMaxNeigongLoopingCount;
		argBox.Set("SelectNeigongLoopingCount", (ISerializableGameData)(object)arg);
	}

	public static void StartSelectFuyuFaithCount(EventArgBox argBox, GameData.Domains.Character.Character character)
	{
		if (!argBox.Get("SelectFuyuFaithCount", out EventSelectFuyuFaithCountData arg))
		{
			arg = new EventSelectFuyuFaithCountData();
		}
		arg.Counter = character.GetDarkAshCounter();
		arg.Curr = DomainManager.Extra.GetFuyuFaith();
		arg.Max = character.GetLeftMaxHealth();
		argBox.Set("SelectFuyuFaithCount", (ISerializableGameData)(object)arg);
	}

	public static int GetTaiwuInventoryItemCount(sbyte itemType, short itemTemplateId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Inventory inventory = taiwu.GetInventory();
		return inventory.GetInventoryItemCount(itemType, itemTemplateId);
	}

	public static int GetCharCricketCount(int charId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		Dictionary<ItemKey, int> items = element_Objects.GetInventory().Items;
		int num = 0;
		foreach (ItemKey key in items.Keys)
		{
			if (key.ItemType == 11)
			{
				num++;
			}
		}
		return num;
	}

	public static List<ItemKey> GetCharCricketList(int charId, int minWinCount = 0)
	{
		Dictionary<ItemKey, int> items = DomainManager.Character.GetElement_Objects(charId).GetInventory().Items;
		List<ItemKey> list = new List<ItemKey>();
		foreach (ItemKey key in items.Keys)
		{
			if (key.ItemType == 11)
			{
				CricketData cricketData = DomainManager.Item.GetCricketData(key.Id);
				if (cricketData[5] >= minWinCount)
				{
					list.Add(key);
				}
			}
		}
		return list;
	}

	public static ItemKey CreateCricket(int charId, sbyte grade)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		ItemKey itemKey = DomainManager.Item.CreateCricket(Domain.MainThreadDataContext, grade);
		AddInventoryItem(element_Objects, itemKey);
		return itemKey;
	}

	public static void KillCricket(ItemKey itemKey)
	{
		if (DomainManager.Item.TryGetElement_Crickets(itemKey.Id, out var element))
		{
			element.SetCurrDurability(0, Domain.MainThreadDataContext);
		}
	}

	public static void SetCricketLeftLife(ItemKey itemKey, int leftLife)
	{
		if (DomainManager.Item.TryGetElement_Crickets(itemKey.Id, out var element))
		{
			element.SetAge((sbyte)Math.Max(element.CalcMaxAge() - leftLife, 0), Domain.MainThreadDataContext);
		}
	}

	public static void AdjustCricketLife(ItemKey itemKey, int lifeDelta)
	{
		if (DomainManager.Item.TryGetElement_Crickets(itemKey.Id, out var element))
		{
			DomainManager.Extra.AdjustCricketExtraAge(Domain.MainThreadDataContext, element.GetId(), (short)lifeDelta);
		}
	}

	public static void ChangeCharacterHappinessByItemChange(ItemKey itemKey, int charId, bool isGetItem)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			sbyte b = DomainManager.Item.GetBaseItem(itemKey).GetHappinessChange();
			if (!isGetItem)
			{
				b *= -1;
			}
			element.ChangeHappiness(Domain.MainThreadDataContext, b);
		}
	}

	public static bool GetSimulateCricketBattleResult(int leftCharId, int rightCharId)
	{
		if (!DomainManager.Character.IsCharacterAlive(leftCharId))
		{
			throw new Exception($"GetSimulateCricketBattleResult: unable to get character of id {leftCharId}");
		}
		if (!DomainManager.Character.IsCharacterAlive(rightCharId))
		{
			throw new Exception($"GetSimulateCricketBattleResult: unable to get character of id {rightCharId}");
		}
		List<ItemDisplayData> npcCricketDisplayDataListForCricketBattle = DomainManager.Item.GetNpcCricketDisplayDataListForCricketBattle(Domain.MainThreadDataContext, leftCharId, Domain.GetTempCreateItemList(), -1);
		List<ItemDisplayData> npcCricketDisplayDataListForCricketBattle2 = DomainManager.Item.GetNpcCricketDisplayDataListForCricketBattle(Domain.MainThreadDataContext, rightCharId, Domain.GetTempCreateItemList(), -1);
		Domain.SetItemListOfLeft(npcCricketDisplayDataListForCricketBattle.ToArray(), Domain.MainThreadDataContext);
		Domain.SetItemListOfRight(npcCricketDisplayDataListForCricketBattle2.ToArray(), Domain.MainThreadDataContext);
		Domain.SetShowItemWithCricketBattleGuess(value: true, Domain.MainThreadDataContext);
		CollectionUtils.Shuffle(Domain.MainThreadDataContext.Random, npcCricketDisplayDataListForCricketBattle);
		CollectionUtils.Shuffle(Domain.MainThreadDataContext.Random, npcCricketDisplayDataListForCricketBattle2);
		int num = 0;
		for (int i = 0; i < 3; i++)
		{
			CricketBattleSimulator.SetBattlers(npcCricketDisplayDataListForCricketBattle[i].Key, npcCricketDisplayDataListForCricketBattle2[i].Key, Domain.MainThreadDataContext);
			if (CricketBattleSimulator.GetBattleResult() == 0)
			{
				num++;
			}
			if (num >= 2)
			{
				break;
			}
		}
		return num >= 2;
	}

	public static ItemKey CreateSkillBook(short templateId, sbyte completePagesCount = -1, sbyte lostPagesCount = -1, sbyte outlinePageType = -1, sbyte normalPagesDirectProb = 50, bool outlineAlwaysComplete = true)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		return DomainManager.Item.CreateSkillBook(mainThreadDataContext, templateId, completePagesCount, lostPagesCount, outlinePageType, normalPagesDirectProb, outlineAlwaysComplete);
	}

	public static int GetEquipmentsSlotIndex(GameData.Domains.Character.Character character, ItemKey itemKey)
	{
		ItemKey[] equipment = character.GetEquipment();
		return equipment.IndexOf(itemKey);
	}

	[Obsolete]
	public static void ApplyTamingResult(GameData.Domains.Character.Character character, ItemKey carrier, bool isWin, Location location, ItemKey rope)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		if (carrier.ItemType == 5)
		{
			DomainManager.Extra.ApplyJiaoTamingResult(mainThreadDataContext, GetOrCreateAnimalByItemKey(carrier), isWin, location, rope);
		}
		else
		{
			DomainManager.Extra.ApplyTamingResult(mainThreadDataContext, character, carrier, isWin, location, rope);
		}
	}

	public static void ApplyAnimalTamingResult(GameData.Domains.Character.Character character, GameData.Domains.Character.Animal animal, bool isWin, Location location, ItemKey rope)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		if (animal.Type == 2)
		{
			DomainManager.Extra.ApplyJiaoTamingResult(mainThreadDataContext, animal, isWin, location, rope);
		}
		else
		{
			DomainManager.Extra.ApplyTamingResult(mainThreadDataContext, character, animal.ItemKey, isWin, location, rope);
		}
	}

	public static void SetCarrierTamePoint(int carrierId, int point = 100)
	{
		DomainManager.Extra.SetCarrierTamePoint(Domain.MainThreadDataContext, carrierId, point);
	}

	public static string TaiwuSendGiftToCharacter(GameData.Domains.Character.Character character, ItemKey gift)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int giftItemFavorabilityChange = GetGiftItemFavorabilityChange(gift, character);
		short favorability = GetFavorability(character, taiwu);
		short itemHappinessChange = GetItemHappinessChange(gift);
		if (GameData.Domains.TaiwuEvent.InteractOfLoveEventHelper.InteractOfLoveEventHelper.IsCurrentLoveToken(gift, character.GetId()))
		{
			return "25a22ca7-64c1-4ed2-89ba-4bfae952644b";
		}
		if (GameData.Domains.TaiwuEvent.InteractOfLoveEventHelper.InteractOfLoveEventHelper.IsPreviousLoveToken(gift, character.GetId()))
		{
			return "d0fe7678-26c0-4f49-aafe-6d7a0fa57d06";
		}
		if (gift.ItemType == 7 || gift.ItemType == 9)
		{
			if (ItemTemplateHelper.GetItemSubType(gift.ItemType, gift.TemplateId) == 901 && IsSectNoDrinking(character.GetOrganizationInfo().OrgTemplateId))
			{
				return "db7cfce2-ad10-43dd-919d-975b8d207ac0";
			}
			if (ItemTemplateHelper.GetItemSubType(gift.ItemType, gift.TemplateId) == 701 && IsSectNoMeatEating(character.GetOrganizationInfo().OrgTemplateId))
			{
				return "e6deec73-901e-46b2-88ee-cea3019c78d3";
			}
			if (GetAvailableEatingSlotsCount(character.GetId()) > 0)
			{
				if (IsItemPoisoned(gift) && character.TryDetectAttachedPoisons(gift))
				{
					return "ed802fcb-73a7-4fe8-a7c1-9bec9be09d45";
				}
				TransferInventoryItemWithDebt(taiwu.GetId(), character.GetId(), gift, 1);
				AddEatingItem(character.GetId(), gift);
				if (GetCharLovingItemSubType(character.GetId()) == ItemTemplateHelper.GetItemSubType(gift.ItemType, gift.TemplateId))
				{
					ChangeFavorabilityOptionalRepeatedEvent(character, taiwu, ClampFavorabilityChangeValue(giftItemFavorabilityChange));
					ChangeRoleHappiness(character, (short)(itemHappinessChange * 2));
					SetCharLovingItemSubTypeRevealed(character.GetId());
					short favorability2 = GetFavorability(character, taiwu);
					return "a431b14a-a2ec-4799-baaf-c9eee30cfc30";
				}
				if (GetCharHatingItemSubType(character.GetId()) == ItemTemplateHelper.GetItemSubType(gift.ItemType, gift.TemplateId))
				{
					ChangeFavorabilityOptionalRepeatedEvent(character, taiwu, ClampFavorabilityChangeValue(giftItemFavorabilityChange / 2));
					ChangeRoleHappiness(character, (short)(itemHappinessChange / 2));
					SetCharHatingItemSubTypeRevealed(character.GetId());
					short favorability3 = GetFavorability(character, taiwu);
					return "5133fa31-d3ae-4516-9038-fde3bf92f03d";
				}
				ChangeFavorabilityOptionalRepeatedEvent(character, taiwu, ClampFavorabilityChangeValue(giftItemFavorabilityChange));
				ChangeRoleHappiness(character, itemHappinessChange);
				short favorability4 = GetFavorability(character, taiwu);
				return "aa12fcb4-d645-4655-a077-4146f1ea0a85";
			}
			return "19e3e1c8-f38f-4337-b3c2-82b2f547c652";
		}
		if (gift.ItemType == 2 || gift.ItemType == 1 || gift.ItemType == 4 || gift.ItemType == 3 || gift.ItemType == 0)
		{
			if (IsItemPoisoned(gift) && character.TryDetectAttachedPoisons(gift) && !Config.Organization.Instance[character.GetOrganizationInfo().OrgTemplateId].AllowPoisoning)
			{
				TransferInventoryItemWithDebt(taiwu.GetId(), character.GetId(), gift, 1);
				giftItemFavorabilityChange /= 2;
				if (GetCharLovingItemSubType(character.GetId()) == ItemTemplateHelper.GetItemSubType(gift.ItemType, gift.TemplateId))
				{
					ChangeFavorabilityOptionalRepeatedEvent(character, taiwu, ClampFavorabilityChangeValue(giftItemFavorabilityChange * 2));
					ChangeRoleHappiness(character, (short)(itemHappinessChange * 2));
					SetCharLovingItemSubTypeRevealed(character.GetId());
				}
				if (GetCharHatingItemSubType(character.GetId()) == ItemTemplateHelper.GetItemSubType(gift.ItemType, gift.TemplateId))
				{
					ChangeFavorabilityOptionalRepeatedEvent(character, taiwu, ClampFavorabilityChangeValue(giftItemFavorabilityChange / 2));
					ChangeRoleHappiness(character, (short)(itemHappinessChange / 2));
					SetCharHatingItemSubTypeRevealed(character.GetId());
				}
				else
				{
					ChangeFavorabilityOptionalRepeatedEvent(character, taiwu, ClampFavorabilityChangeValue(giftItemFavorabilityChange));
					ChangeRoleHappiness(character, itemHappinessChange);
				}
				short favorability5 = GetFavorability(character, taiwu);
				return "40b3b323-9892-4f6c-a6d4-aa0fd6f09cd0";
			}
			TransferInventoryItemWithDebt(taiwu.GetId(), character.GetId(), gift, 1);
			if (GetCharLovingItemSubType(character.GetId()) == ItemTemplateHelper.GetItemSubType(gift.ItemType, gift.TemplateId))
			{
				ChangeFavorabilityOptionalRepeatedEvent(character, taiwu, ClampFavorabilityChangeValue(giftItemFavorabilityChange * 2));
				ChangeRoleHappiness(character, (short)(itemHappinessChange * 2));
				SetCharLovingItemSubTypeRevealed(character.GetId());
				short favorability6 = GetFavorability(character, taiwu);
				return "a431b14a-a2ec-4799-baaf-c9eee30cfc30";
			}
			if (GetCharHatingItemSubType(character.GetId()) == ItemTemplateHelper.GetItemSubType(gift.ItemType, gift.TemplateId))
			{
				ChangeFavorabilityOptionalRepeatedEvent(character, taiwu, ClampFavorabilityChangeValue(giftItemFavorabilityChange / 2));
				ChangeRoleHappiness(character, (short)(itemHappinessChange / 2));
				SetCharHatingItemSubTypeRevealed(character.GetId());
				short favorability7 = GetFavorability(character, taiwu);
				return "5133fa31-d3ae-4516-9038-fde3bf92f03d";
			}
			ChangeFavorabilityOptionalRepeatedEvent(character, taiwu, ClampFavorabilityChangeValue(giftItemFavorabilityChange));
			ChangeRoleHappiness(character, itemHappinessChange);
			short favorability8 = GetFavorability(character, taiwu);
			return "aa12fcb4-d645-4655-a077-4146f1ea0a85";
		}
		if (ItemTemplateHelper.GetItemSubType(gift.ItemType, gift.TemplateId) == 1202)
		{
			if (CheckCharacterWillAcceptLegendaryBookAsGift(character.GetId()))
			{
				TransferInventoryItem(taiwu, character, gift);
				ChangeFavorabilityOptionalRepeatedEvent(character, taiwu, ClampFavorabilityChangeValue(giftItemFavorabilityChange));
				ChangeRoleHappiness(character, itemHappinessChange);
				short favorability9 = GetFavorability(character, taiwu);
				int gameDate = GetGameDate();
				Location location = taiwu.GetLocation();
				GetLifeRecordCollection().AddGiveItem(taiwu.GetId(), gameDate, character.GetId(), location, gift.ItemType, gift.TemplateId);
				return GetRoleBehavior(character) switch
				{
					0 => "15c076ec-eafb-46f2-ac41-d380be6ce1c0", 
					1 => "4003bc5f-adb1-4966-ac0d-ef29858f0cc2", 
					2 => "9a143f7a-e237-4e20-b805-b789b6f5dabb", 
					3 => "69785bef-7610-406b-b003-447cf9565b4a", 
					4 => "afbe6948-2efb-48e3-887d-17de335dfbec", 
					_ => string.Empty, 
				};
			}
			return "1f24a6d9-00b7-4982-bb62-13aca9af73e4";
		}
		if (IsItemPoisoned(gift) && character.TryDetectAttachedPoisons(gift))
		{
			return "ed802fcb-73a7-4fe8-a7c1-9bec9be09d45";
		}
		TransferInventoryItemWithDebt(taiwu.GetId(), character.GetId(), gift, 1);
		if (GetCharLovingItemSubType(character.GetId()) == ItemTemplateHelper.GetItemSubType(gift.ItemType, gift.TemplateId))
		{
			ChangeFavorabilityOptionalRepeatedEvent(character, taiwu, ClampFavorabilityChangeValue(giftItemFavorabilityChange * 2));
			ChangeRoleHappiness(character, (short)(itemHappinessChange * 2));
			SetCharLovingItemSubTypeRevealed(character.GetId());
			short favorability10 = GetFavorability(character, taiwu);
			return "a431b14a-a2ec-4799-baaf-c9eee30cfc30";
		}
		if (GetCharHatingItemSubType(character.GetId()) == ItemTemplateHelper.GetItemSubType(gift.ItemType, gift.TemplateId))
		{
			ChangeFavorabilityOptionalRepeatedEvent(character, taiwu, ClampFavorabilityChangeValue(giftItemFavorabilityChange / 2));
			ChangeRoleHappiness(character, (short)(itemHappinessChange / 2));
			SetCharHatingItemSubTypeRevealed(character.GetId());
			short favorability11 = GetFavorability(character, taiwu);
			return "5133fa31-d3ae-4516-9038-fde3bf92f03d";
		}
		ChangeFavorabilityOptionalRepeatedEvent(character, taiwu, ClampFavorabilityChangeValue(giftItemFavorabilityChange));
		ChangeRoleHappiness(character, itemHappinessChange);
		short favorability12 = GetFavorability(character, taiwu);
		return "aa12fcb4-d645-4655-a077-4146f1ea0a85";
	}

	public static sbyte GetCharacterOwnLegendaryBookState(int charId)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return element.GetLegendaryBookOwnerState();
		}
		return -1;
	}

	public static bool CalcRequestLegendaryBookResult(int charId)
	{
		sbyte characterOwnLegendaryBookState = GetCharacterOwnLegendaryBookState(charId);
		if (characterOwnLegendaryBookState == 2)
		{
			return false;
		}
		int num = 0;
		int taiwuCharacterId = EventArgBox.TaiwuCharacterId;
		if (HasRelationBetweenCharacters(charId, taiwuCharacterId, 1) || HasRelationBetweenCharacters(charId, taiwuCharacterId, 64) || HasRelationBetweenCharacters(charId, taiwuCharacterId, 8))
		{
			num += 4;
		}
		if (HasRelationBetweenCharacters(charId, taiwuCharacterId, 2) || HasRelationBetweenCharacters(charId, taiwuCharacterId, 128) || HasRelationBetweenCharacters(charId, taiwuCharacterId, 16))
		{
			num += 3;
		}
		if (HasRelationBetweenCharacters(charId, taiwuCharacterId, 1024))
		{
			num += 3;
		}
		if (HasRelationBetweenCharacters(charId, taiwuCharacterId, 512))
		{
			num += 2;
		}
		if (HasRelationBetweenCharacters(charId, taiwuCharacterId, 4) || HasRelationBetweenCharacters(charId, taiwuCharacterId, 256) || HasRelationBetweenCharacters(charId, taiwuCharacterId, 32))
		{
			num += 2;
		}
		if (HasRelationBetweenCharacters(charId, taiwuCharacterId, 16384))
		{
			num++;
		}
		if (HasRelationBetweenCharacters(charId, taiwuCharacterId, 8192))
		{
			num++;
		}
		if (HasRelationBetweenCharacters(charId, taiwuCharacterId, 32768))
		{
			num -= 4;
		}
		short favorability = DomainManager.Character.GetFavorability(charId, taiwuCharacterId);
		sbyte favorabilityType = FavorabilityType.GetFavorabilityType(favorability);
		num += favorabilityType;
		int topThousandCharacterRanking = DomainManager.Character.GetTopThousandCharacterRanking(taiwuCharacterId);
		if (topThousandCharacterRanking < 0 || topThousandCharacterRanking > 80)
		{
			return false;
		}
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			int topThousandCharacterRanking2 = DomainManager.Character.GetTopThousandCharacterRanking(charId);
			if (topThousandCharacterRanking > topThousandCharacterRanking2 && topThousandCharacterRanking2 > 0)
			{
				return false;
			}
			sbyte behaviorType = element.GetBehaviorType();
			switch (characterOwnLegendaryBookState)
			{
			case 0:
				return num >= 7 && topThousandCharacterRanking <= GlobalConfig.Instance.RequestLegendaryBookRequireRankWhenOwningBook[behaviorType];
			case 1:
				return num >= 9 && topThousandCharacterRanking <= GlobalConfig.Instance.RequestLegendaryBookRequireRankWhenShocked[behaviorType];
			}
		}
		return false;
	}

	public static int[] CalcExchangeLegendaryBookPrice(int charId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return new int[3] { 2147483647, 2147483647, 2147483647 };
		}
		int[] array = new int[3]
		{
			GlobalConfig.Instance.ExchangeLegendaryBookBasePriceInCoin,
			0,
			0
		};
		sbyte b = GetFavorabilityType(element, DomainManager.Taiwu.GetTaiwu());
		if (b == sbyte.MinValue)
		{
			b = 0;
		}
		array[0] -= (int)((float)array[0] * ((float)b / 9f));
		if (GetCharacterOwnLegendaryBookState(charId) == 1)
		{
			array[0] *= 3;
		}
		array[1] = array[0] / 10;
		array[2] = array[0] / 2;
		return array;
	}

	public static void ProcessExchangeLegendaryBook(int fromCharId, int toCharId, int price, sbyte resourceType, bool isExp, Location location, ItemKey bookKey)
	{
		if (!DomainManager.Character.TryGetElement_Objects(fromCharId, out var element))
		{
			throw new Exception("from character id invalid,exchange legendary book failed!");
		}
		if (!DomainManager.Character.TryGetElement_Objects(toCharId, out var element2))
		{
			throw new Exception("to character id invalid,exchange legendary book failed!");
		}
		if (isExp && element2.GetExp() < price)
		{
			throw new Exception("to character exp not enough,exchange legendary book failed!");
		}
		if (!isExp && element2.GetResource(resourceType) < price)
		{
			throw new Exception($"to character resource {resourceType} not enough,exchange legendary book failed!");
		}
		TransferInventoryItem(element, element2, bookKey);
		if (isExp)
		{
			ChangeRoleExp(element, price);
			ChangeRoleExp(element2, -price);
			GetLifeRecordCollection().AddAcceptRequestExchangeLegendaryBookByExp(fromCharId, GetGameDate(), toCharId, location, bookKey.ItemType, bookKey.TemplateId, price);
		}
		else
		{
			ChangeRoleResource(element, resourceType, price, fromCharId == DomainManager.Taiwu.GetTaiwuCharId());
			ChangeRoleResource(element2, resourceType, -price, toCharId == DomainManager.Taiwu.GetTaiwuCharId());
			GetLifeRecordCollection().AddAcceptRequestExchangeLegendaryBook(fromCharId, GetGameDate(), toCharId, location, bookKey.ItemType, bookKey.TemplateId, resourceType, price);
		}
	}

	public static void RegisterCharacterTemporaryFeature(int charId, short featureTemplateId, int expireDate = -1)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element) && element.AddFeature(Domain.MainThreadDataContext, featureTemplateId, removeMutexFeature: true) && expireDate >= 0)
		{
			DomainManager.Extra.RegisterCharacterTemporaryFeature(Domain.MainThreadDataContext, charId, featureTemplateId, expireDate);
		}
	}

	public static sbyte GetConsumedCharacterLegendaryBookType(GameData.Domains.Character.Character character)
	{
		return DomainManager.LegendaryBook.GetConsumedCharacterLegendaryBookType(character);
	}

	public static List<ItemKey> GetShockedInsaneCharacterBooks(int charId)
	{
		List<ItemKey> list = new List<ItemKey>();
		List<sbyte> charOwnedBookTypes = DomainManager.LegendaryBook.GetCharOwnedBookTypes(charId);
		for (int i = 0; i < charOwnedBookTypes.Count; i++)
		{
			ItemKey legendaryBookItem = DomainManager.LegendaryBook.GetLegendaryBookItem(charOwnedBookTypes[i]);
			if (legendaryBookItem.IsValid())
			{
				list.Add(legendaryBookItem);
			}
		}
		return list;
	}

	public static void CreateRandomEnemiesOnValidBlocks(Location location, short maxSteps, int enemyAmount)
	{
		List<MapBlockData> validBlocks = new List<MapBlockData>();
		DomainManager.Adventure.GetValidBlocksForRandomEnemy(location.AreaId, location.BlockId, maxSteps, onAdventureSite: false, onSettlement: false, nearTaiwu: true, validBlocks);
		sbyte b = DomainManager.World.GetXiangshuLevel();
		if (b == 9)
		{
			b = 8;
		}
		short enemyTemplateId = (short)(298 + b);
		DomainManager.Adventure.CreateTemporaryEnemiesOnValidBlocks(Domain.MainThreadDataContext, Location.Invalid, enemyTemplateId, enemyAmount, validBlocks);
	}

	public static bool IsCharacterHaveLegendaryBook(int charId, ItemKey itemKey)
	{
		if (!itemKey.IsValid())
		{
			return false;
		}
		int num = itemKey.TemplateId - 211;
		return charId == DomainManager.LegendaryBook.GetOwner((sbyte)num);
	}

	public static List<short> GetCharLifeSkillList(int charId, sbyte type = -1, sbyte minGrade = 0, sbyte maxGrade = 8, int minReadedPageCount = 0, bool requireTaiwuNotLearn = false)
	{
		List<GameData.Domains.Character.LifeSkillItem> learnedLifeSkills = DomainManager.Character.GetElement_Objects(charId).GetLearnedLifeSkills();
		List<GameData.Domains.Character.LifeSkillItem> learnedLifeSkills2 = DomainManager.Taiwu.GetTaiwu().GetLearnedLifeSkills();
		List<short> list = new List<short>();
		for (int i = 0; i < learnedLifeSkills.Count; i++)
		{
			short skillId = learnedLifeSkills[i].SkillTemplateId;
			Config.LifeSkillItem lifeSkillItem = LifeSkill.Instance[skillId];
			if ((type < 0 || lifeSkillItem.Type == type) && lifeSkillItem.Grade >= minGrade && lifeSkillItem.Grade <= maxGrade && learnedLifeSkills.Find((GameData.Domains.Character.LifeSkillItem item) => item.SkillTemplateId == skillId).GetReadPagesCount() >= minReadedPageCount && (!requireTaiwuNotLearn || (!learnedLifeSkills2.Exists((GameData.Domains.Character.LifeSkillItem item) => item.SkillTemplateId == skillId) && !DomainManager.Taiwu.TryGetNotLearnLifeSkillReadingProgress(skillId, out var _))))
			{
				list.Add(skillId);
			}
		}
		list.Sort((short skillIdL, short skillIdR) => LifeSkill.Instance[skillIdL].Grade.CompareTo(LifeSkill.Instance[skillIdR].Grade));
		return list;
	}

	public static List<short> GetMinGradeLifeSkillList(List<short> skillIdList)
	{
		List<short> list = new List<short>();
		sbyte b = sbyte.MaxValue;
		for (int i = 0; i < skillIdList.Count; i++)
		{
			short num = skillIdList[i];
			sbyte grade = LifeSkill.Instance[num].Grade;
			if (grade < b)
			{
				list.Clear();
				list.Add(num);
				b = grade;
			}
			else if (grade == b)
			{
				list.Add(num);
			}
		}
		return list;
	}

	public unsafe static void SetCharBaseLifeSkillQualification(int charId, sbyte skillType, short qualification)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		LifeSkillShorts baseLifeSkillQualifications = element_Objects.GetBaseLifeSkillQualifications();
		baseLifeSkillQualifications.Items[skillType] = qualification;
		element_Objects.SetBaseLifeSkillQualifications(ref baseLifeSkillQualifications, Domain.MainThreadDataContext);
	}

	public static void ChangeCharBaseLifeSkillQualification(int charId, sbyte skillType, int delta)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		element_Objects.ChangeBaseLifeSkillQualification(Domain.MainThreadDataContext, skillType, delta);
	}

	public static sbyte GetLifeSkillGrade(short skillId)
	{
		return LifeSkill.Instance[skillId].Grade;
	}

	public static short GetLifeSkillId(sbyte type, sbyte grade)
	{
		for (int i = 0; i < LifeSkill.Instance.Count; i++)
		{
			Config.LifeSkillItem lifeSkillItem = LifeSkill.Instance[i];
			if (lifeSkillItem.Type == type && lifeSkillItem.Grade == grade)
			{
				return lifeSkillItem.TemplateId;
			}
		}
		return -1;
	}

	public static int GetLifeSkillReadedPageCount(int charId, short skillId)
	{
		List<GameData.Domains.Character.LifeSkillItem> learnedLifeSkills = DomainManager.Character.GetElement_Objects(charId).GetLearnedLifeSkills();
		int num = learnedLifeSkills.FindIndex((GameData.Domains.Character.LifeSkillItem item) => item.SkillTemplateId == skillId);
		return (num >= 0) ? learnedLifeSkills[num].GetReadPagesCount() : 0;
	}

	public static void LearnLifeSkill(int charId, short skillId)
	{
		DomainManager.Character.LearnLifeSkill(Domain.MainThreadDataContext, charId, skillId, 0);
	}

	public static ItemKey GetLifeSkillBook(int charId, short skillId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		ItemKey itemKey = DomainManager.Item.CreateItem(mainThreadDataContext, 10, LifeSkill.Instance[skillId].SkillBookId);
		DomainManager.Character.GetElement_Objects(charId).AddInventoryItem(mainThreadDataContext, itemKey, 1);
		return itemKey;
	}

	public static ItemKey GetLifeSkillBook(int charId, sbyte lifeSkillType, sbyte grade, bool isPageComplete)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Config.LifeSkillItem lifeSkillItem = LifeSkill.Instance.FirstOrDefault((Config.LifeSkillItem l) => l.Type == lifeSkillType && l.Grade == grade);
		int num = (isPageComplete ? 5 : (-1));
		ItemKey itemKey = DomainManager.Item.CreateSkillBook(mainThreadDataContext, lifeSkillItem.SkillBookId, (sbyte)num, -1, -1, 50);
		DomainManager.Character.GetElement_Objects(charId).AddInventoryItem(mainThreadDataContext, itemKey, 1);
		return itemKey;
	}

	public static List<short> GetNorLearnLifeSkillList(int charId, sbyte grade, sbyte type = -1)
	{
		List<short> list = new List<short>();
		List<GameData.Domains.Character.LifeSkillItem> learnedLifeSkills = DomainManager.Character.GetElement_Objects(charId).GetLearnedLifeSkills();
		List<short> list2 = ObjectPool<List<short>>.Instance.Get();
		list2.Clear();
		for (int i = 0; i < learnedLifeSkills.Count; i++)
		{
			list2.Add(learnedLifeSkills[i].SkillTemplateId);
		}
		for (int j = 0; j < LifeSkill.Instance.Count; j++)
		{
			Config.LifeSkillItem lifeSkillItem = LifeSkill.Instance[j];
			if (lifeSkillItem.Grade == grade && (type < 0 || lifeSkillItem.Type == type) && !list2.Contains(lifeSkillItem.TemplateId))
			{
				list.Add(lifeSkillItem.TemplateId);
			}
		}
		ObjectPool<List<short>>.Instance.Return(list2);
		return list;
	}

	public static void SyncLifeSkillReadingStateToCharacter(int sourceCharacterId, int targetCharacterId, sbyte lifeSkillType)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(sourceCharacterId);
		GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(targetCharacterId);
		if (lifeSkillType == 16)
		{
			List<GameData.Domains.Character.LifeSkillItem> list = new List<GameData.Domains.Character.LifeSkillItem>();
			list.AddRange(element_Objects.GetLearnedLifeSkills());
			element_Objects2.SetLearnedLifeSkills(list, Domain.MainThreadDataContext);
		}
		else
		{
			DomainManager.Character.SyncLifeSkillReadingStateToCharacter(Domain.MainThreadDataContext, element_Objects, element_Objects2, lifeSkillType);
		}
	}

	public static List<short> GetTeachTaiwuLifeSkillList(int charId)
	{
		GameData.Utilities.ShortList value;
		return DomainManager.Taiwu.TryGetElement_TeachTaiwuLifeSkillDict(charId, out value) ? value.Items : null;
	}

	public static void ClearTeachTaiwuLifeSkillList(int charId)
	{
		DomainManager.Taiwu.ClearTeachTaiwuLifeSkillList(Domain.MainThreadDataContext, charId);
	}

	public static void AddTeachTaiwuLifeSkill(int charId, short skillId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Taiwu.AddTeachTaiwuLifeSkill(mainThreadDataContext, charId, skillId);
		ProfessionFormulaItem formulaCfg = ProfessionFormula.Instance[101];
		int baseDelta = formulaCfg.Calculate(LifeSkill.Instance[skillId].Grade);
		DomainManager.Extra.ChangeProfessionSeniority(mainThreadDataContext, 16, baseDelta);
	}

	public static string LearnTargetLifeSkillDependSectApprovingRate(sbyte lifeSkillType, EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		sbyte orgTemplateId = character2.GetOrganizationInfo().OrgTemplateId;
		List<short> charLifeSkillList = GetCharLifeSkillList(character2.GetId(), lifeSkillType, 0, 8, 3, requireTaiwuNotLearn: true);
		if (charLifeSkillList == null || charLifeSkillList.Count == 0)
		{
			return argBox.GetString("LifeSkillNoneTeachEventGuid");
		}
		short num = GetMinGradeLifeSkillList(charLifeSkillList).Sample();
		sbyte b = (sbyte)Math.Max(0, GetSectApprovingRate(orgTemplateId) / 100 - 1);
		sbyte lifeSkillGrade = GetLifeSkillGrade(num);
		List<short> charLifeSkillList2 = GetCharLifeSkillList(character.GetId(), lifeSkillType, 0, 8);
		if (lifeSkillGrade > b)
		{
			argBox.Set("CantTeachLife", num);
			return argBox.GetString("LifeSkillBeyondApprovingEventGuid");
		}
		if (GetLifeSkillGrade(num) == 0)
		{
			argBox.Set("SkillCanLearn", num);
			return argBox.GetString("LifeSkillTeachEventGuid");
		}
		for (sbyte b2 = 0; b2 < lifeSkillGrade; b2++)
		{
			short lifeSkillId = GetLifeSkillId(lifeSkillType, b2);
			if (!charLifeSkillList2.Contains(lifeSkillId) || GetLifeSkillReadedPageCount(character.GetId(), lifeSkillId) < 3)
			{
				argBox.Set("SkillBefore", lifeSkillId);
				return argBox.GetString("LifeSkillTeachBeforeEventGuid");
			}
		}
		argBox.Set("SkillCanLearn", num);
		return argBox.GetString("LifeSkillTeachEventGuid");
	}

	public static string LearnTargetLifeSkillDependConsummateLevel(sbyte lifeSkillType, EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("CharacterId");
		List<short> charLifeSkillList = GetCharLifeSkillList(character2.GetId(), lifeSkillType, 0, 8, 3, requireTaiwuNotLearn: true);
		if (charLifeSkillList == null || charLifeSkillList.Count == 0)
		{
			return "4f1e6679-8a59-4f88-bf46-682e8c155ce7";
		}
		short num = GetMinGradeLifeSkillList(charLifeSkillList).Sample();
		sbyte lifeSkillGrade = GetLifeSkillGrade(num);
		int num2 = character.GetConsummateLevel() / 2 + 1;
		if (lifeSkillGrade <= num2)
		{
			argBox.Set("SkillCanLearn", num);
			return "2636780e-0cc9-432d-a025-267f218e6c18";
		}
		argBox.Set("CantTeachLife", num);
		return "4a987e91-d35d-4bc7-b8a8-212cafa99a6a";
	}

	public static bool LearnTargetLifeSkillOptionVisible(GameData.Domains.Character.Character character, sbyte lifeSkillType)
	{
		sbyte orgTemplateId = character.GetOrganizationInfo().OrgTemplateId;
		OrganizationItem organizationItem = Config.Organization.Instance[orgTemplateId];
		return organizationItem.LearnLifeSkillTypes.Contains(lifeSkillType);
	}

	public static bool IsCanThreaten(int charA, int charB)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charA);
		GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(charB);
		return element_Objects.GetConsummateLevel() > element_Objects2.GetConsummateLevel();
	}

	public static bool IsThreatenSuccess(int charA, int charB, sbyte concessionCount)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charA);
		GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(charB);
		if (element_Objects2.GetBehaviorType() == 0 || element_Objects2.GetBehaviorType() == 4)
		{
			return false;
		}
		int num = element_Objects.GetConsummateLevel() - element_Objects2.GetConsummateLevel();
		if (element_Objects2.GetBehaviorType() == 2)
		{
			int value = (int)((Math.Pow(1.149999976158142, num) - 1.0) * 100.0);
			return CheckProbability(value);
		}
		if (element_Objects2.GetBehaviorType() == 1)
		{
			int value2 = (int)((Math.Pow(1.2f + (float)concessionCount * 0.05f, num) - 1.0) * 100.0);
			return CheckProbability(value2);
		}
		if (element_Objects2.GetBehaviorType() == 3)
		{
			int value3 = (int)((Math.Pow(1.2f - (float)concessionCount * 0.05f, num) - 1.0) * 100.0);
			return CheckProbability(value3);
		}
		throw new Exception($"Error characterB.GetBehaviorType(), charId= : {element_Objects2}");
	}

	public static bool IsLureSuccess(ItemKey itemKey, int charId, sbyte inducementCount)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		if (element_Objects.GetBehaviorType() == 0 || element_Objects.GetBehaviorType() == 4)
		{
			return false;
		}
		int num = GetItemFavorabilityChange(itemKey);
		short itemSubType = ItemTemplateHelper.GetItemSubType(itemKey.ItemType, itemKey.TemplateId);
		short lovingItemSubType = element_Objects.GetLovingItemSubType();
		short hatingItemSubType = element_Objects.GetHatingItemSubType();
		if (itemSubType == lovingItemSubType)
		{
			num *= 2;
		}
		else if (itemSubType == hatingItemSubType)
		{
			num /= 2;
		}
		if (element_Objects.GetBehaviorType() == 2)
		{
			int value = 50 + (num - 4800) / 108;
			return CheckProbability(value);
		}
		if (element_Objects.GetBehaviorType() == 1)
		{
			int num2 = 40 + (num - 4800) / 108;
			num2 = (int)((double)num2 * Math.Pow(1.1, inducementCount));
			return CheckProbability(num2);
		}
		if (element_Objects.GetBehaviorType() == 3)
		{
			int value2 = 40 + (num - 4800) / 108;
			return CheckProbability(value2);
		}
		throw new Exception($"Error charId.GetBehaviorType(), charId= : {charId}");
	}

	public static void SetLockItemForLifeSkillCombat(ItemKey lockItemKey)
	{
		DomainManager.Taiwu.SetLifeSkillCombatLockItem(Domain.MainThreadDataContext, lockItemKey);
	}

	public static void SetNextLifeSkillCombatForceOperationForbid(bool isForbidForceSilent, bool isForbidForceGiveUp)
	{
		DomainManager.Taiwu.SetNextLifeSkillCombatForceOperationForbid(isForbidForceSilent, isForbidForceGiveUp);
	}

	public static EventArgBox GetFiveLoongEventArgBox()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		return DomainManager.Extra.GetOrCreateDlcArgBox(2764950uL, mainThreadDataContext);
	}

	public static void SetFiveLoongEventArgBox(EventArgBox argBox)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.SetDlcArgBox(2764950uL, argBox, mainThreadDataContext);
	}

	public static void CreateFiveLoongInWorld()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		FiveLoongDlcEntry.CreateAllFiveLoong(mainThreadDataContext);
	}

	public static int GetFiveLoongDictCount()
	{
		return DomainManager.Extra.GetFiveLoongDictCount(Domain.MainThreadDataContext);
	}

	public static int DefeatFiveLoong(short characterTemplateId)
	{
		int result = FiveLoongDlcEntry.DefeatFiveLoong(Domain.MainThreadDataContext, characterTemplateId);
		if (IsExtraTaskInProgress(265) && DomainManager.Extra.GetFiveLoongAppearCount() == 0)
		{
			FinishExtraTask(46, 265);
		}
		return result;
	}

	public static bool HaveDefeatAllLoong()
	{
		bool flag = true;
		for (short num = 686; num <= 690; num++)
		{
			if (DomainManager.Extra.TryGetElement_FiveLoongDict(num, out var value))
			{
				if (value.DisappearDate == 0)
				{
					flag = false;
				}
			}
			else
			{
				flag = false;
			}
			if (!flag)
			{
				break;
			}
		}
		return flag;
	}

	public static bool IsTriggeredDefeatAllLoongTalk()
	{
		EventArgBox fiveLoongEventArgBox = GetFiveLoongEventArgBox();
		bool arg = false;
		if (fiveLoongEventArgBox.Get("ConchShip_PresetKey_FiveLoongDlcDefeatAllLoongTalkTriggered", ref arg) && arg)
		{
			return true;
		}
		return false;
	}

	public static bool HaveDefeatFiveLoong()
	{
		EventArgBox fiveLoongEventArgBox = GetFiveLoongEventArgBox();
		bool arg = false;
		if (fiveLoongEventArgBox.Get("ConchShip_PresetKey_FiveLoongDlcHaveDefeatFiveLoong", ref arg) && arg)
		{
			return true;
		}
		return false;
	}

	public static bool HaveDefeatMinionLoong()
	{
		EventArgBox fiveLoongEventArgBox = GetFiveLoongEventArgBox();
		bool arg = false;
		if (fiveLoongEventArgBox.Get("ConchShip_PresetKey_FiveLoongDlcDefeatMinionLoong", ref arg) && arg)
		{
			return true;
		}
		return false;
	}

	public static bool GotJiaoEgg()
	{
		EventArgBox fiveLoongEventArgBox = GetFiveLoongEventArgBox();
		bool arg = false;
		if (fiveLoongEventArgBox.Get("ConchShip_PresetKey_FiveLoongDlcGotJiaoEgg", ref arg) && arg)
		{
			return true;
		}
		return false;
	}

	public static bool GotLoongScale()
	{
		EventArgBox fiveLoongEventArgBox = GetFiveLoongEventArgBox();
		bool arg = false;
		if (fiveLoongEventArgBox.Get("ConchShip_PresetKey_FiveLoongDlcGotLoongScale", ref arg) && arg)
		{
			return true;
		}
		return false;
	}

	public static bool IsTaiwuHaveLoongCombatMark(short characterTemplateId)
	{
		short elementId = characterTemplateId;
		if (FiveLoongDlcEntry.IsCharacterMinionLoong(characterTemplateId))
		{
			elementId = FiveLoongDlcEntry.MinionLoongToLoong(characterTemplateId);
		}
		else if (!FiveLoongDlcEntry.IsCharacterLoong(characterTemplateId))
		{
			throw new ArgumentOutOfRangeException($"Wrong FiveLoongCharacterTemplateId: {characterTemplateId}");
		}
		if (DomainManager.Extra.TryGetElement_FiveLoongDict(elementId, out var value))
		{
			int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
			return value.GetCharacterDebuffCount(taiwuCharId) > 0;
		}
		return false;
	}

	public static void SetJiaoPoolOpen()
	{
		if (DomainManager.Extra.TryGetDlcEntry<FiveLoongDlcEntry>(2764950uL, out var entry))
		{
			entry.IsJiaoPoolOpen = true;
			TriggerExtraTask(47, 266);
			TriggerExtraTask(47, 273);
		}
	}

	public static bool GetJiaoPoolIsOpen()
	{
		if (!DomainManager.Extra.TryGetDlcEntry<FiveLoongDlcEntry>(2764950uL, out var entry))
		{
			return false;
		}
		return entry.IsJiaoPoolOpen;
	}

	public static short GetLoongTerrainCharacterTemplateId()
	{
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
		short templateId = blockData.TemplateId;
		if (templateId >= 137 && templateId <= 141)
		{
			return (short)(templateId - 137 + 686);
		}
		return -1;
	}

	public static bool FirstArriveLoongTerrainTriggered()
	{
		EventArgBox fiveLoongEventArgBox = GetFiveLoongEventArgBox();
		bool arg = false;
		if (fiveLoongEventArgBox.Get("ConchShip_PresetKey_FiveLoongDlcFirstArriveLoongTerrainTriggered", ref arg) && arg)
		{
			return true;
		}
		return false;
	}

	public static bool IsArriveLoongWhiteTerrainTriggered()
	{
		EventArgBox fiveLoongEventArgBox = GetFiveLoongEventArgBox();
		bool arg = false;
		if (fiveLoongEventArgBox.Get("ConchShip_PresetKey_FiveLoongDlcArriveLoongWhiteTerrain", ref arg) && arg)
		{
			return true;
		}
		return false;
	}

	public static bool IsArriveLoongBlackTerrainTriggered()
	{
		EventArgBox fiveLoongEventArgBox = GetFiveLoongEventArgBox();
		bool arg = false;
		if (fiveLoongEventArgBox.Get("ConchShip_PresetKey_FiveLoongDlcArriveLoongBlackTerrain", ref arg) && arg)
		{
			return true;
		}
		return false;
	}

	public static bool IsArriveLoongRedTerrainTriggered()
	{
		EventArgBox fiveLoongEventArgBox = GetFiveLoongEventArgBox();
		bool arg = false;
		if (fiveLoongEventArgBox.Get("ConchShip_PresetKey_FiveLoongDlcArriveLoongRedTerrain", ref arg) && arg)
		{
			return true;
		}
		return false;
	}

	public static bool IsArriveLoongGreenTerrainTriggered()
	{
		EventArgBox fiveLoongEventArgBox = GetFiveLoongEventArgBox();
		bool arg = false;
		if (fiveLoongEventArgBox.Get("ConchShip_PresetKey_FiveLoongDlcArriveLoongGreenTerrain", ref arg) && arg)
		{
			return true;
		}
		return false;
	}

	public static bool IsArriveLoongYellowTerrainTriggered()
	{
		EventArgBox fiveLoongEventArgBox = GetFiveLoongEventArgBox();
		bool arg = false;
		if (fiveLoongEventArgBox.Get("ConchShip_PresetKey_FiveLoongDlcArriveLoongYellowTerrain", ref arg) && arg)
		{
			return true;
		}
		return false;
	}

	public static bool IsLoongTerrainEventPossibleTriggered()
	{
		EventArgBox fiveLoongEventArgBox = GetFiveLoongEventArgBox();
		bool arg = false;
		bool arg2 = false;
		bool arg3 = false;
		bool arg4 = false;
		bool arg5 = false;
		fiveLoongEventArgBox.Get("ConchShip_PresetKey_FiveLoongDlcArriveLoongWhiteTerrain", ref arg);
		fiveLoongEventArgBox.Get("ConchShip_PresetKey_FiveLoongDlcArriveLoongBlackTerrain", ref arg2);
		fiveLoongEventArgBox.Get("ConchShip_PresetKey_FiveLoongDlcArriveLoongGreenTerrain", ref arg3);
		fiveLoongEventArgBox.Get("ConchShip_PresetKey_FiveLoongDlcArriveLoongRedTerrain", ref arg4);
		fiveLoongEventArgBox.Get("ConchShip_PresetKey_FiveLoongDlcArriveLoongYellowTerrain", ref arg5);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
		MapBlockItem config = blockData.GetConfig();
		if (config.TemplateId == 137)
		{
			return !arg;
		}
		if (config.TemplateId == 138)
		{
			return !arg2;
		}
		if (config.TemplateId == 139)
		{
			return !arg3;
		}
		if (config.TemplateId == 140)
		{
			return !arg4;
		}
		return !arg5;
	}

	public static short GetMapBlockLoongTemplateId(Location location, bool isCharacterClicked)
	{
		if (IsTaiwuAvoidMapBlockEnemies() && !isCharacterClicked)
		{
			return -1;
		}
		if (!DomainManager.Extra.TryGetAnimalIdsByLocation(location, out var animals))
		{
			return -1;
		}
		foreach (int item in animals)
		{
			if (!DomainManager.Extra.TryGetAnimal(item, out var animal))
			{
				continue;
			}
			for (short num = 686; num <= 695; num++)
			{
				if (animal.CharacterTemplateId == num)
				{
					return num;
				}
			}
		}
		return -1;
	}

	public static ItemKey DefeatLoongGetJiaoEgg(short characterTemplateId, sbyte forceGender = -1)
	{
		bool flag = FiveLoongDlcEntry.IsCharacterLoong(characterTemplateId);
		ItemKey result = DomainManager.Extra.DropJiaoEgg(Domain.MainThreadDataContext, flag, characterTemplateId, forceGender);
		Tester.Assert(!flag || result.IsValid(), $"Failed to create jiao egg for loong {characterTemplateId}.");
		return result;
	}

	public static string PlayLoongDebuffAnimation(short characterTemplateId, string afterEvent, EventArgBox argBox)
	{
		if (characterTemplateId >= 691 && characterTemplateId <= 695)
		{
			characterTemplateId -= 5;
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		LoongInfo element_FiveLoongDict = DomainManager.Extra.GetElement_FiveLoongDict(characterTemplateId);
		ushort characterDebuffCount = element_FiveLoongDict.GetCharacterDebuffCount(taiwu.GetId());
		if (characterDebuffCount <= 0)
		{
			return afterEvent;
		}
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "PlayLoongDebuffAnimation");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.PlayLoongDebuffAnimation, characterTemplateId);
		LoongDebuffEffect(characterTemplateId);
		return string.Empty;
	}

	public static void LoongDebuffEffect(short loongCharacterTemplateId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		LoongInfo element_FiveLoongDict = DomainManager.Extra.GetElement_FiveLoongDict(loongCharacterTemplateId);
		ushort characterDebuffCount = element_FiveLoongDict.GetCharacterDebuffCount(taiwu.GetId());
		if (characterDebuffCount <= 0)
		{
			return;
		}
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		int num = 0;
		sbyte b = (sbyte)GetRandom(2, 5);
		int num2 = 0;
		switch (loongCharacterTemplateId)
		{
		case 686:
		{
			for (int l = 0; l < characterDebuffCount; l++)
			{
				Injuries injuries2 = taiwu.GetInjuries();
				sbyte lightestPart2 = injuries2.GetLightestPart(isInner: true);
				int num5 = injuries2.Get(lightestPart2).inner + b - 6;
				if (num5 > 0)
				{
					num += num5;
				}
				taiwu.ChangeInjury(mainThreadDataContext, lightestPart2, isInnerInjury: true, b);
			}
			if (num > 0)
			{
				num2 = Math.Clamp(num * 6, 0, 36);
				taiwu.ChangeHealth(mainThreadDataContext, -num2);
			}
			break;
		}
		case 687:
		{
			int random2 = GetRandom(500, 1000);
			for (int j = 0; j < characterDebuffCount; j++)
			{
				for (int k = 0; k < 3; k++)
				{
					PoisonInts poisoned = taiwu.GetPoisoned();
					sbyte lightestType = poisoned.GetLightestType();
					int poisonMarkCount = taiwu.GetPoisonMarkCount();
					taiwu.ChangePoisoned(mainThreadDataContext, lightestType, 1, random2);
					int poisonMarkCount2 = taiwu.GetPoisonMarkCount();
					if (poisonMarkCount2 - poisonMarkCount > 0)
					{
						num += poisonMarkCount2 - poisonMarkCount;
					}
				}
			}
			num2 = Math.Clamp(num * 2, 0, 36);
			taiwu.ChangeHealth(mainThreadDataContext, -num2);
			break;
		}
		case 688:
		{
			int random = GetRandom(400, 800);
			int num4 = random * characterDebuffCount;
			ChangeRoleDisorderOfQi(taiwu, (short)num4);
			num2 = Math.Clamp(num4 / 1000 * 3, 0, 24);
			taiwu.ChangeHealth(mainThreadDataContext, -num2);
			break;
		}
		case 689:
		{
			for (int i = 0; i < characterDebuffCount; i++)
			{
				Injuries injuries = taiwu.GetInjuries();
				sbyte lightestPart = injuries.GetLightestPart(isInner: false);
				int num3 = injuries.Get(lightestPart).outer + b - 6;
				if (num3 > 0)
				{
					num += num3;
				}
				taiwu.ChangeInjury(mainThreadDataContext, lightestPart, isInnerInjury: false, b);
			}
			if (num > 0)
			{
				num2 = Math.Clamp(num * 6, 0, 36);
				taiwu.ChangeHealth(mainThreadDataContext, -num2);
			}
			break;
		}
		case 690:
			num2 = characterDebuffCount * 12;
			taiwu.ChangeHealth(mainThreadDataContext, -num2);
			break;
		}
	}

	public static void AddCharacterToLoongTalked(int charId)
	{
		EventArgBox fiveLoongEventArgBox = GetFiveLoongEventArgBox();
		if (!fiveLoongEventArgBox.Get<IntList>("ConchShip_PresetKey_FiveLoongDlcArriveLoongYellowTerrain", out IntList arg))
		{
			arg = IntList.Create();
		}
		arg.Items.Add(charId);
		fiveLoongEventArgBox.Set("ConchShip_PresetKey_FiveLoongDlcArriveLoongYellowTerrain", (ISerializableGameData)(object)arg);
		SetFiveLoongEventArgBox(fiveLoongEventArgBox);
	}

	public static bool IsCharacterLoongTalked(int charId)
	{
		EventArgBox fiveLoongEventArgBox = GetFiveLoongEventArgBox();
		if (!fiveLoongEventArgBox.Get<IntList>("ConchShip_PresetKey_FiveLoongDlcArriveLoongYellowTerrain", out IntList arg))
		{
			return false;
		}
		return arg.Items.Contains(charId);
	}

	public static bool IsTriggerLoongDreamBackEvent()
	{
		EventArgBox fiveLoongEventArgBox = GetFiveLoongEventArgBox();
		bool arg = false;
		if (fiveLoongEventArgBox.Get("ConchShip_TaiwuCrossArchiveInheritBuilding", ref arg) && arg)
		{
			return DomainManager.Extra.GetIsJiaoPoolOpen();
		}
		return false;
	}

	public static void SetLoongDreamBackParam()
	{
		TriggerExtraTask(47, 266);
		TriggerExtraTask(47, 273);
		TriggerExtraTask(47, 274);
		EventArgBox fiveLoongEventArgBox = GetFiveLoongEventArgBox();
		fiveLoongEventArgBox.Set("ConchShip_PresetKey_FiveLoongDlcGotLoongScale", arg: true);
		fiveLoongEventArgBox.Set("ConchShip_PresetKey_FiveLoongDlcGotJiaoEgg", arg: true);
		SetFiveLoongEventArgBox(fiveLoongEventArgBox);
	}

	public static GameData.DLC.FiveLoong.Jiao TryGetJiaoData(int jiaoId)
	{
		if (DomainManager.Extra.TryGetElement_Jiaos(jiaoId, out var value))
		{
			return value;
		}
		throw new Exception($"Wrong JiaoId:{jiaoId} ");
	}

	public static short TryGetChildrenOfLoongCharacterTemplateId(int childOfLoongId)
	{
		if (DomainManager.Extra.TryGetElement_ChildrenOfLoong(childOfLoongId, out var value))
		{
			return Config.Jiao.Instance[FiveLoongDlcEntry.CarrierToJiaoTemplate[value.Key.TemplateId]].IndexOfCharacterTemplate;
		}
		throw new Exception($"Wrong JiaoId:{childOfLoongId} ");
	}

	public static int BringUpJiaoFailProb(int jiaoId)
	{
		GameData.DLC.FiveLoong.Jiao jiao = TryGetJiaoData(jiaoId);
		return DomainManager.Extra.BringUpJiaoFailProb(jiao);
	}

	public static int CalcCaptureEscapeJiaoRandomPropertyChangeProb(int jiaoId)
	{
		GameData.DLC.FiveLoong.Jiao jiao = TryGetJiaoData(jiaoId);
		int value = 50 + jiao.AggressiveTimes * 15 - jiao.NegativeTimes * 5;
		return Math.Clamp(value, 0, 100);
	}

	public static void AddJiaoProperty(int jiaoId, short jiaoPropertyTemplateId, sbyte attitudeType)
	{
		Tester.Assert(jiaoPropertyTemplateId >= 0 && jiaoPropertyTemplateId < Config.JiaoProperty.Instance.Count, $"jiaoPropertyTemplateId wrong:{jiaoPropertyTemplateId}");
		GameData.DLC.FiveLoong.Jiao jiao = TryGetJiaoData(jiaoId);
		int jiaoPoolIdByJiaoId = DomainManager.Extra.GetJiaoPoolIdByJiaoId(jiaoId);
		DomainManager.Extra.AddJiaoPropertyInEvent(Domain.MainThreadDataContext, jiao, jiaoPropertyTemplateId, attitudeType, jiaoPoolIdByJiaoId);
	}

	public static short AddJiaoExteriorPropertyRandom(int jiaoId)
	{
		GameData.DLC.FiveLoong.Jiao jiao = TryGetJiaoData(jiaoId);
		return DomainManager.Extra.RandomAddJiaoPresentProperty(Domain.MainThreadDataContext, jiao);
	}

	public static void ChangeJiaoTamePoint(int jiaoId, short jiaoPropertyTemplateId, sbyte attitudeType, bool isComfort = true)
	{
		GameData.DLC.FiveLoong.Jiao jiao = TryGetJiaoData(jiaoId);
		JiaoPropertyItem jiaoPropertyItem = Config.JiaoProperty.Instance[jiaoPropertyTemplateId];
		int delta;
		switch (attitudeType)
		{
		case 0:
			delta = (isComfort ? jiaoPropertyItem.AggressiveComfortParam : jiaoPropertyItem.AggressiveNotComfortParam);
			break;
		case 1:
			return;
		default:
			delta = jiaoPropertyItem.ConservedTameParam;
			break;
		}
		DomainManager.Extra.ChangeJiaoTamePoint(Domain.MainThreadDataContext, jiao, delta);
	}

	public static void AddJiaoAggressiveTimes(int jiaoId, short jiaoPropertyTemplateId)
	{
		GameData.DLC.FiveLoong.Jiao jiao = TryGetJiaoData(jiaoId);
		DomainManager.Extra.AddJiaoAggressiveTimes(Domain.MainThreadDataContext, jiao);
		SetJiaoLastChoiceIsAggressive(jiao, isAggressive: true);
		JiaoPropertyItem jiaoPropertyItem = Config.JiaoProperty.Instance[jiaoPropertyTemplateId];
		DomainManager.Extra.ChangeJiaoTamePoint(Domain.MainThreadDataContext, jiao, jiaoPropertyItem.AggressiveComfortParam);
	}

	public static void AddJiaoNegativeTimes(int jiaoId)
	{
		GameData.DLC.FiveLoong.Jiao jiao = TryGetJiaoData(jiaoId);
		DomainManager.Extra.AddJiaoNegativeTimes(Domain.MainThreadDataContext, jiao);
		SetJiaoLastChoiceIsAggressive(jiao, isAggressive: false);
	}

	public static void SetJiaoLastChoiceIsAggressive(GameData.DLC.FiveLoong.Jiao jiao, bool isAggressive)
	{
		DomainManager.Extra.SetJiaoLastChoiceIsAggressive(Domain.MainThreadDataContext, jiao, isAggressive);
	}

	public static int GetTaiwuLoongScaleCount()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		return taiwu.GetInventory().GetInventoryItemCount(12, 286);
	}

	public static string GetJiaoName(int jiaoId)
	{
		string result = string.Empty;
		if (DomainManager.Extra.TryGetElement_Jiaos(jiaoId, out var value))
		{
			if (value.NameId < 0)
			{
				result = ItemTemplateHelper.GetName(value.Key.ItemType, value.Key.TemplateId);
			}
			else
			{
				IReadOnlyDictionary<int, string> customTexts = DomainManager.World.GetCustomTexts();
				if (customTexts.TryGetValue(value.NameId, out var value2))
				{
					result = value2;
				}
			}
		}
		return result;
	}

	public static int TryGetJiaoIdByItemKey(ItemKey key)
	{
		if (DomainManager.Extra.TryGetJiaoIdByItemKey(key, out var id))
		{
			return id;
		}
		throw new Exception($"Wrong ItemKey:{key} ");
	}

	public static int TryGetChildrenOfLoongIdByItemKey(ItemKey key)
	{
		if (DomainManager.Extra.TryGetChildrenOfLoongIdByItemKey(key, out var id))
		{
			return id;
		}
		throw new Exception($"Wrong ItemKey:{key} ");
	}

	public static (bool, short) KidnapMiscJiao(int jiaoId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.DLC.FiveLoong.Jiao jiao = TryGetJiaoData(jiaoId);
		short num = (short)mainThreadDataContext.Random.Next(0, 9);
		int isDecreaseProperty = DomainManager.Extra.GetIsDecreaseProperty(mainThreadDataContext, jiao);
		int randomEventPropertyDelta = DomainManager.Extra.GetRandomEventPropertyDelta(num, jiao, isDecreaseProperty);
		DomainManager.Extra.AddJiaoProperty(mainThreadDataContext, jiao, num, randomEventPropertyDelta);
		return (isDecreaseProperty > 0, num);
	}

	public static void SetChildOfLoongName(int characterId, int childOfLoongId)
	{
		ChildrenOfLoong childrenOfLoongById = DomainManager.Extra.GetChildrenOfLoongById(childOfLoongId);
		if (childrenOfLoongById.NameId >= 0)
		{
			string element_CustomTexts = DomainManager.World.GetElement_CustomTexts(childrenOfLoongById.NameId);
			if (!string.IsNullOrEmpty(element_CustomTexts))
			{
				DomainManager.Extra.AssignCharacterCustomDisplayName(Domain.MainThreadDataContext, characterId, element_CustomTexts);
				GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(characterId);
				FullName fullName = element_Objects.GetFullName();
				fullName.Type = 8;
				element_Objects.SetFullName(fullName, Domain.MainThreadDataContext);
			}
		}
	}

	public static void UpdateJiaoEvolveRemainingMonth(int jiaoId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.DLC.FiveLoong.Jiao jiao = TryGetJiaoData(jiaoId);
		DomainManager.Extra.UpdateJiaoEvolveRemainingMonth(mainThreadDataContext, jiao);
	}

	public static void JiaoPutInto(int poolId, ItemKey egg, short nurturanceTemplateId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		int id = DomainManager.Extra.GetJiaoByItemKey(egg).Id;
		DomainManager.Extra.PutJiaoInPool(mainThreadDataContext, poolId, id);
		DomainManager.Extra.ChangeNurturance(mainThreadDataContext, poolId, nurturanceTemplateId);
	}

	public static ItemKey JiaoTakeOut(int poolId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		List<ItemKey> list = DomainManager.Extra.PutJiaoOutOfPool(mainThreadDataContext, poolId);
		return (list != null && list.Count > 0) ? list[0] : ItemKey.Invalid;
	}

	public static void JiaoConfirmNurturance(string afterEvent, EventArgBox argBox)
	{
		int poolId = argBox.GetInt("PoolId");
		short arg = argBox.GetShort("Nurturance");
		JiaoPool jiaoPool;
		bool arg2 = DomainManager.Extra.TryGetJiaoPool(poolId, out jiaoPool) && jiaoPool.Jiaos.Count > 0;
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "DlcLoongJiaoDialog");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.ConfirmJiaoNurturanceDialog, arg, arg2);
	}

	public static void JiaoChangeNurturance(int poolId, short nurturanceTemplateId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.ChangeNurturance(mainThreadDataContext, poolId, nurturanceTemplateId);
		DomainManager.Extra.SetJiaoPoolStatus(new IntPair(poolId, 5), mainThreadDataContext);
	}

	public static void JiaoAddTamePoint(int poolId, int addValue)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		if (DomainManager.Extra.TryGetJiaoFromPool(poolId, out var jiao))
		{
			DomainManager.Extra.ChangeJiaoTamePoint(mainThreadDataContext, jiao, addValue);
		}
	}

	public static void JiaoInterruptNurture(int poolId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.SetJiaoPoolStatus(new IntPair(poolId, 6), mainThreadDataContext);
		DomainManager.Extra.JiaoEvolveToCarrier(mainThreadDataContext, poolId);
	}

	public static string JiaoGetNameByPool(int poolId, int index = 0)
	{
		if (!DomainManager.Extra.TryGetJiaoFromPool(poolId, out var jiao, -1, index))
		{
			return string.Empty;
		}
		return jiao.GetNameText();
	}

	public static int JiaoGetIdByPool(int poolId, int index = 0)
	{
		if (!DomainManager.Extra.TryGetJiaoFromPool(poolId, out var jiao, -1, index))
		{
			return -1;
		}
		return jiao.Id;
	}

	public static short JiaoGetCharIdByPool(int poolId)
	{
		if (!DomainManager.Extra.TryGetJiaoFromPool(poolId, out var jiao))
		{
			return -1;
		}
		return Config.Jiao.Instance[jiao.TemplateId].IndexOfCharacterTemplate;
	}

	public static void JiaoCreateTempChar(int poolId, EventArgBox argBox, string key = "CharacterId")
	{
		if (argBox.Contains<int>(key) || !DomainManager.Extra.TryGetJiaoFromPool(poolId, out var jiao))
		{
			return;
		}
		short indexOfCharacterTemplate = Config.Jiao.Instance[jiao.TemplateId].IndexOfCharacterTemplate;
		int num = CreateNonIntelligentCharacter(indexOfCharacterTemplate);
		if (jiao.NameId >= 0)
		{
			string element_CustomTexts = DomainManager.World.GetElement_CustomTexts(jiao.NameId);
			if (!string.IsNullOrEmpty(element_CustomTexts))
			{
				DomainManager.Extra.AssignCharacterCustomDisplayName(Domain.MainThreadDataContext, num, element_CustomTexts);
				GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(num);
				FullName fullName = element_Objects.GetFullName();
				fullName.Type = 8;
				element_Objects.SetFullName(fullName, Domain.MainThreadDataContext);
			}
		}
		argBox.Set(key, num);
		argBox.Set("JiaoId", jiao.Id);
	}

	public static void PetJiao(int poolId)
	{
		if (DomainManager.Extra.TryGetJiaoFromPool(poolId, out var jiao, 1))
		{
			DomainManager.Extra.PetJiao(Domain.MainThreadDataContext, jiao.Id);
		}
	}

	public static bool IsJiaoAbleToPet(int jiaoId)
	{
		return DomainManager.Extra.IsJiaoAbleToPet(jiaoId);
	}

	public static void SetJiaoName(int jiaoCharacterId, int jiaoId)
	{
		GameData.DLC.FiveLoong.Jiao jiaoById = DomainManager.Extra.GetJiaoById(jiaoId);
		if (jiaoById.NameId >= 0)
		{
			string element_CustomTexts = DomainManager.World.GetElement_CustomTexts(jiaoById.NameId);
			if (!string.IsNullOrEmpty(element_CustomTexts))
			{
				DomainManager.Extra.AssignCharacterCustomDisplayName(Domain.MainThreadDataContext, jiaoCharacterId, element_CustomTexts);
				GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(jiaoCharacterId);
				FullName fullName = element_Objects.GetFullName();
				fullName.Type = 8;
				element_Objects.SetFullName(fullName, Domain.MainThreadDataContext);
			}
		}
	}

	public static void JiaoRemoveTempChar(EventArgBox argBox, string key = "CharacterId")
	{
		if (argBox.Contains<int>(key))
		{
			GameData.Domains.Character.Character character = argBox.GetCharacter(key);
			RemoveNonIntelligentCharacter(character);
			DomainManager.Extra.RemoveCharacterCustomDisplayName(Domain.MainThreadDataContext, character.GetId());
			argBox.Remove<int>(key);
		}
	}

	public static short JiaoGetExistNurturance(int poolId, int index = 0)
	{
		if (!DomainManager.Extra.TryGetJiaoFromPool(poolId, out var jiao, -1, index))
		{
			return -1;
		}
		return jiao.NurturanceTemplateId;
	}

	public static bool JiaoIsNurturanceSamePool(int poolId, short nurturanceTemplateId)
	{
		return JiaoGetExistNurturance(poolId) == nurturanceTemplateId;
	}

	public static bool JiaoIsMatchStage(int poolId, sbyte growthStage)
	{
		if (!DomainManager.Extra.TryGetJiaoFromPool(poolId, out var jiao))
		{
			return false;
		}
		if (!DomainManager.Extra.TryGetJiaoPool(poolId, out var jiaoPool))
		{
			return false;
		}
		return jiao.GrowthStage == growthStage && jiaoPool.Jiaos.Count == 1;
	}

	public static bool JiaoIsBreeding(int poolId)
	{
		if (!DomainManager.Extra.TryGetJiaoPool(poolId, out var jiaoPool))
		{
			return false;
		}
		return jiaoPool.Jiaos.Count > 1;
	}

	public static void JiaoShowDialog(string dialogTitleIdName, string dialogContentIdName, string nextEventGuid = "", EventArgBox argBox = null)
	{
		ShowDialogFromEvent("<Language Key=" + dialogTitleIdName + "/>", "<Language Key=" + dialogContentIdName + "/>", 1, nextEventGuid, argBox);
	}

	public static void JiaoSetFostered(int poolId)
	{
		DomainManager.Extra.SetJiaoFostered(poolId);
	}

	public static bool JiaoIsFostered(int poolId)
	{
		return DomainManager.Extra.IsJiaoFostered(poolId);
	}

	public static string HandleJiaoCombatResult(EventArgBox argBox)
	{
		short arg = 0;
		argBox.Get("LoongCharacterTemplateId", ref arg);
		int arg2 = 0;
		argBox.Get("JiaoId", ref arg2);
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		Location location = character.GetLocation();
		int arg3 = -1;
		argBox.Get("AnimalId", ref arg3);
		GameData.Domains.Character.Animal animal = TryGetAnimal(arg3);
		ItemKey itemKey = animal.ItemKey;
		bool flag = itemKey.ItemType == 5;
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("Jiao");
		RemoveNonIntelligentCharacter(character2);
		string empty = string.Empty;
		if (argBox.Get<ItemKey>("ItemKeySeizeCarrierInCombat", out ItemKey arg4))
		{
			RemoveFleeCarrierLocation(itemKey);
			RemoveAnimal(animal);
			ApplyAnimalTamingResult(character, animal, isWin: true, character.GetLocation(), arg4);
			if (!flag)
			{
				AddInventoryItem(character, itemKey);
				argBox.Set("EscapeCarriers", GetJiaoName(arg2));
				empty = "33fb78b2-c124-4919-96d6-6b98d4ce3712";
			}
			else
			{
				(bool, short) tuple = KidnapMiscJiao(arg2);
				empty = ((!tuple.Item1) ? "2c136803-4be2-4cec-9374-63bee19ffb95" : "617c2a29-381b-4292-8c24-4e7910c2c953");
				JiaoPropertyItem jiaoPropertyItem = Config.JiaoProperty.Instance[tuple.Item2];
				argBox.Set("JiaoPropertyDesc", tuple.Item1 ? jiaoPropertyItem.EventDescUp : jiaoPropertyItem.EventDescDown);
			}
			ShowGetItemPageForItems(new List<(ItemKey, int)> { (itemKey, 1) }, empty, argBox);
			return string.Empty;
		}
		int arg5 = 0;
		if (argBox.Get("CombatResult", ref arg5))
		{
			if (arg5 == 0 || arg5 == 5)
			{
				if (!flag)
				{
					argBox.Set("EscapeCarriers", GetJiaoName(arg2));
					ShowGetItemPageForItems(new List<(ItemKey, int)> { (itemKey, 1) }, "33fb78b2-c124-4919-96d6-6b98d4ce3712", argBox);
					RemoveFleeCarrierLocation(itemKey);
					RemoveAnimal(animal);
					AddInventoryItem(character, itemKey);
					return string.Empty;
				}
				return "5da7e3bd-788f-4564-a0e6-8c7bb41d432a";
			}
			return arg5 switch
			{
				3 => "85fac506-be5c-40ec-833b-ee2dd6835d85", 
				2 => "9205d907-63b3-4e79-bf88-b239f47cb2c6", 
				1 => "cfbe4c8c-829e-4eeb-8051-4f199c971f5a", 
				_ => "9205d907-63b3-4e79-bf88-b239f47cb2c6", 
			};
		}
		return string.Empty;
	}

	public static bool GetMainStoryPartTwoUnLockState()
	{
		return true;
	}

	public static bool GetIsQuickStartGame()
	{
		EventArgBox globalEventArgumentBox = DomainManager.TaiwuEvent.GetGlobalEventArgumentBox();
		return globalEventArgumentBox.GetBool("CS_PK_IsQuickStartGame");
	}

	public static void OpenMonthNotifyForStartCricketContent(string listenEventId, EventArgBox argBox)
	{
		Domain.SetListenerWithActionName(listenEventId, argBox, "MonthNotifyShowed");
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenMonthNotifyForCricketContent);
	}

	public static void OpenAdventurePrepare(short adventureTemplateId, bool forceSameLocation)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		if (!forceSameLocation || CheckAdventureSiteState(taiwu.GetLocation(), adventureTemplateId, 1))
		{
			GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenAdventurePrepare, adventureTemplateId);
		}
	}

	public static void OperateBlackMask(bool animShowMask, float animTime, bool hideMaskAfterShow)
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OperateBlackMaskView, animShowMask, animTime, hideMaskAfterShow);
	}

	public static Location[] GetBrokenPerformAreaLocationData()
	{
		short areaId = 138;
		Location postLocation = Location.Invalid;
		Location wangliuzhaiLocation = Location.Invalid;
		IterateAreaBlocks(areaId, delegate(MapBlockData data)
		{
			if (data.TemplateId == 38)
			{
				postLocation = new Location(areaId, data.BlockId);
			}
			if (data.TemplateId == 36)
			{
				wangliuzhaiLocation = new Location(areaId, data.BlockId);
			}
		});
		return new Location[2] { postLocation, wangliuzhaiLocation };
	}

	public static int CreateChuiXingGraveAndAddRelationWithHuanYue(Location location, sbyte level, int deathDate, int huanYueCharId)
	{
		int num = CreateFixedCharacterGrave(468, location, level, deathDate);
		DomainManager.Character.AddRelation(Domain.MainThreadDataContext, num, huanYueCharId, 4);
		return num;
	}

	public static void StartShowSwordTombCreate()
	{
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		List<Location> list = new List<Location>();
		for (int i = 1; i < 8; i++)
		{
			list.Add(DomainManager.Map.GetElement_SwordTombLocations(i));
		}
		list.Add(DomainManager.Map.GetElement_SwordTombLocations(0));
		list.Add(taiwuVillageLocation);
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.StartCreateSwordTomb, list);
	}

	public static int CreateBreakTombXiangshuFixedCharacterAtIndex(sbyte index)
	{
		sbyte xiangshuLevel = DomainManager.World.GetXiangshuLevel();
		Location element_SwordTombLocations = DomainManager.Map.GetElement_SwordTombLocations(index);
		MapBlockData block = DomainManager.Map.GetBlock(element_SwordTombLocations);
		short templateId = block.TemplateId;
		sbyte b = (sbyte)XiangshuAvatarIds.SwordTombBlockTemplateIds.IndexOf(templateId);
		if (b < 0)
		{
			throw new Exception($"{element_SwordTombLocations} has no sword tomb,can not create xiangshu fixed character!");
		}
		short currentLevelXiangshuTemplateId = XiangshuAvatarIds.GetCurrentLevelXiangshuTemplateId(b, xiangshuLevel, isWeakened: true);
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(currentLevelXiangshuTemplateId);
		MoveFixedCharacter(orCreateFixedCharacterByTemplateId, GetBlockLocationGroup(element_SwordTombLocations).Sample());
		return orCreateFixedCharacterByTemplateId.GetId();
	}

	public static Location GetSwordTombLocationAtIndex(sbyte index)
	{
		Location location = DomainManager.Map.GetElement_SwordTombLocations(index);
		List<Location> blockLocationGroup = GetBlockLocationGroup(location);
		foreach (Location item in blockLocationGroup)
		{
			if (CheckBlockHasAdventure(item))
			{
				AdventureItem adventureConfigOfLocation = GetAdventureConfigOfLocation(item);
				if (XiangshuAvatarIds.SwordTombAdventureTemplateIds.Contains(adventureConfigOfLocation.TemplateId))
				{
					location = item;
					break;
				}
			}
		}
		return location;
	}

	public static void RemoveSwordTombFromLocation(Location location)
	{
		List<Location> blockLocationGroup = GetBlockLocationGroup(location);
		short nearestSettlementIdByLocation = DomainManager.Map.GetNearestSettlementIdByLocation(location);
		List<short[]> noDevelopedIdList = new List<short[]>();
		List<short> developedIdList = new List<short>();
		MapBlock.Instance.Iterate(delegate(MapBlockItem e)
		{
			if (e.Size > 1)
			{
				return true;
			}
			if (e.Type == EMapBlockType.Developed && e.CanGenerate)
			{
				developedIdList.Add(e.TemplateId);
			}
			if (e.Type == EMapBlockType.Normal && e.CanGenerate)
			{
				noDevelopedIdList.Add(new short[2] { e.TemplateId, 15 });
			}
			if (e.Type == EMapBlockType.Wild && e.CanGenerate)
			{
				noDevelopedIdList.Add(new short[2] { e.TemplateId, 60 });
			}
			if (e.Type == EMapBlockType.Bad && e.CanGenerate && e.SubType != EMapBlockSubType.Ruin && e.SubType != EMapBlockSubType.DarkPool)
			{
				noDevelopedIdList.Add(new short[2] { e.TemplateId, 25 });
			}
			return true;
		});
		short rootBlockId = DomainManager.Map.GetBlock(location).RootBlockId;
		if (rootBlockId != -1)
		{
			location = new Location(location.AreaId, rootBlockId);
		}
		DomainManager.Map.ChangeBlockTemplate(Domain.MainThreadDataContext, location, noDevelopedIdList.Sample()[0], isTurnVisible: true);
		foreach (Location item in blockLocationGroup)
		{
			short[] randomCellFromWeightCore = GetRandomCellFromWeightCore(noDevelopedIdList);
			short blockTemplateId = randomCellFromWeightCore[0];
			if (DomainManager.Map.IsLocationInSettlementInfluenceRange(item, nearestSettlementIdByLocation))
			{
				blockTemplateId = developedIdList.GetRandom(Domain.MainThreadDataContext.Random);
			}
			DomainManager.Map.ChangeBlockTemplate(Domain.MainThreadDataContext, item, blockTemplateId, isTurnVisible: true);
			MapBlockData block = DomainManager.Map.GetBlock(item);
			block.Destroyed = true;
			block.CurrResources.Initialize();
		}
	}

	public static void RemoveNonIntelligentCharacter(GameData.Domains.Character.Character nonIntelligentCharacter)
	{
		if (nonIntelligentCharacter != null)
		{
			byte creatingType = nonIntelligentCharacter.GetCreatingType();
			int id = nonIntelligentCharacter.GetId();
			Tester.Assert(creatingType != 1, $"charId{id}: {creatingType} != CreatingType.IntelligentCharacter");
			DomainManager.Character.RemoveNonIntelligentCharacter(Domain.MainThreadDataContext, nonIntelligentCharacter);
		}
	}

	public static void RemoveXiangshuFixedCharacter(GameData.Domains.Character.Character xiangshuChar)
	{
		if (xiangshuChar == null)
		{
			throw new Exception("null xiangshu character,can not remove!");
		}
		MoveFixedCharacter(xiangshuChar, Location.Invalid);
		DomainManager.Character.RemoveNonIntelligentCharacter(Domain.MainThreadDataContext, xiangshuChar);
	}

	public static GameData.Domains.Character.Character GetUndefeatedXiangshuCharacterForStory()
	{
		sbyte[] xiangshuAvatarTasksInOrder = DomainManager.World.GetXiangshuAvatarTasksInOrder();
		sbyte b = xiangshuAvatarTasksInOrder[0];
		short templateId = (short)(479 + b);
		return GetOrCreateFixedCharacterByTemplateId(templateId);
	}

	public static GameData.Domains.Character.Character GetCanDefeatedXiangshuCharacterForStory()
	{
		sbyte[] xiangshuAvatarTasksInOrder = DomainManager.World.GetXiangshuAvatarTasksInOrder();
		sbyte xiangshuAvatarId = xiangshuAvatarTasksInOrder[0];
		short currentLevelXiangshuTemplateId = XiangshuAvatarIds.GetCurrentLevelXiangshuTemplateId(xiangshuAvatarId, 8, isWeakened: true);
		return GetOrCreateFixedCharacterByTemplateId(currentLevelXiangshuTemplateId);
	}

	public static void SetFirstSwordTombFinish()
	{
		sbyte[] xiangshuAvatarTasksInOrder = DomainManager.World.GetXiangshuAvatarTasksInOrder();
		DomainManager.World.SetSwordTombStatus(Domain.MainThreadDataContext, xiangshuAvatarTasksInOrder[0], 2);
	}

	public static void CreateAllSwordTombAdventure()
	{
		if (CheckMainStoryLineProgress(19))
		{
			return;
		}
		for (int i = 1; i < 8; i++)
		{
			Location element_SwordTombLocations = DomainManager.Map.GetElement_SwordTombLocations(i);
			List<Location> blockLocationGroup = GetBlockLocationGroup(element_SwordTombLocations);
			blockLocationGroup.RemoveAll(CheckBlockHasAdventure);
			element_SwordTombLocations = blockLocationGroup.Sample();
			MapBlockData block = DomainManager.Map.GetBlock(element_SwordTombLocations);
			int num = XiangshuAvatarIds.SwordTombBlockTemplateIds.IndexOf(block.TemplateId);
			if (num >= 0)
			{
				short num2 = XiangshuAvatarIds.SwordTombAdventureTemplateIds[num];
				if (!CheckAdventureSiteState(element_SwordTombLocations, num2, 1) && TryCreateAdventureSite(element_SwordTombLocations.AreaId, element_SwordTombLocations.BlockId, num2, setBlockVisible: true))
				{
					DomainManager.Adventure.SetAdventureRemainingMonths(Domain.MainThreadDataContext, element_SwordTombLocations.AreaId, element_SwordTombLocations.BlockId, -1);
				}
			}
		}
		StartNextSwordTombCountDown();
	}

	public static void CreateChickenCoopAtTaiwuVillage()
	{
		if (!DomainManager.Building.IsTaiwuVillageHaveSpecifyBuilding(49))
		{
			DomainManager.Building.PlaceBuildingAtBlock(Domain.MainThreadDataContext, EventArgBox.TaiwuVillageAreaId, EventArgBox.TaiwuVillageBlockId, 49, forcePlace: true, isRandom: false);
		}
	}

	public static void CreateKitchenAtSecretVillage(Location villageLocation)
	{
		DomainManager.Building.PlaceBuildingAtBlock(Domain.MainThreadDataContext, villageLocation.AreaId, villageLocation.BlockId, 203, forcePlace: true, isRandom: false);
	}

	public static void CreateChickenKingToTaiwuVillage()
	{
		short templateId = 63;
		int chickenId = DomainManager.Building.AddChicken(Domain.MainThreadDataContext, DomainManager.Taiwu.GetTaiwuVillageSettlementId(), templateId);
		DomainManager.Building.SetChickenHappiness(Domain.MainThreadDataContext, chickenId, 100);
	}

	public static void SetSecretVillageOnFire(bool onFire)
	{
		Domain.SetSecretVillageOnFire(onFire, Domain.MainThreadDataContext);
	}

	public static void SetTaiwuVillageShowShrine(bool shrineVisible)
	{
		Domain.SetTaiwuVillageShowShrine(shrineVisible, Domain.MainThreadDataContext);
	}

	public static void MakeBrokenPerformAreaCharacterAllDead()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		MapDomain map = DomainManager.Map;
		CharacterDomain character = DomainManager.Character;
		short num = 138;
		HashSet<int> hashSet = new HashSet<int>();
		short num2 = -1;
		short templateId = map.GetElement_Areas(num).GetTemplateId();
		sbyte stateIdByStateTemplateId = map.GetStateIdByStateTemplateId(DomainManager.World.GetTaiwuVillageStateTemplateId());
		for (int i = 0; i < 6; i++)
		{
			num2 = (short)(45 + stateIdByStateTemplateId * 6 + i);
			if (map.GetElement_Areas(num2).GetTemplateId() == templateId)
			{
				break;
			}
		}
		Tester.Assert(num2 >= 0);
		Span<MapBlockData> areaBlocks = map.GetAreaBlocks(num);
		Span<MapBlockData> span = areaBlocks;
		for (int j = 0; j < span.Length; j++)
		{
			MapBlockData mapBlockData = span[j];
			if (mapBlockData.CharacterSet != null)
			{
				hashSet.UnionWith(mapBlockData.CharacterSet);
			}
		}
		MapBlockData[] list = (from block in map.GetAreaBlocks(num2).ToArray()
			where block.IsPassable()
			select block).ToArray();
		foreach (int item in hashSet)
		{
			GameData.Domains.Character.Character element_Objects = character.GetElement_Objects(item);
			Location location = element_Objects.GetLocation();
			Location location2 = new Location(num2, list.Sample().BlockId);
			element_Objects.SetLocation(location2, mainThreadDataContext);
			Events.RaiseCharacterLocationChanged(mainThreadDataContext, item, location, location2);
		}
		foreach (int item2 in hashSet)
		{
			GameData.Domains.Character.Character element_Objects2 = character.GetElement_Objects(item2);
			if (element_Objects2.IsActiveExternalRelationState(2))
			{
				List<KidnappedCharacter> collection = DomainManager.Character.GetKidnappedCharacters(element_Objects2.GetId()).GetCollection();
				for (int num3 = collection.Count - 1; num3 >= 0; num3--)
				{
					int charId = collection[num3].CharId;
					GameData.Domains.Character.Character element_Objects3 = DomainManager.Character.GetElement_Objects(charId);
					character.MakeCharacterDead(mainThreadDataContext, element_Objects3, 10);
				}
			}
			character.MakeCharacterDead(mainThreadDataContext, element_Objects2, 10);
		}
		HashSet<int> collection2 = DomainManager.Taiwu.GetGroupCharIds().GetCollection();
		foreach (int item3 in collection2)
		{
			GameData.Domains.Character.Character element_Objects4 = DomainManager.Character.GetElement_Objects(item3);
			if (!element_Objects4.IsActiveExternalRelationState(2))
			{
				continue;
			}
			List<KidnappedCharacter> collection3 = DomainManager.Character.GetKidnappedCharacters(element_Objects4.GetId()).GetCollection();
			for (int num4 = collection3.Count - 1; num4 >= 0; num4--)
			{
				int charId2 = collection3[num4].CharId;
				GameData.Domains.Character.Character element_Objects5 = DomainManager.Character.GetElement_Objects(charId2);
				if (element_Objects5.GetOrganizationInfo().OrgTemplateId == 38)
				{
					DomainManager.Organization.ChangeOrganization(mainThreadDataContext, element_Objects5, OrganizationInfo.None);
				}
			}
		}
	}

	public static void DeActivateAllSwordTombAdventure()
	{
		short taiwuVillageAreaId = EventArgBox.TaiwuVillageAreaId;
		AreaAdventureData adventuresInArea = DomainManager.Adventure.GetAdventuresInArea(taiwuVillageAreaId);
		foreach (KeyValuePair<short, AdventureSiteData> adventureSite in adventuresInArea.AdventureSites)
		{
			if (XiangshuAvatarIds.SwordTombAdventureTemplateIds.Contains(adventureSite.Value.TemplateId))
			{
				DomainManager.Adventure.DeactivateAdventureSite(Domain.MainThreadDataContext, taiwuVillageAreaId, adventureSite.Key);
			}
		}
	}

	public static void ActivateSwordTombAdventure(Location location, sbyte monthCount = sbyte.MinValue)
	{
		AreaAdventureData adventuresInArea = DomainManager.Adventure.GetAdventuresInArea(location.AreaId);
		if (!adventuresInArea.AdventureSites.TryGetValue(location.BlockId, out var value) || XiangshuAvatarIds.SwordTombAdventureTemplateIds.Contains(value.TemplateId))
		{
			DomainManager.Adventure.ActivateAdventureSite(Domain.MainThreadDataContext, location.AreaId, location.BlockId);
			if (monthCount != sbyte.MinValue)
			{
				DomainManager.Adventure.SetAdventureRemainingMonths(Domain.MainThreadDataContext, location.AreaId, location.BlockId, monthCount);
			}
		}
	}

	public static List<Location> GetRemainingSwordTombAdventure()
	{
		List<Location> list = new List<Location>();
		AreaAdventureData adventuresInArea = DomainManager.Adventure.GetAdventuresInArea(EventArgBox.TaiwuVillageAreaId);
		foreach (KeyValuePair<short, AdventureSiteData> adventureSite in adventuresInArea.AdventureSites)
		{
			AdventureSiteData value = adventureSite.Value;
			if (XiangshuAvatarIds.SwordTombAdventureTemplateIds.Contains(value.TemplateId) && value.SiteState == 0)
			{
				list.Add(new Location(EventArgBox.TaiwuVillageAreaId, adventureSite.Key));
			}
		}
		return list;
	}

	public static short GetSwordTombAdventureMaxMonthCount()
	{
		return DomainManager.Adventure.GetSwordTombAdventureMaxMonthCount();
	}

	public static void OpenLegacyActivate()
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenLegacyActivate);
	}

	public static Location GetLastSwordTombLocation()
	{
		AreaAdventureData adventuresInArea = DomainManager.Adventure.GetAdventuresInArea(EventArgBox.TaiwuVillageAreaId);
		Span<short> span = stackalloc short[9];
		span.Fill(-1);
		foreach (KeyValuePair<short, AdventureSiteData> adventureSite in adventuresInArea.AdventureSites)
		{
			adventureSite.Deconstruct(out var key, out var value);
			short num = key;
			AdventureSiteData adventureSiteData = value;
			sbyte xiangshuAvatarIdBySwordTomb = XiangshuAvatarIds.GetXiangshuAvatarIdBySwordTomb(adventureSiteData.TemplateId);
			if (xiangshuAvatarIdBySwordTomb >= 0)
			{
				span[xiangshuAvatarIdBySwordTomb] = num;
			}
		}
		sbyte[] xiangshuAvatarTasksInOrder = DomainManager.World.GetXiangshuAvatarTasksInOrder();
		for (sbyte b = 8; b >= 0; b--)
		{
			sbyte b2 = xiangshuAvatarTasksInOrder[b];
			if (b2 >= 0)
			{
				short num2 = span[b2];
				if (num2 >= 0)
				{
					return new Location(EventArgBox.TaiwuVillageAreaId, num2);
				}
			}
		}
		return Location.Invalid;
	}

	public static void SetNextSwordTombCountDownDate()
	{
		byte bossInvasionSpeedType = DomainManager.World.GetBossInvasionSpeedType();
		short num = GlobalConfig.SwordTombAdventureCountDownCoolDown[bossInvasionSpeedType];
		if (DomainManager.World.GetMainStoryLineProgress() > 22)
		{
			num /= 3;
		}
		int value = GetGameDate() + num;
		SaveGlobalArg("ConchShip_PresetKey_DateOfNextSwordTombActivate", value);
	}

	public static void SetNextSwordTombAdventureCoolDownByFromAdventure(sbyte xiangshuAvatarId)
	{
		if (!GlobalArgBoxContainsKey<int>("ConchShip_PresetKey_DateOfNextSwordTombActivate"))
		{
			SetNextSwordTombCountDownDate();
			return;
		}
		sbyte[] xiangshuAvatarTasksInOrder = DomainManager.World.GetXiangshuAvatarTasksInOrder();
		Dictionary<short, sbyte> dictionary = new Dictionary<short, sbyte>
		{
			{ 114, 0 },
			{ 111, 1 },
			{ 108, 2 },
			{ 110, 3 },
			{ 109, 4 },
			{ 113, 5 },
			{ 116, 6 },
			{ 115, 7 },
			{ 112, 8 }
		};
		AreaAdventureData adventuresInArea = DomainManager.Adventure.GetAdventuresInArea(EventArgBox.TaiwuVillageAreaId);
		Dictionary<sbyte, KeyValuePair<short, AdventureSiteData>> dictionary2 = new Dictionary<sbyte, KeyValuePair<short, AdventureSiteData>>();
		foreach (KeyValuePair<short, AdventureSiteData> adventureSite in adventuresInArea.AdventureSites)
		{
			if (dictionary.TryGetValue(adventureSite.Value.TemplateId, out var value))
			{
				if (adventureSite.Value.RemainingMonths > 0)
				{
					return;
				}
				dictionary2.Add(value, adventureSite);
			}
		}
		foreach (sbyte b in xiangshuAvatarTasksInOrder)
		{
			if (dictionary2.ContainsKey(b) && b == xiangshuAvatarId)
			{
				SetNextSwordTombCountDownDate();
				break;
			}
		}
	}

	public static void StartNextSwordTombCountDown()
	{
		DomainManager.Adventure.StartNextSwordTombCountDown();
	}

	public static Location MoveTaiwuAndRanchenziToDoubleGirl()
	{
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		List<Location> mapBlocksNearLocation = GetMapBlocksNearLocation(location, 10);
		List<Location> neighborListOf9 = GetMapBlocksNearLocation(location, 9);
		mapBlocksNearLocation.RemoveAll((Location e) => neighborListOf9.Contains(e));
		mapBlocksNearLocation.RemoveAll((Location e) => CheckBlockMatchTemplate(e, -1, EMapBlockType.City));
		mapBlocksNearLocation.RemoveAll((Location e) => CheckBlockMatchTemplate(e, -1, EMapBlockType.Town));
		mapBlocksNearLocation.RemoveAll((Location e) => CheckBlockMatchTemplate(e, -1, EMapBlockType.Station));
		mapBlocksNearLocation.RemoveAll((Location e) => CheckBlockMatchTemplate(e, -1, EMapBlockType.Invalid, EMapBlockSubType.Ruin));
		mapBlocksNearLocation.RemoveAll((Location e) => CheckBlockMatchTemplate(e, -1, EMapBlockType.Invalid, EMapBlockSubType.DarkPool));
		mapBlocksNearLocation.RemoveAll((Location e) => CheckBlockMatchTemplate(e, -1, EMapBlockType.Invalid, EMapBlockSubType.Block));
		mapBlocksNearLocation.RemoveAll((Location e) => CheckBlockMatchTemplate(e, -1, EMapBlockType.Invalid, EMapBlockSubType.SwordTomb));
		mapBlocksNearLocation.RemoveAll((Location e) => !DomainManager.Map.GetBlock(e).IsPassable());
		Location location2 = mapBlocksNearLocation.Sample();
		DomainManager.Map.SetBlockAndViewRangeVisible(Domain.MainThreadDataContext, location2.AreaId, location2.BlockId);
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(441);
		MoveFixedCharacter(orCreateFixedCharacterByTemplateId, location2);
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.MainStoryMoveTaiwuAndRanChenZi, location, location2);
		return location2;
	}

	public static void SetHideAllTeammates(bool hideState)
	{
		int[] allCombatGroupChars = Domain.GetAllCombatGroupChars();
		int i = 0;
		for (int num = 3; i < num; i++)
		{
			if (hideState)
			{
				int element_CombatGroupCharIds = DomainManager.Taiwu.GetElement_CombatGroupCharIds(i);
				allCombatGroupChars[i] = element_CombatGroupCharIds;
				DomainManager.Taiwu.SetElement_CombatGroupCharIds(i, -1, Domain.MainThreadDataContext);
				continue;
			}
			int num2 = allCombatGroupChars[i];
			if (DomainManager.Taiwu.GetTaiwuCharId() == num2 || !DomainManager.Character.IsCharacterAlive(num2))
			{
				num2 = -1;
			}
			DomainManager.Taiwu.SetElement_CombatGroupCharIds(i, num2, Domain.MainThreadDataContext);
		}
		Domain.SetAllCombatGroupChars(allCombatGroupChars, Domain.MainThreadDataContext);
		Domain.SetHideAllTeammates(hideState, Domain.MainThreadDataContext);
	}

	public static sbyte GetUndefeatedXiangshuAvatarId()
	{
		return DomainManager.World.GetXiangshuAvatarTasksInOrder()[^1];
	}

	public static sbyte GetXiangshuAvatarIdInOrderOfIndex(sbyte index)
	{
		sbyte[] xiangshuAvatarTasksInOrder = DomainManager.World.GetXiangshuAvatarTasksInOrder();
		return xiangshuAvatarTasksInOrder[index];
	}

	public static Location GetFuMoShenGuangLocationByIndex(sbyte index)
	{
		byte areaSize = DomainManager.Map.GetAreaSize(EventArgBox.TaiwuVillageAreaId);
		ByteCoordinate byteCoordinate = ByteCoordinate.IndexToCoordinate(EventArgBox.TaiwuVillageBlockId, areaSize);
		byte b = byteCoordinate.X;
		byte b2 = byteCoordinate.Y;
		switch (index)
		{
		case 0:
			b += 3;
			break;
		case 1:
			b -= 3;
			break;
		case 2:
			b2 += 3;
			break;
		case 3:
			b2 -= 3;
			break;
		case 4:
			b += 2;
			b2 += 2;
			break;
		case 5:
			b -= 2;
			b2 -= 2;
			break;
		case 6:
			b -= 2;
			b2 += 2;
			break;
		case 7:
			b += 2;
			b2 -= 2;
			break;
		case 8:
			return DomainManager.Taiwu.GetTaiwuVillageLocation();
		default:
			throw new Exception($"wrong index {index} passed to get fumoshenguang location!");
		}
		short blockId = ByteCoordinate.CoordinateToIndex(new ByteCoordinate(b, b2), areaSize);
		return new Location(EventArgBox.TaiwuVillageAreaId, blockId);
	}

	public static GameData.Domains.Character.Character CreateTaiwuShadowEnemy()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		GameData.Domains.Character.Character character = DomainManager.Character.CreateTemporaryCopyOfCharacter(Domain.MainThreadDataContext, taiwu);
		DomainManager.Adventure.AddTemporaryIntelligentCharacter(character.GetId());
		return character;
	}

	public static void MakeWorldChaos()
	{
		List<MapBlockData> list = new List<MapBlockData>();
		List<MapBlockData> list2 = new List<MapBlockData>();
		List<MapBlockData> list3 = new List<MapBlockData>();
		List<short> ruinBlockTemplateIdList = new List<short> { 118, 119, 120, 121, 122, 123 };
		for (short num = 0; num < 45; num++)
		{
			if (num != EventArgBox.TaiwuVillageAreaId)
			{
				list.Clear();
				list2.Clear();
				list3.Clear();
				Span<MapBlockData> areaBlocks = DomainManager.Map.GetAreaBlocks(num);
				Span<MapBlockData> span = areaBlocks;
				for (int i = 0; i < span.Length; i++)
				{
					MapBlockData mapBlockData = span[i];
					MapBlockItem config = mapBlockData.GetConfig();
					if (MapBlockDataMatchers.CanBeRuinedByXiangshu(mapBlockData) && config.Size <= 1)
					{
						if (config.Type == EMapBlockType.Developed)
						{
							list3.Add(mapBlockData);
						}
						if (config.Type == EMapBlockType.Normal)
						{
							list2.Add(mapBlockData);
						}
						if ((config.Type == EMapBlockType.Wild || config.Type == EMapBlockType.Bad) && config.SubType != EMapBlockSubType.SwordTomb && config.SubType != EMapBlockSubType.Ruin)
						{
							list.Add(mapBlockData);
						}
					}
				}
				ChangeBlockToRuin(list, (int)((float)list.Count * 0.3f));
				ChangeBlockToRuin(list2, (int)((float)list2.Count * 0.2f));
				ChangeBlockToRuin(list3, (int)((float)list3.Count * 0.1f));
			}
		}
		DomainManager.Character.GenerateSkeletons(Domain.MainThreadDataContext);
		void ChangeBlockToRuin(List<MapBlockData> list4, int countMax)
		{
			CollectionUtils.Shuffle(Domain.MainThreadDataContext.Random, list4);
			for (int j = 0; j < countMax; j++)
			{
				Location location = new Location(list4[j].AreaId, list4[j].BlockId);
				ChangeLocationBlockType(location, ruinBlockTemplateIdList.Sample());
				MapBlockData block = DomainManager.Map.GetBlock(location);
				block.SetVisible(visible: true, Domain.MainThreadDataContext);
				block.InitResources(Domain.MainThreadDataContext.Random);
				DomainManager.Map.SetBlockData(Domain.MainThreadDataContext, block);
				if (block.GroupBlockList != null)
				{
					foreach (MapBlockData groupBlock in block.GroupBlockList)
					{
						ChangeLocationBlockType(groupBlock.GetLocation(), ruinBlockTemplateIdList.Sample());
						groupBlock.InitResources(Domain.MainThreadDataContext.Random);
						DomainManager.Map.SetBlockData(Domain.MainThreadDataContext, groupBlock);
					}
				}
			}
			list4.RemoveRange(countMax, list4.Count - countMax);
			if (list4.Count > 0)
			{
				GenerateXiangshuMinions(list4);
			}
		}
	}

	public static void PrepareSectMembersAndTaiwuVillagersForSpiritualWanderPlace()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.World.ResetWorldFunctionsStatus(mainThreadDataContext, 4);
		DomainManager.World.ResetWorldFunctionsStatus(mainThreadDataContext, 3);
		DomainManager.World.ResetWorldFunctionsStatus(mainThreadDataContext, 10);
		DomainManager.World.ResetWorldFunctionsStatus(mainThreadDataContext, 7);
		DomainManager.World.ResetWorldFunctionsStatus(mainThreadDataContext, 24);
		DomainManager.World.ResetWorldFunctionsStatus(mainThreadDataContext, 25);
		DomainManager.Adventure.ClearAllAdventureSites(mainThreadDataContext);
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		byte areaSize = DomainManager.Map.GetAreaSize(taiwuVillageLocation.AreaId);
		ByteCoordinate byteCoordinate = ByteCoordinate.IndexToCoordinate(taiwuVillageLocation.BlockId, areaSize);
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		List<MapBlockData> list2 = ObjectPool<List<MapBlockData>>.Instance.Get();
		List<int> list3 = ObjectPool<List<int>>.Instance.Get();
		list.Clear();
		(int, int)[] taiwuEnsuredSurroundingBlockOffsets = GameData.Domains.Map.SharedConstValue.TaiwuEnsuredSurroundingBlockOffsets;
		for (int i = 0; i < taiwuEnsuredSurroundingBlockOffsets.Length; i++)
		{
			(int, int) tuple = taiwuEnsuredSurroundingBlockOffsets[i];
			int item = tuple.Item1;
			int item2 = tuple.Item2;
			ByteCoordinate byteCoordinate2 = new ByteCoordinate((byte)(byteCoordinate.X + item), (byte)(byteCoordinate.Y + item2));
			short item3 = ByteCoordinate.CoordinateToIndex(byteCoordinate2, areaSize);
			list.Add(item3);
		}
		CollectionUtils.Shuffle(mainThreadDataContext.Random, list);
		CharacterMatcherItem prepareCharacterForSpiritualWanderPlace = CharacterMatcher.DefValue.PrepareCharacterForSpiritualWanderPlace;
		foreach (OrganizationItem item4 in (IEnumerable<OrganizationItem>)Config.Organization.Instance)
		{
			if (!item4.IsSect)
			{
				continue;
			}
			Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(item4.TemplateId);
			GameData.Domains.Character.Character character = settlementByOrgTemplateId.GetLeader();
			if (character == null)
			{
				OrganizationMemberItem orgMemberConfig = OrganizationDomain.GetOrgMemberConfig(item4.TemplateId, 8);
				sbyte gender = ((orgMemberConfig.Gender >= 0) ? orgMemberConfig.Gender : Gender.GetRandom(mainThreadDataContext.Random));
				character = CreateIntelligentCharacter(location, gender, -1, -1, settlementByOrgTemplateId.GetId(), 8);
			}
			else
			{
				MoveIntelligentCharacter(character, location);
			}
			character.SpecifyBaseNeiliAllocation(mainThreadDataContext, default(NeiliAllocation));
			int num = character.GetMaxNeili() * 30 / 100;
			if (character.GetCurrNeili() > num)
			{
				character.SpecifyCurrNeili(mainThreadDataContext, num);
			}
			mainThreadDataContext.Equipping.SelectEquipments(mainThreadDataContext, character, isOutOfTaiwuGroup: true);
			OrgMemberCollection members = settlementByOrgTemplateId.GetMembers();
			list3.Clear();
			list3.AddRange(members.GetMembers(6));
			list3.AddRange(members.GetMembers(7));
			list3.AddRange(members.GetMembers(8));
			list3.Remove(character.GetId());
			short blockId = list[list.Count - 1];
			list.RemoveAt(list.Count - 1);
			DomainManager.Map.GetRealNeighborBlocks(taiwuVillageLocation.AreaId, blockId, list2, 1, includeCenter: true);
			foreach (int item5 in list3)
			{
				GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(item5);
				if (prepareCharacterForSpiritualWanderPlace.Match(element_Objects) && element_Objects.GetLeaderId() != character.GetId())
				{
					if (element_Objects.GetLeaderId() >= 0)
					{
						DomainManager.Character.LeaveGroup(mainThreadDataContext, element_Objects);
					}
					short blockId2 = list2.GetRandom(mainThreadDataContext.Random).BlockId;
					Location targetLocation = new Location(taiwuVillageLocation.AreaId, blockId2);
					MoveIntelligentCharacter(element_Objects, targetLocation);
				}
			}
		}
		short blockId3 = list[0];
		list.Clear();
		DomainManager.Map.GetRealNeighborBlocks(taiwuVillageLocation.AreaId, blockId3, list2, 1, includeCenter: true);
		short taiwuVillageSettlementId = DomainManager.Taiwu.GetTaiwuVillageSettlementId();
		Settlement settlement = DomainManager.Organization.GetSettlement(taiwuVillageSettlementId);
		settlement.GetMembers().GetAllMembers(list3);
		foreach (int item6 in list3)
		{
			GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(item6);
			if (prepareCharacterForSpiritualWanderPlace.Match(element_Objects2))
			{
				DomainManager.Taiwu.RemoveVillagerWork(mainThreadDataContext, item6);
				DomainManager.Character.LeaveGroup(mainThreadDataContext, element_Objects2);
				short blockId4 = list2.GetRandom(mainThreadDataContext.Random).BlockId;
				Location targetLocation2 = new Location(taiwuVillageLocation.AreaId, blockId4);
				MoveIntelligentCharacter(element_Objects2, targetLocation2);
			}
		}
		Domain.SaveArgToGlobalArgBox("MainStoryLine_SpiritualWanderPlace_TaiwuVillagersCenter", new Location(taiwuVillageLocation.AreaId, blockId3));
	}

	public static void EnsureTaiwuVillagerLocationForSpiritualWanderPlace()
	{
		DataContext mainThreadDataContext = DomainManager.TaiwuEvent.MainThreadDataContext;
		EventArgBox globalEventArgumentBox = DomainManager.TaiwuEvent.GetGlobalEventArgumentBox();
		if (!globalEventArgumentBox.Get<Location>("MainStoryLine_SpiritualWanderPlace_TaiwuVillagersCenter", out Location arg))
		{
			throw new Exception("MainStoryLine_SpiritualWanderPlace_TaiwuVillagersCenter is not saved.");
		}
		byte areaSize = DomainManager.Map.GetAreaSize(arg.AreaId);
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		List<int> list2 = ObjectPool<List<int>>.Instance.Get();
		DomainManager.Map.GetRealNeighborBlocks(arg.AreaId, arg.BlockId, list, 1, includeCenter: true);
		short taiwuVillageSettlementId = DomainManager.Taiwu.GetTaiwuVillageSettlementId();
		Settlement settlement = DomainManager.Organization.GetSettlement(taiwuVillageSettlementId);
		settlement.GetMembers().GetAllMembers(list2);
		foreach (int item in list2)
		{
			if (!DomainManager.Taiwu.IsInGroup(item))
			{
				GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(item);
				if (element_Objects.GetKidnapperId() < 0 && ByteCoordinate.IndexToCoordinate(element_Objects.GetLocation().BlockId, areaSize).GetManhattanDistance(ByteCoordinate.IndexToCoordinate(arg.BlockId, areaSize)) > 1)
				{
					short blockId = list.GetRandom(mainThreadDataContext.Random).BlockId;
					Location targetLocation = new Location(arg.AreaId, blockId);
					MoveIntelligentCharacter(element_Objects, targetLocation);
				}
			}
		}
	}

	public static void GenerateXiangshuMinions(List<MapBlockData> validBlocks)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		int hereticsAmountFactor = DomainManager.World.GetHereticsAmountFactor();
		for (int i = 0; i < 3; i++)
		{
			short enemyTemplateId = (short)(298 + i + 6 - 1);
			int enemyAmount = GlobalConfig.Instance.BrokenAreaEnemyCountLevelDist[i] * hereticsAmountFactor / 100;
			DomainManager.Adventure.CreateRandomEnemiesOnValidBlocks(mainThreadDataContext, Location.Invalid, enemyTemplateId, enemyAmount, validBlocks);
		}
	}

	public static void AddTravelCommand(string actionName)
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.AreaTravelCommand, actionName);
	}

	public static void RemoveRemainsOfImmortalXuFromInventory()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Inventory inventory = taiwu.GetInventory();
		foreach (KeyValuePair<ItemKey, int> item in inventory.Items)
		{
			if (item.Key.ItemType == 12 && item.Key.TemplateId == 228)
			{
				RemoveInventoryItem(taiwu, item.Key);
				break;
			}
		}
	}

	public static void ClearJuniorXiangshuFromWorld()
	{
		for (int i = 0; i < 9; i++)
		{
			short templateId = XiangshuAvatarIds.JuniorXiangshuTemplateIds[i];
			if (DomainManager.Character.TryGetFixedCharacterByTemplateId(templateId, out var character))
			{
				MoveFixedCharacter(character, Location.Invalid);
			}
		}
		DomainManager.Adventure.RemoveAllJuniorXiangshuAdventures(Domain.MainThreadDataContext);
	}

	public static void AddVillageChangeSaveInfectedVillagerCount()
	{
		if (!GlobalArgBoxContainsKey<int>("ConchShip_PresetKey_VillageChange_SaveInfectedVillagerCount"))
		{
			SaveGlobalArg("ConchShip_PresetKey_VillageChange_SaveInfectedVillagerCount", 1);
			return;
		}
		int intFromGlobalArgBox = GetIntFromGlobalArgBox("ConchShip_PresetKey_VillageChange_SaveInfectedVillagerCount");
		SaveGlobalArg("ConchShip_PresetKey_VillageChange_SaveInfectedVillagerCount", ++intFromGlobalArgBox);
	}

	public static bool GetExorcismEnabled()
	{
		return DomainManager.Extra.GetExorcismEnabled();
	}

	public static void SetExorcismEnabled(bool enabled)
	{
		DomainManager.Extra.SetExorcismEnabled(enabled, Domain.MainThreadDataContext);
	}

	public static bool IsExorcismNeedToBeDisabled()
	{
		return GetExorcismEnabled() && DomainManager.Taiwu.GetTaiwu().GetConsummateLevel() >= 4;
	}

	public static void RestoreAllTaiwuStatus()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Injuries injuries = taiwu.GetInjuries();
		injuries.Initialize();
		taiwu.SetInjuries(injuries, Domain.MainThreadDataContext);
		PoisonInts poisoned = taiwu.GetPoisoned();
		poisoned.Initialize();
		taiwu.SetPoisoned(ref poisoned, Domain.MainThreadDataContext);
		short leftMaxHealth = taiwu.GetLeftMaxHealth();
		taiwu.SetHealth(leftMaxHealth, Domain.MainThreadDataContext);
		taiwu.SetDisorderOfQi(DisorderLevelOfQi.MinValue, Domain.MainThreadDataContext);
	}

	public static void ExecuteTaiwuVillageStationOpenDate()
	{
		if (GlobalArgBoxContainsKey<Location>("TaiwuPostLocation"))
		{
			Location objectFromGlobalArgBox = EventHelper.GetObjectFromGlobalArgBox<Location>("TaiwuPostLocation");
			ChangeLocationBlockType(objectFromGlobalArgBox, 37);
		}
		SetWorldFunctionsStatus(3);
		SetWorldFunctionsStatus(2);
		SetWorldFunctionsStatus(4);
		SetWorldFunctionsStatus(9);
		SetWorldFunctionsStatus(11);
		SetWorldFunctionsStatus(13);
		OpenLegacyActivate();
		if (IsInMainStoryLineProgress(14))
		{
			ChangeMainStoryLineProgress(15);
		}
		if (IsInMainStoryLineProgress(15))
		{
			ChangeMainStoryLineProgress(16);
		}
		SaveGlobalArg("CS_PK_StationOpenDate", GetGameDate());
	}

	public static void SaveTaiwuVillageStateOrgToArgBox(EventArgBox argBox)
	{
		sbyte taiwuVillageStateSect = DomainManager.Taiwu.GetTaiwuVillageStateSect();
		argBox.Set("OrgTemplateId", taiwuVillageStateSect);
	}

	public static void SaveSettlementIdAndActorKey(EventArgBox argBox)
	{
		sbyte b = 1;
		short num = 0;
		if (argBox.Contains<short>("MonthlyEvent_arg1"))
		{
			num = argBox.GetShort("MonthlyEvent_arg1");
			b = DomainManager.Organization.GetSettlement(num).GetOrgTemplateId();
		}
		else
		{
			b = argBox.GetSbyte("OrgTemplateId");
			num = DomainManager.Organization.GetSettlementIdByOrgTemplateId(b);
		}
		if (1 == 0)
		{
		}
		short num2 = b switch
		{
			1 => 292, 
			2 => 293, 
			3 => 294, 
			4 => 295, 
			5 => 296, 
			6 => 297, 
			7 => 298, 
			8 => 299, 
			9 => 300, 
			10 => 301, 
			11 => 302, 
			12 => 303, 
			13 => 304, 
			14 => 305, 
			15 => 306, 
			_ => -1, 
		};
		if (1 == 0)
		{
		}
		short num3 = num2;
		if (num3 >= 0)
		{
			CreateAdventureActor(num3, "ActorKey", argBox);
			argBox.Set("SettlementId", num);
			argBox.Set("OrgTemplateId", b);
		}
	}

	public static void ApplyVowRewards(string afterEvent, EventArgBox argBox, bool selectIgnore = false)
	{
		sbyte b = 1;
		short num = 0;
		if (argBox.Contains<short>("MonthlyEvent_arg1"))
		{
			num = argBox.GetShort("MonthlyEvent_arg1");
			b = DomainManager.Organization.GetSettlement(num).GetOrgTemplateId();
		}
		else
		{
			b = argBox.GetSbyte("OrgTemplateId");
			num = DomainManager.Organization.GetSettlementIdByOrgTemplateId(b);
		}
		argBox.Set("OrgTemplateId", b);
		OrganizationItem organizationItem = Config.Organization.Instance[b];
		if (organizationItem == null)
		{
			return;
		}
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		BuildingBlockData taiwuBuildingBlockData = DomainManager.Taiwu.GetTaiwuBuildingBlockData(44);
		BuildingBlockKey blockKey = new BuildingBlockKey(taiwuVillageLocation.AreaId, taiwuVillageLocation.BlockId, taiwuBuildingBlockData.BlockIndex);
		sbyte b2 = DomainManager.Building.BuildingBlockLevel(blockKey);
		if (argBox.Contains<short>("MonthlyEvent_arg3"))
		{
			b2 = (sbyte)argBox.GetShort("MonthlyEvent_arg3");
		}
		DataContext context = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwuChar = DomainManager.Taiwu.GetTaiwu();
		List<(ItemKey, int)> showItems = new List<(ItemKey, int)>();
		(int, int) vowRewardBonuses = GetVowRewardBonuses(organizationItem.TemplateId, b2);
		List<PresetInventoryItem> vowFixedRewardItems = organizationItem.VowFixedRewardItems;
		if (vowFixedRewardItems != null && vowFixedRewardItems.Count > 0)
		{
			foreach (PresetInventoryItem vowFixedRewardItem in organizationItem.VowFixedRewardItems)
			{
				ApplyRewardsItemToTaiwu(vowFixedRewardItem, showItems, vowRewardBonuses.Item1, vowRewardBonuses.Item2);
			}
		}
		vowFixedRewardItems = organizationItem.VowRandomRewardItems;
		if (vowFixedRewardItems != null && vowFixedRewardItems.Count > 0)
		{
			foreach (PresetInventoryItem item in RandomUtils.GetRandomUnrepeated(context.Random, organizationItem.VowRandomRewardItemsCount + vowRewardBonuses.Item2, organizationItem.VowRandomRewardItems))
			{
				ApplyRewardsItemToTaiwu(item, showItems, vowRewardBonuses.Item1, 0);
			}
		}
		List<(ItemKey, int)> list = new List<(ItemKey, int)>();
		for (sbyte b3 = 0; b3 < 7; b3++)
		{
			int price = 5000 * (b2 + 1);
			int num2 = CricketSpecialConstants.PriceToResource(b3, price);
			taiwuChar.ChangeResource(context, b3, num2);
			int num3 = 321 + b3;
			list.Add((new ItemKey(12, 0, (short)num3, -1), num2));
		}
		Location location = taiwuChar.GetLocation();
		if (!location.IsValid())
		{
			location = taiwuChar.GetValidLocation();
		}
		short vowCharacterTemplateId = GetVowCharacterTemplateId(argBox);
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(vowCharacterTemplateId);
		MoveFixedCharacter(orCreateFixedCharacterByTemplateId, location);
		ConvertFixedCharacter(orCreateFixedCharacterByTemplateId, location, recreateAttributesAndQualifications: true);
		argBox.Set("CharacterId", orCreateFixedCharacterByTemplateId.GetId());
		if (!selectIgnore)
		{
			ProcessAndRemoveBooks("VowCombatSkillBookKeyList", "SelectedCombatSkillBookKey");
			ProcessAndRemoveBooks("VowLifeSkillBookKeyList", "SelectedLifeSkillBookKey");
		}
		if (!selectIgnore)
		{
			ShowGetItemPageForItems(showItems, list, afterEvent, argBox);
		}
		else
		{
			JoinOrganization(orCreateFixedCharacterByTemplateId, taiwuChar.GetOrganizationInfo().SettlementId, 0);
		}
		void ProcessAndRemoveBooks(string itemListDataKey, string selectedItemKey)
		{
			EventSelectItemData eventSelectItemData = argBox.Get<EventSelectItemData>(itemListDataKey);
			ItemKey selectedKey = argBox.Get<ItemKey>(selectedItemKey);
			ItemDisplayData itemDisplayData = eventSelectItemData?.CanSelectItemList.FirstOrDefault((ItemDisplayData c) => c.Key.Equals(selectedKey));
			if (itemDisplayData != null)
			{
				taiwuChar.AddInventoryItem(context, itemDisplayData.Key, itemDisplayData.Amount);
				showItems.Add((itemDisplayData.Key, itemDisplayData.Amount));
			}
			if (eventSelectItemData == null)
			{
				return;
			}
			foreach (ItemDisplayData canSelectItem in eventSelectItemData.CanSelectItemList)
			{
				if (!canSelectItem.Key.Equals(selectedKey))
				{
					DomainManager.Item.RemoveItem(context, canSelectItem.Key);
				}
			}
		}
	}

	public static void GenerateSkillBooksForVow(EventArgBox argBox)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte orgId = argBox.GetSbyte("OrgTemplateId");
		GenerateCombatSkillBooksForVow(mainThreadDataContext, argBox, orgId);
		GenerateLifeSkillBooksForVow(mainThreadDataContext, argBox, orgId);
	}

	private static void GenerateCombatSkillBooksForVow(DataContext context, EventArgBox argBox, sbyte orgId)
	{
		if (argBox.Contains<EventSelectItemData>("VowCombatSkillBookKeyList"))
		{
			AdaptableLog.Info("skip GenerateCombatSkillBooksForVow");
			return;
		}
		IRandomSource random = context.Random;
		EventSelectItemData eventSelectItemData = new EventSelectItemData();
		EventSelectItemData eventSelectItemData2 = eventSelectItemData;
		if (eventSelectItemData2.CanSelectItemList == null)
		{
			eventSelectItemData2.CanSelectItemList = new List<ItemDisplayData>();
		}
		SelectItemFilter item = new SelectItemFilter
		{
			Key = "SelectedCombatSkillBookKey",
			DisplayDataFilterId = 0,
			FilterTemplateId = -1
		};
		eventSelectItemData.FilterList.Add(item);
		sbyte[] vowCombatSkillBookTypes = GetVowCombatSkillBookTypes(orgId);
		sbyte[] array = vowCombatSkillBookTypes;
		foreach (sbyte skillType in array)
		{
			List<short> list = (from c in Config.CombatSkill.Instance
				where c.SectId == orgId && c.Grade == 3 && c.Type == skillType
				select c.TemplateId).ToList();
			if (list.Count > 0)
			{
				short index = list[random.Next(0, list.Count)];
				short bookId = Config.CombatSkill.Instance[index].BookId;
				if (bookId > 0)
				{
					ItemKey itemKey = DomainManager.Item.CreateSkillBook(context, bookId, 5, 0, -1, 100);
					ItemDisplayData itemDisplayData = DomainManager.Item.GetItemDisplayData(itemKey);
					itemDisplayData.Amount = 1;
					eventSelectItemData.CanSelectItemList.Add(itemDisplayData);
					ItemKey itemKey2 = DomainManager.Item.CreateSkillBook(context, bookId, 5, 0, -1, 0);
					ItemDisplayData itemDisplayData2 = DomainManager.Item.GetItemDisplayData(itemKey2);
					itemDisplayData2.Amount = 1;
					eventSelectItemData.CanSelectItemList.Add(itemDisplayData2);
				}
			}
		}
		argBox.Set("VowCombatSkillBookKeyList", (ISerializableGameData)(object)eventSelectItemData);
	}

	private static void GenerateLifeSkillBooksForVow(DataContext context, EventArgBox argBox, sbyte orgId)
	{
		if (argBox.Contains<EventSelectItemData>("VowLifeSkillBookKeyList"))
		{
			AdaptableLog.Info("skip GenerateLifeSkillBooksForVow");
			return;
		}
		IRandomSource random = context.Random;
		EventSelectItemData eventSelectItemData = new EventSelectItemData();
		EventSelectItemData eventSelectItemData2 = eventSelectItemData;
		if (eventSelectItemData2.CanSelectItemList == null)
		{
			eventSelectItemData2.CanSelectItemList = new List<ItemDisplayData>();
		}
		SelectItemFilter item = new SelectItemFilter
		{
			Key = "SelectedLifeSkillBookKey",
			DisplayDataFilterId = 0,
			FilterTemplateId = -1
		};
		eventSelectItemData.FilterList.Add(item);
		sbyte[] vowLifeSkillBookTypes = GetVowLifeSkillBookTypes(orgId);
		sbyte[] array = vowLifeSkillBookTypes;
		foreach (sbyte skillType in array)
		{
			List<short> list = (from c in LifeSkill.Instance
				where c.Grade == 3 && c.Type == skillType
				select c.TemplateId).ToList();
			if (list.Count > 0)
			{
				short index = list[random.Next(0, list.Count)];
				short skillBookId = LifeSkill.Instance[index].SkillBookId;
				if (skillBookId > 0)
				{
					ItemKey itemKey = DomainManager.Item.CreateSkillBook(context, skillBookId, 5, 0, -1, 50);
					ItemDisplayData itemDisplayData = DomainManager.Item.GetItemDisplayData(itemKey);
					itemDisplayData.Amount = 1;
					eventSelectItemData.CanSelectItemList.Add(itemDisplayData);
				}
			}
		}
		argBox.Set("VowLifeSkillBookKeyList", (ISerializableGameData)(object)eventSelectItemData);
	}

	public static void ShowGeneratedCombatSkillBooksForVow(EventArgBox argBox)
	{
		if (!argBox.Get("VowCombatSkillBookKeyList", out EventSelectItemData arg))
		{
			AdaptableLog.Error("VowCombatSkillBookKeyList not found in argBox.");
		}
		else
		{
			argBox.Set("SelectItemInfo", (ISerializableGameData)(object)arg);
		}
	}

	public static void ShowGeneratedLifeSkillBooksForVow(EventArgBox argBox)
	{
		if (!argBox.Get("VowLifeSkillBookKeyList", out EventSelectItemData arg))
		{
			AdaptableLog.Error("VowLifeSkillBookKeyList not found in argBox.");
		}
		else
		{
			argBox.Set("SelectItemInfo", (ISerializableGameData)(object)arg);
		}
	}

	private static sbyte[] GetVowCombatSkillBookTypes(sbyte orgId)
	{
		if (1 == 0)
		{
		}
		sbyte[] result = orgId switch
		{
			1 => new sbyte[6] { 0, 1, 2, 3, 4, 9 }, 
			2 => new sbyte[7] { 0, 1, 2, 3, 4, 7, 10 }, 
			3 => new sbyte[6] { 0, 1, 2, 4, 12, 13 }, 
			4 => new sbyte[6] { 0, 1, 2, 3, 7, 11 }, 
			5 => new sbyte[6] { 0, 1, 2, 5, 7, 8 }, 
			6 => new sbyte[6] { 0, 1, 2, 3, 8, 9 }, 
			7 => new sbyte[6] { 0, 1, 2, 4, 7, 10 }, 
			8 => new sbyte[6] { 0, 1, 2, 3, 4, 13 }, 
			9 => new sbyte[7] { 0, 1, 2, 7, 8, 9, 12 }, 
			10 => new sbyte[7] { 0, 1, 2, 3, 4, 5, 6 }, 
			11 => new sbyte[6] { 0, 1, 2, 3, 8, 10 }, 
			12 => new sbyte[7] { 0, 1, 2, 3, 4, 7, 11 }, 
			13 => new sbyte[6] { 0, 1, 2, 7, 4, 6 }, 
			14 => new sbyte[6] { 0, 1, 2, 3, 6, 8 }, 
			15 => new sbyte[7] { 0, 1, 2, 3, 4, 6, 5 }, 
			_ => Array.Empty<sbyte>(), 
		};
		if (1 == 0)
		{
		}
		return result;
	}

	private static sbyte[] GetVowLifeSkillBookTypes(sbyte orgId)
	{
		if (1 == 0)
		{
		}
		sbyte[] result = orgId switch
		{
			1 => new sbyte[3] { 8, 13, 1 }, 
			2 => new sbyte[3] { 14, 12, 13 }, 
			3 => new sbyte[5] { 8, 9, 10, 0, 3 }, 
			4 => new sbyte[3] { 12, 4, 2 }, 
			5 => new sbyte[5] { 8, 9, 14, 12, 13 }, 
			6 => new sbyte[4] { 6, 7, 14, 15 }, 
			7 => new sbyte[5] { 11, 12, 15, 4, 2 }, 
			8 => new sbyte[4] { 12, 5, 0, 3 }, 
			9 => new sbyte[4] { 6, 7, 10, 11 }, 
			10 => new sbyte[4] { 8, 9, 10, 11 }, 
			11 => new sbyte[3] { 13, 15, 5 }, 
			12 => new sbyte[3] { 8, 9, 7 }, 
			13 => new sbyte[3] { 9, 4, 1 }, 
			14 => new sbyte[3] { 6, 14, 5 }, 
			15 => new sbyte[5] { 8, 9, 12, 15, 5 }, 
			_ => Array.Empty<sbyte>(), 
		};
		if (1 == 0)
		{
		}
		return result;
	}

	private static short GetVowCharacterTemplateId(EventArgBox argBox)
	{
		sbyte b = argBox.GetSbyte("OrgTemplateId");
		if (1 == 0)
		{
		}
		short result = b switch
		{
			1 => 883, 
			2 => 884, 
			3 => 885, 
			4 => 886, 
			5 => 887, 
			6 => 888, 
			7 => 889, 
			8 => 890, 
			9 => 891, 
			10 => 892, 
			11 => 893, 
			12 => 894, 
			13 => 895, 
			14 => 896, 
			15 => 897, 
			_ => 883, 
		};
		if (1 == 0)
		{
		}
		return result;
	}

	public static sbyte ApplyVowJump(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		return character.GetOrganizationInfo().OrgTemplateId;
	}

	public static void FinishVowJumpAsJoinGroup(string afterEvent, EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		if (character != null)
		{
			int id = character.GetId();
			if (TryTriggerAddSeniorityPoint(65, id))
			{
				ProfessionFormulaItem formulaCfg = ProfessionFormula.Instance[65];
				ChangeProfessionSeniority(10, formulaCfg.Calculate(character.GetOrganizationInfo().Grade));
			}
			RequestRoleJoinGroup(id);
			ShowGetItemPageForCharacters(new List<int> { id }, isVillager: false, afterEvent, argBox);
		}
	}

	public static void FinishVowJumpAsJoinOrganization(string afterEvent, EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		if (character != null)
		{
			int id = character.GetId();
			if (TryTriggerAddSeniorityPoint(65, id))
			{
				ProfessionFormulaItem formulaCfg = ProfessionFormula.Instance[65];
				ChangeProfessionSeniority(10, formulaCfg.Calculate(character.GetOrganizationInfo().Grade));
			}
			GameData.Domains.Character.Character character2 = argBox.GetCharacter("RoleTaiwu");
			JoinOrganization(character, character2.GetOrganizationInfo().SettlementId, 0);
			ShowGetItemPageForCharacters(new List<int> { character.GetId() }, isVillager: true, afterEvent, argBox);
		}
	}

	public static void RejectVowCharacter(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		Settlement settlement = DomainManager.Organization.GetSettlement(character.GetOrganizationInfo().SettlementId);
		MoveIntelligentCharacter(character, settlement.GetLocation());
	}

	private static (int gradeBonus, int amountBonus) GetVowRewardBonuses(sbyte orgTemplateId, int currLevel)
	{
		int num = (currLevel + 1) / 3;
		if (1 == 0)
		{
		}
		(int, int) result = orgTemplateId switch
		{
			2 => (0, num), 
			11 => (0, num), 
			_ => (num, 0), 
		};
		if (1 == 0)
		{
		}
		return result;
	}

	public static void ApplyRewardsItemToTaiwu(PresetInventoryItem item, List<(ItemKey, int)> showItems, int gradeBonus, int amountBonus)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		short groupId = ItemTemplateHelper.GetGroupId(item.Type, item.TemplateId);
		if (groupId < 0)
		{
			ItemKey item2 = AddItemToRole(taiwu, item.Type, item.TemplateId, item.Amount + amountBonus, -1);
			showItems.Add((item2, item.Amount));
			return;
		}
		sbyte grade = ItemTemplateHelper.GetGrade(item.Type, item.TemplateId);
		sbyte expectedGrade = (sbyte)Math.Clamp(grade + gradeBonus, 0, 8);
		short templateIdInGroup = ItemTemplateHelper.GetTemplateIdInGroup(item.Type, groupId, expectedGrade);
		ItemKey item3 = AddItemToRole(taiwu, item.Type, templateIdInGroup, item.Amount + amountBonus, -1);
		showItems.Add((item3, item.Amount));
	}

	public static void ApplyHelpSect(EventArgBox argBox, string helpCharacterKey, string notHelpCharacterKey)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character character = argBox.GetCharacter(helpCharacterKey);
		sbyte orgTemplateId = character.GetOrganizationInfo().OrgTemplateId;
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId);
		OrgMemberCollection members = settlementByOrgTemplateId.GetMembers();
		sbyte[] mainStoryHelpSectApprovedGrades = GlobalConfig.Instance.MainStoryHelpSectApprovedGrades;
		int[] mainStoryHelpSectApprovedCounts = GlobalConfig.Instance.MainStoryHelpSectApprovedCounts;
		int num = Math.Min(mainStoryHelpSectApprovedGrades.Length, mainStoryHelpSectApprovedCounts.Length);
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		for (int i = 0; i < num; i++)
		{
			list.Clear();
			foreach (int member in members.GetMembers(mainStoryHelpSectApprovedGrades[i]))
			{
				if (DomainManager.Organization.TryGetSettlementCharacter(member, out var settlementChar) && !settlementChar.GetApprovedTaiwu())
				{
					list.Add(settlementChar.GetId());
				}
			}
			foreach (int item in RandomUtils.GetRandomUnrepeated(mainThreadDataContext.Random, mainStoryHelpSectApprovedCounts[i], list))
			{
				SetSectCharApprovedTaiwu(item);
			}
		}
		short areaId = settlementByOrgTemplateId.GetLocation().AreaId;
		ChangeSpiritualDebtByAreaId(areaId, GlobalConfig.Instance.MainStoryHelpSectAddSpiritualDebt);
		ObjectPool<List<int>>.Instance.Return(list);
		GameData.Domains.Character.Character character2 = argBox.GetCharacter(notHelpCharacterKey);
		sbyte orgTemplateId2 = character2.GetOrganizationInfo().OrgTemplateId;
		Settlement settlementByOrgTemplateId2 = DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId2);
		short areaId2 = settlementByOrgTemplateId2.GetLocation().AreaId;
		ChangeSpiritualDebtByAreaId(areaId2, GlobalConfig.Instance.MainStoryNotHelpSectAddSpiritualDebt);
	}

	public static void FindCharacters(short[] characterFilterRuleIds, int estimateCount, List<GameData.Domains.Character.Character> results, short areaIdBegin, short areaIdEnd, sbyte curStateTemplateId = -1)
	{
		results.Clear();
		List<Predicate<GameData.Domains.Character.Character>> list = new List<Predicate<GameData.Domains.Character.Character>>();
		foreach (short num in characterFilterRuleIds)
		{
			CharacterFilterRulesItem characterFilterRulesItem = Config.CharacterFilterRules.Instance[num];
			bool includeInfected = characterFilterRulesItem.RulesList.Any((CharacterFilterElement rule) => rule.PropertyType == 8 && rule.ValueMin == 1);
			list.Clear();
			GameData.Domains.Character.Filters.CharacterFilterRules.ToPredicates(num, list, curStateTemplateId);
			if (areaIdBegin == areaIdEnd)
			{
				MapCharacterFilter.Find(list, results, areaIdBegin, includeInfected);
			}
			else
			{
				MapCharacterFilter.ParallelFind(list, results, areaIdBegin, areaIdEnd, includeInfected);
			}
		}
		if (areaIdEnd - areaIdBegin == 135)
		{
			MapCharacterFilter.FindTraveling(list, results);
		}
		CollectionUtils.Shuffle(Domain.MainThreadDataContext.Random, results);
		if (results.Count > estimateCount)
		{
			results.RemoveRange(estimateCount, results.Count - estimateCount);
		}
	}

	public static void FindCharacters(List<Predicate<GameData.Domains.Character.Character>> predicates, int estimateCount, List<GameData.Domains.Character.Character> results, short areaIdBegin, short areaIdEnd, sbyte curStateTemplateId = -1)
	{
		results.Clear();
		if (areaIdBegin == areaIdEnd)
		{
			MapCharacterFilter.Find(predicates, results, areaIdBegin);
		}
		else
		{
			MapCharacterFilter.ParallelFind(predicates, results, areaIdBegin, areaIdEnd);
		}
		if (areaIdEnd - areaIdBegin == 135)
		{
			MapCharacterFilter.FindTraveling(predicates, results);
		}
		CollectionUtils.Shuffle(Domain.MainThreadDataContext.Random, results);
		if (results.Count > estimateCount)
		{
			results.RemoveRange(estimateCount, results.Count - estimateCount);
		}
	}

	public static void FindCharacters(Predicate<GameData.Domains.Character.Character> predicate, int estimateCount, List<GameData.Domains.Character.Character> results, short areaIdBegin, short areaIdEnd, sbyte curStateTemplateId = -1)
	{
		results.Clear();
		if (areaIdBegin == areaIdEnd)
		{
			MapCharacterFilter.Find(predicate, results, areaIdBegin);
		}
		else
		{
			MapCharacterFilter.ParallelFind(predicate, results, areaIdBegin, areaIdEnd);
		}
		if (areaIdEnd - areaIdBegin == 135)
		{
			MapCharacterFilter.FindTraveling(predicate, results);
		}
		CollectionUtils.Shuffle(Domain.MainThreadDataContext.Random, results);
		if (results.Count > estimateCount)
		{
			results.RemoveRange(estimateCount, results.Count - estimateCount);
		}
	}

	public static void FindCharacters(Predicate<GameData.Domains.Character.Character> predicate, List<GameData.Domains.Character.Character> results, short areaIdBegin, short areaIdEnd)
	{
		results.Clear();
		if (areaIdBegin == areaIdEnd)
		{
			MapCharacterFilter.Find(predicate, results, areaIdBegin);
		}
		else
		{
			MapCharacterFilter.ParallelFind(predicate, results, areaIdBegin, areaIdEnd);
		}
		if (areaIdEnd - areaIdBegin == 135)
		{
			MapCharacterFilter.FindTraveling(predicate, results);
		}
		CollectionUtils.Shuffle(Domain.MainThreadDataContext.Random, results);
	}

	public static void FindCharacters(short[] characterFilterRuleIds, int estimateCount, List<GameData.Domains.Character.Character> results, List<short> areaIdList, sbyte curStateTemplateId = -1)
	{
		results.Clear();
		List<Predicate<GameData.Domains.Character.Character>> list = new List<Predicate<GameData.Domains.Character.Character>>();
		foreach (short characterFilterRulesId in characterFilterRuleIds)
		{
			list.Clear();
			GameData.Domains.Character.Filters.CharacterFilterRules.ToPredicates(characterFilterRulesId, list, curStateTemplateId);
			MapCharacterFilter.ParallelFind(list, results, areaIdList);
		}
		CollectionUtils.Shuffle(Domain.MainThreadDataContext.Random, results);
		if (results.Count > estimateCount)
		{
			results.RemoveRange(estimateCount, results.Count - estimateCount);
		}
	}

	public static void FindCharacters(Predicate<GameData.Domains.Character.Character> predicate, int estimateCount, List<GameData.Domains.Character.Character> results, List<short> areaIdList, sbyte curStateTemplateId = -1)
	{
		results.Clear();
		MapCharacterFilter.ParallelFind(predicate, results, areaIdList);
		CollectionUtils.Shuffle(Domain.MainThreadDataContext.Random, results);
		if (results.Count > estimateCount)
		{
			results.RemoveRange(estimateCount, results.Count - estimateCount);
		}
	}

	public static void StopTravel()
	{
		DomainManager.Map.StopTravel(Domain.MainThreadDataContext);
	}

	public static void SetBlockData(Location location)
	{
		if (location.IsValid())
		{
			MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
			DomainManager.Map.SetBlockData(Domain.MainThreadDataContext, blockData);
		}
	}

	public static List<MapTemplateEnemyInfo> GetMapRandomEnemyGroupForChar(MapBlockData blockData, int charId, bool avoidRandomEnemy)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			throw new Exception("GetMapRandomEnemyGroupForCharacter need a alive character id!");
		}
		if (blockData.TemplateEnemyList == null || blockData.TemplateEnemyList.Count <= 0)
		{
			return null;
		}
		List<MapTemplateEnemyInfo> list = new List<MapTemplateEnemyInfo>();
		List<MapTemplateEnemyInfo> list2 = new List<MapTemplateEnemyInfo>();
		List<MapTemplateEnemyInfo> list3 = new List<MapTemplateEnemyInfo>();
		int i = 0;
		for (int count = blockData.TemplateEnemyList.Count; i < count; i++)
		{
			MapTemplateEnemyInfo item = blockData.TemplateEnemyList[i];
			if (GameData.Domains.Character.Character.IsXiangshuMinion(item.TemplateId))
			{
				list.Add(item);
			}
			else if (GameData.Domains.Character.Character.IsRighteous(item.TemplateId))
			{
				list2.Add(item);
			}
			else
			{
				list3.Add(item);
			}
		}
		if (list.Count > 0)
		{
			if (list.Count > 1)
			{
				list.Sort(MapTemplateEnemyInfoSortFunc);
			}
			if (list.Count > 4)
			{
				list.RemoveRange(4, list.Count - 4);
			}
			return list;
		}
		if (avoidRandomEnemy && DomainManager.Extra.IsProfessionalSkillUnlockedAndEquipped(28))
		{
			return null;
		}
		if (list2.Count > 0)
		{
			sbyte fameType = element.GetFameType();
			if (FameType.AttackByRighteous(fameType))
			{
				if (list2.Count > 1)
				{
					list2.Sort(MapTemplateEnemyInfoSortFunc);
				}
				if (list2.Count > 4)
				{
					list2.RemoveRange(4, list2.Count - 4);
				}
				return list2;
			}
		}
		if (list3.Count > 0)
		{
			if (list3.Count > 1)
			{
				list3.Sort(MapTemplateEnemyInfoSortFunc);
			}
			if (list3.Count > 4)
			{
				list3.RemoveRange(4, list3.Count - 4);
			}
			return list3;
		}
		return null;
		static int MapTemplateEnemyInfoSortFunc(MapTemplateEnemyInfo a, MapTemplateEnemyInfo b)
		{
			return Config.Character.Instance[b.TemplateId].OrganizationInfo.Grade.CompareTo(Config.Character.Instance[a.TemplateId].OrganizationInfo.Grade);
		}
	}

	public static (List<MapTemplateEnemyInfo> xiangshuMinionList, List<MapTemplateEnemyInfo> righteousList, List<MapTemplateEnemyInfo> randomEnemyList) GetMapRandomEnemyGroupFromBlock(MapBlockData blockData)
	{
		List<MapTemplateEnemyInfo> list = new List<MapTemplateEnemyInfo>();
		List<MapTemplateEnemyInfo> list2 = new List<MapTemplateEnemyInfo>();
		List<MapTemplateEnemyInfo> list3 = new List<MapTemplateEnemyInfo>();
		if (blockData.TemplateEnemyList != null)
		{
			int i = 0;
			for (int count = blockData.TemplateEnemyList.Count; i < count; i++)
			{
				MapTemplateEnemyInfo item = blockData.TemplateEnemyList[i];
				if (GameData.Domains.Character.Character.IsXiangshuMinion(item.TemplateId))
				{
					list.Add(item);
				}
				else if (GameData.Domains.Character.Character.IsRighteous(item.TemplateId))
				{
					list2.Add(item);
				}
				else
				{
					list3.Add(item);
				}
			}
		}
		if (list.Count > 0)
		{
			if (list.Count > 1)
			{
				list.Sort(MapTemplateEnemyInfoSortFunc);
			}
			if (list.Count > 4)
			{
				list.RemoveRange(4, list.Count - 4);
			}
		}
		if (list2.Count > 0)
		{
			if (list2.Count > 1)
			{
				list2.Sort(MapTemplateEnemyInfoSortFunc);
			}
			if (list2.Count > 4)
			{
				list2.RemoveRange(4, list2.Count - 4);
			}
		}
		if (list3.Count > 0)
		{
			if (list3.Count > 1)
			{
				list3.Sort(MapTemplateEnemyInfoSortFunc);
			}
			if (list3.Count > 4)
			{
				list3.RemoveRange(4, list3.Count - 4);
			}
		}
		return (xiangshuMinionList: list, righteousList: list2, randomEnemyList: list3);
		static int MapTemplateEnemyInfoSortFunc(MapTemplateEnemyInfo a, MapTemplateEnemyInfo b)
		{
			return Config.Character.Instance[b.TemplateId].OrganizationInfo.Grade.CompareTo(Config.Character.Instance[a.TemplateId].OrganizationInfo.Grade);
		}
	}

	public static void StartCombatWithMapRandomEnemyGroup(List<MapTemplateEnemyInfo> group, short combatConfigId, string combatCompleteEvent, EventArgBox argBox, int leaderId = -1)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		List<int> list = new List<int>();
		if (group.Count > 1)
		{
			if (leaderId != -1)
			{
				group.RemoveAt(0);
				list.Add(leaderId);
			}
			for (int i = 0; i < group.Count; i++)
			{
				int item = CreateNonIntelligentCharacter(group[i].TemplateId);
				list.Add(item);
			}
		}
		else
		{
			short templateId = group[0].TemplateId;
			if (leaderId != -1)
			{
				list.Add(leaderId);
			}
			else
			{
				int item2 = CreateNonIntelligentCharacter(templateId);
				list.Add(item2);
			}
			short minionGroupId = Config.Character.Instance[templateId].MinionGroupId;
			if (minionGroupId >= 0)
			{
				List<short> minions = MinionGroup.Instance[minionGroupId].Minions;
				for (int j = 0; j < minions.Count; j++)
				{
					int item3 = CreateNonIntelligentCharacter(minions[j]);
					list.Add(item3);
				}
			}
		}
		Domain.SetListenerWithActionName(combatCompleteEvent, argBox, "CombatOver");
		if (list == null || list.Count <= 0)
		{
			throw new Exception("no available enemyTeam passed !");
		}
		DomainManager.Combat.CombatEntry(mainThreadDataContext, list, combatConfigId);
	}

	public static void CharacterEscapeToNearbyBlock(EventArgBox argBox, GameData.Domains.Character.Character character, short steps)
	{
		CharacterEscapeToNearbyBlock(argBox, character, steps, hasNotification: false);
	}

	public static void CharacterEscapeToNearbyBlock(EventArgBox argBox, GameData.Domains.Character.Character character, short steps, bool hasNotification)
	{
		Location location = character.GetLocation();
		if (!location.IsValid())
		{
			return;
		}
		if (character.GetId() == DomainManager.Taiwu.GetTaiwuCharId())
		{
			Tester.Assert(steps == 1);
			List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
			DomainManager.Map.GetRealNeighborBlocks(location.AreaId, location.BlockId, list, steps);
			if (list.Count > 1 && argBox.Get<Location>("BlockFrom", out Location arg))
			{
				MapBlockData block = DomainManager.Map.GetBlock(arg);
				list.Remove(block);
				foreach (Location item in DomainManager.Map.TaiwuMoveRecord)
				{
					if (item.AreaId == location.AreaId)
					{
						MapBlockData block2 = DomainManager.Map.GetBlock(item);
						list.Remove(block2);
					}
				}
				if (list.Count == 0)
				{
					list.Add(block);
				}
			}
			MapBlockData random = list.GetRandom(Domain.MainThreadDataContext.Random);
			ObjectPool<List<MapBlockData>>.Instance.Return(list);
			if (DomainManager.World.GetAdvancingMonthState() == 0)
			{
				DomainManager.Map.Move(Domain.MainThreadDataContext, random.BlockId, notCostTime: true);
			}
		}
		else
		{
			DomainManager.Character.EscapeToRandomNearbyBlock(Domain.MainThreadDataContext, character, steps);
		}
		if (hasNotification)
		{
			InstantNotificationCollection instantNotificationCollection = DomainManager.World.GetInstantNotificationCollection();
			instantNotificationCollection.AddCharacterEscape(character.GetId());
		}
	}

	public static void MapRandomEnemiesEscapeToNearbyBlock(Location location)
	{
		if (!location.IsValid())
		{
			return;
		}
		MapBlockData block = DomainManager.Map.GetBlock(location);
		if (block.TemplateEnemyList != null)
		{
			List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
			DomainManager.Adventure.GetValidBlocksForRandomEnemy(location.AreaId, block.BlockId, 2, onAdventureSite: false, onSettlement: false, nearTaiwu: true, list);
			for (int num = block.TemplateEnemyList.Count - 1; num >= 0; num--)
			{
				Location destLocation = ((list.Count > 0) ? list.GetRandom(Domain.MainThreadDataContext.Random).GetLocation() : Location.Invalid);
				Events.RaiseTemplateEnemyLocationChanged(Domain.MainThreadDataContext, block.TemplateEnemyList[num], location, destLocation);
			}
			ObjectPool<List<MapBlockData>>.Instance.Return(list);
		}
	}

	public static void MapRandomEnemiesEscapeByCharacter(Location location, int charId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			throw new Exception("MapRandomEnemiesEscapeByCharacter need a alive character id!");
		}
		MapBlockData block = DomainManager.Map.GetBlock(location);
		if (block.TemplateEnemyList == null)
		{
			return;
		}
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		DomainManager.Adventure.GetValidBlocksForRandomEnemy(location.AreaId, block.BlockId, 2, onAdventureSite: false, onSettlement: false, nearTaiwu: true, list);
		if (list.Count <= 0)
		{
			return;
		}
		sbyte fameType = element.GetFameType();
		bool flag = fameType == 1 || fameType == 0;
		for (int num = block.TemplateEnemyList.Count - 1; num >= 0; num--)
		{
			if (flag || !GameData.Domains.Character.Character.IsRighteous(block.TemplateEnemyList[num].TemplateId))
			{
				MapBlockData random = list.GetRandom(Domain.MainThreadDataContext.Random);
				Events.RaiseTemplateEnemyLocationChanged(destLocation: new Location(random.AreaId, random.BlockId), context: Domain.MainThreadDataContext, templateEnemyInfo: block.TemplateEnemyList[num], srcLocation: location);
			}
		}
		ObjectPool<List<MapBlockData>>.Instance.Return(list);
	}

	public static void GenerateRandomEnemyOnBlock(Location location, short enemyCharTemplateId)
	{
		byte creatingType = Config.Character.Instance[enemyCharTemplateId].CreatingType;
		bool condition = (uint)(creatingType - 2) <= 1u;
		Tester.Assert(condition);
		MapBlockData block = DomainManager.Map.GetBlock(location);
		block.AddTemplateEnemy(new MapTemplateEnemyInfo(enemyCharTemplateId, block.BlockId, -1));
		DomainManager.Map.SetBlockData(Domain.MainThreadDataContext, block);
	}

	public static void RemoveMapRandomEnemiesOnBlock(Location location, List<MapTemplateEnemyInfo> toRemoveList)
	{
		foreach (MapTemplateEnemyInfo toRemove in toRemoveList)
		{
			Events.RaiseTemplateEnemyLocationChanged(Domain.MainThreadDataContext, toRemove, location, Location.Invalid);
		}
	}

	public static void SetMapRandomEnemyListToArgBox(EventArgBox argBox, string keyPrefix, List<MapTemplateEnemyInfo> randEnemyList)
	{
		if (randEnemyList != null)
		{
			argBox.Set(keyPrefix + "_Count", randEnemyList.Count);
			for (int i = 0; i < randEnemyList.Count; i++)
			{
				argBox.Set($"{keyPrefix}_Item_{i}", (ISerializableGameData)(object)randEnemyList[i]);
			}
		}
	}

	public static bool GetMapRandomEnemyListFromArgBox(EventArgBox argBox, string keyPrefix, out List<MapTemplateEnemyInfo> randEnemyList)
	{
		randEnemyList = new List<MapTemplateEnemyInfo>();
		int arg = 0;
		if (!argBox.Get(keyPrefix + "_Count", ref arg))
		{
			return false;
		}
		for (int i = 0; i < arg; i++)
		{
			argBox.Get<MapTemplateEnemyInfo>($"{keyPrefix}_Item_{i}", out MapTemplateEnemyInfo arg2);
			randEnemyList.Add(arg2);
		}
		return true;
	}

	public static void ChangeSafetyForSettlementsInArea(short areaId, int delta)
	{
		DomainManager.Map.ChangeSettlementSafetyInArea(Domain.MainThreadDataContext, areaId, delta);
	}

	public static void ChangeSafetyForSettlement(Location location, int delta)
	{
		Location location2 = DomainManager.Map.GetBlock(location).GetRootBlock().GetLocation();
		Settlement settlementByLocation = DomainManager.Organization.GetSettlementByLocation(location2);
		settlementByLocation.ChangeSafety(Domain.MainThreadDataContext, delta);
	}

	public static void ChangeCultureForSettlementsInArea(short areaId, int delta)
	{
		DomainManager.Map.ChangeSettlementCultureInArea(Domain.MainThreadDataContext, areaId, delta);
	}

	public static void ChangeCultureForSettlement(Location location, int delta)
	{
		Location location2 = DomainManager.Map.GetBlock(location).GetRootBlock().GetLocation();
		Settlement settlementByLocation = DomainManager.Organization.GetSettlementByLocation(location2);
		settlementByLocation.ChangeCulture(Domain.MainThreadDataContext, delta);
	}

	public static int GetSettlementCharacterCountWithoutBaby(Location location)
	{
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		HashSet<int> hashSet = ObjectPool<HashSet<int>>.Instance.Get();
		list.Clear();
		hashSet.Clear();
		MapBlockData mapBlockData = GetMapBlockData(location.AreaId, location.BlockId);
		Location location2 = mapBlockData.GetRootBlock().GetLocation();
		DomainManager.Map.GetSettlementBlocksAndAffiliatedBlocks(location2.AreaId, location2.BlockId, list);
		for (int i = 0; i < list.Count; i++)
		{
			MapBlockData mapBlockData2 = GetMapBlockData(location.AreaId, list[i]);
			if (mapBlockData2 != null && mapBlockData2.CharacterSet != null)
			{
				hashSet.UnionWith(mapBlockData2.CharacterSet);
			}
		}
		int num = 0;
		foreach (int item in hashSet)
		{
			if (DomainManager.Character.TryGetElement_Objects(item, out var element) && element.GetAgeGroup() > 0)
			{
				num++;
			}
		}
		ObjectPool<List<short>>.Instance.Return(list);
		ObjectPool<HashSet<int>>.Instance.Return(hashSet);
		return num;
	}

	public static bool LocationCharacterHasMoney(Location location)
	{
		MapBlockData mapBlockData = GetMapBlockData(location.AreaId, location.BlockId);
		HashSet<int> characterSet = mapBlockData.CharacterSet;
		if (characterSet == null)
		{
			return false;
		}
		foreach (int item in characterSet)
		{
			if (DomainManager.Character.TryGetElement_Objects(item, out var element) && element.GetResource(6) > 0)
			{
				return true;
			}
		}
		return false;
	}

	public static sbyte GetStateIdByAreaId(short areaId)
	{
		return DomainManager.Map.GetStateIdByAreaId(areaId);
	}

	public static sbyte GetStateIdByStateTemplateId(short stateTemplateId)
	{
		return DomainManager.Map.GetStateIdByStateTemplateId(stateTemplateId);
	}

	public static sbyte GetStateMainCityOrgTemplateId(sbyte stateId)
	{
		short index = (short)(3 * stateId);
		return DomainManager.Map.GetElement_Areas(index).SettlementInfos[0].OrgTemplateId;
	}

	public static string GetStateMainCityNameBySettlementId(short settlementId)
	{
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(settlement.GetLocation().AreaId);
		sbyte mainAreaID = MapState.Instance[stateTemplateIdByAreaId].MainAreaID;
		return MapArea.Instance[mainAreaID].Name;
	}

	public static string GetOrganizationNameByTemplateId(sbyte orgTemplateId)
	{
		OrganizationItem item = Config.Organization.Instance.GetItem(orgTemplateId);
		if (item == null)
		{
			throw new Exception($"failed to get organization config of template id {orgTemplateId}");
		}
		return item.Name;
	}

	public static sbyte GetStateSectOrgTemplateId(sbyte stateId)
	{
		sbyte index = (sbyte)(stateId + 1);
		return MapState.Instance[index].SectID;
	}

	public static MapBlockData GetMapBlockData(short areaId, short blockId)
	{
		return DomainManager.Map.GetBlockData(areaId, blockId);
	}

	public static EMapBlockType GetMapBlockType(short areaId, short blockId)
	{
		short templateId = DomainManager.Map.GetBlockData(areaId, blockId).TemplateId;
		return MapBlock.Instance[templateId].Type;
	}

	public static short GetBelongSettlementId(short areaId, short blockId)
	{
		MapBlockData blockData = DomainManager.Map.GetBlockData(areaId, blockId);
		short num = ((blockData.BelongBlockId >= 0) ? blockData.BelongBlockId : blockData.GetRootBlock().BlockId);
		if (num < 0)
		{
			return -1;
		}
		MapAreaData element_Areas = DomainManager.Map.GetElement_Areas(areaId);
		SettlementInfo[] settlementInfos = element_Areas.SettlementInfos;
		for (int i = 0; i < settlementInfos.Length; i++)
		{
			SettlementInfo settlementInfo = settlementInfos[i];
			if (settlementInfo.BlockId == num)
			{
				return settlementInfo.SettlementId;
			}
		}
		return -1;
	}

	public static short GetBlockSettlementId(short areaId, short blockId)
	{
		Location key = new Location(areaId, blockId);
		MapBlockData block = DomainManager.Map.GetBlock(key);
		if (block.RootBlockId >= 0)
		{
			block = DomainManager.Map.GetBlock(areaId, block.RootBlockId);
		}
		return DomainManager.Organization.GetSettlementByLocation(block.GetLocation())?.GetId() ?? (-1);
	}

	public static Location GetSettlementLocation(short settlementId)
	{
		return DomainManager.Organization.GetSettlement(settlementId).GetLocation();
	}

	public static Location GetBambooHouseLocation()
	{
		short areaIdByAreaTemplateId = DomainManager.Map.GetAreaIdByAreaTemplateId(0);
		MapBlockData bambooHouseBlock = null;
		IterateAreaBlocks(areaIdByAreaTemplateId, delegate(MapBlockData blockData)
		{
			if (blockData.GetConfig().SubType == EMapBlockSubType.Zhulu)
			{
				bambooHouseBlock = blockData;
			}
		});
		if (bambooHouseBlock == null)
		{
			throw new Exception("error:can not find bamboo house location!");
		}
		return new Location(bambooHouseBlock.AreaId, bambooHouseBlock.BlockId);
	}

	public static void IterateAreaBlocks(short areaId, Action<MapBlockData> action)
	{
		if (action != null)
		{
			Span<MapBlockData> areaBlocks = DomainManager.Map.GetAreaBlocks(areaId);
			Span<MapBlockData> span = areaBlocks;
			for (int i = 0; i < span.Length; i++)
			{
				MapBlockData obj = span[i];
				action(obj);
			}
		}
	}

	public static void IterateAreaAdventureBlocks(short areaId, Action<MapBlockData, AdventureSiteData> action)
	{
		AreaAdventureData adventuresInArea = DomainManager.Adventure.GetAdventuresInArea(areaId);
		foreach (KeyValuePair<short, AdventureSiteData> adventureSite in adventuresInArea.AdventureSites)
		{
			if (adventureSite.Value.SiteState == 1)
			{
				MapBlockData block = DomainManager.Map.GetBlock(areaId, adventureSite.Key);
				if (block != null)
				{
					action(block, adventureSite.Value);
				}
			}
		}
	}

	public static MapBlockData GetRandomEdgeBlock(short areaId, sbyte edgeType, bool excludeAdventureLocation = false)
	{
		if (edgeType == 4)
		{
			edgeType = (sbyte)Domain.MainThreadDataContext.Random.Next(0, 4);
		}
		short randomEdgeBlock = DomainManager.Map.GetRandomEdgeBlock(Domain.MainThreadDataContext.Random, areaId, edgeType);
		if (excludeAdventureLocation)
		{
			Location location = new Location(areaId, randomEdgeBlock);
			while (CheckBlockHasAdventure(location))
			{
				randomEdgeBlock = DomainManager.Map.GetRandomEdgeBlock(Domain.MainThreadDataContext.Random, areaId, edgeType);
				location = new Location(areaId, randomEdgeBlock);
			}
		}
		return DomainManager.Map.GetBlock(areaId, randomEdgeBlock);
	}

	public static List<MapBlockData> GetBlocksAroundLocation(Location location, int minDist)
	{
		List<MapBlockData> list = new List<MapBlockData>();
		Span<MapBlockData> areaBlocks = DomainManager.Map.GetAreaBlocks(location.AreaId);
		byte areaSize = DomainManager.Map.GetAreaSize(location.AreaId);
		ByteCoordinate byteCoordinate = ByteCoordinate.IndexToCoordinate(location.BlockId, areaSize);
		Span<MapBlockData> span = areaBlocks;
		for (int i = 0; i < span.Length; i++)
		{
			MapBlockData mapBlockData = span[i];
			if (byteCoordinate.GetManhattanDistance(ByteCoordinate.IndexToCoordinate(mapBlockData.BlockId, areaSize)) >= minDist)
			{
				list.Add(mapBlockData);
			}
		}
		return list;
	}

	public static List<MapBlockData> GetAllNotDevelopedBlocks(short areaId)
	{
		List<MapBlockData> list = new List<MapBlockData>();
		Span<MapBlockData> areaBlocks = DomainManager.Map.GetAreaBlocks(areaId);
		Span<MapBlockData> span = areaBlocks;
		for (int i = 0; i < span.Length; i++)
		{
			MapBlockData mapBlockData = span[i];
			if (mapBlockData.IsNonDeveloped())
			{
				list.Add(mapBlockData);
			}
		}
		return list;
	}

	public static bool TryCreateAdventureSite(short areaId, short blockId, short adventureTemplateId, bool setBlockVisible)
	{
		bool flag = DomainManager.Adventure.TryCreateAdventureSite(Domain.MainThreadDataContext, areaId, blockId, adventureTemplateId, MonthlyActionKey.Invalid);
		if (flag && setBlockVisible)
		{
			DomainManager.Map.GetBlock(areaId, blockId)?.SetVisible(visible: true, Domain.MainThreadDataContext);
		}
		return flag;
	}

	public static void RemoveAdventureSite(short areaId, short blockId, bool isTimeout, bool isComplete)
	{
		DomainManager.Adventure.RemoveAdventureSite(Domain.MainThreadDataContext, areaId, blockId, isTimeout, isComplete);
	}

	public static byte GetStepCountBetweenBlocksInSameArea(Location blockALocation, Location blockBLocation)
	{
		if (blockALocation.AreaId != blockBLocation.AreaId)
		{
			return byte.MaxValue;
		}
		MapBlockData block = DomainManager.Map.GetBlock(blockALocation);
		ByteCoordinate blockPos = block.GetBlockPos();
		MapBlockData block2 = DomainManager.Map.GetBlock(blockBLocation);
		ByteCoordinate blockPos2 = block2.GetBlockPos();
		return (byte)(Math.Abs(blockPos.X - blockPos2.X) + Math.Abs(blockPos.Y - blockPos2.Y));
	}

	public static void GenerateCricketPlaceNearTaiwu(int minGroupCount, int maxGroupCount, int minDistance = -1, int maxDistance = -1)
	{
		short areaId = DomainManager.Taiwu.GetTaiwu().GetLocation().AreaId;
		CricketPlaceData cricketPlaceData = new CricketPlaceData();
		cricketPlaceData.Init(areaId, Domain.MainThreadDataContext.Random, minGroupCount, maxGroupCount, minDistance, maxDistance);
		DomainManager.Map.SetCricketPlaceData(Domain.MainThreadDataContext, areaId, cricketPlaceData);
		for (int i = 0; i < cricketPlaceData.CricketBlocks.Length; i++)
		{
			DomainManager.Map.GetBlock(areaId, cricketPlaceData.CricketBlocks[i]).SetVisible(visible: true, Domain.MainThreadDataContext);
		}
	}

	public static void SetCricketAtTaiwuLocationFake()
	{
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		CricketPlaceData element_CricketPlaceData = DomainManager.Map.GetElement_CricketPlaceData(location.AreaId);
		if (element_CricketPlaceData == null)
		{
			return;
		}
		int num = element_CricketPlaceData.CricketBlocks.IndexOf(location.BlockId);
		int num2 = num / 3;
		int num3 = num % 3;
		if (num < 0 || element_CricketPlaceData.RealCircketIdx[num2] != num3)
		{
			return;
		}
		for (byte b = 0; b < 3; b++)
		{
			if (b != num3 && !element_CricketPlaceData.CricketTriggered[num2 * 3 + b])
			{
				element_CricketPlaceData.RealCircketIdx[num2] = b;
				break;
			}
		}
		DomainManager.Map.SetCricketPlaceData(Domain.MainThreadDataContext, location.AreaId, element_CricketPlaceData);
	}

	public static void ClearAreaCricket(short areaId)
	{
		DomainManager.Map.SetCricketPlaceData(Domain.MainThreadDataContext, areaId, null);
	}

	public static short GetSettlementIdByOrgTemplateId(sbyte orgTemplateId)
	{
		return DomainManager.Organization.GetSettlementIdByOrgTemplateId(orgTemplateId);
	}

	public static Settlement GetSettlementByOrgTemplateId(sbyte orgTemplateId)
	{
		return DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId);
	}

	public static List<short> GetSettlementLocationsByOrgTemplateId(sbyte orgTemplateId, bool shuffle = true)
	{
		Settlement settlementByOrgTemplateId = GetSettlementByOrgTemplateId(orgTemplateId);
		Location location = settlementByOrgTemplateId.GetLocation();
		List<short> list = new List<short>();
		DomainManager.Map.GetSettlementBlocks(location.AreaId, location.BlockId, list);
		if (shuffle)
		{
			CollectionUtils.Shuffle(Domain.MainThreadDataContext.Random, list);
		}
		return list;
	}

	public static List<Location> GetMapBlocksNearLocation(Location location, sbyte steps)
	{
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		DomainManager.Map.GetRealNeighborBlocks(location.AreaId, location.BlockId, list, steps);
		return list.ConvertAll((MapBlockData e) => new Location(e.AreaId, e.BlockId));
	}

	public unsafe static short GetLocationResourceOfType(Location location, sbyte resourceType)
	{
		MapBlockData block = DomainManager.Map.GetBlock(location);
		if (block == null)
		{
			return 0;
		}
		return block.CurrResources.Items[resourceType];
	}

	public static Location GetRandomAreaEdgeBlockForEvent(short areaId, IEnumerable<Predicate<MapBlockData>> filters)
	{
		AreaAdventureData adventuresInArea = DomainManager.Adventure.GetAdventuresInArea(areaId);
		List<short> selectableBlocks = ObjectPool<List<short>>.Instance.Get();
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		short blockId = -1;
		list.Clear();
		selectableBlocks.Clear();
		DomainManager.Map.GetEdgeBlockList(areaId, selectableBlocks);
		DomainManager.Map.GetMapBlocksInAreaByFilters(areaId, (MapBlockData blockData) => selectableBlocks.Contains(blockData.BlockId) && !adventuresInArea.AdventureSites.ContainsKey(blockData.BlockId) && filters.Aggregate(seed: true, (bool current, Predicate<MapBlockData> filter) => current && filter(blockData)), list);
		if (list.Any())
		{
			blockId = list.GetRandom(Domain.MainThreadDataContext.Random).BlockId;
		}
		ObjectPool<List<MapBlockData>>.Instance.Return(list);
		ObjectPool<List<short>>.Instance.Return(selectableBlocks);
		return new Location(areaId, blockId);
	}

	public static Location GetAreaStationLocation(short areaId)
	{
		return new Location(areaId, DomainManager.Map.GetElement_Areas(areaId).StationBlockId);
	}

	public static List<Location> GetAreaSettlementLocations(short areaId)
	{
		return DomainManager.Map.GetElement_Areas(areaId).SettlementInfos.Select((SettlementInfo settlementInfo) => new Location(areaId, settlementInfo.BlockId)).ToList();
	}

	public static bool IsLocationRangeHasBlockTemplate(Location location, int range, short blockTemplateId)
	{
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		MapBlockData block = DomainManager.Map.GetBlock(location);
		DomainManager.Map.GetNeighborBlocks(block.AreaId, block.BlockId, list, block.GetConfig().ViewRange);
		bool result = list.Any((MapBlockData blk) => blk.TemplateId == blockTemplateId);
		ObjectPool<List<MapBlockData>>.Instance.Return(list);
		return result;
	}

	public static void MakeAreaGraduallyBroken(short areaId, Location protectedLocation, int protectedRange)
	{
		MapDomain map = DomainManager.Map;
		AdventureDomain adventure = DomainManager.Adventure;
		CharacterDomain character = DomainManager.Character;
		MapAreaData element_Areas = map.GetElement_Areas(areaId);
		ByteCoordinate byteCoordinate = ByteCoordinate.IndexToCoordinate(protectedLocation.BlockId, map.GetAreaSize(protectedLocation.AreaId));
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		HashSet<short> hashSet = ObjectPool<HashSet<short>>.Instance.Get();
		List<short> list2 = ObjectPool<List<short>>.Instance.Get();
		HashSet<int> hashSet2 = ObjectPool<HashSet<int>>.Instance.Get();
		List<short> list3 = ObjectPool<List<short>>.Instance.Get();
		List<MapBlockData> list4 = ObjectPool<List<MapBlockData>>.Instance.Get();
		list2.Clear();
		list2.Add(118);
		list2.Add(119);
		list2.Add(120);
		list2.Add(121);
		list2.Add(122);
		list2.Add(123);
		hashSet.Clear();
		hashSet.Add(126);
		hashSet.UnionWith(list2);
		hashSet2.Clear();
		list3.Clear();
		list3.Add(298);
		list3.Add(299);
		list3.Add(300);
		map.GetEdgeBlockList(areaId, list, hashSet, excludeTravelBlock: false, strictSelect: false, containsBigBlock: true);
		foreach (short item in list)
		{
			if (item == element_Areas.StationBlockId)
			{
				continue;
			}
			MapBlockData block = map.GetBlock(areaId, item);
			if (!MapBlockDataMatchers.CanBeRuinedByXiangshu(block) || block.GetManhattanDistanceToPos(byteCoordinate.X, byteCoordinate.Y) <= protectedRange)
			{
				continue;
			}
			Location location = new Location(areaId, item);
			short templateId = block.TemplateId;
			if (block.RootBlockId >= 0)
			{
				location.BlockId = block.RootBlockId;
			}
			map.ChangeBlockTemplate(Domain.MainThreadDataContext, location, list2.Sample(), isTurnVisible: false);
			if (block.CharacterSet != null)
			{
				hashSet2.UnionWith(block.CharacterSet);
			}
			if (block.GroupBlockList != null)
			{
				foreach (MapBlockData groupBlock in block.GroupBlockList)
				{
					if (groupBlock.CharacterSet != null)
					{
						hashSet2.UnionWith(groupBlock.CharacterSet);
					}
				}
			}
			block.InitResources(Domain.MainThreadDataContext.Random);
			DomainManager.Map.SetBlockData(Domain.MainThreadDataContext, block);
			if (block.GroupBlockList != null)
			{
				foreach (MapBlockData groupBlock2 in block.GroupBlockList)
				{
					groupBlock2.InitResources(Domain.MainThreadDataContext.Random);
					DomainManager.Map.SetBlockData(Domain.MainThreadDataContext, groupBlock2);
				}
			}
			if (!list2.Contains(templateId) && (block.TemplateEnemyList == null || block.TemplateEnemyList.Count <= 0) && Domain.MainThreadDataContext.Random.Next(100) < 50)
			{
				list4.Clear();
				list4.Add(block);
				adventure.CreateRandomEnemiesOnValidBlocks(Domain.MainThreadDataContext, Location.Invalid, list3.Sample(), 1, list4);
			}
		}
		foreach (int item2 in hashSet2)
		{
			GameData.Domains.Character.Character element_Objects = character.GetElement_Objects(item2);
			character.MakeCharacterDead(Domain.MainThreadDataContext, element_Objects, 10);
		}
		ObjectPool<List<short>>.Instance.Return(list3);
		ObjectPool<List<MapBlockData>>.Instance.Return(list4);
		ObjectPool<HashSet<int>>.Instance.Return(hashSet2);
		ObjectPool<List<short>>.Instance.Return(list2);
		ObjectPool<HashSet<short>>.Instance.Return(hashSet);
		ObjectPool<List<short>>.Instance.Return(list);
	}

	public static void MakeAreaGraduallyBrokenInCondition(short areaId, Predicate<MapBlockData> excludeCondition, IDictionary<short, byte> protectedBlocks)
	{
		MapDomain mapDomain = DomainManager.Map;
		AdventureDomain adventure = DomainManager.Adventure;
		CharacterDomain character = DomainManager.Character;
		MapAreaData element_Areas = mapDomain.GetElement_Areas(areaId);
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		HashSet<short> hashSet = ObjectPool<HashSet<short>>.Instance.Get();
		List<short> list2 = ObjectPool<List<short>>.Instance.Get();
		HashSet<int> hashSet2 = ObjectPool<HashSet<int>>.Instance.Get();
		List<short> list3 = ObjectPool<List<short>>.Instance.Get();
		List<MapBlockData> list4 = ObjectPool<List<MapBlockData>>.Instance.Get();
		List<ItemKey> list5 = ObjectPool<List<ItemKey>>.Instance.Get();
		list2.Clear();
		list2.Add(118);
		list2.Add(119);
		list2.Add(120);
		list2.Add(121);
		list2.Add(122);
		list2.Add(123);
		hashSet.Clear();
		hashSet.Add(126);
		hashSet.UnionWith(list2);
		hashSet2.Clear();
		list3.Clear();
		list3.Add(303);
		list3.Add(304);
		list3.Add(305);
		mapDomain.GetEdgeBlockList(areaId, list, hashSet, excludeTravelBlock: false, strictSelect: false, containsBigBlock: true);
		foreach (short item in list)
		{
			if (item == element_Areas.StationBlockId)
			{
				continue;
			}
			MapBlockData block = mapDomain.GetBlock(areaId, item);
			if (block.TemplateId == 0)
			{
				DomainManager.TaiwuEvent.OnEvent_TaiwuVillageDestroyed();
				break;
			}
			if (!MapBlockDataMatchers.CanBeRuinedByXiangshu(block) || excludeCondition(block) || protectedBlocks.Any(delegate(KeyValuePair<short, byte> p)
			{
				KeyValuePair<short, byte> keyValuePair = p;
				keyValuePair.Deconstruct(out var key, out var value);
				short blockIndex = key;
				byte b = value;
				ByteCoordinate byteCoordinate = ByteCoordinate.IndexToCoordinate(blockIndex, mapDomain.GetAreaSize(areaId));
				return block.GetManhattanDistanceToPos(byteCoordinate.X, byteCoordinate.Y) <= b;
			}))
			{
				continue;
			}
			Location location = new Location(areaId, item);
			short templateId = block.TemplateId;
			if (block.RootBlockId >= 0)
			{
				location.BlockId = block.RootBlockId;
			}
			mapDomain.ChangeBlockTemplate(Domain.MainThreadDataContext, location, list2.Sample(), isTurnVisible: false);
			block.InitResources(Domain.MainThreadDataContext.Random);
			block.DestroyItemsDirect(list5);
			DomainManager.Map.SetBlockData(Domain.MainThreadDataContext, block);
			if (block.GroupBlockList != null)
			{
				foreach (MapBlockData groupBlock in block.GroupBlockList)
				{
					groupBlock.InitResources(Domain.MainThreadDataContext.Random);
					groupBlock.DestroyItemsDirect(list5);
					DomainManager.Map.SetBlockData(Domain.MainThreadDataContext, groupBlock);
				}
			}
			if (!list2.Contains(templateId) && (block.TemplateEnemyList == null || block.TemplateEnemyList.Count <= 0))
			{
				list4.Clear();
				list4.Add(block);
				int num = 0;
				for (int num2 = Domain.MainThreadDataContext.Random.Next(5, 10); num < num2; num++)
				{
					adventure.CreateRandomEnemiesOnValidBlocks(Domain.MainThreadDataContext, Location.Invalid, list3.Sample(), 1, list4);
				}
			}
		}
		DomainManager.Item.RemoveItems(Domain.MainThreadDataContext, list5);
		ObjectPool<List<ItemKey>>.Instance.Return(list5);
		ObjectPool<List<short>>.Instance.Return(list3);
		ObjectPool<List<MapBlockData>>.Instance.Return(list4);
		ObjectPool<HashSet<int>>.Instance.Return(hashSet2);
		ObjectPool<List<short>>.Instance.Return(list2);
		ObjectPool<HashSet<short>>.Instance.Return(hashSet);
		ObjectPool<List<short>>.Instance.Return(list);
	}

	public static void SetBlockAndViewRangeVisible(short areaId, short blockId)
	{
		DomainManager.Map.SetBlockAndViewRangeVisible(Domain.MainThreadDataContext, areaId, blockId);
	}

	public static void ChangeLocationBlockType(Location location, short templateId, bool safeChange = true)
	{
		DomainManager.Map.ChangeBlockTemplate(Domain.MainThreadDataContext, location, templateId, isTurnVisible: true);
	}

	public static AdventureItem GetAdventureConfigOfLocation(Location location)
	{
		AreaAdventureData adventuresInArea = DomainManager.Adventure.GetAdventuresInArea(location.AreaId);
		if (adventuresInArea.AdventureSites.TryGetValue(location.BlockId, out var value))
		{
			return Config.Adventure.Instance.GetItem(value.TemplateId);
		}
		return null;
	}

	public static List<Location> GetBlockLocationGroup(Location location, bool includeSelf = true)
	{
		return DomainManager.Map.GetBlockLocationGroup(location, includeSelf);
	}

	public static Location GetAdventureGenerateRandomLocation(Location center, sbyte rangeMin, sbyte rangeMax, params short[] exceptBlockTemplateIds)
	{
		List<Location> mapBlocksNearLocation = GetMapBlocksNearLocation(center, rangeMax);
		List<Location> rangeListMin = GetMapBlocksNearLocation(center, rangeMin);
		mapBlocksNearLocation.RemoveAll(delegate(Location e)
		{
			if (rangeListMin.Contains(e))
			{
				return true;
			}
			if (CheckBlockHasAdventure(e))
			{
				return true;
			}
			MapBlockData block = DomainManager.Map.GetBlock(e);
			MapBlockItem config = block.GetConfig();
			if (config.SubType == EMapBlockSubType.DarkPool)
			{
				return true;
			}
			if (exceptBlockTemplateIds != null)
			{
				for (int i = 0; i < exceptBlockTemplateIds.Length; i++)
				{
					if (exceptBlockTemplateIds[i] == config.TemplateId)
					{
						return true;
					}
				}
			}
			return false;
		});
		if (mapBlocksNearLocation.Count > 0)
		{
			return mapBlocksNearLocation.Sample();
		}
		return center;
	}

	public static Location GetAdventureGenerateRandomLocationOfEdge(short areaId, Location currentLocation, sbyte rangeMin, params short[] exceptBlockTemplateIds)
	{
		List<short> list = new List<short>();
		DomainManager.Map.GetEdgeBlockList(areaId, list);
		list.RemoveAll(delegate(short e)
		{
			Location location = new Location(areaId, e);
			if (areaId == currentLocation.AreaId && GetStepCountBetweenBlocksInSameArea(currentLocation, location) <= rangeMin)
			{
				return true;
			}
			if (CheckBlockHasAdventure(location))
			{
				return true;
			}
			MapBlockData block = DomainManager.Map.GetBlock(location);
			MapBlockItem config = block.GetConfig();
			if (config.SubType == EMapBlockSubType.DarkPool)
			{
				return true;
			}
			if (exceptBlockTemplateIds != null)
			{
				for (int i = 0; i < exceptBlockTemplateIds.Length; i++)
				{
					if (exceptBlockTemplateIds[i] == config.TemplateId)
					{
						return true;
					}
				}
			}
			return false;
		});
		return new Location(areaId, list.Sample());
	}

	public static void GetLocationByDistance(Location centerLocation, int minStep, int maxStep, ref List<MapBlockData> mapBlockList)
	{
		DomainManager.Map.GetLocationByDistance(centerLocation, minStep, maxStep, ref mapBlockList);
	}

	public static MapBlockData GetLocationByDistanceRandom(Location centerLocation, int minStep, int maxStep, ref List<MapBlockData> mapBlockList)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Map.GetLocationByDistance(centerLocation, minStep, maxStep, ref mapBlockList);
		return mapBlockList.GetRandom(mainThreadDataContext.Random);
	}

	public static Location GetRandomGraveBlock(Location location)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		return DomainManager.Map.GetRandomGraveBlock(mainThreadDataContext.Random, location);
	}

	public static Location GetLocationExpectedCurrentState(Location currentLocation)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte stateIdByAreaId = DomainManager.Map.GetStateIdByAreaId(currentLocation.AreaId);
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		for (short num = 0; num < 45; num++)
		{
			sbyte stateIdByAreaId2 = DomainManager.Map.GetStateIdByAreaId(num);
			if (stateIdByAreaId != stateIdByAreaId2)
			{
				list.Add(num);
			}
		}
		short random = list.GetRandom(mainThreadDataContext.Random);
		list.Clear();
		Span<MapBlockData> areaBlocks = DomainManager.Map.GetAreaBlocks(random);
		Span<MapBlockData> span = areaBlocks;
		for (int i = 0; i < span.Length; i++)
		{
			MapBlockData mapBlockData = span[i];
			list.Add(mapBlockData.BlockId);
		}
		short random2 = list.GetRandom(mainThreadDataContext.Random);
		ObjectPool<List<short>>.Instance.Return(list);
		return new Location(random, random2);
	}

	public static Location GetSecretVillageRandomLocation(DataContext context)
	{
		short blockId = DomainManager.Map.GetAreaBlocks(137).ToArray().GetRandom(context.Random)
			.BlockId;
		return new Location(137, blockId);
	}

	public static short GetAreaIdByAreaTemplateId(short areaTemplateId)
	{
		return DomainManager.Map.GetAreaIdByAreaTemplateId(areaTemplateId);
	}

	public static void WorldMapDoShake(string afterEvent, EventArgBox argBox)
	{
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "WorldMapShaken");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.WorldMapDoShakeByEvent);
	}

	public static void WorldMapDoFocus(Location location, float duration, string afterEvent, EventArgBox argBox)
	{
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "WorldMapFocused");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.WorldMapDoFocusByEvent, location, duration);
	}

	public static List<short> GetNormalAreaIdsByStateId(short stateId)
	{
		List<short> list = new List<short>();
		int num = 3;
		for (int i = 0; i < num; i++)
		{
			list.Add((short)(stateId * num + i));
		}
		return list;
	}

	public static Location GetRandomLocationOfSettlement(sbyte orgTemplateId, bool show = false)
	{
		Settlement settlementByOrgTemplateId = GetSettlementByOrgTemplateId(orgTemplateId);
		if (settlementByOrgTemplateId == null)
		{
			throw new Exception("Settlement can not null");
		}
		Location settlementLocation = GetSettlementLocation(settlementByOrgTemplateId.GetId());
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		list.Clear();
		DomainManager.Map.GetSettlementBlocksAndAffiliatedBlocks(settlementLocation.AreaId, settlementLocation.BlockId, list);
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		short blockId = list[mainThreadDataContext.Random.Next(0, list.Count - 1)];
		ObjectPool<List<short>>.Instance.Return(list);
		Location result = new Location(settlementLocation.AreaId, blockId);
		if (show)
		{
			MapBlockData blockData = DomainManager.Map.GetBlockData(result.AreaId, result.BlockId);
			if (!blockData.Visible)
			{
				blockData.SetVisible(visible: true, mainThreadDataContext);
			}
		}
		return result;
	}

	public static Settlement GetSettlementByLocation(Location location)
	{
		Location location2 = DomainManager.Map.GetBlock(location).GetRootBlock().GetLocation();
		return DomainManager.Organization.GetSettlementByLocation(location2);
	}

	public static void ChangeBlockTemplateUnsafe(Location location, short blockTemplateId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		MapBlockData block = DomainManager.Map.GetBlock(location);
		if (block.CanChangeBlockType())
		{
			DomainManager.Map.ChangeBlockTemplate(mainThreadDataContext, location, blockTemplateId, isTurnVisible: true);
		}
	}

	public static short GetNearestSettlementIdByLocation(Location location)
	{
		return DomainManager.Map.GetNearestSettlementIdByLocation(location);
	}

	public static short GetAreaRandomSettlementId(short areaId, bool containsMainCity = false, bool containsSect = false)
	{
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		DomainManager.Map.GetAreaSettlementIds(areaId, list, containsMainCity, containsSect);
		short random = list.GetRandom(Domain.MainThreadDataContext.Random);
		ObjectPool<List<short>>.Instance.Return(list);
		return random;
	}

	public static void ChangeSpiritualDebtByAreaId(short areaId, int changeValue)
	{
		DomainManager.Extra.ChangeAreaSpiritualDebt(Domain.MainThreadDataContext, areaId, changeValue);
	}

	public static int GetAreaSpiritualDebt(short areaId)
	{
		return DomainManager.Extra.GetAreaSpiritualDebt(areaId);
	}

	public static short GetSpiritualDebtFinalCost(short targetSettlementId, short baseCost)
	{
		return DomainManager.Taiwu.GetSpiritualDebtFinalCost(targetSettlementId, baseCost);
	}

	public static int ChangeSpiritualDebtInTravelingEvent(short areaId, sbyte lifeSkillType)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int roleLifeSkillAttainmentWithQualification = GetRoleLifeSkillAttainmentWithQualification(taiwu, lifeSkillType);
		int num = roleLifeSkillAttainmentWithQualification * 5 / 20;
		ChangeSpiritualDebtByAreaId(areaId, (short)num);
		return num;
	}

	[Obsolete("use GetAreaSpiritualDebt instead.")]
	public static short GetAreaSpiritualDebtByAreaId(short areaId)
	{
		MapAreaData element_Areas = DomainManager.Map.GetElement_Areas(areaId);
		if (element_Areas != null)
		{
			return element_Areas.SpiritualDebt;
		}
		throw new Exception($"{areaId} is NOT available! ");
	}

	[Obsolete]
	public static List<MapTemplateEnemyInfo> GetMapRandomEnemyGroup(MapBlockData blockData)
	{
		return GetMapRandomEnemyGroupForChar(blockData, DomainManager.Taiwu.GetTaiwuCharId(), avoidRandomEnemy: true);
	}

	[Obsolete]
	public static List<MapTemplateEnemyInfo> GetMapRandomEnemyGroupForCharacter(MapBlockData blockData, int charId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			throw new Exception("GetMapRandomEnemyGroupForCharacter need a alive character id!");
		}
		if (blockData.TemplateEnemyList == null || blockData.TemplateEnemyList.Count <= 0)
		{
			return null;
		}
		List<MapTemplateEnemyInfo> list = new List<MapTemplateEnemyInfo>();
		List<MapTemplateEnemyInfo> list2 = new List<MapTemplateEnemyInfo>();
		List<MapTemplateEnemyInfo> list3 = new List<MapTemplateEnemyInfo>();
		int i = 0;
		for (int count = blockData.TemplateEnemyList.Count; i < count; i++)
		{
			MapTemplateEnemyInfo item = blockData.TemplateEnemyList[i];
			if (GameData.Domains.Character.Character.IsXiangshuMinion(item.TemplateId))
			{
				list.Add(item);
			}
			else if (GameData.Domains.Character.Character.IsRighteous(item.TemplateId))
			{
				list2.Add(item);
			}
			else
			{
				list3.Add(item);
			}
		}
		if (list.Count > 0)
		{
			if (list.Count > 1)
			{
				list.Sort(MapTemplateEnemyInfoSortFunc);
			}
			if (list.Count > 4)
			{
				list.RemoveRange(4, list.Count - 4);
			}
			return list;
		}
		if (DomainManager.Extra.IsProfessionalSkillUnlockedAndEquipped(28))
		{
			return null;
		}
		if (list2.Count > 0)
		{
			sbyte fameType = element.GetFameType();
			if (fameType == 1 || fameType == 0)
			{
				if (list2.Count > 1)
				{
					list2.Sort(MapTemplateEnemyInfoSortFunc);
				}
				if (list2.Count > 4)
				{
					list2.RemoveRange(4, list2.Count - 4);
				}
				return list2;
			}
		}
		if (list3.Count > 0)
		{
			if (list3.Count > 1)
			{
				list3.Sort(MapTemplateEnemyInfoSortFunc);
			}
			if (list3.Count > 4)
			{
				list3.RemoveRange(4, list3.Count - 4);
			}
			return list3;
		}
		return null;
		static int MapTemplateEnemyInfoSortFunc(MapTemplateEnemyInfo a, MapTemplateEnemyInfo b)
		{
			return Config.Character.Instance[b.TemplateId].OrganizationInfo.Grade.CompareTo(Config.Character.Instance[a.TemplateId].OrganizationInfo.Grade);
		}
	}

	[Obsolete]
	public static void TryTransferLocationAdventure(Location location, sbyte range)
	{
	}

	[Obsolete]
	public static void SpiritualDebtInteractionEmei()
	{
		DomainManager.Building.SpiritualDebtInteractionEmei(Domain.MainThreadDataContext);
	}

	public static int TriggerLocationFirstPickup(Location location, bool noCombat = false)
	{
		MapPickup mapPickup = DomainManager.Map.FindFirstVisibleMapPickupOnLocation(location);
		if (mapPickup == null || !mapPickup.IsNormalType)
		{
			return -1;
		}
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		if (mapPickup.HasXiangshuMinion && !noCombat && !mapPickup.CalcCanAutoBeatXiangshuMinion())
		{
			return CreateNonIntelligentCharacter(mapPickup.CalcXiangshuMinionTemplateId());
		}
		if (mapPickup.HasXiangshuMinion)
		{
			mapPickup.ApplyMinionEscape(mainThreadDataContext, location);
		}
		DomainManager.Map.TriggerNormalMapPickup(mainThreadDataContext, mapPickup);
		return -1;
	}

	public static bool AnyAutoPickup(Location location)
	{
		if (!GlobalDomain.Settings.AutoTriggerMapNormalPickup)
		{
			return false;
		}
		return DomainManager.Map.GetMapPickups(location).Any(IsAutoPickup);
	}

	public static int TriggerLocationAutoPickups(Location location)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		List<MapPickup> list = DomainManager.Map.GetMapPickups(location).ToList();
		list.Sort(MapPickupHelper.CompareVisiblePickups);
		foreach (MapPickup item in list.Where(IsAutoPickup))
		{
			if (item.HasXiangshuMinion && !item.CalcCanAutoBeatXiangshuMinion())
			{
				DomainManager.Map.SetPickupAtFirst(mainThreadDataContext, item);
				return CreateNonIntelligentCharacter(item.CalcXiangshuMinionTemplateId());
			}
			if (item.HasXiangshuMinion)
			{
				item.ApplyMinionEscape(mainThreadDataContext, location);
			}
			DomainManager.Map.TriggerNormalMapPickup(mainThreadDataContext, item);
		}
		return -1;
	}

	private static bool IsAutoPickup(MapPickup pickup)
	{
		//IL_007b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0080: Unknown result type (might be due to invalid IL or missing references)
		MapPickupAutoTriggerSetting normalMapPickupAutoTriggerSetting = GlobalDomain.Settings.NormalMapPickupAutoTriggerSetting;
		if (!normalMapPickupAutoTriggerSetting.IncludeXiangshuMinion && pickup.CalcNeedBattle())
		{
			return false;
		}
		if (normalMapPickupAutoTriggerSetting.MinGrade != -1 && pickup.Type == MapPickup.EMapPickupType.Item && ItemTemplateHelper.GetGrade(pickup.ItemType, pickup.ItemTemplateId) < normalMapPickupAutoTriggerSetting.MinGrade)
		{
			return false;
		}
		if (!normalMapPickupAutoTriggerSetting.PickupTypes[(int)pickup.Template.Type2])
		{
			return false;
		}
		BoolArray32 val = pickup.CalcMapPickupBanReason();
		return !((BoolArray32)(ref val)).Any();
	}

	public static void OnTaiwuDefeatByMapPickupEnemy(EventArgBox argBox)
	{
		DomainManager.Map.TempDisableTriggerNormalPickupByTaiwuEscape = true;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		if (!argBox.Get<Location>("BlockFrom", out Location _))
		{
			argBox.Set("BlockFrom", (ISerializableGameData)(object)DomainManager.Map.TaiwuLastLocation);
		}
		CharacterEscapeToNearbyBlock(argBox, taiwu, 1);
		DomainManager.Map.TempDisableTriggerNormalPickupByTaiwuEscape = false;
	}

	public static void ChangeMerchantFavorability(sbyte merchantType, int delta)
	{
		DomainManager.Merchant.ChangeMerchantCumulativeMoney(Domain.MainThreadDataContext, merchantType, delta);
	}

	[Obsolete]
	public static void ChangeMerchantFavorabilityPercent(sbyte merchantType, int delta)
	{
		DomainManager.Merchant.ChangeMerchantFavorability(Domain.MainThreadDataContext, merchantType, delta);
	}

	public static int GetMerchantFavorability(sbyte merchantType)
	{
		return DomainManager.Merchant.GetCumulativeMoney(merchantType);
	}

	public static int GetMerchantFavorabilityPercent(sbyte merchantType)
	{
		return DomainManager.Merchant.GetCurFavorability(merchantType);
	}

	public static sbyte GetMerchantLevel(sbyte merchantType, short settlementId)
	{
		return DomainManager.Merchant.GetMerchantLevel(merchantType, settlementId);
	}

	public static void StartTempCaravanAction(sbyte merchantType, sbyte merchantLevel, bool refresh = false, bool ignoreWorldProgress = false, bool ignoreFavorability = false, string tradeFinishEvent = "", EventArgBox argBox = null)
	{
		DomainManager.Merchant.StartTempCaravanAction(merchantType, merchantLevel, refresh, ignoreWorldProgress, ignoreFavorability, isOpenedByProfessionSkill: false);
		Domain.SetListenerWithActionName(tradeFinishEvent, argBox, "ShopActionComplete");
	}

	public static void StartSpecificCharIdAndMerchantTypeAction(int charId, sbyte merchantType, sbyte merchantLevel, bool refresh = false, string tradeFinishEvent = "", EventArgBox argBox = null)
	{
		DomainManager.Merchant.StartSpecificCharIdAndMerchantTypeAction(charId, merchantType, merchantLevel, refresh);
		Domain.SetListenerWithActionName(tradeFinishEvent, argBox, "ShopActionComplete");
	}

	public static void DiscardNormalInformation(int charId, NormalInformation normalInformation)
	{
		DomainManager.Information.DiscardNormalInformation(Domain.MainThreadDataContext, charId, normalInformation);
	}

	public static void TransformNormalInformation(int charId, NormalInformation normalInformation)
	{
		DomainManager.Information.TransformNormalInformation(Domain.MainThreadDataContext, charId, normalInformation);
	}

	public static void CostNormalInformationUsedCount(int charId, NormalInformation normalInformation)
	{
		if (!DomainManager.Information.TryGetElement_Information(charId, out var value))
		{
			return;
		}
		InformationItem item = Config.Information.Instance.GetItem(normalInformation.TemplateId);
		if (item.InfoIds.CheckIndex(normalInformation.Level))
		{
			InformationInfoItem item2 = InformationInfo.Instance.GetItem(item.InfoIds[normalInformation.Level]);
			if (!item2.Consume)
			{
				return;
			}
		}
		sbyte usedCount = value.GetUsedCount(normalInformation);
		usedCount = value.SetUsedCount(normalInformation, (sbyte)(usedCount + 1));
		if (usedCount >= value.GetUsedCountMax(normalInformation))
		{
			DiscardNormalInformation(charId, normalInformation);
		}
		else
		{
			DomainManager.Information.SetNormalInformationCharacterDataModified(Domain.MainThreadDataContext, charId);
		}
	}

	public unsafe static sbyte GetNormalInformationUseResultType(int targetCharId, NormalInformation normalInformation)
	{
		InformationItem informationItem = Config.Information.Instance[normalInformation.TemplateId];
		InformationInfoItem info = InformationInfo.Instance[informationItem.InfoIds[normalInformation.Level]];
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(targetCharId);
		switch (informationItem.Type)
		{
		case 0:
		{
			MapStateItem mapStateItem = MapState.Instance.First((MapStateItem s) => MapArea.Instance[s.MainAreaID].OrganizationId.Contains(info.Oraganization));
			sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(element_Objects.GetLocation().AreaId);
			if ((mapStateItem.TemplateId != stateTemplateIdByAreaId && !mapStateItem.NeighborStates.Contains(stateTemplateIdByAreaId)) || (DomainManager.Map.GetAreaIdByAreaTemplateId(mapStateItem.MainAreaID) == element_Objects.GetBirthLocation().AreaId && element_Objects.GetBirthLocation().AreaId != element_Objects.GetLocation().AreaId))
			{
				return 0;
			}
			if (mapStateItem.TemplateId != stateTemplateIdByAreaId || (mapStateItem.TemplateId == stateTemplateIdByAreaId && normalInformation.Level > element_Objects.GetOrganizationInfo().Grade))
			{
				return 1;
			}
			return 2;
		}
		case 1:
		{
			sbyte oraganization = info.Oraganization;
			OrganizationInfo organizationInfo2 = element_Objects.GetOrganizationInfo();
			if (oraganization != organizationInfo2.OrgTemplateId && organizationInfo2.OrgTemplateId >= 0 && Config.Organization.Instance[oraganization].Goodness != Config.Organization.Instance[organizationInfo2.OrgTemplateId].Goodness)
			{
				return 0;
			}
			if (oraganization != organizationInfo2.OrgTemplateId)
			{
				return 1;
			}
			return 2;
		}
		case 2:
		{
			NormalInformationCollection characterNormalInformation = DomainManager.Information.GetCharacterNormalInformation(targetCharId);
			if (!characterNormalInformation.ReceivedCounts.TryGetValue(informationItem.TemplateId, out var value))
			{
				value = 0;
			}
			short num = DomainManager.Taiwu.GetTaiwu().GetLifeSkillQualifications().Items[info.LifeSkillType];
			short num2 = element_Objects.GetLifeSkillQualifications().Items[info.LifeSkillType];
			if (num * (normalInformation.Level + 1) >= num2 + num2 * value * 2)
			{
				characterNormalInformation.ReceivedCounts[informationItem.TemplateId] = (sbyte)(value + 2);
				return 0;
			}
			if (num * (normalInformation.Level + 1) >= num2 + num2 * value)
			{
				characterNormalInformation.ReceivedCounts[informationItem.TemplateId] = (sbyte)(value + 1);
				return 1;
			}
			return 2;
		}
		case 3:
		case 4:
		{
			NormalInformationCollection characterNormalInformation2 = DomainManager.Information.GetCharacterNormalInformation(targetCharId);
			if (!characterNormalInformation2.GetList().Contains(normalInformation))
			{
				return 0;
			}
			return 2;
		}
		case 5:
			return 3;
		case 6:
		{
			ProfessionData characterCurrentProfession = DomainManager.Extra.GetCharacterCurrentProfession(targetCharId);
			OrganizationInfo organizationInfo = element_Objects.GetOrganizationInfo();
			if (organizationInfo.OrgTemplateId >= 0)
			{
				short memberId = OrganizationDomain.GetMemberId(organizationInfo.OrgTemplateId, organizationInfo.Grade);
				OrganizationMemberItem item = OrganizationMember.Instance.GetItem(memberId);
				if (item.PreferProfessions != null)
				{
					IntPair[] preferProfessions = item.PreferProfessions;
					for (int i = 0; i < preferProfessions.Length; i++)
					{
						IntPair intPair = preferProfessions[i];
						if (intPair.First == info.Profession && intPair.Second == 0)
						{
							return 2;
						}
					}
				}
			}
			if (characterCurrentProfession != null)
			{
				ProfessionItem config = characterCurrentProfession.GetConfig();
				if (config.CompatibleProfessions.Contains(info.Profession))
				{
					return 0;
				}
				if (config.ConflictingProfessions.Contains(info.Profession))
				{
					return 2;
				}
			}
			return 1;
		}
		default:
			throw new NotImplementedException();
		}
	}

	internal static bool NormalInformationCanGiveTaiwu(NormalInformation information)
	{
		InformationItem item = Config.Information.Instance.GetItem(information.TemplateId);
		if (item != null)
		{
			sbyte type = item.Type;
			if ((uint)type <= 1u || type == 6)
			{
				return true;
			}
		}
		return false;
	}

	public static bool CheckCharacterHasNormalInformationCanGiveTaiwu(int charId)
	{
		NormalInformationCollection characterNormalInformation = DomainManager.Information.GetCharacterNormalInformation(charId);
		return characterNormalInformation != null && characterNormalInformation.GetList().Count(NormalInformationCanGiveTaiwu) > 0;
	}

	public static IEnumerable<NormalInformation> GetExceptedCharacterNormalInformation(int charAId, int charBId)
	{
		IList<NormalInformation> collectionAList = DomainManager.Information.GetCharacterNormalInformation(charAId).GetList();
		NormalInformationCollection collectionB = DomainManager.Information.GetCharacterNormalInformation(charBId);
		foreach (NormalInformation source in collectionB.GetList())
		{
			if (NormalInformationCanGiveTaiwu(source))
			{
				InformationItem config = Config.Information.Instance.GetItem(source.TemplateId);
				if (!collectionAList.Contains(source) || !config.UsedCountWithMax)
				{
					yield return source;
				}
			}
		}
	}

	public static int GetExtraNormalInformationOdds(int selfCharId, int targetCharId, IEnumerable<NormalInformation> exceptedSet)
	{
		NormalInformationCollection characterNormalInformation = DomainManager.Information.GetCharacterNormalInformation(selfCharId);
		NormalInformationCollection characterNormalInformation2 = DomainManager.Information.GetCharacterNormalInformation(targetCharId);
		if (!exceptedSet.Any())
		{
			return 0;
		}
		sbyte b = 2;
		sbyte favorabilityType = FavorabilityType.GetFavorabilityType(DomainManager.Character.GetFavorability(targetCharId, selfCharId));
		if (favorabilityType < b)
		{
			return 0;
		}
		return (Math.Max(0, favorabilityType - b) + 1) * 20;
	}

	public static NormalInformation DistributeExtraNormalInformation(IEnumerable<NormalInformation> exceptedSet, int targetId)
	{
		NormalInformation normalInformation = exceptedSet.OrderBy((NormalInformation e) => e.Level).First();
		DistributeNormalInformationToCharacter(normalInformation, targetId);
		return normalInformation;
	}

	public static void DistributeNormalInformationToCharacter(NormalInformation normalInformation, int targetId)
	{
		InformationItem item = Config.Information.Instance.GetItem(normalInformation.TemplateId);
		if (item.UsedCountWithMax)
		{
			DomainManager.Information.AddNormalInformationToCharacter(Domain.MainThreadDataContext, targetId, normalInformation);
		}
		else
		{
			DomainManager.Information.GiveRemainUsedCountInformation(Domain.MainThreadDataContext, targetId, normalInformation);
		}
		if (targetId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			AddLegacyPoint(34);
		}
	}

	public static void ApplyNormalInformationSideEffect(NormalInformation normalInformation, sbyte useResultType, int selfCharId, int targetId)
	{
		ApplyNormalInformationSideEffectWithEffectRate(normalInformation, useResultType, selfCharId, targetId, 100);
	}

	public static void ApplyNormalInformationSideEffectWithEffectRate(NormalInformation normalInformation, sbyte useResultType, int selfCharId, int targetId, int effectRate)
	{
		InformationItem informationItem = Config.Information.Instance[normalInformation.TemplateId];
		GameData.Domains.Character.Character targetChar = DomainManager.Character.GetElement_Objects(targetId);
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		switch (informationItem.Type)
		{
		case 0:
		{
			sbyte oraganization2 = InformationInfo.Instance[informationItem.InfoIds[normalInformation.Level]].Oraganization;
			Location currentAreaLocation = targetChar.GetLocation();
			if (GetRandom() < informationItem.ChangeLovingAndHatingRate[useResultType] * effectRate / 100)
			{
				if (CheckProbability(informationItem.ChangeLovingRate))
				{
					ChangeLoving();
				}
				else
				{
					ChangeHating();
				}
			}
			break;
		}
		case 1:
		{
			sbyte oraganization = InformationInfo.Instance[informationItem.InfoIds[normalInformation.Level]].Oraganization;
			OrganizationItem organizationItem = Config.Organization.Instance[oraganization];
			Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(oraganization);
			Tester.Assert(organizationItem.IsSect);
			if (GetRandom() < informationItem.ChangeTowardOrganizationRate[useResultType] * effectRate / 100)
			{
				targetChar.SetIdealSect(oraganization, Domain.MainThreadDataContext);
				lifeRecordCollection.AddNormalInformationChangeIdealSect(targetId, DomainManager.World.GetCurrDate(), targetChar.GetLocation(), selfCharId, settlementByOrgTemplateId.GetId());
			}
			sbyte idealSect = targetChar.GetIdealSect();
			if (normalInformation.TemplateId >= 55 && normalInformation.TemplateId <= 75 && oraganization == idealSect && GetRandom() < informationItem.RemoveTowardOrganizationRate[useResultType])
			{
				int random;
				do
				{
					random = GetRandom(1, 15);
				}
				while (random == idealSect);
				idealSect = (sbyte)random;
				targetChar.SetIdealSect(idealSect, Domain.MainThreadDataContext);
				lifeRecordCollection.AddNormalInformationChangeIdealSectNegative(targetId, DomainManager.World.GetCurrDate(), targetChar.GetLocation(), selfCharId, settlementByOrgTemplateId.GetId());
			}
			if (GetRandom() < informationItem.ChangeBehaviorTypeRate[useResultType] * effectRate / 100)
			{
				short baseMorality = targetChar.GetBaseMorality();
				short mainMorality = Config.Organization.Instance[oraganization].MainMorality;
				int num = baseMorality + (mainMorality - baseMorality) / 10;
				sbyte behaviorType = targetChar.GetBehaviorType();
				ChangeRoleBaseBehaviorValue(targetChar, (short)(num - baseMorality));
				sbyte behaviorType2 = targetChar.GetBehaviorType();
				if (behaviorType2 != behaviorType)
				{
					lifeRecordCollection.AddNormalInformationChangeBaseMorality(targetId, DomainManager.World.GetCurrDate(), targetChar.GetLocation(), selfCharId, behaviorType2);
				}
			}
			break;
		}
		case 2:
		{
			sbyte lifeSkillType = InformationInfo.Instance[informationItem.InfoIds[normalInformation.Level]].LifeSkillType;
			if (useResultType == 0)
			{
				GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(selfCharId);
				lifeRecordCollection.AddNormalInformationChangeLifeSkillTypeInterest(targetId, DomainManager.World.GetCurrDate(), targetChar.GetLocation(), selfCharId, lifeSkillType);
				targetChar.AddPersonalNeed(Domain.MainThreadDataContext, GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(15, lifeSkillType, element_Objects.GetLifeSkillAttainment(lifeSkillType)));
			}
			break;
		}
		case 5:
			switch (useResultType)
			{
			case 0:
				DomainManager.Character.GetElement_Objects(selfCharId).ChangeResource(Domain.MainThreadDataContext, 7, informationItem.Authority * effectRate / 100);
				break;
			case 1:
				DomainManager.Character.GetElement_Objects(selfCharId).ChangeResource(Domain.MainThreadDataContext, 7, informationItem.Authority / 2 * effectRate / 100);
				break;
			}
			break;
		default:
			if (useResultType == 0)
			{
				DomainManager.Character.GetElement_Objects(selfCharId).ChangeResource(Domain.MainThreadDataContext, 7, informationItem.Authority * effectRate / 100);
			}
			break;
		}
	}

	public static string ApplyNormalInformation(int charId, EventArgBox argBox, NormalInformation normalInformation, string nextEventGuid1, string nextEventGuid2, string nextEventGuid3, string nextEventGuid4)
	{
		return ApplyNormalInformationWithEffectRate(charId, argBox, normalInformation, nextEventGuid1, nextEventGuid2, nextEventGuid3, nextEventGuid4, 100);
	}

	public static string ApplyNormalInformationWithEffectRate(int charId, EventArgBox argBox, NormalInformation normalInformation, string nextEventGuid1, string nextEventGuid2, string nextEventGuid3, string nextEventGuid4, int effectRate)
	{
		sbyte normalInformationUseResultType = GetNormalInformationUseResultType(charId, normalInformation);
		InformationItem item = Config.Information.Instance.GetItem(normalInformation.TemplateId);
		if (6 == item.Type)
		{
			short value = item.ChangeProfessionRate[normalInformationUseResultType];
			if (CheckProbability(value) && DomainManager.Character.TryGetElement_Objects(charId, out var element) && element.CanHaveProfession())
			{
				InformationInfoItem item2 = InformationInfo.Instance.GetItem(item.InfoIds[normalInformation.Level]);
				DomainManager.Extra.SetCharacterCurrProfession(Domain.MainThreadDataContext, charId, item2.Profession);
				GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
				LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
				lifeRecordCollection.AddNormalInformationChangeProfession(charId, DomainManager.World.GetCurrDate(), taiwu.GetValidLocation(), taiwu.GetId(), item2.Profession);
			}
		}
		if (normalInformationUseResultType != 3)
		{
			SetInteractionCooldown(charId, 0);
		}
		switch (normalInformationUseResultType)
		{
		case 0:
		{
			InformationInfoItem item3 = InformationInfo.Instance.GetItem(item.InfoIds[normalInformation.Level]);
			if (2 == item.Type && 13 == item3.LifeSkillType)
			{
				ProfessionFormulaItem formulaCfg = ProfessionFormula.Instance[47];
				int baseDelta = formulaCfg.Calculate(normalInformation.Level);
				DomainManager.Extra.ChangeProfessionSeniority(Domain.MainThreadDataContext, 6, baseDelta);
			}
			else if (2 == item.Type && 12 == item3.LifeSkillType)
			{
				ProfessionFormulaItem formulaCfg2 = ProfessionFormula.Instance[41];
				int baseDelta2 = formulaCfg2.Calculate(normalInformation.Level);
				DomainManager.Extra.ChangeProfessionSeniority(Domain.MainThreadDataContext, 5, baseDelta2);
			}
			else
			{
				ProfessionFormulaItem formulaCfg3 = ProfessionFormula.Instance[31];
				int baseDelta3 = formulaCfg3.Calculate(normalInformation.Level);
				DomainManager.Extra.ChangeProfessionSeniority(Domain.MainThreadDataContext, 4, baseDelta3);
			}
			CostNormalInformationUsedCount(EventArgBox.TaiwuCharacterId, normalInformation);
			ApplyNormalInformationSideEffectWithEffectRate(normalInformation, 0, EventArgBox.TaiwuCharacterId, charId, effectRate);
			AddLegacyPoint(35);
			return nextEventGuid2;
		}
		case 1:
			CostNormalInformationUsedCount(EventArgBox.TaiwuCharacterId, normalInformation);
			ApplyNormalInformationSideEffectWithEffectRate(normalInformation, 1, EventArgBox.TaiwuCharacterId, charId, effectRate);
			return nextEventGuid3;
		case 2:
			CostNormalInformationUsedCount(EventArgBox.TaiwuCharacterId, normalInformation);
			ApplyNormalInformationSideEffectWithEffectRate(normalInformation, 2, EventArgBox.TaiwuCharacterId, charId, effectRate);
			return nextEventGuid4;
		case 3:
			return StartSwordTombInformationEvent(normalInformation, argBox);
		default:
			return string.Empty;
		}
	}

	public static void GetSwordTombInformation(EInformationInfoSwordInformationType type, bool isConsume, int xiangshuAvatarId, EventArgBox argBox)
	{
		if (xiangshuAvatarId == -1)
		{
			MapBlockData block = DomainManager.Map.GetBlock(DomainManager.Taiwu.GetTaiwu().GetLocation());
			GameData.Domains.Character.Character blockXiangshuAvatar = GetBlockXiangshuAvatar(block);
			xiangshuAvatarId = XiangshuAvatarIds.GetXiangshuAvatarIdByCharacterTemplateId(blockXiangshuAvatar.GetTemplateId());
		}
		NormalInformation normalInformation = DomainManager.Information.CalcSwordTombInformation(type, isConsume, xiangshuAvatarId);
		InformationItem informationItem = Config.Information.Instance[normalInformation.TemplateId];
		InformationInfoItem informationInfoItem = InformationInfo.Instance[informationItem.InfoIds[normalInformation.Level]];
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		if (informationItem.UsedCountWithMax)
		{
			if (DomainManager.Information.TryGetElement_Information(taiwuCharId, out var value) && value.GetList().Contains(normalInformation))
			{
				DiscardNormalInformation(taiwuCharId, normalInformation);
			}
			DomainManager.Information.AddNormalInformationToCharacter(Domain.MainThreadDataContext, DomainManager.Taiwu.GetTaiwuCharId(), normalInformation);
		}
		else
		{
			DomainManager.Information.GiveRemainUsedCountInformation(Domain.MainThreadDataContext, DomainManager.Taiwu.GetTaiwuCharId(), normalInformation);
		}
		argBox.Set("SwordTombInformationName", informationInfoItem.Name);
	}

	public static int GetTargetCharSwordTombInformationReceivedCount(int targetCharId, NormalInformation normalInformation)
	{
		InformationItem informationItem = Config.Information.Instance[normalInformation.TemplateId];
		NormalInformationCollection characterNormalInformation = DomainManager.Information.GetCharacterNormalInformation(targetCharId);
		sbyte value;
		return characterNormalInformation.ReceivedCounts.TryGetValue(informationItem.TemplateId, out value) ? value : 0;
	}

	public static string StartSwordTombInformationEvent(NormalInformation normalInformation, EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		int id = character.GetId();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int targetCharSwordTombInformationReceivedCount = GetTargetCharSwordTombInformationReceivedCount(id, normalInformation);
		InformationItem informationItem = Config.Information.Instance[normalInformation.TemplateId];
		InformationInfoItem informationInfoItem = InformationInfo.Instance[informationItem.InfoIds[normalInformation.Level]];
		if (informationInfoItem.SwordInformationType == EInformationInfoSwordInformationType.SwordTombFake || !informationInfoItem.Consume || targetCharSwordTombInformationReceivedCount > 0)
		{
			sbyte useResultType;
			string result;
			switch ((informationInfoItem.SwordInformationType == EInformationInfoSwordInformationType.SwordTombReal && informationInfoItem.Consume) ? (targetCharSwordTombInformationReceivedCount - 1) : targetCharSwordTombInformationReceivedCount)
			{
			case 0:
				AddLegacyPoint(35);
				useResultType = 0;
				result = "44080243-84c6-40a0-95d4-31b68eecbca5";
				break;
			case 1:
				useResultType = 1;
				result = "a492637b-a49b-4041-b403-7b295bdccffe";
				break;
			default:
				useResultType = 2;
				result = "11e308de-e4c3-418b-a2c3-84fd637a19f8";
				break;
			}
			if (informationInfoItem.SwordInformationType == EInformationInfoSwordInformationType.SwordTombFake)
			{
				CostNormalInformationUsedCount(taiwuCharId, normalInformation);
			}
			ApplyNormalInformationSideEffect(normalInformation, useResultType, taiwuCharId, id);
			DomainManager.Information.EnsureCharacterNormalInformationCollection(Domain.MainThreadDataContext, id).ReceivedCounts[normalInformation.TemplateId] = (sbyte)(targetCharSwordTombInformationReceivedCount + 1);
			DomainManager.Information.SetNormalInformationCharacterDataModified(Domain.MainThreadDataContext, id);
			SetInteractionCooldown(id, 0);
			return result;
		}
		sbyte behaviorType = character.GetBehaviorType();
		sbyte orgTemplateId = character.GetOrganizationInfo().OrgTemplateId;
		if (1 == 0)
		{
		}
		sbyte b = orgTemplateId switch
		{
			5 => 0, 
			8 => 0, 
			14 => 0, 
			1 => 1, 
			2 => 1, 
			3 => 1, 
			4 => 2, 
			7 => 2, 
			9 => 2, 
			6 => 3, 
			12 => 3, 
			13 => 3, 
			10 => 4, 
			11 => 4, 
			15 => 4, 
			_ => behaviorType, 
		};
		if (1 == 0)
		{
		}
		sbyte b2 = b;
		if (1 == 0)
		{
		}
		string text2;
		switch (orgTemplateId)
		{
		case 5:
			text2 = "a01e37d7-ef93-4da3-a2c9-3cc8b2932c21";
			break;
		case 8:
			text2 = "ddcc1c56-b180-4460-807c-c022739456fd";
			break;
		case 14:
			text2 = "d2d5ee9b-4152-4b31-b0c8-2398e20afd5d";
			break;
		case 1:
			text2 = "c4975bf2-f7c4-4aa9-9811-caa9d4e81c3c";
			break;
		case 2:
			text2 = "69964475-1132-40eb-ab9e-03fc7f624115";
			break;
		case 3:
			text2 = "97ef4cf7-da8d-49c6-af7c-5bd83b9c618f";
			break;
		case 4:
			text2 = "5abdaa52-baa7-4548-8883-847e91a84c83";
			break;
		case 7:
			text2 = "64044dd9-4bd3-483a-95e2-075512f306e5";
			break;
		case 9:
			text2 = "2e68e446-0e20-4038-9e33-e9fc9d3e751a";
			break;
		case 6:
			text2 = "69256f82-0b22-4210-b1f3-1e958bd2e4db";
			break;
		case 12:
			text2 = "03c69a08-ce18-400c-b986-00873451b472";
			break;
		case 13:
			text2 = "264f4699-0e0c-4e32-bd18-0c70c2895fd6";
			break;
		case 10:
			text2 = "1425f0f3-4e36-4e94-8a5a-d368e1b98528";
			break;
		case 11:
			text2 = "452c24ec-3b37-4f16-a48b-355770537527";
			break;
		case 15:
			text2 = "80281d36-3e1f-40b9-819d-628cb6bb7c8f";
			break;
		default:
		{
			if (1 == 0)
			{
			}
			string text = behaviorType switch
			{
				0 => "cdb7b4c6-b70f-4430-b16c-fac80222c0de", 
				1 => "fe8aa2bf-f4e6-43de-b45e-8ee288610ccf", 
				2 => "2eb4a187-ab56-4bd6-b52f-b74df1571244", 
				3 => "d0fe948b-7534-4f76-8464-1294c21cb321", 
				_ => "4176fb90-550c-455c-afba-9953e62807de", 
			};
			if (1 == 0)
			{
			}
			text2 = text;
			break;
		}
		}
		if (1 == 0)
		{
		}
		string result2 = text2;
		sbyte swordTombInformationGiftMaxGrade = GetSwordTombInformationGiftMaxGrade(id);
		argBox.Set("SwordTombInformation", (ISerializableGameData)(object)normalInformation);
		argBox.Set("SwordTombName", informationInfoItem.SwordTombPlaceHolder);
		argBox.Set("SwordTombBehavior", informationInfoItem.BehaviorTypePlaceHolders[b2]);
		argBox.Set("SwordTombHiringCostString", GetSwordTombInformationHiringUsedCount().ToString());
		argBox.Set("SwordTombGiftMaxItemGradeString", $" <color=#GradeColor_{swordTombInformationGiftMaxGrade}><Language Key=LK_Num_{9 - swordTombInformationGiftMaxGrade}/><Language Key=LK_Item_Grade/></color> ");
		argBox.Set("SwordTombGiftMaxCombatSkillGradeString", $" <color=#GradeColor_{swordTombInformationGiftMaxGrade}><Language Key=LK_Num_{9 - swordTombInformationGiftMaxGrade}/><Language Key=LK_Grade/></color> ");
		argBox.Set("SwordTombGiftMaxOrgGradeString", $" <color=#GradeColor_{swordTombInformationGiftMaxGrade}><Language Key=LK_OrgGrade_{swordTombInformationGiftMaxGrade}/></color> ");
		return result2;
	}

	public static ItemKey GetSwordTombInformationGiftItem(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		int id = character.GetId();
		int arg = -1;
		if (argBox.Get("SwordTombGiftPreviousCharId", ref arg) && arg == id && argBox.Get<ItemKey>("SwordTombGiftItem", out ItemKey arg2))
		{
			return arg2;
		}
		sbyte swordTombInformationGiftMaxGrade = GetSwordTombInformationGiftMaxGrade(id);
		Inventory inventory = character.GetInventory();
		if (inventory.Items.Count == 0)
		{
			arg2 = ItemKey.Invalid;
		}
		else
		{
			int num = swordTombInformationGiftMaxGrade + 1;
			List<ItemKey> list = ObjectPool<List<ItemKey>>.Instance.Get();
			list.Clear();
			while (list.Count == 0 && num > 0)
			{
				num--;
				foreach (ItemKey key in inventory.Items.Keys)
				{
					if (GetItemGrade(key) == num)
					{
						list.Add(key);
					}
				}
			}
			arg2 = ((list.Count > 0) ? list[new Random(id).Next(list.Count)] : ItemKey.Invalid);
			ObjectPool<List<ItemKey>>.Instance.Return(list);
		}
		argBox.Set("SwordTombGiftItem", (ISerializableGameData)(object)arg2);
		return arg2;
	}

	public static short GetSwordTombInformationGiftCombatSkill(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		int id = character.GetId();
		int arg = -1;
		short arg2 = -1;
		if (argBox.Get("SwordTombGiftPreviousCharId", ref arg) && arg == id && argBox.Get("SwordTombGiftCombatSkill", ref arg2))
		{
			return arg2;
		}
		sbyte swordTombInformationGiftMaxGrade = GetSwordTombInformationGiftMaxGrade(id);
		List<short> charCombatSkillList = GetCharCombatSkillList(id, -1, -1, 0, 8);
		List<short> learnedCombatSkills = DomainManager.Taiwu.GetTaiwu().GetLearnedCombatSkills();
		if (charCombatSkillList == null || charCombatSkillList.Count == 0)
		{
			arg2 = -1;
		}
		else
		{
			int num = swordTombInformationGiftMaxGrade + 1;
			List<short> list = ObjectPool<List<short>>.Instance.Get();
			list.Clear();
			while (list.Count == 0 && num > 0)
			{
				num--;
				foreach (short item in charCombatSkillList)
				{
					if (Config.CombatSkill.Instance[item].Grade == num && !learnedCombatSkills.Contains(item))
					{
						list.Add(item);
					}
				}
			}
			arg2 = (short)((list.Count > 0) ? list[new Random(id).Next(list.Count)] : (-1));
			ObjectPool<List<short>>.Instance.Return(list);
		}
		argBox.Set("SwordTombGiftCombatSkill", arg2);
		return arg2;
	}

	public static bool IsSwordTombInformationGiftCharacterAbleToJoin(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		int id = character.GetId();
		int arg = -1;
		bool arg2 = false;
		if (argBox.Get("SwordTombGiftPreviousCharId", ref arg) && arg == id && argBox.Get("SwordTombGiftCharacter", ref arg2))
		{
			return arg2;
		}
		arg2 = character.GetOrganizationInfo().Grade <= GetSwordTombInformationGiftMaxGrade(character.GetId());
		argBox.Set("SwordTombGiftCharacter", arg2);
		return arg2;
	}

	public static sbyte GetSwordTombInformationGiftMaxGrade(int targetCharId)
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int num = DomainManager.World.GetXiangshuLevel() + 1;
		ushort relationType = DomainManager.Character.GetRelation(targetCharId, taiwuCharId).RelationType;
		bool flag = FavorabilityType.GetFavorabilityType(DomainManager.Character.GetFavorability(targetCharId, taiwuCharId)) >= 6;
		bool flag2 = RelationType.HasRelation(relationType, 2) || RelationType.HasRelation(relationType, 1) || RelationType.HasRelation(relationType, 4) || RelationType.HasRelation(relationType, 16) || RelationType.HasRelation(relationType, 8) || RelationType.HasRelation(relationType, 32) || RelationType.HasRelation(relationType, 128) || RelationType.HasRelation(relationType, 64) || RelationType.HasRelation(relationType, 256) || RelationType.HasRelation(relationType, 512) || RelationType.HasRelation(relationType, 16384) || RelationType.HasRelation(relationType, 1024);
		return (sbyte)Math.Min(8, num + (flag ? 1 : 0) + (flag2 ? 1 : 0));
	}

	public static void SwordTombInformationReceiveGift(short giftType, EventArgBox argBox)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		string text = "";
		argBox.Set("SwordTombGiftType", giftType);
		object obj;
		ItemKey item;
		switch (giftType)
		{
		case 1:
			argBox.Get<ItemKey>("SwordTombGiftItem", out item);
			if (item.ItemType == 12)
			{
				short templateId = item.TemplateId;
				if (templateId >= 211 && templateId <= 224)
				{
					obj = "a679dd12-3e7d-404d-8f91-beca19a04cb0";
					goto IL_008a;
				}
			}
			obj = "9ffe7e03-456b-4abc-abf2-82da562cd3a3";
			goto IL_008a;
		case 2:
		{
			short arg = -1;
			argBox.Get("SwordTombGiftCombatSkill", ref arg);
			ClearTeachTaiwuCombatSkillList(character.GetId());
			item = LearnCombatSkillFromNpc(character, arg);
			text = "da61b2a3-ec1c-4e09-a261-f554a88b4109";
			ShowGetItemPageForItems(new List<(ItemKey, int)> { (item, 1) }, text, argBox);
			argBox.Remove<short>("SwordTombGiftCombatSkill");
			argBox.Set("SwordTombGiftCombatSkillReceived", arg);
			break;
		}
		case 3:
			{
				int id = character.GetId();
				sbyte roleBehavior = GetRoleBehavior(character);
				if (1 == 0)
				{
				}
				string text2 = roleBehavior switch
				{
					0 => "1da53983-cd7f-475f-b64c-745b1947e477", 
					1 => "77b5e4b0-56f3-4cd0-851e-abbb900f4cba", 
					2 => "955d6803-7cc5-4dfa-921e-c203dce41499", 
					3 => "c78109fa-d65e-4c51-8a6c-53f4dabad64a", 
					4 => "e72877d3-5a7e-4e80-8433-707cb95356d6", 
					_ => text, 
				};
				if (1 == 0)
				{
				}
				text = text2;
				RequestRoleJoinGroup(id);
				ShowGetItemPageForCharacters(new List<int> { id }, isVillager: false, text, argBox);
				break;
			}
			IL_008a:
			text = (string)obj;
			TransferInventoryItem(character, taiwu, item);
			ShowGetItemPageForItems(new List<(ItemKey, int)> { (item, 1) }, text, argBox);
			argBox.Remove<ItemKey>("SwordTombGiftItem");
			break;
		}
	}

	public static void FinishSwordTombInformationEvent(EventArgBox argBox)
	{
		int arg = 0;
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		NormalInformationCollection element_Information = DomainManager.Information.GetElement_Information(taiwuCharId);
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		int id = character.GetId();
		argBox.Get<NormalInformation>("SwordTombInformation", out NormalInformation arg2);
		argBox.Get("SwordTombGiftType", ref arg);
		SetInteractionCooldown(id, 0);
		sbyte b = element_Information.GetUsedCount(arg2);
		DomainManager.Information.EnsureCharacterNormalInformationCollection(Domain.MainThreadDataContext, id).ReceivedCounts[arg2.TemplateId] = 1;
		switch (arg)
		{
		case 1:
			b = element_Information.SetUsedCount(arg2, (sbyte)(b + 1));
			break;
		case 2:
			b = element_Information.SetUsedCount(arg2, (sbyte)(b + 1));
			break;
		case 3:
			b = element_Information.SetUsedCount(arg2, (sbyte)(b + GetSwordTombInformationHiringUsedCount()));
			break;
		}
		if (b >= element_Information.GetUsedCountMax(arg2))
		{
			TransformNormalInformation(taiwuCharId, arg2);
		}
		else
		{
			DomainManager.Information.SetNormalInformationCharacterDataModified(Domain.MainThreadDataContext, taiwuCharId);
		}
		DomainManager.Information.SetNormalInformationCharacterDataModified(Domain.MainThreadDataContext, id);
	}

	public static int GetSwordTombInformationHiringUsedCount()
	{
		return 3;
	}

	public static void FixTaiwuMainStoryGainSkillBook()
	{
		DomainManager.Extra.FixTaiwuMainStoryGainSkillBook(Domain.MainThreadDataContext);
	}

	public static void SettlementPrisonSetInfo(short buildingTemplateId, EventArgBox argBox)
	{
		Settlement taiwuLocationSettlement = GetTaiwuLocationSettlement();
		argBox.Set("SettlementId", taiwuLocationSettlement.GetId());
		argBox.Set("AreaId", taiwuLocationSettlement.GetLocation().AreaId);
		Tester.Assert(SettlementIsSect(taiwuLocationSettlement.GetId()));
		SectSettlementSetGuardInfo(taiwuLocationSettlement, argBox);
	}

	[Obsolete("Always return true for now.")]
	public static bool SettlementPrisonCanEnter(short settlementId, EventArgBox argBox)
	{
		return true;
	}

	public static void AddBounty(Sect sect, GameData.Domains.Character.Character character, sbyte punishmentSeverity, short punishmentType, int duration = -1)
	{
		sect.AddBounty(Domain.MainThreadDataContext, character, punishmentSeverity, punishmentType, duration);
	}

	public static void AddBounty(int charId, sbyte orgTemplateId, short punishmentType)
	{
		if (DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId) is Sect sect && DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			PunishmentTypeItem punishmentTypeItem = PunishmentType.Instance[punishmentType];
			if (punishmentTypeItem != null)
			{
				sect.AddBounty(Domain.MainThreadDataContext, element, punishmentTypeItem.Severity, punishmentType);
			}
		}
	}

	public static void AddTaiwuBounty(sbyte orgTemplateId, short punishmentType)
	{
		AddBounty(DomainManager.Taiwu.GetTaiwuCharId(), orgTemplateId, punishmentType);
	}

	public static bool IsCharacterSectFugitive(int charId, short settlementId)
	{
		Tester.Assert(charId != DomainManager.Taiwu.GetTaiwuCharId());
		if (settlementId < 0)
		{
			return false;
		}
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		return DomainManager.Organization.IsCharacterSectFugitive(charId, settlement.GetOrgTemplateId());
	}

	public static bool IsTaiwuSectFugitive(short settlementId)
	{
		if (settlementId < 0)
		{
			return false;
		}
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		return DomainManager.Organization.GetTaiwuFugitiveBountySect()?.Contains(settlement.GetOrgTemplateId()) ?? false;
	}

	public static bool IsCharacterSectEnemy(int charId, short settlementId)
	{
		Tester.Assert(settlementId >= 0);
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		if (!(settlement is Sect sect))
		{
			return false;
		}
		return sect.HasEnemySectBounty(charId) || sect.HasEnemyRelationBounty(charId);
	}

	public static void SendCharacterIntoPrison(int charId, short settlementId, EventArgBox argBox, int duration = -1)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return;
		}
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		if (!(settlement is Sect sect))
		{
			return;
		}
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
		lifeRecordCollection.AddSendingToPrisonCriminal(element.GetId(), GetGameDate(), taiwu.GetId(), sect.GetId());
		SettlementPrisonRecordCollection settlementPrisonRecordCollection = DomainManager.Extra.GetSettlementPrisonRecordCollection(mainThreadDataContext, settlementId);
		settlementPrisonRecordCollection.AddSentToPrisonTaiwu(GetGameDate(), settlementId, charId, taiwu.GetId());
		DomainManager.Extra.SetSettlementPrisonRecordCollection(mainThreadDataContext, settlementId, settlementPrisonRecordCollection);
		CharacterSet groupCharIds = DomainManager.Taiwu.GetGroupCharIds();
		if (DomainManager.Character.TryGetKidnappedCharacters(taiwu.GetId(), out var list) && list.IndexOf(charId) >= 0)
		{
			RemovePrisonerFromCharacter(charId, taiwu.GetId(), isEscaped: false);
		}
		if (groupCharIds.GetCollection().Contains(charId))
		{
			SettlementPrisonEventEffectItem settlementPrisonEventEffectItem = SettlementPrisonEventEffect.Instance[(short)0];
			ChangeFavorabilityOptional(element, taiwu, (short)settlementPrisonEventEffectItem.ChangeFavorTeammate, 3);
			RequestRoleLeaveGroup(charId);
		}
		ProfessionFormulaItem formulaCfg = ProfessionFormula.Instance[27];
		if (duration != -1)
		{
			sbyte punishmentSeverity = DurationToPunishmentSeverityLevel(duration);
			sect.AddPrisoner(mainThreadDataContext, element, punishmentSeverity, 43, duration);
			lifeRecordCollection.AddSendingToPrison2Taiwu(taiwu.GetId(), GetGameDate(), element.GetId(), sect.GetId());
			return;
		}
		sbyte sectOrgTemplateId;
		SettlementBounty bounty = DomainManager.Organization.GetBounty(charId, out sectOrgTemplateId);
		if (IsCharacterSectFugitive(charId, settlementId))
		{
			if (element.IsCompletelyInfected())
			{
				sect.AddPrisoner(mainThreadDataContext, element, 39);
			}
			else
			{
				DomainManager.Organization.PunishSectMember(mainThreadDataContext, sect, element, bounty.PunishmentSeverity, bounty.PunishmentType, isArrested: true);
			}
			int baseDelta = formulaCfg.Calculate(bounty.PunishmentSeverity + 1, element.GetInteractionGrade());
			DomainManager.Extra.ChangeProfessionSeniority(mainThreadDataContext, 3, baseDelta);
		}
		else if (sect.HasEnemySectBounty(charId))
		{
			PunishmentTypeItem punishmentTypeItem = PunishmentType.Instance[(short)41];
			sbyte punishmentTypeSeverity = sect.GetPunishmentTypeSeverity(punishmentTypeItem, includeDefault: true);
			sect.AddPrisoner(mainThreadDataContext, element, punishmentTypeSeverity, punishmentTypeItem.TemplateId);
			int baseDelta2 = formulaCfg.Calculate(punishmentTypeSeverity + 1, element.GetInteractionGrade());
			DomainManager.Extra.ChangeProfessionSeniority(mainThreadDataContext, 3, baseDelta2);
		}
		else if (sect.HasEnemyRelationBounty(charId))
		{
			PunishmentTypeItem punishmentTypeItem2 = PunishmentType.Instance[(short)42];
			sbyte punishmentTypeSeverity2 = sect.GetPunishmentTypeSeverity(punishmentTypeItem2, includeDefault: true);
			sect.AddPrisoner(mainThreadDataContext, element, punishmentTypeSeverity2, punishmentTypeItem2.TemplateId);
			List<int> enemyCharacterListOfStateSettlement = GetEnemyCharacterListOfStateSettlement(charId, settlementId);
			if (enemyCharacterListOfStateSettlement != null && enemyCharacterListOfStateSettlement.Count > 0)
			{
				for (int i = 0; i < enemyCharacterListOfStateSettlement.Count; i++)
				{
					int charId2 = enemyCharacterListOfStateSettlement[i];
					if (DomainManager.Character.TryGetElement_Objects(enemyCharacterListOfStateSettlement[i], out var element2))
					{
						ChangeFavorabilityOptional(element2, taiwu, 3000, 3);
						DomainManager.Character.TryRemoveOneWayRelation(mainThreadDataContext, charId2, charId, 32768);
					}
				}
			}
			int baseDelta3 = formulaCfg.Calculate(punishmentTypeSeverity2 + 1, element.GetInteractionGrade());
			DomainManager.Extra.ChangeProfessionSeniority(mainThreadDataContext, 3, baseDelta3);
		}
		GetBounty(sect, element, argBox);
	}

	private static List<int> GetEnemyCharacterListOfStateSettlement(int charId, short targetSettlementId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var _))
		{
			return null;
		}
		Settlement settlement = DomainManager.Organization.GetSettlement(targetSettlementId);
		Tester.Assert(settlement is Sect);
		Location location = settlement.GetLocation();
		sbyte stateIdByAreaId = DomainManager.Map.GetStateIdByAreaId(location.AreaId);
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		List<int> list2 = new List<int>();
		DomainManager.Map.GetStateSettlementIds(stateIdByAreaId, list, containsMainCity: true, containsSect: true);
		for (int i = 0; i < list.Count; i++)
		{
			short settlementId = list[i];
			Settlement settlement2 = DomainManager.Organization.GetSettlement(settlementId);
			OrgMemberCollection members = settlement2.GetMembers();
			for (sbyte b = 3; b < 9; b++)
			{
				HashSet<int> members2 = members.GetMembers(b);
				foreach (int item in members2)
				{
					if (DomainManager.Organization.GetPrisonerSect(item) != settlement.GetOrgTemplateId() && DomainManager.Character.HasRelation(item, charId, 32768))
					{
						list2.Add(item);
					}
				}
			}
		}
		ObjectPool<List<short>>.Instance.Return(list);
		return list2;
	}

	private static sbyte DurationToPunishmentSeverityLevel(int duration)
	{
		sbyte result = 1;
		if (duration >= 6)
		{
			result = 1;
		}
		if (duration >= 12)
		{
			result = 2;
		}
		if (duration >= 24)
		{
			result = 3;
		}
		return result;
	}

	public static void GetBounty(Sect sect, GameData.Domains.Character.Character character, EventArgBox argBox)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		int num = sect.CalcBountyAmount(character.GetInteractionGrade());
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		if (DomainManager.Extra.IsProfessionalSkillUnlocked(3, 2))
		{
			ProfessionData professionData = DomainManager.Extra.GetProfessionData(3);
			int seniorityPercent = professionData.GetSeniorityPercent();
			num += num * seniorityPercent / 100;
			int itemBonusGrade = Math.Clamp(character.GetOrganizationInfo().Grade * professionData.GetSeniorityPercent() / 100 - 2, 0, 8);
			short[] martialArtistItemBonus = Config.Organization.Instance.GetItem(sect.GetOrgTemplateId()).MartialArtistItemBonus;
			if (martialArtistItemBonus != null && martialArtistItemBonus.CheckIndex(itemBonusGrade))
			{
				short groupTemplateId = Config.Weapon.Instance.GetItem(martialArtistItemBonus[itemBonusGrade]).GroupId;
				List<WeaponItem> list = (from templateId in Config.Weapon.Instance.GetAllKeys()
					select Config.Weapon.Instance.GetItem(templateId) into template
					where template.GroupId == groupTemplateId && template.Grade == itemBonusGrade
					select template).ToList();
				if (list.Count > 0)
				{
					WeaponItem random = list.GetRandom(mainThreadDataContext.Random);
					ItemKey itemKey = DomainManager.Item.CreateItem(mainThreadDataContext, random.ItemType, random.TemplateId);
					taiwu.AddInventoryItem(mainThreadDataContext, itemKey, 1);
					DomainManager.World.GetInstantNotificationCollection().AddGetItem(taiwu.GetId(), itemKey.ItemType, itemKey.TemplateId);
					GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenGetItem_Item, new List<ItemDisplayData> { DomainManager.Item.GetItemDisplayData(itemKey) }, arg2: false, arg3: false);
				}
			}
		}
		argBox.Set("BountyCount", num);
		LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
		switch (Config.Organization.Instance[sect.GetOrgTemplateId()].Goodness)
		{
		case -1:
			ChangeRoleResource(taiwu, 6, num);
			argBox.Set("BountyTypeName", Config.ResourceType.Instance.GetItem(6).Name);
			lifeRecordCollection.AddSendingToPrison1Taiwu(taiwu.GetId(), GetGameDate(), character.GetId(), sect.GetId(), 6, num);
			break;
		case 1:
			ChangeRoleResource(taiwu, 7, num);
			argBox.Set("BountyTypeName", Config.ResourceType.Instance.GetItem(7).Name);
			lifeRecordCollection.AddSendingToPrison1Taiwu(taiwu.GetId(), GetGameDate(), character.GetId(), sect.GetId(), 7, num);
			break;
		case 0:
			ChangeRoleExp(taiwu, num);
			argBox.Set("BountyTypeName", CharacterPropertyDisplay.Instance.GetItem(104).Name);
			lifeRecordCollection.AddSendingToPrison1TaiwuByExp(taiwu.GetId(), GetGameDate(), character.GetId(), sect.GetId(), num);
			break;
		}
	}

	public static bool IsCharacterBelongSect(int charId, short settlementId)
	{
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		return element_Objects.GetOrganizationInfo().OrgTemplateId == settlement.GetOrgTemplateId();
	}

	public static void BreakIntoPrisonKidnapEffect(int charId, short settlementId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return;
		}
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		if (settlement is Sect sect)
		{
			SettlementPrisoner prisoner = sect.Prison.GetPrisoner(charId);
			DataContext mainThreadDataContext = Domain.MainThreadDataContext;
			GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
			if (element.IsCompletelyInfected())
			{
				DomainManager.Extra.AddStoneRoomCharacter(mainThreadDataContext, element);
				LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
				lifeRecordCollection.AddImprisonedXiangshuInfectedTaiwu(taiwu.GetId(), GetGameDate(), charId, settlementId);
			}
			else
			{
				ItemKey itemKey = CreateItem(prisoner.RopeItemKey.ItemType, prisoner.RopeItemKey.TemplateId);
				AddItemToRole(taiwu, itemKey, 1, -1);
				AddPrisonerToCharacter(charId, taiwu.GetId(), itemKey);
				sect.RemovePrisoner(mainThreadDataContext, charId);
				LifeRecordCollection lifeRecordCollection2 = GetLifeRecordCollection();
				lifeRecordCollection2.AddSentToPrisonTaiwu(taiwu.GetId(), GetGameDate(), charId, settlementId);
			}
			SettlementPrisonRecordCollection settlementPrisonRecordCollection = DomainManager.Extra.GetSettlementPrisonRecordCollection(mainThreadDataContext, settlementId);
			settlementPrisonRecordCollection.AddIntrudePrisonAndSentToPrisonTaiwu(GetGameDate(), settlementId, taiwu.GetId(), charId);
			DomainManager.Extra.SetSettlementPrisonRecordCollection(mainThreadDataContext, settlementId, settlementPrisonRecordCollection);
		}
	}

	public static void PrisonRescueEffect(int charId, short settlementId, bool breakInto)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return;
		}
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		if (settlement is Sect sect)
		{
			GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
			DataContext mainThreadDataContext = Domain.MainThreadDataContext;
			sect.RemovePrisoner(mainThreadDataContext, charId);
			if (IsTaiwuGroupFull())
			{
				OrganizationInfo organizationInfo = taiwu.GetOrganizationInfo();
				JoinOrganization(element, organizationInfo.SettlementId, 0);
			}
			else
			{
				RequestRoleJoinGroup(charId);
			}
			LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
			lifeRecordCollection.AddRobbedFromPrisonNpc(charId, GetGameDate(), taiwu.GetId(), settlementId);
			SettlementPrisonRecordCollection settlementPrisonRecordCollection = DomainManager.Organization.GetSettlementPrisonRecordCollection(mainThreadDataContext, settlementId);
			if (breakInto)
			{
				settlementPrisonRecordCollection.AddIntrudePrisonAndPrisonRobbery(GetGameDate(), settlementId, taiwu.GetId(), charId);
			}
			else
			{
				settlementPrisonRecordCollection.AddPrisonRobbery(GetGameDate(), settlementId, taiwu.GetId(), charId);
			}
			DomainManager.Organization.SetSettlementPrisonRecordCollection(mainThreadDataContext, settlementId, settlementPrisonRecordCollection);
		}
	}

	public static void BreakIntoOrRescueEffect(short settlementId, EventArgBox argBox)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		SettlementPrisonEventEffect instance = SettlementPrisonEventEffect.Instance;
		int guardCombatLevel = GetGuardCombatLevel();
		if (1 == 0)
		{
		}
		short index = guardCombatLevel switch
		{
			1 => 1, 
			2 => 2, 
			_ => 3, 
		};
		if (1 == 0)
		{
		}
		SettlementPrisonEventEffectItem effectCfg = instance[index];
		(CharacterSet, CharacterSet, CharacterSet, CharacterSet) tuple = DomainManager.Organization.ApplySettlementPrisonEventEffect(mainThreadDataContext, effectCfg, settlementId);
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int id = taiwu.GetId();
		foreach (int item in tuple.Item1.GetCollection())
		{
			bool flag = tuple.Item2.Contains(item);
			bool flag2 = tuple.Item4.Contains(item);
			if (flag && flag2)
			{
				lifeRecordCollection.AddIntrudePrisonCancelSupportMakeEnemyNpc(item, currDate, id, settlementId);
			}
			else if (flag)
			{
				lifeRecordCollection.AddIntrudePrisonMakeEnemyOthersNpc(item, currDate, id, settlementId);
			}
			else if (flag2)
			{
				lifeRecordCollection.AddIntrudePrisonCancelSupportNpc(item, currDate, id, settlementId);
			}
		}
		if (tuple.Item1.GetCount() != 0)
		{
			int count = tuple.Item2.GetCount();
			int count2 = tuple.Item4.GetCount();
			if (count > 0 && count2 > 0)
			{
				lifeRecordCollection.AddIntrudePrisonCancelSupportMakeEnemyTaiwu(id, currDate, settlementId);
			}
			else if (count > 0)
			{
				lifeRecordCollection.AddIntrudePrisonMakeEnemyOthersTaiwu(id, currDate, settlementId);
			}
			else if (count2 > 0)
			{
				lifeRecordCollection.AddIntrudePrisonCancelSupportTaiwu(id, currDate, settlementId);
			}
		}
		SettlementPrisonRecordCollection settlementPrisonRecordCollection = DomainManager.Extra.GetSettlementPrisonRecordCollection(mainThreadDataContext, settlementId);
		settlementPrisonRecordCollection.AddIntrudePrison(currDate, settlementId, id);
		DomainManager.Extra.SetSettlementPrisonRecordCollection(mainThreadDataContext, settlementId, settlementPrisonRecordCollection);
	}

	public static short CalcInteractPrisonNeedApprovingRate(int charId, short settlementId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var _))
		{
			return 0;
		}
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		if (!(settlement is Sect sect))
		{
			return 0;
		}
		SettlementPrisoner prisoner = sect.Prison.GetPrisoner(charId);
		int num = (int)MathF.Max(prisoner.Duration - (GetGameDate() - prisoner.KidnapBeginDate), 0f);
		return (short)((float)(prisoner.PunishmentSeverity * 200) * ((float)num * 1f / (float)prisoner.Duration));
	}

	public static short CalcAskForPrisonerNeedApprovingRate(int charId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return 0;
		}
		return (short)((element.GetOrganizationInfo().Grade + 1) * 50);
	}

	public static bool TaiwuCanAskForThisPrisoner(int charId, short settlementId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return false;
		}
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		if (!(settlement is Sect sect))
		{
			return false;
		}
		SettlementPrisoner prisoner = sect.Prison.GetPrisoner(charId);
		sbyte grade = element.GetOrganizationInfo().Grade;
		sbyte xiangshuLevel = DomainManager.World.GetXiangshuLevel();
		if (prisoner.PunishmentSeverity == 1)
		{
			return grade <= xiangshuLevel;
		}
		if (prisoner.PunishmentSeverity == 2)
		{
			return grade <= xiangshuLevel - 1;
		}
		if (prisoner.PunishmentSeverity == 3)
		{
			return grade <= xiangshuLevel - 2;
		}
		return grade <= xiangshuLevel - 3;
	}

	public static short CalcTiawuSendToPrisonNeedApprovingRate(int duration, int prisonerId, short settlementId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(prisonerId);
		int num = ((element_Objects.GetOrganizationInfo().SettlementId == settlementId) ? 300 : 150);
		sbyte b = DurationToPunishmentSeverityLevel(duration);
		return (short)(b * num);
	}

	public static void CancelApprovingRate(EventArgBox argBox)
	{
		IntList intList = argBox.Get<IntList>("SelectApprovedTaiwu");
		if (intList.Items == null)
		{
			return;
		}
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		foreach (int item in intList.Items)
		{
			if (DomainManager.Organization.TryGetSettlementCharacter(item, out var settlementChar))
			{
				settlementChar.SetApprovedTaiwu(mainThreadDataContext, approve: false);
			}
		}
	}

	public static void InteractPrisonPleaseEffect(int charId, short settlementId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return;
		}
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		sbyte orgTemplateId = settlement.GetOrgTemplateId();
		if (settlement is Sect sect)
		{
			DataContext mainThreadDataContext = Domain.MainThreadDataContext;
			GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
			SettlementPrisoner prisoner = sect.Prison.GetPrisoner(charId);
			sbyte grade = element.GetOrganizationInfo().Grade;
			ProfessionFormulaItem formulaCfg = ProfessionFormula.Instance[59];
			int baseDelta = formulaCfg.Calculate(prisoner.PunishmentSeverity, grade);
			DomainManager.Extra.ChangeProfessionSeniority(mainThreadDataContext, 8, baseDelta);
			sect.RemovePrisoner(mainThreadDataContext, charId);
			LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
			lifeRecordCollection.AddRequestTheReleaseOfTheCriminalTaiwu(taiwu.GetId(), GetGameDate(), charId, settlementId);
			OrganizationInfo organizationInfo = element.GetOrganizationInfo();
			if (organizationInfo.OrgTemplateId == 0)
			{
				OrganizationMemberItem orgMemberConfig = OrganizationDomain.GetOrgMemberConfig(orgTemplateId, organizationInfo.Grade);
				sbyte rejoinGrade = orgMemberConfig.GetRejoinGrade();
				OrganizationInfo destOrgInfo = new OrganizationInfo(orgTemplateId, rejoinGrade, principal: true, settlementId);
				DomainManager.Organization.ChangeOrganization(mainThreadDataContext, element, destOrgInfo);
			}
			SettlementPrisonRecordCollection settlementPrisonRecordCollection = DomainManager.Extra.GetSettlementPrisonRecordCollection(mainThreadDataContext, settlementId);
			settlementPrisonRecordCollection.AddPrisonBail(GetGameDate(), settlementId, taiwu.GetId(), charId);
			DomainManager.Extra.SetSettlementPrisonRecordCollection(mainThreadDataContext, settlementId, settlementPrisonRecordCollection);
		}
	}

	public static void InteractPrisonKidnapInfectedEffect(int charId, short settlementId)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
			if (settlement is Sect sect)
			{
				DataContext mainThreadDataContext = Domain.MainThreadDataContext;
				sect.RemovePrisoner(mainThreadDataContext, charId);
				GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
				DomainManager.Extra.AddStoneRoomCharacter(mainThreadDataContext, element);
				LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
				lifeRecordCollection.AddImprisonedXiangshuInfectedTaiwu(taiwu.GetId(), GetGameDate(), charId, settlementId);
				SettlementPrisonRecordCollection settlementPrisonRecordCollection = DomainManager.Extra.GetSettlementPrisonRecordCollection(mainThreadDataContext, settlementId);
				settlementPrisonRecordCollection.AddSendingToPrisonTaiwu(GetGameDate(), settlementId, taiwu.GetId(), charId);
				DomainManager.Extra.SetSettlementPrisonRecordCollection(mainThreadDataContext, settlementId, settlementPrisonRecordCollection);
			}
		}
	}

	public static void InteractPrisonKidnapEffect(int charId, short settlementId, ItemKey ropeItemKey)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var _))
		{
			Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
			if (settlement is Sect sect)
			{
				DataContext mainThreadDataContext = Domain.MainThreadDataContext;
				sect.RemovePrisoner(mainThreadDataContext, charId);
				GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
				AddPrisonerToCharacter(charId, taiwu.GetId(), ropeItemKey);
				LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
				lifeRecordCollection.AddSentToPrisonTaiwu(taiwu.GetId(), GetGameDate(), charId, settlementId);
				SettlementPrisonRecordCollection settlementPrisonRecordCollection = DomainManager.Extra.GetSettlementPrisonRecordCollection(mainThreadDataContext, settlementId);
				settlementPrisonRecordCollection.AddSendingToPrisonTaiwu(GetGameDate(), settlementId, taiwu.GetId(), charId);
				DomainManager.Extra.SetSettlementPrisonRecordCollection(mainThreadDataContext, settlementId, settlementPrisonRecordCollection);
			}
		}
	}

	public static void InteractPrisonRescueEffect(short settlementId, int prisonerId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		SettlementPrisonEventEffect instance = SettlementPrisonEventEffect.Instance;
		int guardCombatLevel = GetGuardCombatLevel();
		if (1 == 0)
		{
		}
		short index = guardCombatLevel switch
		{
			1 => 5, 
			2 => 6, 
			_ => 7, 
		};
		if (1 == 0)
		{
		}
		SettlementPrisonEventEffectItem effectCfg = instance[index];
		(CharacterSet, CharacterSet, CharacterSet, CharacterSet) tuple = DomainManager.Organization.ApplySettlementPrisonEventEffect(mainThreadDataContext, effectCfg, settlementId);
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int id = taiwu.GetId();
		foreach (int item in tuple.Item1.GetCollection())
		{
			bool flag = tuple.Item2.Contains(item);
			bool flag2 = tuple.Item4.Contains(item);
			if (flag && flag2)
			{
				lifeRecordCollection.AddPrisonBreakIntrudePrisonCancelSupportMakeEnemyNpc(item, currDate, id, prisonerId, settlementId);
			}
			else if (flag)
			{
				lifeRecordCollection.AddPrisonBreakIntrudePrisonMakeEnemyOthersNpc(item, currDate, id, prisonerId, settlementId);
			}
			else if (flag2)
			{
				lifeRecordCollection.AddPrisonBreakIntrudePrisonCancelSupportNpc(item, currDate, id, prisonerId, settlementId);
			}
		}
		if (tuple.Item1.GetCount() != 0)
		{
			int count = tuple.Item2.GetCount();
			int count2 = tuple.Item4.GetCount();
			if (count > 0 && count2 > 0)
			{
				lifeRecordCollection.AddPrisonBreakIntrudePrisonCancelSupportMakeEnemyTaiwu(id, currDate, prisonerId, settlementId);
			}
			else if (count > 0)
			{
				lifeRecordCollection.AddPrisonBreakIntrudePrisonMakeEnemyOthersTaiwu(id, currDate, prisonerId, settlementId);
			}
			else if (count2 > 0)
			{
				lifeRecordCollection.AddPrisonBreakIntrudePrisonCancelSupportTaiwu(id, currDate, prisonerId, settlementId);
			}
		}
		SettlementPrisonRecordCollection settlementPrisonRecordCollection = DomainManager.Extra.GetSettlementPrisonRecordCollection(mainThreadDataContext, settlementId);
		settlementPrisonRecordCollection.AddPrisonRobbery(currDate, settlementId, id, prisonerId);
		DomainManager.Extra.SetSettlementPrisonRecordCollection(mainThreadDataContext, settlementId, settlementPrisonRecordCollection);
	}

	public static sbyte GetFugitiveBountySect(GameData.Domains.Character.Character character)
	{
		Tester.Assert(character.GetId() != DomainManager.Taiwu.GetTaiwuCharId());
		return DomainManager.Organization.GetFugitiveBountySect(character.GetId());
	}

	public static void SetArrestSettlementInfo(EventArgBox argBox, GameData.Domains.Character.Character character)
	{
		Tester.Assert(character.GetId() != DomainManager.Taiwu.GetTaiwuCharId());
		sbyte fugitiveBountySect = GetFugitiveBountySect(character);
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(fugitiveBountySect);
		argBox.Set("SettlementId", settlementByOrgTemplateId.GetId());
	}

	public static bool AskForPrisonerVisible(GameData.Domains.Character.Character character)
	{
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		if (organizationInfo.SettlementId < 0)
		{
			return false;
		}
		Settlement settlement = DomainManager.Organization.GetSettlement(organizationInfo.SettlementId);
		if (!(settlement is Sect sect))
		{
			return false;
		}
		if (DomainManager.Character.TryGetKidnappedCharacters(character.GetId(), out var list))
		{
			foreach (KidnappedCharacter item in list.GetCollection())
			{
				Tester.Assert(item.CharId != DomainManager.Taiwu.GetTaiwuCharId());
				sbyte fugitiveBountySect = DomainManager.Organization.GetFugitiveBountySect(item.CharId);
				if (fugitiveBountySect >= 0)
				{
					SettlementBounty bounty = sect.Prison.GetBounty(item.CharId);
					if (bounty.CurrentHunterId == character.GetId())
					{
						return true;
					}
				}
			}
		}
		return false;
	}

	public static void AskForPrisonerRelease(int hunterId, int prisonerId, EventArgBox argBox)
	{
		short arg = -1;
		argBox.Get("SettlementId", ref arg);
		RemovePrisonerFromCharacter(prisonerId, hunterId, isEscaped: false);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(hunterId);
		GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(prisonerId);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		SettlementPrisonEventEffectItem settlementPrisonEventEffectItem = SettlementPrisonEventEffect.Instance[(short)14];
		ChangeFavorabilityOptional(element_Objects, taiwu, (short)settlementPrisonEventEffectItem.ChangeFavorCaptor, 3);
		ChangeFavorabilityOptional(element_Objects2, taiwu, (short)settlementPrisonEventEffectItem.ChangeFavorTeammate, 3);
		LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
		lifeRecordCollection.AddVictoryInCombatHandOverTheCriminalTaiwu(taiwu.GetId(), GetGameDate(), hunterId, prisonerId, arg);
	}

	public static void AskForPrisonerKidnap(int hunterId, int prisonerId, EventArgBox argBox)
	{
		short arg = -1;
		argBox.Get("SettlementId", ref arg);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(hunterId);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		RemovePrisonerFromCharacter(prisonerId, hunterId, isEscaped: false);
		Settlement settlement = DomainManager.Organization.GetSettlement(arg);
		if (settlement is Sect sect)
		{
			SettlementBounty bounty = sect.Prison.GetBounty(prisonerId);
			short prisonRopeTemplateId = sect.GetPrisonRopeTemplateId(bounty.PunishmentSeverity);
			ItemKey itemKey = CreateItem(12, prisonRopeTemplateId);
			AddItemToRole(taiwu, itemKey, 1, -1);
			AddPrisonerToCharacter(prisonerId, taiwu.GetId(), itemKey);
			SettlementPrisonEventEffectItem settlementPrisonEventEffectItem = SettlementPrisonEventEffect.Instance[(short)15];
			ChangeFavorabilityOptional(element_Objects, taiwu, (short)settlementPrisonEventEffectItem.ChangeFavorCaptor, 3);
			LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
			lifeRecordCollection.AddVictoryInCombatHandOverTheCriminalTaiwu(taiwu.GetId(), GetGameDate(), hunterId, prisonerId, arg);
		}
	}

	public static void AskForPrisonerLose(int hunterId, int prisonerId, EventArgBox argBox)
	{
		short arg = -1;
		argBox.Get("SettlementId", ref arg);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
		lifeRecordCollection.AddFailureInCombatHandOverTheCriminalTaiwu(taiwu.GetId(), GetGameDate(), hunterId, prisonerId, arg);
	}

	public static void AskForPrisonerSetBountyInfo(int hunterId, int prisonerId, EventArgBox argBox)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(hunterId);
		GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(prisonerId);
		Settlement settlement = DomainManager.Organization.GetSettlement(element_Objects.GetOrganizationInfo().SettlementId);
		if (settlement is Sect sect)
		{
			int arg = sect.CalcBountyAmount(element_Objects2.GetInteractionGrade());
			argBox.Set("BountyCount", arg);
		}
	}

	public static void AskForPrisonerBribeRelease(int hunterId, int prisonerId, EventArgBox argBox)
	{
		short arg = -1;
		argBox.Get("SettlementId", ref arg);
		RemovePrisonerFromCharacter(prisonerId, hunterId, isEscaped: false);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(prisonerId);
		GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(hunterId);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		SettlementPrisonEventEffectItem settlementPrisonEventEffectItem = SettlementPrisonEventEffect.Instance[(short)13];
		ChangeFavorabilityOptional(element_Objects, taiwu, (short)settlementPrisonEventEffectItem.ChangeFavorTeammate, 3);
		OrganizationInfo organizationInfo = element_Objects2.GetOrganizationInfo();
		int arg2 = 0;
		argBox.Get("BountyCount", ref arg2);
		LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
		if (Config.Organization.Instance[organizationInfo.OrgTemplateId].Goodness == 0)
		{
			lifeRecordCollection.AddBuyHandOverTheCriminalTaiwuByExp(taiwu.GetId(), GetGameDate(), hunterId, prisonerId, arg, arg2);
			return;
		}
		sbyte resourceType = 6;
		if (Config.Organization.Instance[organizationInfo.OrgTemplateId].Goodness == 1)
		{
			resourceType = 7;
		}
		lifeRecordCollection.AddBuyHandOverTheCriminalTaiwu(taiwu.GetId(), GetGameDate(), hunterId, prisonerId, arg, resourceType, arg2);
	}

	public static void AskForPrisonerBribeKidnap(int hunterId, int prisonerId, EventArgBox argBox)
	{
		short arg = -1;
		argBox.Get("SettlementId", ref arg);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(hunterId);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		RemovePrisonerFromCharacter(prisonerId, hunterId, isEscaped: false);
		Settlement settlement = DomainManager.Organization.GetSettlement(arg);
		if (!(settlement is Sect sect))
		{
			return;
		}
		SettlementBounty bounty = sect.Prison.GetBounty(prisonerId);
		short prisonRopeTemplateId = sect.GetPrisonRopeTemplateId(bounty.PunishmentSeverity);
		ItemKey itemKey = CreateItem(12, prisonRopeTemplateId);
		AddItemToRole(taiwu, itemKey, 1, -1);
		AddPrisonerToCharacter(prisonerId, taiwu.GetId(), itemKey);
		OrganizationInfo organizationInfo = element_Objects.GetOrganizationInfo();
		int arg2 = 0;
		argBox.Get("BountyCount", ref arg2);
		LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
		if (Config.Organization.Instance[organizationInfo.OrgTemplateId].Goodness == 0)
		{
			lifeRecordCollection.AddBuyHandOverTheCriminalTaiwuByExp(taiwu.GetId(), GetGameDate(), hunterId, prisonerId, arg, arg2);
			return;
		}
		sbyte resourceType = 6;
		if (Config.Organization.Instance[organizationInfo.OrgTemplateId].Goodness == 1)
		{
			resourceType = 7;
		}
		lifeRecordCollection.AddBuyHandOverTheCriminalTaiwu(taiwu.GetId(), GetGameDate(), hunterId, prisonerId, arg, resourceType, arg2);
	}

	public static void AskForPrisonerLifeSkillCombatRelease(int hunterId, int prisonerId, EventArgBox argBox)
	{
		short arg = -1;
		argBox.Get("SettlementId", ref arg);
		RemovePrisonerFromCharacter(prisonerId, hunterId, isEscaped: false);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(prisonerId);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		SettlementPrisonEventEffectItem settlementPrisonEventEffectItem = SettlementPrisonEventEffect.Instance[(short)13];
		ChangeFavorabilityOptional(element_Objects, taiwu, (short)settlementPrisonEventEffectItem.ChangeFavorTeammate, 3);
		LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
		lifeRecordCollection.AddLifeSkillBattleHandOverTheCriminalTaiwu(taiwu.GetId(), GetGameDate(), hunterId, prisonerId, arg);
	}

	public static void AskForPrisonerLifeSkillCombatKidnap(int hunterId, int prisonerId, EventArgBox argBox)
	{
		short arg = -1;
		argBox.Get("SettlementId", ref arg);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		RemovePrisonerFromCharacter(prisonerId, hunterId, isEscaped: false);
		Settlement settlement = DomainManager.Organization.GetSettlement(arg);
		if (settlement is Sect sect)
		{
			SettlementBounty bounty = sect.Prison.GetBounty(prisonerId);
			short prisonRopeTemplateId = sect.GetPrisonRopeTemplateId(bounty.PunishmentSeverity);
			ItemKey itemKey = CreateItem(12, prisonRopeTemplateId);
			AddItemToRole(taiwu, itemKey, 1, -1);
			AddPrisonerToCharacter(prisonerId, taiwu.GetId(), itemKey);
			LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
			lifeRecordCollection.AddLifeSkillBattleHandOverTheCriminalTaiwu(taiwu.GetId(), GetGameDate(), hunterId, prisonerId, arg);
		}
	}

	public static void RemovePrisoner(GameData.Domains.Character.Character character, short settlementId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		if (settlement is Sect sect)
		{
			sect.RemovePrisoner(mainThreadDataContext, character.GetId());
			LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
			lifeRecordCollection.AddBeReleasedUponCompletionOfASentence(character.GetId(), GetGameDate(), settlementId);
			SettlementPrisonRecordCollection settlementPrisonRecordCollection = DomainManager.Extra.GetSettlementPrisonRecordCollection(mainThreadDataContext, settlementId);
			settlementPrisonRecordCollection.AddBeReleasedUponCompletionOfASentence(GetGameDate(), settlementId, character.GetId());
		}
	}

	public static void ArrestPrisonAgreeEffect(int teammateId, int hunterId, EventArgBox argBox)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(hunterId);
		ItemKey itemKey = CreateItem(12, 73);
		AddItemToRole(element_Objects, itemKey, 1, -1);
		AddPrisonerToCharacter(teammateId, hunterId, itemKey);
		CharacterEscapeToNearbyBlock(argBox, element_Objects, 1);
		short arg = -1;
		argBox.Get("SettlementId", ref arg);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
		lifeRecordCollection.AddReceiveCriminalsTaiwu(taiwu.GetId(), GetGameDate(), teammateId, hunterId, arg);
		lifeRecordCollection.AddReceiveCriminalsCaptor(hunterId, GetGameDate(), teammateId, taiwu.GetId(), arg);
		lifeRecordCollection.AddReceiveCriminalsCriminal(teammateId, GetGameDate(), taiwu.GetId(), hunterId, arg);
		GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(teammateId);
		SettlementPrisonEventEffectItem settlementPrisonEventEffectItem = SettlementPrisonEventEffect.Instance[(short)10];
		ChangeFavorabilityOptional(element_Objects2, taiwu, (short)settlementPrisonEventEffectItem.ChangeFavorTeammate, 3);
	}

	public static void ArrestPrisonLoseEffect(int teammateId, int hunterId, EventArgBox argBox)
	{
		short arg = -1;
		argBox.Get("SettlementId", ref arg);
		Settlement settlement = DomainManager.Organization.GetSettlement(arg);
		if (settlement is Sect sect)
		{
			SettlementBounty bounty = sect.Prison.GetBounty(teammateId);
			short prisonRopeTemplateId = sect.GetPrisonRopeTemplateId(bounty.PunishmentSeverity);
			ItemKey itemKey = CreateItem(12, prisonRopeTemplateId);
			GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(hunterId);
			AddItemToRole(element_Objects, itemKey, 1, -1);
			AddPrisonerToCharacter(teammateId, hunterId, itemKey);
			CharacterEscapeToNearbyBlock(argBox, element_Objects, 1);
			GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
			LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
			lifeRecordCollection.AddResistArresEngageInBattleTaiwu(taiwu.GetId(), GetGameDate(), hunterId, teammateId, taiwu.GetLocation(), arg);
			lifeRecordCollection.AddArrestedSuccessfullyCaptor(hunterId, GetGameDate(), teammateId, taiwu.GetLocation(), arg, 889);
			GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(teammateId);
			SettlementPrisonEventEffectItem settlementPrisonEventEffectItem = SettlementPrisonEventEffect.Instance[(short)9];
			ChangeFavorabilityOptional(element_Objects2, taiwu, (short)settlementPrisonEventEffectItem.ChangeFavorTeammate, 3);
		}
	}

	public static void ArrestPrisonWinEffect(int teammateId, int hunterId, EventArgBox argBox)
	{
		short arg = -1;
		argBox.Get("SettlementId", ref arg);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(hunterId);
		Settlement settlement = DomainManager.Organization.GetSettlement(arg);
		MoveIntelligentCharacter(element_Objects, settlement.GetLocation());
		if (!(settlement is Sect sect))
		{
			return;
		}
		sect.RemoveBounty(Domain.MainThreadDataContext, teammateId);
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		SettlementPrisonEventEffectItem effectCfg = SettlementPrisonEventEffect.Instance[(short)8];
		(CharacterSet, CharacterSet, CharacterSet, CharacterSet) tuple = DomainManager.Organization.ApplySettlementPrisonEventEffect(mainThreadDataContext, effectCfg, arg);
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int id = taiwu.GetId();
		foreach (int item in tuple.Item1.GetCollection())
		{
			bool flag = tuple.Item2.Contains(item);
			bool flag2 = tuple.Item4.Contains(item);
			if (flag && flag2)
			{
				lifeRecordCollection.AddResistArrestIntrudePrisonCancelSupportMakeEnemyNpc(item, currDate, id, teammateId, arg);
			}
			else if (flag)
			{
				lifeRecordCollection.AddResistArresPrisonBreakIntrudePrisonMakeEnemyOthersNpc(item, currDate, id, teammateId, arg);
			}
			else if (flag2)
			{
				lifeRecordCollection.AddResistArresPrisonBreakIntrudePrisonCancelSupportNpc(item, currDate, id, teammateId, arg);
			}
		}
		if (tuple.Item1.GetCount() != 0)
		{
			int count = tuple.Item2.GetCount();
			int count2 = tuple.Item4.GetCount();
			if (count > 0 && count2 > 0)
			{
				lifeRecordCollection.AddResistArresPrisonBreakIntrudePrisonCancelSupportMakeEnemyTaiwu(id, currDate, teammateId, arg);
			}
			else if (count > 0)
			{
				lifeRecordCollection.AddResistArresPrisonBreakIntrudePrisonMakeEnemyOthersTaiwu(id, currDate, teammateId, arg);
			}
			else if (count2 > 0)
			{
				lifeRecordCollection.AddResistArresPrisonBreakIntrudePrisonCancelSupportTaiwu(id, currDate, teammateId, arg);
			}
		}
		LifeRecordCollection lifeRecordCollection2 = GetLifeRecordCollection();
		lifeRecordCollection2.AddResistArresEngageInBattleTaiwu(taiwu.GetId(), GetGameDate(), hunterId, teammateId, taiwu.GetLocation(), arg);
		lifeRecordCollection2.AddArrestFailedCaptor(hunterId, GetGameDate(), teammateId, taiwu.GetLocation(), arg, 886);
		GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(teammateId);
		SettlementPrisonEventEffectItem settlementPrisonEventEffectItem = SettlementPrisonEventEffect.Instance[(short)8];
		ChangeFavorabilityOptional(element_Objects2, taiwu, (short)settlementPrisonEventEffectItem.ChangeFavorTeammate, 3);
	}

	public static bool TaiwuWantedInteracted(int charId)
	{
		return DomainManager.Extra.TaiwuWantedInteracted(charId);
	}

	private static bool CanTriggerTaiwuWantedInteraction(int charId, EventArgBox argBox)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			if (element.GetOrganizationInfo().OrgTemplateId == 16)
			{
				return false;
			}
			sbyte characterSettlementStateSectTemplateId = GetCharacterSettlementStateSectTemplateId(charId);
			if (characterSettlementStateSectTemplateId < 0)
			{
				return false;
			}
			short settlementIdByOrgTemplateId = DomainManager.Organization.GetSettlementIdByOrgTemplateId(characterSettlementStateSectTemplateId);
			argBox.Set("SettlementId", settlementIdByOrgTemplateId);
			return IsTaiwuSectFugitive(settlementIdByOrgTemplateId);
		}
		return false;
	}

	private static bool CanTriggerHuntFugitiveInteraction(GameData.Domains.Character.Character character)
	{
		if (DomainManager.Character.TryGetCharacterPrioritizedAction(character.GetId(), out var action) && action is HuntFugitiveAction huntFugitiveAction)
		{
			if (!huntFugitiveAction.CheckValid(character))
			{
				return false;
			}
			return huntFugitiveAction.Target.TargetCharId == DomainManager.Taiwu.GetTaiwuCharId();
		}
		return false;
	}

	public static void TaiwuWantedAddInteracted(int charId)
	{
		DomainManager.Extra.TaiwuWantedAddInteracted(Domain.MainThreadDataContext, charId);
	}

	private static void TaiwuWantedWinEffect(int hunterId, EventArgBox argBox, bool addLifeRecord)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int id = taiwu.GetId();
		short arg = -1;
		argBox.Get("SettlementId", ref arg);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(hunterId);
		Settlement settlement = DomainManager.Organization.GetSettlement(arg);
		MoveIntelligentCharacter(element_Objects, settlement.GetLocation());
		if (!(settlement is Sect sect))
		{
			return;
		}
		sect.RemoveBounty(Domain.MainThreadDataContext, id);
		if (!addLifeRecord)
		{
			return;
		}
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		SettlementPrisonEventEffectItem settlementPrisonEventEffectItem = SettlementPrisonEventEffect.Instance[(short)16];
		(CharacterSet, CharacterSet, CharacterSet, CharacterSet) tuple = DomainManager.Organization.ApplySettlementPrisonEventEffect(mainThreadDataContext, settlementPrisonEventEffectItem, arg);
		ChangeFavorabilityOptional(element_Objects, taiwu, (short)settlementPrisonEventEffectItem.ChangeFavorCaptor, 3);
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		foreach (int item in tuple.Item1.GetCollection())
		{
			bool flag = tuple.Item2.Contains(item);
			bool flag2 = tuple.Item4.Contains(item);
			if (flag && flag2)
			{
				lifeRecordCollection.AddResistArrestIntrudePrisonCancelSupportMakeEnemyNpcGuard(item, currDate, id, arg);
			}
			else if (flag)
			{
				lifeRecordCollection.AddResistArresPrisonBreakIntrudePrisonMakeEnemyOthersNpcGuard(item, currDate, id, arg);
			}
			else if (flag2)
			{
				lifeRecordCollection.AddResistArresPrisonBreakIntrudePrisonCancelSupportNpcGuard(item, currDate, id, arg);
			}
		}
		if (tuple.Item1.GetCount() != 0)
		{
			int count = tuple.Item2.GetCount();
			int count2 = tuple.Item4.GetCount();
			if (count > 0 && count2 > 0)
			{
				lifeRecordCollection.AddResistArresPrisonBreakIntrudePrisonCancelSupportMakeEnemyTaiwuWanted(id, currDate, arg);
			}
			else if (count > 0)
			{
				lifeRecordCollection.AddResistArresPrisonBreakIntrudePrisonCancelSupportTaiwuWanted(id, currDate, arg);
			}
			else if (count2 > 0)
			{
				lifeRecordCollection.AddResistArresPrisonBreakIntrudePrisonMakeEnemyOthersTaiwuWanted(id, currDate, arg);
			}
		}
	}

	public static void TaiwuWantedFightWinEffect(int hunterId, EventArgBox argBox)
	{
		short arg = -1;
		argBox.Get("SettlementId", ref arg);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		TaiwuWantedWinEffect(hunterId, argBox, addLifeRecord: true);
		LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
		lifeRecordCollection.AddArrestFailedCaptor(hunterId, GetGameDate(), taiwu.GetId(), taiwu.GetLocation(), arg, 1035);
	}

	public static void TaiwuWantedLifeSkillCombatWinEffect(int hunterId, EventArgBox argBox)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int id = taiwu.GetId();
		TaiwuWantedWinEffect(hunterId, argBox, addLifeRecord: false);
		LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
		lifeRecordCollection.AddLifeSkillBattleWinAndAvoidArrestTaiwu(id, GetGameDate(), hunterId);
	}

	public static void TaiwuWantedBribeEffect(int hunterId, EventArgBox argBox)
	{
		TaiwuWantedWinEffect(hunterId, argBox, addLifeRecord: false);
	}

	public static void TaiwuWantedFightLoseEffect(int hunterId, EventArgBox argBox)
	{
		short arg = -1;
		argBox.Get("SettlementId", ref arg);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
		lifeRecordCollection.AddArrestedSuccessfullyCaptor(hunterId, GetGameDate(), taiwu.GetId(), taiwu.GetLocation(), arg, 1036);
	}

	public static void TaiwuWantedLifeSkillCombatLoseEffect(int hunterId, EventArgBox argBox)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
		lifeRecordCollection.AddLifeSkillBattleLoseAndWasArrestedTaiwu(taiwu.GetId(), GetGameDate(), hunterId);
	}

	public unsafe static void TaiwuWantedSectPunished(EventArgBox argBox, bool confess)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int id = taiwu.GetId();
		short arg = -1;
		argBox.Get("SettlementId", ref arg);
		Settlement settlement = DomainManager.Organization.GetSettlement(arg);
		if (!(settlement is Sect sect))
		{
			return;
		}
		SettlementBounty bounty = sect.Prison.GetBounty(id);
		sect.RemoveBounty(mainThreadDataContext, id);
		sbyte customizedPunishmentSeverityTemplateId = bounty.PunishmentSeverity;
		sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(settlement.GetLocation().AreaId);
		DomainManager.Extra.TryGetCustomizedCityPunishmentSeverity(stateTemplateIdByAreaId, isSect: true, bounty.PunishmentType, ref customizedPunishmentSeverityTemplateId);
		sbyte orgTemplateId = settlement.GetOrgTemplateId();
		PunishmentSeverityItem punishmentSeverityItem = PunishmentSeverity.Instance[customizedPunishmentSeverityTemplateId];
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		int resource = taiwu.GetResource(7);
		int num = punishmentSeverityItem.CommonAuthorityDelta;
		if (confess)
		{
			num /= 2;
		}
		int num2 = resource - num;
		int num3 = punishmentSeverityItem.CommonSpiritualDebtDelta;
		if (confess)
		{
			num3 /= 2;
		}
		int num4 = 0;
		if (num2 >= 0)
		{
			num4 = num;
		}
		else
		{
			num4 = resource;
			num3 -= num2 / 10;
		}
		ChangeRoleResource(taiwu, 7, -num4);
		DomainManager.Extra.ChangeAreaSpiritualDebt(mainThreadDataContext, settlement.GetLocation().AreaId, -num3);
		lifeRecordCollection.AddTaiwuPunishmentTongyong(id, currDate, arg, num4, settlement.GetLocation(), num3 / 10);
		switch (orgTemplateId)
		{
		case 1:
		{
			short shaolinDelta = punishmentSeverityItem.ShaolinDelta;
			HashSet<int> hashSet = new HashSet<int>();
			DomainManager.Character.GetAllRelatedCharIds(id, hashSet);
			foreach (int item in hashSet)
			{
				DomainManager.Character.ChangeFavorabilityTendToZero(mainThreadDataContext, item, id, shaolinDelta);
			}
			lifeRecordCollection.AddTaiwuPunishmentShaolin(id, currDate);
			break;
		}
		case 2:
		{
			sbyte value7 = AddTaiwuPunishmentFeature(orgTemplateId, customizedPunishmentSeverityTemplateId);
			lifeRecordCollection.AddTaiwuPunishmentEmei(id, currDate, value7);
			break;
		}
		case 3:
		{
			taiwu.SetCurrNeili(0, mainThreadDataContext);
			NeiliAllocation baseNeiliAllocation = default(NeiliAllocation);
			baseNeiliAllocation.Initialize();
			taiwu.SetBaseNeiliAllocation(baseNeiliAllocation, mainThreadDataContext);
			sbyte value5 = AddTaiwuPunishmentFeature(orgTemplateId, customizedPunishmentSeverityTemplateId);
			lifeRecordCollection.AddTaiwuPunishmentBaihua(id, currDate, value5);
			break;
		}
		case 4:
		{
			sbyte value4 = AddTaiwuPunishmentFeature(orgTemplateId, customizedPunishmentSeverityTemplateId);
			lifeRecordCollection.AddTaiwuPunishmentWudang(id, currDate, value4);
			break;
		}
		case 5:
		{
			List<int> yuanshanDelta = punishmentSeverityItem.YuanshanDelta;
			taiwu.ChangeHappiness(mainThreadDataContext, yuanshanDelta[0]);
			taiwu.ChangeXiangshuInfection(mainThreadDataContext, yuanshanDelta[1]);
			lifeRecordCollection.AddTaiwuPunishmentYuanshan(id, currDate);
			break;
		}
		case 6:
		{
			sbyte value = AddTaiwuPunishmentFeature(orgTemplateId, customizedPunishmentSeverityTemplateId);
			lifeRecordCollection.AddTaiwuPunishmentShingXiang(id, currDate, value);
			break;
		}
		case 7:
		{
			sbyte value9 = AddTaiwuPunishmentFeature(orgTemplateId, customizedPunishmentSeverityTemplateId);
			lifeRecordCollection.AddTaiwuPunishmentRanShan(id, currDate, value9);
			break;
		}
		case 8:
		{
			sbyte value8 = AddTaiwuPunishmentFeature(orgTemplateId, customizedPunishmentSeverityTemplateId);
			lifeRecordCollection.AddTaiwuPunishmentXuanNv(id, currDate, value8);
			break;
		}
		case 9:
			taiwu.ChangeCurrAge(mainThreadDataContext, punishmentSeverityItem.ZhujianDelta);
			lifeRecordCollection.AddTaiwuPunishmentZhuJian(id, currDate);
			break;
		case 10:
		{
			Span<short> span2 = stackalloc short[6] { 8, 17, 26, 35, 44, 53 };
			int kongsangDelta = punishmentSeverityItem.KongsangDelta;
			for (int l = 0; l < kongsangDelta; l++)
			{
				taiwu.ApplyEatingItemInstantEffects(mainThreadDataContext, 8, span2[mainThreadDataContext.Random.Next(6)]);
			}
			lifeRecordCollection.AddTaiwuPunishmentKongSang(id, currDate, kongsangDelta);
			break;
		}
		case 11:
		{
			sbyte value6 = AddTaiwuPunishmentFeature(orgTemplateId, customizedPunishmentSeverityTemplateId);
			lifeRecordCollection.AddTaiwuPunishmentJinGang(id, currDate, value6);
			break;
		}
		case 12:
		{
			int wuxianDelta = punishmentSeverityItem.WuxianDelta;
			Span<sbyte> span = stackalloc sbyte[8];
			SpanList<sbyte> spanList = span;
			for (int j = 0; j < wuxianDelta; j++)
			{
				sbyte currMaxEatingSlotsCount = taiwu.GetCurrMaxEatingSlotsCount();
				EatingItems eatingItems = taiwu.GetEatingItems();
				if (eatingItems.GetAvailableEatingSlot(currMaxEatingSlotsCount) < 0)
				{
					break;
				}
				spanList.Clear();
				for (sbyte b2 = 0; b2 < 8; b2++)
				{
					spanList.Add(b2);
				}
				for (int k = 0; k < 9; k++)
				{
					ItemKey itemKey = (ItemKey)eatingItems.ItemKeys[k];
					if (EatingItems.IsWug(itemKey))
					{
						spanList.Remove(Config.Medicine.Instance[itemKey.TemplateId].WugType);
					}
				}
				if (spanList.Count == 0)
				{
					break;
				}
				sbyte random = spanList.GetRandom(mainThreadDataContext.Random);
				short wugTemplateId = ItemDomain.GetWugTemplateId(random, 4);
				taiwu.AddWug(mainThreadDataContext, wugTemplateId);
			}
			lifeRecordCollection.AddTaiwuPunishmentWuXian(id, currDate, wuxianDelta);
			break;
		}
		case 13:
		{
			sbyte value3 = AddTaiwuPunishmentFeature(orgTemplateId, customizedPunishmentSeverityTemplateId);
			lifeRecordCollection.AddTaiwuPunishmentJieQing(id, currDate, value3);
			break;
		}
		case 14:
		{
			sbyte value2 = AddTaiwuPunishmentFeature(orgTemplateId, customizedPunishmentSeverityTemplateId);
			lifeRecordCollection.AddTaiwuPunishmentFuLong(id, currDate, value2);
			break;
		}
		case 15:
		{
			int xuehouDelta = punishmentSeverityItem.XuehouDelta;
			Span<sbyte> pArray = stackalloc sbyte[7] { 0, 1, 2, 3, 4, 5, 6 };
			CollectionUtils.Shuffle(mainThreadDataContext.Random, pArray, 7);
			for (int i = 0; i < xuehouDelta; i++)
			{
				sbyte b = pArray[i];
				bool flag = mainThreadDataContext.Random.NextBool();
				short num5 = (flag ? BreakFeatureHelper.BodyPart2HurtFeature[b] : BreakFeatureHelper.BodyPart2CrashFeature[b]);
				taiwu.ChangeInjury(mainThreadDataContext, b, flag, 4);
				if (!taiwu.GetFeatureIds().Contains(num5))
				{
					taiwu.AddFeature(mainThreadDataContext, num5);
					DomainManager.SpecialEffect.Add(mainThreadDataContext, taiwu.GetId(), SpecialEffectDomain.BreakBodyFeatureEffectClassName[num5]);
				}
				taiwu.AddFeature(mainThreadDataContext, num5);
			}
			lifeRecordCollection.AddTaiwuPunishmentXueHou(id, currDate, xuehouDelta);
			break;
		}
		}
	}

	public static sbyte AddTaiwuPunishmentFeature(sbyte orgTemplateId, sbyte severity)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int id = taiwu.GetId();
		List<short> taiwuPunishementFeature = Config.Organization.Instance[orgTemplateId].TaiwuPunishementFeature;
		bool flag = ((orgTemplateId == 2 || orgTemplateId == 7) ? true : false);
		short num = (flag ? taiwuPunishementFeature[0] : taiwuPunishementFeature[severity]);
		sbyte duration = CharacterFeature.Instance[taiwuPunishementFeature[severity]].Duration;
		if (DomainManager.Extra.TryGetTemporaryFeatureExpireDate(id, num, out var date))
		{
			DomainManager.Extra.RegisterCharacterTemporaryFeature(mainThreadDataContext, id, num, date + duration);
		}
		else
		{
			taiwu.AddFeature(mainThreadDataContext, num);
			DomainManager.Extra.RegisterCharacterTemporaryFeature(mainThreadDataContext, id, num, DomainManager.World.GetCurrDate() + duration);
		}
		return duration;
	}

	public static bool TaiwuCanGetTaught(GameData.Domains.Character.Character arg0)
	{
		return DomainManager.Taiwu.IsTaiwuAbleToGetTaught(arg0);
	}

	public static void SetGuardCombat(int level)
	{
		EventArgBox globalEventArgumentBox = DomainManager.TaiwuEvent.GetGlobalEventArgumentBox();
		globalEventArgumentBox.Set("IsGuardCombat", arg: true);
		globalEventArgumentBox.Set("GuardCombatLevel", level);
	}

	public static int GetGuardCombatLevel()
	{
		return DomainManager.TaiwuEvent.GetGlobalEventArgumentBox().GetInt("GuardCombatLevel");
	}

	public static void RemoveGuardCombatLevel()
	{
		DomainManager.TaiwuEvent.GetGlobalEventArgumentBox().Remove<int>("GuardCombatLevel");
	}

	public static int CreateNonIntelligentGuard(Settlement settlement, sbyte gradeOffset, sbyte treasuryLayer = -1)
	{
		return settlement?.CreateNonIntelligentGuard(Domain.MainThreadDataContext, (treasuryLayer < 0) ? ((sbyte)Math.Clamp(GetGuardCombatLevel() - 1, 0, 2)) : treasuryLayer, gradeOffset) ?? (-1);
	}

	public static int CreateNonIntelligentGuard(short settlementId, sbyte gradeOffset, sbyte treasuryLayer = -1)
	{
		return CreateNonIntelligentGuard(DomainManager.Organization.GetSettlement(settlementId), gradeOffset, treasuryLayer);
	}

	public static void StartSelectProfessionItem(string itemNameKey, EventArgBox argBox)
	{
		if (!argBox.Get("SelectItemInfo", out EventSelectItemData arg))
		{
			arg = new EventSelectItemData();
			argBox.Set("SelectItemInfo", (ISerializableGameData)(object)arg);
		}
		SelectItemFilter item = new SelectItemFilter
		{
			Key = itemNameKey,
			DisplayDataFilterId = 0,
			FilterTemplateId = -1
		};
		for (short num = 237; num <= 242; num++)
		{
			ItemDisplayData item2 = new ItemDisplayData(12, num);
			arg.CanSelectItemList.Add(item2);
		}
		for (short num2 = 343; num2 <= 354; num2++)
		{
			ItemDisplayData item3 = new ItemDisplayData(12, num2);
			arg.CanSelectItemList.Add(item3);
		}
		arg.FilterList.Add(item);
	}

	[Obsolete]
	public static bool CheckSeniorityIsSatisfyByGrade(GameData.Domains.Character.Character character)
	{
		sbyte grade = character.GetOrganizationInfo().Grade;
		ProfessionData currentProfessionData = GetCurrentProfessionData();
		if (currentProfessionData == null)
		{
			return false;
		}
		return grade <= currentProfessionData.GetSeniorityOrgGrade();
	}

	public static bool CheckSeniorityIsSatisfyByGradeByProfession(GameData.Domains.Character.Character character, int professionId)
	{
		sbyte grade = character.GetOrganizationInfo().Grade;
		ProfessionData professionData = GetProfessionData(professionId);
		if (professionData == null)
		{
			return false;
		}
		return grade <= professionData.GetSeniorityOrgGrade();
	}

	public static bool CheckFavorabilityIsSatisfy(GameData.Domains.Character.Character character)
	{
		sbyte behaviorType = character.GetBehaviorType();
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		sbyte favorabilityType = GetFavorabilityType(character, taiwu);
		return favorabilityType >= GetProfessionFavorabilityType(behaviorType);
	}

	public static sbyte GetProfessionFavorabilityType(sbyte behaviorType)
	{
		if (behaviorType == 0 || behaviorType == 1)
		{
			return 3;
		}
		switch (behaviorType)
		{
		case 2:
			return 4;
		default:
			if (behaviorType != 4)
			{
				return 3;
			}
			goto case 3;
		case 3:
			return 5;
		}
	}

	public static bool CheckResourceIsEnoughToUseSkill(GameData.Domains.Character.Character character, short templateId)
	{
		if (DomainManager.Extra.NoProfessionSkillCost)
		{
			return true;
		}
		List<ResourceInfo> resourcesCost = ProfessionSkill.Instance[templateId].ResourcesCost;
		for (int i = 0; i < resourcesCost.Count; i++)
		{
			if (!character.CheckResources(Domain.MainThreadDataContext, resourcesCost[i].ResourceType, resourcesCost[i].ResourceCount))
			{
				return false;
			}
		}
		return true;
	}

	public static bool CheckResourceIsEnough(GameData.Domains.Character.Character character, sbyte type, int value)
	{
		return character.CheckResources(Domain.MainThreadDataContext, type, value);
	}

	public static List<(ItemKey, int)> InitialSelectProfession(int professionTemplateId)
	{
		int skillUnlockSeniority = GameData.Domains.Taiwu.Profession.SharedMethods.GetSkillUnlockSeniority(GameData.Domains.Taiwu.Profession.SharedMethods.GetSkillId(professionTemplateId, 1));
		DomainManager.Extra.ChangeProfessionSeniority(Domain.MainThreadDataContext, professionTemplateId, skillUnlockSeniority, withBonus: false);
		List<ItemKey> list = new List<ItemKey>();
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		switch (professionTemplateId)
		{
		case 0:
			list.Add(AddItemToRole(taiwu, 12, 237, 1, -1));
			break;
		case 1:
			list.Add(AddItemToRole(taiwu, 12, 238, 1, -1));
			break;
		case 2:
			list.Add(AddItemToRole(taiwu, 12, 239, 1, -1));
			break;
		case 3:
			list.Add(AddItemToRole(taiwu, 12, 343, 1, -1));
			break;
		case 4:
			list.Add(AddItemToRole(taiwu, 12, 344, 1, -1));
			break;
		case 5:
			list.Add(AddItemToRole(taiwu, 12, 345, 1, -1));
			break;
		case 6:
			list.Add(AddItemToRole(taiwu, 12, 346, 1, -1));
			break;
		case 7:
			list.Add(AddItemToRole(taiwu, 12, 347, 1, -1));
			break;
		case 8:
			list.Add(AddItemToRole(taiwu, 12, 348, 1, -1));
			break;
		case 9:
			list.Add(AddItemToRole(taiwu, 12, 240, 1, -1));
			break;
		case 10:
			list.Add(AddItemToRole(taiwu, 12, 241, 1, -1));
			break;
		case 11:
			list.Add(AddItemToRole(taiwu, 12, 242, 1, -1));
			break;
		case 12:
			list.Add(AddItemToRole(taiwu, 12, 349, 1, -1));
			break;
		case 13:
			list.Add(AddItemToRole(taiwu, 12, 350, 1, -1));
			break;
		case 14:
			list.Add(AddItemToRole(taiwu, 12, 351, 1, -1));
			break;
		case 15:
			list.Add(AddItemToRole(taiwu, 12, 352, 1, -1));
			break;
		case 16:
			list.Add(AddItemToRole(taiwu, 12, 353, 1, -1));
			break;
		case 17:
			list.Add(AddItemToRole(taiwu, 12, 354, 1, -1));
			break;
		}
		return list.ConvertAll((ItemKey e) => (e: e, 1));
	}

	[Obsolete]
	public static ProfessionData GetCurrentProfessionData()
	{
		return DomainManager.Extra.GetCurrentProfessionData();
	}

	public static ProfessionData GetProfessionData(int professionId)
	{
		return DomainManager.Extra.GetProfessionData(professionId);
	}

	public static bool IsProfessionalSkillUnlocked(int skillTemplateId)
	{
		return DomainManager.Extra.IsProfessionalSkillUnlocked(skillTemplateId);
	}

	public static bool IsProfessionalSkillUnlockedAndEquipped(int skillTemplateId)
	{
		return DomainManager.Extra.IsProfessionalSkillUnlockedAndEquipped(skillTemplateId);
	}

	public static void ConfirmSkillExecute(string afterEvent, EventArgBox argBox)
	{
		int num = argBox.GetInt("TemplateId");
		int charId = 0;
		bool isSuccess = false;
		bool isExtraordinary = false;
		bool skipAnimation = false;
		ItemKey itemKey = ItemKey.Invalid;
		bool skipConfirm = false;
		if (argBox.Contains<int>("SelectedCharId"))
		{
			charId = argBox.GetInt("SelectedCharId");
		}
		if (argBox.Contains<bool>("IsSuccess"))
		{
			isSuccess = argBox.GetBool("IsSuccess");
		}
		if (argBox.Contains<bool>("IsExtraordinary"))
		{
			isExtraordinary = argBox.GetBool("IsExtraordinary");
		}
		if (argBox.Contains<bool>("SkipAnimation"))
		{
			skipAnimation = argBox.GetBool("SkipAnimation");
		}
		if (argBox.Contains<ItemKey>("SelectItemKey"))
		{
			itemKey = argBox.Get<ItemKey>("SelectItemKey");
		}
		if (argBox.Contains<bool>("SkipConfirm"))
		{
			skipConfirm = argBox.GetBool("SkipConfirm");
		}
		ProfessionSkillArg professionSkillArg = new ProfessionSkillArg
		{
			ProfessionId = ProfessionSkill.Instance[num].Profession,
			SkillId = num,
			CharId = charId,
			IsSuccess = isSuccess,
			IsExtraordinary = isExtraordinary,
			ItemKey = itemKey,
			SkipConfirm = skipConfirm,
			SkipAnimation = skipAnimation
		};
		ProfessionSkillHandle.ConfirmSkillExecuteWithEvent(professionSkillArg, afterEvent, argBox);
	}

	public static void ConfirmSkillExecuteAndPlayAnim(string afterEvent, EventArgBox argBox)
	{
		int num = argBox.GetInt("TemplateId");
		ProfessionSkillArg arg = new ProfessionSkillArg
		{
			ProfessionId = ProfessionSkill.Instance[num].Profession,
			SkillId = num
		};
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.ConfirmSkillExecuteAndPlayAnim, arg, arg2: true);
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "ConfirmProfessionSkillExecuteAndAnimComplete");
		}
	}

	public static void PlaySkillExecuteAnim(string afterEvent, EventArgBox argBox)
	{
		int num = argBox.GetInt("TemplateId");
		ProfessionSkillArg arg = new ProfessionSkillArg
		{
			ProfessionId = ProfessionSkill.Instance[num].Profession,
			SkillId = num
		};
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.ConfirmSkillExecuteAndPlayAnim, arg, arg2: false);
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "ConfirmProfessionSkillExecuteAndAnimComplete");
		}
	}

	[Obsolete]
	public static void OpenProfessionSkillUnlocked(string afterEvent, EventArgBox argBox)
	{
		int num = argBox.GetInt("TemplateId");
		if (DomainManager.Extra.ProfessionSkillUnlockedCache == null)
		{
			DomainManager.Extra.ProfessionSkillUnlockedCache = new List<int>();
		}
		if (!DomainManager.Extra.ProfessionSkillUnlockedCache.Contains(num))
		{
			DomainManager.Extra.ProfessionSkillUnlockedCache.Add(num);
			GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenProfessionSkillUnlocked, num);
			if (!string.IsNullOrEmpty(afterEvent))
			{
				AddEventInListenWithActionName(afterEvent, argBox, "OpenProfessionSkillUnlocked");
			}
		}
	}

	public static void SetDisableMoving(bool disableMove)
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.SetDisableMoving, disableMove);
	}

	[Obsolete]
	public static sbyte GetSkillExecutedCostTime(int skillIndex)
	{
		ProfessionData currentProfessionData = GetCurrentProfessionData();
		if (currentProfessionData == null)
		{
			return 0;
		}
		ProfessionSkillItem skillConfig = currentProfessionData.GetSkillConfig(skillIndex);
		return (sbyte)skillConfig.TimeCost;
	}

	[Obsolete]
	public static void OnSkillExecutedCostTime(int skillIndex)
	{
		if (!DomainManager.Extra.NoProfessionSkillCost)
		{
			ProfessionData currentProfessionData = GetCurrentProfessionData();
			if (currentProfessionData != null)
			{
				ProfessionSkillItem skillConfig = currentProfessionData.GetSkillConfig(skillIndex);
				DomainManager.World.AdvanceDaysInMonth(Domain.MainThreadDataContext, skillConfig.TimeCost);
			}
		}
	}

	[Obsolete]
	public static void OnSkillExecutedCoolDown(int skillIndex)
	{
		GetCurrentProfessionData()?.OfflineSkillCooldown(skillIndex);
	}

	public static void OnSkillExecutedCoolDown(int professionId, int skillIndex)
	{
		GetProfessionData(professionId)?.OfflineSkillCooldown(skillIndex);
	}

	[Obsolete]
	public static void OnSkillExecutedAddExp(int skillIndex, bool isSuccess = true, bool cached = false)
	{
		ProfessionData currentProfessionData = GetCurrentProfessionData();
		if (currentProfessionData != null)
		{
			ProfessionSkillItem skillConfig = currentProfessionData.GetSkillConfig(skillIndex);
			DomainManager.Extra.ChangeProfessionSeniority(Domain.MainThreadDataContext, currentProfessionData.TemplateId, isSuccess ? skillConfig.Exp : skillConfig.FailExp, withBonus: true, cached);
			DomainManager.TaiwuEvent.CheckTaiwuStatusImmediately();
		}
	}

	[Obsolete]
	public static void OnSkillExecutedAddExpSpecial(int value, bool cached = false)
	{
		ProfessionData currentProfessionData = GetCurrentProfessionData();
		if (currentProfessionData != null)
		{
			DomainManager.Extra.ChangeProfessionSeniority(Domain.MainThreadDataContext, currentProfessionData.TemplateId, value, withBonus: true, cached);
			DomainManager.TaiwuEvent.CheckTaiwuStatusImmediately();
		}
	}

	public static void ChangeProfessionSeniority(short professionTemplateId, int value, bool cached = false)
	{
		DomainManager.Extra.ChangeProfessionSeniority(Domain.MainThreadDataContext, professionTemplateId, value, withBonus: true, cached);
	}

	public static bool TryTriggerAddSeniorityPoint(int formulaTemplateId, int targetId)
	{
		return DomainManager.Extra.TryTriggerAddSeniorityPoint(Domain.MainThreadDataContext, formulaTemplateId, targetId);
	}

	public static bool ProfessionSkillConditionNotSatisfy(int skillTemplateId)
	{
		ProfessionSkillItem professionSkillItem = ProfessionSkill.Instance[skillTemplateId];
		ProfessionItem professionItem = Profession.Instance[professionSkillItem.Profession];
		ProfessionData professionData = DomainManager.Extra.GetProfessionData(professionItem.TemplateId);
		if (professionData == null)
		{
			return false;
		}
		int skillIndex = ((professionItem.ExtraProfessionSkill == skillTemplateId) ? professionItem.ProfessionSkills.Length : professionItem.ProfessionSkills.IndexOf(skillTemplateId));
		if (professionData.IsSkillCooldown(DomainManager.World.GetCurrDate(), skillIndex))
		{
			return false;
		}
		if (!DomainManager.Extra.NoProfessionSkillCost)
		{
			GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
			ResourceInts resources = taiwu.GetResources();
			foreach (ResourceInfo item in professionSkillItem.ResourcesCost)
			{
				if (!resources.CheckIsMeet(item.ResourceType, item.ResourceCount))
				{
					return false;
				}
			}
		}
		return true;
	}

	public static bool ProfessionSkillSeniorityNotSatisfy(int skillTemplateId)
	{
		ProfessionSkillItem professionSkillItem = ProfessionSkill.Instance[skillTemplateId];
		ProfessionItem professionItem = Profession.Instance[professionSkillItem.Profession];
		ProfessionData professionData = DomainManager.Extra.GetProfessionData(professionItem.TemplateId);
		if (professionData == null)
		{
			return false;
		}
		return professionData.Seniority >= GameData.Domains.Taiwu.Profession.SharedMethods.GetSkillUnlockSeniority(skillTemplateId);
	}

	[Obsolete]
	public static int GetCurrentProfessionSeniority()
	{
		ProfessionData currentProfessionData = GetCurrentProfessionData();
		return currentProfessionData.Seniority;
	}

	public static int ProfessionSkillSeniorityNeed(int skillTemplateId)
	{
		ProfessionSkillItem professionSkillItem = ProfessionSkill.Instance[skillTemplateId];
		ProfessionItem professionItem = Profession.Instance[professionSkillItem.Profession];
		ProfessionData professionData = DomainManager.Extra.GetProfessionData(professionItem.TemplateId);
		if (professionData == null)
		{
			return -1;
		}
		return GameData.Domains.Taiwu.Profession.SharedMethods.GetSkillUnlockSeniority(skillTemplateId);
	}

	public static void SetOneShotEventHandled(int oneShotEventType)
	{
		DomainManager.Extra.SetOneShotEventHandled(Domain.MainThreadDataContext, oneShotEventType);
	}

	public static bool IsOneShotEventHandled(int oneShotEventType)
	{
		return DomainManager.Extra.IsOneShotEventHandled(oneShotEventType);
	}

	public static void SetCharacterDisplayName(int charId, string displayName)
	{
		DomainManager.Extra.AssignCharacterCustomDisplayName(Domain.MainThreadDataContext, charId, displayName);
	}

	[Obsolete]
	public static void ExecuteLiteratiSkill2(sbyte lifeSkillType)
	{
	}

	public static int GetAuthorityByRenameNpc(GameData.Domains.Character.Character character, bool isGood)
	{
		ProfessionData professionData = GetProfessionData(4);
		if (professionData == null)
		{
			return 0;
		}
		sbyte grade = character.GetOrganizationInfo().Grade;
		return (grade + 1) * (50 + 100 * professionData.Seniority / 3000000);
	}

	public static string OpenMerchantShop(sbyte merchantType)
	{
		ProfessionData professionData = GetProfessionData(15);
		sbyte seniorityCaravanGrade = professionData.GetSeniorityCaravanGrade();
		DomainManager.Merchant.StartTempCaravanAction(merchantType, seniorityCaravanGrade, refresh: true, ignoreWorldProgress: false, ignoreFavorability: false, isOpenedByProfessionSkill: true);
		return Config.MerchantType.Instance[merchantType].Name;
	}

	public static void StartMerchantShopAction(string onCompleteEventId = "", EventArgBox argBox = null)
	{
		Domain.SetListenerWithActionName(onCompleteEventId, argBox, "MerchantShopClose");
	}

	public static int GetTradeItemMaxGrade()
	{
		return 8;
	}

	public static bool CheckFavoribility(int characterId, sbyte targetLevel)
	{
		short favorability = DomainManager.Character.GetFavorability(characterId, DomainManager.Taiwu.GetTaiwuCharId());
		sbyte favorabilityType = FavorabilityType.GetFavorabilityType(favorability);
		return favorabilityType >= targetLevel;
	}

	public static int GetTradeItemValue(ItemKey itemKey, int amount)
	{
		ProfessionData professionData = GetProfessionData(15);
		int seniorityTradeCostFactor = professionData.GetSeniorityTradeCostFactor();
		int value = DomainManager.Item.GetValue(itemKey);
		return amount * value * seniorityTradeCostFactor / 100;
	}

	public static bool MakeTrade(int charId, ItemKey itemKey, int amount, EventArgBox argBox)
	{
		DataContext mainThreadDataContext = DomainManager.TaiwuEvent.MainThreadDataContext;
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int resource = DomainManager.Taiwu.GetTaiwu().GetResource(6);
		int tradeItemValue = GetTradeItemValue(itemKey, amount);
		argBox?.Set("ConchShip_PresetKey_TradeItemPrice", tradeItemValue);
		if (resource < tradeItemValue)
		{
			return false;
		}
		ChangeRoleResource(element_Objects, 6, tradeItemValue);
		RemoveInventoryOrEquipItem(element_Objects, itemKey, amount, deleteItem: false);
		ChangeRoleResource(taiwu, 6, -tradeItemValue);
		taiwu.AddInventoryItem(mainThreadDataContext, itemKey, amount);
		int num = -DomainManager.Item.GetBaseItem(itemKey).GetHappinessChange();
		ChangeFavorabilityOptional(element_Objects, taiwu, (short)num, 3);
		int currDate = DomainManager.World.GetCurrDate();
		Location location = taiwu.GetLocation();
		DomainManager.LifeRecord.GetLifeRecordCollection().AddForcefulPurchase(taiwu.GetId(), currDate, charId, location, tradeItemValue, itemKey.ItemType, itemKey.TemplateId);
		int value = DomainManager.Item.GetValue(itemKey);
		int baseDelta = ProfessionFormulaImpl.Calculate(97, value);
		DomainManager.Extra.ChangeProfessionSeniority(mainThreadDataContext, 15, baseDelta);
		return true;
	}

	[Obsolete]
	public static int GetMerchantItem(out string merchantName, out Inventory resultInventory, EventArgBox argBox)
	{
		resultInventory = new Inventory();
		DataContext mainThreadDataContext = DomainManager.TaiwuEvent.MainThreadDataContext;
		merchantName = null;
		List<int> taiwuLocationMaxLevelCaravanIdList = DomainManager.Merchant.GetTaiwuLocationMaxLevelCaravanIdList();
		if (taiwuLocationMaxLevelCaravanIdList == null || taiwuLocationMaxLevelCaravanIdList.Count == 0)
		{
			argBox.Set("ConchShip_PresetKey_CaravanCount", 0);
			argBox.Set("ConchShip_PresetKey_CaravanIndex", 0);
			argBox.Set("ConchShip_PresetKey_CaravanPresentCount", 0);
			return 0;
		}
		int num = argBox.GetInt("ConchShip_PresetKey_CaravanPresentCount");
		int num2 = argBox.GetInt("ConchShip_PresetKey_CaravanIndex");
		int num3 = taiwuLocationMaxLevelCaravanIdList[num2];
		argBox.Set("CaravanId", num3);
		MerchantData caravanMerchantData = DomainManager.Merchant.GetCaravanMerchantData(Domain.MainThreadDataContext, num3);
		merchantName = Config.MerchantType.Instance[caravanMerchantData.MerchantType].Name;
		sbyte xiangshuLevel = GameData.Domains.World.SharedMethods.GetXiangshuLevel(DomainManager.World.GetXiangshuProgress());
		short val = GlobalConfig.Instance.MerchantFavorabilityUpperLimits[xiangshuLevel];
		int num4 = 0;
		short num5 = Math.Min(caravanMerchantData.MerchantConfig.Level, val);
		int num6 = num5;
		int num7 = 0;
		for (int i = 0; i <= num6; i++)
		{
			Inventory goodsList = caravanMerchantData.GetGoodsList(num6);
			num7 += goodsList.Items.Sum((KeyValuePair<ItemKey, int> p) => p.Value);
		}
		while (num4 < 3 && num6 >= 0)
		{
			Inventory goodsList2 = caravanMerchantData.GetGoodsList(num6--);
			while (num4 < 3 && goodsList2.InventoryItemTotalCount > 0)
			{
				int num8 = 0;
				int num9 = mainThreadDataContext.Random.Next(100);
				num8 = ((num9 >= 15) ? ((num9 < 50) ? 1 : 2) : 0);
				Dictionary<sbyte, Dictionary<ItemKey, int>> dictionary = (from p in goodsList2.Items
					group p by ItemTemplateHelper.GetGrade(p.Key.ItemType, p.Key.TemplateId)).ToDictionary((IGrouping<sbyte, KeyValuePair<ItemKey, int>> p) => p.Key, (IGrouping<sbyte, KeyValuePair<ItemKey, int>> p) => p.ToDictionary((KeyValuePair<ItemKey, int> keyValuePair) => keyValuePair.Key, (KeyValuePair<ItemKey, int> keyValuePair) => keyValuePair.Value));
				sbyte b = dictionary.Keys.Max();
				sbyte min = dictionary.Keys.Min();
				sbyte value = Convert.ToSByte(b - num8);
				value = Math.Clamp(value, min, b);
				if (dictionary.TryGetValue(value, out var value2))
				{
					ItemKey key = value2.ElementAt(mainThreadDataContext.Random.Next(0, value2.Count)).Key;
					resultInventory.OfflineAdd(key, 1);
					goodsList2.OfflineRemove(key, 1);
					DomainManager.Item.RemoveOwner(key, ItemOwnerType.Caravan, num3);
					DomainManager.Taiwu.AddItem(mainThreadDataContext, key, 1, ItemSourceType.Inventory);
					DomainManager.Merchant.SetCaravanData(num3, caravanMerchantData, mainThreadDataContext);
					num4++;
				}
			}
		}
		argBox.Set("ConchShip_PresetKey_CaravanPresentCount", num + num7);
		argBox.Set("ConchShip_PresetKey_CaravanIndex", num2 + 1);
		argBox.Set("ConchShip_PresetKey_CaravanCount", taiwuLocationMaxLevelCaravanIdList.Count);
		num = argBox.GetInt("ConchShip_PresetKey_CaravanPresentCount");
		num2 = argBox.GetInt("ConchShip_PresetKey_CaravanIndex");
		if (num2 == taiwuLocationMaxLevelCaravanIdList.Count && num > 0)
		{
			OnSkillExecutedCostTime(2);
		}
		return num7;
	}

	public static bool IsCricketSmart(int cricketId)
	{
		return DomainManager.Extra.IsCricketSmart(cricketId);
	}

	public static CricketData GetCricketData(int itemId)
	{
		return DomainManager.Item.GetCricketData(itemId);
	}

	public static bool IsCricketGreat(ItemKey itemKey)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		ItemDisplayData inventoryItemDisplayData = DomainManager.Character.GetInventoryItemDisplayData(taiwu.GetId(), itemKey);
		sbyte cricketGrade = ItemTemplateHelper.GetCricketGrade(inventoryItemDisplayData.CricketColorId, inventoryItemDisplayData.CricketPartId);
		return cricketGrade == 7 || cricketGrade == 8;
	}

	public static bool IsCricketReachSmartCondition(int itemId)
	{
		CricketData cricketData = GetCricketData(itemId);
		ProfessionData professionData = GetProfessionData(17);
		int num = 10;
		return (float)(cricketData[5] - cricketData[6]) >= (float)num - MathF.Ceiling((float)(professionData.GetSeniorityPercent() * 7) / 100f);
	}

	public static bool IsCricketIdentified(int cricketId)
	{
		return DomainManager.Extra.IsCricketIdentified(cricketId);
	}

	public static bool CanIdentifyCricket(int cricketId)
	{
		return DomainManager.Extra.CanIdentifyCricket(cricketId);
	}

	public static void SetCricketIdentified(int cricketId)
	{
		ProfessionFormulaItem formulaCfg = ProfessionFormula.Instance[108];
		ChangeProfessionSeniority(17, formulaCfg.Calculate());
		DomainManager.Extra.SetCricketIdentified(Domain.MainThreadDataContext, cricketId);
	}

	public static bool CanUpgradeCricket(int cricketId)
	{
		return DomainManager.Extra.CanUpgradeCricket(cricketId);
	}

	public static ItemKey UpgradeCricket(int charId, int cricketId)
	{
		ProfessionFormulaItem formulaCfg = ProfessionFormula.Instance[109];
		ChangeProfessionSeniority(17, formulaCfg.Calculate());
		return DomainManager.Extra.UpgradeCricket(Domain.MainThreadDataContext, charId, cricketId);
	}

	public static void OpenExtraordinaryCricketView(ItemKey itemKey)
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenExtraordinaryCricket, itemKey);
	}

	public static string GetCricketDesc(ItemKey itemKey)
	{
		ItemDisplayData itemDisplayData = DomainManager.Item.GetItemDisplayData(itemKey);
		CricketPartsItem cricketPartsItem = null;
		cricketPartsItem = ((ItemTemplateHelper.GetGrade(itemKey.ItemType, itemKey.TemplateId) < 7) ? CricketParts.Instance[itemDisplayData.CricketPartId] : CricketParts.Instance[itemDisplayData.CricketPartId + itemDisplayData.CricketColorId]);
		return cricketPartsItem.Desc;
	}

	public static bool DukeSkill_CheckCharacterHasTitle(int charId)
	{
		ProfessionData professionData = GetProfessionData(17);
		if (professionData == null)
		{
			return false;
		}
		return ProfessionSkillHandle.DukeSkill_CheckCharacterHasTitle(charId, professionData);
	}

	public static short DukeSkill_GetTitleFromOwner(int charId)
	{
		ProfessionData professionData = GetProfessionData(17);
		if (professionData == null)
		{
			return -1;
		}
		return ProfessionSkillHandle.DukeSkill_GetTitleFromOwner(charId, professionData);
	}

	public static int DukeSkill_GetOwnerOfTitle(short templateId)
	{
		ProfessionData professionData = GetProfessionData(17);
		if (professionData == null)
		{
			return -1;
		}
		return ProfessionSkillHandle.DukeSkill_GetOwnerOfTitle(templateId, professionData);
	}

	public static void DukeSkill_AddCharacterTitle(int charId, short templateId)
	{
		ProfessionData professionData = GetProfessionData(17);
		if (professionData != null)
		{
			ProfessionSkillHandle.DukeSkill_AddCharacterTitle(Domain.MainThreadDataContext, professionData, charId, templateId);
		}
	}

	public static void DukeSkill_RemoveCharacterTitle(int charId)
	{
		ProfessionData professionData = GetProfessionData(17);
		if (professionData != null)
		{
			ProfessionSkillHandle.DukeSkill_RemoveCharacterTitle(Domain.MainThreadDataContext, professionData, charId);
		}
	}

	public static int GetDukeSkillBecomeEnemyProb(sbyte behaviorType)
	{
		return ProfessionRelatedConstants.BehaviorTypeBecomeEnemyProb[behaviorType];
	}

	public static sbyte GetDukeSkill2ItemGrade(GameData.Domains.Character.Character character)
	{
		sbyte behaviorType = character.GetBehaviorType();
		int num = ProfessionRelatedConstants.BehaviorTypeScore[behaviorType];
		num += FavorabilityType.GetFavorabilityType(DomainManager.Character.GetFavorability(character.GetId(), DomainManager.Taiwu.GetTaiwuCharId()));
		if (num < 0)
		{
			if (CheckProbability(5))
			{
				return 6;
			}
			if (CheckProbability(25))
			{
				return 5;
			}
			if (CheckProbability(30))
			{
				return 4;
			}
			return 3;
		}
		if (num < 4)
		{
			if (CheckProbability(5))
			{
				return 7;
			}
			if (CheckProbability(25))
			{
				return 6;
			}
			if (CheckProbability(30))
			{
				return 5;
			}
			return 4;
		}
		if (CheckProbability(5))
		{
			return 8;
		}
		if (CheckProbability(25))
		{
			return 7;
		}
		if (CheckProbability(30))
		{
			return 6;
		}
		return 5;
	}

	public static sbyte GetDukeSkill2ItemGrade(Location location)
	{
		MapAreaItem config = DomainManager.Map.GetElement_Areas(location.AreaId).GetConfig();
		sbyte sectID = MapState.Instance[config.StateID].SectID;
		short sectApprovingRate = GetSectApprovingRate(sectID);
		int random = GetRandom(0, 75);
		if (sectApprovingRate <= 300)
		{
			if (random < 5)
			{
				return 6;
			}
			if (random < 15)
			{
				return 5;
			}
			if (random < 35)
			{
				return 4;
			}
			return 3;
		}
		if (sectApprovingRate <= 600)
		{
			if (random < 5)
			{
				return 7;
			}
			if (random < 15)
			{
				return 6;
			}
			if (random < 35)
			{
				return 5;
			}
			return 4;
		}
		if (random < 5)
		{
			return 8;
		}
		if (random < 15)
		{
			return 7;
		}
		if (random < 35)
		{
			return 6;
		}
		return 5;
	}

	public static sbyte GetDukeSkill2WestItemGrade(GameData.Domains.Character.Character character)
	{
		sbyte favorabilityType = FavorabilityType.GetFavorabilityType(DomainManager.Character.GetFavorability(character.GetId(), DomainManager.Taiwu.GetTaiwuCharId()));
		List<sbyte> list = ObjectPool<List<sbyte>>.Instance.Get();
		list.Clear();
		if (favorabilityType == 6)
		{
			list.Add(6);
			list.Add(7);
			list.Add(8);
		}
		else
		{
			list.Add(5);
			list.Add(6);
			list.Add(7);
		}
		sbyte result = list[GetRandom(0, list.Count)];
		ObjectPool<List<sbyte>>.Instance.Return(list);
		return result;
	}

	public static ItemKey DukeSkill_GetNewCricket(GameData.Domains.Character.Character character)
	{
		ProfessionData professionData = GetProfessionData(17);
		if (professionData == null)
		{
			return ItemKey.Invalid;
		}
		return ProfessionSkillHandle.DukeSkill_GetNewCricket(Domain.MainThreadDataContext, character.GetId());
	}

	public static GameData.Domains.Character.Character GetNotGiveCricketCharacter()
	{
		ProfessionData professionData = GetProfessionData(17);
		if (professionData == null)
		{
			return null;
		}
		DukeSkillsData dukeSkillsData = (DukeSkillsData)professionData.SkillsData;
		if (DomainManager.Character.TryGetElement_Objects(dukeSkillsData.GetNotGiveCricketCharId(DomainManager.Character.IsCharacterAlive), out var element))
		{
			return element;
		}
		return null;
	}

	public static void SetCharacterCricketGivenData(int charId, bool isGiven)
	{
		ProfessionData professionData = GetProfessionData(17);
		if (professionData != null)
		{
			DukeSkillsData dukeSkillsData = (DukeSkillsData)professionData.SkillsData;
			dukeSkillsData.SetCharacterCricketGivenData(charId, isGiven);
			DomainManager.Extra.SetProfessionData(Domain.MainThreadDataContext, professionData);
		}
	}

	public static int GetDukeNotGiveCricketCount()
	{
		ProfessionData professionData = DomainManager.Extra.GetProfessionData(17);
		if (professionData == null)
		{
			return 0;
		}
		DukeSkillsData dukeSkillsData = (DukeSkillsData)professionData.SkillsData;
		return dukeSkillsData.GetNotGivenCricketTitles(DomainManager.Character.IsCharacterAlive).Count();
	}

	public static bool HandleDukeGiveCricket(EventArgBox argBox)
	{
		ProfessionData professionData = DomainManager.Extra.GetProfessionData(17);
		if (professionData == null)
		{
			return false;
		}
		DukeSkillsData dukeSkillsData = (DukeSkillsData)professionData.SkillsData;
		GameData.Domains.Character.Character notGiveCricketCharacter = GetNotGiveCricketCharacter();
		if (notGiveCricketCharacter == null)
		{
			return false;
		}
		ItemKey itemKey = DukeSkill_GetNewCricket(notGiveCricketCharacter);
		if (!itemKey.IsValid())
		{
			return false;
		}
		short titleFromOwner = dukeSkillsData.GetTitleFromOwner(notGiveCricketCharacter.GetId());
		argBox.Set("CharacterTitleTemplateId", titleFromOwner);
		argBox.Set("CharacterId", notGiveCricketCharacter.GetId());
		argBox.Set("Cricket", (ISerializableGameData)(object)itemKey);
		SetCharacterCricketGivenData(notGiveCricketCharacter.GetId(), isGiven: true);
		if (argBox.Get<IntList>("CricketIdList", out IntList arg))
		{
			arg.Items.Add(itemKey.Id);
		}
		else
		{
			IntList intList = IntList.Create();
			intList.Items.Add(itemKey.Id);
			argBox.Set("CricketIdList", (ISerializableGameData)(object)intList);
		}
		return true;
	}

	public static void HandleDukeGiveCricketShow(EventArgBox argBox)
	{
		if (argBox.Get<IntList>("CricketIdList", out IntList arg))
		{
			List<(ItemKey, int)> list = new List<(ItemKey, int)>();
			for (int i = 0; i < arg.Items.Count; i++)
			{
				int id = arg.Items[i];
				ItemKey itemKey = DomainManager.Item.GetBaseItem(new ItemKey(11, 0, 0, id)).GetItemKey();
				list.Add((itemKey, 1));
			}
			ShowGetItemPageForItems(list, "", argBox);
		}
	}

	public static bool TravelingBuddhistMonkSkill_CanVisitTemple(Location location)
	{
		return ProfessionSkillHandle.TravelingBuddhistMonkSkill_CanVisitTemple(location);
	}

	public static void TravelingBuddhistMonkSkill_CreateTemples()
	{
		ProfessionSkillHandle.TravelingBuddhistMonkSkill_CreateTemples(Domain.MainThreadDataContext);
	}

	public static List<string> TravelingBuddhistMonkSkill_GetTempleNames()
	{
		return ProfessionSkillHandle.TravelingBuddhistMonkSkill_GetTempleNames();
	}

	public static void TravelingBuddhistMonkSkill3_SetFeature(short featureId)
	{
		ProfessionSkillHandle.TravelingBuddhistMonkSkill3_SetFeature(Domain.MainThreadDataContext, featureId);
	}

	public static void TravelingBuddhistMonkSkill_SetTempleVisited(Location location)
	{
		ProfessionSkillHandle.TravelingBuddhistMonkSkill_SetTempleVisited(Domain.MainThreadDataContext, location);
	}

	public static int GetVisitedTempleCount()
	{
		ProfessionData professionData = DomainManager.Extra.GetProfessionData(12);
		if (professionData == null)
		{
			return 0;
		}
		TravelingBuddhistMonkSkillsData skillsData = professionData.GetSkillsData<TravelingBuddhistMonkSkillsData>();
		return skillsData.GetVisitedTempleCount();
	}

	public static sbyte GetSkillGradeByTempleCount()
	{
		return ProfessionRelatedConstants.TempleCountToSkillGrade[GetVisitedTempleCount()];
	}

	public static ItemKey GetCombatSkillBookAndRead(short combatSkillTemplateId)
	{
		return DomainManager.Taiwu.GetCombatSkillBookAndRead(Domain.MainThreadDataContext, combatSkillTemplateId, 50);
	}

	public static ItemKey GetLifeSkillBookAndRead(short lifeSkillTemplateId)
	{
		return DomainManager.Taiwu.GetLifeSkillBookAndRead(Domain.MainThreadDataContext, lifeSkillTemplateId, 50);
	}

	public static string GetTemplateDesc(Location location)
	{
		MapAreaItem config = DomainManager.Map.GetElement_Areas(location.AreaId).GetConfig();
		return config.TempleDesc;
	}

	public static int GetAuthorityByGarde(GameData.Domains.Character.Character character)
	{
		sbyte grade = character.GetOrganizationInfo().Grade;
		return (grade + 1) * (grade + 1) * 30;
	}

	public static void OpenTravelingTaoistMonkSkill2(int characterId, string afterEvent, EventArgBox argBox)
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenTravelingTaoistMonkSkill2, characterId);
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		int badFeatureCount = GetBadFeatureCount(character);
		argBox.Set("preCount", badFeatureCount);
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "TravelingTaoistMonkSkill2Executed");
		}
	}

	public static int GetBadFeatureCount(GameData.Domains.Character.Character character)
	{
		List<short> featureIds = character.GetFeatureIds();
		int num = 0;
		for (int i = 0; i < featureIds.Count; i++)
		{
			if (CharacterFeature.Instance[featureIds[i]].Level < 0)
			{
				num++;
			}
		}
		return num;
	}

	public static void AddLuckEventPrediction(int charId, bool isPositive, bool isAvoided)
	{
		DomainManager.Character.AddLuckEventPrediction(charId, isPositive, isAvoided);
	}

	public static bool IsBuddhist(GameData.Domains.Character.Character character)
	{
		return character.IsMonkType(2);
	}

	public static int TonsureAuthorityGet(GameData.Domains.Character.Character character)
	{
		sbyte grade = character.GetOrganizationInfo().Grade;
		return (grade + 1) * (grade + 1) * 30;
	}

	public static void AddSavedSoul(int charId)
	{
		DomainManager.Extra.AddSavedSoul(Domain.MainThreadDataContext, charId);
	}

	public static int GetSavedSoulCount()
	{
		ProfessionData professionData = DomainManager.Extra.GetProfessionData(6);
		if (professionData == null)
		{
			return 0;
		}
		BuddhistMonkSkillsData skillsData = professionData.GetSkillsData<BuddhistMonkSkillsData>();
		return skillsData.GetSavedSoulsCount();
	}

	public static int GetTravelingTaoistMonkSkill1ExpCost(GameData.Domains.Character.Character character)
	{
		return ProfessionSkillHandle.TravelingTaoistMonkSkill1_ExpCost(character);
	}

	public static List<GameData.Domains.Character.Character> SelectFemale(short stateId)
	{
		List<GameData.Domains.Character.Character> list = new List<GameData.Domains.Character.Character>();
		FindCharacters(DomainManager.Character.CanSelectForForcePregnancy, list, 0, 135);
		return list;
	}

	public static void BuddhistMonkSkill_SelectDirectedSamsara(int motherId, int reincarnatedCharId)
	{
		ProfessionSkillHandle.BuddhistMonkSkill_SelectDirectedSamsara(Domain.MainThreadDataContext, motherId, reincarnatedCharId);
	}

	public static void BuddhistMonkSkill3_SelectFeatureFromEvent(int reincarnatedCharId, short featureId)
	{
		ProfessionSkillHandle.BuddhistMonkSkill_SetSamsaraFeature(Domain.MainThreadDataContext, reincarnatedCharId, featureId);
	}

	public static void BuddhistMonkSkill3_Execute(string afterEvent, EventArgBox argBox)
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenProfessionSkillSpecial, 22);
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "ConfirmProfessionSkillExecuteAndAnimComplete");
		}
	}

	public static void BecomeBuddhistMonk(GameData.Domains.Character.Character character)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		character.BecomeMonkType(mainThreadDataContext, 2);
		AvatarData avatar = character.GetAvatar();
		avatar.ResetGrowableElementShowingAbility(0);
		character.SetAvatar(avatar, mainThreadDataContext);
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		if (RelationTypeHelper.AllowAddingMentorRelation(character.GetId(), taiwuCharId))
		{
			int currDate = DomainManager.World.GetCurrDate();
			DomainManager.Character.AddRelation(Domain.MainThreadDataContext, character.GetId(), taiwuCharId, 2048, currDate);
		}
	}

	public static bool BuddhistMonkSkill3_CheckCanSelectFeature(short featureId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		sbyte fameType = taiwu.GetFameType();
		if ((fameType == -2 || fameType == 3) ? true : false)
		{
			return true;
		}
		if (FameType.IsNonNegative(fameType))
		{
			return featureId >= 605 && featureId < 610;
		}
		return featureId >= 610 && featureId < 615;
	}

	public static void BuddhistMonkSkill2_Execute(EventArgBox argBox)
	{
		if (!argBox.Get<CharacterSet>("SelectedCharId", out CharacterSet arg))
		{
			return;
		}
		int num = 0;
		foreach (int item in arg.GetCollection())
		{
			if (IsAvailableCharacterId(item))
			{
				AddSavedSoul(item);
				num++;
			}
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		LifeRecordCollection lifeRecordCollection = GetLifeRecordCollection();
		int gameDate = GetGameDate();
		Location location = taiwu.GetLocation();
		lifeRecordCollection.AddExpiateDeadSouls(taiwu.GetId(), gameDate, location);
		DomainManager.World.GetInstantNotificationCollection().AddReleaseSouls(num);
	}

	public static void TaoistMonkSkill3ConfirmTribulationSucceed()
	{
		ProfessionData professionData = GetProfessionData(5);
		ProfessionSkillHandle.TaoistMonkSkill_ConfirmTribulationSucceed(Domain.MainThreadDataContext, professionData);
	}

	public static string TaoistMonkSkill4GetDisasterEventGuid()
	{
		List<short> featureIds = DomainManager.Taiwu.GetTaiwu().GetFeatureIds();
		string result = "5fb4a4e7-2403-4294-9778-3ba706889a8c";
		if (featureIds.Contains(629))
		{
			result = "5f6a1b69-9393-4847-8455-cd10a034486a";
		}
		else if (featureIds.Contains(628))
		{
			result = "09298851-161c-48e3-a785-d892ca1d5b6c";
		}
		else if (featureIds.Contains(627))
		{
			result = "e2fdc895-2c9a-4274-893a-0c918244a866";
		}
		return result;
	}

	public static int TaoistMonkSkill3GetAuthority(sbyte grade)
	{
		ProfessionData professionData = GetProfessionData(5);
		return professionData.GetTaoistMonkSkill3AuthorityPara() * (grade + 1) * (grade + 1);
	}

	public static bool CheckTaoistMonkSkill3TribulationSucceed()
	{
		return ProfessionSkillHandle.TaoistMonkSkill_CheckTribulationSucceed();
	}

	public static void SetCharacterPerformCompletelyInfected(GameData.Domains.Character.Character character, EventArgBox argBox)
	{
		if (character == null)
		{
			throw new Exception("null character passed in to SetCharacterPerformCompletelyInfected");
		}
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		argBox.Set("InfectedValueBefore", character.GetXiangshuInfection());
		character.ChangeXiangshuInfection(mainThreadDataContext, 200);
		CharacterFeatureItem item = CharacterFeature.Instance.GetItem(218);
		short groupFeature = character.GetGroupFeature(item.MutexGroupId);
		if (groupFeature >= 0)
		{
			argBox.Set("FeatureIdBefore", groupFeature);
		}
		character.AddFeature(mainThreadDataContext, item.TemplateId, removeMutexFeature: true);
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		argBox.Set("OrgInfoBefore", (ISerializableGameData)(object)organizationInfo);
		OrganizationInfo organizationInfo2 = new OrganizationInfo(20, organizationInfo.Grade, principal: true, -1);
		character.SetOrganizationInfo(organizationInfo2, mainThreadDataContext);
		if (CharacterIsInTaiwuGroup(character.GetId()))
		{
			RequestRoleLeaveGroup(character.GetId());
			argBox.Set("NeedJoinGroup", arg: true);
		}
	}

	public static void RollBackCharacterFromPerformCompletelyInfected(GameData.Domains.Character.Character character, EventArgBox argBox)
	{
		if (character == null)
		{
			throw new Exception("null character passed in to RollBackCharacterFromPerformCompletelyInfected");
		}
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		character.SetXiangshuInfection(argBox.GetByte("InfectedValueBefore"), mainThreadDataContext);
		character.RemoveFeature(mainThreadDataContext, 218);
		short arg = -1;
		if (argBox.Get("FeatureIdBefore", ref arg))
		{
			character.AddFeature(mainThreadDataContext, arg, removeMutexFeature: true);
		}
		character.SetOrganizationInfo(argBox.Get<OrganizationInfo>("OrgInfoBefore"), mainThreadDataContext);
		if (argBox.GetBool("NeedJoinGroup"))
		{
			DomainManager.Taiwu.JoinGroup(Domain.MainThreadDataContext, character.GetId());
		}
	}

	public static short GetMartialArtistHereticTemplateIds(sbyte consummateLevel)
	{
		int num = (int)MathF.Abs(consummateLevel - 1) / 2;
		return ProfessionRelatedConstants.MartialArtistHereticTemplateIds[num];
	}

	public static int GetAuthorityByBeatHeretic()
	{
		return GetCurrentProfessionData()?.GetSeniorityAuthorityGain() ?? 0;
	}

	public static int GetSafetyByBeatHeretic()
	{
		return GetProfessionData(3)?.GetSenioritySafetyGain() ?? 0;
	}

	public static int GetCultureByBeatHeretic()
	{
		return GetProfessionData(3)?.GetSeniorityCultureGain() ?? 0;
	}

	public static void ExecuteMartialArtistSkill2(sbyte combatSkillType)
	{
		ProfessionData currentProfessionData = GetCurrentProfessionData();
		ProfessionSkillHandle.MartialArtistSkill_MakeAreaLearnCombatSkill(Domain.MainThreadDataContext, currentProfessionData, combatSkillType);
	}

	[Obsolete]
	private static bool MartialArtistSkill0Useful(OrganizationItem orgCfg)
	{
		return DomainManager.Extra.MartialArtistSkill0Useful(orgCfg);
	}

	public static void MartialArtistSkill3Execute()
	{
		DomainManager.Extra.MartialArtistSkill3Execute(Domain.MainThreadDataContext, updateData: true);
	}

	public static int GetInfluencePowerBonusFactor()
	{
		return GetProfessionData(8)?.GetInfluencePowerBonusFactor() ?? 0;
	}

	public static void AristocratSkill_ChangeInfluencePower(int charId, bool isAdd)
	{
		ProfessionSkillHandle.AristocratSkill_ChangeInfluencePower(Domain.MainThreadDataContext, charId, isAdd);
	}

	public static sbyte GetGrowingGradeBySeniority()
	{
		return GetProfessionData(8)?.GetSeniorityGrowingGrade(Domain.MainThreadDataContext.Random) ?? 0;
	}

	public static int GetFeatureUpgradeCount()
	{
		return GetProfessionData(8)?.GetSeniorityFeatureUpgradeCount(Domain.MainThreadDataContext.Random) ?? 0;
	}

	public static void RecreateLifeSkillQualifications(int charId, sbyte growingOrgTemplateId, sbyte growingGrade)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			element.RecreateLifeSkillQualifications(Domain.MainThreadDataContext, growingOrgTemplateId, growingGrade);
			DomainManager.World.GetInstantNotificationCollection().AddComradeLifeSkillUpNew1(charId, growingGrade);
		}
	}

	public static void RecreateCombatSkillQualifications(int charId, sbyte growingOrgTemplateId, sbyte growingGrade)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			element.RecreateCombatSkillQualifications(Domain.MainThreadDataContext, growingOrgTemplateId, growingGrade);
			DomainManager.World.GetInstantNotificationCollection().AddComradeCombatSkillUpNew1(charId, growingGrade);
		}
	}

	public static void RecreateMainAttributes(int charId, sbyte growingOrgTemplateId, sbyte growingGrade)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			element.RecreateMainAttributes(Domain.MainThreadDataContext, growingOrgTemplateId, growingGrade);
			DomainManager.World.GetInstantNotificationCollection().AddComradePropertyUpNew1(charId, growingGrade);
		}
	}

	public static void RecreateFeatures(int charId, int upgradeCount, sbyte featureMedalType)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			element.RecreateFeaturesByUpgradeCount(Domain.MainThreadDataContext, upgradeCount, featureMedalType);
			DomainManager.World.GetInstantNotificationCollection().AddComradeFeatureUp(charId);
		}
	}

	public static bool IsCharacterAbleToBeRecommended(int charId)
	{
		ProfessionData professionData = DomainManager.Extra.GetProfessionData(8);
		AristocratSkillsData skillsData = professionData.GetSkillsData<AristocratSkillsData>();
		return !skillsData.IsCharacterRecommended(charId);
	}

	public static int BeggarGetNpcMoney(Location location, bool isTransferMoney = false)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int num = ProfessionSkillHandle.BeggarSkill_GetLocationBeggingMoney(mainThreadDataContext, location, isTransferMoney);
		if (isTransferMoney)
		{
			taiwu.ChangeResource(mainThreadDataContext, 6, num);
			int baseDelta = ProfessionFormulaImpl.Calculate(60, num);
			DomainManager.Extra.ChangeProfessionSeniority(mainThreadDataContext, 9, baseDelta);
		}
		return num;
	}

	public static string BeggarSkill_LookingForCharacter()
	{
		return ProfessionSkillHandle.BeggarSkill_LookingForCharacter();
	}

	public static void BeggarSkill_ClearLookingForCharacter()
	{
		ProfessionSkillHandle.BeggarSkill_ClearLookingForCharacter(Domain.MainThreadDataContext);
	}

	public static void BeggarSkill_AddLookingForCharacter(string name)
	{
		ProfessionSkillHandle.BeggarSkill_AddLookingForCharacter(Domain.MainThreadDataContext, name);
	}

	public static bool BeggarSkill_FoundMoreAlive()
	{
		return ProfessionSkillHandle.BeggarSkill_FoundMoreAlive();
	}

	public static bool BeggarSkill_FoundMoreDead()
	{
		return ProfessionSkillHandle.BeggarSkill_FoundMoreDead();
	}

	public static bool CheckNameIsTaiwuOrGroup(string name)
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		foreach (int item in DomainManager.Taiwu.GetGroupCharIds().GetCollection())
		{
			GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(item);
			string monasticTitleOrDisplayName = GetMonasticTitleOrDisplayName(element_Objects, item == taiwuCharId);
			if (monasticTitleOrDisplayName.Equals(name))
			{
				return true;
			}
		}
		return false;
	}

	public static string GetMonasticTitleOrDisplayName(GameData.Domains.Character.Character character, bool isTaiwu)
	{
		NameRelatedData data = new NameRelatedData();
		CharacterDomain.GetNameRelatedData(character, ref data);
		var (text, text2) = data.GetMonasticTitleOrDisplayName(isTaiwu);
		return text + text2;
	}

	public static bool GetBeggarSkill1LeaveResult(GameData.Domains.Character.Character character)
	{
		ProfessionData professionData = GetProfessionData(9);
		if (professionData == null)
		{
			return false;
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		sbyte favorabilityType = FavorabilityType.GetFavorabilityType(DomainManager.Character.GetFavorability(character.GetId(), taiwu.GetId()));
		int num = ProfessionRelatedConstants.BeggarSkill2BehaviorTypeFactors[character.GetBehaviorType()];
		num += favorabilityType * 5 + professionData.GetSeniorityPercent() / 2;
		return CheckProbability(num);
	}

	public static void MakeCharacterMoveRandom(GameData.Domains.Character.Character character, int step)
	{
		if (character.GetId() == DomainManager.Taiwu.GetTaiwuCharId())
		{
			throw new Exception("character can not is taiwu");
		}
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		Location location = character.GetLocation();
		DomainManager.Map.GetNeighborBlocks(location.AreaId, location.BlockId, list, step);
		if (list.Count != 0)
		{
			MapBlockData mapBlockData = list[mainThreadDataContext.Random.Next(list.Count)];
			DomainManager.Character.GroupMove(mainThreadDataContext, character, mapBlockData.GetLocation());
			ObjectPool<List<MapBlockData>>.Instance.Return(list);
		}
	}

	public static int GetTasterSeniority(ItemKey itemKey)
	{
		TeaWineItem teaWineItem = Config.TeaWine.Instance[itemKey.TemplateId];
		return (teaWineItem.Grade + 1) * 10;
	}

	public static short GetDisorderOfQi(ItemKey itemKey, GameData.Domains.Character.Character character)
	{
		if (itemKey.ItemType != 9)
		{
			throw new Exception($"Invalid item type: {itemKey.ItemType}");
		}
		TeaWineItem teaWineItem = Config.TeaWine.Instance[itemKey.TemplateId];
		short recoveryOfQiDisorder = character.GetRecoveryOfQiDisorder();
		return (short)(Math.Abs(teaWineItem.DirectChangeOfQiDisorder) * (100 - recoveryOfQiDisorder / 20) / 100);
	}

	public static void AddEatingItemTogether(GameData.Domains.Character.Character taiwu, GameData.Domains.Character.Character other, ItemKey itemKey)
	{
		Tester.Assert(taiwu.GetId() == DomainManager.Taiwu.GetTaiwuCharId());
		Tester.Assert(itemKey.ItemType == 9);
		short itemSubType = ItemTemplateHelper.GetItemSubType(itemKey.ItemType, itemKey.TemplateId);
		bool flag = (itemSubType == 900 && DomainManager.Extra.IsProfessionalSkillUnlocked(16, 1)) || (itemSubType == 901 && DomainManager.Extra.IsProfessionalSkillUnlocked(7, 1));
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		taiwu.RemoveInventoryItem(mainThreadDataContext, itemKey, 1, deleteItem: false);
		if (flag)
		{
			PoisonInts poisoned = taiwu.GetPoisoned();
			taiwu.AddEatingItem(mainThreadDataContext, itemKey);
			taiwu.SetPoisoned(ref poisoned, mainThreadDataContext);
		}
		else
		{
			taiwu.AddEatingItem(mainThreadDataContext, itemKey);
		}
		ItemKey itemKey2 = DomainManager.Item.CreateCopyOfItem(mainThreadDataContext, itemKey);
		other.AddEatingItem(mainThreadDataContext, itemKey2);
	}

	public static (Location, int, short) GetAnimalHunterFight(GameData.Domains.Character.Character taiwu)
	{
		ProfessionData professionData = DomainManager.Extra.GetProfessionData(1);
		Location location = taiwu.GetLocation();
		if (professionData == null || !DomainManager.Extra.TryGetAnimalAttackInRange(location, 2, isTaiwuVictim: true, out var result))
		{
			return (Location.Invalid, -1, -1);
		}
		sbyte seniorityCallAnimalGrade = professionData.GetSeniorityCallAnimalGrade();
		foreach (var item in result)
		{
			if (DomainManager.Extra.TryGetAnimal(item.Item2, out var animal) && Config.Character.Instance[animal.CharacterTemplateId].RandomAnimalAttack)
			{
				sbyte carrierGradeByAnimal = GetCarrierGradeByAnimal(animal.CharacterTemplateId);
				if (carrierGradeByAnimal > seniorityCallAnimalGrade)
				{
					DomainManager.Extra.TryGetAnimal(item.Item2, out animal);
					return (item.Item1, item.Item2, animal.CharacterTemplateId);
				}
			}
		}
		return (Location.Invalid, -1, -1);
	}

	public static void AnimalMoveToLocation(Location originLocation, int animalId, Location targetLocation)
	{
		if (DomainManager.Extra.TryGetAnimal(animalId, out var animal))
		{
			DomainManager.Extra.SetAnimalLocation(Domain.MainThreadDataContext, animal, targetLocation);
		}
	}

	public static Dictionary<Location, List<short>> GetAnimalHunterCanGet(GameData.Domains.Character.Character taiwu)
	{
		ProfessionData professionData = DomainManager.Extra.GetProfessionData(1);
		Location location = taiwu.GetLocation();
		if (professionData == null || !DomainManager.Extra.TryGetAnimalAttackInRange(location, 2, isTaiwuVictim: true, out var result))
		{
			return null;
		}
		Dictionary<Location, List<short>> dictionary = new Dictionary<Location, List<short>>();
		sbyte seniorityCallAnimalGrade = professionData.GetSeniorityCallAnimalGrade();
		foreach (var (key, id) in result)
		{
			if (!DomainManager.Extra.TryGetAnimal(id, out var animal))
			{
				continue;
			}
			sbyte carrierGradeByAnimal = GetCarrierGradeByAnimal(animal.CharacterTemplateId);
			if (carrierGradeByAnimal <= seniorityCallAnimalGrade)
			{
				if (!dictionary.ContainsKey(key))
				{
					dictionary.Add(key, new List<short>());
				}
				dictionary[key].Add(animal.CharacterTemplateId);
			}
		}
		return dictionary;
	}

	public static List<(ItemKey, int)> HunterGetCarriers(Dictionary<Location, List<short>> animals, ref List<ItemKey> escapeCarriers)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		List<(ItemKey, int)> list = new List<(ItemKey, int)>();
		foreach (KeyValuePair<Location, List<short>> animal in animals)
		{
			for (int i = 0; i < animal.Value.Count; i++)
			{
				short num = animal.Value[i];
				if (Config.Character.Instance[num].RandomAnimalAttack)
				{
					ItemKey itemKey = DomainManager.Extra.GetFleeCarrierByLocation(num, animal.Key);
					if (itemKey.IsValid())
					{
						escapeCarriers.Add(itemKey);
						DomainManager.Extra.RemoveFleeCarrierLocation(Domain.MainThreadDataContext, itemKey);
						AddItemToRole(taiwu, itemKey, 1, -1);
					}
					else
					{
						CarrierItem carrierConfigByAnimal = GetCarrierConfigByAnimal(num);
						itemKey = AddItemToRole(taiwu, 4, carrierConfigByAnimal.TemplateId, 1, -1);
					}
					RemoveSingleMapAnimalOnBlock(animal.Key, num);
					list.Add((itemKey, 1));
				}
			}
		}
		if (list.Count > 0)
		{
			return list;
		}
		return null;
	}

	public static CarrierItem GetCarrierConfigByAnimal(short animalCharacterTemplateId)
	{
		return ProfessionSkillHandle.GetCarrierByAnimal(animalCharacterTemplateId);
	}

	public static sbyte GetCarrierGradeByAnimal(short animalCharacterTemplateId)
	{
		if (FiveLoongDlcEntry.IsCharacterLoong(animalCharacterTemplateId) || FiveLoongDlcEntry.IsCharacterMinionLoong(animalCharacterTemplateId))
		{
			return 8;
		}
		return GetCarrierConfigByAnimal(animalCharacterTemplateId).Grade;
	}

	public static void FilterItemForHunterSkill3(EventArgBox argBox)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		if (!argBox.Get("SelectItemInfo", out EventSelectItemData arg))
		{
			arg = new EventSelectItemData();
			argBox.Set("SelectItemInfo", (ISerializableGameData)(object)arg);
		}
		SelectItemFilter item = new SelectItemFilter
		{
			Key = "SelectItemKey",
			DisplayDataFilterId = 0,
			FilterTemplateId = -1
		};
		List<ItemDisplayData> allInventoryItems = DomainManager.Character.GetAllInventoryItems(taiwu.GetId());
		foreach (ItemDisplayData item2 in allInventoryItems)
		{
			ItemKey key = item2.Key;
			if (ProfessionSkillHandle.IsItemCanConvertToAnimalCharacter(key))
			{
				arg.CanSelectItemList.Add(item2);
			}
		}
		arg.FilterList.Add(item);
		arg.VisibleItemFilterTypes = new List<int> { 0, 3 };
		arg.ConfirmDisableTips = "LK_Event_SelectItemMode_ConfirmButtonTips_NoBeastCarrier";
	}

	public static void ConfirmCreateSpecialTeammateFromBeastCarrier(ItemKey sourceItemKey, string customGivenName)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		ProfessionSkillHandle.HunterSkill_ItemToAnimalCharacter(mainThreadDataContext, sourceItemKey, customGivenName);
	}

	public static void CivilianSkill_MakeCharacterLeaveSect(GameData.Domains.Character.Character character)
	{
		ProfessionSkillHandle.CivilianSkill_MakeCharacterLeaveSect(Domain.MainThreadDataContext, character);
	}

	public static int GetCivilianSkill2Cost(GameData.Domains.Character.Character character, sbyte resourceType)
	{
		if (resourceType != 7 && resourceType != 6 && resourceType != 8)
		{
			throw new Exception($"Unsupported ResourceType: {resourceType}");
		}
		sbyte grade = character.GetOrganizationInfo().Grade;
		short characterInfluencePower = GetCharacterInfluencePower(character.GetId());
		int num = (grade + 1) * (grade + 1) * 3 * characterInfluencePower;
		return resourceType switch
		{
			7 => num, 
			6 => num * 10, 
			_ => num * 5, 
		};
	}

	[Obsolete]
	public static bool CivilianSkill0Useful(OrganizationItem orgCfg)
	{
		return DomainManager.Extra.CivilianSkill0Useful(orgCfg);
	}

	public static int GetLifeTimeAddValue(ItemKey itemKey)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		short lifeSkillAttainment = taiwu.GetLifeSkillAttainment(8);
		short lifeSkillAttainment2 = taiwu.GetLifeSkillAttainment(9);
		sbyte grade = ItemTemplateHelper.GetGrade(itemKey.ItemType, itemKey.TemplateId);
		return (grade + 1) * (lifeSkillAttainment + lifeSkillAttainment2) / 100;
	}

	public static int GetDoctorSkillMoneyValue(ItemKey itemKey)
	{
		ProfessionData professionData = GetProfessionData(13);
		if (professionData == null)
		{
			return 0;
		}
		int value = DomainManager.Item.GetBaseItem(itemKey).GetValue();
		float num = (float)professionData.GetSeniorityDoctorMedicinePricePercent() / 100f;
		float num2 = (float)value * num;
		return (int)num2;
	}

	public static short GetDoctorSkill0FavorabilityChange(MedicineItem config)
	{
		ProfessionData professionData = GetProfessionData(13);
		float num = (float)ItemTemplateHelper.GetBaseFavorabilityChange(config.ItemType, config.TemplateId) * ((float)professionData.GetSeniorityDoctorFavorAddPercent() / 100f);
		return ClampFavorabilityChangeValue((int)num);
	}

	public static short GetChangeDisorderOfQiByDoctorSkill0()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		short lifeSkillAttainment = taiwu.GetLifeSkillAttainment(8);
		short lifeSkillAttainment2 = taiwu.GetLifeSkillAttainment(9);
		return (short)((lifeSkillAttainment + lifeSkillAttainment2) * 5);
	}

	public static bool CanRecoverHealth(GameData.Domains.Character.Character character, ItemKey itemKey)
	{
		Tester.Assert(itemKey.ItemType == 8);
		MedicineItem medicineItem = Config.Medicine.Instance[itemKey.TemplateId];
		Tester.Assert(medicineItem.EffectType == EMedicineEffectType.RecoverHealth);
		if (medicineItem.EffectValue < 0)
		{
			return false;
		}
		short leftMaxHealth = DomainManager.Character.GetLeftMaxHealth(character.GetId());
		short health = character.GetHealth();
		if (leftMaxHealth >= 0 && leftMaxHealth > health)
		{
			return true;
		}
		return false;
	}

	public static void DoctorSkill3Execute(GameData.Domains.Character.Character character)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int num = taiwu.GetBaseMaxHealth() * GlobalConfig.Instance.DoctorSkill3_HealthTransferPercent / 100;
		character.ChangeBaseMaxHealth(mainThreadDataContext, num, autoAdjustHealth: false);
		taiwu.ChangeBaseMaxHealth(mainThreadDataContext, -num, autoAdjustHealth: false);
		if (taiwu.GetHealth() > taiwu.GetLeftMaxHealth())
		{
			taiwu.SetHealth(taiwu.GetLeftMaxHealth(), mainThreadDataContext);
		}
		int num2 = num * GlobalConfig.Instance.DoctorSkill3_FavorabilityChangePercent;
		DomainManager.Character.DirectlyChangeFavorabilityOptional(mainThreadDataContext, character, taiwu, num2, 3);
		DomainManager.Character.AddFavorabilityChangeInstantNotification(character, taiwu, num2 > 0);
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		lifeRecordCollection.AddProfessionDoctorLifeTransition(character.GetId(), currDate, taiwu.GetId(), taiwu.GetLocation());
	}

	public static void AddSeniorityOnFindMaterialAdventure(ItemKey itemKey)
	{
		if (DomainManager.Adventure.GetCurAdventureId() >= 0)
		{
			sbyte type = DomainManager.Adventure.AdventureCfg.Type;
			if (type >= 9 && type <= 14 && itemKey.ItemType == 5)
			{
				int value = DomainManager.Item.GetValue(itemKey);
				int baseDelta = ProfessionFormulaImpl.Calculate(6, value);
				DomainManager.Extra.ChangeProfessionSeniority(Domain.MainThreadDataContext, 0, baseDelta);
			}
		}
	}

	public static void OnEnterPraiseOrAbuse(int charId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		sbyte grade = element_Objects.GetOrganizationInfo().Grade;
		int baseDelta = ProfessionFormulaImpl.Calculate(61, grade);
		DomainManager.Extra.ChangeProfessionSeniority(Domain.MainThreadDataContext, 9, baseDelta);
	}

	public static void ExtraProfessionSkillSetFeature(int featureId)
	{
		DomainManager.Extra.ExtraProfessionSkillSetFeature(Domain.MainThreadDataContext, (short)featureId);
	}

	public static bool HasFriendOrFamilyRelation(int charId)
	{
		return RelationTypeToNormalInteractionType(charId) != ENormalInteractionType.Invalid;
	}

	public static ENormalInteractionType RelationTypeToNormalInteractionType(int charId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		if (DomainManager.Character.TryGetRelation(taiwu.GetId(), charId, out var relation) && DomainManager.Character.TryGetRelation(charId, taiwu.GetId(), out var relation2))
		{
			if (RelationType.HasRelation(relation.RelationType, 512) || RelationType.HasRelation(relation.RelationType, 8192) || RelationType.HasRelation(relation.RelationType, 256) || RelationType.HasRelation(relation.RelationType, 32) || RelationType.HasRelation(relation.RelationType, 4))
			{
				return ENormalInteractionType.FriendSet;
			}
			if (RelationType.HasRelation(relation.RelationType, 1024) || (RelationType.HasRelation(relation.RelationType, 16384) && RelationType.HasRelation(relation2.RelationType, 16384)))
			{
				return ENormalInteractionType.LoveSet;
			}
			if (RelationType.HasRelation(relation.RelationType, 128) || RelationType.HasRelation(relation.RelationType, 2) || RelationType.HasRelation(relation.RelationType, 16))
			{
				return ENormalInteractionType.ChildSet;
			}
			if (RelationType.HasRelation(relation.RelationType, 64) || RelationType.HasRelation(relation.RelationType, 1) || RelationType.HasRelation(relation.RelationType, 8))
			{
				return ENormalInteractionType.ParentSet;
			}
			if (RelationType.HasRelation(relation.RelationType, 2048))
			{
				return ENormalInteractionType.TeacherSet;
			}
		}
		return ENormalInteractionType.Invalid;
	}

	public static bool IsFriendOrFamilyInteractionCooldown(int charId)
	{
		sbyte cooldown;
		return DomainManager.Extra.IsFriendOrFamilyInteractionCooldown(charId, out cooldown);
	}

	public static void SetFriendOrFamilySendGiftResult(int charId, EventArgBox argBox)
	{
		DomainManager.Extra.SetFriendOrFamilySendGiftResult(Domain.MainThreadDataContext, charId, argBox);
	}

	public static void ExecuteFriendOrFamilySendGift(int charId, EventArgBox argBox)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			DataContext mainThreadDataContext = Domain.MainThreadDataContext;
			GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
			bool arg = false;
			bool arg2 = false;
			if (argBox.Get("AddExp", ref arg) && arg)
			{
				int arg3 = 0;
				argBox.Get("AddExpCount", ref arg3);
				ChangeRoleExp(taiwu, arg3);
			}
			else if (argBox.Get("IsMiscResource", ref arg2) && arg2)
			{
				sbyte arg4 = 0;
				int arg5 = 0;
				argBox.Get("ResourceType", ref arg4);
				argBox.Get("Count", ref arg5);
				ChangeRoleResource(element, arg4, -arg5);
				ChangeRoleResource(taiwu, arg4, arg5);
			}
			else
			{
				argBox.Get<ItemKey>("ItemKey", out ItemKey arg6);
				element.RemoveInventoryItem(mainThreadDataContext, arg6, 1, deleteItem: false);
				taiwu.AddInventoryItem(mainThreadDataContext, arg6, 1);
			}
			sbyte arg7 = 0;
			argBox.Get("Cooldown", ref arg7);
			if (DomainManager.Extra.TryGetElement_FriendOrFamilyInteractionCooldownDict(charId, out var _))
			{
				DomainManager.Extra.SetFriendOrFamilyInteractionCooldown(mainThreadDataContext, charId, arg7);
			}
			else
			{
				DomainManager.Extra.AddFriendOrFamilyInteractionCooldown(mainThreadDataContext, charId, arg7);
			}
		}
	}

	public static void RequestDemandAgree(EventArgBox argBox)
	{
		short arg = -1;
		argBox.Get("MonthlyEventTemplateId", ref arg);
		switch (arg)
		{
		case 0:
			RequestHealOuterInjuryByItemAgree(argBox);
			break;
		case 1:
			RequestHealInnerInjuryByItemAgree(argBox);
			break;
		case 2:
			RequestHealPoisonByItemAgree(argBox);
			break;
		case 3:
			RequestHealthAgree(argBox);
			break;
		case 4:
			RequestHealDisorderOfQiAgree(argBox);
			break;
		case 5:
			RequestNeiliAgree(argBox);
			break;
		case 6:
			RequestKillWugAgree(argBox);
			break;
		case 7:
			RequestFoodAgree(argBox);
			break;
		case 8:
			RequestTeaWineAgree(argBox);
			break;
		case 9:
			RequestResourceAgree(argBox);
			break;
		case 10:
			RequestItemAgree(argBox);
			break;
		case 11:
			RequestRepairItemAgree(argBox);
			break;
		case 12:
			RequestAddPoisonToItemAgree(argBox);
			break;
		case 13:
			RequestInstructionOnReadingLifeSkillAgree(argBox);
			break;
		case 14:
			RequestInstructionOnBreakoutAgree(argBox);
			break;
		}
	}

	public static void RequestHealOuterInjuryByItemAgree(EventArgBox argBox)
	{
		argBox.Get<ItemKey>("MonthlyEvent_arg3", out ItemKey arg);
		RequestHealInjuryAction requestHealInjuryAction = new RequestHealInjuryAction
		{
			ItemUsed = arg,
			IsInnerInjury = false,
			AgreeToRequest = true
		};
		GameData.Domains.Character.Character character = argBox.GetCharacter("MonthlyEvent_arg0");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("RoleTaiwu");
		if (requestHealInjuryAction.CheckValid(character, character2))
		{
			ApplyGeneralActionChanges(requestHealInjuryAction, character, character2);
		}
	}

	public static void RequestHealInnerInjuryByItemAgree(EventArgBox argBox)
	{
		argBox.Get<ItemKey>("MonthlyEvent_arg3", out ItemKey arg);
		RequestHealInjuryAction requestHealInjuryAction = new RequestHealInjuryAction
		{
			ItemUsed = arg,
			IsInnerInjury = true,
			AgreeToRequest = true
		};
		GameData.Domains.Character.Character character = argBox.GetCharacter("MonthlyEvent_arg0");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("RoleTaiwu");
		if (requestHealInjuryAction.CheckValid(character, character2))
		{
			ApplyGeneralActionChanges(requestHealInjuryAction, character, character2);
		}
	}

	public static void RequestHealPoisonByItemAgree(EventArgBox argBox)
	{
		argBox.Get<ItemKey>("MonthlyEvent_arg3", out ItemKey arg);
		int arg2 = -1;
		argBox.Get("MonthlyEvent_arg4", ref arg2);
		RequestDetoxPoisonAction requestDetoxPoisonAction = new RequestDetoxPoisonAction
		{
			ItemUsed = arg,
			AgreeToRequest = true,
			PoisonType = (sbyte)arg2
		};
		GameData.Domains.Character.Character character = argBox.GetCharacter("MonthlyEvent_arg0");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("RoleTaiwu");
		if (requestDetoxPoisonAction.CheckValid(character, character2))
		{
			ApplyGeneralActionChanges(requestDetoxPoisonAction, character, character2);
		}
	}

	public static void RequestHealthAgree(EventArgBox argBox)
	{
		argBox.Get<ItemKey>("MonthlyEvent_arg3", out ItemKey arg);
		RequestIncreaseHealthAction requestIncreaseHealthAction = new RequestIncreaseHealthAction
		{
			ItemUsed = arg,
			AgreeToRequest = true
		};
		GameData.Domains.Character.Character character = argBox.GetCharacter("MonthlyEvent_arg0");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("RoleTaiwu");
		if (requestIncreaseHealthAction.CheckValid(character, character2))
		{
			ApplyGeneralActionChanges(requestIncreaseHealthAction, character, character2);
		}
	}

	public static void RequestHealDisorderOfQiAgree(EventArgBox argBox)
	{
		argBox.Get<ItemKey>("MonthlyEvent_arg3", out ItemKey arg);
		RequestRestoreQiAction requestRestoreQiAction = new RequestRestoreQiAction
		{
			ItemUsed = arg,
			AgreeToRequest = true
		};
		GameData.Domains.Character.Character character = argBox.GetCharacter("MonthlyEvent_arg0");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("RoleTaiwu");
		if (requestRestoreQiAction.CheckValid(character, character2))
		{
			ApplyGeneralActionChanges(requestRestoreQiAction, character, character2);
		}
	}

	public static void RequestNeiliAgree(EventArgBox argBox)
	{
		argBox.Get<ItemKey>("MonthlyEvent_arg3", out ItemKey arg);
		RequestIncreaseNeiliAction requestIncreaseNeiliAction = new RequestIncreaseNeiliAction
		{
			ItemUsed = arg,
			AgreeToRequest = true
		};
		GameData.Domains.Character.Character character = argBox.GetCharacter("MonthlyEvent_arg0");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("RoleTaiwu");
		if (requestIncreaseNeiliAction.CheckValid(character, character2))
		{
			ApplyGeneralActionChanges(requestIncreaseNeiliAction, character, character2);
		}
	}

	public static void RequestKillWugAgree(EventArgBox argBox)
	{
		argBox.Get<ItemKey>("MonthlyEvent_arg3", out ItemKey arg);
		argBox.Get<ItemKey>("MonthlyEvent_arg4", out ItemKey arg2);
		RequestKillWugAction requestKillWugAction = new RequestKillWugAction
		{
			ItemUsed = arg,
			AgreeToRequest = true,
			WugType = Config.Medicine.Instance[arg2.TemplateId].WugType
		};
		GameData.Domains.Character.Character character = argBox.GetCharacter("MonthlyEvent_arg0");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("RoleTaiwu");
		if (requestKillWugAction.CheckValid(character, character2))
		{
			ApplyGeneralActionChanges(requestKillWugAction, character, character2);
		}
	}

	public static void RequestFoodAgree(EventArgBox argBox)
	{
		argBox.Get<ItemKey>("MonthlyEvent_arg3", out ItemKey arg);
		int arg2 = -1;
		argBox.Get("MonthlyEvent_arg4", ref arg2);
		RequestRecoverMainAttributeAction requestRecoverMainAttributeAction = new RequestRecoverMainAttributeAction
		{
			ItemUsed = arg,
			AgreeToRequest = true,
			MainAttributeType = (sbyte)arg2
		};
		GameData.Domains.Character.Character character = argBox.GetCharacter("MonthlyEvent_arg0");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("RoleTaiwu");
		if (requestRecoverMainAttributeAction.CheckValid(character, character2))
		{
			ApplyGeneralActionChanges(requestRecoverMainAttributeAction, character, character2);
		}
	}

	public static void RequestTeaWineAgree(EventArgBox argBox)
	{
		argBox.Get<ItemKey>("MonthlyEvent_arg3", out ItemKey arg);
		RequestIncreaseHappinessAction requestIncreaseHappinessAction = new RequestIncreaseHappinessAction
		{
			ItemUsed = arg,
			AgreeToRequest = true
		};
		GameData.Domains.Character.Character character = argBox.GetCharacter("MonthlyEvent_arg0");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("RoleTaiwu");
		if (requestIncreaseHappinessAction.CheckValid(character, character2))
		{
			ApplyGeneralActionChanges(requestIncreaseHappinessAction, character, character2);
		}
	}

	public static void RequestResourceAgree(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("MonthlyEvent_arg0");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("MonthlyEvent_arg2");
		int arg = -1;
		argBox.Get("MonthlyEvent_arg3", ref arg);
		int arg2 = -1;
		argBox.Get("MonthlyEvent_arg4", ref arg2);
		RequestResourceAction requestResourceAction = new RequestResourceAction
		{
			AgreeToRequest = true,
			Amount = arg,
			ResourceType = (sbyte)arg2
		};
		if (requestResourceAction.CheckValid(character, character2))
		{
			ApplyGeneralActionChanges(requestResourceAction, character, character2);
		}
	}

	public static void RequestItemAgree(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("MonthlyEvent_arg0");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("MonthlyEvent_arg2");
		argBox.Get<ItemKey>("MonthlyEvent_arg3", out ItemKey arg);
		int arg2 = -1;
		argBox.Get("MonthlyEvent_arg4", ref arg2);
		RequestItemAction requestItemAction = new RequestItemAction
		{
			AgreeToRequest = true,
			Amount = arg2,
			TargetItem = arg
		};
		if (requestItemAction.CheckValid(character, character2))
		{
			ApplyGeneralActionChanges(requestItemAction, character, character2);
		}
	}

	public static void RequestRepairItemAgree(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("MonthlyEvent_arg0");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("MonthlyEvent_arg2");
		argBox.Get<ItemKey>("MonthlyEvent_arg3", out ItemKey arg);
		argBox.Get<ItemKey>("MonthlyEvent_arg4", out ItemKey arg2);
		int arg3 = -1;
		argBox.Get("MonthlyEvent_arg5", ref arg3);
		int arg4 = -1;
		argBox.Get("MonthlyEvent_arg6", ref arg4);
		RequestRepairItemAction requestRepairItemAction = new RequestRepairItemAction
		{
			TargetItem = arg,
			AgreeToRequest = true,
			ToolUsed = arg2,
			ResourceAmount = arg3,
			ResourceType = (sbyte)arg4
		};
		if (requestRepairItemAction.CheckValid(character, character2))
		{
			ApplyGeneralActionChanges(requestRepairItemAction, character, character2);
		}
	}

	public static void RequestAddPoisonToItemAgree(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("MonthlyEvent_arg0");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("MonthlyEvent_arg2");
		argBox.Get<ItemKey>("MonthlyEvent_arg3", out ItemKey arg);
		argBox.Get<ItemKey>("MonthlyEvent_arg4", out ItemKey arg2);
		RequestAddPoisonToItemAction requestAddPoisonToItemAction = new RequestAddPoisonToItemAction
		{
			TargetItem = arg,
			AgreeToRequest = true,
			PoisonUsed = arg2
		};
		requestAddPoisonToItemAction.CheckValid(character, character2);
		ApplyGeneralActionChanges(requestAddPoisonToItemAction, character, character2);
	}

	public static void RequestInstructionOnReadingLifeSkillAgree(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("MonthlyEvent_arg0");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("MonthlyEvent_arg2");
		argBox.Get<ItemKey>("MonthlyEvent_arg3", out ItemKey arg);
		int arg2 = 0;
		argBox.Get("MonthlyEvent_arg4", ref arg2);
		LifeSkillReadingDemandAction lifeSkillReadingDemandAction = new LifeSkillReadingDemandAction
		{
			AgreeToRequest = true,
			BookItemKey = arg,
			PageId = (byte)(arg2 - 1)
		};
		if (lifeSkillReadingDemandAction.CheckValid(character, character2))
		{
			ApplyGeneralActionChanges(lifeSkillReadingDemandAction, character, character2);
		}
	}

	public static void RequestInstructionOnBreakoutAgree(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("MonthlyEvent_arg0");
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("MonthlyEvent_arg2");
		int arg = -1;
		argBox.Get("MonthlyEvent_arg3", ref arg);
		BreakingDemandAction breakingDemandAction = new BreakingDemandAction
		{
			AgreeToRequest = true,
			CombatSkillTemplateId = (short)arg
		};
		if (breakingDemandAction.CheckValid(character, character2))
		{
			ApplyGeneralActionChanges(breakingDemandAction, character, character2);
		}
	}

	public static short GetResourceFavorabilityChange(sbyte resourceType, int amount)
	{
		return AiHelper.GeneralActionConstants.GetResourceFavorabilityChange(resourceType, amount);
	}

	public static short GetResourceHappinessChange(sbyte resourceType, int amount)
	{
		return AiHelper.GeneralActionConstants.GetResourceHappinessChange(resourceType, amount);
	}

	public static void ConfiscateResource(int charId, bool onlyTakeOverflow = false)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		OrganizationInfo organizationInfo = element_Objects.GetOrganizationInfo();
		if (OrganizationDomain.IsSect(organizationInfo.OrgTemplateId) && organizationInfo.SettlementId >= 0)
		{
			ResourceInts resources = (onlyTakeOverflow ? element_Objects.GetResourcesAboveSatisfyingThreshold() : element_Objects.GetResources());
			Settlement settlement = DomainManager.Organization.GetSettlement(organizationInfo.SettlementId);
			settlement.ConfiscateResources(mainThreadDataContext, element_Objects, ref resources);
		}
	}

	public static SecretInformationCollection GetSecretInformationCollection()
	{
		return DomainManager.Information.GetSecretInformationCollection();
	}

	public static void CostSecretInformationUsedCount(int charId, int metaDataId)
	{
		sbyte characterSecretInformationUsedCount = DomainManager.Extra.GetCharacterSecretInformationUsedCount(charId, metaDataId);
		int num = (IsSecretInformationBroadcast(metaDataId) ? GlobalConfig.Instance.SecretInformationInBroadcastMaxUseCount : GlobalConfig.Instance.SecretInformationInPrivateMaxUseCount);
		characterSecretInformationUsedCount++;
		DomainManager.Extra.SetCharacterSecretInformationUsedCount(Domain.MainThreadDataContext, charId, metaDataId, characterSecretInformationUsedCount);
		if (characterSecretInformationUsedCount > num)
		{
			AdaptableLog.Error($"taiwu({charId}) used secret information {metaDataId} in {characterSecretInformationUsedCount} times(max: {num})");
		}
	}

	public static int CreateSecretInformationMetaData(int resultOfCollectionAdding, bool withInitialDistribute = true)
	{
		return DomainManager.Information.AddSecretInformationMetaDataWithNecessity(Domain.MainThreadDataContext, resultOfCollectionAdding, withInitialDistribute, necessarily: true, null);
	}

	public static void DiscardSecretInformation(int charId, int metaDataId)
	{
		DomainManager.Information.DiscardSecretInformation(Domain.MainThreadDataContext, charId, metaDataId);
	}

	public static bool DistributeSecretInformationToCharacter(int metaDataId, int charId, int sourceCharId = -1)
	{
		return DomainManager.Information.DistributeSecretInformationToCharacter(Domain.MainThreadDataContext, metaDataId, charId, sourceCharId);
	}

	public static void BroadcastSecretInformation(int metaDataId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Information.MakeSecretInformationBroadcastEffect(mainThreadDataContext, metaDataId, -1);
	}

	public static bool DisseminateSecretInformationFromTaiwu(int metaDataId, int targetCharId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int id = taiwu.GetId();
		InformationDomain information = DomainManager.Information;
		short num = information.CalcSecretInformationTemplateId(metaDataId);
		int num2 = 0;
		if (information.TryGetElement_CharacterSecretInformation(id, out var value) && value.Collection.TryGetValue(metaDataId, out var value2))
		{
			num2 = information.CalcSecretInformationAuthorityCostWhenDisseminatingByCharacter(num, taiwu.GetFameType(), information.GetSecretInformationDisseminatingCountOfBranch(metaDataId, value2.SecretInformationDisseminationBranch));
		}
		CostSecretInformationUsedCount(id, metaDataId);
		SecretInformationItem item = SecretInformation.Instance.GetItem(num);
		HashSet<SecretInformationRelationshipType> hashSet = new HashSet<SecretInformationRelationshipType>();
		if (information.TryGetSecretInformationCharacter(metaDataId, 0, out var characterId))
		{
			information.CheckSecretInformationRelationship(characterId, -1, targetCharId, -1, hashSet);
		}
		if (information.TryGetSecretInformationCharacter(metaDataId, 1, out var characterId2))
		{
			information.CheckSecretInformationRelationship(characterId2, -1, targetCharId, -1, hashSet);
		}
		if (hashSet.Contains(SecretInformationRelationshipType.Enemy) || hashSet.Contains(SecretInformationRelationshipType.Relative) || hashSet.Contains(SecretInformationRelationshipType.Friend) || characterId == targetCharId || characterId2 == targetCharId)
		{
			ProfessionFormulaItem formulaCfg = ProfessionFormula.Instance[33];
			int baseDelta = formulaCfg.Calculate(num2, item.SortValue);
			DomainManager.Extra.ChangeProfessionSeniority(Domain.MainThreadDataContext, 4, baseDelta);
		}
		if (DistributeSecretInformationToCharacter(metaDataId, targetCharId, id))
		{
			ChangeRoleResource(taiwu, 7, -Math.Min(taiwu.GetResource(7), num2));
			ProfessionFormulaItem formulaCfg2 = ProfessionFormula.Instance[32];
			int baseDelta2 = formulaCfg2.Calculate(num2, item.SortValue);
			DomainManager.Extra.ChangeProfessionSeniority(Domain.MainThreadDataContext, 4, baseDelta2);
			return true;
		}
		return false;
	}

	public static List<int> GetSecretInformationOfCharacter(int charId, bool includeBroadcast = true)
	{
		return DomainManager.Information.GetSecretInformationOfCharacter(charId, includeBroadcast);
	}

	public static bool CharacterHasSecretInformationByTemplateId(int charId, short templateId)
	{
		return DomainManager.Information.CharacterHasSecretInformationByTemplateId(charId, templateId);
	}

	public static SecretInformationItem GetSecretInformationConfig(int metaDataId)
	{
		return DomainManager.Information.GetSecretInformationConfig(metaDataId);
	}

	public static List<int> PickUsableSecretInformationFromMetaDataIdList(int charId, List<int> sourceMetaDataIds)
	{
		List<int> list = new List<int>();
		int i = 0;
		for (int count = sourceMetaDataIds.Count; i < count; i++)
		{
			int num = sourceMetaDataIds[i];
			int num2 = (IsSecretInformationBroadcast(num) ? GlobalConfig.Instance.SecretInformationInBroadcastMaxUseCount : GlobalConfig.Instance.SecretInformationInPrivateMaxUseCount);
			if (DomainManager.Extra.GetCharacterSecretInformationUsedCount(charId, num) < num2)
			{
				list.Add(num);
			}
		}
		return list;
	}

	public static List<int> GetTypedSecretInformationOfCharacter(int charId, short secretInformationTemplateId, bool includeBroadcast = true)
	{
		return (from metaDataId in GetSecretInformationOfCharacter(charId, includeBroadcast)
			where DomainManager.Information.CalcSecretInformationTemplateId(metaDataId) == secretInformationTemplateId
			select metaDataId).ToList();
	}

	public static EventArgBox GetSecretInformationParameters(int metaDataId)
	{
		EventArgBox eventArgBox = new EventArgBox();
		if (DomainManager.Information.TryGetElement_SecretInformationMetaData(metaDataId, out var element))
		{
			DomainManager.Information.MakeSecretInformationEventArgBox(element, eventArgBox);
		}
		return eventArgBox;
	}

	public static void ApplySecretInformationTargetEffect(int metaDataId, int targetCharId, short secretInformationEffectTemplateId)
	{
	}

	public static void ApplySecretInformationBroadcastEffect(int metaDataId, short secretInformationEffectTemplateId)
	{
		ApplySecretInformationTargetEffect(metaDataId, -1, secretInformationEffectTemplateId);
	}

	public static SecretInformationItem GetSecretInformationItem(short templateId)
	{
		return SecretInformation.Instance.GetItem(templateId);
	}

	public static SecretInformationEffectItem GetSecretInformationEffectItem(short templateId)
	{
		return SecretInformationEffect.Instance.GetItem(templateId);
	}

	public static void StartTradeSecretInformation(int charId, string saveKey)
	{
		EventSelectInformationData eventSelectInformationData = new EventSelectInformationData();
		eventSelectInformationData.RelatedCharacterId = charId;
		eventSelectInformationData.SelectComplete = false;
		eventSelectInformationData.IsForShopping = true;
		eventSelectInformationData.CharacterNameRelatedData = DomainManager.Character.GetNameRelatedData(charId);
		eventSelectInformationData.AvailableData = true;
		eventSelectInformationData.ToSelectSecretInformationDataIdList = DomainManager.Information.RequestShopSecretInformationIdList(Domain.MainThreadDataContext, charId).ToList();
		Domain.SetSelectInformationData(eventSelectInformationData, Domain.MainThreadDataContext);
	}

	public static void StartInformationSelect(int charId, string saveKey, bool isNormalInformation)
	{
		EventSelectInformationData eventSelectInformationData = new EventSelectInformationData();
		eventSelectInformationData.RelatedCharacterId = charId;
		eventSelectInformationData.SaveKey = saveKey;
		eventSelectInformationData.SelectComplete = false;
		eventSelectInformationData.CharacterNameRelatedData = DomainManager.Character.GetNameRelatedData(charId);
		if (isNormalInformation)
		{
			eventSelectInformationData.ToSelectNormalInformation = DomainManager.Information.GetCharacterNormalInformation(charId);
		}
		else
		{
			SecretInformationDisplayPackage secretInformationDisplayPackageForSelections = DomainManager.Information.GetSecretInformationDisplayPackageForSelections(charId);
			eventSelectInformationData.ToSelectSecretInformationDataIdList = secretInformationDisplayPackageForSelections.SecretInformationDisplayDataList.ConvertAll((SecretInformationDisplayData e) => e.SecretInformationMetaDataId);
		}
		eventSelectInformationData.AvailableData = true;
		Domain.SetSelectInformationData(eventSelectInformationData, Domain.MainThreadDataContext);
	}

	public static void StartSecretInformationSelectRelateWithB(int charA, int charB, string saveKey)
	{
		EventSelectInformationData eventSelectInformationData = new EventSelectInformationData();
		eventSelectInformationData.RelatedCharacterId = charA;
		eventSelectInformationData.SaveKey = saveKey;
		eventSelectInformationData.SelectComplete = false;
		eventSelectInformationData.CharacterNameRelatedData = DomainManager.Character.GetNameRelatedData(charA);
		SecretInformationDisplayPackage relateBSecretInformationDisplayPackageForSelections = DomainManager.Information.GetRelateBSecretInformationDisplayPackageForSelections(charA, charB);
		eventSelectInformationData.ToSelectSecretInformationDataIdList = relateBSecretInformationDisplayPackageForSelections.SecretInformationDisplayDataList.ConvertAll((SecretInformationDisplayData e) => e.SecretInformationMetaDataId);
		eventSelectInformationData.AvailableData = true;
		Domain.SetSelectInformationData(eventSelectInformationData, Domain.MainThreadDataContext);
	}

	public static bool CanGetSecretInformationRelateWithB(int charA, int charB)
	{
		SecretInformationDisplayPackage relateBSecretInformationDisplayPackageForSelections = DomainManager.Information.GetRelateBSecretInformationDisplayPackageForSelections(charA, charB);
		return relateBSecretInformationDisplayPackageForSelections.SecretInformationDisplayDataList.Count > 0;
	}

	public static List<int> GetSecretInformationDisseminationBranchCharacterIds(int metaDataId)
	{
		if (DomainManager.Information.TryGetElement_SecretInformationMetaData(metaDataId, out var element))
		{
			return element.GetDisseminationBranchCharacterIds().ToList();
		}
		return new List<int>();
	}

	public static HashSet<int> GetSecretInformationRelatedCharacters(int metaDataId, int characterId, bool includeGeneral = true, bool includeAlive = true, bool includeDead = true)
	{
		HashSet<int> hashSet = new HashSet<int>();
		if (DomainManager.Information.TryGetElement_SecretInformationMetaData(metaDataId, out var metaData) && metaData.CharacterRelationshipSnapshotCollection.Collection.TryGetValue(characterId, out var value))
		{
			value.RelatedCharacters.GetAllRelatedCharIds(hashSet, includeGeneral);
			if (!includeAlive)
			{
				hashSet.RemoveWhere((int charId) => metaData.CharacterExtraInfoCollection.Collection.TryGetValue(charId, out var value2) && value2.AliveState == 0);
			}
			if (!includeDead)
			{
				hashSet.RemoveWhere((int charId) => metaData.CharacterExtraInfoCollection.Collection.TryGetValue(charId, out var value2) && value2.AliveState != 0);
			}
		}
		return hashSet;
	}

	public static List<int> GetSecretInformationInitialCharacterIds(int metaDataId)
	{
		HashSet<int> hashSet = new HashSet<int>();
		HashSet<int> keyChars = new HashSet<int>();
		EventArgBox secretInformationParameters = GetSecretInformationParameters(metaDataId);
		short arg = -1;
		secretInformationParameters.Get("templateId", ref arg);
		SecretInformationItem secretInformationItem = SecretInformation.Instance[arg];
		if (secretInformationItem.Parameters != null)
		{
			HashSet<int> hashSet2 = ObjectPool<HashSet<int>>.Instance.Get();
			for (int i = 0; i < secretInformationItem.Parameters.Length; i++)
			{
				int arg2 = -1;
				if (secretInformationItem.Parameters[i] == "Character" && !secretInformationParameters.Get($"arg{i}", ref arg2))
				{
					continue;
				}
				keyChars.Add(arg2);
				if (DomainManager.Character.TryGetElement_Objects(arg2, out var element) && element != null)
				{
					hashSet2.Clear();
					switch (secretInformationItem.InitialTarget)
					{
					case ESecretInformationInitialTarget.Area:
						DomainManager.Character.GetAreaPeople(Domain.MainThreadDataContext.Random, element, hashSet2, 100);
						break;
					case ESecretInformationInitialTarget.Nearest:
						DomainManager.Character.GetClosePeople(Domain.MainThreadDataContext.Random, element, hashSet2, 100);
						break;
					case ESecretInformationInitialTarget.Local:
						DomainManager.Character.GetSameBlockPeople(Domain.MainThreadDataContext.Random, element, hashSet2, 100);
						break;
					}
					hashSet.UnionWith(hashSet2);
				}
			}
			ObjectPool<HashSet<int>>.Instance.Return(hashSet2);
		}
		hashSet.RemoveWhere((int charId) => keyChars.Contains(charId));
		return hashSet.ToList();
	}

	public static LocalObjectPool<SecretInformationProcessor> GetSecretInformationProcessorPool()
	{
		return DomainManager.Information.SecretInformationProcessorPool;
	}

	public static ICollection<int> GetSecretInformationKnownDiff(int selfCharacter, int targetCharacter)
	{
		HashSet<int> hashSet = new HashSet<int>();
		if (DomainManager.Information.TryGetElement_CharacterSecretInformation(selfCharacter, out var value))
		{
			hashSet.UnionWith(value.Collection.Keys);
		}
		if (DomainManager.Information.TryGetElement_CharacterSecretInformation(targetCharacter, out var target))
		{
			hashSet.RemoveWhere((int metaDataId) => target.Collection.ContainsKey(metaDataId));
		}
		return hashSet;
	}

	public static int GetSecretInformationHolderCount(int metaDataId)
	{
		return DomainManager.Information.GetSecretInformationHolderCount(metaDataId);
	}

	public unsafe static string GetSecretInformationDesc(int metaDataId, EventArgBox argBox)
	{
		if (!DomainManager.Information.TryGetElement_SecretInformationMetaData(metaDataId, out var element))
		{
			return string.Empty;
		}
		SecretInformationCollection secretInformationCollection = GetSecretInformationCollection();
		int offset = element.GetOffset();
		List<string> list = new List<string>();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		SecretInformationItem secretInformationItem;
		fixed (byte* rawData = secretInformationCollection.RawData)
		{
			byte* ptr = rawData + offset;
			ptr++;
			int num = *(int*)ptr;
			ptr += 4;
			short index = *(short*)ptr;
			ptr += 2;
			secretInformationItem = SecretInformation.Instance[index];
			if (secretInformationItem.Parameters != null)
			{
				int i = 0;
				for (int num2 = secretInformationItem.Parameters.Length; i < num2; i++)
				{
					string text = secretInformationItem.Parameters[i];
					if (!string.IsNullOrEmpty(text))
					{
						switch (text)
						{
						case "Character":
						{
							int arg = *(int*)ptr;
							ptr += 4;
							string text2 = $"SecretArgCharacterId{i}";
							argBox.Set(text2, arg);
							list.Add("<Character key=" + text2 + " str=Name/>");
							break;
						}
						case "Location":
						{
							short index5 = *(short*)ptr;
							ptr += 2;
							short num4 = *(short*)ptr;
							ptr += 2;
							MapAreaData element_Areas = DomainManager.Map.GetElement_Areas(index5);
							list.Add(element_Areas.GetConfig().Name ?? "");
							break;
						}
						case "ItemKey":
						{
							ulong num3 = *(ulong*)ptr;
							ItemKey itemKey = (ItemKey)num3;
							ptr += 8;
							list.Add(ItemTemplateHelper.GetName(itemKey.ItemType, itemKey.TemplateId));
							break;
						}
						case "Resource":
						{
							sbyte index4 = (sbyte)(*ptr);
							ptr++;
							list.Add(Config.ResourceType.Instance[index4].Name);
							break;
						}
						case "LifeSkill":
						{
							short index3 = *(short*)ptr;
							ptr += 2;
							list.Add(LifeSkill.Instance[index3].Name);
							break;
						}
						case "CombatSkill":
						{
							short index2 = *(short*)ptr;
							ptr += 2;
							list.Add(Config.CombatSkill.Instance[index2].Name);
							break;
						}
						case "Integer":
							list.Add($"{*(int*)ptr}");
							ptr += 4;
							break;
						default:
							throw new NotImplementedException(text);
						}
					}
				}
			}
		}
		while (list.Count < 4)
		{
			list.Add(string.Empty);
		}
		int j = 0;
		for (int count = list.Count; j < count; j++)
		{
			list[j] = "<color=#pinkyellow>" + list[j] + "</color>";
		}
		return string.Format(secretInformationItem.Desc, list[0], list[1], list[2], list[3]);
	}

	public static HashSet<SecretInformationRelationshipType> CheckSecretInformationRelationship(int characterId, int targetCharacterId)
	{
		return CheckSecretInformationRelationshipWithSnapshot(characterId, -1, targetCharacterId, -1);
	}

	public static HashSet<SecretInformationRelationshipType> CheckSecretInformationRelationshipWithSnapshot(int characterId, int selfMetaDataIdForSnapshot, int targetCharacterId, int targetMetaDataIdForSnapshot)
	{
		return DomainManager.Information.CheckSecretInformationRelationship(characterId, selfMetaDataIdForSnapshot, targetCharacterId, targetMetaDataIdForSnapshot);
	}

	public static int GetSecretInformationRelevanceMetaDataId(int metaDataId)
	{
		if (DomainManager.Information.TryGetElement_SecretInformationMetaData(metaDataId, out var element))
		{
			return element.GetRelevanceSecretInformationMetaDataId();
		}
		return -1;
	}

	public static sbyte GetSecretInformationCharacterFameTypeSnapshot(int metaDataId, int characterId)
	{
		if (DomainManager.Information.GetElement_SecretInformationMetaData(metaDataId).CharacterExtraInfoCollection.Collection.TryGetValue(characterId, out var value))
		{
			return value.FameType;
		}
		AdaptableLog.TagWarning("SecretInformation", $"GetCharacterExtraInfo Failed: MetaDataId[{metaDataId}] CharacterId[{characterId}]");
		return 0;
	}

	public static byte GetSecretInformationCharacterMonkTypeSnapshot(int metaDataId, int characterId)
	{
		if (DomainManager.Information.GetElement_SecretInformationMetaData(metaDataId).CharacterExtraInfoCollection.Collection.TryGetValue(characterId, out var value))
		{
			return value.MonkType;
		}
		AdaptableLog.TagWarning("SecretInformation", $"GetCharacterExtraInfo Failed: MetaDataId[{metaDataId}] CharacterId[{characterId}]");
		return 0;
	}

	public static OrganizationInfo GetSecretInformationCharacterSectSnapshot(int metaDataId, int characterId)
	{
		if (DomainManager.Information.GetElement_SecretInformationMetaData(metaDataId).CharacterExtraInfoCollection.Collection.TryGetValue(characterId, out var value))
		{
			return value.OrgInfo;
		}
		AdaptableLog.TagWarning("SecretInformation", $"GetCharacterExtraInfo Failed: MetaDataId[{metaDataId}] CharacterId[{characterId}]");
		return new OrganizationInfo(-1, -1, principal: true, -1);
	}

	public static List<short> GetSecretInformationAppliedStructs(short secretInformationAppliedStructGroupId, sbyte taiwuSecretInformationAppliedRelationId, sbyte oppositeSecretInformationAppliedRelationId)
	{
		return (from s in SecretInformationAppliedStruct.Instance
			where s != null && s.GroupTemplateId == secretInformationAppliedStructGroupId && s.TaiwuIndex == taiwuSecretInformationAppliedRelationId && s.CharIndex == oppositeSecretInformationAppliedRelationId
			select s.TemplateId).ToList();
	}

	public static IEnumerable<short> GetOrderedSecretInformationSelections(IEnumerable<short> selectionIds)
	{
		return selectionIds.OrderBy((short id) => SecretInformationAppliedSelection.Instance[id].Priority);
	}

	public static int GetSecretInformationAuthorityCostWhenDisseminating(int metaDataId, int characterId)
	{
		if (DomainManager.Information.TryGetElement_SecretInformationMetaData(metaDataId, out var element) && DomainManager.Information.TryGetElement_CharacterSecretInformation(characterId, out var value) && value.Collection.TryGetValue(metaDataId, out var value2) && DomainManager.Character.TryGetElement_Objects(characterId, out var element2))
		{
			short secretInformationTemplateId = DomainManager.Information.CalcSecretInformationTemplateId(element);
			return DomainManager.Information.CalcSecretInformationAuthorityCostWhenDisseminatingByCharacter(secretInformationTemplateId, element2.GetFameType(), DomainManager.Information.GetSecretInformationDisseminatingCountOfBranch(metaDataId, value2.SecretInformationDisseminationBranch));
		}
		return 0;
	}

	public static int GetThreatenEffect(int selfCharId, int targetCharId, int metaDataId, short templateId)
	{
		int result = -1;
		if (!DomainManager.Character.TryGetElement_Objects(selfCharId, out var element) || !DomainManager.Character.TryGetElement_Objects(targetCharId, out var _) || DomainManager.Character.GetFavorability(targetCharId, selfCharId) == short.MinValue)
		{
			return result;
		}
		short sortValue = SecretInformation.Instance.GetItem(templateId).SortValue;
		int num = sortValue * GlobalConfig.Instance.ThreatenEffectFactorOfSortValue;
		result = num;
		int num2 = -1;
		if (IsInAnySect(targetCharId))
		{
			SecretInformationProcessor secretInformationProcessor = DomainManager.Information.SecretInformationProcessorPool.Get();
			if (!secretInformationProcessor.Initialize(metaDataId))
			{
				AdaptableLog.Warning("Initialize SecretInfo ProcessorPool Failed!");
				DomainManager.Information.SecretInformationProcessorPool.Return(secretInformationProcessor);
			}
			num2 = secretInformationProcessor.CalSectPunishLevel_WithCharId(targetCharId);
			DomainManager.Information.SecretInformationProcessorPool.Return(secretInformationProcessor);
		}
		num2++;
		if (!IsInAnySect(targetCharId))
		{
			num2 = sortValue / 3;
		}
		result += result * num2 * 20 / 100;
		int num3 = GetSecretInformationHolderCount(metaDataId);
		byte maxPersonAmount = SecretInformation.Instance.GetItem(templateId).MaxPersonAmount;
		if (IsSecretInformationBroadcast(metaDataId))
		{
			num3 = maxPersonAmount;
		}
		int num4 = Math.Clamp(num3 * 50 / maxPersonAmount, 0, 50);
		result += result * num4 / 100;
		sbyte fame = element.GetFame();
		int num5 = Math.Abs(fame) / GlobalConfig.Instance.ThreatenEffectDenominatorOfFame;
		result += result * num5 / 100;
		return Math.Clamp(result, int.MinValue, int.MaxValue);
	}

	public static int GetThreatenDifficulty(int selfCharId, int targetCharId, int metaDataId)
	{
		int result = -1;
		if (!DomainManager.Character.TryGetElement_Objects(selfCharId, out var _) || !DomainManager.Character.TryGetElement_Objects(targetCharId, out var element2) || DomainManager.Character.GetFavorability(targetCharId, selfCharId) == short.MinValue)
		{
			return result;
		}
		sbyte grade = element2.GetOrganizationInfo().Grade;
		sbyte behaviorType = element2.GetBehaviorType();
		sbyte favorabilityType = FavorabilityType.GetFavorabilityType(DomainManager.Character.GetFavorability(targetCharId, selfCharId));
		int num = grade * GlobalConfig.Instance.ThreatenDifficultyFactorOfGrade;
		int num2 = GlobalConfig.Instance.ThreatenDifficultyFactorOfBehaviorType[behaviorType];
		int num3 = 0;
		if (favorabilityType > 0)
		{
			num3 = GlobalConfig.Instance.ThreatenDifficultyFactorOfPositiveFavorType[behaviorType];
		}
		if (favorabilityType < 0)
		{
			num3 = GlobalConfig.Instance.ThreatenDifficultyFactorOfNegativeFavorType[behaviorType];
		}
		return Math.Clamp(Math.Max(num + num3 * num2 / 100, 0), int.MinValue, int.MaxValue);
	}

	public static int GetThreatenFinaleDifficultyOfItem(int origDifficulty, ItemKey itemKey)
	{
		sbyte itemGrade = GetItemGrade(itemKey);
		return origDifficulty + (itemGrade + 1) * 2;
	}

	public static int GetThreatenFinalDifficultyOfEndRelation(int origDifficulty, int threatenedCharId, int nominatedCharId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var _) || !DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var _))
		{
			return origDifficulty;
		}
		short favorability = DomainManager.Character.GetFavorability(threatenedCharId, nominatedCharId);
		sbyte favorabilityType = FavorabilityType.GetFavorabilityType(favorability);
		return origDifficulty + favorabilityType * 2;
	}

	public static int GetThreatenFinalDifficultyOfMarry(int origDifficulty, int threatenedCharId, int nominatedCharId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(threatenedCharId, out var element) || !DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var element2))
		{
			return origDifficulty;
		}
		int num = 0;
		int num2 = 0;
		int num3 = 0;
		if (element.GetBisexual())
		{
			if (element2.GetGender() != element.GetGender() && element2.GetDisplayingGender() == element.GetDisplayingGender())
			{
				num = 6;
			}
		}
		else if (element2.GetGender() == element.GetGender() && element2.GetDisplayingGender() != element.GetDisplayingGender())
		{
			num = 6;
		}
		if (element.GetMonkType() != 0)
		{
			num2 = 6;
		}
		if (!element.OrgAndMonkTypeAllowMarriage())
		{
			num3 = 12;
		}
		return origDifficulty + num + num2 + num3;
	}

	public static List<string> GetCommonReplacedContentInThreatenSucceedEvent(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		sbyte roleBehavior = GetRoleBehavior(character);
		List<string> list = new List<string>();
		switch (roleBehavior)
		{
		case 0:
			list.Add("Event_SecretInformation_ThreatenSucceed_Just");
			break;
		case 1:
			list.Add("Event_SecretInformation_ThreatenSucceed_Kind");
			break;
		case 2:
			list.Add("Event_SecretInformation_ThreatenSucceed_Even");
			break;
		case 3:
			list.Add("Event_SecretInformation_ThreatenSucceed_Rebel");
			break;
		case 4:
			list.Add("Event_SecretInformation_ThreatenSucceed_Egoistic");
			break;
		}
		return list;
	}

	public static List<string> GetCommonReplacedContentInThreatenFailedEvent(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		sbyte roleBehavior = GetRoleBehavior(character);
		List<string> list = new List<string>();
		switch (roleBehavior)
		{
		case 0:
			list.Add("Event_SecretInformation_ThreatenFailed_Just");
			break;
		case 1:
			list.Add("Event_SecretInformation_ThreatenFailed_Kind");
			break;
		case 2:
			list.Add("Event_SecretInformation_ThreatenFailed_Even");
			break;
		case 3:
			list.Add("Event_SecretInformation_ThreatenFailed_Rebel");
			break;
		case 4:
			list.Add("Event_SecretInformation_ThreatenFailed_Egoistic");
			break;
		}
		return list;
	}

	private static int GetConfessLoveDifficultyInThreadNeedle(int selfCharId, int targetCharId, int oriDifficulty, bool isProPosal = false)
	{
		if (!DomainManager.Character.TryGetElement_Objects(selfCharId, out var element) || !DomainManager.Character.TryGetElement_Objects(targetCharId, out var element2))
		{
			return int.MinValue;
		}
		int num = 0;
		int num2 = 0;
		int num3 = 0;
		if (element2.GetBisexual())
		{
			if (element.GetGender() != element2.GetGender() && element.GetDisplayingGender() == element2.GetDisplayingGender())
			{
				num = 3;
				if (isProPosal)
				{
					num = 6;
				}
			}
		}
		else if (element.GetGender() == element2.GetGender() && element.GetDisplayingGender() != element2.GetDisplayingGender())
		{
			num = 3;
			if (isProPosal)
			{
				num = 6;
			}
		}
		if (element2.GetMonkType() != 0)
		{
			num2 = 3;
			if (isProPosal)
			{
				num2 = 6;
			}
		}
		if (!element2.OrgAndMonkTypeAllowMarriage())
		{
			num3 = 6;
			if (isProPosal)
			{
				num3 = 12;
			}
		}
		return oriDifficulty + num + num2 + num3;
	}

	private static int GetThreadNeedleDifficultyOfStartRelation(int targetCharId, int selectedCharId, ushort relationType, bool isBothWayRelation = true)
	{
		int result = int.MinValue;
		if (!DomainManager.Character.TryGetElement_Objects(targetCharId, out var element) || !DomainManager.Character.TryGetElement_Objects(selectedCharId, out var element2))
		{
			return result;
		}
		int gradeFactor_StartRelation_Difficulty = SecretInformationConfig.GradeFactor_StartRelation_Difficulty;
		int num = (element.GetOrganizationInfo().Grade + 1) * gradeFactor_StartRelation_Difficulty;
		int num2 = (element2.GetOrganizationInfo().Grade + 1) * gradeFactor_StartRelation_Difficulty;
		sbyte behaviorType = element.GetBehaviorType();
		sbyte behaviorType2 = element2.GetBehaviorType();
		int num3 = SecretInformationConfig.BehaviorAdjust_StartRelation_Difficulty[behaviorType];
		int num4 = SecretInformationConfig.BehaviorAdjust_StartRelation_Difficulty[behaviorType2];
		result = Math.Clamp(Math.Max(num + num3, num2 + num4), int.MinValue, int.MaxValue);
		short favorability = GetFavorability(element2, element);
		sbyte favorabilityType = FavorabilityType.GetFavorabilityType(favorability);
		int num5 = SecretInformationConfig.FavorFactor_StartRelation_Difficulty[behaviorType2];
		result += Math.Clamp(Math.Max(result - favorabilityType * num5 / 100, 0), int.MinValue, int.MaxValue);
		switch (relationType)
		{
		case 16384:
			if (isBothWayRelation)
			{
				return GetConfessLoveDifficultyInThreadNeedle(selectedCharId, targetCharId, result);
			}
			if (element.GetBisexual())
			{
				if (element2.GetGender() != element.GetGender() && element2.GetDisplayingGender() == element.GetDisplayingGender())
				{
					result += 3;
				}
			}
			else if (element2.GetGender() == element.GetGender() && element2.GetDisplayingGender() != element.GetDisplayingGender())
			{
				result += 3;
			}
			return result;
		case 64:
		case 128:
		case 512:
		case 2048:
		case 8192:
			return result;
		case 1024:
			if (element2.GetActualAge() < 16 || GetAliveSpouse(selectedCharId) != null || GetAliveSpouse(targetCharId) != null)
			{
				return int.MaxValue;
			}
			return GetConfessLoveDifficultyInThreadNeedle(selectedCharId, targetCharId, result, isProPosal: true);
		case 32768:
			return result - 12;
		default:
			return int.MinValue;
		}
	}

	private static int GetThreadNeedleDifficultyOfEndRelation(int targetCharId, int nominatedCharId, ushort relationType, bool isBothWayRelation = true)
	{
		int result = int.MinValue;
		if (!DomainManager.Character.TryGetElement_Objects(targetCharId, out var element) || !DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var element2))
		{
			return result;
		}
		int gradeFactor_EndRelation_Difficulty = SecretInformationConfig.GradeFactor_EndRelation_Difficulty;
		int num = (element.GetOrganizationInfo().Grade + 1) * gradeFactor_EndRelation_Difficulty;
		int num2 = (element2.GetOrganizationInfo().Grade + 1) * gradeFactor_EndRelation_Difficulty;
		sbyte behaviorType = element.GetBehaviorType();
		sbyte behaviorType2 = element2.GetBehaviorType();
		int num3 = SecretInformationConfig.BehaviorAdjust_EndRelation_Difficulty[behaviorType];
		int num4 = SecretInformationConfig.BehaviorAdjust_EndRelation_Difficulty[behaviorType2];
		result = Math.Clamp(Math.Max(num + num3, num2 + num4), int.MinValue, int.MaxValue);
		short favorability = GetFavorability(element2, element);
		sbyte favorabilityType = FavorabilityType.GetFavorabilityType(favorability);
		int num5 = SecretInformationConfig.FavorFactor_EndRelation_Difficulty[behaviorType2];
		result = Math.Clamp(Math.Max(result + favorabilityType * num5 / 100, 0), int.MinValue, int.MaxValue);
		short favorability2 = GetFavorability(element, element2);
		sbyte favorabilityType2 = FavorabilityType.GetFavorabilityType(favorability2);
		switch (relationType)
		{
		case 16384:
			if (isBothWayRelation)
			{
				return result + favorabilityType2 * 2;
			}
			return result + favorabilityType2;
		case 8192:
			return result + favorabilityType2;
		case 64:
		case 128:
		case 512:
		case 1024:
		case 2048:
			return result + favorabilityType2 * 2;
		case 32768:
			return result - 12;
		default:
			return int.MinValue;
		}
	}

	private static int GetThreadNeedleEffectOfStartRelation(int promotedCharId, int targetCharId, int nominatedCharId, int metaDataId)
	{
		int result = int.MinValue;
		if (!DomainManager.Character.TryGetElement_Objects(targetCharId, out var element) || !DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var _) || !DomainManager.Character.TryGetElement_Objects(promotedCharId, out var element3))
		{
			return result;
		}
		SecretInformationProcessor secretInformationProcessor = DomainManager.Information.SecretInformationProcessorPool.Get();
		if (!secretInformationProcessor.Initialize(metaDataId))
		{
			throw new Exception($"Can not Initialize Processor Of {metaDataId}!");
		}
		short secretInformationTemplateId = secretInformationProcessor.GetSecretInformationTemplateId();
		short sortValue = SecretInformation.Instance.GetItem(secretInformationTemplateId).SortValue;
		int sortValueFactor_StartRelation_Effect = SecretInformationConfig.SortValueFactor_StartRelation_Effect;
		result = sortValue * sortValueFactor_StartRelation_Effect;
		int num = GetSecretInformationHolderCount(metaDataId);
		int holderCountFactor_StartRelation_Effect = SecretInformationConfig.HolderCountFactor_StartRelation_Effect;
		byte maxPersonAmount = SecretInformation.Instance.GetItem(secretInformationTemplateId).MaxPersonAmount;
		if (IsSecretInformationBroadcast(metaDataId))
		{
			num = maxPersonAmount;
		}
		int num2 = Math.Clamp(num * holderCountFactor_StartRelation_Effect / maxPersonAmount, 0, 50);
		result = result * (100 + num2) / 100;
		short favorability = GetFavorability(element, element3);
		sbyte favorabilityType = FavorabilityType.GetFavorabilityType(favorability);
		sbyte behaviorType = element.GetBehaviorType();
		int num3 = SecretInformationConfig.FavorFactor_StartRelation_Effect[behaviorType];
		result = Math.Max(result + favorabilityType * num3 / 100, 0);
		sbyte fame = element3.GetFame();
		int fameDenominator_StartRelation_Effect = SecretInformationConfig.FameDenominator_StartRelation_Effect;
		int num4 = fame / fameDenominator_StartRelation_Effect;
		return result * (100 + num4) / 100;
	}

	private static int GetThreadNeedleEffectOfEndRelation(int promotedCharId, int targetCharId, int nominatedCharId, int metaDataId)
	{
		int result = int.MinValue;
		if (!DomainManager.Character.TryGetElement_Objects(targetCharId, out var element) || !DomainManager.Character.TryGetElement_Objects(nominatedCharId, out var _) || !DomainManager.Character.TryGetElement_Objects(promotedCharId, out var element3))
		{
			return result;
		}
		SecretInformationProcessor secretInformationProcessor = DomainManager.Information.SecretInformationProcessorPool.Get();
		if (!secretInformationProcessor.Initialize(metaDataId))
		{
			throw new Exception($"Can not Initialize Processor Of {metaDataId}!");
		}
		short secretInformationTemplateId = secretInformationProcessor.GetSecretInformationTemplateId();
		short sortValue = SecretInformation.Instance.GetItem(secretInformationTemplateId).SortValue;
		int sortValueFactor_EndRelation_Effect = SecretInformationConfig.SortValueFactor_EndRelation_Effect;
		result = sortValue * sortValueFactor_EndRelation_Effect;
		int num = GetSecretInformationHolderCount(metaDataId);
		int holderCountFactor_EndRelation_Effect = SecretInformationConfig.HolderCountFactor_EndRelation_Effect;
		byte maxPersonAmount = SecretInformation.Instance.GetItem(secretInformationTemplateId).MaxPersonAmount;
		if (IsSecretInformationBroadcast(metaDataId))
		{
			num = maxPersonAmount;
		}
		int num2 = Math.Clamp(num * holderCountFactor_EndRelation_Effect / maxPersonAmount, 0, 50);
		result = result * (100 + num2) / 100;
		short favorability = GetFavorability(element, element3);
		sbyte favorabilityType = FavorabilityType.GetFavorabilityType(favorability);
		sbyte behaviorType = element.GetBehaviorType();
		int num3 = SecretInformationConfig.FavorFactor_EndRelation_Effect[behaviorType];
		result = Math.Max(result + favorabilityType * num3 / 100, 0);
		sbyte fame = element3.GetFame();
		int fameDenominator_EndRelation_Effect = SecretInformationConfig.FameDenominator_EndRelation_Effect;
		int num4 = fame / fameDenominator_EndRelation_Effect;
		return result * (100 + num4) / 100;
	}

	public static int ApplyThreadNeedle_StartRelation(EventArgBox argBox, ushort relationType, bool isBothWayRelation = true)
	{
		int taiwuCharacterId = EventArgBox.TaiwuCharacterId;
		int arg = -1;
		argBox.Get("CharacterId", ref arg);
		int arg2 = -1;
		argBox.Get("SelectedCharIdForThreadNeedleAdding", ref arg2);
		int arg3 = -1;
		argBox.Get("metaDataIdForThreaten", ref arg3);
		if (taiwuCharacterId == -1 || arg == -1 || arg2 == -1 || arg3 == -1)
		{
			throw new Exception("Wrong Ids In ThreadNeedle Event !");
		}
		int num = int.MinValue;
		int num2 = int.MinValue;
		if (relationType != 32768)
		{
			num = GetThreadNeedleDifficultyOfStartRelation(arg, arg2, relationType, isBothWayRelation);
			num2 = GetThreadNeedleEffectOfStartRelation(taiwuCharacterId, arg, arg2, arg3);
		}
		else
		{
			num = GetThreadNeedleDifficultyOfEndRelation(arg, arg2, relationType, isBothWayRelation);
			num2 = GetThreadNeedleEffectOfEndRelation(taiwuCharacterId, arg, arg2, arg3);
		}
		if (num == int.MinValue || num2 == int.MinValue)
		{
			throw new Exception("Wrong Values Of ThreadNeedle Event!");
		}
		CostSecretInformationUsedCount(taiwuCharacterId, arg3);
		if (num2 >= num)
		{
			if (CheckStartRelationSucceed(arg, arg2, relationType, isBothWayRelation))
			{
				if (taiwuCharacterId == arg2)
				{
					ApplyStartRelationByThreadNeedle(arg, arg2, relationType, succeed: true, isBothWayRelation);
					return 3;
				}
				ApplyStartRelationByThreadNeedle(arg, arg2, relationType, succeed: true, isBothWayRelation);
				return 4;
			}
			ApplyStartRelationByThreadNeedle(arg, arg2, relationType, succeed: false, isBothWayRelation);
			return 2;
		}
		if (taiwuCharacterId == arg2)
		{
			return 0;
		}
		return 1;
	}

	public static int ApplyThreadNeedle_EndRelation(EventArgBox argBox, ushort relationType, bool isBothWayRelation = true)
	{
		int taiwuCharacterId = EventArgBox.TaiwuCharacterId;
		int arg = -1;
		argBox.Get("CharacterId", ref arg);
		int arg2 = -1;
		argBox.Get("SelectedCharIdForThreadNeedleEnding", ref arg2);
		int arg3 = -1;
		argBox.Get("metaDataIdForThreaten", ref arg3);
		if (taiwuCharacterId == -1 || arg == -1 || arg2 == -1 || arg3 == -1)
		{
			throw new Exception("Wrong Ids In ThreadNeedle Event !");
		}
		int num = int.MinValue;
		int num2 = int.MinValue;
		if (relationType != 32768)
		{
			num = GetThreadNeedleDifficultyOfEndRelation(arg, arg2, relationType, isBothWayRelation);
			num2 = GetThreadNeedleEffectOfEndRelation(taiwuCharacterId, arg, arg2, arg3);
		}
		else
		{
			num = GetThreadNeedleDifficultyOfStartRelation(arg, arg2, relationType, isBothWayRelation);
			num2 = GetThreadNeedleEffectOfStartRelation(taiwuCharacterId, arg, arg2, arg3);
		}
		if (num == int.MinValue || num2 == int.MinValue)
		{
			throw new Exception("Wrong Values Of ThreadNeedle Event!");
		}
		CostSecretInformationUsedCount(taiwuCharacterId, arg3);
		if (num2 >= num)
		{
			if (CheckEndRelationSucceed(arg, arg2, relationType, isBothWayRelation))
			{
				if (taiwuCharacterId == arg2)
				{
					ApplyEndRelationByThreadNeedle(arg, arg2, relationType, succeed: true, isBothWayRelation);
					return 8;
				}
				ApplyEndRelationByThreadNeedle(arg, arg2, relationType, succeed: true, isBothWayRelation);
				return 9;
			}
			if (relationType == 16384 || relationType == 32768)
			{
				ApplyEndRelationByThreadNeedle(arg, arg2, relationType, succeed: false, isBothWayRelation);
				return 9;
			}
			return 7;
		}
		if (taiwuCharacterId == arg2)
		{
			return 5;
		}
		return 6;
	}

	public static EventArgBox GetSectMainStoryEventArgBox(sbyte orgTemplateId)
	{
		return DomainManager.Extra.GetSectMainStoryEventArgBox(orgTemplateId);
	}

	public static void SaveSectMainStoryEventArgBox(sbyte orgTemplateId)
	{
		DomainManager.Extra.SaveSectMainStoryEventArgumentBox(Domain.MainThreadDataContext, orgTemplateId);
	}

	public static void SaveArgToSectMainStory<T>(sbyte orgTemplateId, string key, T value)
	{
		DomainManager.Extra.SaveArgToSectMainStoryEventArgBox(Domain.MainThreadDataContext, orgTemplateId, key, value);
	}

	public static void RemoveArgFromSectMainStory<T>(sbyte orgTemplateId, string key)
	{
		DomainManager.Extra.RemoveArgToSectMainStoryEventArgBox<T>(Domain.MainThreadDataContext, orgTemplateId, key);
	}

	public static int GetSectMainStoryActiveStatus(sbyte orgTemplateId)
	{
		return DomainManager.World.GetSectMainStoryActiveStatus(orgTemplateId);
	}

	public static void SetSectMainStoryActiveStatus(sbyte orgTemplateId, bool pause)
	{
		DomainManager.World.SetSectMainStoryActiveStatus(orgTemplateId, pause);
	}

	public static void InvestSectForMartialArtTournament(sbyte orgTemplateId, sbyte preparationType, int amount)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Sect sect = (Sect)DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId);
		int[] taiwuInvestmentForMartialArtTournament = sect.GetTaiwuInvestmentForMartialArtTournament();
		taiwuInvestmentForMartialArtTournament[preparationType] += amount;
		sect.SetTaiwuInvestmentForMartialArtTournament(taiwuInvestmentForMartialArtTournament, mainThreadDataContext);
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		OrgMemberCollection members = sect.GetMembers();
		SortedList<long, int> sortedList = new SortedList<long, int>();
		for (sbyte b = 0; b < 8; b++)
		{
			HashSet<int> members2 = members.GetMembers(b);
			foreach (int item in members2)
			{
				SectCharacter element_SectCharacters = DomainManager.Organization.GetElement_SectCharacters(item);
				if (!element_SectCharacters.GetApprovedTaiwu())
				{
					short favorability = DomainManager.Character.GetFavorability(item, taiwuCharId);
					sortedList.Add(((long)favorability << 32) + item, item);
				}
			}
		}
		if (sortedList.Count != 0)
		{
			int num = Math.Max(0, sortedList.Count - 1 - 3);
			int index = mainThreadDataContext.Random.Next(num, sortedList.Count);
			int objectId = sortedList.Values[index];
			SectCharacter element_SectCharacters2 = DomainManager.Organization.GetElement_SectCharacters(objectId);
			element_SectCharacters2.SetApprovedTaiwu(mainThreadDataContext, approve: true);
		}
	}

	public static bool IsSectPreparingForMartialArtTournament(sbyte orgTemplateId)
	{
		short settlementId = DomainManager.Organization.GetSettlementIdByOrgTemplateId(orgTemplateId);
		List<MartialArtTournamentPreparationInfo> martialArtTournamentPreparationInfoList = DomainManager.Organization.GetMartialArtTournamentPreparationInfoList();
		return martialArtTournamentPreparationInfoList.FindIndex((MartialArtTournamentPreparationInfo info) => info.SettlementId == settlementId) >= 0;
	}

	public static List<GameData.Domains.Character.Character> GetSectCharList(sbyte sectId, sbyte minGrade = 0, sbyte maxGrade = 8)
	{
		return GetSectCharListWithInfantFilter(sectId, minGrade, maxGrade, includeInfant: true);
	}

	public static List<GameData.Domains.Character.Character> GetSectCharListWithInfantFilter(sbyte sectId, sbyte minGrade = 0, sbyte maxGrade = 8, bool includeInfant = false)
	{
		List<GameData.Domains.Character.Character> result = new List<GameData.Domains.Character.Character>();
		short settlementIdByOrgTemplateId = DomainManager.Organization.GetSettlementIdByOrgTemplateId(sectId);
		DomainManager.Organization.GetCharactersFromSettlementWithInfantFilter(settlementIdByOrgTemplateId, minGrade, maxGrade, result, includeInfant);
		return result;
	}

	public static GameData.Domains.Character.Character TryGetSectLeaderAtLocation(Location location, sbyte orgTemplateId, bool includeAllBlocksInGroup)
	{
		if (!location.IsValid() || !OrganizationDomain.IsSect(orgTemplateId))
		{
			return null;
		}
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId);
		GameData.Domains.Character.Character leader = settlementByOrgTemplateId.GetLeader();
		if (leader == null)
		{
			return null;
		}
		int id = leader.GetId();
		Location location2 = leader.GetLocation();
		if (location2.AreaId != location.AreaId)
		{
			return null;
		}
		MapBlockData block = DomainManager.Map.GetBlock(location);
		if (location.BlockId == location2.BlockId && block.CharacterSet != null && block.CharacterSet.Contains(id))
		{
			return leader;
		}
		if (includeAllBlocksInGroup)
		{
			MapBlockData rootBlock = block.GetRootBlock();
			if (rootBlock != block && rootBlock.BlockId == location2.BlockId && rootBlock.CharacterSet != null && rootBlock.CharacterSet.Contains(id))
			{
				return leader;
			}
			if (rootBlock.GroupBlockList != null)
			{
				for (int i = 0; i < rootBlock.GroupBlockList.Count; i++)
				{
					MapBlockData mapBlockData = rootBlock.GroupBlockList[i];
					if (mapBlockData.BlockId == location2.BlockId && mapBlockData.CharacterSet != null && mapBlockData.CharacterSet.Contains(id))
					{
						return leader;
					}
				}
			}
		}
		return null;
	}

	public static GameData.Domains.Character.Character TryGetSectMemberAtLocation(Location location, sbyte orgTemplateId, sbyte minGrade, sbyte maxGrade = -1, bool mustAdult = true, bool alsoCheckRoot = false, bool alsoCheckBelong = false)
	{
		if (!location.IsValid())
		{
			return null;
		}
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		minGrade = Math.Clamp(minGrade, 0, 8);
		maxGrade = Math.Max(maxGrade, minGrade);
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		List<GameData.Domains.Character.Character> list2 = ObjectPool<List<GameData.Domains.Character.Character>>.Instance.Get();
		if (alsoCheckBelong)
		{
			DomainManager.Map.QueryRegularBelongBlocks(list, location, true, MapDomain.QueryFilterAnyCharacter);
		}
		else if (alsoCheckRoot)
		{
			DomainManager.Map.QueryRootBlocks(list, location);
		}
		else
		{
			list.Add(DomainManager.Map.GetBlock(location));
		}
		foreach (MapBlockData item in list)
		{
			HashSet<int> characterSet = item.CharacterSet;
			if (characterSet == null || characterSet.Count <= 0)
			{
				continue;
			}
			foreach (int item2 in item.CharacterSet)
			{
				if (DomainManager.Character.TryGetElement_Objects(item2, out var element) && (!mustAdult || element.GetAgeGroup() == 2))
				{
					OrganizationInfo organizationInfo = element.GetOrganizationInfo();
					if (organizationInfo.OrgTemplateId == orgTemplateId && organizationInfo.Grade >= minGrade && organizationInfo.Grade <= maxGrade)
					{
						list2.Add(element);
					}
				}
			}
		}
		GameData.Domains.Character.Character result = ((list2.Count > 0) ? list2.GetRandom(mainThreadDataContext.Random) : null);
		ObjectPool<List<MapBlockData>>.Instance.Return(list);
		ObjectPool<List<GameData.Domains.Character.Character>>.Instance.Return(list2);
		return result;
	}

	public static bool CharacterIsOrganizationLeader(GameData.Domains.Character.Character character, sbyte orgTemplateId)
	{
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId);
		GameData.Domains.Character.Character leader = settlementByOrgTemplateId.GetLeader();
		if (leader == null)
		{
			return false;
		}
		return leader.GetId() == character.GetId();
	}

	public static GameData.Domains.Character.Character GetOrganizationLeader(sbyte orgTemplateId)
	{
		return DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId)?.GetLeader();
	}

	public static GameData.Domains.Character.Character GetOrganizationHighestMember(sbyte orgTemplateId)
	{
		return DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId)?.GetAvailableHighMember(8, 0);
	}

	public static bool CharacterIsOrganizationHigh(GameData.Domains.Character.Character character, sbyte orgTemplateId)
	{
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		return organizationInfo.Grade >= 6 && organizationInfo.OrgTemplateId == orgTemplateId;
	}

	[Obsolete("Use EventHelper.TryGetSectLeaderAtLocation instead")]
	public static GameData.Domains.Character.Character FindLeaderOfTargetOrganizationAtLocation(Location location, short templateId, bool includeAllRelatedLocations)
	{
		return TryGetSectLeaderAtLocation(location, (sbyte)templateId, includeAllRelatedLocations);
	}

	public static void SetSectCharApprovedTaiwu(int charId, bool approved = true)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Character.TryCreateRelation(mainThreadDataContext, charId, DomainManager.Taiwu.GetTaiwuCharId());
		DomainManager.Organization.TryGetElement_SectCharacters(charId, out var element);
		element?.SetApprovedTaiwu(mainThreadDataContext, approved);
	}

	public static void AddSectMemberFeature(int charId, sbyte orgTemplateId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		OrganizationInfo dstOrgInfo = new OrganizationInfo(orgTemplateId, 3, principal: true, -1);
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			DomainManager.Organization.TryAddSectMemberFeature(mainThreadDataContext, element, dstOrgInfo);
		}
	}

	public static bool IsLocationHasTargetSectCharacter(Location location, short orgTemplateId)
	{
		MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
		if (blockData.CharacterSet == null)
		{
			return false;
		}
		foreach (int item in blockData.CharacterSet)
		{
			if (item >= 0)
			{
				GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(item);
				if (element_Objects.GetOrganizationInfo().OrgTemplateId == orgTemplateId)
				{
					return true;
				}
			}
		}
		return false;
	}

	public static int GetTargetSectCharacterAtLocation(Location location, short orgTemplateId, sbyte grade = -1)
	{
		MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
		if (blockData.CharacterSet == null)
		{
			return -1;
		}
		foreach (int item in blockData.CharacterSet)
		{
			if (item >= 0)
			{
				GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(item);
				OrganizationInfo organizationInfo = element_Objects.GetOrganizationInfo();
				if ((grade <= 0 || organizationInfo.Grade == grade) && organizationInfo.OrgTemplateId == orgTemplateId)
				{
					return item;
				}
			}
		}
		return -1;
	}

	public static short GetSectApprovingRate(sbyte sectTemplateId)
	{
		return DomainManager.Organization.GetSettlementByOrgTemplateId(sectTemplateId).CalcApprovingRate();
	}

	public static short CalcSpiritualDebtActualCost(sbyte orgTemplateId, short baseCost)
	{
		if (!OrganizationDomain.IsSect(orgTemplateId))
		{
			return baseCost;
		}
		short sectApprovingRate = GetSectApprovingRate(orgTemplateId);
		if (sectApprovingRate > 800)
		{
			return (short)(baseCost / 2);
		}
		return baseCost;
	}

	public static List<GameData.Domains.Character.Character> SetSectMemberApproveTaiwu(sbyte sectId, byte countMax, sbyte gradeMin = 0, sbyte gradeMax = 8)
	{
		List<GameData.Domains.Character.Character> sectCharListWithInfantFilter = GetSectCharListWithInfantFilter(sectId, 0, 8);
		for (int num = sectCharListWithInfantFilter.Count - 1; num >= 0; num--)
		{
			if (!IsSectCharApprovedTaiwu(sectCharListWithInfantFilter[num].GetId()))
			{
				OrganizationInfo organizationInfo = sectCharListWithInfantFilter[num].GetOrganizationInfo();
				if (organizationInfo.Grade > gradeMax || organizationInfo.Grade < gradeMin)
				{
					sectCharListWithInfantFilter.RemoveAt(num);
				}
			}
		}
		countMax = (byte)Math.Min(countMax, sectCharListWithInfantFilter.Count);
		List<GameData.Domains.Character.Character> list = new List<GameData.Domains.Character.Character>();
		CollectionUtils.Shuffle(Domain.MainThreadDataContext.Random, sectCharListWithInfantFilter);
		for (int i = 0; i < countMax; i++)
		{
			SetSectCharApprovedTaiwu(sectCharListWithInfantFilter[i].GetId());
			list.Add(sectCharListWithInfantFilter[i]);
		}
		return list;
	}

	public static void SetSectAllowLearning(sbyte sectId)
	{
		short id = DomainManager.Organization.GetSettlementByOrgTemplateId(sectId).GetId();
		DomainManager.Organization.GetElement_Sects(id).SetTaiwuExploreStatus(2, Domain.MainThreadDataContext);
		AddLegacyPoint(36);
	}

	public static void SetSectSpiritualDebtInteractionOccurred(sbyte sectId)
	{
		short id = DomainManager.Organization.GetSettlementByOrgTemplateId(sectId).GetId();
		DomainManager.Organization.GetElement_Sects(id).SetSpiritualDebtInteractionOccurred(spiritualDebtInteractionOccurred: true, Domain.MainThreadDataContext);
	}

	public static void RecommendPupil(int charId, GameData.Domains.Character.Character student, short settlementId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		ChangeRoleResource(taiwu, 7, -200);
		RequestRoleLeaveGroup(charId);
		JoinOrganization(student, settlementId, 0);
		OrganizationMemberItem orgMemberConfig = OrganizationDomain.GetOrgMemberConfig(student.GetOrganizationInfo());
		int addSeniority = 0;
		for (sbyte b = 0; b < orgMemberConfig.LifeSkillsAdjust.Length; b++)
		{
			short num = orgMemberConfig.LifeSkillsAdjust[b];
			if (num >= 0)
			{
				short lifeSkillQualification = student.GetLifeSkillQualification(b);
				AddSeniority(lifeSkillQualification, num);
			}
		}
		for (sbyte b2 = 0; b2 < orgMemberConfig.CombatSkillsAdjust.Length; b2++)
		{
			short num2 = orgMemberConfig.CombatSkillsAdjust[b2];
			if (num2 >= 0)
			{
				short combatSkillQualification = student.GetCombatSkillQualification(b2);
				AddSeniority(combatSkillQualification, num2);
			}
		}
		for (sbyte b3 = 0; b3 < orgMemberConfig.MainAttributesAdjust.Length; b3++)
		{
			short num3 = orgMemberConfig.MainAttributesAdjust[b3];
			if (num3 >= 0)
			{
				short maxMainAttribute = student.GetMaxMainAttribute(b3);
				AddSeniority(maxMainAttribute, num3);
			}
		}
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		if (addSeniority > 0)
		{
			DomainManager.Extra.ChangeProfessionSeniority(mainThreadDataContext, 8, addSeniority);
		}
		void AddSeniority(short value, short adjust)
		{
			ProfessionFormulaItem formulaCfg = ProfessionFormula.Instance[58];
			addSeniority += formulaCfg.Calculate(value, adjust);
		}
	}

	public static void JoinOrganization(GameData.Domains.Character.Character character, short settlementId, sbyte grade)
	{
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		if (organizationInfo.OrgTemplateId == settlement.GetOrgTemplateId())
		{
			if (organizationInfo.Grade != grade)
			{
				DomainManager.Organization.ChangeGrade(Domain.MainThreadDataContext, character, grade, destPrincipal: true);
			}
			return;
		}
		OrganizationInfo destOrgInfo = new OrganizationInfo
		{
			OrgTemplateId = settlement.GetOrgTemplateId(),
			Grade = grade,
			SettlementId = settlementId,
			Principal = true
		};
		DomainManager.Organization.ChangeOrganization(Domain.MainThreadDataContext, character, destOrgInfo);
	}

	public static void ChangeOrganization(GameData.Domains.Character.Character character, OrganizationInfo destOrgInfo)
	{
		DomainManager.Organization.ChangeOrganization(Domain.MainThreadDataContext, character, destOrgInfo);
	}

	public static void PunishSectMember(sbyte orgTemplateId, GameData.Domains.Character.Character character, sbyte punishmentSeverity = -1, short punishmentType = -1, bool isArrested = false)
	{
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId);
		if (settlementByOrgTemplateId is Sect sect)
		{
			DomainManager.Organization.PunishSectMember(Domain.MainThreadDataContext, sect, character, punishmentSeverity, punishmentType, isArrested);
		}
	}

	public static void JoinSpouseOrganization(GameData.Domains.Character.Character selfChar, GameData.Domains.Character.Character spouseChar)
	{
		DomainManager.Organization.JoinSpouseOrganization(Domain.MainThreadDataContext, selfChar, spouseChar);
	}

	public static void ChangeOrganizationGrade(int charId, int changeValue)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		OrganizationInfo organizationInfo = element_Objects.GetOrganizationInfo();
		sbyte b = (sbyte)Math.Clamp(organizationInfo.Grade + changeValue, 0, 8);
		if (!organizationInfo.Principal)
		{
			OrganizationItem organizationItem = Config.Organization.Instance[organizationInfo.OrgTemplateId];
			OrganizationMemberItem organizationMemberItem = OrganizationMember.Instance[organizationItem.Members[b]];
			if (string.IsNullOrEmpty(organizationMemberItem.SpouseAnonymousTitles[0]))
			{
				organizationInfo.Principal = true;
			}
		}
		DomainManager.Organization.ChangeGrade(mainThreadDataContext, element_Objects, b, organizationInfo.Principal);
		int aliveSpouse = DomainManager.Character.GetAliveSpouse(charId);
		if (aliveSpouse >= 0)
		{
			GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(aliveSpouse);
			DomainManager.Organization.UpdateGradeAccordingToSpouse(mainThreadDataContext, element_Objects2, element_Objects);
		}
	}

	public static void EndAllMentorAndMenteeRelations(int charId, short orgTemplateId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		HashSet<int> relatedCharIds = DomainManager.Character.GetRelatedCharIds(charId, 2048);
		HashSet<int> relatedCharIds2 = DomainManager.Character.GetRelatedCharIds(charId, 4096);
		foreach (int item in relatedCharIds)
		{
			DomainManager.Character.ChangeRelationType(mainThreadDataContext, charId, item, 2048, 0);
			if (DomainManager.Character.TryGetElement_Objects(item, out var element) && element != null)
			{
				DomainManager.Character.ChangeRelationType(mainThreadDataContext, item, charId, 4096, 0);
			}
		}
		foreach (int item2 in relatedCharIds2)
		{
			DomainManager.Character.ChangeRelationType(mainThreadDataContext, charId, item2, 4096, 0);
			if (DomainManager.Character.TryGetElement_Objects(item2, out var element2) && element2 != null)
			{
				DomainManager.Character.ChangeRelationType(mainThreadDataContext, item2, charId, 2048, 0);
			}
		}
	}

	public static void SectPunishment(int charId, sbyte punishLevel)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		if (DomainManager.Organization.TryGetElement_Sects(element_Objects.GetOrganizationInfo().SettlementId, out var element))
		{
			DomainManager.Organization.PunishSectMember(mainThreadDataContext, element, element_Objects, punishLevel, -1);
		}
	}

	public static void AddMaxApprovingRateBonus(short settlementId, short bonus, int duration)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		if (duration < 0)
		{
			Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
			short approvingRateUpperLimitBonus = settlement.GetApprovingRateUpperLimitBonus();
			approvingRateUpperLimitBonus += bonus;
			settlement.SetApprovingRateUpperLimitBonus(approvingRateUpperLimitBonus, mainThreadDataContext);
		}
		else
		{
			DomainManager.Extra.AddMaxApprovingRateTempBonus(mainThreadDataContext, settlementId, bonus, duration);
		}
	}

	public static GameData.Domains.Character.Character GetSectCharacter(Location location, sbyte orgTemplateId, sbyte minGrade, sbyte maxGrade)
	{
		Tester.Assert(!location.Equals(Location.Invalid));
		MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
		HashSet<int> characterSet = blockData.CharacterSet;
		foreach (int item in characterSet)
		{
			GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(item);
			OrganizationInfo organizationInfo = element_Objects.GetOrganizationInfo();
			if (organizationInfo.OrgTemplateId != orgTemplateId || organizationInfo.Grade < minGrade || organizationInfo.Grade > maxGrade)
			{
				continue;
			}
			return element_Objects;
		}
		return null;
	}

	public static void AddMartialArtTournamentWinnerPrize(sbyte sectId)
	{
		if (OrganizationDomain.IsSect(sectId))
		{
			MartialArtTournamentMonthlyAction.AddMartialArtTournamentWinnerPrize(Domain.MainThreadDataContext, sectId);
		}
	}

	public static bool HaveGotSectCompetitionClothing(short organizationId)
	{
		string key = "ConchShip_PresetKey_SectCompetitionClothing" + GetSectCompetitionClothingTemplateId(organizationId);
		return GlobalArgBoxContainsKey<bool>(key);
	}

	public static void SaveSectCompetitionClothing(short organizationId)
	{
		string key = "ConchShip_PresetKey_SectCompetitionClothing" + GetSectCompetitionClothingTemplateId(organizationId);
		SaveGlobalArg(key, value: true);
	}

	public static short GetSectCompetitionClothingTemplateId(short organizationId)
	{
		sbyte xiangshuLevel = DomainManager.World.GetXiangshuLevel();
		int num = 0;
		if (xiangshuLevel >= 2)
		{
			num = 0;
		}
		if (xiangshuLevel >= 4)
		{
			num = 1;
		}
		if (xiangshuLevel >= 6)
		{
			num = 2;
		}
		int num2 = 18;
		int num3 = (organizationId - 1) * 3 + num2 + num;
		if (organizationId > 4)
		{
			num3++;
		}
		return (short)num3;
	}

	public static void GetSectCompetitionRewards(EventArgBox argBox, bool getExtra, bool getFeature, bool getClothing)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location validLocation = taiwu.GetValidLocation();
		int adventureParameter = GetAdventureParameter("sustainDegree");
		int num = Math.Min(adventureParameter / 20, 5);
		sbyte stateIdByAreaId = GetStateIdByAreaId(validLocation.AreaId);
		sbyte stateSectOrgTemplateId = GetStateSectOrgTemplateId(stateIdByAreaId);
		sbyte arg = 0;
		argBox.Get("LearnGrade", ref arg);
		sbyte gradeMax = Math.Min(8, arg);
		List<GameData.Domains.Character.Character> list = SetSectMemberApproveTaiwu(stateSectOrgTemplateId, (byte)num, 0, gradeMax);
		foreach (GameData.Domains.Character.Character item in list)
		{
			ChangeFavorabilityOptionalStoryEvent(item, argBox.GetCharacter("RoleTaiwu"), (short)GetRandom(3, 6001));
		}
		short belongSettlementId = GetBelongSettlementId(validLocation.AreaId, validLocation.BlockId);
		AddMaxApprovingRateBonus(belongSettlementId, 100, 36);
		if (getClothing)
		{
			short sectCompetitionClothingTemplateId = GetSectCompetitionClothingTemplateId(stateSectOrgTemplateId);
			ItemKey itemKey = CreateItem(3, sectCompetitionClothingTemplateId);
			string key = "ConchShip_PresetKey_SectCompetitionClothing" + sectCompetitionClothingTemplateId;
			SaveGlobalArg(key, value: true);
			argBox.Set("GetItemKey", (ISerializableGameData)(object)itemKey);
			AddItemToRole(taiwu, itemKey, 1, -1);
		}
		if (getExtra)
		{
			if (getFeature)
			{
				taiwu.AddFeature(Domain.MainThreadDataContext, GetOrganizationMenteeFeature(stateSectOrgTemplateId));
			}
			else
			{
				GetExpRewardInCombatMatch(argBox);
			}
		}
	}

	public static void GetExpRewardInCombatMatch(EventArgBox argBox)
	{
		int arg = -1;
		if (argBox.Get("HostId", ref arg) && DomainManager.Character.TryGetElement_Objects(arg, out var element))
		{
			sbyte grade = element.GetOrganizationInfo().Grade;
			int num = (1 + grade) * (1 + grade) * (1 + grade) * 20;
			ChangeRoleExp(DomainManager.Taiwu.GetTaiwu(), num);
			argBox.Set("ExpReward", num);
		}
	}

	public static short GetOrganizationMenteeFeature(short organizationTemplateId)
	{
		return (short)(organizationTemplateId - 1 + 499);
	}

	public static int CalcSectCharApprovedTaiwuDebtCost(GameData.Domains.Character.Character character)
	{
		sbyte roleGrade = GetRoleGrade(character);
		return (20 + roleGrade * 10) * 10;
	}

	public static int CalcSectCharApprovedTaiwuMoneyCost(GameData.Domains.Character.Character character)
	{
		sbyte roleGrade = GetRoleGrade(character);
		return (1 + roleGrade) * (1 + roleGrade) * (1 + roleGrade) * 100;
	}

	public static int GetResourceCostInSectCombatMatch(GameData.Domains.Character.Character character, sbyte type = -1)
	{
		sbyte roleGrade = GetRoleGrade(character);
		if (1 == 0)
		{
		}
		int num = type switch
		{
			-1 => 50, 
			7 => 10, 
			6 => 100, 
			_ => 20, 
		};
		if (1 == 0)
		{
		}
		int num2 = num;
		return (1 + roleGrade) * (1 + roleGrade) * (1 + roleGrade) * num2;
	}

	public static int GetResourceCostInSectCombatMatch(int charId, sbyte type = -1)
	{
		return GetResourceCostInSectCombatMatch(DomainManager.Character.GetElement_Objects(charId), type);
	}

	public static int SetSectCombatMatchEnemy(short orgTemplateId, EventArgBox argBox)
	{
		if (1 == 0)
		{
		}
		short num2;
		switch (orgTemplateId)
		{
		case 2:
			num2 = 325;
			break;
		case 6:
			num2 = 357;
			break;
		case 7:
			num2 = 365;
			break;
		case 9:
			num2 = 381;
			break;
		case 10:
			num2 = 389;
			break;
		case 11:
			num2 = 397;
			break;
		case 14:
			num2 = 421;
			break;
		case 5:
		{
			int random2 = GetRandom(0, 5);
			if (1 == 0)
			{
			}
			short num = random2 switch
			{
				0 => 397, 
				1 => 405, 
				2 => 413, 
				3 => 421, 
				_ => 429, 
			};
			if (1 == 0)
			{
			}
			num2 = num;
			break;
		}
		case 15:
		{
			int random = GetRandom(0, 5);
			if (1 == 0)
			{
			}
			short num = random switch
			{
				0 => 317, 
				1 => 325, 
				2 => 333, 
				3 => 341, 
				_ => 349, 
			};
			if (1 == 0)
			{
			}
			num2 = num;
			break;
		}
		default:
			throw new Exception($"Invalid organization template id {orgTemplateId}");
		}
		if (1 == 0)
		{
		}
		short beginTemplateId = num2;
		short templateIdOfFixedCharacterCombatWith = SectMainStoryRelatedConstants.GetTemplateIdOfFixedCharacterCombatWith(beginTemplateId, 7, consummateLevelIncrease: false);
		int num3 = CreateNonIntelligentCharacter(templateIdOfFixedCharacterCombatWith);
		argBox.Set("Disciple", num3);
		return num3;
	}

	public static void SetToRepayKindessChar(EventArgBox argBox)
	{
		int arg = -1;
		if (argBox.Get("Disciple", ref arg))
		{
			GameData.Domains.Character.Character characterById = GetCharacterById(arg);
			GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
			OrganizationInfo organizationInfo = characterById.GetOrganizationInfo();
			ConvertRandomEnemy(characterById, character.GetValidLocation());
			JoinOrganization(characterById, organizationInfo.SettlementId, organizationInfo.Grade);
			ChangeFavorabilityOptional(characterById, character, 8000, 0);
			SetToRepayKindnessCharId(arg);
		}
	}

	public static void SetToRepayKindnessCharId(int charId)
	{
		DomainManager.World.SetToRepayKindnessCharId(charId);
	}

	public static int GetToRepayKindnessCharId()
	{
		return DomainManager.World.GetToRepayKindnessCharId();
	}

	public static ItemKey GetToRepayKindnessCombatSkillBook(int charId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(charId);
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills2 = DomainManager.CombatSkill.GetCharCombatSkills(taiwuCharId);
		short num = -1;
		foreach (var (num3, combatSkill2) in charCombatSkills)
		{
			if (num == -1)
			{
				num = num3;
			}
			if (!charCombatSkills2.ContainsKey(num3))
			{
				num = num3;
			}
			if (Config.CombatSkill.Instance[num3].Grade >= Config.CombatSkill.Instance[num].Grade)
			{
				num = num3;
			}
		}
		short bookId = Config.CombatSkill.Instance[num].BookId;
		ushort readingState = charCombatSkills[num].GetReadingState();
		byte pageTypes = CombatSkillStateHelper.GeneratePageTypesFromReadingState(mainThreadDataContext.Random, readingState);
		byte b = 0;
		while (b < 15 && !CombatSkillStateHelper.IsPageRead(readingState, b))
		{
			b++;
		}
		return DomainManager.Item.CreateDemandedSkillBook(mainThreadDataContext, bookId, b, pageTypes);
	}

	public static void SetSectLeader(sbyte orgTemplateId, EventArgBox argBox)
	{
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId);
		if (settlementByOrgTemplateId != null && settlementByOrgTemplateId.GetLeader() != null && settlementByOrgTemplateId.GetLeader().GetAgeGroup() > 0 && IsCharacterAtTargetSectLocation(settlementByOrgTemplateId.GetLeader(), 14))
		{
			argBox.Set("SectLeader", settlementByOrgTemplateId.GetLeader().GetId());
			return;
		}
		int arg = CreateNonIntelligentCharacter(GetSectRetiredSeniorTemplateId(orgTemplateId));
		argBox.Set("SectLeader", arg);
	}

	public static short TransformSettlementToSectSettlement(short settlementId)
	{
		if (SettlementIsSect(settlementId))
		{
			return settlementId;
		}
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		Location location = settlement.GetLocation();
		sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(location.AreaId);
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(MapState.Instance[stateTemplateIdByAreaId].SectID);
		return settlementByOrgTemplateId.GetId();
	}

	private static short GetSectRetiredSeniorTemplateId(sbyte orgTemplateId)
	{
		if (1 == 0)
		{
		}
		short result = orgTemplateId switch
		{
			1 => 316, 
			2 => 324, 
			3 => 332, 
			4 => 340, 
			5 => 348, 
			6 => 356, 
			7 => 364, 
			8 => 372, 
			9 => 380, 
			10 => 388, 
			11 => 396, 
			12 => 404, 
			13 => 412, 
			14 => 420, 
			15 => 428, 
			_ => throw new Exception($"Not support orgTemplateId: {orgTemplateId}"), 
		};
		if (1 == 0)
		{
		}
		return result;
	}

	public static bool BaihuaTaiwuMedicineAttinmentMeet(int needValue)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		short lifeSkillAttainment = taiwu.GetLifeSkillAttainment(8);
		return lifeSkillAttainment >= needValue;
	}

	public static void BaihuaTriggerAdventureFourAction()
	{
		DomainManager.TaiwuEvent.AddTempDynamicAction(Domain.MainThreadDataContext, new BaihuaStoryAdventureFourTriggerAction());
	}

	public static void BaihuaAdventureFourSetCharacterArgs(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("MajorCharacter_0_0");
		if (IsTemporaryIntelligentCharacter(character.GetId()))
		{
			KeepTemporaryCharacterAfterAdventure(character);
		}
		argBox.Set("VillageHead", character.GetId());
	}

	public static void BaihuaSetAnonymTaiwuActor(EventArgBox argBox, bool isLeft = true, sbyte anonymActorType = 1)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(3);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_BaihuaAnonymTaiwuIsMale", ref arg);
		if (arg)
		{
			string text = anonymActorType switch
			{
				2 => "SectMainStoryAnonymMale", 
				1 => "SectMainStoryBaihuaShadowAnonymMale", 
				_ => "SectMainStoryBaihuaAnonymMaleRelieved", 
			};
			if (isLeft)
			{
				argBox.SetLeftActorKey(text);
			}
			else
			{
				argBox.SetActorKey(text);
			}
		}
		else
		{
			string text2 = anonymActorType switch
			{
				2 => "SectMainStoryAnonymFemale", 
				1 => "SectMainStoryBaihuaShadowAnonymFemale", 
				_ => "SectMainStoryBaihuaAnonymFemaleRelieved", 
			};
			if (isLeft)
			{
				argBox.SetLeftActorKey(text2);
			}
			else
			{
				argBox.SetActorKey(text2);
			}
		}
	}

	public static void BaihuaSetAnonymTaiwuEventBackground(EventArgBox argBox, string maleEventBackground, string femaleEventBackground)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(3);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_BaihuaAnonymTaiwuIsMale", ref arg);
		argBox.Set("ConchShip_PresetKey_SpecifyEventBackground", arg ? maleEventBackground : femaleEventBackground);
	}

	public static void BaihuaCreateAnonymTaiwuActor(EventArgBox argBox)
	{
		CreateAdventureActor(194, "SectMainStoryBaihuaShadowAnonymMale", argBox);
		CreateAdventureActor(199, "SectMainStoryAnonymMale", argBox);
		CreateAdventureActor(197, "SectMainStoryBaihuaAnonymMaleRelieved", argBox);
		CreateAdventureActor(195, "SectMainStoryBaihuaShadowAnonymFemale", argBox);
		CreateAdventureActor(200, "SectMainStoryAnonymFemale", argBox);
		CreateAdventureActor(198, "SectMainStoryBaihuaAnonymFemaleRelieved", argBox);
	}

	public static GameData.Domains.Character.Character BaihuaGetAnonymTaiwuCharacter(sbyte anonymTaiwuType)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(3);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_BaihuaAnonymTaiwuIsMale", ref arg);
		return anonymTaiwuType switch
		{
			1 => GetOrCreateFixedCharacterByTemplateId((short)(arg ? 791 : 792)), 
			2 => GetOrCreateFixedCharacterByTemplateId((short)(arg ? 798 : 799)), 
			_ => GetOrCreateFixedCharacterByTemplateId((short)(arg ? 806 : 807)), 
		};
	}

	public static void BaihuaRemoveAllFixCharacter(bool goodEnd)
	{
		if (!goodEnd && TryGetFixedCharacterByTemplateId(781, out var character))
		{
			RemoveNonIntelligentCharacter(character);
		}
		for (short num = 782; num <= 785; num++)
		{
			if (TryGetFixedCharacterByTemplateId(num, out var character2))
			{
				RemoveNonIntelligentCharacter(character2);
			}
		}
		if (!goodEnd && TryGetFixedCharacterByTemplateId(786, out var character3))
		{
			RemoveNonIntelligentCharacter(character3);
		}
		for (short num2 = 787; num2 <= 790; num2++)
		{
			if (TryGetFixedCharacterByTemplateId(num2, out var character4))
			{
				RemoveNonIntelligentCharacter(character4);
			}
		}
		for (short num3 = 791; num3 <= 792; num3++)
		{
			if (TryGetFixedCharacterByTemplateId(num3, out var character5))
			{
				RemoveNonIntelligentCharacter(character5);
			}
		}
		for (short num4 = 798; num4 <= 800; num4++)
		{
			if (TryGetFixedCharacterByTemplateId(num4, out var character6))
			{
				RemoveNonIntelligentCharacter(character6);
			}
		}
		for (short num5 = 806; num5 <= 807; num5++)
		{
			if (TryGetFixedCharacterByTemplateId(num5, out var character7))
			{
				RemoveNonIntelligentCharacter(character7);
			}
		}
		if (goodEnd)
		{
			return;
		}
		for (short num6 = 808; num6 <= 809; num6++)
		{
			if (TryGetFixedCharacterByTemplateId(num6, out var character8))
			{
				RemoveNonIntelligentCharacter(character8);
			}
		}
	}

	public static void CallBaihuaMember(bool isLeuko)
	{
		DomainManager.World.CallBaihuaMember(Domain.MainThreadDataContext, isLeuko);
	}

	public static void BaihuaClearCalledCharacters(bool isLeuko)
	{
		DomainManager.World.BaihuaClearCalledCharacters(Domain.MainThreadDataContext, isLeuko);
	}

	public static bool BaihuaLeukoKillsCanInteract(int id)
	{
		if (!IsExtraTaskInProgress(308))
		{
			return false;
		}
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(3);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_BaihuaLeukoKillsInteractOpen", ref arg);
		if (!arg)
		{
			return false;
		}
		short arg2 = -1;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_BaihuaLeukoKillsMonthEventSettlementId", ref arg2);
		DomainManager.Character.TryGetElement_Objects(id, out var element);
		if (!IsLocationAtSettlementRange(element.GetLocation(), arg2))
		{
			return false;
		}
		OrganizationInfo organizationInfo = element.GetOrganizationInfo();
		if (organizationInfo.OrgTemplateId == 3 || organizationInfo.SettlementId == arg2)
		{
			return true;
		}
		return false;
	}

	public static bool BaihuaMelanoKillsCanInteract(int id)
	{
		if (!IsExtraTaskInProgress(310))
		{
			return false;
		}
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(3);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_BaihuaMelanoKillsInteractOpen", ref arg);
		if (!arg)
		{
			return false;
		}
		short arg2 = -1;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_BaihuaMelanoKillsMonthEventSettlementId", ref arg2);
		DomainManager.Character.TryGetElement_Objects(id, out var element);
		if (!IsLocationAtSettlementRange(element.GetLocation(), arg2))
		{
			return false;
		}
		OrganizationInfo organizationInfo = element.GetOrganizationInfo();
		if (organizationInfo.OrgTemplateId == 3 || organizationInfo.SettlementId == arg2)
		{
			return true;
		}
		return false;
	}

	public static sbyte BaihuaGetAndSetRandomFiveElementsType(bool isLeuko, EventArgBox argBox)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(3);
		sbyte b = -1;
		IRandomSource random = Domain.MainThreadDataContext.Random;
		if (isLeuko)
		{
			sbyte arg = -1;
			if (sectMainStoryEventArgBox.Get("ConchShip_PresetKey_BaihuaLeukoKillsFiveElementsType", ref arg))
			{
				BaihuaSetGroupElementType(isLeuko, argBox);
				return arg;
			}
			sbyte arg2 = -1;
			if (sectMainStoryEventArgBox.Get("ConchShip_PresetKey_BaihuaMelanoKillsFiveElementsType", ref arg2))
			{
				b = (sbyte)(arg2 + 2);
				if (b > 4)
				{
					b -= 5;
				}
			}
			else
			{
				b = (sbyte)random.Next(0, 5);
			}
			SaveArgToSectMainStory(3, "ConchShip_PresetKey_BaihuaLeukoKillsFiveElementsType", b);
			SaveArgToSectMainStory(3, "ConchShipEventArgBoxKey_PresetKey_BaihuaLeukoKillsOptionSelectDate", GetGameDate());
			TriggerExtraTask(50, 309);
			FinishExtraTask(50, 308);
		}
		else
		{
			sbyte arg3 = -1;
			if (sectMainStoryEventArgBox.Get("ConchShip_PresetKey_BaihuaMelanoKillsFiveElementsType", ref arg3))
			{
				BaihuaSetGroupElementType(isLeuko, argBox);
				return arg3;
			}
			sbyte arg4 = -1;
			if (sectMainStoryEventArgBox.Get("ConchShip_PresetKey_BaihuaLeukoKillsFiveElementsType", ref arg4))
			{
				b = (sbyte)(arg3 + 2);
				if (b > 4)
				{
					b -= 5;
				}
			}
			else
			{
				b = (sbyte)random.Next(0, 5);
			}
			SaveArgToSectMainStory(3, "ConchShip_PresetKey_BaihuaMelanoKillsFiveElementsType", b);
			SaveArgToSectMainStory(3, "ConchShip_PresetKey_BaihuaMelanoKillsOptionSelectDate", GetGameDate());
			FinishExtraTask(50, 310);
			TriggerExtraTask(50, 311);
		}
		BaihuaSetGroupElementType(isLeuko, argBox);
		return b;
	}

	public static bool BaihuaLMBothCombatWon()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(3);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_BaihuaMelanoKillsCombatWin", ref arg);
		bool arg2 = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_BaihuaLeukoKillsCombatWin", ref arg2);
		bool flag = arg2 && arg;
		if (flag)
		{
			TriggerExtraTask(48, 312);
			FinishAllTaskInChain(50);
		}
		return flag;
	}

	public static void BaihuaCharacterFeatureUpdate()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		if (taiwu.GetFeatureIds().Contains(540))
		{
			taiwu.RemoveFeature(mainThreadDataContext, 540);
		}
		taiwu.AddFeature(mainThreadDataContext, 544);
	}

	public static short BaihuaSelectVillageSettlementId()
	{
		short areaIdByAreaTemplateId = GetAreaIdByAreaTemplateId(18);
		short areaRandomSettlementId = GetAreaRandomSettlementId(areaIdByAreaTemplateId);
		SaveArgToSectMainStory(3, "ConchShip_PresetKey_BaihuaVillageSettlementIdSelection", areaRandomSettlementId);
		return areaRandomSettlementId;
	}

	public static bool BaihuaTaiwuHasYangMaterial()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Dictionary<ItemKey, int> items = taiwu.GetInventory().Items;
		foreach (KeyValuePair<ItemKey, int> item in items)
		{
			short itemSubType = ItemTemplateHelper.GetItemSubType(item.Key.ItemType, item.Key.TemplateId);
			if (itemSubType == 505)
			{
				MaterialItem materialItem = Config.Material.Instance[item.Key.TemplateId];
				if (materialItem.Property == EMaterialProperty.Yang)
				{
					return true;
				}
			}
		}
		return false;
	}

	public static bool BaihuaTaiwuHasYinMaterial()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Dictionary<ItemKey, int> items = taiwu.GetInventory().Items;
		foreach (KeyValuePair<ItemKey, int> item in items)
		{
			short itemSubType = ItemTemplateHelper.GetItemSubType(item.Key.ItemType, item.Key.TemplateId);
			if (itemSubType == 505)
			{
				MaterialItem materialItem = Config.Material.Instance[item.Key.TemplateId];
				if (materialItem.Property == EMaterialProperty.Yin)
				{
					return true;
				}
			}
		}
		return false;
	}

	public static void BaihuaTryCreateAdventureFinale()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		List<MapBlockData> mapBlockList = new List<MapBlockData>();
		DomainManager.Map.GetLocationByDistance(taiwuVillageLocation, 4, 7, ref mapBlockList);
		CollectionUtils.Shuffle(mainThreadDataContext.Random, mapBlockList);
		AreaAdventureData adventuresInArea = DomainManager.Adventure.GetAdventuresInArea(taiwuVillageLocation.AreaId);
		foreach (MapBlockData item in mapBlockList)
		{
			if (!DomainManager.Map.IsBlockSpecial(item) && !Enumerable.Contains(adventuresInArea.AdventureSites.Keys, item.BlockId))
			{
				MapBlockItem config = item.GetConfig();
				if (config.SubType != EMapBlockSubType.DarkPool)
				{
					TryCreateAdventureSite(item.AreaId, item.BlockId, 189, setBlockVisible: true);
					break;
				}
			}
		}
	}

	public static sbyte BaihuaAdventureFinalePathGetSectFight(int pathIndex)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(3);
		sbyte b = -1;
		switch (pathIndex)
		{
		case 1:
		{
			sectMainStoryEventArgBox.Get<SByteList>("ConchShip_PresetKey_BaihuaAdventureFinialPathOneSectMeet", out SByteList arg3);
			if (arg3.Items == null)
			{
				b = (sbyte)mainThreadDataContext.Random.Next(6, 11);
				arg3 = SByteList.Create();
			}
			else if (arg3.Items.Count < 5)
			{
				b = (sbyte)(arg3.Items[0] + arg3.Items.Count);
				if (b > 10)
				{
					b -= 5;
				}
			}
			if (arg3.Items.Count < 5)
			{
				arg3.Items.Add(b);
				SaveArgToSectMainStory(3, "ConchShip_PresetKey_BaihuaAdventureFinialPathOneSectMeet", arg3);
			}
			break;
		}
		case 2:
		{
			sectMainStoryEventArgBox.Get<SByteList>("ConchShip_PresetKey_BaihuaAdventureFinialPathTwoSectMeet", out SByteList arg2);
			if (arg2.Items == null)
			{
				b = (sbyte)mainThreadDataContext.Random.Next(11, 16);
				arg2 = SByteList.Create();
			}
			else if (arg2.Items.Count < 5)
			{
				b = (sbyte)(arg2.Items[0] + arg2.Items.Count);
				if (b > 15)
				{
					b -= 5;
				}
			}
			if (arg2.Items.Count < 5)
			{
				arg2.Items.Add(b);
				SaveArgToSectMainStory(3, "ConchShip_PresetKey_BaihuaAdventureFinialPathTwoSectMeet", arg2);
			}
			break;
		}
		case 3:
		{
			sectMainStoryEventArgBox.Get<SByteList>("ConchShip_PresetKey_BaihuaAdventureFinialPathThreeSectMeet", out SByteList arg);
			if (arg.Items == null)
			{
				b = (sbyte)mainThreadDataContext.Random.Next(1, 6);
				arg = SByteList.Create();
			}
			else if (arg.Items.Count < 5)
			{
				b = (sbyte)(arg.Items[0] + arg.Items.Count);
				if (b > 5)
				{
					b -= 5;
				}
			}
			if (arg.Items.Count < 5)
			{
				arg.Items.Add(b);
				SaveArgToSectMainStory(3, "ConchShip_PresetKey_BaihuaAdventureFinialPathThreeSectMeet", arg);
			}
			break;
		}
		}
		return b;
	}

	public static short BaihuaAdventureFinalePathGetSectFightTemplateId(short orgTemplateId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int num = 4;
		OrganizationItem organizationItem = Config.Organization.Instance[orgTemplateId];
		for (int num2 = organizationItem.RandomEnemyTemplateIds.Length - 1; num2 >= num; num2--)
		{
			CharacterItem characterItem = Config.Character.Instance[organizationItem.RandomEnemyTemplateIds[num2]];
			if (characterItem.ConsummateLevel < taiwu.GetConsummateLevel())
			{
				return organizationItem.RandomEnemyTemplateIds[num2];
			}
		}
		return organizationItem.RandomEnemyTemplateIds[num];
	}

	public static void BaihuaAdventureFinaleSaveWonSect(sbyte orgTemplateId)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(3);
		sectMainStoryEventArgBox.Get<SByteList>("ConchShip_PresetKey_BaihuaAdventureFinialWinSect", out SByteList arg);
		if (arg.Items == null)
		{
			arg = SByteList.Create();
		}
		arg.Items.Add(orgTemplateId);
		SaveArgToSectMainStory(3, "ConchShip_PresetKey_BaihuaAdventureFinialWinSect", arg);
	}

	public static void BaihuaTaiwuRandomInjury()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		RandomChangeInjury(taiwu, 1, Domain.MainThreadDataContext.Random.Next(0, 2) == 0);
	}

	public static void BaihuaCureTaiwu()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		if (taiwu.GetFeatureIds().Contains(544))
		{
			taiwu.RemoveFeature(mainThreadDataContext, 544);
		}
		taiwu.SetCurrNeili(taiwu.GetMaxNeili(), mainThreadDataContext);
		HealCharacterAllInjury(taiwu);
		HealCharacterAllPoison(taiwu);
		RecoverCharacterDisorderOfQi(taiwu);
		taiwu.SetHealth(taiwu.GetLeftMaxHealth(), mainThreadDataContext);
	}

	public static void BaihuaFinal()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(3);
		bool flag = sectMainStoryEventArgBox.Contains<bool>("ConchShip_PresetKey_BaihuaLeukoAssistedMelano") && sectMainStoryEventArgBox.Contains<bool>("ConchShip_PresetKey_BaihuaMelanoAssistedLeuko");
		SaveArgToSectMainStory(3, flag ? "ConchShip_PresetKey_SectMainStoryBaihuaProsperousEndDate" : "ConchShip_PresetKey_SectMainStoryBaihuaFailingEndDate", GetGameDate());
		FinishExtraTask(48, 328);
		FinishAllTaskInChain(51);
		FinishAllTaskInChain(50);
		Settlement settlementByOrgTemplateId = GetSettlementByOrgTemplateId(3);
		Location location = settlementByOrgTemplateId.GetLocation();
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(781);
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId2 = GetOrCreateFixedCharacterByTemplateId(786);
		MoveFixedCharacter(orCreateFixedCharacterByTemplateId, flag ? location : Location.Invalid);
		MoveFixedCharacter(orCreateFixedCharacterByTemplateId2, flag ? location : Location.Invalid);
		if (flag)
		{
			DataContext mainThreadDataContext = Domain.MainThreadDataContext;
			GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
			GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId3 = GetOrCreateFixedCharacterByTemplateId(808);
			GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId4 = GetOrCreateFixedCharacterByTemplateId(809);
			orCreateFixedCharacterByTemplateId.SetHappiness(75, mainThreadDataContext);
			orCreateFixedCharacterByTemplateId2.SetHappiness(75, mainThreadDataContext);
			orCreateFixedCharacterByTemplateId3.SetHappiness(75, mainThreadDataContext);
			orCreateFixedCharacterByTemplateId4.SetHappiness(75, mainThreadDataContext);
			DirectlySetFavorabilities(orCreateFixedCharacterByTemplateId.GetId(), taiwu.GetId(), 30000, 30000);
			DirectlySetFavorabilities(orCreateFixedCharacterByTemplateId2.GetId(), taiwu.GetId(), 30000, 30000);
			DirectlySetFavorabilities(orCreateFixedCharacterByTemplateId3.GetId(), taiwu.GetId(), 30000, 30000);
			DirectlySetFavorabilities(orCreateFixedCharacterByTemplateId4.GetId(), taiwu.GetId(), 30000, 30000);
		}
	}

	public static void BaihuaSetLeukoKillsString(EventArgBox argBox, bool isLeuko)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(3);
		short arg = -1;
		sectMainStoryEventArgBox.Get(isLeuko ? "ConchShip_PresetKey_BaihuaLeukoKillsMonthEventSettlementId" : "ConchShip_PresetKey_BaihuaMelanoKillsMonthEventSettlementId", ref arg);
		Settlement settlement = DomainManager.Organization.GetSettlement(arg);
		argBox.Set("SettlementId", arg);
		argBox.Set("AreaId", settlement.GetLocation().AreaId);
	}

	public static void BaihuaSetGroupMeetName(bool isLeuko, EventArgBox argBox)
	{
		DomainManager.World.BaihuaGroupMeetCount(isLeuko, out var groupId);
		argBox.Set("GroupId", groupId);
	}

	public static void BaihuaSetGroupElementType(bool isLeuko, EventArgBox argBox)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(3);
		sbyte arg = -1;
		sectMainStoryEventArgBox.Get(isLeuko ? "ConchShip_PresetKey_BaihuaLeukoKillsFiveElementsType" : "ConchShip_PresetKey_BaihuaMelanoKillsFiveElementsType", ref arg);
		argBox.Set("FiveElementType", arg);
	}

	public static bool BaihuaCanInteractLM()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(3);
		sbyte sectMainStoryTaskStatus = DomainManager.World.GetSectMainStoryTaskStatus(3);
		if (sectMainStoryEventArgBox.Contains<int>("ConchShip_PresetKey_SectMainStoryBaihuaProsperousEndDate") || sectMainStoryTaskStatus == 1)
		{
			return true;
		}
		return false;
	}

	public static int BaihuaGetLMInteractDialog(bool isLeuko)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(3);
		sectMainStoryEventArgBox.Get<IntList>(isLeuko ? "ConchShip_PresetKey_BaihuaLeukoDialogNotTriggered" : "ConchShip_PresetKey_BaihuaMelanoDialogNotTriggered", out IntList arg);
		if (arg.Items == null)
		{
			arg = IntList.Create();
			for (int i = 0; i < 5; i++)
			{
				arg.Items.Add(i);
			}
		}
		int num = 0;
		if (arg.Items.Count == 0)
		{
			num = mainThreadDataContext.Random.Next(0, 5);
		}
		else
		{
			num = arg.Items.GetRandom(mainThreadDataContext.Random);
			arg.Items.Remove(num);
		}
		SaveArgToSectMainStory(3, isLeuko ? "ConchShip_PresetKey_BaihuaLeukoDialogNotTriggered" : "ConchShip_PresetKey_BaihuaMelanoDialogNotTriggered", arg);
		return num;
	}

	public static void BaihuaOpenSpecialInteract(string afterEvent, EventArgBox argBox)
	{
		Domain.SetListenerWithActionName(afterEvent, argBox, "FinishBaihuaSectMainStorySpecial");
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.BaihuaSectMainStorySpecial);
	}

	public static List<(ItemKey, int)> BaihuaLMGetMedicine(bool isLeuko)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		EMaterialProperty giveProperty = ((!isLeuko) ? EMaterialProperty.Yang : EMaterialProperty.Yin);
		List<short> canSelectTemplateIds = ObjectPool<List<short>>.Instance.Get();
		List<(ItemKey, int)> list = new List<(ItemKey, int)>();
		Config.Material.Instance.Iterate(delegate(MaterialItem medicineItem)
		{
			if (medicineItem.ItemSubType == 505 && medicineItem.Property == giveProperty)
			{
				sbyte grade = medicineItem.Grade;
				if (grade >= 5 && grade <= 6)
				{
					canSelectTemplateIds.Add(medicineItem.TemplateId);
				}
			}
			return true;
		});
		CollectionUtils.Shuffle(mainThreadDataContext.Random, canSelectTemplateIds);
		for (int num = 0; num < 3; num++)
		{
			MaterialItem materialItem = Config.Material.Instance[canSelectTemplateIds[num]];
			ItemKey item = AddItemToRole(taiwu, 5, materialItem.TemplateId, 1, -1);
			list.Add((item, 1));
		}
		ObjectPool<List<short>>.Instance.Return(canSelectTemplateIds);
		return list;
	}

	public static bool BaihuaLMNewsTalkedContains(int charId)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(3);
		sectMainStoryEventArgBox.Get<IntList>("ConchShip_PresetKey_BaihuaLMNewsTalkedCharIds", out IntList arg);
		if (arg.Items == null)
		{
			return false;
		}
		return arg.Items.Contains(charId);
	}

	public static void BaihuaAddLMNewsTalked(int charId)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(3);
		sectMainStoryEventArgBox.Get<IntList>("ConchShip_PresetKey_BaihuaLMNewsTalkedCharIds", out IntList arg);
		if (arg.Items == null)
		{
			arg = IntList.Create();
		}
		arg.Items.Add(charId);
		SaveArgToSectMainStory(3, "ConchShip_PresetKey_BaihuaLMNewsTalkedCharIds", arg);
	}

	public static void SaveSectMainStoryEndState(sbyte orgTemplateId, sbyte endState)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.World.SetSectMainStoryTaskStatus(mainThreadDataContext, orgTemplateId, endState);
	}

	public static sbyte GetSectMainStoryTaskStatus(sbyte orgTemplateId)
	{
		return DomainManager.World.GetSectMainStoryTaskStatus(orgTemplateId);
	}

	public static void AddSectMainStoryInformation(short orgTemplateId, bool goodEnd, int informationIndex)
	{
		OrganizationItem organizationItem = Config.Organization.Instance[orgTemplateId];
		List<short> list = (goodEnd ? organizationItem.StoryGoodEndingsInformation : organizationItem.StoryBadEndingsInformation);
		short templateId = list[informationIndex];
		NormalInformation normalInformation = new NormalInformation(templateId, 8);
		DistributeNormalInformationToCharacter(normalInformation, DomainManager.Taiwu.GetTaiwuCharId());
	}

	public static void SectMainStoryEnd(sbyte orgTemplateId, bool goodEnd, int informationIndex = 0, string afterEvent = "", EventArgBox argBox = null, bool addInformation = true)
	{
		if (goodEnd)
		{
			SectChangeFavorability(orgTemplateId, 12000);
		}
		else
		{
			SectChangeFavorability(orgTemplateId, -12000);
		}
		if (addInformation)
		{
			AddSectMainStoryInformation(orgTemplateId, goodEnd, informationIndex);
		}
		SaveSectMainStoryEndState(orgTemplateId, (sbyte)(goodEnd ? 1 : 2));
		ShowSectMainStoryEndScroll(orgTemplateId, goodEnd, afterEvent, argBox);
	}

	public static void CreateSectBuildingForce(sbyte orgTemplateId, short buildingTemplateId)
	{
		Location location = DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId).GetLocation();
		DomainManager.Building.PlaceBuildingAtBlock(Domain.MainThreadDataContext, location.AreaId, location.BlockId, buildingTemplateId, forcePlace: true, isRandom: false);
	}

	public static bool IsSectMainStoryUnlocked(sbyte orgTemplateId)
	{
		sbyte b = orgTemplateId;
		sbyte b2 = b;
		if (b2 == 4)
		{
			return false;
		}
		return false;
	}

	public static void ShowSectMainStoryUnlock(sbyte orgTemplateId, string afterEvent, EventArgBox argBox)
	{
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "ShowSectMainStoryUnlock");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.ShowSectMainStoryUnlock, orgTemplateId);
		if (!string.IsNullOrEmpty(afterEvent) && argBox != null)
		{
			Domain.CheckTaiwuStatusImmediately();
		}
	}

	public static bool TriggerEmeiStoryAdventureTwo()
	{
		MonthlyActionKey key = MonthlyEventActionsManager.PredefinedKeys["EmeiStoryDefault"];
		ConfigWrapperAction configWrapperAction = (ConfigWrapperAction)Domain.GetMonthlyAction(key);
		if (configWrapperAction.CurrConfigMonthlyAction != null)
		{
			return false;
		}
		configWrapperAction.CreateWrappedAction(81, -1);
		return configWrapperAction.CurrConfigMonthlyAction != null;
	}

	public static bool IsEmeiStoryAdventureTwoTriggered()
	{
		MonthlyActionKey key = MonthlyEventActionsManager.PredefinedKeys["EmeiStoryDefault"];
		ConfigWrapperAction configWrapperAction = (ConfigWrapperAction)Domain.GetMonthlyAction(key);
		return configWrapperAction.CurrConfigMonthlyAction != null;
	}

	public static void SaveWhiteApeBlockId()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Location location = Location.Invalid;
		short arg = 0;
		if (GetSectMainStoryEventArgBox(2).Get("ConchShip_PresetKey_WhiteApeBlockIdTmpSave", ref arg))
		{
			location.AreaId = DomainManager.Organization.GetSettlementByOrgTemplateId(2).GetLocation().AreaId;
			location.BlockId = arg;
			RemoveArgFromSectMainStory<short>(2, "ConchShip_PresetKey_WhiteApeBlockIdTmpSave");
		}
		else
		{
			location = GetEmeiSpecifyLocation();
		}
		SaveArgToSectMainStory(2, "ConchShip_PresetKey_WhiteApeBlockId", location.BlockId);
		DomainManager.Extra.GenerateEmeiBlood(mainThreadDataContext, location);
		MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
		if (!blockData.Visible)
		{
			blockData.SetVisible(visible: true, mainThreadDataContext);
		}
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(679);
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId2 = GetOrCreateFixedCharacterByTemplateId(637);
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		DirectlySetFavorabilities(orCreateFixedCharacterByTemplateId.GetId(), taiwuCharId, 0, 0);
		DirectlySetFavorabilities(orCreateFixedCharacterByTemplateId2.GetId(), taiwuCharId, 0, 0);
	}

	public static void ClearWhiteApeBlockId()
	{
		short arg = 0;
		if (GetSectMainStoryEventArgBox(2).Get("ConchShip_PresetKey_WhiteApeBlockId", ref arg))
		{
			SaveArgToSectMainStory(2, "ConchShip_PresetKey_WhiteApeBlockIdTmpSave", arg);
		}
		RemoveArgFromSectMainStory<short>(2, "ConchShip_PresetKey_WhiteApeBlockId");
		DomainManager.Extra.ClearEmeiBlood(Domain.MainThreadDataContext);
	}

	public static Location GetEmeiSpecifyLocation()
	{
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		GetValidEmeiSpecifyLocations(list);
		if (list.Count == 0)
		{
			return Location.Invalid;
		}
		Location location = list[Domain.MainThreadDataContext.Random.Next(0, list.Count)].GetLocation();
		ObjectPool<List<MapBlockData>>.Instance.Return(list);
		return location;
	}

	public static void GetValidEmeiSpecifyLocations(List<MapBlockData> nonDevelopedMapBlockDatas)
	{
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(2);
		Location location = settlementByOrgTemplateId.GetLocation();
		List<MapBlockData> mapBlockList = ObjectPool<List<MapBlockData>>.Instance.Get();
		MapBlockItem mapBlockItem = MapBlock.Instance[(short)20];
		GetLocationByDistance(location, mapBlockItem.Range + 3, mapBlockItem.Range + 3, ref mapBlockList);
		foreach (MapBlockData item in mapBlockList)
		{
			if (item.GetConfig().SubType != EMapBlockSubType.DLCLoong && item.IsNonDeveloped())
			{
				nonDevelopedMapBlockDatas.Add(item);
			}
		}
		ObjectPool<List<MapBlockData>>.Instance.Return(mapBlockList);
	}

	public static bool CheckHomicideCase0()
	{
		short arg = -1;
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(2);
		if (!sectMainStoryEventArgBox.Get("ConchShip_PresetKey_WhiteApeBlockId", ref arg))
		{
			return false;
		}
		if (sectMainStoryEventArgBox.Contains<bool>("ConchShip_PresetKey_HomocideCase0Triggered"))
		{
			return false;
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		MapBlockData mapBlockData = GetMapBlockData(location.AreaId, location.BlockId);
		Location location2 = GetSettlementByOrgTemplateId(2).GetLocation();
		if (location2.AreaId != location.AreaId)
		{
			return false;
		}
		ByteCoordinate blockPos = GetMapBlockData(location2.AreaId, arg).GetBlockPos();
		return mapBlockData.GetManhattanDistanceToPos(blockPos.X, blockPos.Y) <= 3;
	}

	public static bool CheckHomicideCase1()
	{
		if (!IsExtraTaskInProgress(200))
		{
			return false;
		}
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(2);
		if (sectMainStoryEventArgBox.Contains<bool>("ConchShip_PresetKey_HomocideCase1Triggered"))
		{
			return false;
		}
		int arg = 1;
		if (!sectMainStoryEventArgBox.Get("ConchShip_PresetKey_HomocideCase0Time", ref arg))
		{
			return false;
		}
		short arg2 = -1;
		int gameDate = GetGameDate();
		if (gameDate < arg + 1)
		{
			return false;
		}
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_WhiteApeBlockId", ref arg2);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		MapBlockData mapBlockData = GetMapBlockData(location.AreaId, location.BlockId);
		Location location2 = GetSettlementByOrgTemplateId(2).GetLocation();
		if (location2.AreaId != location.AreaId)
		{
			return false;
		}
		ByteCoordinate blockPos = GetMapBlockData(location2.AreaId, arg2).GetBlockPos();
		return mapBlockData.GetManhattanDistanceToPos(blockPos.X, blockPos.Y) <= 2;
	}

	public static bool CheckHomicideCase2()
	{
		if (!IsExtraTaskInProgress(200))
		{
			return false;
		}
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(2);
		if (sectMainStoryEventArgBox.Contains<bool>("ConchShip_PresetKey_HomocideCase2Triggered"))
		{
			return false;
		}
		int arg = 1;
		if (!sectMainStoryEventArgBox.Get("ConchShip_PresetKey_HomocideCase1Time", ref arg))
		{
			return false;
		}
		short arg2 = -1;
		int gameDate = GetGameDate();
		if (gameDate < arg + 1)
		{
			return false;
		}
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_WhiteApeBlockId", ref arg2);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		MapBlockData mapBlockData = GetMapBlockData(location.AreaId, location.BlockId);
		Location location2 = GetSettlementByOrgTemplateId(2).GetLocation();
		if (location2.AreaId != location.AreaId)
		{
			return false;
		}
		ByteCoordinate blockPos = GetMapBlockData(location2.AreaId, arg2).GetBlockPos();
		return mapBlockData.GetManhattanDistanceToPos(blockPos.X, blockPos.Y) <= 1;
	}

	public static void CreateEmeiRole(EventArgBox argBox)
	{
		EventActorData value = CreateAdventureActor(152, "CharIdJia", argBox);
		EventActorData value2 = CreateAdventureActor(153, "CharIdYi", argBox);
		EventActorData value3 = CreateAdventureActor(154, "CharIdBing", argBox);
		EventActorData value4 = CreateAdventureActor(155, "CharIdDing", argBox);
		EventActorData value5 = CreateAdventureActor(156, "CharIdWu", argBox);
		EventActorData value6 = CreateAdventureActor(157, "CharIdSi", argBox);
		EventActorData value7 = CreateAdventureActor(158, "CharIdGeng", argBox);
		EventActorData value8 = CreateAdventureActor(159, "CharIdXin", argBox);
		SaveArgToSectMainStory(2, "ConchShip_PresetKey_EmeiRoleJia", value);
		SaveArgToSectMainStory(2, "ConchShip_PresetKey_EmeiRoleYi", value2);
		SaveArgToSectMainStory(2, "ConchShip_PresetKey_EmeiRoleBing", value3);
		SaveArgToSectMainStory(2, "ConchShip_PresetKey_EmeiRoleDing", value4);
		SaveArgToSectMainStory(2, "ConchShip_PresetKey_EmeiRoleWu", value5);
		SaveArgToSectMainStory(2, "ConchShip_PresetKey_EmeiRoleSi", value6);
		SaveArgToSectMainStory(2, "ConchShip_PresetKey_EmeiRoleGeng", value7);
		SaveArgToSectMainStory(2, "ConchShip_PresetKey_EmeiRoleXin", value8);
	}

	public static void SetEmeiRole(EventArgBox argBox)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(2);
		EventActorData arg = sectMainStoryEventArgBox.Get<EventActorData>("ConchShip_PresetKey_EmeiRoleJia");
		EventActorData arg2 = sectMainStoryEventArgBox.Get<EventActorData>("ConchShip_PresetKey_EmeiRoleYi");
		EventActorData arg3 = sectMainStoryEventArgBox.Get<EventActorData>("ConchShip_PresetKey_EmeiRoleBing");
		EventActorData arg4 = sectMainStoryEventArgBox.Get<EventActorData>("ConchShip_PresetKey_EmeiRoleDing");
		EventActorData arg5 = sectMainStoryEventArgBox.Get<EventActorData>("ConchShip_PresetKey_EmeiRoleWu");
		EventActorData arg6 = sectMainStoryEventArgBox.Get<EventActorData>("ConchShip_PresetKey_EmeiRoleSi");
		EventActorData arg7 = sectMainStoryEventArgBox.Get<EventActorData>("ConchShip_PresetKey_EmeiRoleGeng");
		EventActorData arg8 = sectMainStoryEventArgBox.Get<EventActorData>("ConchShip_PresetKey_EmeiRoleXin");
		argBox.Set("CharIdJia", (ISerializableGameData)(object)arg);
		argBox.Set("CharIdYi", (ISerializableGameData)(object)arg2);
		argBox.Set("CharIdBing", (ISerializableGameData)(object)arg3);
		argBox.Set("CharIdDing", (ISerializableGameData)(object)arg4);
		argBox.Set("CharIdWu", (ISerializableGameData)(object)arg5);
		argBox.Set("CharIdSi", (ISerializableGameData)(object)arg6);
		argBox.Set("CharIdGeng", (ISerializableGameData)(object)arg7);
		argBox.Set("CharIdXin", (ISerializableGameData)(object)arg8);
	}

	public static void MoveTaiwuToWhiteApe()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		short arg = -1;
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(2);
		if (sectMainStoryEventArgBox.Get("ConchShip_PresetKey_WhiteApeBlockId", ref arg) && location.BlockId != arg)
		{
			TeleportMoveTaiwuToBlock(arg);
		}
	}

	public static void EnterEmeiAdventure()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		CreateAndEnterAdventure(location, 177);
	}

	public static void ClearEmeiBlood()
	{
		DomainManager.Extra.ClearEmeiBlood(Domain.MainThreadDataContext);
	}

	public static void SetTaiwuSoftInjury()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		ChangeRoleBodyPartInjuryByLevel(taiwu, isInnerInjury: false, 1, 5);
		SaveArgToSectMainStory(2, "ConchShip_PresetKey_TaiwuJumpCliffInjuryType", 2);
	}

	public static void SetTaiwuSeriousInjury()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		ChangeRoleBodyPartInjuryByLevel(taiwu, isInnerInjury: false, 3, 5);
		SaveArgToSectMainStory(2, "ConchShip_PresetKey_TaiwuJumpCliffInjuryType", 3);
	}

	public static void EmeiAddSelectGoodEndCount()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(2);
		int arg = 0;
		arg = ((!sectMainStoryEventArgBox.Get("ConchShip_PresetKey_EmeiSelectGoodEndCount", ref arg)) ? 1 : (arg + 1));
		SaveArgToSectMainStory(2, "ConchShip_PresetKey_EmeiSelectGoodEndCount", arg);
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(679);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		DirectlyChangeFavorabilityOptional(orCreateFixedCharacterByTemplateId, taiwu, 3000, 4);
	}

	public static void EmeiAddSelectBadEndCount()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(2);
		int arg = 0;
		arg = ((!sectMainStoryEventArgBox.Get("ConchShip_PresetKey_EmeiSelectBadEndCount", ref arg)) ? 1 : (arg + 1));
		SaveArgToSectMainStory(2, "ConchShip_PresetKey_EmeiSelectBadEndCount", arg);
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(637);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		DirectlyChangeFavorabilityOptional(orCreateFixedCharacterByTemplateId, taiwu, 3000, 4);
	}

	public static int EmeiGetSelectGoodEndCount()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(2);
		int arg = 0;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_EmeiSelectGoodEndCount", ref arg);
		return arg;
	}

	public static int EmeiGetSelectBadEndCount()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(2);
		int arg = 0;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_EmeiSelectBadEndCount", ref arg);
		return arg;
	}

	public static bool EmeiDifferentSelectIsShow()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(2);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_EmeiFourthSelectResult", ref arg);
		return EmeiGetSelectBadEndCount() >= 2 && !arg;
	}

	public static void EmeiWhiteGibbonAppear()
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(679);
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(2);
		short arg = -1;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_WhiteApeBlockId", ref arg);
		Location targetLocation = new Location(GetSettlementByOrgTemplateId(2).GetLocation().AreaId, arg);
		MoveFixedCharacter(orCreateFixedCharacterByTemplateId, targetLocation);
	}

	public static void EmeiWhiteGibbonDisappear()
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(679);
		MoveFixedCharacter(orCreateFixedCharacterByTemplateId, Location.Invalid);
	}

	public static void EmeiWhiteGibbonDisappearWithQuestionMark()
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(636);
		MoveFixedCharacter(orCreateFixedCharacterByTemplateId, Location.Invalid);
	}

	public static void EmeiShiHoujiuDisappear()
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(637);
		MoveFixedCharacter(orCreateFixedCharacterByTemplateId, Location.Invalid);
	}

	public static void EmeiHideLeader()
	{
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(2);
		GameData.Domains.Character.Character leader = settlementByOrgTemplateId.GetLeader();
		if (leader != null && !leader.IsActiveExternalRelationState(60) && leader.GetKidnapperId() < 0 && leader.GetLocation().IsValid())
		{
			SaveArgToSectMainStory(2, "ConchShip_PresetKey_EmeiLeaderOriginalLocation", leader.GetLocation());
			SaveArgToSectMainStory(2, "ConchShip_PresetKey_EmeiLeaderOriginalId", leader.GetId());
			HideIntelligentCharacter(leader);
		}
	}

	public static void EmeiShowLeader()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(2);
		if (sectMainStoryEventArgBox.Get<Location>("ConchShip_PresetKey_EmeiLeaderOriginalLocation", out Location arg))
		{
			int arg2 = -1;
			sectMainStoryEventArgBox.Get("ConchShip_PresetKey_EmeiLeaderOriginalId", ref arg2);
			if (DomainManager.Character.TryGetElement_Objects(arg2, out var element))
			{
				MoveIntelligentCharacter(element, arg);
			}
		}
	}

	public static void EmeiRemoveRelatedFixedCharacter(bool includeGibbon = true, bool includeShiHoujiu = true)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		if (includeGibbon)
		{
			GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(679);
			DomainManager.Character.RemoveNonIntelligentCharacter(mainThreadDataContext, orCreateFixedCharacterByTemplateId);
		}
		if (includeShiHoujiu)
		{
			GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId2 = GetOrCreateFixedCharacterByTemplateId(637);
			DomainManager.Character.RemoveNonIntelligentCharacter(mainThreadDataContext, orCreateFixedCharacterByTemplateId2);
		}
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId3 = GetOrCreateFixedCharacterByTemplateId(636);
		DomainManager.Character.RemoveNonIntelligentCharacter(mainThreadDataContext, orCreateFixedCharacterByTemplateId3);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		ItemKey inventoryItemKey = taiwu.GetInventory().GetInventoryItemKey(12, 267);
		if (inventoryItemKey.IsValid())
		{
			taiwu.RemoveInventoryItem(mainThreadDataContext, inventoryItemKey, 1, deleteItem: true);
		}
	}

	public static string EmeiGetShiHoujiuDialogueEventGuid(EventArgBox argBox)
	{
		if (EmeiIsShiHoujiuFollowOpen())
		{
			return argBox.GetString("FollowOpenTalk");
		}
		if (EmeiIsSamePassAdventureTwoTaiwu())
		{
			return argBox.GetString("SameTaiwuTalk");
		}
		return argBox.GetString("NormalTalk");
	}

	public static string EmeiGetWhiteGibbonDialogueEventGuid(EventArgBox argBox)
	{
		if (EmeiIsWhiteGibbonFollowOpen())
		{
			return argBox.GetString("FollowOpenTalk");
		}
		if (EmeiIsSamePassAdventureTwoTaiwu())
		{
			return argBox.GetString("SameTaiwuTalk");
		}
		return argBox.GetString("NormalTalk");
	}

	public static bool EmeiIsSamePassAdventureTwoTaiwu()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(2);
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int num = sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_EmeiPassAdventureTwoTaiwuId");
		return taiwuCharId == num;
	}

	public static bool EmeiIsWhiteGibbonFollowOpen()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(2);
		bool arg = false;
		return sectMainStoryEventArgBox.Get("ConchShip_PresetKey_EmeiWhiteGibbonFollowOpen", ref arg) && arg;
	}

	public static bool EmeiIsShiHoujiuFollowOpen()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(2);
		bool arg = false;
		return sectMainStoryEventArgBox.Get("ConchShip_PresetKey_EmeiShiHoujiuFollowOpen", ref arg) && arg;
	}

	public static void EmeiShiHoujiuReturnToEmei()
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(637);
		Location emeiSpecifyLocation = GetEmeiSpecifyLocation();
		MoveFixedCharacter(orCreateFixedCharacterByTemplateId, emeiSpecifyLocation);
	}

	public static void EmeiWhiteGibbonReturnToEmei()
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(679);
		Location emeiSpecifyLocation = GetEmeiSpecifyLocation();
		MoveFixedCharacter(orCreateFixedCharacterByTemplateId, emeiSpecifyLocation);
	}

	public static void EmeiAdventureTwoSetCharacterArgs(EventArgBox argBox)
	{
		for (int i = 0; i < 4; i++)
		{
			string key = $"ParticipateCharacter_0_{i}";
			GameData.Domains.Character.Character character = argBox.GetCharacter(key);
			key = $"EmeiElder0{i + 1}";
			argBox.Set(key, character.GetId());
			if (IsTemporaryIntelligentCharacter(character.GetId()))
			{
				KeepTemporaryCharacterAfterAdventure(character);
			}
		}
		for (int j = 0; j < 11; j++)
		{
			string key2 = $"ParticipateCharacter_1_{j}";
			GameData.Domains.Character.Character character2 = argBox.GetCharacter(key2);
			key2 = $"EmeiFollower{j + 1}";
			argBox.Set(key2, character2.GetId());
			if (IsTemporaryIntelligentCharacter(character2.GetId()))
			{
				KeepTemporaryCharacterAfterAdventure(character2);
			}
		}
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(679);
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId2 = GetOrCreateFixedCharacterByTemplateId(637);
		argBox.Set("ShiHoujiu", orCreateFixedCharacterByTemplateId2.GetId());
		argBox.Set("EmeiGibbon", orCreateFixedCharacterByTemplateId.GetId());
		CreateAdventureActor(162, "EmeiBlackMan", argBox);
	}

	public static bool EmeiAdventureTwoSetPathArgs(EventArgBox argBox)
	{
		int arg = 0;
		if (!argBox.Contains<int>("ConchShip_PresetKey_EmeiAdventureTwoPathEventTriggerCount"))
		{
			argBox.Set("ConchShip_PresetKey_EmeiAdventureTwoPathEventTriggerCount", 1);
			arg = 1;
		}
		else
		{
			argBox.Get("ConchShip_PresetKey_EmeiAdventureTwoPathEventTriggerCount", ref arg);
			arg++;
			argBox.Set("ConchShip_PresetKey_EmeiAdventureTwoPathEventTriggerCount", arg);
		}
		if (arg >= 6)
		{
			return false;
		}
		GameData.Domains.Character.Character character = argBox.GetCharacter("EmeiFollower" + (arg + 5));
		argBox.Set("EmeiFollowerRandom", character.GetId());
		return true;
	}

	public static void OpenEmeiCombatSkillSpecialBreak(string afterEvent, EventArgBox argBox, short charTemplateId, int characterId)
	{
		Domain.SetListenerWithActionName(afterEvent, argBox, "CombatSkillSpecialBreak");
		bool flag;
		switch (charTemplateId)
		{
		case 636:
		case 679:
		case 680:
		case 681:
			flag = true;
			break;
		default:
			flag = false;
			break;
		}
		bool arg = flag;
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenCombatSkillSpecialBreak, charTemplateId, arg);
	}

	public static void Follow(GameData.Domains.Character.Character character, int distance)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		if (!location.IsValid())
		{
			location = taiwu.GetValidLocation();
		}
		DomainManager.Map.GetRealNeighborBlocks(location.AreaId, location.BlockId, list, distance);
		MapBlockData mapBlockData = list[mainThreadDataContext.Random.Next(0, list.Count)];
		ObjectPool<List<MapBlockData>>.Instance.Return(list);
		MoveFixedCharacter(character, mapBlockData.GetLocation());
	}

	public static bool IsEmeiHomocideCasesInteractionId(int charId)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(2);
		if (!sectMainStoryEventArgBox.Contains<IntList>("ConchShip_PresetKey_EmeiEmeiHomocideCasesInteractionIds"))
		{
			return false;
		}
		IntList intList = sectMainStoryEventArgBox.Get<IntList>("ConchShip_PresetKey_EmeiEmeiHomocideCasesInteractionIds");
		if (intList.Items == null)
		{
			return false;
		}
		return intList.Items.Contains(charId);
	}

	public static void AddEmeiHomocideCasesInteractionId(int charId)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(2);
		IntList value;
		if (!sectMainStoryEventArgBox.Contains<IntList>("ConchShip_PresetKey_EmeiEmeiHomocideCasesInteractionIds"))
		{
			value = IntList.Create();
		}
		else
		{
			value = sectMainStoryEventArgBox.Get<IntList>("ConchShip_PresetKey_EmeiEmeiHomocideCasesInteractionIds");
			if (value.Items == null)
			{
				value = IntList.Create();
			}
		}
		value.Items.Add(charId);
		SaveArgToSectMainStory(2, "ConchShip_PresetKey_EmeiEmeiHomocideCasesInteractionIds", value);
	}

	public static void EmeiCreateIntelligentNpc()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		OrganizationInfo orgInfo = new OrganizationInfo(2, 4, principal: true, -1);
		short characterTemplateId = OrganizationDomain.GetCharacterTemplateId(orgInfo.OrgTemplateId, 2, 1);
		IntelligentCharacterCreationInfo intelligentCharacterCreationInfo = new IntelligentCharacterCreationInfo(taiwu.GetLocation(), orgInfo, characterTemplateId);
		intelligentCharacterCreationInfo.Age = (short)mainThreadDataContext.Random.Next(18, 30);
		intelligentCharacterCreationInfo.Gender = 1;
		IntelligentCharacterCreationInfo info = intelligentCharacterCreationInfo;
		GameData.Domains.Character.Character character = DomainManager.Character.CreateIntelligentCharacter(mainThreadDataContext, ref info);
		DomainManager.Character.CompleteCreatingCharacter(character.GetId());
		character.SetBaseMorality(500, mainThreadDataContext);
	}

	public static void FulongTriggerAdventureOneAction()
	{
		DomainManager.TaiwuEvent.AddTempDynamicAction(Domain.MainThreadDataContext, new FulongStoryAdventureOneTriggerAction());
	}

	public static void FulongAdventureOneSetLeader(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("MajorCharacter_0_0");
		if (character == null)
		{
			int arg = CreateNonIntelligentCharacter(420);
			argBox.Set("SectLeader", arg);
			argBox.Set("MajorCharacter_0_0", arg);
		}
		else
		{
			argBox.Set("SectLeader", character.GetId());
		}
	}

	public static bool FulongAdventureCanDrinkWine()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		return CanEatItemExceptMisc(taiwu) && taiwu.GetDisorderOfQi() <= 6000;
	}

	public static void FulongAdventureDrinkWine(EventArgBox argBox, GameData.Domains.Character.Character character)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		short num = 0;
		if (character.GetOrganizationInfo().Grade == 1)
		{
			num = 1;
		}
		else if (character.GetOrganizationInfo().Grade == 2)
		{
			num = 2;
		}
		TeaWineItem teaWineItem = Config.TeaWine.Instance[num];
		ChangeFavorabilityOptional(character, taiwu, (short)teaWineItem.BaseFavorabilityChange, 4);
		ItemKey itemKey = AddItemToRole(taiwu, 9, num, 1, -1);
		AddEatingItem(taiwu.GetId(), itemKey);
		if (CanEatItemExceptMisc(character))
		{
			ItemKey itemKey2 = AddItemToRole(character, 9, num, 1, -1);
			AddEatingItem(character.GetId(), itemKey2);
		}
	}

	public static void FulongAdventurePathEventSetCharacterId(EventArgBox argBox, int pathIndex, int count)
	{
		argBox.Set("CharacterId", (pathIndex switch
		{
			0 => count switch
			{
				0 => argBox.GetCharacter("MajorCharacter_0_1_0"), 
				1 => argBox.GetCharacter("MajorCharacter_0_1_1"), 
				_ => argBox.GetCharacter("MajorCharacter_0_1_2"), 
			}, 
			1 => count switch
			{
				0 => argBox.GetCharacter("MajorCharacter_0_2_0"), 
				1 => argBox.GetCharacter("MajorCharacter_0_2_1"), 
				_ => argBox.GetCharacter("MajorCharacter_0_2_2"), 
			}, 
			_ => count switch
			{
				0 => argBox.GetCharacter("MajorCharacter_0_3_0"), 
				1 => argBox.GetCharacter("MajorCharacter_0_3_1"), 
				_ => argBox.GetCharacter("MajorCharacter_0_3_2"), 
			}, 
		}).GetId());
	}

	public static void FulongAdventureGiveTreasure(EventArgBox argBox)
	{
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		for (short num = 28; num <= 72; num++)
		{
			MiscItem miscItem = Config.Misc.Instance[num];
			sbyte grade = miscItem.Grade;
			if (grade >= 5 && grade <= 7)
			{
				list.Add(num);
			}
		}
		short random = list.GetRandom(Domain.MainThreadDataContext.Random);
		ObjectPool<List<short>>.Instance.Return(list);
		ItemKey itemKey = new ItemKey(12, 0, random, -1);
		argBox.Set("GiftItem", (ISerializableGameData)(object)itemKey);
	}

	public static void FulongAdventureGiveResourceTypes(EventArgBox argBox, sbyte resourceType)
	{
		GameData.Utilities.ShortList shortList = argBox.Get<GameData.Utilities.ShortList>("GiveResourceTypes");
		if (shortList.Items == null)
		{
			shortList = GameData.Utilities.ShortList.Create();
		}
		if (!shortList.Items.Contains(resourceType))
		{
			shortList.Items.Add(resourceType);
		}
		argBox.Set("ResourceType", resourceType);
		argBox.Set("GiveResourceTypes", (ISerializableGameData)(object)shortList);
	}

	public static string FulongGetAdventureGiveResourceTypesGuid(EventArgBox argBox)
	{
		GameData.Utilities.ShortList shortList = argBox.Get<GameData.Utilities.ShortList>("GiveResourceTypes");
		if (shortList.Items == null)
		{
			return "a62710ce-557a-4402-9ff4-765165db97a2";
		}
		if (shortList.Items.Count == 1 && shortList.Items.Contains(0))
		{
			return "2d4a7c1a-403e-45d1-9a32-1129de717bc6";
		}
		if (shortList.Items.Count == 1 && shortList.Items.Contains(1))
		{
			return "f68e2120-a5b3-4f4c-8806-8eaf27fd3503";
		}
		if (shortList.Items.Count == 1 && shortList.Items.Contains(2))
		{
			return "5e4d1c2f-ad1e-433e-ae96-15f0a9214fa7";
		}
		if (shortList.Items.Count == 1 && shortList.Items.Contains(3))
		{
			return "267f104d-89d2-4e9e-a895-258b6d0dbc7c";
		}
		if (shortList.Items.Count == 1 && shortList.Items.Contains(4))
		{
			return "faffda0e-e41d-4bdc-8c86-17f8e5a2ec2b";
		}
		if (shortList.Items.Count == 1 && shortList.Items.Contains(5))
		{
			return "463a9fbd-d2bf-44ee-ae05-bef4621032a8";
		}
		if (shortList.Items.Count == 1 && shortList.Items.Contains(6))
		{
			return "d4f69f6c-4754-4202-9f20-c9a3a185ea2c";
		}
		if (shortList.Items.Count > 1 && shortList.Items.Contains(0) && shortList.Items.Contains(5))
		{
			return "94b5daba-beaf-4de8-ab8d-46aa5cb9f859";
		}
		return "3f0016e3-9afe-49a9-b394-3fc1ab1a142b";
	}

	public static void FulongAdventureChangeCharacterFavorability(GameData.Domains.Character.Character character)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		DomainManager.Character.ChangeFavorabilityOptional(Domain.MainThreadDataContext, character, taiwu, SectMainStoryRelatedConstants.FulongAdventureOneFavorabilityChange, 4);
	}

	public static List<FulongInFlameArea> GetAllFulongInFlameAreas()
	{
		return DomainManager.Extra.GetAllFulongInFlameAreas();
	}

	public static void FulongStartFire()
	{
		DomainManager.Extra.GenerateFulongInFlameArea(Domain.MainThreadDataContext, 3, GlobalConfig.Instance.FulongFlameBoomNumber, isBig: true);
		DomainManager.Extra.GenerateFulongInFlameArea(Domain.MainThreadDataContext, 3, GlobalConfig.Instance.FulongFlameBoomNumber, isBig: true);
		DomainManager.Extra.GenerateFulongInFlameArea(Domain.MainThreadDataContext, 3, GlobalConfig.Instance.FulongFlameBoomNumber, isBig: true);
		SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongFireStartTime", GetGameDate());
		TriggerExtraTask(52, 346);
	}

	public static List<short> FulongGetPutOutFireReward()
	{
		int arg = 0;
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(14);
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongPutOutFireCount", ref arg);
		sbyte b = (sbyte)(arg + 2);
		Span<short> span = stackalloc short[3];
		SpanList<short> spanList = span;
		List<short> list = new List<short>();
		spanList.Add(77);
		spanList.Add(78);
		spanList.Add(80);
		SpanList<short>.Enumerator enumerator = spanList.GetEnumerator();
		while (enumerator.MoveNext())
		{
			short current = enumerator.Current;
			MakeItemResult result = MakeItemSubType.Instance[MakeItemType.Instance[Config.Material.Instance[current].CraftableItemTypes[0]].MakeItemSubTypes[0]].Result;
			short item = (short)(result.TemplateId - Config.Food.Instance[result.TemplateId].Grade + b);
			list.Add(item);
		}
		return list;
	}

	public static void FulongPutOutOnceFire()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		List<FulongInFlameArea> allFulongInFlameAreas = GetAllFulongInFlameAreas();
		for (int i = 0; i < allFulongInFlameAreas.Count; i++)
		{
			FulongInFlameArea fulongInFlameArea = allFulongInFlameAreas[i];
			List<short> first = fulongInFlameArea.LightedBlocks.Keys.ToList();
			first = first.Except(fulongInFlameArea.ExtinguishedBlocks).Except(fulongInFlameArea.MineBlocks).ToList();
			if (first.Count > 2)
			{
				short random = first.GetRandom(mainThreadDataContext.Random);
				DomainManager.Extra.ExtinguishFulongInFlameArea(mainThreadDataContext, random, isEvent: true);
			}
		}
	}

	public static bool FulongGuideCanTrigger()
	{
		if (!IsExtraTaskInProgress(346))
		{
			return false;
		}
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(14);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongFireFightingGuideTriggered", ref arg);
		if (arg)
		{
			return false;
		}
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(14);
		Location location = settlementByOrgTemplateId.GetLocation();
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location2 = taiwu.GetLocation();
		if (location2.AreaId != location.AreaId)
		{
			return false;
		}
		List<FulongInFlameArea> allFulongInFlameAreas = GetAllFulongInFlameAreas();
		List<MapBlockData> mapBlockList = ObjectPool<List<MapBlockData>>.Instance.Get();
		DomainManager.Map.GetLocationByDistance(location2, 1, 1, ref mapBlockList);
		for (int i = 0; i < mapBlockList.Count; i++)
		{
			Location location3 = mapBlockList[i].GetLocation();
			for (int j = 0; j < allFulongInFlameAreas.Count; j++)
			{
				if (Enumerable.Contains(allFulongInFlameAreas[j].LightedBlocks.Keys, location3.BlockId))
				{
					ObjectPool<List<MapBlockData>>.Instance.Return(mapBlockList);
					return true;
				}
			}
		}
		ObjectPool<List<MapBlockData>>.Instance.Return(mapBlockList);
		return false;
	}

	public static void FulongSectSetLeader(EventArgBox argBox)
	{
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(14);
		if (settlementByOrgTemplateId != null && settlementByOrgTemplateId.GetLeader() != null && IsCharacterAtTargetSectLocation(settlementByOrgTemplateId.GetLeader(), 14))
		{
			argBox.Set("SectLeader", settlementByOrgTemplateId.GetLeader().GetId());
			return;
		}
		int arg = CreateNonIntelligentCharacter(420);
		argBox.Set("SectLeader", arg);
	}

	public static void FulongSetReudhLazuliStartFavorability()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(810);
		DirectlySetFavorabilities(orCreateFixedCharacterByTemplateId.GetId(), taiwu.GetId(), SectMainStoryRelatedConstants.FulongLazuliStartFavorability, SectMainStoryRelatedConstants.FulongLazuliStartFavorability);
	}

	public static int FulongMonvState(EventArgBox argBox)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(14);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongTravelWithLazuliMonvTalkTriggered", ref arg);
		if (arg)
		{
			return 3;
		}
		DomainManager.Character.TryGetFixedCharacterByTemplateId(39, out var character);
		if (character != null && character.GetLocation().AreaId == DomainManager.Taiwu.GetTaiwuVillageLocation().AreaId)
		{
			argBox.Set("Monv", character.GetId());
			return 0;
		}
		for (short num = 129; num <= 137; num++)
		{
			DomainManager.Character.TryGetFixedCharacterByTemplateId(num, out var character2);
			if (character2 != null && character2.GetLocation().AreaId == DomainManager.Taiwu.GetTaiwuVillageLocation().AreaId)
			{
				return 1;
			}
		}
		sbyte xiangshuAvatarIdByCharacterTemplateId = XiangshuAvatarIds.GetXiangshuAvatarIdByCharacterTemplateId(39);
		if (DomainManager.World.GetElement_XiangshuAvatarTaskStatuses(xiangshuAvatarIdByCharacterTemplateId).SwordTombStatus < 2)
		{
			return 2;
		}
		return 3;
	}

	public static void FulongReudhLazuliMovementDependMonv()
	{
		if (TryGetFixedCharacterByTemplateId(810, out var character))
		{
			DomainManager.Character.FulongReudhLazuliMovementDependMonv(Domain.MainThreadDataContext, character);
		}
	}

	public static void FulongAddReudhLazuliChatMysteryCount()
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(14);
		int arg = 0;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongReudhLazuliChatMysteryCount", ref arg);
		DomainManager.Extra.SaveArgToSectMainStoryEventArgBox(Domain.MainThreadDataContext, 14, "ConchShip_PresetKey_FulongReudhLazuliChatMysteryCount", ++arg);
	}

	public static int FulongGetReudhLazuliAi2LocationState()
	{
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
		if (blockData.BelongBlockId < 0)
		{
			return 3;
		}
		Location location2 = new Location(location.AreaId, blockData.BelongBlockId);
		Settlement settlementByLocation = DomainManager.Organization.GetSettlementByLocation(location2);
		if (settlementByLocation == null)
		{
			return 3;
		}
		if (settlementByLocation.GetOrgTemplateId() == 16)
		{
			return 2;
		}
		return 1;
	}

	public static string FulongGetTravelWithLazuliLocationEvent(EventArgBox eventArgBox)
	{
		if (!DomainManager.Extra.IsExtraTaskInProgress(336) && !DomainManager.Extra.IsExtraTaskInProgress(345))
		{
			return string.Empty;
		}
		int id = GetOrCreateFixedCharacterByTemplateId(474).GetId();
		eventArgBox.Set("ChickenKing", id);
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(810);
		eventArgBox.Set("ReudhLazuli", orCreateFixedCharacterByTemplateId.GetId());
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		MapBlockData mapBlockData = GetMapBlockData(location.AreaId, location.BlockId);
		MapBlockData rootBlock = mapBlockData.GetRootBlock();
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(14);
		MapBlockItem config = rootBlock.GetConfig();
		EMapBlockSubType subType = config.SubType;
		if ((subType == EMapBlockSubType.Fuzhou || subType == EMapBlockSubType.Shouchun || subType == EMapBlockSubType.Yangzhou) ? true : false)
		{
			if (!sectMainStoryEventArgBox.Contains<bool>("ConchShip_PresetKey_FulongTravelWithLazuliCityTriggered"))
			{
				SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongTravelWithLazuliCityTriggered", value: true);
				return "3cf8d2b1-0684-43df-9423-d52b9dcfcc1f";
			}
			return string.Empty;
		}
		if (config.Type == EMapBlockType.Sect && config.SubType != EMapBlockSubType.FulongTan)
		{
			if (!sectMainStoryEventArgBox.Contains<bool>("ConchShip_PresetKey_FulongTravelWithLazuliSectTriggered"))
			{
				SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongTravelWithLazuliSectTriggered", value: true);
				return "42ab2896-df4f-4c62-a3bb-519d04257835";
			}
			return string.Empty;
		}
		if (config.TemplateId == 0 && DomainManager.Extra.IsExtraTaskInProgress(345))
		{
			if (!sectMainStoryEventArgBox.Contains<bool>("ConchShip_PresetKey_FulongTravelWithLazuliTaiwuVillageTriggered"))
			{
				SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongTravelWithLazuliTaiwuVillageTriggered", value: true);
				return "034492a8-e1a5-40c8-99bf-87b1b6d0d080";
			}
			return string.Empty;
		}
		if (config.TemplateId == 34 && AtTargetArea(location))
		{
			if (!sectMainStoryEventArgBox.Contains<bool>("ConchShip_PresetKey_FulongTravelWithLazuliVillageTriggered"))
			{
				SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongTravelWithLazuliVillageTriggered", value: true);
				return "bb456d3f-5598-4c34-9784-2f3c2e17fb43";
			}
			return string.Empty;
		}
		if (config.TemplateId == 35 && AtTargetArea(location))
		{
			if (!sectMainStoryEventArgBox.Contains<bool>("ConchShip_PresetKey_FulongTravelWithLazuliTownTriggered"))
			{
				SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongTravelWithLazuliTownTriggered", value: true);
				return "ef05aa29-0841-4bf1-b951-3856bf6ac993";
			}
			return string.Empty;
		}
		if (config.TemplateId == 36 && AtTargetArea(location))
		{
			if (!sectMainStoryEventArgBox.Contains<bool>("ConchShip_PresetKey_FulongTravelWithLazuliStockadeTriggered"))
			{
				SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongTravelWithLazuliStockadeTriggered", value: true);
				return "08a7773e-e5fa-43fd-9c00-92edd8710891";
			}
			return string.Empty;
		}
		if (DomainManager.Extra.TryGetAnimalsByLocation(location, out var animals) && animals.Count > 0)
		{
			for (int num = animals.Count - 1; num >= 0; num--)
			{
				if (FiveLoongDlcEntry.IsCharacterLoong(animals[num].CharacterTemplateId) || FiveLoongDlcEntry.IsCharacterMinionLoong(animals[num].CharacterTemplateId) || animals[num].ItemKey.IsValid())
				{
					animals.RemoveAt(num);
				}
			}
			if (animals.Count <= 0)
			{
				return string.Empty;
			}
			if (!sectMainStoryEventArgBox.Contains<bool>("ConchShip_PresetKey_FulongTravelWithLazuliAnimalTriggered"))
			{
				eventArgBox.Set("AnimalTemplateId", animals[0].CharacterTemplateId);
				SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongTravelWithLazuliAnimalTriggered", value: true);
				return "b8b34225-1aae-41e4-a72c-6a757ced4c49";
			}
		}
		if (mapBlockData.TemplateEnemyList != null)
		{
			string text = string.Empty;
			for (int i = 0; i < mapBlockData.TemplateEnemyList.Count; i++)
			{
				short templateId = mapBlockData.TemplateEnemyList[i].TemplateId;
				if (templateId >= 298 && templateId <= 306)
				{
					if (!sectMainStoryEventArgBox.Contains<bool>("ConchShip_PresetKey_FulongTravelWithLazuliXiangshuMinionTriggered"))
					{
						eventArgBox.Set("EnemyTemplateId", mapBlockData.TemplateEnemyList[i].TemplateId);
						SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongTravelWithLazuliXiangshuMinionTriggered", value: true);
						text = "e12aabfa-3947-4ce2-b16b-005a7f193966";
						break;
					}
					continue;
				}
				templateId = mapBlockData.TemplateEnemyList[i].TemplateId;
				if (templateId >= 307 && templateId <= 315)
				{
					sbyte fameType = taiwu.GetFameType();
					if (fameType != 1 && fameType != 0)
					{
						text = string.Empty;
						break;
					}
				}
				if (!sectMainStoryEventArgBox.Contains<bool>("ConchShip_PresetKey_FulongTravelWithLazuliRandomEnemyTriggered"))
				{
					eventArgBox.Set("EnemyTemplateId", mapBlockData.TemplateEnemyList[i].TemplateId);
					SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongTravelWithLazuliRandomEnemyTriggered", value: true);
					text = "209b1ffb-b465-4d37-8111-1191d9769b11";
					break;
				}
			}
			if (!text.Equals(string.Empty))
			{
				DomainManager.Map.ClearBlockRandomEnemies(Domain.MainThreadDataContext, mapBlockData);
			}
			return text;
		}
		int arg = 0;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongTravelWithLazuliMoveCount", ref arg);
		SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongTravelWithLazuliMoveCount", ++arg);
		int arg2 = 0;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongTravelWithLazuliMoveAreaId", ref arg2);
		if (arg > 6 || arg2 != location.AreaId)
		{
			if (arg2 != location.AreaId)
			{
				SaveArgToSectMainStory((sbyte)14, "ConchShip_PresetKey_FulongTravelWithLazuliMoveAreaId", (int)location.AreaId);
			}
			if (!sectMainStoryEventArgBox.Contains<bool>("ConchShip_PresetKey_FulongTravelWithLazuliChicken1"))
			{
				SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongTravelWithLazuliChicken1", value: true);
				SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongTravelWithLazuliMoveCount", 0);
				return "242a1283-5b57-4c40-80f6-6a6e7d7be970";
			}
			if (!sectMainStoryEventArgBox.Contains<bool>("ConchShip_PresetKey_FulongTravelWithLazuliChicken2"))
			{
				SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongTravelWithLazuliChicken2", value: true);
				SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongTravelWithLazuliMoveCount", 0);
				return "97c2d89a-ab79-4960-a469-b433133510cb";
			}
		}
		return string.Empty;
		static bool AtTargetArea(Location location2)
		{
			short areaIdByAreaTemplateId = DomainManager.Map.GetAreaIdByAreaTemplateId(13);
			short areaIdByAreaTemplateId2 = DomainManager.Map.GetAreaIdByAreaTemplateId(9);
			short areaIdByAreaTemplateId3 = DomainManager.Map.GetAreaIdByAreaTemplateId(15);
			if (location2.AreaId == areaIdByAreaTemplateId || location2.AreaId == areaIdByAreaTemplateId2 || location2.AreaId == areaIdByAreaTemplateId3)
			{
				return true;
			}
			return false;
		}
	}

	public static bool FulongCanTriggerWorldView()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(14);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongTravelWithLazuliWorldViewTriggered", ref arg);
		if (arg)
		{
			return false;
		}
		bool arg2 = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongTravelWithLazuliCityTriggered", ref arg2);
		bool arg3 = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongTravelWithLazuliTownTriggered", ref arg3);
		bool arg4 = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongTravelWithLazuliStockadeTriggered", ref arg4);
		bool arg5 = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongTravelWithLazuliVillageTriggered", ref arg5);
		return arg2 && (arg3 || arg4 || arg5);
	}

	public static int FulongGetCharacterFavorTaiwu()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		MapBlockData mapBlockData = GetMapBlockData(location.AreaId, location.BlockId);
		if (mapBlockData.CharacterSet != null)
		{
			foreach (int item in mapBlockData.CharacterSet)
			{
				if (!DomainManager.Character.TryGetElement_Objects(item, out var element) || element.GetOrganizationInfo().OrgTemplateId != 14 || DomainManager.Character.GetFavorabilityType(item, taiwu.GetId()) < 4)
				{
					continue;
				}
				return item;
			}
		}
		return -1;
	}

	public static ItemKey FulongAdventureTwoGetItem()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		ItemKey invalid = ItemKey.Invalid;
		int num = mainThreadDataContext.Random.Next(0, 10);
		if (num < 3)
		{
			invalid.ItemType = 7;
			invalid.TemplateId = (short)mainThreadDataContext.Random.Next(4, 7);
		}
		else
		{
			invalid.ItemType = 5;
			invalid.TemplateId = (short)mainThreadDataContext.Random.Next(70, 77);
		}
		return invalid;
	}

	public static bool FulongSpecialInteractVisible(GameData.Domains.Character.Character character)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(14);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongSpecialInteractOpen", ref arg);
		if (!arg)
		{
			return false;
		}
		int arg2 = int.MaxValue;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongMessengerAppearTime", ref arg2);
		bool flag = GetGameDate() > arg2 + 3;
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		bool flag2 = !flag;
		bool flag3 = flag2;
		if (flag3)
		{
			bool flag4;
			switch (organizationInfo.OrgTemplateId)
			{
			case 16:
			case 29:
			case 33:
			case 35:
				flag4 = true;
				break;
			default:
				flag4 = false;
				break;
			}
			flag3 = flag4;
		}
		if (flag3)
		{
			return IsCharacterAtOrganizationRange(character, organizationInfo.OrgTemplateId);
		}
		if (flag && ((OrganizationDomain.IsSect(organizationInfo.OrgTemplateId) && organizationInfo.OrgTemplateId != 14) || organizationInfo.OrgTemplateId == 16))
		{
			return true;
		}
		return false;
	}

	public static string FulongSpecialInteractNextEvent(GameData.Domains.Character.Character character)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(14);
		int arg = int.MaxValue;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongMessengerAppearTime", ref arg);
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		sbyte behaviorType = character.GetBehaviorType();
		bool flag = GetGameDate() > arg + 3;
		if (organizationInfo.OrgTemplateId == 16)
		{
			return behaviorType switch
			{
				0 => flag ? "3e5b729e-63d8-4904-9ecf-76266613d95b" : "54591fc6-08a4-4c0b-8620-ba880a21727e", 
				1 => flag ? "e86f3b22-786f-43aa-9263-bf495115aa68" : "8925fd51-ac10-4618-95b0-a5e6a7cc8888", 
				2 => flag ? "d58e7e0d-a4b4-4f70-98fd-74f52ab48019" : "7e7be4f2-e808-4ae3-a362-11bb24ae3100", 
				3 => flag ? "d8d34bf7-021a-40d5-9f9f-b1e3485ab4ff" : "19b88a46-f36e-43dc-94dd-bf1ed4a7c4e1", 
				_ => flag ? "2b4602c5-6bfd-4141-8280-cba2919cf36c" : "6d35bc38-d14d-4a09-8af8-1d514905fe40", 
			};
		}
		return behaviorType switch
		{
			0 => flag ? "127c64b8-54c6-4c55-9acc-d0b20b06e670" : "b36ad879-64f8-4f2b-bdd3-9bcc87ea7bb6", 
			1 => flag ? "8d21d525-38b3-44a0-a6aa-b21e42f303c4" : "4f483d50-afef-478a-a8ce-3eb4736d2cb9", 
			2 => flag ? "681e63eb-d37e-4298-8d85-cea87daa2315" : "d1e99f71-7546-43bf-9b1c-814baf9a150e", 
			3 => flag ? "744e56ba-bfd4-4e22-8f29-23e4fe7b5551" : "6b35d868-8c13-41d9-93e3-1e1914a483a4", 
			_ => flag ? "a8b2d819-e6bd-49a1-ab71-bad4b36b5208" : "c5fdedc5-04ac-4ae6-b65a-1c261c4e4916", 
		};
	}

	public static bool FulongCheckChickenFeather()
	{
		if (!DomainManager.Extra.IsExtraTaskInProgress(338))
		{
			return false;
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
		Location location2 = blockData.GetRootBlock().GetLocation();
		if (DomainManager.Taiwu.GetTaiwuVillageLocation().Equals(location2))
		{
			return false;
		}
		Settlement settlementByLocation = DomainManager.Organization.GetSettlementByLocation(location2);
		if (settlementByLocation != null)
		{
			List<int> locationChicken = DomainManager.Building.GetLocationChicken(location2);
			List<int> sectFulongLoseFeatherChickens = DomainManager.Extra.GetSectFulongLoseFeatherChickens();
			for (int i = 0; i < locationChicken.Count; i++)
			{
				int item = locationChicken[i];
				if (sectFulongLoseFeatherChickens.Count <= 0 || !sectFulongLoseFeatherChickens.Contains(item))
				{
					return true;
				}
			}
		}
		return false;
	}

	public static bool FulongLazuliLetterCanTrigger()
	{
		if (!DomainManager.Extra.IsExtraTaskInProgress(338))
		{
			return false;
		}
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(14);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(14);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongLazuliLetterTriggered", ref arg);
		if (arg)
		{
			return false;
		}
		if (settlementByOrgTemplateId.GetLocation().AreaId != location.AreaId)
		{
			return true;
		}
		int arg2 = 0;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongChickenKingLetterMoveCount", ref arg2);
		if (arg2 >= 4)
		{
			return true;
		}
		SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongChickenKingLetterMoveCount", ++arg2);
		return false;
	}

	public static void FulongCreateMessenger()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		short templateIdOfFixedCharacterCombatWith = SectMainStoryRelatedConstants.GetTemplateIdOfFixedCharacterCombatWith(820, 5);
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		List<sbyte> list2 = new List<sbyte> { 16, 35, 33, 29 };
		IntList value = IntList.Create();
		for (int i = 0; i < list2.Count; i++)
		{
			Location location = DomainManager.Organization.GetSettlementByOrgTemplateId(list2[i]).GetLocation();
			list.Clear();
			DomainManager.Map.GetSettlementBlocksAndAffiliatedBlocks(location.AreaId, location.BlockId, list);
			CollectionUtils.Shuffle(mainThreadDataContext.Random, list);
			int random = GetRandom(3, 6);
			for (int j = 0; j < random; j++)
			{
				int num = CreateNonIntelligentCharacter(templateIdOfFixedCharacterCombatWith);
				value.Items.Add(num);
				GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(num);
				Location targetLocation = new Location(location.AreaId, list[j]);
				MoveFixedEnemy(element_Objects, targetLocation);
			}
		}
		SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongMessengerIdList", value);
		ObjectPool<List<short>>.Instance.Return(list);
	}

	public static void FulongRemoveMessengerAndZealot()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(14);
		IntList intList = sectMainStoryEventArgBox.Get<IntList>("ConchShip_PresetKey_FulongMessengerIdList");
		if (intList.Items != null)
		{
			for (int i = 0; i < intList.Items.Count; i++)
			{
				int objectId = intList.Items[i];
				if (DomainManager.Character.TryGetElement_Objects(objectId, out var element))
				{
					RemoveNonIntelligentCharacter(element);
				}
			}
		}
		DomainManager.Extra.RemoveAllFulongOutLaws(Domain.MainThreadDataContext);
	}

	public static void ApplyTaiwuKillFulongOutLaw(int robberId)
	{
		DomainManager.Extra.ApplyTaiwuKillFulongOutLaw(Domain.MainThreadDataContext, robberId);
	}

	public static void ProcessFulongOutLawRobbing(int robberId, int victimId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.ApplyFulongOutLawRobSucceed(mainThreadDataContext, robberId, victimId);
	}

	public static void ApplyTaiwuGetRobbedByFulongOutLaws(sbyte resourceType, int resourceValue, int robberId, int victimId)
	{
		DomainManager.Extra.ApplyTaiwuGetRobbedByFulongOutLaws(Domain.MainThreadDataContext, resourceType, resourceValue, robberId, victimId);
	}

	public static int FulongLazuliPersuadeSetCharacter()
	{
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(14);
		List<int> list = new List<int>();
		settlementByOrgTemplateId.GetMembers().GetAllMembers(list);
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		CollectionUtils.Shuffle(mainThreadDataContext.Random, list);
		for (int i = 0; i < list.Count; i++)
		{
			int num = list[i];
			if (DomainManager.Character.TryGetElement_Objects(num, out var element) && element.GetAgeGroup() >= 2 && element.GetOrganizationInfo().Grade <= 6 && !element.IsActiveExternalRelationState(60) && element.GetKidnapperId() < 0 && element.GetLegendaryBookOwnerState() != 3 && element.GetLegendaryBookOwnerState() != 2 && !element.IsCompletelyInfected())
			{
				return num;
			}
		}
		return -1;
	}

	public static void FulongCreateAdvenrureThree()
	{
		SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongSpecialInteractOpen", value: false);
		DomainManager.TaiwuEvent.AddTempDynamicAction(Domain.MainThreadDataContext, new FulongStoryAdventureThreeTriggerAction());
	}

	public static void FulongAdvenrureThreeSetCharacter(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("MajorCharacter_0_1");
		if (IsTemporaryIntelligentCharacter(character.GetId()))
		{
			KeepTemporaryCharacterAfterAdventure(character);
		}
		argBox.Set("FulongFriend1", character.GetId());
		GameData.Domains.Character.Character character2 = argBox.GetCharacter("MajorCharacter_0_2");
		if (IsTemporaryIntelligentCharacter(character2.GetId()))
		{
			KeepTemporaryCharacterAfterAdventure(character2);
		}
		argBox.Set("FulongFriend2", character2.GetId());
		GameData.Domains.Character.Character character3 = argBox.GetCharacter("MajorCharacter_0_3");
		if (IsTemporaryIntelligentCharacter(character3.GetId()))
		{
			KeepTemporaryCharacterAfterAdventure(character3);
		}
		argBox.Set("FulongFriend3", character3.GetId());
	}

	public static void FulongAdventureThreePathEventSetCharacterId(EventArgBox argBox, int count)
	{
		argBox.Set("CharacterId", (count switch
		{
			0 => argBox.GetCharacter("MajorCharacter_0_4"), 
			1 => argBox.GetCharacter("MajorCharacter_0_5"), 
			2 => argBox.GetCharacter("MajorCharacter_0_6"), 
			_ => argBox.GetCharacter("MajorCharacter_0_7"), 
		}).GetId());
	}

	public static bool FulongLazuliIsFriend()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(14);
		bool arg = false;
		if (sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongLazuliIsFriend", ref arg) && arg)
		{
			return true;
		}
		return false;
	}

	public static void FulongLazuliAddFavorability()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(810);
		DirectlyChangeFavorabilityOptionalStoryEvent(orCreateFixedCharacterByTemplateId, taiwu, SectMainStoryRelatedConstants.FulongLazuliFavorabilityAdd);
	}

	public static void FulongLazuliSetFavorability()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(810);
		sbyte favorabilityType = GetFavorabilityType(orCreateFixedCharacterByTemplateId, taiwu);
		if (favorabilityType < 5)
		{
			sbyte favorabilityType2 = FavorabilityType.GetFavorabilityType(5);
			DirectlySetFavorabilities(orCreateFixedCharacterByTemplateId.GetId(), taiwu.GetId(), favorabilityType2, favorabilityType2);
		}
	}

	public static void FulongEndEffect(bool goodEnd, bool adventureComplete = true)
	{
		FinishAllTaskInChain(52);
		SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongChickenKingLeaveHome", value: false);
		if (adventureComplete)
		{
			SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongSpecialFuncOpen", value: true);
		}
		SaveArgToSectMainStory(14, goodEnd ? "ConchShip_PresetKey_SectMainStoryFulongProsperousEndDate" : "ConchShip_PresetKey_SectMainStoryFulongFailingEndDate", GetGameDate() + (goodEnd ? 1 : 1));
		if (!goodEnd)
		{
			FulongDefeatEffect();
		}
	}

	public static void FulongCombatWonEffect()
	{
		TriggerExtraTask(52, 341);
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(812);
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(14);
		List<MapBlockData> mapBlockList = ObjectPool<List<MapBlockData>>.Instance.Get();
		DomainManager.Map.GetLocationByDistance(settlementByOrgTemplateId.GetLocation(), 6, 6, ref mapBlockList);
		Location targetLocation = Location.Invalid;
		for (int i = 0; i < mapBlockList.Count; i++)
		{
			MapBlockData mapBlockData = mapBlockList[i];
			MapBlockItem config = mapBlockData.GetConfig();
			if (config.TemplateId != 124 && config.SubType != EMapBlockSubType.DLCLoong)
			{
				targetLocation = mapBlockData.GetLocation();
			}
		}
		if (targetLocation.Equals(Location.Invalid))
		{
			targetLocation = mapBlockList.GetRandom(Domain.MainThreadDataContext.Random).GetLocation();
		}
		MoveFixedCharacter(orCreateFixedCharacterByTemplateId, targetLocation);
		ObjectPool<List<MapBlockData>>.Instance.Return(mapBlockList);
	}

	public static void FulongDefeatEffect()
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(810);
		MoveFixedCharacter(orCreateFixedCharacterByTemplateId, Location.Invalid);
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId2 = GetOrCreateFixedCharacterByTemplateId(813);
		MoveFixedCharacter(orCreateFixedCharacterByTemplateId2, Location.Invalid);
	}

	public static void FulongLazuliFavorabilityInherit(GameData.Domains.Character.Character character)
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(810);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		short favorability = GetFavorability(orCreateFixedCharacterByTemplateId, taiwu);
		DirectlySetFavorabilities(character.GetId(), taiwu.GetId(), favorability, favorability);
	}

	public static void FulongEndTryRemoveFixedCharacter()
	{
		for (short num = 810; num <= 819; num++)
		{
			if (num != 812)
			{
				GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(num);
				RemoveNonIntelligentCharacter(orCreateFixedCharacterByTemplateId);
			}
		}
	}

	public static void FulongAddLoseFeatherChicken(int chickenId, short chickenTemplateId)
	{
		List<int> sectFulongLoseFeatherChickens = DomainManager.Extra.GetSectFulongLoseFeatherChickens();
		sectFulongLoseFeatherChickens.Add(chickenId);
		DomainManager.Extra.SetSectFulongLoseFeatherChickens(sectFulongLoseFeatherChickens, Domain.MainThreadDataContext);
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(14);
		GameData.Utilities.ShortList value = sectMainStoryEventArgBox.Get<GameData.Utilities.ShortList>("ConchShip_PresetKey_FulongChickenFeatherDropList");
		if (value.Items == null)
		{
			value = GameData.Utilities.ShortList.Create();
		}
		value.Items.Add(chickenTemplateId);
		DomainManager.Extra.SaveArgToSectMainStoryEventArgBox(Domain.MainThreadDataContext, 14, "ConchShip_PresetKey_FulongChickenFeatherDropList", value);
	}

	public static bool FulongChickenLoseFeather(int chickenId)
	{
		List<int> sectFulongLoseFeatherChickens = DomainManager.Extra.GetSectFulongLoseFeatherChickens();
		return sectFulongLoseFeatherChickens.Contains(chickenId);
	}

	public static void FulongChickenLoseFeatherSaveSettlement(int characterId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(characterId);
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(14);
		GameData.Utilities.ShortList value = sectMainStoryEventArgBox.Get<GameData.Utilities.ShortList>("ConchShip_PresetKey_FulongLoseChickenFeatherInteractionSettlements");
		if (value.Items == null)
		{
			value = GameData.Utilities.ShortList.Create();
		}
		value.Items.Add(element_Objects.GetOrganizationInfo().SettlementId);
		SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongLoseChickenFeatherInteractionSettlements", value);
	}

	public static void FulongChickenKingLoseFeather()
	{
		List<int> sectFulongLoseFeatherChickens = DomainManager.Extra.GetSectFulongLoseFeatherChickens();
		sectFulongLoseFeatherChickens.Add(DomainManager.Building.GetChickenKingId());
		SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongChickenFeatherLackCount", (SectMainStoryRelatedConstants.FulongChickenFeatherNeedCount - sectFulongLoseFeatherChickens.Count).ToString());
		DomainManager.Extra.SetSectFulongLoseFeatherChickens(sectFulongLoseFeatherChickens, Domain.MainThreadDataContext);
	}

	public static int FulongGetLoseChickenFeatherCount()
	{
		List<int> sectFulongLoseFeatherChickens = DomainManager.Extra.GetSectFulongLoseFeatherChickens();
		SaveArgToSectMainStory(14, "ConchShip_PresetKey_FulongChickenFeatherLackCount", (SectMainStoryRelatedConstants.FulongChickenFeatherNeedCount - sectFulongLoseFeatherChickens.Count).ToString());
		return sectFulongLoseFeatherChickens.Count;
	}

	public static bool FulongCanUseTeammateLoseChickenFeather()
	{
		HashSet<int> collection = DomainManager.Taiwu.GetGroupCharIds().GetCollection();
		int num = 0;
		foreach (int item in collection)
		{
			if (item != DomainManager.Taiwu.GetTaiwuCharId())
			{
				GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(item);
				if (element_Objects.GetAgeGroup() > 0)
				{
					num++;
				}
			}
		}
		return num >= 2;
	}

	public static List<string> FulongGetChickenText(int index)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(14);
		int arg = 0;
		int arg2 = 0;
		int arg3 = 0;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongLazuliLetterEventA", ref arg);
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongLazuliLetterEventB", ref arg2);
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongLazuliLetterEventC", ref arg3);
		List<string> list = new List<string>();
		switch (index)
		{
		case 1:
		{
			if (1 == 0)
			{
			}
			string text = arg switch
			{
				0 => "<Language Key=Event_SectStoryFulong_ChickenKing_1_1/>", 
				1 => "<Language Key=Event_SectStoryFulong_ChickenKing_1_2/>", 
				2 => "<Language Key=Event_SectStoryFulong_ChickenKing_1_3/>", 
				_ => throw new Exception($"Unsupported eventA: {arg}"), 
			};
			if (1 == 0)
			{
			}
			string item = text;
			list.Add(item);
			if (1 == 0)
			{
			}
			text = arg2 switch
			{
				0 => "<Language Key=Event_SectStoryFulong_ChickenKing_1_4/>", 
				1 => "<Language Key=Event_SectStoryFulong_ChickenKing_1_5/>", 
				2 => "<Language Key=Event_SectStoryFulong_ChickenKing_1_6/>", 
				_ => throw new Exception($"Unsupported eventA: {arg2}"), 
			};
			if (1 == 0)
			{
			}
			item = text;
			list.Add(item);
			if (1 == 0)
			{
			}
			text = arg3 switch
			{
				0 => "<Language Key=Event_SectStoryFulong_ChickenKing_1_7/>", 
				1 => "<Language Key=Event_SectStoryFulong_ChickenKing_1_8/>", 
				2 => "<Language Key=Event_SectStoryFulong_ChickenKing_1_9/>", 
				_ => throw new Exception($"Unsupported eventA: {arg3}"), 
			};
			if (1 == 0)
			{
			}
			item = text;
			list.Add(item);
			break;
		}
		case 2:
		{
			if (1 == 0)
			{
			}
			string text = arg switch
			{
				0 => "<Language Key=Event_SectStoryFulong_ChickenKing_2_1/>", 
				1 => "<Language Key=Event_SectStoryFulong_ChickenKing_2_2/>", 
				2 => "<Language Key=Event_SectStoryFulong_ChickenKing_2_3/>", 
				_ => throw new Exception($"Unsupported eventA: {arg}"), 
			};
			if (1 == 0)
			{
			}
			string item = text;
			list.Add(item);
			if (1 == 0)
			{
			}
			text = arg2 switch
			{
				0 => "<Language Key=Event_SectStoryFulong_ChickenKing_2_4/>", 
				1 => "<Language Key=Event_SectStoryFulong_ChickenKing_2_5/>", 
				2 => "<Language Key=Event_SectStoryFulong_ChickenKing_2_6/>", 
				_ => throw new Exception($"Unsupported eventA: {arg2}"), 
			};
			if (1 == 0)
			{
			}
			item = text;
			list.Add(item);
			if (1 == 0)
			{
			}
			text = arg3 switch
			{
				0 => "<Language Key=Event_SectStoryFulong_ChickenKing_2_7/>", 
				1 => "<Language Key=Event_SectStoryFulong_ChickenKing_2_8/>", 
				2 => "<Language Key=Event_SectStoryFulong_ChickenKing_2_9/>", 
				_ => throw new Exception($"Unsupported eventA: {arg3}"), 
			};
			if (1 == 0)
			{
			}
			item = text;
			list.Add(item);
			break;
		}
		case 3:
		{
			if (1 == 0)
			{
			}
			string text = arg switch
			{
				0 => "<Language Key=Event_SectStoryFulong_ChickenKing_3_1/>", 
				1 => "<Language Key=Event_SectStoryFulong_ChickenKing_3_2/>", 
				_ => throw new Exception($"Unsupported eventA: {arg}"), 
			};
			if (1 == 0)
			{
			}
			string item = text;
			list.Add(item);
			if (1 == 0)
			{
			}
			text = arg2 switch
			{
				0 => "<Language Key=Event_SectStoryFulong_ChickenKing_3_3/>", 
				1 => "<Language Key=Event_SectStoryFulong_ChickenKing_3_4/>", 
				_ => throw new Exception($"Unsupported eventA: {arg2}"), 
			};
			if (1 == 0)
			{
			}
			item = text;
			list.Add(item);
			if (1 == 0)
			{
			}
			text = arg3 switch
			{
				0 => "<Language Key=Event_SectStoryFulong_ChickenKing_3_5/>", 
				1 => "<Language Key=Event_SectStoryFulong_ChickenKing_3_6/>", 
				_ => throw new Exception($"Unsupported eventA: {arg3}"), 
			};
			if (1 == 0)
			{
			}
			item = text;
			list.Add(item);
			break;
		}
		case 4:
		{
			if (1 == 0)
			{
			}
			string text = arg switch
			{
				0 => "<Language Key=Event_SectStoryFulong_ChickenKing_4_1/>", 
				1 => "<Language Key=Event_SectStoryFulong_ChickenKing_4_2/>", 
				_ => throw new Exception($"Unsupported eventA: {arg}"), 
			};
			if (1 == 0)
			{
			}
			string item = text;
			list.Add(item);
			if (1 == 0)
			{
			}
			text = arg2 switch
			{
				0 => "<Language Key=Event_SectStoryFulong_ChickenKing_4_3/>", 
				1 => "<Language Key=Event_SectStoryFulong_ChickenKing_4_4/>", 
				_ => throw new Exception($"Unsupported eventA: {arg2}"), 
			};
			if (1 == 0)
			{
			}
			item = text;
			list.Add(item);
			if (1 == 0)
			{
			}
			text = arg3 switch
			{
				0 => "<Language Key=Event_SectStoryFulong_ChickenKing_4_5/>", 
				1 => "<Language Key=Event_SectStoryFulong_ChickenKing_4_6/>", 
				_ => throw new Exception($"Unsupported eventA: {arg3}"), 
			};
			if (1 == 0)
			{
			}
			item = text;
			list.Add(item);
			break;
		}
		}
		return list;
	}

	public static bool FulongChickenNpcRandomWordTriggered(GameData.Domains.Character.Character character)
	{
		if (!IsExtraTaskInProgress(338))
		{
			return false;
		}
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		Settlement settlement = DomainManager.Organization.GetSettlement(organizationInfo.SettlementId);
		List<int> settlementChickenIdList = DomainManager.Building.GetSettlementChickenIdList(settlement.GetLocation());
		if (settlementChickenIdList.Count == 0)
		{
			return false;
		}
		List<int> sectFulongLoseFeatherChickens = DomainManager.Extra.GetSectFulongLoseFeatherChickens();
		for (int i = 0; i < settlementChickenIdList.Count; i++)
		{
			int item = settlementChickenIdList[i];
			if (sectFulongLoseFeatherChickens.Contains(item))
			{
				return true;
			}
		}
		return false;
	}

	public static bool FulongProsperousNpcRandomWordTriggered(GameData.Domains.Character.Character character)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(14);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongSelectFalling", ref arg);
		if (arg)
		{
			return false;
		}
		int arg2 = int.MaxValue;
		if (sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongSelectFallingDate", ref arg2) && arg2 <= GetGameDate() + 2)
		{
			return true;
		}
		return false;
	}

	public static bool FulongUnfinishedSpecialOptionCanShow()
	{
		int extraTaskChainCurrentTask = DomainManager.Extra.GetExtraTaskChainCurrentTask(52);
		if (((uint)(extraTaskChainCurrentTask - 332) <= 8u || (uint)(extraTaskChainCurrentTask - 344) <= 1u) ? true : false)
		{
			return true;
		}
		return false;
	}

	public static void AddJieqingMaskCharId(int charId)
	{
		DomainManager.TaiwuEvent.AddJieqingMaskCharId(charId);
	}

	public static void RemoveJieqingMaskCharId(int charId)
	{
		DomainManager.TaiwuEvent.RemoveJieqingMaskCharId(charId);
	}

	public static void JingangMonkWasRobbedEffect()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		taiwu.AddFeature(Domain.MainThreadDataContext, 483);
		TriggerExtraTask(35, 182);
		DomainManager.Extra.SaveArgToSectMainStoryEventArgBox(Domain.MainThreadDataContext, 11, "ConchShip_PresetKey_JingangMonkMurderedTriggeredDate", GetGameDate());
	}

	public static void JingangWardOffEvilEffect()
	{
		JingangCreateMonkSoul();
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		taiwu.RemoveFeature(Domain.MainThreadDataContext, 483);
		TriggerExtraTask(35, 183);
	}

	public static void JingangCreateMonkSoul()
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(748);
		DomainManager.Character.SectMainStoryJingangCreateDeadMonk(Domain.MainThreadDataContext, orCreateFixedCharacterByTemplateId);
	}

	public static bool JingangCanTriggerWardOffEvil()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		if (!DomainManager.Extra.IsExtraTaskInProgress(182))
		{
			return false;
		}
		Location location = taiwu.GetLocation();
		if (!location.IsValid())
		{
			return false;
		}
		sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(location.AreaId);
		if (stateTemplateIdByAreaId != 11)
		{
			return false;
		}
		if (DomainManager.Map.IsAreaBroken(location.AreaId))
		{
			return false;
		}
		MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
		if (DomainManager.Map.IsBlockSpecial(blockData))
		{
			return false;
		}
		EMapBlockSubType subType = blockData.GetConfig().SubType;
		if (subType >= EMapBlockSubType.Ruin && subType <= EMapBlockSubType.None)
		{
			return false;
		}
		if (!IsCharacterAtOrganizationRange(taiwu, 11))
		{
			EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(11);
			int arg = 0;
			sectMainStoryEventArgBox.Get("ConchShip_PresetKey_JingangAfterMonkMurderedTriggeredMoveCount", ref arg);
			SaveArgToSectMainStory(11, "ConchShip_PresetKey_JingangAfterMonkMurderedTriggeredMoveCount", ++arg);
			if (arg >= 10)
			{
				return true;
			}
		}
		return false;
	}

	public static bool JingangCanTriggerJingangPeopleSuffering()
	{
		if (!DomainManager.Extra.IsExtraTaskInProgress(185) && !DomainManager.Extra.IsExtraTaskInProgress(179))
		{
			return false;
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		short areaIdByAreaTemplateId = DomainManager.Map.GetAreaIdByAreaTemplateId(26);
		if (location.AreaId != areaIdByAreaTemplateId)
		{
			return false;
		}
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		List<short> list2 = ObjectPool<List<short>>.Instance.Get();
		DomainManager.Map.GetAreaSettlementIds(areaIdByAreaTemplateId, list, containsMainCity: true);
		for (int i = 0; i < list.Count; i++)
		{
			Settlement settlement = DomainManager.Organization.GetSettlement(list[i]);
			Location location2 = settlement.GetLocation();
			list2.Clear();
			DomainManager.Map.GetSettlementBlocksAndAffiliatedBlocks(location2.AreaId, location2.BlockId, list2);
			if (list2.Contains(location.BlockId))
			{
				ObjectPool<List<short>>.Instance.Return(list2);
				ObjectPool<List<short>>.Instance.Return(list);
				return true;
			}
		}
		ObjectPool<List<short>>.Instance.Return(list2);
		ObjectPool<List<short>>.Instance.Return(list);
		return false;
	}

	public static void JingangSavePeopleSufferingCount()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(11);
		int arg = 0;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_JingangTriggeredPeopleSufferingCount", ref arg);
		SaveArgToSectMainStory(11, "ConchShip_PresetKey_JingangTriggeredPeopleSufferingCount", ++arg);
	}

	public static int JingangGetPeopleSufferingSettlementIdsCount()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(11);
		int arg = 0;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_JingangTriggeredPeopleSufferingCount", ref arg);
		return arg;
	}

	public static void JingangAddPersuadeVillagerCount()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(11);
		int arg = 0;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_JingangPersuadeVillagerCount", ref arg);
		arg++;
		SaveArgToSectMainStory(11, "ConchShip_PresetKey_JingangPersuadeVillagerCount", arg);
	}

	public static bool JingangPersuadeIsSuccess()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(11);
		int arg = 0;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_JingangPersuadeVillagerCount", ref arg);
		return arg >= 1;
	}

	public static bool JingangVillagerCanInteraction(int charId)
	{
		DomainManager.Character.TryGetElement_Objects(charId, out var element);
		OrganizationInfo organizationInfo = element.GetOrganizationInfo();
		OrganizationItem organizationItem = Config.Organization.Instance[organizationInfo.OrgTemplateId];
		if (organizationItem.IsSect)
		{
			return false;
		}
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		short areaIdByAreaTemplateId = DomainManager.Map.GetAreaIdByAreaTemplateId(26);
		DomainManager.Map.GetAreaSettlementIds(areaIdByAreaTemplateId, list, containsMainCity: true);
		if (!list.Contains(organizationInfo.SettlementId))
		{
			ObjectPool<List<short>>.Instance.Return(list);
			return false;
		}
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(11);
		sectMainStoryEventArgBox.Get<IntList>("ConchShip_PresetKey_JingangTriggeredInteractionVillagers", out IntList arg);
		if (arg.Items != null && arg.Items.Contains(charId))
		{
			ObjectPool<List<short>>.Instance.Return(list);
			return false;
		}
		List<int> items = arg.Items;
		if (items != null && items.Count >= 5)
		{
			ObjectPool<List<short>>.Instance.Return(list);
			return false;
		}
		ObjectPool<List<short>>.Instance.Return(list);
		return DomainManager.Extra.IsExtraTaskInProgress(179) || DomainManager.Extra.IsExtraTaskInProgress(186) || DomainManager.Extra.IsExtraTaskInProgress(180) || DomainManager.Extra.IsExtraTaskInProgress(181) || DomainManager.Extra.IsExtraTaskInProgress(187) || DomainManager.Extra.IsExtraTaskInProgress(188) || DomainManager.Extra.IsExtraTaskInProgress(189) || DomainManager.Extra.IsExtraTaskInProgress(190) || DomainManager.Extra.IsExtraTaskInProgress(191) || DomainManager.Extra.IsExtraTaskInProgress(192);
	}

	public static void JingangAddVillagerInteraction(int charId)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(11);
		sectMainStoryEventArgBox.Get<IntList>("ConchShip_PresetKey_JingangTriggeredInteractionVillagers", out IntList arg);
		if (arg.Items == null)
		{
			arg = IntList.Create();
		}
		arg.Items.Add(charId);
		SaveArgToSectMainStory(11, "ConchShip_PresetKey_JingangTriggeredInteractionVillagers", arg);
	}

	public static int JingangGetVillagerInteractionCount()
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(11);
		sectMainStoryEventArgBox.Get<IntList>("ConchShip_PresetKey_JingangTriggeredInteractionVillagers", out IntList arg);
		if (arg.Items == null)
		{
			return 0;
		}
		return arg.Items.Count;
	}

	public static bool JingangArriveJingangCanTrigger()
	{
		if (!DomainManager.Extra.IsExtraTaskInProgress(186) && !DomainManager.Extra.IsExtraTaskInProgress(180))
		{
			return false;
		}
		if (!IsSectAllowLearning(11))
		{
			return false;
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		return IsCharacterAtTargetSectLocation(taiwu, 11);
	}

	public static void JingangSetSectLeader(EventArgBox argBox)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		GameData.Domains.Character.Character character = TryGetSectLeaderAtLocation(taiwu.GetLocation(), 11, includeAllBlocksInGroup: true);
		if (character != null)
		{
			argBox.Set("SectLeader", character.GetId());
			return;
		}
		int arg = CreateNonIntelligentCharacter(749);
		argBox.Set("SectLeader", arg);
	}

	public static Location JingangCreateAdventure()
	{
		short areaIdByAreaTemplateId = DomainManager.Map.GetAreaIdByAreaTemplateId(11);
		Span<MapBlockData> areaBlocks = DomainManager.Map.GetAreaBlocks(areaIdByAreaTemplateId);
		Location location = Location.Invalid;
		List<MapBlockData> mapBlockList = ObjectPool<List<MapBlockData>>.Instance.Get();
		for (int i = 0; i < areaBlocks.Length; i++)
		{
			MapBlockData mapBlockData = areaBlocks[i];
			if (!mapBlockData.IsNonDeveloped())
			{
				continue;
			}
			EMapBlockSubType subType = mapBlockData.GetConfig().SubType;
			if ((subType >= EMapBlockSubType.Ruin && subType <= EMapBlockSubType.None) || DomainManager.Map.IsBlockSpecial(mapBlockData) || DomainManager.Adventure.GetAdventuresInArea(mapBlockData.AreaId).AdventureSites.ContainsKey(mapBlockData.BlockId))
			{
				continue;
			}
			Location location2 = mapBlockData.GetLocation();
			mapBlockList.Clear();
			DomainManager.Map.GetLocationByDistance(location2, 1, 1, ref mapBlockList);
			bool flag = false;
			for (int j = 0; j < mapBlockList.Count; j++)
			{
				if (!mapBlockList[j].IsNonDeveloped())
				{
					flag = true;
				}
			}
			if (flag)
			{
				location = location2;
				break;
			}
		}
		ObjectPool<List<MapBlockData>>.Instance.Return(mapBlockList);
		Tester.Assert(location != Location.Invalid);
		TryCreateAdventureSite(location.AreaId, location.BlockId, 182, setBlockVisible: true);
		return location;
	}

	public static short JingangAdventureGetFightXiangshuMinion()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		short num = 298;
		for (short num2 = 298; num2 <= 306; num2++)
		{
			num = num2;
			CharacterItem characterItem = Config.Character.Instance[num];
			if (characterItem.ConsummateLevel >= taiwu.GetConsummateLevel() + 2)
			{
				break;
			}
		}
		return num;
	}

	public static bool JingangWesternBuddhistMonkFollow()
	{
		TryGetFixedCharacterByTemplateId(623, out var character);
		if (character == null)
		{
			return false;
		}
		if (!DomainManager.World.JingangIsInSpreadSutraTask())
		{
			return false;
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location validLocation = taiwu.GetValidLocation();
		MapBlockData blockData = DomainManager.Map.GetBlockData(validLocation.AreaId, validLocation.BlockId);
		Location location = character.GetLocation();
		MapBlockData blockData2 = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
		ByteCoordinate blockPos = blockData2.GetBlockPos();
		if (blockData.GetManhattanDistanceToPos(blockPos.X, blockPos.Y) > 2)
		{
			DataContext mainThreadDataContext = Domain.MainThreadDataContext;
			List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
			DomainManager.Map.GetRealNeighborBlocks(validLocation.AreaId, validLocation.BlockId, list, 2);
			for (int num = list.Count - 1; num >= 0; num--)
			{
				MapBlockData mapBlockData = list[num];
				if (IsLocationAtOrganizationRange(mapBlockData.GetLocation(), 11))
				{
					list.RemoveAt(num);
				}
			}
			if (list.Count > 0)
			{
				MapBlockData mapBlockData2 = list[mainThreadDataContext.Random.Next(0, list.Count)];
				MoveFixedCharacter(character, mapBlockData2.GetLocation());
			}
			ObjectPool<List<MapBlockData>>.Instance.Return(list);
		}
		return false;
	}

	public static void JingangCreateCentralPlainsMonk()
	{
		int num = JingangSpreadSecInfoStage();
		if (num == -1)
		{
			return;
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location validLocation = taiwu.GetValidLocation();
		MapBlockData taiwuMapBlockData = DomainManager.Map.GetBlockData(validLocation.AreaId, validLocation.BlockId);
		List<Location> list = new List<Location>();
		List<MapBlockData> list2 = DomainManager.Map.GetAreaBlocks(validLocation.AreaId).ToArray().ToList();
		list2.Sort((MapBlockData l, MapBlockData r) => l.GetBlockPos().GetManhattanDistance(taiwuMapBlockData.GetBlockPos()) - r.GetBlockPos().GetManhattanDistance(taiwuMapBlockData.GetBlockPos()));
		if (DomainManager.Map.IsAreaBroken(validLocation.AreaId))
		{
			for (int num2 = 0; num2 < list2.Count; num2++)
			{
				list.Add(list2[num2].GetLocation());
				if (list.Count >= 3)
				{
					break;
				}
			}
		}
		else
		{
			for (int num3 = 0; num3 < list2.Count; num3++)
			{
				if (!list2[num3].IsNonDeveloped() && list2[num3].IsPassable())
				{
					list.Add(list2[num3].GetLocation());
					if (list.Count >= 9)
					{
						break;
					}
				}
			}
		}
		short num4 = 0;
		if (num >= 0 && num <= 2)
		{
			num4 = JingangGetStartMonkTemplateIdByStage(num);
			for (short num5 = 0; num5 < 3; num5++)
			{
				GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId((short)(num5 + num4));
				MoveFixedCharacter(orCreateFixedCharacterByTemplateId, (list.Count >= 9) ? list[num5 * 3] : list[num5]);
			}
			SaveArgToSectMainStory(11, "ConchShip_PresetKey_JingangCreateCentralPlainsMonkTaiwuAreaId", validLocation.AreaId);
		}
		else if (num == 3)
		{
			GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId2 = GetOrCreateFixedCharacterByTemplateId(759);
			MoveFixedCharacter(orCreateFixedCharacterByTemplateId2, list[1]);
			SaveArgToSectMainStory(11, "ConchShip_PresetKey_JingangCreateCentralPlainsMonkTaiwuAreaId", validLocation.AreaId);
		}
	}

	public static bool JingangCentralPlainsMonkFollow()
	{
		if (!DomainManager.World.JingangIsInSpreadSutraTask())
		{
			return false;
		}
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(11);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location validLocation = taiwu.GetValidLocation();
		short arg = -1;
		if (!sectMainStoryEventArgBox.Get("ConchShip_PresetKey_JingangCreateCentralPlainsMonkTaiwuAreaId", ref arg) || validLocation.AreaId == arg)
		{
			return false;
		}
		int num = JingangSpreadSecInfoStage();
		short num2 = JingangGetStartMonkTemplateIdByStage(num);
		MapBlockData taiwuMapBlockData = DomainManager.Map.GetBlockData(validLocation.AreaId, validLocation.BlockId);
		List<Location> list = new List<Location>();
		List<MapBlockData> list2 = DomainManager.Map.GetAreaBlocks(validLocation.AreaId).ToArray().ToList();
		list2.Sort((MapBlockData l, MapBlockData r) => l.GetBlockPos().GetManhattanDistance(taiwuMapBlockData.GetBlockPos()) - r.GetBlockPos().GetManhattanDistance(taiwuMapBlockData.GetBlockPos()));
		if (DomainManager.Map.IsAreaBroken(validLocation.AreaId))
		{
			for (int num3 = 0; num3 < list2.Count; num3++)
			{
				list.Add(list2[num3].GetLocation());
				if (list.Count >= 3)
				{
					break;
				}
			}
		}
		else
		{
			for (int num4 = 0; num4 < list2.Count; num4++)
			{
				if (!list2[num4].IsNonDeveloped() && list2[num4].IsPassable())
				{
					list.Add(list2[num4].GetLocation());
					if (list.Count >= 9)
					{
						break;
					}
				}
			}
		}
		GameData.Domains.Character.Character character2;
		if (num >= 0 && num <= 2)
		{
			for (int num5 = 0; num5 < 3; num5++)
			{
				if (TryGetFixedCharacterByTemplateId((short)(num2 + num5), out var character))
				{
					MoveFixedCharacter(character, (list.Count >= 9) ? list[num5 * 3] : list[num5]);
				}
			}
		}
		else if (TryGetFixedCharacterByTemplateId(759, out character2))
		{
			MoveFixedCharacter(character2, list[1]);
		}
		SaveArgToSectMainStory(11, "ConchShip_PresetKey_JingangCreateCentralPlainsMonkTaiwuAreaId", validLocation.AreaId);
		return false;
	}

	public static void JingangEnterSpreadSutraStage()
	{
		int gameDate = GetGameDate();
		SaveArgToSectMainStory(11, "ConchShip_PresetKey_JingangAttackDate", gameDate);
		SaveArgToSectMainStory(11, "ConchShip_PresetKey_JingangLettersFromJingangDate", gameDate);
	}

	public static bool JingangSecretInformationIsSolveScripture(int metaDataId)
	{
		SecretInformationItem secretInformationConfig = GetSecretInformationConfig(metaDataId);
		short templateId = secretInformationConfig.TemplateId;
		return templateId >= 112 && templateId <= 115;
	}

	public static int JingangSpreadSecInfoStage()
	{
		return DomainManager.World.JingangSpreadSecInfoStage();
	}

	public static short JingangGetStartMonkTemplateIdByStage(int stage)
	{
		return stage switch
		{
			0 => 750, 
			1 => 753, 
			2 => 756, 
			3 => 759, 
			_ => -1, 
		};
	}

	public static void JingangAddKnowSecInfoCharId(int charId)
	{
		DomainManager.World.JingangAddKnowSecInfoCharId(Domain.MainThreadDataContext, charId);
	}

	public static bool JingangIsCharacterKnowSecInfo(int charId)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(11);
		sectMainStoryEventArgBox.Get<IntList>("ConchShip_PresetKey_JingangKnowSecInfoIdList", out IntList arg);
		if (arg.Items == null)
		{
			return false;
		}
		return arg.Items.Contains(charId);
	}

	public static void JingangAddTalkedCentralPlainsMonkId(int charId)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(11);
		sectMainStoryEventArgBox.Get<IntList>("ConchShip_PresetKey_JingangTalkedCentralPlainsMonkId", out IntList arg);
		if (arg.Items == null)
		{
			arg = IntList.Create();
		}
		if (!arg.Items.Contains(charId))
		{
			arg.Items.Add(charId);
		}
		DomainManager.Extra.SaveArgToSectMainStoryEventArgBox(Domain.MainThreadDataContext, 11, "ConchShip_PresetKey_JingangTalkedCentralPlainsMonkId", arg);
	}

	public static int JingangGetTalkedCentralPlainsMonkCount()
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(11);
		sectMainStoryEventArgBox.Get<IntList>("ConchShip_PresetKey_JingangTalkedCentralPlainsMonkId", out IntList arg);
		if (arg.Items == null)
		{
			return 0;
		}
		return arg.Items.Count;
	}

	public static void JingangClearTalkedCentralPlainsMonk()
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(11);
		sectMainStoryEventArgBox.Remove<IntList>("ConchShip_PresetKey_JingangTalkedCentralPlainsMonkId");
		SaveSectMainStoryEventArgBox(11);
	}

	public static void JingangClearKnowSecInfo()
	{
		DomainManager.World.JingangClearKnowSecInfo(Domain.MainThreadDataContext);
		SaveArgToSectMainStory(11, "ConchShip_PresetKey_JingangSamsaraMonkSoulTalked", value: false);
	}

	public static bool JingangIsEnterHelpMonkBranch()
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(11);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_JingangSelectHelpWestMonk", ref arg);
		bool arg2 = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_JingangSecInfoSpreadingSelectCombat", ref arg2);
		if (arg || arg2)
		{
			return true;
		}
		return false;
	}

	public static void JingangProsperousHandle()
	{
		DomainManager.Extra.FinishAllTaskInChain(Domain.MainThreadDataContext, 35);
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(623);
		RemoveNonIntelligentCharacter(orCreateFixedCharacterByTemplateId);
		DomainManager.Information.ReleaseAllJingangInformation(Domain.MainThreadDataContext);
	}

	public static void JingangFailingHandle()
	{
		DomainManager.Extra.FinishAllTaskInChain(Domain.MainThreadDataContext, 35);
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(623);
		RemoveNonIntelligentCharacter(orCreateFixedCharacterByTemplateId);
		DomainManager.Information.ReleaseAllJingangInformation(Domain.MainThreadDataContext);
	}

	public static void JingangDistributeSecInfo(int metaDataId, int targetCharId)
	{
		DomainManager.World.JingangDistributeSecInfo(Domain.MainThreadDataContext, metaDataId, targetCharId);
	}

	public static void JingangDistributeSecInfoInEvent(int metaDataId, int targetCharId)
	{
		DisseminateSecretInformationFromTaiwu(metaDataId, targetCharId);
	}

	public static void JingangCreateAndDistributeSecInfo(short templateId, int relateCharId)
	{
		if (1 == 0)
		{
		}
		int num = templateId switch
		{
			112 => CreateSecretInformationMetaData(GetSecretInformationCollection().AddSolveScripture1(relateCharId), withInitialDistribute: false), 
			113 => CreateSecretInformationMetaData(GetSecretInformationCollection().AddSolveScripture2(relateCharId), withInitialDistribute: false), 
			114 => CreateSecretInformationMetaData(GetSecretInformationCollection().AddSolveScripture3(relateCharId), withInitialDistribute: false), 
			115 => CreateSecretInformationMetaData(GetSecretInformationCollection().AddSolveScripture4(relateCharId), withInitialDistribute: false), 
			_ => throw new Exception($"Unsupported templateId: {templateId}"), 
		};
		if (1 == 0)
		{
		}
		int num2 = num;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		JingangDistributeSecInfo(num2, taiwu.GetId());
		SaveArgToSectMainStory(11, "ConchShip_PresetKey_JingangSecInfoMetaDataId", num2);
	}

	public static void JingangBroadCastSecInfo()
	{
		DomainManager.World.JingangBroadCastSecInfo(Domain.MainThreadDataContext);
	}

	public static bool JingangWesternBuddhistMonkTalkAllTriggered()
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(11);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_JingangWesternBuddhistMonkTalkOneTriggered", ref arg);
		bool arg2 = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_JingangWesternBuddhistMonkTalkTwoTriggered", ref arg2);
		bool arg3 = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_JingangWesternBuddhistMonkTalkThreeTriggered", ref arg3);
		return arg && arg2 && arg3;
	}

	public static void JingangKunlunPeopleChangeFavorability()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		short areaIdByAreaTemplateId = GetAreaIdByAreaTemplateId(26);
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		List<int> list2 = ObjectPool<List<int>>.Instance.Get();
		DomainManager.Map.GetAreaSettlementIds(areaIdByAreaTemplateId, list, containsMainCity: true);
		for (int i = 0; i < list.Count; i++)
		{
			Settlement settlement = DomainManager.Organization.GetSettlement(list[i]);
			list2.Clear();
			settlement.GetMembers().GetAllMembers(list2);
			for (int j = 0; j < list2.Count; j++)
			{
				if (DomainManager.Character.TryGetElement_Objects(list2[j], out var element))
				{
					ChangeFavorabilityOptional(element, taiwu, 3000, 4);
				}
			}
		}
		ObjectPool<List<short>>.Instance.Return(list);
		ObjectPool<List<int>>.Instance.Return(list2);
	}

	public static int JingangCanTriggerPietyEventCount()
	{
		return DomainManager.World.JingangCanTriggerPietyEventCount();
	}

	public static bool JingangIsCharacterBelongKunlunNotSect(int charId)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			short characterOrganizationAreaId = GetCharacterOrganizationAreaId(element);
			short areaIdByAreaTemplateId = GetAreaIdByAreaTemplateId(26);
			OrganizationInfo organizationInfo = element.GetOrganizationInfo();
			OrganizationItem organizationItem = Config.Organization.Instance[organizationInfo.OrgTemplateId];
			if (characterOrganizationAreaId == areaIdByAreaTemplateId && !organizationItem.IsSect)
			{
				return true;
			}
		}
		return false;
	}

	public static void SectChangeFavorability(sbyte orgTemplateId, short delta)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		List<GameData.Domains.Character.Character> sectCharList = GetSectCharList(orgTemplateId, 0, 8);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		for (int i = 0; i < sectCharList.Count; i++)
		{
			DomainManager.Character.TryCreateRelation(mainThreadDataContext, sectCharList[i].GetId(), taiwu.GetId());
			ChangeFavorabilityWithMergeOptional(sectCharList[i], taiwu, delta, 4, isMerge: true);
		}
	}

	public static bool IsSectMainStoryCharacter(short charTemplateId)
	{
		return SectMainStoryRelatedConstants.SectMainStoryCharacterTemplateIds.Contains(charTemplateId);
	}

	public static sbyte GetLiaoWumingAiState()
	{
		int extraTaskChainCurrentTask = DomainManager.Extra.GetExtraTaskChainCurrentTask(27);
		if (extraTaskChainCurrentTask == 105)
		{
			return 1;
		}
		if (SectMainStoryRelatedConstants.LiaoWumingAi2TaskInfo.Contains(extraTaskChainCurrentTask))
		{
			return 2;
		}
		if (extraTaskChainCurrentTask == 115)
		{
			return 3;
		}
		return -1;
	}

	public static Location GetLiaoWumingPoisonedLocation()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Span<sbyte> span = stackalloc sbyte[3] { 1, 10, 5 };
		sbyte orgTemplateId = span[mainThreadDataContext.Random.Next(span.Length)];
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId);
		short areaId = settlementByOrgTemplateId.GetLocation().AreaId;
		sbyte stateIdByAreaId = DomainManager.Map.GetStateIdByAreaId(areaId);
		List<short> normalAreaIdsByStateId = GetNormalAreaIdsByStateId(stateIdByAreaId);
		short random = normalAreaIdsByStateId.GetRandom(mainThreadDataContext.Random);
		Span<MapBlockData> areaBlocks = DomainManager.Map.GetAreaBlocks(random);
		List<MapBlockData> obj = mainThreadDataContext.AdvanceMonthRelatedData.Blocks.Occupy();
		Span<MapBlockData> span2 = areaBlocks;
		for (int i = 0; i < span2.Length; i++)
		{
			MapBlockData mapBlockData = span2[i];
			if (mapBlockData.IsPassable() && !mapBlockData.IsCityTown() && mapBlockData.BelongBlockId < 0 && mapBlockData.CharacterSet != null)
			{
				obj.Add(mapBlockData);
			}
		}
		if (obj.Count == 0)
		{
			Span<MapBlockData> span3 = areaBlocks;
			for (int j = 0; j < span3.Length; j++)
			{
				MapBlockData mapBlockData2 = span3[j];
				if (mapBlockData2.IsPassable() && !mapBlockData2.IsCityTown() && mapBlockData2.BelongBlockId < 0)
				{
					obj.Add(mapBlockData2);
				}
			}
		}
		if (obj.Count == 0)
		{
			Span<MapBlockData> span4 = areaBlocks;
			for (int k = 0; k < span4.Length; k++)
			{
				MapBlockData mapBlockData3 = span4[k];
				if (mapBlockData3.IsPassable())
				{
					obj.Add(mapBlockData3);
				}
			}
		}
		DomainManager.Character.CullCanSelectBlocks(obj);
		MapBlockData random2 = obj.GetRandom(mainThreadDataContext.Random);
		mainThreadDataContext.AdvanceMonthRelatedData.Blocks.Release(ref obj);
		return new Location(random, random2.BlockId);
	}

	public static bool IsForbidMeetSkeleton(int deadId)
	{
		DeadCharacter deadCharacter = DomainManager.Character.GetDeadCharacter(deadId);
		return SectMainStoryRelatedConstants.CanNotMeetSkeletonCharacters.Contains(deadCharacter.TemplateId);
	}

	public static bool IsForbidGraveInteraction(int deadId)
	{
		DeadCharacter deadCharacter = DomainManager.Character.GetDeadCharacter(deadId);
		return SectMainStoryRelatedConstants.CanNotGraveInteractionCharavters.Contains(deadCharacter.TemplateId);
	}

	public static sbyte GetGradeFromTripodVesselOfMedicine()
	{
		int random = GetRandom();
		for (sbyte b = 0; b < SectMainStoryRelatedConstants.TripodVesselOfMedicineProb.Length; b++)
		{
			if (random < SectMainStoryRelatedConstants.TripodVesselOfMedicineProb[b])
			{
				return b;
			}
		}
		return 0;
	}

	public static List<(ItemKey, int)> MakeLitchiWithMixedPoison()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		List<(ItemKey, int)> list = new List<(ItemKey, int)>();
		for (int i = 0; i < SectMainStoryRelatedConstants.MakeMixedPoison.Length; i++)
		{
			ItemKey itemKey = DomainManager.Item.CreateItem(mainThreadDataContext, 7, 5);
			short[] array = SectMainStoryRelatedConstants.MakeMixedPoison[i];
			for (int j = 0; j < array.Length; j++)
			{
				ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey);
				itemKey = DomainManager.Item.SetAttachedPoisons(mainThreadDataContext, baseItem, array[j], add: true).item.GetItemKey();
			}
			taiwu.AddInventoryItem(mainThreadDataContext, itemKey, 1);
		}
		ItemKey item = DomainManager.Item.CreateItem(mainThreadDataContext, 7, 5);
		list.Add((item, 20));
		return list;
	}

	public static void AddPoisonToLiaoWuming(GameData.Domains.Character.Character character)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		for (sbyte b = 0; b < 6; b++)
		{
			int delta = mainThreadDataContext.Random.Next(8333, 12500);
			character.ChangePoisoned(mainThreadDataContext, b, 0, delta);
		}
		short baseDelta = (short)mainThreadDataContext.Random.Next(2000, 4000);
		character.ChangeDisorderOfQi(mainThreadDataContext, baseDelta);
	}

	public static bool IsTaiwuAtRanshanSettlement(bool settlementBlockOnly = false)
	{
		return DomainManager.World.IsTaiwuAtRanshanSettlement(settlementBlockOnly);
	}

	public static void SetRanshanSpecialInteractionToggle(int index)
	{
		DomainManager.Extra.GetSectMainStoryEventArgBox(7).Set("ConchShip_PresetKey_Ranshan_SpecialInteractionToggle", index);
		SaveSectMainStoryEventArgBox(7);
	}

	public static bool TryGetRanshanSpecialInteractionEventGuid(EventArgBox argBox, out string res)
	{
		res = string.Empty;
		int arg = -1;
		int arg2 = -1;
		if (!argBox.Get("CharacterId", ref arg) || !DomainManager.Character.TryGetElement_Objects(arg, out var element) || element.GetOrganizationInfo().OrgTemplateId != 7 || !DomainManager.Extra.GetSectMainStoryEventArgBox(7).Get("ConchShip_PresetKey_Ranshan_SpecialInteractionToggle", ref arg2) || arg2 < 0)
		{
			return false;
		}
		OrganizationInfo organizationInfo = element.GetOrganizationInfo();
		switch (arg2)
		{
		case 1:
		{
			sbyte grade2 = organizationInfo.Grade;
			sbyte b2 = grade2;
			if (b2 >= 6)
			{
				if (b2 == 8 && organizationInfo.Principal)
				{
					res = "b8db554a-cd7c-426d-ab43-701d533ef418";
					return true;
				}
				res = "a16df7b5-6105-4d7e-a0b0-f24a0354cfa9";
				return true;
			}
			if (b2 >= 3)
			{
				res = "1470f02f-bd15-4c96-ba7e-04d5160b2a18";
				return true;
			}
			res = "69cf6a8e-e6aa-4546-9a95-60476492f126";
			return true;
		}
		case 2:
		{
			sbyte grade3 = organizationInfo.Grade;
			sbyte b3 = grade3;
			if (b3 >= 6)
			{
				if (b3 == 8 && organizationInfo.Principal)
				{
					res = "19f47128-51a0-4397-a580-25583ee9a7d8";
					return true;
				}
				res = "7716afbf-ed76-4c12-9206-2dfe2a0600ff";
				return true;
			}
			if (b3 >= 3)
			{
				res = "776d1654-2df9-4cd1-be16-bdd7bd5e0ffb";
				return true;
			}
			res = "2781a5ea-cddb-4d29-9a95-7b8fd0207af2";
			return true;
		}
		case 3:
		{
			sbyte grade = organizationInfo.Grade;
			sbyte b = grade;
			if (b >= 6)
			{
				if (b == 8 && organizationInfo.Principal)
				{
					res = "3ef5fe52-5a94-4486-9435-bca26092bdbf";
					return true;
				}
				res = "3558c330-1e4c-459a-9761-3ef89c41cbea";
				return true;
			}
			if (b >= 3)
			{
				res = "bcdfcfa8-966e-49b4-96c0-941868c037f8";
				return true;
			}
			res = "bf8e7d8a-33a1-4491-937e-2bf6bfff456f";
			return true;
		}
		default:
			return false;
		}
	}

	public static bool IsRanshanSectMainStoryComplete()
	{
		return DomainManager.World.GetSectMainStoryTaskStatus(7) != 0;
	}

	public static void ThreeCorpsesFollowingTaiwu()
	{
		sbyte sectMainStoryTaskStatus = GetSectMainStoryTaskStatus(7);
		switch (sectMainStoryTaskStatus)
		{
		case 0:
			if (IsExtraTaskChainInProgress(49))
			{
				break;
			}
			return;
		case 2:
			return;
		}
		foreach (short ranshanThreeCorpsesCharacterTemplateId in SectMainStoryRelatedConstants.RanshanThreeCorpsesCharacterTemplateIdList)
		{
			SectStoryThreeCorpsesCharacter ranshanThreeCorpsesCharacterByTemplateId = DomainManager.Extra.GetRanshanThreeCorpsesCharacterByTemplateId(ranshanThreeCorpsesCharacterTemplateId);
			if (ranshanThreeCorpsesCharacterByTemplateId == null || !ranshanThreeCorpsesCharacterByTemplateId.IsAroundTaiwu || ranshanThreeCorpsesCharacterByTemplateId.Target >= 0)
			{
				continue;
			}
			switch (sectMainStoryTaskStatus)
			{
			case 0:
				if (ranshanThreeCorpsesCharacterByTemplateId.Progress != 3)
				{
					break;
				}
				continue;
			case 1:
				if (ranshanThreeCorpsesCharacterByTemplateId.IsGoodEnd)
				{
					break;
				}
				continue;
			}
			GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(ranshanThreeCorpsesCharacterTemplateId);
			Location location = orCreateFixedCharacterByTemplateId.GetLocation();
			if (location == Location.Invalid)
			{
				DomainManager.Extra.SetRanshanThreeCorpsesCharacterLocation(Domain.MainThreadDataContext, ranshanThreeCorpsesCharacterTemplateId);
				break;
			}
			GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
			Location validLocation = taiwu.GetValidLocation();
			MapBlockData blockData = DomainManager.Map.GetBlockData(validLocation.AreaId, validLocation.BlockId);
			ByteCoordinate blockPos = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId).GetBlockPos();
			if (blockData.GetManhattanDistanceToPos(blockPos.X, blockPos.Y) > 2)
			{
				DomainManager.Extra.SetRanshanThreeCorpsesCharacterLocation(Domain.MainThreadDataContext, ranshanThreeCorpsesCharacterTemplateId);
			}
		}
	}

	public static void SetRanshanChapter1MonthlyEventProgress()
	{
		int arg = 0;
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(7);
		if (!sectMainStoryEventArgBox.Get("ConchShip_PresetKey_Ranshan_Chapter1_MonthlyEventTriggeredCount", ref arg))
		{
			arg = 0;
		}
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Ranshan_Chapter1_MonthlyEventTriggeredCount", ++arg);
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Ranshan_Chapter1_MonthlyEventTriggeredDate", DomainManager.World.GetCurrDate());
		SaveSectMainStoryEventArgBox(7);
	}

	public static int GetRanshanChapter1MonthlyEventTriggeredCount()
	{
		return DomainManager.World.GetRanshanChapter1MonthlyEventTriggeredCount();
	}

	public static bool IsRanshanChapter1AbleToTrigger()
	{
		return DomainManager.Extra.IsExtraTaskInProgress(293) && IsTaiwuAtRanshanSettlement(settlementBlockOnly: true);
	}

	public static void SetRanshanAdventure1MapBlockName(EventArgBox argBox)
	{
		Location validLocation = DomainManager.Taiwu.GetTaiwu().GetValidLocation();
		MapBlockItem mapBlockItem = MapBlock.Instance[(short)25];
		int blockIndexInBigBlock = DomainManager.Map.GetBlock(validLocation).GetBlockIndexInBigBlock(DomainManager.Map.GetAreaSize(validLocation.AreaId));
		argBox.Set("RanshanAdventure1DestinationName", mapBlockItem.BlockNames[(IsTaiwuAtRanshanSettlement(settlementBlockOnly: true) && blockIndexInBigBlock == 0) ? 2 : 0]);
	}

	public static List<(ItemKey, int)> GetItemsInRanshanAdventure1()
	{
		List<(ItemKey, int)> list = new List<(ItemKey, int)>();
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		list.Add((AddItemToRole(taiwu, 12, 268, 1, -1), 1));
		list.Add((AddItemToRole(taiwu, 12, 269, 1, -1), 1));
		list.Add((AddItemToRole(taiwu, 12, 270, 1, -1), 1));
		return list;
	}

	public static void SetRanshanSectLeaderArgBox(EventArgBox argBox)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		sbyte orgTemplateId = 7;
		short templateId = 364;
		GameData.Domains.Character.Character character = TryGetSectLeaderAtLocation(taiwu.GetLocation(), orgTemplateId, includeAllBlocksInGroup: true);
		if (character == null || character.GetAgeGroup() == 0)
		{
			int arg = CreateNonIntelligentCharacter(templateId);
			argBox.Set("SectLeader", arg);
			argBox.Set("SectLeaderName", "<color=#GradeColor_8><Language Key=Event_SectStoryShixiang_Qianbei/></color>");
		}
		else
		{
			OrganizationMemberItem orgMemberConfig = OrganizationDomain.GetOrgMemberConfig(character.GetOrganizationInfo());
			argBox.Set("SectLeader", character.GetId());
			argBox.Set("SectLeaderName", "<color=#GradeColor_8>" + orgMemberConfig.GradeName + "</color>");
		}
	}

	public static void CreateRanshanChapter1Adventure()
	{
		Location location = DomainManager.Organization.GetSettlementByOrgTemplateId(7).GetLocation();
		List<short> list = new List<short>();
		DomainManager.Map.GetSettlementBlocks(location.AreaId, location.BlockId, list);
		foreach (short item in list)
		{
			MapBlockData block = DomainManager.Map.GetBlock(location.AreaId, item);
			if (!DomainManager.Map.IsBlockOccupiedByCriticalAdventure(location.AreaId, block.BlockId) && TryCreateAdventureSite(location.AreaId, block.BlockId, 184, setBlockVisible: true))
			{
				break;
			}
		}
	}

	public static void SetRanshanChapter2TeachStartDate()
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(7);
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Ranshan_Chapter2_TeachStartDate", DomainManager.World.GetCurrDate());
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_SanZongBiWuCountDown", 24);
		SaveSectMainStoryEventArgBox(7);
	}

	public static int InitializeRanshanThreeCorpsesCharacter(short templateId)
	{
		return DomainManager.Extra.InitializeRanshanThreeCorpsesCharacter(Domain.MainThreadDataContext, templateId);
	}

	public static void ChangeRanshanThreeCorpsesCharacterFavorability(short templateId, int delta)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = DomainManager.Character.GetOrCreateFixedCharacterByTemplateId(Domain.MainThreadDataContext, templateId);
		short favorability = GetFavorability(orCreateFixedCharacterByTemplateId, taiwu);
		short num = (short)Math.Clamp(favorability + delta, -30000, 30000);
		DirectlySetFavorabilities(orCreateFixedCharacterByTemplateId.GetId(), taiwu.GetId(), num, num);
	}

	public static void SetRanshanChapter2CombatPlayDecision(short templateId, int decision)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(7);
		if (1 == 0)
		{
		}
		string key = templateId switch
		{
			660 => "ConchShip_PresetKey_Ranshan_Chapter2_HuajuCombatPlayDecision", 
			661 => "ConchShip_PresetKey_Ranshan_Chapter2_XuanzhiCombatPlayDecision", 
			_ => "ConchShip_PresetKey_Ranshan_Chapter2_YingjiaoCombatPlayDecision", 
		};
		if (1 == 0)
		{
		}
		sectMainStoryEventArgBox.Set(key, decision);
		SaveSectMainStoryEventArgBox(7);
	}

	public static int GetRanshanChapter2CombatPlayDecision(short templateId)
	{
		int arg = 0;
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(7);
		if (1 == 0)
		{
		}
		string key = templateId switch
		{
			660 => "ConchShip_PresetKey_Ranshan_Chapter2_HuajuCombatPlayDecision", 
			661 => "ConchShip_PresetKey_Ranshan_Chapter2_XuanzhiCombatPlayDecision", 
			_ => "ConchShip_PresetKey_Ranshan_Chapter2_YingjiaoCombatPlayDecision", 
		};
		if (1 == 0)
		{
		}
		return sectMainStoryEventArgBox.Get(key, ref arg) ? arg : 0;
	}

	public static void SetThreeCorpsesCharacterCombatPlayDate(short templateId)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(7);
		if (1 == 0)
		{
		}
		string key = templateId switch
		{
			660 => "ConchShip_PresetKey_Ranshan_Chapter2_HuajuCombatPlayDate", 
			661 => "ConchShip_PresetKey_Ranshan_Chapter2_XuanzhiCombatPlayDate", 
			_ => "ConchShip_PresetKey_Ranshan_Chapter2_YingjiaoCombatPlayDate", 
		};
		if (1 == 0)
		{
		}
		sectMainStoryEventArgBox.Set(key, DomainManager.World.GetCurrDate());
		SaveSectMainStoryEventArgBox(7);
	}

	public static bool IsThreeCorpsesCharacterCombatPlayed(short templateId)
	{
		int currDate = DomainManager.World.GetCurrDate();
		int arg = -1;
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(7);
		if (1 == 0)
		{
		}
		string key = templateId switch
		{
			660 => "ConchShip_PresetKey_Ranshan_Chapter2_HuajuCombatPlayDate", 
			661 => "ConchShip_PresetKey_Ranshan_Chapter2_XuanzhiCombatPlayDate", 
			_ => "ConchShip_PresetKey_Ranshan_Chapter2_YingjiaoCombatPlayDate", 
		};
		if (1 == 0)
		{
		}
		return sectMainStoryEventArgBox.Get(key, ref arg) && arg == currDate;
	}

	public static bool IsThreeCorpsesCharacterFirstTimeCombatPlay(short templateId)
	{
		return GetRanshanChapter2CombatPlayDecision(templateId) <= 0;
	}

	public static void SetRanshanChapter2ThreeCorpsesProgress(short templateId)
	{
		DomainManager.Extra.SetRanshanThreeCorpsesCharacterProgress(Domain.MainThreadDataContext, templateId);
	}

	public static sbyte GetRanshanChapter2ThreeCorpsesProgress(short templateId)
	{
		return DomainManager.Extra.GetRanshanThreeCorpsesCharacterByTemplateId(templateId).Progress;
	}

	public static bool IsRanshanChapter2ThreeCorpsesProgressDone(short templateId)
	{
		return GetRanshanChapter2ThreeCorpsesProgress(templateId) == 3;
	}

	public static void SetRanshanChapter2MenteeEnding(short templateId)
	{
		DomainManager.Extra.SetRanshanThreeCorpsesCharacterGoodEnd(Domain.MainThreadDataContext, templateId);
	}

	public static bool GetRanshanChapter2MenteeEnding(short templateId)
	{
		return DomainManager.Extra.GetRanshanThreeCorpsesCharacterByTemplateId(templateId).IsGoodEnd;
	}

	public static void PrepareRanshanChapter2BookGift(EventArgBox argBox)
	{
		if (!argBox.Get("SelectItemInfo", out EventSelectItemData arg))
		{
			arg = new EventSelectItemData
			{
				CanSelectItemList = new List<ItemDisplayData>(),
				FilterList = new List<SelectItemFilter>()
			};
			argBox.Set("SelectItemInfo", (ISerializableGameData)(object)arg);
		}
		SelectItemFilter item = new SelectItemFilter
		{
			Key = "SelectedItemKey",
			DisplayDataFilterId = 0,
			FilterTemplateId = -1
		};
		Inventory inventory = DomainManager.Taiwu.GetTaiwu().GetInventory();
		foreach (KeyValuePair<ItemKey, int> item2 in inventory.Items)
		{
			ItemKey key = item2.Key;
			if (key.ItemType == 10)
			{
				ItemDisplayData itemDisplayData = DomainManager.Item.GetItemDisplayData(key, EventArgBox.TaiwuCharacterId);
				itemDisplayData.Amount = item2.Value;
				arg.CanSelectItemList.Add(itemDisplayData);
			}
		}
		arg.FilterList.Add(item);
	}

	public static bool DoesThreeCorpsesCharacterLikeTheBook(short templateId, ItemKey itemKey)
	{
		SkillBookItem skillBookItem = Config.SkillBook.Instance[itemKey.TemplateId];
		if (skillBookItem.ItemSubType == 1001)
		{
			switch (templateId)
			{
			case 660:
			{
				sbyte combatSkillType = skillBookItem.CombatSkillType;
				return (combatSkillType == 2 || combatSkillType == 10) ? true : false;
			}
			case 661:
			{
				sbyte combatSkillType = skillBookItem.CombatSkillType;
				return (combatSkillType == 0 || combatSkillType == 7) ? true : false;
			}
			case 662:
			{
				sbyte combatSkillType = skillBookItem.CombatSkillType;
				return (combatSkillType == 1 || combatSkillType == 4) ? true : false;
			}
			}
		}
		else
		{
			switch (templateId)
			{
			case 660:
			{
				sbyte combatSkillType = skillBookItem.LifeSkillType;
				return ((uint)(combatSkillType - 4) <= 1u || combatSkillType == 11) ? true : false;
			}
			case 661:
			{
				sbyte combatSkillType = skillBookItem.LifeSkillType;
				return (combatSkillType == 6 || (uint)(combatSkillType - 14) <= 1u) ? true : false;
			}
			case 662:
			{
				sbyte combatSkillType = skillBookItem.LifeSkillType;
				return (combatSkillType == 1 || combatSkillType == 8 || combatSkillType == 12) ? true : false;
			}
			}
		}
		return false;
	}

	public static short GetRanshanThreeCorpsesFavorabilityChangeByGiftBook(ItemKey itemKey, short templateId)
	{
		int num = DomainManager.Item.GetBaseItem(itemKey).GetFavorabilityChange();
		foreach (short featureId in Config.Character.Instance[templateId].FeatureIds)
		{
			if ((uint)(featureId - 546) <= 2u)
			{
				num = num * CharacterFeature.Instance[featureId].FavorabilityIncrementFactor / 100;
				break;
			}
		}
		return (short)num;
	}

	public static List<(ItemKey, int)> GetRanshanChapter2HuajuReward(int value)
	{
		List<(ItemKey, int)> list = new List<(ItemKey, int)>();
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		ItemKey item = AddItemToRole(taiwu, 5, (short)(31 + value), 1, -1);
		list.Add((item, 1));
		return list;
	}

	public static List<(ItemKey, int)> GetRanshanChapter2XuanzhiReward(int value)
	{
		List<(ItemKey, int)> list = new List<(ItemKey, int)>();
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		ItemKey item = AddItemToRole(taiwu, 9, (short)(4 + value), 1, -1);
		list.Add((item, 1));
		return list;
	}

	public static List<(ItemKey, int)> GetRanshanChapter2YingjiaoReward(int value)
	{
		List<(ItemKey, int)> list = new List<(ItemKey, int)>();
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		ItemKey item = AddItemToRole(taiwu, 8, (short)(101 + value), 1, -1);
		list.Add((item, 1));
		return list;
	}

	public static bool GetRanshanChapter2YingjiaoSelection(int value)
	{
		bool arg = false;
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(7);
		return sectMainStoryEventArgBox.Get((value == 1) ? "ConchShip_PresetKey_Ranshan_Chapter2_YingjiaoSelection1" : "ConchShip_PresetKey_Ranshan_Chapter2_YingjiaoSelection2", ref arg) && arg;
	}

	public static void SetRanshanChapter2YingjiaoSelection(int key, bool value)
	{
		DomainManager.Extra.GetSectMainStoryEventArgBox(7).Set((key == 1) ? "ConchShip_PresetKey_Ranshan_Chapter2_YingjiaoSelection1" : "ConchShip_PresetKey_Ranshan_Chapter2_YingjiaoSelection2", value);
		SaveSectMainStoryEventArgBox(7);
	}

	public static int GetRanshanThreeCorpsesFavorabilityProgress(short templateId)
	{
		sbyte favorabilityType = FavorabilityType.GetFavorabilityType(DomainManager.Character.GetFavorability(DomainManager.Extra.GetRanshanThreeCorpsesCharacterByTemplateId(templateId).Id, DomainManager.Taiwu.GetTaiwuCharId()));
		return GetRanshanChapter2ThreeCorpsesProgress(templateId) switch
		{
			0 => (favorabilityType >= 3) ? 1 : 0, 
			1 => (favorabilityType < 4) ? 1 : 2, 
			2 => (favorabilityType < 5) ? 2 : 3, 
			_ => 3, 
		};
	}

	public static string GetRanshanChapter2ProgressEventGuid(short templateId)
	{
		SectStoryThreeCorpsesCharacter ranshanThreeCorpsesCharacterByTemplateId = DomainManager.Extra.GetRanshanThreeCorpsesCharacterByTemplateId(templateId);
		int ranshanThreeCorpsesFavorabilityProgress = GetRanshanThreeCorpsesFavorabilityProgress(templateId);
		switch (templateId)
		{
		case 660:
		{
			if (1 == 0)
			{
			}
			string result = ranshanThreeCorpsesFavorabilityProgress switch
			{
				0 => "f5b8c958-1e97-4668-aeeb-0faa956a8617", 
				1 => (ranshanThreeCorpsesCharacterByTemplateId.Progress < 1) ? "a3a84c93-f4b1-4eda-956d-58dab9b30e87" : "6fa29526-6fdd-4b9a-abc3-f5c092bb1734", 
				2 => (ranshanThreeCorpsesCharacterByTemplateId.Progress < 2) ? "1fa82c75-1ff2-47ae-b5e7-bef4155d3684" : "4fcd232c-2fee-4a9a-b0cf-e5252fa3c50a", 
				_ => "ffcb5ead-d7a9-4215-a6a3-cd488e91b7ca", 
			};
			if (1 == 0)
			{
			}
			return result;
		}
		case 661:
		{
			if (1 == 0)
			{
			}
			string result = ranshanThreeCorpsesFavorabilityProgress switch
			{
				0 => "8af384be-cac1-472f-8588-405cebe0bdfc", 
				1 => (ranshanThreeCorpsesCharacterByTemplateId.Progress < 1) ? "cb57f595-92b3-44a3-bac2-ae7bd916cc70" : "6b59079d-a365-4560-9f13-e342623e67ad", 
				2 => (ranshanThreeCorpsesCharacterByTemplateId.Progress < 2) ? "092b9bbd-3c2d-4cf0-a48c-10ced744d830" : "9e33a295-2b36-4795-b8e4-ea4764757f3b", 
				_ => "69b2bc16-74dd-4a8e-9a40-d2986e22e4f3", 
			};
			if (1 == 0)
			{
			}
			return result;
		}
		case 662:
		{
			if (1 == 0)
			{
			}
			string result = ranshanThreeCorpsesFavorabilityProgress switch
			{
				0 => "9ab9b3c4-50a6-49ff-b196-4a928c33e6e3", 
				1 => (ranshanThreeCorpsesCharacterByTemplateId.Progress < 1) ? "fcde53ed-b38c-4148-9782-dd67217ebc98" : "60ff3498-a5d9-430d-b549-93c2eaad9a39", 
				2 => (ranshanThreeCorpsesCharacterByTemplateId.Progress < 2) ? "1abda80f-5bb5-4a90-b047-94e45adc51a3" : "62591f75-06ad-4cfb-b227-d8e3ffc86d30", 
				_ => "dceb9a2b-f349-488a-b934-a84a113cfec4", 
			};
			if (1 == 0)
			{
			}
			return result;
		}
		default:
			return string.Empty;
		}
	}

	public static void HideRanshanThreeCorpsesCharacter(short templateId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = DomainManager.Character.GetOrCreateFixedCharacterByTemplateId(mainThreadDataContext, templateId);
		Events.RaiseFixedCharacterLocationChanged(mainThreadDataContext, orCreateFixedCharacterByTemplateId.GetId(), orCreateFixedCharacterByTemplateId.GetLocation(), Location.Invalid);
		orCreateFixedCharacterByTemplateId.SetLocation(Location.Invalid, mainThreadDataContext);
	}

	public static string GetRanshanChapter2LetterContent(EventArgBox argBox)
	{
		StringBuilder stringBuilder = new StringBuilder();
		stringBuilder.AppendLine();
		if (IsRanshanChapter2ThreeCorpsesProgressDone(660))
		{
			stringBuilder.AppendLine(GetRanshanChapter2MenteeEnding(660) ? "<Language Key=Event_SectStoryRanshan_HuajuLetter_Description_Good/>" : "<Language Key=Event_SectStoryRanshan_HuajuLetter_Description_Bad/>");
		}
		if (IsRanshanChapter2ThreeCorpsesProgressDone(661))
		{
			stringBuilder.AppendLine(GetRanshanChapter2MenteeEnding(661) ? "<Language Key=Event_SectStoryRanshan_XuanzhiLetter_Description_Good/>" : "<Language Key=Event_SectStoryRanshan_XuanzhiLetter_Description_Bad/>");
		}
		if (IsRanshanChapter2ThreeCorpsesProgressDone(662))
		{
			stringBuilder.AppendLine(GetRanshanChapter2MenteeEnding(662) ? "<Language Key=Event_SectStoryRanshan_YingjiaoLetter_Description_Good/>" : "<Language Key=Event_SectStoryRanshan_YingjiaoLetter_Description_Bad/>");
		}
		return stringBuilder.ToString();
	}

	public static void SetRanshanChapter3WillingToBeImmortal(bool res)
	{
		DomainManager.Extra.GetSectMainStoryEventArgBox(7).Set("ConchShip_PresetKey_Ranshan_Chapter3_WillingToBeImmortal", res);
		SaveSectMainStoryEventArgBox(7);
	}

	public static bool GetRanshanChapter3WillingToBeImmortal()
	{
		bool arg = false;
		return DomainManager.Extra.GetSectMainStoryEventArgBox(7).Get("ConchShip_PresetKey_Ranshan_Chapter3_WillingToBeImmortal", ref arg) && arg;
	}

	public static bool CreateRanshanChapter3Adventure()
	{
		MonthlyActionKey key = MonthlyEventActionsManager.PredefinedKeys["RanshanStoryDefault"];
		ConfigWrapperAction configWrapperAction = (ConfigWrapperAction)Domain.GetMonthlyAction(key);
		if (configWrapperAction.CurrConfigMonthlyAction != null)
		{
			return false;
		}
		configWrapperAction.CreateWrappedAction(82, -1);
		return configWrapperAction.CurrConfigMonthlyAction != null;
	}

	public static void InitializeRanshanFootman()
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(625);
		DomainManager.Character.DirectlySetFavorabilities(Domain.MainThreadDataContext, orCreateFixedCharacterByTemplateId.GetId(), DomainManager.Taiwu.GetTaiwuCharId(), 14000, 14000);
	}

	public static bool IsRanshanChapter3AbleToTrigger()
	{
		return DomainManager.Extra.IsExtraTaskInProgress(322) && IsTaiwuAtRanshanSettlement(settlementBlockOnly: true);
	}

	public static void SetCharacterSkeleton(int charId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return;
		}
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		AvatarData avatarData = new AvatarData(element.GetAvatar());
		avatarData.ConvertAvatarToSkeleton();
		element.SetAvatar(avatarData, mainThreadDataContext);
		ItemKey itemKey = element.GetEquipment()[4];
		sbyte grade = element.GetOrganizationInfo().Grade;
		if (1 == 0)
		{
		}
		short num;
		if (grade <= 5)
		{
			num = (short)((grade < 0 || grade > 2) ? 70 : 69);
		}
		else
		{
			if (grade > 8)
			{
				throw new Exception($"character {charId} has an invalid grade {element.GetOrganizationInfo().Grade}");
			}
			num = 71;
		}
		if (1 == 0)
		{
		}
		short templateId = num;
		ItemKey itemKey2 = DomainManager.Item.CreateItem(mainThreadDataContext, 3, templateId);
		element.AddInventoryItem(mainThreadDataContext, itemKey2, 1);
		element.ChangeEquipment(mainThreadDataContext, -1, 4, itemKey2);
		if (itemKey.IsValid())
		{
			element.RemoveInventoryItem(mainThreadDataContext, itemKey, 1, deleteItem: true);
		}
	}

	public static void SetRanshanChapter3AdventureCharacterArgs(EventArgBox argBox)
	{
		MonthlyActionsItem monthlyActionsItem = MonthlyActions.Instance[(short)82];
		int num = 0;
		IRandomSource random = Domain.MainThreadDataContext.Random;
		ushort num2 = 0;
		for (int i = 0; i < monthlyActionsItem.ParticipateTargetFilterList.Length; i++)
		{
			int adventureParticipateCharacterCount = argBox.GetAdventureParticipateCharacterCount(i);
			for (int j = 0; j < adventureParticipateCharacterCount; j++)
			{
				argBox.Set($"RanshanMentee{num++}", argBox.GetAdventureParticipateCharacter(i, j).GetId());
			}
		}
		argBox.Set("MenteeCount", num);
		int num3 = num / 2;
		for (int k = 0; k < num3; k++)
		{
			num2 = BitOperation.SetBit(num2, k, true);
		}
		for (int num4 = num - 1; num4 > 0; num4--)
		{
			int num5 = random.Next(num4 + 1);
			bool bit = BitOperation.GetBit(num2, num4);
			bool bit2 = BitOperation.GetBit(num2, num5);
			num2 = BitOperation.SetBit(num2, num4, bit2);
			num2 = BitOperation.SetBit(num2, num5, bit);
		}
		argBox.Set("BetrayTags", num2);
	}

	public static void ResetRanshanChapter3AdventureSelectedCharacters(EventArgBox argBox)
	{
		argBox.Set("SelectedTags", (ushort)0);
	}

	public static bool IsRanshanChapter3CharacterContainsBetrayTag(EventArgBox argBox)
	{
		int arg = -1;
		if (argBox.Get("CharA", ref arg))
		{
			int num = argBox.GetInt("MenteeCount");
			ushort num2 = argBox.GetUshort("BetrayTags");
			for (int i = 0; i < num; i++)
			{
				if (argBox.GetInt($"RanshanMentee{i}") == arg && BitOperation.GetBit(num2, i))
				{
					return true;
				}
			}
		}
		return false;
	}

	public static void PickRanshanChapter3AdventureCharacters(EventArgBox argBox, int stage, bool needBetrayTag, bool betrayTag)
	{
		int total = argBox.GetInt("MenteeCount");
		ushort betrayTags = argBox.GetUshort("BetrayTags");
		int ranshanChapter3AdventureIntelligentCharacter = GetRanshanChapter3AdventureIntelligentCharacter(argBox, total, betrayTags, needBetrayTag, betrayTag);
		int num = argBox.GetInt($"RanshanMentee{ranshanChapter3AdventureIntelligentCharacter}");
		int arg = ((stage == 1) ? argBox.GetInt($"RanshanMentee{GetRanshanChapter3AdventureIntelligentCharacter(argBox, total, betrayTags, needBetrayTag, betrayTag, ranshanChapter3AdventureIntelligentCharacter)}") : GetRanshanChapter3AdventureTemporaryCharacter(DomainManager.Character.GetElement_Objects(num).GetOrganizationInfo().Grade, stage));
		argBox.Set("CharA", num);
		argBox.Set("CharB", arg);
	}

	public static int GetRanshanChapter3AdventureIntelligentCharacter(EventArgBox argBox, int total, ushort betrayTags, bool needBetrayTag, bool betrayTag, int banned = -1)
	{
		ushort num = argBox.GetUshort("SelectedTags");
		for (int i = 0; i < total; i++)
		{
			if (!BitOperation.GetBit(num, i) && (!needBetrayTag || BitOperation.GetBit(betrayTags, i) == betrayTag) && i != banned)
			{
				num = BitOperation.SetBit(num, i, true);
				argBox.Set("SelectedTags", num);
				return i;
			}
		}
		ResetRanshanChapter3AdventureSelectedCharacters(argBox);
		for (int j = 0; j < total; j++)
		{
			if ((!needBetrayTag || BitOperation.GetBit(betrayTags, j) == betrayTag) && j != banned)
			{
				num = BitOperation.SetBit(num, j, true);
				argBox.Set("SelectedTags", num);
				return j;
			}
		}
		return -1;
	}

	public static int GetRanshanChapter3AdventureTemporaryCharacter(int grade, int stage)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		if (1 == 0)
		{
		}
		short num = grade switch
		{
			1 => 370, 
			2 => 369, 
			3 => 368, 
			_ => 367, 
		};
		if (1 == 0)
		{
		}
		short templateId = num;
		int num2 = CreateNonIntelligentCharacter(templateId);
		int num3 = mainThreadDataContext.Random.Next(40, 60) + ((stage != 2) ? 20 : 0);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(num2);
		element_Objects.SetCurrAge((short)num3, mainThreadDataContext);
		element_Objects.SetHealth(element_Objects.GetMaxHealth(), mainThreadDataContext);
		element_Objects.SetAvatar(mainThreadDataContext, element_Objects.GetAvatar());
		return num2;
	}

	public static void RanshanChapter3AdventureAllCharacterChangeAge(EventArgBox argBox, int delta = 0)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		if (!argBox.Get<CharacterSet>("Teammate", out CharacterSet arg))
		{
			arg = default(CharacterSet);
		}
		HashSet<int> collection = DomainManager.Taiwu.GetGroupCharIds().GetCollection();
		foreach (int item in collection)
		{
			if (DomainManager.Character.TryGetElement_Objects(item, out var element))
			{
				DomainManager.Character.RevertAllTemporaryModifications(mainThreadDataContext, element);
				if (delta > 0)
				{
					DomainManager.Character.TemporarilyModifyHealth(Domain.MainThreadDataContext, element, (short)(element.GetHealth() + delta * 10));
					DomainManager.Character.TemporarilyModifyCurrAge(Domain.MainThreadDataContext, element, (short)(element.GetCurrAge() + delta));
				}
				element.SetAvatar(mainThreadDataContext, element.GetAvatar());
				if (IsCharacterWearingChildClothing(element))
				{
					element.ForceReplaceClothing(mainThreadDataContext, 0);
				}
			}
			arg.Add(item);
		}
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(625);
		DomainManager.Character.RevertAllTemporaryModifications(mainThreadDataContext, orCreateFixedCharacterByTemplateId);
		if (delta > 0)
		{
			DomainManager.Character.TemporarilyModifyHealth(Domain.MainThreadDataContext, orCreateFixedCharacterByTemplateId, (short)(orCreateFixedCharacterByTemplateId.GetHealth() + delta * 10));
			DomainManager.Character.TemporarilyModifyCurrAge(Domain.MainThreadDataContext, orCreateFixedCharacterByTemplateId, (short)(orCreateFixedCharacterByTemplateId.GetCurrAge() + delta));
		}
		orCreateFixedCharacterByTemplateId.SetAvatar(mainThreadDataContext, orCreateFixedCharacterByTemplateId.GetAvatar());
		if (IsCharacterWearingChildClothing(orCreateFixedCharacterByTemplateId))
		{
			orCreateFixedCharacterByTemplateId.ForceReplaceClothing(mainThreadDataContext, 37);
		}
		else
		{
			ReplaceCharacterClothingForChild(orCreateFixedCharacterByTemplateId);
		}
		int num = argBox.GetInt("MenteeCount");
		ushort num2 = argBox.GetUshort("SelectedTags");
		argBox.Set("EventCharacterId", argBox.GetInt("RanshanMentee0"));
		for (int i = 0; i < num; i++)
		{
			int num3 = argBox.GetInt($"RanshanMentee{i}");
			GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(num3);
			DomainManager.Character.RevertAllTemporaryModifications(mainThreadDataContext, element_Objects);
			if (delta > 0)
			{
				DomainManager.Character.TemporarilyModifyHealth(Domain.MainThreadDataContext, element_Objects, (short)(element_Objects.GetHealth() + delta * 10));
				DomainManager.Character.TemporarilyModifyCurrAge(Domain.MainThreadDataContext, element_Objects, (short)(element_Objects.GetCurrAge() + delta));
			}
			element_Objects.SetAvatar(mainThreadDataContext, element_Objects.GetAvatar());
			if (BitOperation.GetBit(num2, i))
			{
				argBox.Set("EventCharacterId", num3);
			}
		}
		if (delta == 0 && arg.GetCount() > 0)
		{
			HashSet<int> collection2 = arg.GetCollection();
			foreach (int item2 in collection2)
			{
				if (DomainManager.Character.TryGetElement_Objects(item2, out var element2))
				{
					DomainManager.Character.RevertAllTemporaryModifications(mainThreadDataContext, element2);
					ReplaceCharacterClothingForChild(element2);
				}
			}
		}
		argBox.Set("Teammate", (ISerializableGameData)(object)arg);
	}

	public static bool IsCharacterWearingChildClothing(GameData.Domains.Character.Character character)
	{
		short templateId = character.GetEquipment()[4].TemplateId;
		if ((uint)(templateId - 64) <= 1u)
		{
			return true;
		}
		return false;
	}

	public static void ReplaceCharacterClothingForChild(GameData.Domains.Character.Character character)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		switch (character.GetAgeGroup())
		{
		case 1:
			character.ForceReplaceClothing(mainThreadDataContext, 65);
			break;
		case 0:
			character.ForceReplaceClothing(mainThreadDataContext, 64);
			break;
		}
	}

	public static void ApplyRanshanChapter3AdventureBeatSkeleton(EventArgBox argBox)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int num = argBox.GetInt("CharA");
		if (DomainManager.Character.TryGetElement_Objects(num, out var element) && DomainManager.Organization.TryGetElement_SectCharacters(num, out var _))
		{
			DirectlyChangeFavorabilityOptionalStoryEvent(element, taiwu, 6000);
			element.ChangeHappiness(mainThreadDataContext, -20);
			SetSectCharApprovedTaiwu(num);
		}
	}

	public static bool IsRanshanChapter4AbleToTrigger()
	{
		return DomainManager.Extra.IsExtraTaskInProgress(298);
	}

	public static bool IsRanshanMenteeGoodStoryEnding()
	{
		return DomainManager.Extra.IsRanshanMenteeGoodStoryEnding();
	}

	public static void RemoveRanshanStoryItems()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		ItemKey inventoryItem = GetInventoryItem(taiwu, 12, 268);
		if (inventoryItem.IsValid())
		{
			RemoveInventoryItem(taiwu, inventoryItem);
		}
		inventoryItem = GetInventoryItem(taiwu, 12, 269);
		if (inventoryItem.IsValid())
		{
			RemoveInventoryItem(taiwu, inventoryItem);
		}
		inventoryItem = GetInventoryItem(taiwu, 12, 270);
		if (inventoryItem.IsValid())
		{
			RemoveInventoryItem(taiwu, inventoryItem);
		}
	}

	public static GameData.Domains.Character.Character GetOrCreateRanshanZhuxian()
	{
		short ranshanZhuxianTemplateId = SectMainStoryRelatedConstants.GetRanshanZhuxianTemplateId();
		return DomainManager.Character.GetOrCreateFixedCharacterByTemplateId(Domain.MainThreadDataContext, ranshanZhuxianTemplateId);
	}

	public static void AddDisplayEventLegendaryBookKeeping()
	{
		DomainManager.Extra.AddDisplayEventLegendaryBookKeeping(Domain.MainThreadDataContext);
	}

	public static void SetRanshanThreeCorpsesCharacterFollowing(short templateId, bool value)
	{
		DomainManager.Extra.SetRanshanThreeCorpsesCharacterFollowing(Domain.MainThreadDataContext, templateId, value);
	}

	public static bool GetRanshanThreeCorpsesCharacterFollowing(short templateId)
	{
		return DomainManager.Extra.GetRanshanThreeCorpsesCharacterByTemplateId(templateId).IsAroundTaiwu;
	}

	public static void StopRanshanThreeCorpsesGiveUpAction(short characterTemplateId)
	{
		DomainManager.Extra.ApplyRanshanThreeCorpsesLegendaryBookActionResult(Domain.MainThreadDataContext, characterTemplateId, -1, isSuccess: false);
	}

	public static bool IsRanshanThreeCorpsesInAction(short characterTemplateId)
	{
		return DomainManager.Extra.GetRanshanThreeCorpsesCharacterByTemplateId(characterTemplateId).Target >= 0;
	}

	public static bool IsAbleToTriggerThreeCorpsesPassLegacyEvent(short characterTemplateId)
	{
		if (!IsExtraTaskChainInProgress(49))
		{
			return false;
		}
		SectStoryThreeCorpsesCharacter ranshanThreeCorpsesCharacterByTemplateId = DomainManager.Extra.GetRanshanThreeCorpsesCharacterByTemplateId(characterTemplateId);
		return ranshanThreeCorpsesCharacterByTemplateId.TaiwuId != DomainManager.Taiwu.GetTaiwuCharId() && !ranshanThreeCorpsesCharacterByTemplateId.PassLegacyEventTriggered;
	}

	public static void SetRanshanThreeCorpsesCharacterPassLegacyEventTriggered(short characterTemplateId)
	{
		DomainManager.Extra.SetRanshanThreeCorpsesCharacterPassLegacyEventTriggered(Domain.MainThreadDataContext, characterTemplateId);
	}

	public static void ShaolinShaolinTriggerStatueReturn(string nextEvent, EventArgBox argBox)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(1);
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_ShaolinStatueReturnTriggered", arg: true);
		SaveSectMainStoryEventArgBox(1);
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		ItemKey item = AddItemToRole(character, 12, 247, 1, -1);
		ShowGetItemPageForItems(new List<(ItemKey, int)> { (item, 1) }, nextEvent, argBox);
	}

	public static void ShaolinReplaceStatue(short newStatueTemplateId, string afterEvent, EventArgBox argBox)
	{
		ShaolinClearStatue();
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		ItemKey item = AddItemToRole(taiwu, 12, newStatueTemplateId, 1, -1);
		ShowGetItemPageForItems(new List<(ItemKey, int)> { (item, 1) }, afterEvent, argBox);
	}

	public static void ShaolinClearStatue()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		RemoveStatue(247);
		RemoveStatue(264);
		RemoveStatue(265);
		RemoveStatue(271);
		void RemoveStatue(short oldStatueTemplateId)
		{
			ItemKey inventoryItem = GetInventoryItem(taiwu, 12, oldStatueTemplateId);
			if (inventoryItem.IsValid())
			{
				RemoveInventoryItem(taiwu, inventoryItem);
			}
		}
	}

	public static int ShaolinGetDamoFightTimes()
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(1);
		return sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_ShaolinDamoFightTimes");
	}

	public static bool ShaolinLearnCombatSkill(string afterEvent, EventArgBox argBox)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(1);
		sbyte arg = -1;
		arg = (sbyte)((sectMainStoryEventArgBox.Get("ConchShip_PresetKey_ShaolinCombatSkillType", ref arg) && arg >= 0) ? arg : 0);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(taiwuCharId);
		int num = sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_ShaolinDamoFightTimes");
		IReadOnlyList<CombatSkillItem> learnableCombatSkills = CombatSkillDomain.GetLearnableCombatSkills(1, arg);
		sbyte normalPagesDirectProb = (sbyte)((!argBox.GetBool("Reverse")) ? 100 : 0);
		List<(ItemKey, int)> list = new List<(ItemKey, int)>();
		foreach (CombatSkillItem item in learnableCombatSkills)
		{
			if (CombatSkillDomain.GetCombatSkillGradeGroup(item.Grade, 1, arg) == num)
			{
				if (!charCombatSkills.ContainsKey(item.TemplateId))
				{
					LearnCombatSkill(taiwuCharId, item.TemplateId);
				}
				short bookId = item.BookId;
				ItemKey itemKey = DomainManager.Item.CreateSkillBook(mainThreadDataContext, bookId, 5, -1, -1, normalPagesDirectProb);
				taiwu.AddInventoryItem(mainThreadDataContext, itemKey, 1);
				list.Add((itemKey, 1));
			}
		}
		if (list.Count <= 0)
		{
			return false;
		}
		TaskInfoItem taskInfoItem = TaskInfo.Instance[224];
		string[] combatSkillIdsEventArgBoxKey = taskInfoItem.CombatSkillIdsEventArgBoxKey;
		if (combatSkillIdsEventArgBoxKey != null && combatSkillIdsEventArgBoxKey.Length > 0)
		{
			for (int i = 0; i < taskInfoItem.CombatSkillIdsEventArgBoxKey.Length; i++)
			{
				string key = taskInfoItem.CombatSkillIdsEventArgBoxKey[i];
				int num2 = ((i < list.Count) ? list[i].Item1.TemplateId : (-1));
				int arg2 = ((num2 >= 0) ? Config.SkillBook.Instance[num2].CombatSkillTemplateId : (-1));
				sectMainStoryEventArgBox.Set(key, arg2);
			}
		}
		DomainManager.Extra.SaveSectMainStoryEventArgumentBox(mainThreadDataContext, 1);
		ShowGetItemPageForItems(list, afterEvent, argBox);
		return true;
	}

	public static void ShaolinGetSutraMiddle(string afterEvent, EventArgBox argBox)
	{
		ShaolinGetSutraBooks(afterEvent, argBox, 3, 5);
	}

	public static void ShaolinGetSutraHigh(string afterEvent, EventArgBox argBox)
	{
		ShaolinGetSutraBooks(afterEvent, argBox, 6, 8);
	}

	private static void ShaolinGetSutraBooks(string afterEvent, EventArgBox argBox, sbyte beginGrade, sbyte endGrade)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		List<(ItemKey, int)> bookItemKeys = new List<(ItemKey, int)>();
		DomainManager.World.ShaolinGetSutraBooks(mainThreadDataContext, beginGrade, endGrade, delegate(ItemKey itemKey)
		{
			AddInventoryItem(taiwu, itemKey);
			bookItemKeys.Add((itemKey, 1));
		});
		ShowGetItemPageForItems(bookItemKeys, afterEvent, argBox);
	}

	public static bool ShaolinSutraBooksIsRead()
	{
		short arg = -1;
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(1);
		if (!sectMainStoryEventArgBox.Get("ConchShip_PresetKey_ShaolinReadingMaxGradeSutra", ref arg) || arg < 0)
		{
			return false;
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int num = taiwu.FindLearnedLifeSkillIndex(arg);
		if (num < 0)
		{
			return false;
		}
		List<GameData.Domains.Character.LifeSkillItem> learnedLifeSkills = taiwu.GetLearnedLifeSkills();
		return learnedLifeSkills[num].GetReadPagesCount() >= 3;
	}

	public static void ShaolinGetWellWornShoe(string afterEvent, EventArgBox argBox)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		ItemKey itemKey = DomainManager.Item.CreateAccessory(mainThreadDataContext, 252, 1);
		AddInventoryItem(taiwu, itemKey);
		ShowGetItemPageForItems(new List<(ItemKey, int)> { (itemKey, 1) }, afterEvent, argBox);
	}

	public static short ShaolinLifeSkillCombatPractice()
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(1);
		sbyte arg = -1;
		if (!sectMainStoryEventArgBox.Get("ConchShip_PresetKey_ShaolinCombatSkillType", ref arg) || arg < 0)
		{
			return -1;
		}
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(taiwuCharId);
		int num = sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_ShaolinDamoFightTimes");
		List<GameData.Domains.CombatSkill.CombatSkill> list = ObjectPool<List<GameData.Domains.CombatSkill.CombatSkill>>.Instance.Get();
		IReadOnlyList<CombatSkillItem> learnableCombatSkills = CombatSkillDomain.GetLearnableCombatSkills(1, arg);
		foreach (CombatSkillItem item in learnableCombatSkills)
		{
			if (CombatSkillDomain.GetCombatSkillGradeGroup(item.Grade, 1, arg) == num && charCombatSkills.TryGetValue(item.TemplateId, out var value) && !CombatSkillStateHelper.IsBrokenOut(value.GetActivationState()))
			{
				list.Add(value);
			}
		}
		list.Sort((GameData.Domains.CombatSkill.CombatSkill lhs, GameData.Domains.CombatSkill.CombatSkill rhs) => lhs.Template.Grade.CompareTo(rhs.Template.Grade));
		GameData.Domains.CombatSkill.CombatSkill combatSkill = ((list.Count > 0) ? list[0] : null);
		ObjectPool<List<GameData.Domains.CombatSkill.CombatSkill>>.Instance.Return(list);
		if (combatSkill == null)
		{
			return -1;
		}
		int delta = Config.SkillBreakPlate.Instance[combatSkill.Template.Grade].CostExp * 5;
		ChangeRoleExp(DomainManager.Taiwu.GetTaiwu(), delta);
		return combatSkill.GetId().SkillTemplateId;
	}

	public static int GetSectMainStoryCombatTimesShaolin()
	{
		return DomainManager.World.GetSectMainStoryCombatTimesShaolin();
	}

	public static short GetTrialDamoTemplateId()
	{
		int num = ShaolinGetDamoFightTimes();
		if (1 == 0)
		{
		}
		short result = num switch
		{
			0 => 540, 
			1 => 541, 
			_ => 542, 
		};
		if (1 == 0)
		{
		}
		return result;
	}

	public static short GetFinalDamoTemplateId()
	{
		return 542;
	}

	public static bool ShaolinLearnedAllCombatSkill()
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(taiwuCharId);
		IReadOnlyList<IReadOnlyList<CombatSkillItem>> learnableCombatSkills = CombatSkillDomain.GetLearnableCombatSkills(1);
		foreach (IReadOnlyList<CombatSkillItem> item in learnableCombatSkills)
		{
			foreach (CombatSkillItem item2 in item)
			{
				if (!charCombatSkills.ContainsKey(item2.TemplateId))
				{
					return false;
				}
			}
		}
		return true;
	}

	public static bool ShaolinHasUnlearnCombatSkill()
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(1);
		sbyte arg = -1;
		if (!sectMainStoryEventArgBox.Get("ConchShip_PresetKey_ShaolinCombatSkillType", ref arg) || arg < 0)
		{
			return false;
		}
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(taiwuCharId);
		int num = sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_ShaolinDamoFightTimes");
		IReadOnlyList<CombatSkillItem> learnableCombatSkills = CombatSkillDomain.GetLearnableCombatSkills(1, arg);
		foreach (CombatSkillItem item in learnableCombatSkills)
		{
			if (CombatSkillDomain.GetCombatSkillGradeGroup(item.Grade, 1, arg) != num || charCombatSkills.ContainsKey(item.TemplateId))
			{
				continue;
			}
			return true;
		}
		return false;
	}

	public static bool ShaolinHasUnfinishedCombatSkill()
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(1);
		sbyte arg = -1;
		if (!sectMainStoryEventArgBox.Get("ConchShip_PresetKey_ShaolinCombatSkillType", ref arg) || arg < 0)
		{
			return false;
		}
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(taiwuCharId);
		int num = sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_ShaolinDamoFightTimes");
		IReadOnlyList<CombatSkillItem> learnableCombatSkills = CombatSkillDomain.GetLearnableCombatSkills(1, arg);
		foreach (CombatSkillItem item in learnableCombatSkills)
		{
			if (CombatSkillDomain.GetCombatSkillGradeGroup(item.Grade, 1, arg) != num || !charCombatSkills.TryGetValue(item.TemplateId, out var value) || CombatSkillStateHelper.IsBrokenOut(value.GetActivationState()))
			{
				continue;
			}
			return true;
		}
		return false;
	}

	public static bool CharacterIsShaolinBuddhistAbbot(GameData.Domains.Character.Character character)
	{
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		return organizationInfo.OrgTemplateId == 1 && organizationInfo.Grade == 8;
	}

	public static bool CharacterIsShaolinMember(GameData.Domains.Character.Character character)
	{
		return character.GetOrganizationInfo().OrgTemplateId == 1;
	}

	public static bool ShaolinSutraPavilionEntryPermit()
	{
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(1);
		OrgMemberCollection orgMembers = settlementByOrgTemplateId.GetMembers();
		return AnyApprovedTaiwu(6) || AnyApprovedTaiwu(7) || AnyApprovedTaiwu(8);
		bool AnyApprovedTaiwu(sbyte grade)
		{
			return orgMembers.GetMembers(grade).Any(IsSectCharApprovedTaiwu);
		}
	}

	public static bool ShaolinSutraPavilionGuarding()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(1);
		return GetGameDate() == sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_ShaolinSutraPavilionGuardDate");
	}

	public static void SetShaolinSutraPavilionGuard()
	{
		int gameDate = GetGameDate();
		SaveArgToSectMainStory(1, "ConchShip_PresetKey_ShaolinSutraPavilionGuardDate", gameDate);
	}

	public static void ShaolinToEventCombatSutraPavilion(EventArgBox argBox, string winEvent, string failEvent, string fleeEvent)
	{
		sbyte arg = 0;
		string toEventGuid = ((!argBox.Get("CombatResult", ref arg)) ? string.Empty : (CombatResultType.IsPlayerWin(arg) ? winEvent : ((arg == 2) ? fleeEvent : failEvent)));
		ToEvent(toEventGuid);
	}

	public static bool ShaolinInteractMythOptionVisible(EventArgBox argBox)
	{
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		return CharacterIsShaolinMember(character) && IsExtraTaskInProgress(136) && LocationInOrganizationBelongBlocks(character.GetLocation(), 1);
	}

	public static bool LocationInOrganizationBelongBlocks(Location location, sbyte orgTemplateId)
	{
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId);
		if (settlementByOrgTemplateId == null)
		{
			return false;
		}
		Location location2 = settlementByOrgTemplateId.GetLocation();
		if (location2.AreaId != location.AreaId)
		{
			return false;
		}
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		DomainManager.Map.QueryRegularBelongBlocks(list, location2, true);
		bool result = list.Any((MapBlockData block) => block.BlockId == location.BlockId);
		ObjectPool<List<MapBlockData>>.Instance.Return(list);
		return result;
	}

	public static void OpenShaolinMeditationInteraction()
	{
		SaveArgToSectMainStory(1, "ConchShip_PresetKey_ShaolinMeditationInteractionActivated", value: true);
	}

	public static bool ShaolinInteractMeditationOptionVisible()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(1);
		return sectMainStoryEventArgBox.GetBool("ConchShip_PresetKey_ShaolinMeditationInteractionActivated");
	}

	public static void UpdateDamoDreamMeetTaiwuId()
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		SaveArgToSectMainStory(1, "ConchShip_PresetKey_DamoDreamMeetTaiwuId", taiwuCharId);
	}

	public static void OpenSectShaolinDemonSlayer(string afterEvent, EventArgBox argBox)
	{
		if (DomainManager.World.ShaolinGenerateDemonSlayerTrial(Domain.MainThreadDataContext))
		{
			Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(1);
			ChangeSpiritualDebtByAreaId(settlementByOrgTemplateId.GetLocation().AreaId, GetSpiritualDebtFinalCost(settlementByOrgTemplateId.GetId(), -600));
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenSectShaolinDemonSlayer);
	}

	public static bool SectShaolinDemonSlayerTrialing()
	{
		SectShaolinDemonSlayerData sectShaolinDemonSlayerData = DomainManager.Extra.GetSectShaolinDemonSlayerData();
		return sectShaolinDemonSlayerData.Trialing;
	}

	public static void StartDemonSlayerCombat(string afterEvent, EventArgBox argBox)
	{
		int arg = -1;
		argBox.Get("BossIndex", ref arg);
		SectShaolinDemonSlayerData sectShaolinDemonSlayerData = DomainManager.Extra.GetSectShaolinDemonSlayerData();
		DemonSlayerTrialItem trialingDemon = sectShaolinDemonSlayerData.GetTrialingDemon(arg);
		if (trialingDemon == null)
		{
			return;
		}
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		foreach (DemonSlayerTrialRestrictItem trialingRestrict in sectShaolinDemonSlayerData.GetTrialingRestricts(arg))
		{
			if (!string.IsNullOrEmpty(trialingRestrict.EffectClassName))
			{
				Type type = Type.GetType(trialingRestrict.EffectClassName);
				Tester.Assert(type != null, "type != null");
				IReadOnlyList<int> effectParameters = trialingRestrict.EffectParameters;
				object obj = Activator.CreateInstance(type, taiwuCharId, effectParameters);
				SectShaolinDemonSlayerData sectShaolinDemonSlayerData2 = sectShaolinDemonSlayerData;
				if (sectShaolinDemonSlayerData2.TrialingRestrictEffects == null)
				{
					sectShaolinDemonSlayerData2.TrialingRestrictEffects = new List<SpecialEffectBase>();
				}
				sectShaolinDemonSlayerData.TrialingRestrictEffects.Add((SpecialEffectBase)obj);
			}
		}
		GameData.Domains.Character.Character character = DomainManager.World.CreateFixedDemon(mainThreadDataContext, trialingDemon.CharacterId);
		short combatConfigId = sectShaolinDemonSlayerData.GetTrialingRestricts(arg).GetCombatConfigId();
		StartCombat(character.GetId(), combatConfigId, afterEvent, argBox);
	}

	public static void GetSectShaolinDemonSlayerReward(string afterEvent, EventArgBox argBox)
	{
		SectShaolinDemonSlayerData sectShaolinDemonSlayerData = DomainManager.Extra.GetSectShaolinDemonSlayerData();
		int arg = -1;
		argBox.Get("BossIndex", ref arg);
		DemonSlayerTrialItem trialingDemon = sectShaolinDemonSlayerData.GetTrialingDemon(arg);
		if (trialingDemon == null)
		{
			return;
		}
		sbyte combatStatus = DomainManager.Combat.GetCombatStatus();
		if (combatStatus != CombatStatusType.EnemyFail && combatStatus != CombatStatusType.EnemyFlee)
		{
			return;
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		ChangeRoleExp(taiwu, sectShaolinDemonSlayerData.TrialingLevel.RewardExp);
		bool flag = false;
		if (!sectShaolinDemonSlayerData.IsDemonDefeated(trialingDemon.TemplateId))
		{
			flag = true;
			sectShaolinDemonSlayerData.MarkDemonAsDefeated(trialingDemon.TemplateId);
		}
		List<(ItemKey, int)> list = new List<(ItemKey, int)>();
		if (flag)
		{
			ItemKey item = AddItemToRole(taiwu, 2, trialingDemon.FirstTimeRewards, 1, -1);
			list.Add((item, 1));
		}
		foreach (PresetInventoryItem rewardItem in sectShaolinDemonSlayerData.TrialingLevel.RewardItems)
		{
			ItemKey item2 = AddItemToRole(taiwu, rewardItem.Type, rewardItem.TemplateId, 1, -1);
			list.Add((item2, 1));
		}
		ShowGetItemPageForItems(list, afterEvent, argBox);
	}

	public static void StartSelectCharacterFeature(string afterEvent, EventArgBox argBox)
	{
		SectShaolinDemonSlayerData sectShaolinDemonSlayerData = DomainManager.Extra.GetSectShaolinDemonSlayerData();
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "SelectDemonSlayerCharacterFeatureFinish");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.SelectDemonSlayerCharacterFeature, sectShaolinDemonSlayerData.TrialingLevel.TemplateId);
	}

	public static void SectShaolinDemonSlayerToNextLevel()
	{
		SectShaolinDemonSlayerData sectShaolinDemonSlayerData = DomainManager.Extra.GetSectShaolinDemonSlayerData();
		sectShaolinDemonSlayerData.ToNextLevel();
		DomainManager.Extra.SetSectShaolinDemonSlayerData(Domain.MainThreadDataContext, sectShaolinDemonSlayerData);
	}

	public static int GetSectShaolinDemonSlayerCurrLevel()
	{
		SectShaolinDemonSlayerData sectShaolinDemonSlayerData = DomainManager.Extra.GetSectShaolinDemonSlayerData();
		return sectShaolinDemonSlayerData.TrialingLevel.TemplateId;
	}

	public static void CreateShixiangEnemy()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Location location = DomainManager.Organization.GetSettlementByOrgTemplateId(6).GetLocation();
		MapBlockItem mapBlockItem = MapBlock.Instance[(short)24];
		List<MapBlockData> validBlocks = new List<MapBlockData>();
		DomainManager.Adventure.GetValidBlocksForRandomEnemy(location.AreaId, location.BlockId, mapBlockItem.Range, onAdventureSite: true, onSettlement: false, nearTaiwu: true, validBlocks);
		short beginEnemyTemplateIdByXiangshuLevel = SectMainStoryRelatedConstants.GetBeginEnemyTemplateIdByXiangshuLevel();
		int num = mainThreadDataContext.Random.Next(10, 16);
		int num2 = num / 4;
		int num3 = num % 4;
		DomainManager.Adventure.CreateRandomEnemiesOnValidBlocks(Domain.MainThreadDataContext, location, beginEnemyTemplateIdByXiangshuLevel, num2 + num3, validBlocks);
		DomainManager.Adventure.CreateRandomEnemiesOnValidBlocks(Domain.MainThreadDataContext, location, (short)(beginEnemyTemplateIdByXiangshuLevel + 1), num2, validBlocks);
		DomainManager.Adventure.CreateRandomEnemiesOnValidBlocks(Domain.MainThreadDataContext, location, (short)(beginEnemyTemplateIdByXiangshuLevel + 2), num2, validBlocks);
		DomainManager.Adventure.CreateRandomEnemiesOnValidBlocks(Domain.MainThreadDataContext, location, (short)(beginEnemyTemplateIdByXiangshuLevel + 3), num2, validBlocks);
	}

	public static void CreateShixiangTraitorEnemy()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		int num = mainThreadDataContext.Random.Next(15, 21);
		Location location = DomainManager.Organization.GetSettlementByOrgTemplateId(6).GetLocation();
		MapBlockItem mapBlockItem = MapBlock.Instance[(short)24];
		List<MapBlockData> validBlocks = new List<MapBlockData>();
		DomainManager.Adventure.GetValidBlocksForRandomEnemy(location.AreaId, location.BlockId, mapBlockItem.Range, onAdventureSite: true, onSettlement: false, nearTaiwu: true, validBlocks);
		short templateIdOfFixedCharacterCombatWith = SectMainStoryRelatedConstants.GetTemplateIdOfFixedCharacterCombatWith(608, 5);
		int num2 = num / (templateIdOfFixedCharacterCombatWith + 1 - 608);
		int num3 = num % (templateIdOfFixedCharacterCombatWith + 1 - 608);
		for (short num4 = 608; num4 < templateIdOfFixedCharacterCombatWith + 1; num4++)
		{
			CreateShixiangFixedEnemiesOnValidBlocks(num4, (num4 == templateIdOfFixedCharacterCombatWith) ? num2 : (num2 + num3), validBlocks, -1);
		}
	}

	public static void CreateShixiangBarbarianEnemy()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		int num = mainThreadDataContext.Random.Next(30, 41);
		Location location = DomainManager.Organization.GetSettlementByOrgTemplateId(6).GetLocation();
		MapBlockItem mapBlockItem = MapBlock.Instance[(short)24];
		List<MapBlockData> validBlocks = new List<MapBlockData>();
		DomainManager.Adventure.GetValidBlocksForRandomEnemy(location.AreaId, location.BlockId, mapBlockItem.Range, onAdventureSite: true, onSettlement: false, nearTaiwu: true, validBlocks);
		short templateIdOfFixedCharacterCombatWith = SectMainStoryRelatedConstants.GetTemplateIdOfFixedCharacterCombatWith(613, 5);
		int num2 = num / (templateIdOfFixedCharacterCombatWith + 1 - 613);
		int num3 = num % (templateIdOfFixedCharacterCombatWith + 1 - 613);
		for (short num4 = 613; num4 < templateIdOfFixedCharacterCombatWith + 1; num4++)
		{
			short hairColorId = SectMainStoryRelatedConstants.BarbarianMasterHairColorTemplateId[mainThreadDataContext.Random.Next(SectMainStoryRelatedConstants.BarbarianMasterHairColorTemplateId.Length)];
			CreateShixiangFixedEnemiesOnValidBlocks(num4, (num4 == templateIdOfFixedCharacterCombatWith) ? num2 : (num2 + num3), validBlocks, hairColorId);
		}
	}

	public static void CreateShixiangFixedEnemiesOnValidBlocks(short enemyTemplateId, int enemyAmount, IList<MapBlockData> validBlocks, short hairColorId = -1)
	{
		if (enemyTemplateId <= 0)
		{
			return;
		}
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Tester.Assert(Config.Character.Instance[enemyTemplateId].CreatingType == 3);
		for (int i = 0; i < enemyAmount; i++)
		{
			if (validBlocks.Count == 0)
			{
				break;
			}
			int index = mainThreadDataContext.Random.Next(0, validBlocks.Count);
			Location targetLocation = new Location(validBlocks[index].AreaId, validBlocks[index].BlockId);
			GameData.Domains.Character.Character character = DomainManager.Character.CreateFixedEnemy(Domain.MainThreadDataContext, enemyTemplateId);
			int id = character.GetId();
			DomainManager.Character.CompleteCreatingCharacter(id);
			if (hairColorId != -1)
			{
				AvatarData avatar = character.GetAvatar();
				avatar.FrontHairId = hairColorId;
				avatar.BackHairId = hairColorId;
				character.SetAvatar(avatar, mainThreadDataContext);
				DomainManager.Extra.AddShixiangBarbarianMasterId(mainThreadDataContext, character.GetId());
			}
			MoveFixedEnemy(character, targetLocation);
		}
	}

	public static bool IsSettlementRandomEnemyClean(sbyte orgTemplateId, short charTemplateId)
	{
		Location location = DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId).GetLocation();
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		list.Clear();
		DomainManager.Map.GetSettlementBlocksAndAffiliatedBlocks(location.AreaId, location.BlockId, list);
		bool flag = true;
		for (int i = 0; i < list.Count; i++)
		{
			MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, list[i]);
			List<MapTemplateEnemyInfo> templateEnemyList = blockData.TemplateEnemyList;
			if (templateEnemyList == null || templateEnemyList.Count <= 0)
			{
				continue;
			}
			for (int j = 0; j < blockData.TemplateEnemyList.Count; j++)
			{
				if (blockData.TemplateEnemyList[j].TemplateId == charTemplateId)
				{
					flag = false;
					break;
				}
			}
			if (!flag)
			{
				break;
			}
		}
		ObjectPool<List<short>>.Instance.Return(list);
		return flag;
	}

	public static bool IsSettlementFixedEnemyClean(sbyte orgTemplateId, short charTemplateId)
	{
		Location location = DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId).GetLocation();
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		list.Clear();
		DomainManager.Map.GetSettlementBlocksAndAffiliatedBlocks(location.AreaId, location.BlockId, list);
		bool flag = true;
		for (int i = 0; i < list.Count; i++)
		{
			MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, list[i]);
			HashSet<int> enemyCharacterSet = blockData.EnemyCharacterSet;
			if (enemyCharacterSet == null || enemyCharacterSet.Count <= 0)
			{
				continue;
			}
			foreach (int item in blockData.EnemyCharacterSet)
			{
				DomainManager.Character.TryGetElement_Objects(item, out var element);
				if (element.GetTemplateId() == charTemplateId)
				{
					flag = false;
					break;
				}
			}
			if (!flag)
			{
				break;
			}
		}
		ObjectPool<List<short>>.Instance.Return(list);
		return flag;
	}

	public static bool IsShixiangSettlementEnemyClean()
	{
		short beginEnemyTemplateIdByXiangshuLevel = SectMainStoryRelatedConstants.GetBeginEnemyTemplateIdByXiangshuLevel();
		return IsSettlementRandomEnemyClean(6, beginEnemyTemplateIdByXiangshuLevel) && IsSettlementRandomEnemyClean(6, (short)(beginEnemyTemplateIdByXiangshuLevel + 1)) && IsSettlementRandomEnemyClean(6, (short)(beginEnemyTemplateIdByXiangshuLevel + 2)) && IsSettlementRandomEnemyClean(6, (short)(beginEnemyTemplateIdByXiangshuLevel + 3));
	}

	public static bool IsShixiangSettlementTraitorClean()
	{
		short num = 608;
		return IsSettlementFixedEnemyClean(6, num) && IsSettlementFixedEnemyClean(6, (short)(num + 1)) && IsSettlementFixedEnemyClean(6, (short)(num + 2)) && IsSettlementFixedEnemyClean(6, (short)(num + 3));
	}

	public static bool IsShixiangSettlementBarbarianClean()
	{
		short num = 613;
		return IsSettlementFixedEnemyClean(6, num) && IsSettlementFixedEnemyClean(6, (short)(num + 1)) && IsSettlementFixedEnemyClean(6, (short)(num + 2)) && IsSettlementFixedEnemyClean(6, (short)(num + 3));
	}

	public static GameData.Domains.Character.Character GetLocationBarbarianMaster(Location location)
	{
		MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
		HashSet<int> enemyCharacterSet = blockData.EnemyCharacterSet;
		if (enemyCharacterSet != null && enemyCharacterSet.Count > 0)
		{
			foreach (int item in blockData.EnemyCharacterSet)
			{
				DomainManager.Character.TryGetElement_Objects(item, out var element);
				short templateId = element.GetTemplateId();
				if (templateId >= 613 && templateId <= 617)
				{
					return element;
				}
			}
		}
		return null;
	}

	public static bool CheckShixiangPartOneTriggered()
	{
		sbyte sectMainStoryTaskStatus = GetSectMainStoryTaskStatus(6);
		int extraTaskChainCurrentTask = GetExtraTaskChainCurrentTask(34);
		if (sectMainStoryTaskStatus != 0)
		{
			return false;
		}
		if (extraTaskChainCurrentTask >= 0 && extraTaskChainCurrentTask != 232)
		{
			return false;
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		sbyte stateIdByAreaId = GetStateIdByAreaId(location.AreaId);
		sbyte stateIdByStateTemplateId = GetStateIdByStateTemplateId(6);
		if (stateIdByAreaId != stateIdByStateTemplateId)
		{
			return false;
		}
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		DomainManager.Map.GetStateSettlementIds(stateIdByStateTemplateId, list, containsMainCity: true);
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(6);
		sectMainStoryEventArgBox.Get<GameData.Utilities.ShortList>("ConchShip_PresetKey_MockShixiangEventTriggeredSettlementId", out GameData.Utilities.ShortList arg);
		int arg2 = 0;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_MockShixiangEventCount", ref arg2);
		if (arg2 >= 3)
		{
			return false;
		}
		if (arg2 == 0 && sectMainStoryEventArgBox.Contains<int>(SectMainStoryEventArgKeys.TriggeringStatus))
		{
			return false;
		}
		if (arg.Items == null)
		{
			arg = GameData.Utilities.ShortList.Create();
		}
		List<short> list2 = ObjectPool<List<short>>.Instance.Get();
		for (int i = 0; i < list.Count; i++)
		{
			if (arg.Items.Contains(list[i]))
			{
				continue;
			}
			list2.Clear();
			Settlement settlement = DomainManager.Organization.GetSettlement(list[i]);
			Location location2 = settlement.GetLocation();
			if (location2.AreaId == location.AreaId)
			{
				DomainManager.Map.GetSettlementBlocks(location2.AreaId, location2.BlockId, list2);
				if (list2.Contains(location.BlockId))
				{
					ObjectPool<List<short>>.Instance.Return(list2);
					ObjectPool<List<short>>.Instance.Return(list);
					return true;
				}
			}
		}
		ObjectPool<List<short>>.Instance.Return(list2);
		ObjectPool<List<short>>.Instance.Return(list);
		return false;
	}

	public static void SaveShixiangPartOneTriggered()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		sbyte stateIdByStateTemplateId = GetStateIdByStateTemplateId(6);
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		DomainManager.Map.GetStateSettlementIds(stateIdByStateTemplateId, list, containsMainCity: true);
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(6);
		sectMainStoryEventArgBox.Get<GameData.Utilities.ShortList>("ConchShip_PresetKey_MockShixiangEventTriggeredSettlementId", out GameData.Utilities.ShortList arg);
		if (arg.Items == null)
		{
			arg = GameData.Utilities.ShortList.Create();
		}
		List<short> list2 = ObjectPool<List<short>>.Instance.Get();
		for (int i = 0; i < list.Count; i++)
		{
			Settlement settlement = DomainManager.Organization.GetSettlement(list[i]);
			list2.Clear();
			Location location2 = settlement.GetLocation();
			if (location2.AreaId != location.AreaId)
			{
				continue;
			}
			DomainManager.Map.GetSettlementBlocks(location2.AreaId, location2.BlockId, list2);
			if (list2.Contains(location.BlockId))
			{
				arg.Items.Add(list[i]);
				SaveArgToSectMainStory(6, "ConchShip_PresetKey_MockShixiangEventTriggeredSettlementId", arg);
				int arg2 = 0;
				sectMainStoryEventArgBox.Get("ConchShip_PresetKey_MockShixiangEventCount", ref arg2);
				if (arg2 == 0)
				{
					TriggerExtraTask(34, 232);
				}
				if (arg2 >= 2)
				{
					TriggerExtraTask(34, 233);
				}
				arg2++;
				SaveArgToSectMainStory(6, "ConchShip_PresetKey_MockShixiangEventCount", arg2);
				break;
			}
		}
		ObjectPool<List<short>>.Instance.Return(list);
		ObjectPool<List<short>>.Instance.Return(list2);
	}

	public static short GetMockShixiangEventIndex()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(6);
		sectMainStoryEventArgBox.Get<GameData.Utilities.ShortList>("ConchShip_PresetKey_MockShixiangEventTriggered", out GameData.Utilities.ShortList arg);
		List<short> list = new List<short> { 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 };
		if (arg.Items == null)
		{
			arg = GameData.Utilities.ShortList.Create();
		}
		short num = 1;
		if (arg.Items == null || arg.Items.Count == 0 || arg.Items.Count == 10)
		{
			num = (short)mainThreadDataContext.Random.Next(1, 11);
		}
		else
		{
			for (int i = 0; i < arg.Items.Count; i++)
			{
				list.Remove(arg.Items[i]);
			}
			num = list[mainThreadDataContext.Random.Next(0, list.Count)];
		}
		arg.Items.Add(num);
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_MockShixiangEventTriggered", (ISerializableGameData)(object)arg);
		SaveSectMainStoryEventArgBox(6);
		return num;
	}

	public static void SelectCombatWithBarbarians()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.TriggerExtraTask(mainThreadDataContext, 34, 177);
		ShixiangSaveEndTime();
		SaveArgToSectMainStory(6, "ConchShip_PresetKey_ShixiangToFightEnemy", value: true);
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(6);
		if (settlementByOrgTemplateId != null)
		{
			int num = 5;
			int num2 = mainThreadDataContext.Random.Next(num, 11);
			int num3 = num2 / num;
			int num4 = num2 % num;
			OrgMemberCollection members = settlementByOrgTemplateId.GetMembers();
			for (sbyte b = 5; b >= 0; b--)
			{
				HashSet<int> members2 = members.GetMembers(b);
				ChangeMemberFavorability(members2, (b == 5) ? (num3 + num4) : num3);
			}
		}
	}

	public static void ShixiangRandomAddFavor()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		int count = mainThreadDataContext.Random.Next(1, 4);
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(6);
		if (settlementByOrgTemplateId != null)
		{
			OrgMemberCollection members = settlementByOrgTemplateId.GetMembers();
			List<int> list = ObjectPool<List<int>>.Instance.Get();
			members.GetAllMembers(list);
			ChangeMemberFavorability(list.ToHashSet(), count);
			ObjectPool<List<int>>.Instance.Return(list);
		}
	}

	public static void SelectWaitShixiangCombatWithBarbarians()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.TriggerExtraTask(mainThreadDataContext, 34, 234);
		ShixiangSaveEndTime();
		SaveArgToSectMainStory(6, "ConchShip_PresetKey_ShixiangToFightEnemy", value: true);
	}

	private static void ShixiangSaveEndTime()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(6);
		bool arg = false;
		if (sectMainStoryEventArgBox.Get("ConchShip_PresetKey_SelectGoodEnd", ref arg))
		{
			SaveArgToSectMainStory(6, arg ? "ConchShip_PresetKey_SectMainStoryShixiangProsperousEndDate" : "ConchShip_PresetKey_SectMainStoryShixiangFailingEndDate", GetGameDate());
		}
	}

	public static void ChangeMemberFavorability(HashSet<int> member, int count)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		foreach (int item in member)
		{
			if (DomainManager.Character.TryGetElement_Objects(item, out var element))
			{
				ChangeFavorabilityWithMergeOptional(element, taiwu, 3000, 4);
				count--;
				if (count == 0)
				{
					break;
				}
			}
		}
	}

	public static void GetShixiangEndAward(string afterEvent = "", EventArgBox argBox = null)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(6);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_SelectGoodEnd", ref arg);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		if (arg)
		{
			ChangeRoleResource(taiwu, 7, 15000);
		}
		List<ItemKey> list = new List<ItemKey>();
		for (int i = 0; i < 3; i++)
		{
			ItemKey randomItemByGrade = GetRandomItemByGrade(6, 901);
			list.Add(randomItemByGrade);
		}
		for (int j = 0; j < 2; j++)
		{
			ItemKey randomItemByGrade2 = GetRandomItemByGrade(7, 901);
			list.Add(randomItemByGrade2);
		}
		ItemKey randomItemByGrade3 = GetRandomItemByGrade(8, 901);
		list.Add(randomItemByGrade3);
		List<(ItemKey, int)> list2 = new List<(ItemKey, int)>();
		for (int k = 0; k < list.Count; k++)
		{
			ItemKey item = AddItemToRole(taiwu, 9, list[k].TemplateId, 1, -1);
			list2.Add((item, 1));
		}
		ShowGetItemPageForItems(list2, afterEvent, argBox);
	}

	public static void UpdateShixiangEnemy(GameData.Domains.Character.Character enemy)
	{
		Location location = enemy.GetLocation();
		MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		list.Clear();
		if (CharacterIsBarbarianMaster(enemy))
		{
			int num = 0;
			foreach (int item in blockData.EnemyCharacterSet)
			{
				if (DomainManager.Character.TryGetElement_Objects(item, out var element) && CharacterIsBarbarianMaster(element))
				{
					num++;
					list.Add(item);
				}
			}
			if (IsExtraTaskInProgress(177))
			{
				EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(6);
				int arg = 0;
				sectMainStoryEventArgBox.Get("ConchShip_PresetKey_TaiwuKillBarbarianMasterCount", ref arg);
				int arg2 = 0;
				sectMainStoryEventArgBox.Get("ConchShip_PresetKey_TaiwuKillBarbarianMasterCount2", ref arg2);
				SaveArgToSectMainStory(6, "ConchShip_PresetKey_TaiwuKillBarbarianMasterCount", arg + num);
				SaveArgToSectMainStory(6, "ConchShip_PresetKey_TaiwuKillBarbarianMasterCount2", arg2 + num);
			}
		}
		else if (CharacterIsShixiangTraitor(enemy))
		{
			foreach (int item2 in blockData.EnemyCharacterSet)
			{
				if (DomainManager.Character.TryGetElement_Objects(item2, out var element2) && CharacterIsShixiangTraitor(element2))
				{
					list.Add(item2);
				}
			}
		}
		foreach (int item3 in list)
		{
			if (DomainManager.Character.TryGetElement_Objects(item3, out var element3))
			{
				RemoveNonIntelligentCharacter(element3);
			}
		}
		ObjectPool<List<int>>.Instance.Return(list);
	}

	public static void ShixiangHelpCharacterReadBook(ItemKey book, GameData.Domains.Character.Character character)
	{
		Tester.Assert(book.ItemType == 10);
		SkillBookItem skillBookItem = Config.SkillBook.Instance[book.TemplateId];
		List<GameData.Domains.Character.LifeSkillItem> learnedLifeSkills = character.GetLearnedLifeSkills();
		int num = character.FindLearnedLifeSkillIndex(skillBookItem.LifeSkillTemplateId);
		if (num < 0)
		{
			return;
		}
		GameData.Domains.Character.LifeSkillItem lifeSkillItem = learnedLifeSkills[num];
		for (byte b = 0; b < 5; b++)
		{
			if (!lifeSkillItem.IsPageRead(b))
			{
				DataContext mainThreadDataContext = Domain.MainThreadDataContext;
				character.ReadLifeSkillPage(mainThreadDataContext, num, b);
				break;
			}
		}
	}

	[Obsolete]
	public static List<short> GetShixiangCanLearnCombatSkillList(int charId)
	{
		return new List<short>();
	}

	[Obsolete]
	public static void AddCombatPracticeLevel(short templateId)
	{
	}

	public static bool CharacterIsBarbarianMaster(GameData.Domains.Character.Character character)
	{
		if (character == null)
		{
			return false;
		}
		return character.GetTemplateId() >= 613 && character.GetTemplateId() <= 617;
	}

	public static bool CharacterIsShixiangTraitor(GameData.Domains.Character.Character character)
	{
		if (character == null)
		{
			return false;
		}
		return character.GetTemplateId() >= 608 && character.GetTemplateId() <= 612;
	}

	public static void MoveTaiwuOutShixiangSettlement()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.World.ClearTrivialMonthlyEvents(mainThreadDataContext);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(6);
		Location location2 = settlementByOrgTemplateId.GetLocation();
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		list.Clear();
		DomainManager.Map.GetSettlementBlocks(location2.AreaId, location2.BlockId, list);
		List<MapBlockData> list2 = new List<MapBlockData>();
		DomainManager.Map.GetRealNeighborBlocks(location.AreaId, location.BlockId, list2);
		short num = -1;
		foreach (MapBlockData item in list2)
		{
			if (!list.Contains(item.BlockId))
			{
				num = item.BlockId;
				break;
			}
		}
		Tester.Assert(num != -1);
		DomainManager.Map.Move(mainThreadDataContext, num, notCostTime: true);
		ObjectPool<List<short>>.Instance.Return(list);
	}

	public static string GetShixiangLeaderName()
	{
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(6);
		GameData.Domains.Character.Character leader = settlementByOrgTemplateId.GetLeader();
		if (leader == null || leader.GetKidnapperId() >= 0)
		{
			return "<Language Key=Event_SectStoryShixiang_Qianbei/>";
		}
		return OrganizationMember.Instance[91].GradeName;
	}

	public static GameData.Domains.Character.Character GetShixiangValidLeader()
	{
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(6);
		GameData.Domains.Character.Character leader = settlementByOrgTemplateId.GetLeader();
		if (leader == null || leader.GetKidnapperId() >= 0 || leader.GetAgeGroup() == 0)
		{
			return null;
		}
		return leader;
	}

	public static void ShixiangMembersPoisoned()
	{
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(6);
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		settlementByOrgTemplateId.GetMembers().GetAllMembers(list);
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		foreach (int item in list)
		{
			if (DomainManager.Character.TryGetElement_Objects(item, out var element))
			{
				for (sbyte b = 0; b < 6; b++)
				{
					int delta = mainThreadDataContext.Random.Next(500, 1000);
					element.ChangePoisoned(mainThreadDataContext, b, 0, delta);
				}
			}
		}
		ObjectPool<List<int>>.Instance.Return(list);
	}

	public static void ShixiangMembersHealPoison()
	{
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(6);
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		settlementByOrgTemplateId.GetMembers().GetAllMembers(list);
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		foreach (int item in list)
		{
			if (DomainManager.Character.TryGetElement_Objects(item, out var element))
			{
				PoisonInts poisoned = element.GetPoisoned();
				PoisonInts delta = poisoned.GetReversed();
				element.DirectlyChangePoisoned(mainThreadDataContext, ref delta);
			}
		}
		ObjectPool<List<int>>.Instance.Return(list);
	}

	public static int GetShixiangMemberWithCondition()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
		if (blockData.CharacterSet == null)
		{
			return -1;
		}
		foreach (int item in blockData.CharacterSet)
		{
			if (item >= 0)
			{
				GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(item);
				if (element_Objects.GetAgeGroup() >= 2 && element_Objects.GetOrganizationInfo().OrgTemplateId == 6 && CheckRoleInjured(element_Objects) && GetFavorabilityType(element_Objects, taiwu) >= 0)
				{
					return item;
				}
			}
		}
		foreach (int item2 in blockData.CharacterSet)
		{
			if (item2 >= 0)
			{
				GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(item2);
				if (element_Objects2.GetAgeGroup() >= 2 && element_Objects2.GetOrganizationInfo().OrgTemplateId == 6 && GetFavorabilityType(element_Objects2, taiwu) >= 0)
				{
					return item2;
				}
			}
		}
		return -1;
	}

	public static void OpenUpgradeTeammateCommand(string afterEvent, EventArgBox argBox)
	{
		Domain.SetListenerWithActionName(afterEvent, argBox, "UpgradeTeammateCommand");
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenUpgradeTeammateCommand);
	}

	public static void SetTeammatesName(EventArgBox argBox)
	{
		argBox.Get<IntList>("Teammates", out IntList arg);
		StringBuilder stringBuilder = new StringBuilder();
		for (int i = 0; i < arg.Items.Count; i++)
		{
			(string, string) displayName = DomainManager.Character.GetNameRelatedData(arg.Items[i]).GetDisplayName(isTaiwu: false);
			string value = displayName.Item1 + displayName.Item2;
			stringBuilder.Append(value);
			if (i != arg.Items.Count - 1)
			{
				stringBuilder.Append("");
			}
		}
		argBox.Set("TeammatesName", stringBuilder.ToString());
	}

	public static void ClearShixiangRandomEnemy()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(6);
		Location location = settlementByOrgTemplateId.GetLocation();
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		MapBlockItem mapBlockItem = MapBlock.Instance[(short)24];
		DomainManager.Map.GetRealNeighborBlocks(location.AreaId, location.BlockId, list, mapBlockItem.Range);
		MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
		list.Add(blockData);
		foreach (MapBlockData item in list)
		{
			List<MapTemplateEnemyInfo> list2 = ObjectPool<List<MapTemplateEnemyInfo>>.Instance.Get();
			if (item.TemplateEnemyList != null && item.TemplateEnemyList.Count > 0)
			{
				foreach (MapTemplateEnemyInfo templateEnemy in item.TemplateEnemyList)
				{
					list2.Add(templateEnemy);
				}
				foreach (MapTemplateEnemyInfo item2 in list2)
				{
					Events.RaiseTemplateEnemyLocationChanged(mainThreadDataContext, item2, item.GetLocation(), Location.Invalid);
				}
			}
			ObjectPool<List<MapTemplateEnemyInfo>>.Instance.Return(list2);
		}
		ObjectPool<List<MapBlockData>>.Instance.Return(list);
	}

	public static bool ShixiangOrgMemberConfigTemplateIdIsLiterati(short templateId)
	{
		if (templateId == 184 || templateId == 193 || templateId == 202 || templateId == 211)
		{
			return true;
		}
		return false;
	}

	public static bool IsWuDangPrologueCheckPass()
	{
		if (DomainManager.TutorialChapter.InGuiding)
		{
			return false;
		}
		if (GetSectMainStoryTaskStatus(4) != 0)
		{
			return false;
		}
		if (!IsSectAllowLearning(4))
		{
			return false;
		}
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(4);
		if (sectMainStoryEventArgBox.Contains<int>(SectMainStoryEventArgKeys.TriggeringStatus))
		{
			return false;
		}
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		Location location2 = GetSettlementByOrgTemplateId(4).GetLocation();
		if (location.AreaId != location2.AreaId)
		{
			return false;
		}
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_WudangFrontEventTriggered", ref arg);
		if (arg)
		{
			return false;
		}
		if (CheckProbability(50))
		{
			return false;
		}
		return true;
	}

	public static void SetBlackSnakeName(EventArgBox argBox)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(4);
		string arg = string.Empty;
		if (sectMainStoryEventArgBox.Get("ConchShip_PresetKey_BlackSnakeCustomName", ref arg))
		{
			argBox.Set("BlackSnake", arg);
			return;
		}
		CharacterItem characterItem = Config.Character.Instance[(short)672];
		argBox.Set("BlackSnake", characterItem.GivenName);
	}

	public static void OpenModifyBook(string afterEvent, EventArgBox argBox)
	{
		Domain.SetListenerWithActionName(afterEvent, argBox, "BookModified");
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenModifyBook);
	}

	public static void BlockOverWrittenByHeavenlyTree(int id, bool isSuccess)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		if (!DomainManager.Extra.TryGetHeavenlyTreeById(id, out var tree))
		{
			return;
		}
		if (isSuccess)
		{
			DomainManager.Map.ChangeBlockTemplate(mainThreadDataContext, tree.Location, GetBlockTemplateIdByHeavenlyTreeTemplateId(tree.TemplateId), isTurnVisible: true);
		}
		else
		{
			MapBlockData block = DomainManager.Map.GetBlock(tree.Location);
			if (block.BlockSubType != EMapBlockSubType.DLCLoong)
			{
				block.Destroyed = true;
				block.CurrResources.Initialize();
				DomainManager.Map.DestroyMapBlockItemsDirect(mainThreadDataContext, block);
			}
			TriggerWudangHeavenlyTreeExtraTask(240);
			WudangIntEventArgChange("ConchShip_PresetKey_FinishFairylandStoryCount", -1);
		}
		DomainManager.Extra.RemoveHeavenlyTree(mainThreadDataContext, tree.Id);
		DomainManager.Character.TryGetElement_Objects(tree.Id, out var element);
		RemoveNonIntelligentCharacter(element);
		if (GetGrowingHeavenlyTreeCount() == 0)
		{
			FinishExtraTask(41, 238);
		}
		if (GetNormalSeedAndTreeCount() == 0)
		{
			FinishExtraTask(57, 405);
		}
		if (GetFindFairylandCount() == 0)
		{
			FinishExtraTask(41, 152);
		}
		if (tree.MetInDream)
		{
			DomainManager.Extra.RemoveWudangFairyland(mainThreadDataContext, tree.Location);
		}
	}

	public static short GetBlockTemplateIdByHeavenlyTreeTemplateId(short templateId)
	{
		if (1 == 0)
		{
		}
		EMapBlockSubType eMapBlockSubType = templateId switch
		{
			272 => EMapBlockSubType.Mountain, 
			273 => EMapBlockSubType.Cave, 
			274 => EMapBlockSubType.Canyon, 
			275 => EMapBlockSubType.Swamp, 
			276 => EMapBlockSubType.Hill, 
			277 => EMapBlockSubType.TaoYuan, 
			278 => EMapBlockSubType.Field, 
			279 => EMapBlockSubType.Lake, 
			280 => EMapBlockSubType.Woodland, 
			281 => EMapBlockSubType.Jungle, 
			282 => EMapBlockSubType.RiverBeach, 
			283 => EMapBlockSubType.Valley, 
			394 => EMapBlockSubType.Mountain, 
			395 => EMapBlockSubType.Cave, 
			396 => EMapBlockSubType.Canyon, 
			397 => EMapBlockSubType.Swamp, 
			398 => EMapBlockSubType.Hill, 
			399 => EMapBlockSubType.TaoYuan, 
			400 => EMapBlockSubType.Field, 
			401 => EMapBlockSubType.Lake, 
			402 => EMapBlockSubType.Woodland, 
			403 => EMapBlockSubType.Jungle, 
			404 => EMapBlockSubType.RiverBeach, 
			405 => EMapBlockSubType.Valley, 
			_ => EMapBlockSubType.Invalid, 
		};
		if (1 == 0)
		{
		}
		EMapBlockSubType eMapBlockSubType2 = eMapBlockSubType;
		List<int> list = new List<int>();
		for (int i = 0; i < MapBlock.Instance.Count; i++)
		{
			if (MapBlock.Instance[i].SubType == eMapBlockSubType2)
			{
				list.Add(i);
			}
		}
		return MapBlock.Instance[list[Domain.MainThreadDataContext.Random.Next(0, list.Count)]].TemplateId;
	}

	public static void PlantHeavenlyTree(short itemTemplateId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character character = DomainManager.Character.CreateFixedEnemy(mainThreadDataContext, 673);
		int id = character.GetId();
		DomainManager.Character.CompleteCreatingCharacter(id);
		character.SetLocation(location, mainThreadDataContext);
		DomainManager.Extra.PlantHeavenlyTree(mainThreadDataContext, id, itemTemplateId, location);
		MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
		DomainManager.Map.SetBlockData(mainThreadDataContext, blockData);
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		DomainManager.Map.GetRealNeighborBlocks(location.AreaId, location.BlockId, list, 3, includeCenter: true);
		foreach (MapBlockData item in list)
		{
			if (!item.Visible)
			{
				item.SetVisible(visible: true, mainThreadDataContext);
			}
		}
		ObjectPool<List<MapBlockData>>.Instance.Return(list);
		if (!ItemTemplateHelper.CheckIsHeavenlyNormalTreeSeeds(12, itemTemplateId))
		{
			TriggerWudangHeavenlyTreeExtraTask(238);
		}
		if (GetHeavenlyTreeSeedCount() == 0)
		{
			FinishExtraTask(41, 237);
		}
		if (GetNormalSeedAndTreeCount() > 0)
		{
			TriggerExtraTask(57, 405);
		}
	}

	public static SectStoryHeavenlyTreeExtendable GetHeavenlyTree(int id)
	{
		DomainManager.Extra.TryGetHeavenlyTreeById(id, out var tree);
		return tree;
	}

	public static SectStoryHeavenlyTreeExtendable GetHeavenlyTreeByLocation(Location location)
	{
		DomainManager.Extra.TryGetHeavenlyTreeByLocation(location, out var tree);
		return tree;
	}

	public static void HeavenlyTreeGrewUp(GameData.Domains.Character.Character character, int delta, EventArgBox argBox)
	{
		if (DomainManager.Adventure.GetCurAdventureId() < 0)
		{
			int arg = DomainManager.Extra.HeavenlyTreeGrewUp(Domain.MainThreadDataContext, character.GetId(), delta, showUI: true);
			argBox.Set("CharacterId", arg);
		}
	}

	public static void SetHeavenlyTreeMetInDream(int id)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.SetHeavenlyTreeMetInDream(mainThreadDataContext, id, met: true);
		TriggerWudangHeavenlyTreeExtraTask(152);
	}

	public static void SetHeavenlyTreeFindFairyland(int id)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.SetHeavenlyTreeFindFairyland(mainThreadDataContext, id, find: true);
		WudangIntEventArgChange("ConchShip_PresetKey_FinishFairylandStoryCount", 1);
	}

	public static void SetHeavenlyTreeFightWithSnake(int id)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.SetHeavenlyTreeFightWithSnake(mainThreadDataContext, id, alreadyFight: true);
	}

	public static void SetHeavenlyTreeSnakeTemplateId(int id, short templateId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.SetHeavenlyTreeSnakeTemplateId(mainThreadDataContext, id, templateId);
	}

	public static short GetFightSnakeTemplateId(int id)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		SectStoryHeavenlyTreeExtendable heavenlyTree = GetHeavenlyTree(id);
		if (heavenlyTree.SnakeTemplateId > 0)
		{
			return heavenlyTree.SnakeTemplateId;
		}
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(4);
		short num = -1;
		sectMainStoryEventArgBox.Get<GameData.Utilities.ShortList>("ConchShip_PresetKey_WudangSankeFighted", out GameData.Utilities.ShortList arg);
		if (arg.Items == null || arg.Items.Count == 0)
		{
			num = SectMainStoryRelatedConstants.SnakeItemInfo[mainThreadDataContext.Random.Next(0, SectMainStoryRelatedConstants.SnakeItemInfo.Length)].Item1;
		}
		else
		{
			List<short> list = ObjectPool<List<short>>.Instance.Get();
			for (int i = 0; i < SectMainStoryRelatedConstants.SnakeItemInfo.Length; i++)
			{
				if (!arg.Items.Contains(SectMainStoryRelatedConstants.SnakeItemInfo[i].Item1))
				{
					list.Add(SectMainStoryRelatedConstants.SnakeItemInfo[i].Item1);
				}
			}
			num = list[mainThreadDataContext.Random.Next(0, list.Count)];
			ObjectPool<List<short>>.Instance.Return(list);
		}
		SetHeavenlyTreeSnakeTemplateId(id, num);
		AddFightSnakeTemplateId(num);
		return num;
	}

	public static bool HaveNotDefeatSnake()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(4);
		sectMainStoryEventArgBox.Get<GameData.Utilities.ShortList>("ConchShip_PresetKey_WudangSankeFighted", out GameData.Utilities.ShortList arg);
		if (arg.Items != null)
		{
			return arg.Items.Count < SectMainStoryRelatedConstants.SnakeItemInfo.Length;
		}
		return true;
	}

	public static void AddFightSnakeTemplateId(short templateId)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(4);
		sectMainStoryEventArgBox.Get<GameData.Utilities.ShortList>("ConchShip_PresetKey_WudangSankeFighted", out GameData.Utilities.ShortList arg);
		if (arg.Items == null)
		{
			arg = GameData.Utilities.ShortList.Create();
		}
		arg.Items.Add(templateId);
		SaveArgToSectMainStory(4, "ConchShip_PresetKey_WudangSankeFighted", arg);
	}

	public static void GetWudangReverseBook(string afterString, EventArgBox argBox)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		short num = -1;
		short num2 = -1;
		short num3 = -1;
		do
		{
			int num4 = mainThreadDataContext.Random.Next(0, 14);
			num = GetCombatSkillId((sbyte)num4, 4, 0);
		}
		while (num == -1);
		do
		{
			int num5 = mainThreadDataContext.Random.Next(0, 14);
			num2 = GetCombatSkillId((sbyte)num5, 4, 0);
		}
		while (num2 == -1 || num2 == num);
		do
		{
			int num6 = mainThreadDataContext.Random.Next(0, 14);
			num3 = GetCombatSkillId((sbyte)num6, 4, 0);
		}
		while (num3 == -1 || num3 == num || num3 == num2);
		ItemKey itemKey = CreateSkillBook(Config.CombatSkill.Instance[num].BookId, -1, -1, -1, 0);
		ItemKey itemKey2 = CreateSkillBook(Config.CombatSkill.Instance[num2].BookId, -1, -1, -1, 0);
		ItemKey itemKey3 = CreateSkillBook(Config.CombatSkill.Instance[num3].BookId, -1, -1, -1, 0);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		AddInventoryItem(taiwu, itemKey);
		AddInventoryItem(taiwu, itemKey2);
		AddInventoryItem(taiwu, itemKey3);
		List<(ItemKey, int)> itemList = new List<(ItemKey, int)>
		{
			(itemKey, 1),
			(itemKey2, 1),
			(itemKey3, 1)
		};
		ShowGetItemPageForItems(itemList, afterString, argBox);
	}

	public static short GetRandomWudangLowestCombatSkill()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		short num = -1;
		while (num == -1)
		{
			int num2 = mainThreadDataContext.Random.Next(0, 14);
			num = GetCombatSkillId((sbyte)num2, 4, 0);
		}
		return num;
	}

	public static bool LifeSkillBookAllPagesRead(GameData.Domains.Character.Character character, short skillTemplateId)
	{
		List<GameData.Domains.Character.LifeSkillItem> learnedLifeSkills = character.GetLearnedLifeSkills();
		foreach (GameData.Domains.Character.LifeSkillItem item in learnedLifeSkills)
		{
			if (item.SkillTemplateId == skillTemplateId && item.IsAllPagesRead())
			{
				return true;
			}
		}
		return false;
	}

	public static bool TaoismAttainmentsIsEnough()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(4);
		int findFairylandCount = GetFindFairylandCount();
		int num = 0;
		if (findFairylandCount == 0)
		{
			num = 50;
		}
		if (findFairylandCount == 1)
		{
			num = 100;
		}
		if (findFairylandCount == 2)
		{
			num = 150;
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		return taiwu.GetLifeSkillAttainment(12) >= num;
	}

	public static void GetWudangTreasureBySnakeTemplateId(short templateId, string afterString, EventArgBox argBox)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		short itemTemplateId = -1;
		(short, short)[] snakeItemInfo = SectMainStoryRelatedConstants.SnakeItemInfo;
		for (int i = 0; i < snakeItemInfo.Length; i++)
		{
			(short, short) tuple = snakeItemInfo[i];
			if (tuple.Item1 == templateId)
			{
				itemTemplateId = tuple.Item2;
				break;
			}
		}
		ItemKey itemKey = AddItemToRole(taiwu, 12, itemTemplateId, 1, -1);
		argBox.Set("GetItemKey", (ISerializableGameData)(object)itemKey);
		List<(ItemKey, int)> itemList = new List<(ItemKey, int)> { (itemKey, 1) };
		TriggerWudangHeavenlyTreeExtraTask(153);
		ShowGetItemPageForItems(itemList, afterString, argBox);
	}

	public static short GetWudangTreasureTemplateIdBySnake(short templateId, EventArgBox argBox)
	{
		short num = -1;
		(short, short)[] snakeItemInfo = SectMainStoryRelatedConstants.SnakeItemInfo;
		for (int i = 0; i < snakeItemInfo.Length; i++)
		{
			(short, short) tuple = snakeItemInfo[i];
			if (tuple.Item1 == templateId)
			{
				num = tuple.Item2;
				break;
			}
		}
		ItemKey itemKey = new ItemKey(12, 0, num, 0);
		argBox.Set("ItemKey", (ISerializableGameData)(object)itemKey);
		return num;
	}

	public static string GetFairylandDescBySnakeTemplateId(int id)
	{
		SectStoryHeavenlyTreeExtendable heavenlyTree = GetHeavenlyTree(id);
		return heavenlyTree.SnakeTemplateId switch
		{
			555 => "<Language Key=Event_SectStoryWudang_FairylandDesc1/>", 
			558 => "<Language Key=Event_SectStoryWudang_FairylandDesc2/>", 
			561 => "<Language Key=Event_SectStoryWudang_FairylandDesc3/>", 
			564 => "<Language Key=Event_SectStoryWudang_FairylandDesc4/>", 
			567 => "<Language Key=Event_SectStoryWudang_FairylandDesc5/>", 
			570 => "<Language Key=Event_SectStoryWudang_FairylandDesc6/>", 
			573 => "<Language Key=Event_SectStoryWudang_FairylandDesc7/>", 
			576 => "<Language Key=Event_SectStoryWudang_FairylandDesc8/>", 
			579 => "<Language Key=Event_SectStoryWudang_FairylandDesc9/>", 
			_ => "<Language Key=Event_SectStoryWudang_FairylandDesc10/>", 
		};
	}

	public static sbyte GetCurrSeason()
	{
		sbyte currMonthInYear = DomainManager.World.GetCurrMonthInYear();
		foreach (SeasonItem item in (IEnumerable<SeasonItem>)Season.Instance)
		{
			if (item.Months.Contains(currMonthInYear))
			{
				return item.TemplateId;
			}
		}
		return -1;
	}

	public static void GetHeavenlyTreeSeed(string afterString, EventArgBox argBox)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		short arg = -1;
		argBox.Get("SeedOneTemplateId", ref arg);
		short arg2 = -1;
		argBox.Get("SeedTwoTemplateId", ref arg2);
		short arg3 = -1;
		argBox.Get("SeedThreeTemplateId", ref arg3);
		ItemKey item = ItemKey.Invalid;
		ItemKey item2 = ItemKey.Invalid;
		ItemKey item3 = ItemKey.Invalid;
		if (arg != -1)
		{
			item = AddItemToRole(taiwu, 12, arg, 1, -1);
		}
		if (arg2 != -1)
		{
			item2 = AddItemToRole(taiwu, 12, arg2, 1, -1);
		}
		if (arg3 != -1)
		{
			item3 = AddItemToRole(taiwu, 12, arg3, 1, -1);
		}
		List<(ItemKey, int)> list = new List<(ItemKey, int)>();
		if (!item.Equals(ItemKey.Invalid))
		{
			list.Add((item, 1));
		}
		if (!item2.Equals(ItemKey.Invalid))
		{
			list.Add((item2, 1));
		}
		if (!item3.Equals(ItemKey.Invalid))
		{
			list.Add((item3, 1));
		}
		TriggerWudangHeavenlyTreeExtraTask(237);
		ShowGetItemPageForItems(list, afterString, argBox);
	}

	public static void GetTaoismBook(string afterString, EventArgBox argBox)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		List<(ItemKey, int)> list = new List<(ItemKey, int)>();
		for (sbyte b = 0; b <= 2; b++)
		{
			short lifeSkillId = GetLifeSkillId(12, b);
			ItemKey itemKey = CreateSkillBook(lifeSkillId, 5, -1, -1, 50);
			AddInventoryItem(taiwu, itemKey);
			list.Add((itemKey, 1));
		}
		ShowGetItemPageForItems(list, afterString, argBox);
	}

	public static void GetBookFromSloppyTaoistMonkLetter(string afterString, EventArgBox argBox)
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(543);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(4);
		sbyte arg = 0;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_LastEventSloppyTaoistMonkFavor", ref arg);
		sbyte favorabilityType = GetFavorabilityType(orCreateFixedCharacterByTemplateId, taiwu);
		if (favorabilityType != arg)
		{
			List<(ItemKey, int)> list = new List<(ItemKey, int)>();
			for (sbyte b = (sbyte)(arg + 3); b < favorabilityType + 3; b++)
			{
				short lifeSkillId = GetLifeSkillId(12, b);
				ItemKey itemKey = CreateSkillBook(lifeSkillId, 5, -1, -1, 50);
				AddInventoryItem(taiwu, itemKey);
				list.Add((itemKey, 1));
			}
			SaveArgToSectMainStory(4, "ConchShip_PresetKey_LastEventSloppyTaoistMonkFavor", favorabilityType);
			ShowGetItemPageForItems(list, afterString, argBox);
		}
	}

	public static void GetBookCountFromSloppyTaoistMonkLetter(EventArgBox argBox)
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(543);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(4);
		sbyte arg = 0;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_LastEventSloppyTaoistMonkFavor", ref arg);
		sbyte favorabilityType = GetFavorabilityType(orCreateFixedCharacterByTemplateId, taiwu);
		argBox.Set("BookCount", favorabilityType - arg);
	}

	public static void GetMeetImmortalAccessory(string afterString, EventArgBox argBox)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(4);
		int num = sectMainStoryEventArgBox.GetInt(SectMainStoryEventArgKeys.MeetImmortalEventCount);
		ItemKey itemKey = ItemKey.Invalid;
		ItemKey itemKey2 = ItemKey.Invalid;
		ItemKey itemKey3 = ItemKey.Invalid;
		switch (num)
		{
		case 1:
		{
			int num3 = 0;
			for (sbyte b2 = 0; b2 < 3; b2++)
			{
				switch (num3)
				{
				case 0:
					itemKey = GetRandomItemByGrade(b2, 200);
					break;
				case 1:
					itemKey2 = GetRandomItemByGrade(b2, 200);
					break;
				default:
					itemKey3 = GetRandomItemByGrade(b2, 200);
					break;
				}
				num3++;
			}
			break;
		}
		case 2:
		{
			int num4 = 0;
			for (sbyte b3 = 3; b3 < 6; b3++)
			{
				if (num4 == 0)
				{
					itemKey = GetRandomItemByGrade(b3, 200);
				}
				if (num4 == 1)
				{
					itemKey2 = GetRandomItemByGrade(b3, 200);
				}
				if (num4 == 2)
				{
					itemKey3 = GetRandomItemByGrade(b3, 200);
				}
				num4++;
			}
			break;
		}
		default:
		{
			int num2 = 0;
			for (sbyte b = 6; b <= 8; b++)
			{
				if (num2 == 0)
				{
					itemKey = GetRandomItemByGrade(b, 200);
				}
				if (num2 == 1)
				{
					itemKey2 = GetRandomItemByGrade(b, 200);
				}
				if (num2 == 2)
				{
					itemKey3 = GetRandomItemByGrade(b, 200);
				}
				num2++;
			}
			break;
		}
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		ItemKey item = AddItemToRole(taiwu, itemKey.ItemType, itemKey.TemplateId, 1, -1);
		ItemKey item2 = AddItemToRole(taiwu, itemKey2.ItemType, itemKey2.TemplateId, 1, -1);
		ItemKey item3 = AddItemToRole(taiwu, itemKey3.ItemType, itemKey3.TemplateId, 1, -1);
		ShowGetItemPageForItems(new List<(ItemKey, int)>
		{
			(item, 1),
			(item2, 1),
			(item3, 1)
		}, afterString, argBox);
	}

	public static string GetWudangTreasureDesc(ItemKey selectItemKey)
	{
		if (selectItemKey.TemplateId == 248)
		{
			return "<Language Key=Event_SectStoryWudang_TreasureDesc1/>";
		}
		if (selectItemKey.TemplateId == 249)
		{
			return "<Language Key=Event_SectStoryWudang_TreasureDesc2/>";
		}
		if (selectItemKey.TemplateId == 250)
		{
			return "<Language Key=Event_SectStoryWudang_TreasureDesc3/>";
		}
		if (selectItemKey.TemplateId == 251)
		{
			return "<Language Key=Event_SectStoryWudang_TreasureDesc4/>";
		}
		if (selectItemKey.TemplateId == 252)
		{
			return "<Language Key=Event_SectStoryWudang_TreasureDesc5/>";
		}
		if (selectItemKey.TemplateId == 253)
		{
			return "<Language Key=Event_SectStoryWudang_TreasureDesc6/>";
		}
		if (selectItemKey.TemplateId == 254)
		{
			return "<Language Key=Event_SectStoryWudang_TreasureDesc7/>";
		}
		if (selectItemKey.TemplateId == 255)
		{
			return "<Language Key=Event_SectStoryWudang_TreasureDesc8/>";
		}
		if (selectItemKey.TemplateId == 256)
		{
			return "<Language Key=Event_SectStoryWudang_TreasureDesc9/>";
		}
		return "<Language Key=Event_SectStoryWudang_TreasureDesc10/>";
	}

	public static string GetHeavenlyTreeGrowDesc(int id, int delta)
	{
		SectStoryHeavenlyTreeExtendable heavenlyTree = GetHeavenlyTree(id);
		int num = heavenlyTree.GrowPoint + delta;
		if (num < 100)
		{
			return "<Language Key=Event_SectStoryWudang_GrowDesc1/>";
		}
		if (num < 300)
		{
			return "<Language Key=Event_SectStoryWudang_GrowDesc2/>";
		}
		if (num < 600)
		{
			return "<Language Key=Event_SectStoryWudang_GrowDesc3/>";
		}
		if (num < 900)
		{
			return "<Language Key=Event_SectStoryWudang_GrowDesc4/>";
		}
		if (GetSectMainStoryTaskStatus(4) == 0 && !ItemTemplateHelper.CheckIsHeavenlyNormalTreeSeeds(12, heavenlyTree.TemplateId))
		{
			return "<Language Key=Event_SectStoryWudang_GrowDesc5/>";
		}
		return "<Language Key=Event_SectStoryWudang_GrowDesc11/>";
	}

	public static string GetHeavenlyTreeGrowDesc2(int id, int delta)
	{
		SectStoryHeavenlyTreeExtendable heavenlyTree = GetHeavenlyTree(id);
		int num = heavenlyTree.GrowPoint + delta;
		if (num < 100)
		{
			return "<Language Key=Event_SectStoryWudang_GrowDesc6/>";
		}
		if (num < 300)
		{
			return "<Language Key=Event_SectStoryWudang_GrowDesc7/>";
		}
		if (num < 600)
		{
			return "<Language Key=Event_SectStoryWudang_GrowDesc8/>";
		}
		if (num < 900)
		{
			return "<Language Key=Event_SectStoryWudang_GrowDesc9/>";
		}
		if (GetSectMainStoryTaskStatus(4) == 0 && !ItemTemplateHelper.CheckIsHeavenlyNormalTreeSeeds(12, heavenlyTree.TemplateId))
		{
			return "<Language Key=Event_SectStoryWudang_GrowDesc10/>";
		}
		return "<Language Key=Event_SectStoryWudang_GrowDesc11/>";
	}

	public static int GetAllHeavenlyTreeRelatedCount()
	{
		int heavenlyTreeSeedCount = GetHeavenlyTreeSeedCount();
		heavenlyTreeSeedCount += GetPlantedHeavenlyTreeCount();
		heavenlyTreeSeedCount += GetWudangTreasureCount();
		return heavenlyTreeSeedCount + GetGivenTreasureCount();
	}

	public static int GetHeavenlyTreeSeedCount()
	{
		int num = 0;
		for (short num2 = 272; num2 <= 283; num2++)
		{
			num += GetTaiwuInventoryItemCount(12, num2);
		}
		return num;
	}

	public static int GetPlantedHeavenlyTreeCount()
	{
		return DomainManager.Extra.GetPlantedHeavenlyTreeCount();
	}

	public static int GetGrowingHeavenlyTreeCount()
	{
		return DomainManager.Extra.GetGrowingHeavenlyTreeCount();
	}

	public static int GetNormalSeedAndTreeCount()
	{
		return DomainManager.Extra.GetNormalSeedAndTreeCount();
	}

	public static int GetWudangTreasureCount()
	{
		int num = 0;
		for (short num2 = 248; num2 <= 257; num2++)
		{
			num += GetTaiwuInventoryItemCount(12, num2);
		}
		return num;
	}

	public static int GetGivenTreasureCount()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(4);
		int arg = 0;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_GiveTaoistTreasureCount", ref arg);
		return arg;
	}

	public static int GetFindFairylandCount()
	{
		List<SectStoryHeavenlyTreeExtendable> allHeavenlyTrees = DomainManager.Extra.GetAllHeavenlyTrees();
		int num = 0;
		foreach (SectStoryHeavenlyTreeExtendable item in allHeavenlyTrees)
		{
			if (item.FindFairyland)
			{
				num++;
			}
		}
		return num;
	}

	public static string GetMapBlockDesc(short seedTemplateId)
	{
		return seedTemplateId switch
		{
			394 => MapBlock.Instance[57].Name, 
			396 => MapBlock.Instance[63].Name, 
			398 => MapBlock.Instance[69].Name, 
			400 => MapBlock.Instance[75].Name, 
			402 => MapBlock.Instance[81].Name, 
			404 => MapBlock.Instance[87].Name, 
			401 => MapBlock.Instance[93].Name, 
			403 => MapBlock.Instance[94].Name, 
			395 => MapBlock.Instance[97].Name, 
			397 => MapBlock.Instance[100].Name, 
			399 => MapBlock.Instance[103].Name, 
			_ => MapBlock.Instance[106].Name, 
		};
	}

	public static void OpenDefendHeavenlyTree(string afterEvent, EventArgBox argBox, bool includeGrownTree = false)
	{
		Domain.SetListenerWithActionName(afterEvent, argBox, "DefendHeavenlyTree");
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenDefendHeavenlyTree, includeGrownTree);
	}

	public static void WudangIntEventArgChange(string key, int delta)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(4);
		int num = sectMainStoryEventArgBox.GetInt(key);
		SaveArgToSectMainStory(4, key, num + delta);
	}

	public static void CreateWudangFirstLingbao(string afterEvent, EventArgBox argBox)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(4);
		Location location = settlementByOrgTemplateId.GetLocation();
		DomainManager.Extra.CreateWudangLingbaoLight(mainThreadDataContext, location);
		WorldMapDoFocus(location, 3f, afterEvent, argBox);
	}

	public static void CreateWudangSecondLingbao(string afterEvent, EventArgBox argBox)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(4);
		Location location = settlementByOrgTemplateId.GetLocation();
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		DomainManager.Map.GetSettlementBlocks(location.AreaId, location.BlockId, list);
		Location location2 = Location.Invalid;
		for (int i = 0; i < list.Count; i++)
		{
			if (list[i] != location.BlockId)
			{
				location2 = new Location(location.AreaId, list[i]);
			}
		}
		DomainManager.Extra.CreateWudangLingbaoDark(mainThreadDataContext, location2);
		WorldMapDoFocus(location2, 3f, afterEvent, argBox);
		ObjectPool<List<short>>.Instance.Return(list);
	}

	public static void ClearAllWudangLingbao()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.ClearAllWudangLingbao(mainThreadDataContext);
	}

	public static void AllHeavenllyTreeSuccess()
	{
		List<SectStoryHeavenlyTreeExtendable> allHeavenlyTrees = DomainManager.Extra.GetAllHeavenlyTrees();
		for (int num = allHeavenlyTrees.Count - 1; num >= 0; num--)
		{
			BlockOverWrittenByHeavenlyTree(allHeavenlyTrees[num].Id, isSuccess: true);
		}
	}

	public static bool IsRandomEnemyBelongHeavenlyTree(EventArgBox argBox)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		if (!location.IsValid())
		{
			return false;
		}
		MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
		ByteCoordinate blockPos = blockData.GetBlockPos();
		List<SectStoryHeavenlyTreeExtendable> allHeavenlyTrees = DomainManager.Extra.GetAllHeavenlyTrees();
		for (int i = 0; i < allHeavenlyTrees.Count; i++)
		{
			Location location2 = allHeavenlyTrees[i].Location;
			if (location2.AreaId == location.AreaId)
			{
				MapBlockData blockData2 = DomainManager.Map.GetBlockData(location2.AreaId, location2.BlockId);
				if (blockData2.GetManhattanDistanceToPos(blockPos.X, blockPos.Y) <= 3)
				{
					argBox.Set("CharacterId", allHeavenlyTrees[i].Id);
					return true;
				}
			}
		}
		return false;
	}

	public static bool HaveHeavenlyTreeGrowing()
	{
		List<SectStoryHeavenlyTreeExtendable> allHeavenlyTrees = DomainManager.Extra.GetAllHeavenlyTrees();
		foreach (SectStoryHeavenlyTreeExtendable item in allHeavenlyTrees)
		{
			GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(item.Id);
			short templateId = element_Objects.GetTemplateId();
			if (templateId < 677 && templateId >= 673)
			{
				return true;
			}
		}
		return false;
	}

	public static void SloppyTaoistMonkUpgradeFavorability()
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(543);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		DirectlyUpgradeFavorability(orCreateFixedCharacterByTemplateId.GetId(), taiwu.GetId());
	}

	public static bool IsSnakeGiven(short templateId)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(4);
		sectMainStoryEventArgBox.Get<GameData.Utilities.ShortList>("ConchShip_PresetKey_GivenMonkSnakeList", out GameData.Utilities.ShortList arg);
		if (arg.Items == null || arg.Items.Count == 0)
		{
			return false;
		}
		return arg.Items.Contains(templateId);
	}

	public static void SaveGivenSnake(short templateId)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(4);
		sectMainStoryEventArgBox.Get<GameData.Utilities.ShortList>("ConchShip_PresetKey_GivenMonkSnakeList", out GameData.Utilities.ShortList arg);
		if (arg.Items == null)
		{
			arg = GameData.Utilities.ShortList.Create();
		}
		arg.Items.Add(templateId);
		SaveArgToSectMainStory(4, "ConchShip_PresetKey_GivenMonkSnakeList", arg);
	}

	public static void AddWudangReadBookToTree(short templateId)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(4);
		sectMainStoryEventArgBox.Get<GameData.Utilities.ShortList>(SectMainStoryEventArgKeys.HaveReadBookToTree, out GameData.Utilities.ShortList arg);
		if (arg.Items == null)
		{
			arg = GameData.Utilities.ShortList.Create();
		}
		arg.Items.Add(templateId);
		SaveArgToSectMainStory(4, SectMainStoryEventArgKeys.HaveReadBookToTree, arg);
	}

	public static bool IsBooKHaveReadToTree(short templateId)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(4);
		sectMainStoryEventArgBox.Get<GameData.Utilities.ShortList>(SectMainStoryEventArgKeys.HaveReadBookToTree, out GameData.Utilities.ShortList arg);
		if (arg.Items == null || arg.Items.Count == 0)
		{
			return false;
		}
		return arg.Items.Contains(templateId);
	}

	public static void ClearHeavenlyTreeSeed()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Inventory inventory = taiwu.GetInventory();
		for (short num = 272; num <= 283; num++)
		{
			ItemKey inventoryItem = GetInventoryItem(taiwu, 12, num);
			if (inventoryItem.IsValid())
			{
				taiwu.RemoveInventoryItem(Domain.MainThreadDataContext, inventoryItem, inventory.Items[inventoryItem], deleteItem: true);
			}
		}
	}

	public static void TriggerWudangHeavenlyTreeExtraTask(int taskInfoTemplateId)
	{
		if (GetSectMainStoryTaskStatus(4) == 0)
		{
			TriggerExtraTask(41, taskInfoTemplateId);
		}
	}

	public static int GetHeavenlyTreeGrewUpValueByResource(int resourceCount)
	{
		if (GetSectMainStoryTaskStatus(4) == 0)
		{
			return resourceCount / 100;
		}
		return resourceCount * 3 / 100;
	}

	public static int GetHeavenlyTreeGrewUpValueByBook()
	{
		if (GetSectMainStoryTaskStatus(4) == 0)
		{
			return 100;
		}
		return 300;
	}

	public static bool CheckHasExtraWudangMisc()
	{
		Inventory inventory = DomainManager.Taiwu.GetTaiwu().GetInventory();
		for (short num = 248; num <= 257; num++)
		{
			if (inventory.GetInventoryItemKey(12, num).IsValid())
			{
				return true;
			}
		}
		return false;
	}

	public static void RemoveExtraWudangMisc()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Inventory inventory = DomainManager.Taiwu.GetTaiwu().GetInventory();
		for (short num = 248; num <= 257; num++)
		{
			ItemKey inventoryItemKey = inventory.GetInventoryItemKey(12, num);
			if (inventoryItemKey.IsValid())
			{
				taiwu.RemoveInventoryItem(Domain.MainThreadDataContext, inventoryItemKey, inventory.Items[inventoryItemKey], deleteItem: true);
			}
		}
	}

	public static bool IsTaiwuAtWuxianSettlement(bool settlementBlockOnly = false)
	{
		short settlementIdByOrgTemplateId = DomainManager.Organization.GetSettlementIdByOrgTemplateId(12);
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		if (!location.IsValid())
		{
			return false;
		}
		return settlementBlockOnly ? DomainManager.Map.IsLocationOnSettlementBlock(location, settlementIdByOrgTemplateId) : DomainManager.Map.IsLocationInSettlementInfluenceRange(location, settlementIdByOrgTemplateId);
	}

	public static bool IsPrologueWugEventAbleToTrigger()
	{
		int wugAdded;
		return HasSectSpiritualDebtInteractionOccurred(12) && IsTaiwuAtWuxianSettlement() && (!TryGetPrologueAddedWug(out wugAdded) || wugAdded == -1) && GetTriggeredPrologueWugEventCount() != 3 && GetSectMainStoryTaskStatus(12) == 0 && GetSectMainStoryActiveStatus(12) >= 0;
	}

	public static bool IsLastPrologueWugEvent()
	{
		return 3 - GetTriggeredPrologueWugEventCount() == 1;
	}

	public static int GetTriggeredPrologueWugEventCount()
	{
		int wuxianPrologueWugEventRecord = GetWuxianPrologueWugEventRecord();
		int num = 0;
		for (int i = 0; i < 3; i++)
		{
			if (IsWugEventTriggered(wuxianPrologueWugEventRecord, i))
			{
				num++;
			}
		}
		return num;
	}

	public static int RandomPickPrologueWugEvent()
	{
		List<int> list = new List<int>();
		int wuxianPrologueWugEventRecord = GetWuxianPrologueWugEventRecord();
		for (int i = 0; i < 3; i++)
		{
			if (!IsWugEventTriggered(wuxianPrologueWugEventRecord, i))
			{
				list.Add(i);
			}
		}
		return (list.Count == 0) ? (-1) : list[Domain.MainThreadDataContext.Random.Next(list.Count)];
	}

	public static void SavePrologueWugEventData(EventArgBox argBox)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(12);
		int wuxianPrologueWugEventRecord = GetWuxianPrologueWugEventRecord();
		int arg = -1;
		int arg2 = 0;
		int num = argBox.GetInt("PrologueWugEvent");
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Prologue_WugEventRecord", wuxianPrologueWugEventRecord | (1 << num));
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Prologue_TaiwuId", DomainManager.Taiwu.GetTaiwuCharId());
		if (argBox.Get("PrologueWugAdded", ref arg))
		{
			sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Prologue_AddedWug", arg);
		}
		if (argBox.Get("PrologueFavorabilityDelta", ref arg2))
		{
			ChangeRanXinduFavorability(arg2);
		}
		SaveSectMainStoryEventArgBox(12);
	}

	public static void SavePrologueWugEventData2(EventArgBox argBox)
	{
		DomainManager.Extra.GetSectMainStoryEventArgBox(12).Set("ConchShip_PresetKey_Wuxian_Prologue_WugAttacked", arg: true);
		SaveSectMainStoryEventArgBox(12);
	}

	public static void SavePrologueWugEventData3(EventArgBox argBox)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(12);
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Prologue_AddedWug", -2);
		SaveSectMainStoryEventArgBox(12);
	}

	public static void ChangeRanXinduFavorability(int delta)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = DomainManager.Character.GetOrCreateFixedCharacterByTemplateId(Domain.MainThreadDataContext, 631);
		if (!DomainManager.Character.TryGetRelation(orCreateFixedCharacterByTemplateId.GetId(), taiwu.GetId(), out var _))
		{
			DirectlySetFavorabilities(orCreateFixedCharacterByTemplateId.GetId(), taiwu.GetId(), 10000, 10000);
		}
		DirectlyChangeFavorabilityOptionalStoryEvent(orCreateFixedCharacterByTemplateId, taiwu, delta);
	}

	public static void SetRanXinduHappiness(sbyte happinessType)
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = DomainManager.Character.GetOrCreateFixedCharacterByTemplateId(Domain.MainThreadDataContext, 631);
		orCreateFixedCharacterByTemplateId.SetHappiness(HappinessType.Ranges[happinessType].min, Domain.MainThreadDataContext);
	}

	public static void SetPreviousTaiwuName(EventArgBox argBox)
	{
		List<int> previousTaiwuIds = DomainManager.Taiwu.GetPreviousTaiwuIds();
		argBox.Set("PreviousTaiwu", previousTaiwuIds[previousTaiwuIds.Count - 1]);
	}

	public static bool TryGetPrologueAddedWug(out int wugAdded)
	{
		return DomainManager.World.TryGetPrologueAddedWug(out wugAdded);
	}

	public static bool IsPrologueWugAttackedOnce()
	{
		return DomainManager.World.IsWuxianPrologueWugAttackedOnce();
	}

	public static bool IsWuxianTaiwuChanged()
	{
		return DomainManager.World.IsWuxianTaiwuChanged();
	}

	public static sbyte GetRandomLeg(EventArgBox argBox)
	{
		sbyte b = (sbyte)(Domain.MainThreadDataContext.Random.NextBool() ? 5 : 6);
		argBox.Set("Leg", (b == 5) ? "<Language Key=LK_CombatSkill_HitParts_LeftFoot/>" : "<Language Key=LK_CombatSkill_HitParts_RightFoot/>");
		return b;
	}

	public static int GetWuxianPrologueWugEventRecord()
	{
		int arg = 0;
		return DomainManager.Extra.GetSectMainStoryEventArgBox(12).Get("ConchShip_PresetKey_Wuxian_Prologue_WugEventRecord", ref arg) ? arg : 0;
	}

	public static bool IsWugEventTriggered(int record, int wugEvent)
	{
		return (record & (1 << wugEvent)) != 0;
	}

	public static int GetWuxianChapterOneVisitCount()
	{
		int arg = 0;
		return DomainManager.Extra.GetSectMainStoryEventArgBox(12).Get("ConchShip_PresetKey_Wuxian_Chapter1_VisitCount", ref arg) ? arg : 0;
	}

	public static int GetWuxianChapterOneWish(int index)
	{
		int arg = -1;
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(12);
		if (1 == 0)
		{
		}
		string key = index switch
		{
			1 => "ConchShip_PresetKey_Wuxian_Chapter1_Wish1", 
			2 => "ConchShip_PresetKey_Wuxian_Chapter1_Wish2", 
			_ => "ConchShip_PresetKey_Wuxian_Chapter1_Wish3", 
		};
		if (1 == 0)
		{
		}
		return sectMainStoryEventArgBox.Get(key, ref arg) ? arg : (-1);
	}

	public static int GetWuxianChapterOneWishCount()
	{
		return DomainManager.World.GetWuxianChapterOneWishCount();
	}

	public static int GetWuxianChapterOneWishComeTrueCount()
	{
		return DomainManager.World.GetWuxianChapterOneWishComeTrueCount();
	}

	public static void SaveWuxianChapterOneData1(EventArgBox argBox)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(12);
		int wuxianChapterOneVisitCount = GetWuxianChapterOneVisitCount();
		int arg = 0;
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Chapter1_VisitCount", wuxianChapterOneVisitCount + 1);
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Prologue_AddedWug", -2);
		if (argBox.Get("Chapter1Wish1", ref arg))
		{
			sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Chapter1_Wish1", arg);
			sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Chapter1_WuxianChapter1WishCount", 1);
		}
		else if (argBox.Get("Chapter1Wish2", ref arg))
		{
			sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Chapter1_Wish2", arg);
			sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Chapter1_WuxianChapter1WishCount", 2);
		}
		else if (argBox.Get("Chapter1Wish3", ref arg))
		{
			sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Chapter1_Wish3", arg);
			sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Chapter1_WuxianChapter1WishCount", 3);
		}
		SetSectSpiritualDebtInteractionOccurred(12);
		SaveSectMainStoryEventArgBox(12);
	}

	public static void SaveWuxianChapterOneData2()
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(12);
		int wuxianChapterOneWishComeTrueCount = GetWuxianChapterOneWishComeTrueCount();
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Chapter1_WishComeTrueCount", wuxianChapterOneWishComeTrueCount + 1);
		SaveSectMainStoryEventArgBox(12);
	}

	public static void SaveWuxianChapterOneData3(EventArgBox argBox)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(12);
		bool arg = false;
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Chapter1_Refused", argBox.Get("Chapter1Refused", ref arg));
		SaveSectMainStoryEventArgBox(12);
	}

	public static bool IsAbleToTriggerWuxianChapterOneTrigger1(int charId)
	{
		return DomainManager.Taiwu.GetTaiwuCharId() == charId && (IsExtraTaskInProgress(277) || IsExtraTaskInProgress(193));
	}

	public static bool IsAbleToTriggerWuxianChapterOneTrigger3()
	{
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		return IsExtraTaskInProgress(292) && DomainManager.Map.IsLocationInOrganizationInfluenceRange(location, 12);
	}

	public static bool IsAbleToTriggerWuxianChapterOneTrigger4()
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(12);
		Location arg;
		return IsExtraTaskInProgress(195) && sectMainStoryEventArgBox.Get<Location>("ConchShip_PresetKey_Wuxian_Chapter1_RanXinduLocation", out arg) && DomainManager.Taiwu.GetTaiwu().GetLocation().Equals(arg);
	}

	public static void MoveRanXindu()
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(631);
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		List<MapBlockData> list = new List<MapBlockData>();
		DomainManager.Map.GetNeighborBlocks(location.AreaId, location.BlockId, list);
		MapBlockData mapBlockData = list[Domain.MainThreadDataContext.Random.Next(list.Count)];
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(12);
		Location location2 = new Location(mapBlockData.AreaId, mapBlockData.BlockId);
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Chapter1_RanXinduLocation", (ISerializableGameData)(object)location2);
		MoveFixedCharacter(orCreateFixedCharacterByTemplateId, location2);
		SaveSectMainStoryEventArgBox(12);
	}

	public static void HideRanXindu()
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(631);
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(12);
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Chapter1_RanXinduLocation", (ISerializableGameData)(object)Location.Invalid);
		MoveFixedCharacter(orCreateFixedCharacterByTemplateId, Location.Invalid);
		SaveSectMainStoryEventArgBox(12);
	}

	public static bool IsTaiwuMedicineOrToxicologyAttainmentEnough()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		return GetRoleLifeSkillAttainmentByType(taiwu, 9) >= 200 || GetRoleLifeSkillAttainmentByType(taiwu, 8) >= 200;
	}

	public static bool IsRanXinduGetRefused()
	{
		bool arg = false;
		return DomainManager.Extra.GetSectMainStoryEventArgBox(12).Get("ConchShip_PresetKey_Wuxian_Chapter1_Refused", ref arg) && arg;
	}

	public static void WuxianChapterOneWishComeTrueHappy()
	{
		List<int> wuxianSettlementMembers = GetWuxianSettlementMembers();
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		int currDate = DomainManager.World.GetCurrDate();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		foreach (int item in wuxianSettlementMembers)
		{
			if (DomainManager.Character.TryGetElement_Objects(item, out var element))
			{
				element.ChangeHappiness(mainThreadDataContext, -10);
				lifeRecordCollection.AddWuxianDecreasedMood(item, currDate);
			}
		}
	}

	public static void WuxianChapterOneWishComeTrueCharmed()
	{
		List<int> wuxianSettlementMembers = GetWuxianSettlementMembers();
		HashSet<int> hashSet = new HashSet<int>();
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int currDate = DomainManager.World.GetCurrDate();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		foreach (int item in wuxianSettlementMembers)
		{
			if (!DomainManager.Character.TryGetElement_Objects(item, out var element))
			{
				continue;
			}
			RelatedCharacters relatedCharacters = DomainManager.Character.GetRelatedCharacters(item);
			if (relatedCharacters == null)
			{
				continue;
			}
			hashSet.Clear();
			relatedCharacters.GetAllRelatedCharIds(hashSet);
			foreach (int item2 in hashSet)
			{
				if (item2 != taiwuCharId && DomainManager.Character.TryGetElement_Objects(item2, out var element2) && element.GetCreatingType() == 1 && element2.GetCreatingType() == 1)
				{
					DomainManager.Character.ChangeFavorabilityOptional(mainThreadDataContext, element, element2, -1200, 4);
				}
			}
			lifeRecordCollection.AddWuxianDecreasedFavorability(item, currDate);
		}
	}

	public static void WuxianChapterOneWishComeTruePowerful()
	{
		List<int> wuxianSettlementMembers = GetWuxianSettlementMembers();
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		int currDate = DomainManager.World.GetCurrDate();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		foreach (int item in wuxianSettlementMembers)
		{
			if (DomainManager.Character.TryGetElement_Objects(item, out var element))
			{
				element.ChangeCurrNeiliWithoutChecking(mainThreadDataContext, -600);
				lifeRecordCollection.AddWuxianQiDecline(item, currDate);
			}
		}
	}

	public static void WuxianChapterOneWishComeTrueHealthy()
	{
		List<int> wuxianSettlementMembers = GetWuxianSettlementMembers();
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		int currDate = DomainManager.World.GetCurrDate();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		foreach (int item in wuxianSettlementMembers)
		{
			if (DomainManager.Character.TryGetElement_Objects(item, out var element))
			{
				element.ChangePoisoned(mainThreadDataContext, (sbyte)mainThreadDataContext.Random.Next(6), 0, 1200);
				lifeRecordCollection.AddWuxianPoisoning(item, currDate, element.GetLocation());
			}
		}
	}

	public static void WuxianChapterOneWishComeTrueRich()
	{
		List<int> wuxianSettlementMembers = GetWuxianSettlementMembers();
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		List<MapBlockData> list = new List<MapBlockData>();
		int currDate = DomainManager.World.GetCurrDate();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		foreach (int item in wuxianSettlementMembers)
		{
			if (!DomainManager.Character.TryGetElement_Objects(item, out var element))
			{
				continue;
			}
			Location location = element.GetLocation();
			if (location.Equals(Location.Invalid))
			{
				continue;
			}
			DomainManager.Map.GetNeighborBlocks(location.AreaId, location.BlockId, list);
			if (list.Count == 0)
			{
				continue;
			}
			for (int i = 0; i < 3; i++)
			{
				Inventory inventory = element.GetInventory();
				if (inventory.Items.Count == 0)
				{
					continue;
				}
				sbyte b = 8;
				ItemKey itemKey = ItemKey.Invalid;
				foreach (KeyValuePair<ItemKey, int> item2 in inventory.Items)
				{
					item2.Deconstruct(out var key, out var value);
					ItemKey itemKey2 = key;
					int num = value;
					sbyte grade = ItemTemplateHelper.GetGrade(itemKey2.ItemType, itemKey2.TemplateId);
					if (grade == b && mainThreadDataContext.Random.NextBool())
					{
						itemKey = itemKey2;
					}
					else if (grade < b)
					{
						b = grade;
						itemKey = itemKey2;
					}
				}
				if (!itemKey.Equals(ItemKey.Invalid))
				{
					element.RemoveInventoryItem(mainThreadDataContext, itemKey, 1, deleteItem: false);
					DomainManager.Map.AddBlockItem(mainThreadDataContext, list[mainThreadDataContext.Random.Next(list.Count)], itemKey, 1);
				}
			}
			lifeRecordCollection.AddWuxianLoseItem(item, currDate, location);
		}
	}

	public static List<int> GetWuxianSettlementMembers()
	{
		List<int> list = new List<int>();
		DomainManager.Organization.GetSettlementByOrgTemplateId(12).GetMembers().GetAllMembers(list);
		return list;
	}

	public static bool IsAbleToTriggerWuxianChapterTwoBaihua()
	{
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(3);
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		return IsExtraTaskInProgress(194) && IsSectAllowLearning(3) && DomainManager.Map.IsLocationOnSettlementBlock(location, settlementByOrgTemplateId.GetId());
	}

	public static bool IsAbleToTriggerWuxianChapterTwoBaihuaConsultation(EventArgBox argBox)
	{
		int arg = -1;
		int result;
		if (IsExtraTaskInProgress(281) && argBox.Get("CharacterId", ref arg) && DomainManager.Character.TryGetElement_Objects(arg, out var element))
		{
			OrganizationInfo organizationInfo = element.GetOrganizationInfo();
			result = ((organizationInfo.OrgTemplateId == 3 && organizationInfo.Grade >= 6) ? 1 : 0);
		}
		else
		{
			result = 0;
		}
		return (byte)result != 0;
	}

	public static bool IsAbleToTriggerWuxianChapterTwoKongSang()
	{
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(10);
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		return IsExtraTaskInProgress(196) && IsSectAllowLearning(10) && DomainManager.Map.IsLocationOnSettlementBlock(location, settlementByOrgTemplateId.GetId());
	}

	public static bool IsAbleToTriggerWuxianChapterTwoKongSangConsultation(EventArgBox argBox)
	{
		int arg = -1;
		int result;
		if (IsExtraTaskInProgress(283) && argBox.Get("CharacterId", ref arg) && DomainManager.Character.TryGetElement_Objects(arg, out var element))
		{
			OrganizationInfo organizationInfo = element.GetOrganizationInfo();
			result = ((organizationInfo.OrgTemplateId == 10 && organizationInfo.Grade >= 6) ? 1 : 0);
		}
		else
		{
			result = 0;
		}
		return (byte)result != 0;
	}

	public static void SaveWuxianChapterTwoData1(EventArgBox argBox)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(12);
		int arg = 0;
		if (argBox.Get("Chapter2Selection1", ref arg))
		{
			sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Chapter2_Adventure1Selection", arg);
		}
		else if (argBox.Get("Chapter2Selection2", ref arg))
		{
			sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Chapter2_Adventure2Selection", arg);
		}
		SaveSectMainStoryEventArgBox(12);
	}

	public static int GetWuxianChapterTwoSelection(int index)
	{
		int arg = -1;
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(12);
		if (1 == 0)
		{
		}
		string key = ((index != 1) ? "ConchShip_PresetKey_Wuxian_Chapter2_Adventure2Selection" : "ConchShip_PresetKey_Wuxian_Chapter2_Adventure1Selection");
		if (1 == 0)
		{
		}
		return sectMainStoryEventArgBox.Get(key, ref arg) ? arg : (-1);
	}

	public static void SetWuxianChapterTwoSectLeaderArgBox(EventArgBox argBox, bool isBaihua)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		sbyte orgTemplateId = (sbyte)(isBaihua ? 3 : 10);
		short templateId = (short)(isBaihua ? 332 : 388);
		GameData.Domains.Character.Character character = TryGetSectLeaderAtLocation(taiwu.GetLocation(), orgTemplateId, includeAllBlocksInGroup: true);
		if (character != null)
		{
			OrganizationMemberItem orgMemberConfig = OrganizationDomain.GetOrgMemberConfig(character.GetOrganizationInfo());
			argBox.Set("SectLeader", character.GetId());
			argBox.Set("SectLeaderName", "<color=#GradeColor_8>" + orgMemberConfig.GradeName + "</color>");
		}
		else
		{
			int arg = CreateNonIntelligentCharacter(templateId);
			argBox.Set("SectLeader", arg);
			argBox.Set("SectLeaderName", "<color=#GradeColor_8><Language Key=Event_SectStoryShixiang_Qianbei/></color>");
		}
	}

	public static void CreateWuxianChapterTowAdventure(bool isBaihua)
	{
		Location location = DomainManager.Organization.GetSettlementByOrgTemplateId((sbyte)(isBaihua ? 3 : 10)).GetLocation();
		short adventureTemplateId = (short)(isBaihua ? 183 : 180);
		List<MapBlockData> list = new List<MapBlockData>();
		DomainManager.Map.GetSettlementAffiliatedBlocks(location.AreaId, location.BlockId, list);
		foreach (MapBlockData item in list)
		{
			if (TryCreateAdventureSite(item.AreaId, item.BlockId, adventureTemplateId, setBlockVisible: true))
			{
				break;
			}
		}
	}

	public static void SaveWuxianChapterThreeData1(EventArgBox argBox)
	{
		DomainManager.Extra.GetSectMainStoryEventArgBox(12).Set("ConchShip_PresetKey_Wuxian_Chapter3_AbleToStart", arg: true);
		SaveSectMainStoryEventArgBox(12);
	}

	public static void SaveWuxianChapterThreeData2(EventArgBox argBox)
	{
		int wuxianChapterThreeMailReceivedCount = GetWuxianChapterThreeMailReceivedCount();
		DomainManager.Extra.GetSectMainStoryEventArgBox(12).Set("ConchShip_PresetKey_Wuxian_Chapter3_MailReceivedCount", wuxianChapterThreeMailReceivedCount + 1);
		SaveSectMainStoryEventArgBox(12);
	}

	public static int GetWuxianChapterThreeMailReceivedCount()
	{
		int arg = 0;
		return DomainManager.Extra.GetSectMainStoryEventArgBox(12).Get("ConchShip_PresetKey_Wuxian_Chapter3_MailReceivedCount", ref arg) ? arg : 0;
	}

	public static void TriggerWuxianStoryAdventureAction()
	{
		DomainManager.TaiwuEvent.AddTempDynamicAction(Domain.MainThreadDataContext, new WuxianStoryAdventureTriggerAction());
	}

	public static bool IsWuxianFinalBossBeaten()
	{
		return DomainManager.World.IsWuxianFinalBossBeaten();
	}

	public static bool IsWuxianStoryAdventureComplete()
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(12);
		bool arg = false;
		return sectMainStoryEventArgBox.Get("ConchShip_PresetKey_Wuxian_Chapter4_AdventureComplete", ref arg) && arg;
	}

	public static bool IsAbleToTriggerWuxianChapterFourFinal()
	{
		return IsTaiwuAtWuxianSettlement(settlementBlockOnly: true) && IsWuxianFinalBossBeaten() && DomainManager.World.GetCurrDate() >= GetWuxianHappyEndingEventDate() && DomainManager.Extra.GetExtraTaskChainCurrentTask(36) >= 0;
	}

	public static int GetWuxianHappyEndingEventDate()
	{
		return DomainManager.World.GetWuxianHappyEndingEventDate();
	}

	public static void SaveChapterFourFinalAdventureData(bool isFinalBossBeaten)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(12);
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Chapter4_AdventureComplete", arg: true);
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Wuxian_Chapter4_FinalBossBeaten", isFinalBossBeaten);
		SaveSectMainStoryEventArgBox(12);
	}

	public static void RanXinduHealCharacter(int charId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		if (GameData.Domains.Character.Character.IsCharacterIdValid(charId) && DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			PoisonInts poisoned = default(PoisonInts);
			element.SetInjuries(default(Injuries), mainThreadDataContext);
			element.SetPoisoned(ref poisoned, mainThreadDataContext);
		}
	}

	public static void WuxianEndingFailing0()
	{
		DomainManager.World.WuxianEndingFailing0(Domain.MainThreadDataContext);
	}

	public static void WuxianEndingFailing1()
	{
		DomainManager.World.WuxianEndingFailing1(Domain.MainThreadDataContext, isComplete: true);
	}

	public static void WuxianEndingProsperous()
	{
		DomainManager.World.WuxianEndingProsperous(Domain.MainThreadDataContext);
	}

	[Obsolete]
	public static void WuxianEndingEvent(bool goodEnd, int informationIndex, string afterEvent = "", EventArgBox argBox = null)
	{
		SectMainStoryEnd(12, goodEnd, informationIndex, afterEvent, argBox);
	}

	public static bool IsWuxianPassLegacyEventTriggered()
	{
		bool arg = false;
		return DomainManager.Extra.GetSectMainStoryEventArgBox(12).Get("ConchShip_PresetKey_Wuxian_PassLegacyEventTriggered", ref arg) && arg;
	}

	public static bool IsWuxianEndingEventTriggered()
	{
		return DomainManager.World.IsWuxianEndingEventTriggered();
	}

	public static void SetWuxianPassLegacyEventTriggered()
	{
		DomainManager.Extra.GetSectMainStoryEventArgBox(12).Set("ConchShip_PresetKey_Wuxian_PassLegacyEventTriggered", arg: true);
		SaveSectMainStoryEventArgBox(12);
	}

	public static void SetWuxianEndingEventTriggered()
	{
		DomainManager.Extra.GetSectMainStoryEventArgBox(12).Set("ConchShip_PresetKey_Wuxian_Chapter4_EndingEventTriggered", arg: true);
		SaveSectMainStoryEventArgBox(12);
	}

	public static int GetWuxianWugJugPoisonSum()
	{
		return DomainManager.Extra.GetSectWuxianWugJugPoisons().Poisons.Sum();
	}

	public static void AddDisplayEventWugFairy()
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.WuxianWugFairy);
	}

	public static string GetRanXinduText(sbyte type, EventArgBox argBox, bool usePrevious = false)
	{
		string arg = "";
		if (usePrevious)
		{
			argBox.Get("WuxianRanXinduText", ref arg);
			return "<Language Key=" + arg + "/>";
		}
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		if (type == 1)
		{
			if (mainThreadDataContext.Random.NextBool())
			{
				Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
				sbyte b;
				for (b = 1; b <= 15; b++)
				{
					if (GetStateIdByAreaId(DomainManager.Organization.GetSettlementByOrgTemplateId(b).GetLocation().AreaId) == GetStateIdByAreaId(location.AreaId))
					{
						arg = SectMainStoryRelatedConstants.RanXinduFairyTexts[0][b - 1];
						break;
					}
				}
				if (b > 15)
				{
					arg = SectMainStoryRelatedConstants.RanXinduFairyTexts[1][mainThreadDataContext.Random.Next(SectMainStoryRelatedConstants.RanXinduFairyTexts[1].Length)];
				}
			}
			else
			{
				arg = SectMainStoryRelatedConstants.RanXinduFairyTexts[1][mainThreadDataContext.Random.Next(SectMainStoryRelatedConstants.RanXinduFairyTexts[1].Length)];
			}
		}
		else
		{
			arg = SectMainStoryRelatedConstants.RanXinduFairyTexts[type][mainThreadDataContext.Random.Next(SectMainStoryRelatedConstants.RanXinduFairyTexts[type].Length)];
		}
		argBox.Set("WuxianRanXinduText", arg);
		return "<Language Key=" + arg + "/>";
	}

	public static List<(ItemKey, int)> GetPoisonItemsFromRanXindu(bool isHot)
	{
		List<(ItemKey, int)> list = new List<(ItemKey, int)>();
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		for (int i = 0; i < 7; i++)
		{
			int num3;
			if (isHot)
			{
				int num = Domain.MainThreadDataContext.Random.Next(3);
				if (1 == 0)
				{
				}
				int num2 = num switch
				{
					0 => 236 + i, 
					1 => 257 + i, 
					_ => 264 + i, 
				};
				if (1 == 0)
				{
				}
				num3 = num2;
			}
			else
			{
				int num4 = Domain.MainThreadDataContext.Random.Next(3);
				if (1 == 0)
				{
				}
				int num2 = num4 switch
				{
					0 => 250 + i, 
					1 => 243 + i, 
					_ => 271 + i, 
				};
				if (1 == 0)
				{
				}
				num3 = num2;
			}
			int num5 = num3;
			ItemKey item = AddItemToRole(taiwu, 5, (short)num5, SectMainStoryRelatedConstants.PoisonItemsFromRanXinduCount[i], -1);
			list.Add((item, SectMainStoryRelatedConstants.PoisonItemsFromRanXinduCount[i]));
		}
		return list;
	}

	public static ItemKey XuannvCreateRandomJadeItemWithGradeToTaiwu(sbyte gradeMin, sbyte gradeMax, int amount = 1)
	{
		short num = 28;
		short num2 = 35;
		List<short> list = new List<short>();
		while (gradeMin <= gradeMax)
		{
			list.Add((short)(num + gradeMin));
			list.Add((short)(num2 + gradeMin));
			gradeMin++;
		}
		CollectionUtils.Shuffle(Domain.MainThreadDataContext.Random, list);
		short random = list.GetRandom(Domain.MainThreadDataContext.Random);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		return AddItemToRole(taiwu, 5, random, amount, -1);
	}

	public static void XuannvDoctorHealTaiwuInjury()
	{
		ClearCharInjury(DomainManager.Taiwu.GetTaiwuCharId());
	}

	public static void XuannvDoctorHealTaiwuPoison()
	{
		ClearCharPoison(DomainManager.Taiwu.GetTaiwuCharId());
	}

	public static void XuannvDoctorHealTaiwuDisorderOfQi()
	{
		DomainManager.Taiwu.GetTaiwu().SetDisorderOfQi(0, Domain.MainThreadDataContext);
	}

	public unsafe static sbyte XuannvGetTaiwuMaxPoisonType()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		PoisonInts poisoned = taiwu.GetPoisoned();
		int num = 0;
		sbyte result = -1;
		for (sbyte b = 0; b < 6; b++)
		{
			if (poisoned.Items[b] > num)
			{
				result = b;
				num = poisoned.Items[b];
			}
		}
		return result;
	}

	public static bool XuannvHasTaiwuLearnedAllXuannvCombatSkills()
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(taiwuCharId);
		IReadOnlyList<IReadOnlyList<CombatSkillItem>> learnableCombatSkills = CombatSkillDomain.GetLearnableCombatSkills(8);
		foreach (IReadOnlyList<CombatSkillItem> item in learnableCombatSkills)
		{
			foreach (CombatSkillItem item2 in item)
			{
				if (!charCombatSkills.ContainsKey(item2.TemplateId))
				{
					return false;
				}
			}
		}
		return true;
	}

	public static List<(ItemKey, int)> XuannvLearnCombatSkill(bool isRevers)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(8);
		sbyte arg = -1;
		Tester.Assert(sectMainStoryEventArgBox.Get("ConchShip_PresetKey_XuannvPartTwo_SelectedCombatSkillType", ref arg));
		int num = sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_Xuannv_PartThreeSearchLoverCountKey");
		HashSet<sbyte>[] array = new HashSet<sbyte>[3]
		{
			new HashSet<sbyte> { 0, 1, 2 },
			new HashSet<sbyte> { 3, 4, 5 },
			new HashSet<sbyte> { 6, 7, 8 }
		};
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		List<short> learnedCombatSkills = taiwu.GetLearnedCombatSkills();
		IReadOnlyList<CombatSkillItem> learnableCombatSkills = CombatSkillDomain.GetLearnableCombatSkills(8, arg);
		List<(ItemKey, int)> list = new List<(ItemKey, int)>();
		string[] array2 = new string[3] { "ConchShip_PresetKey_XuannvPartThree_LearningSkillId_0", "ConchShip_PresetKey_XuannvPartThree_LearningSkillId_1", "ConchShip_PresetKey_XuannvPartThree_LearningSkillId_2" };
		int index = 0;
		foreach (CombatSkillItem item in learnableCombatSkills)
		{
			if (array[num].Contains(item.Grade))
			{
				short templateId = item.TemplateId;
				if ((!learnedCombatSkills.Contains(templateId) || !XuannvTaiwuCanLearnCombatSkill(templateId)) && array2.CheckIndex(index))
				{
					sectMainStoryEventArgBox.Set(array2[index++], templateId);
				}
				short bookId = Config.CombatSkill.Instance[templateId].BookId;
				ItemKey itemKey = DomainManager.Item.CreateSkillBook(mainThreadDataContext, bookId, 5, -1, -1, (sbyte)((!isRevers) ? 100 : 0));
				DomainManager.Taiwu.GetTaiwu().AddInventoryItem(mainThreadDataContext, itemKey, 1);
				list.Add((itemKey, 1));
				if (!learnedCombatSkills.Contains(templateId))
				{
					LearnCombatSkill(taiwuCharId, templateId);
				}
			}
		}
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_XuannvPartThree_LearningSkill", arg: true);
		SaveSectMainStoryEventArgBox(8);
		return list;
	}

	public static List<(ItemKey, int)> XuannvAddSkillBookOnly(bool isRevers)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(8);
		sbyte arg = -1;
		if (!sectMainStoryEventArgBox.Get("ConchShip_PresetKey_XuannvPartTwo_SelectedCombatSkillType", ref arg))
		{
			arg = 0;
		}
		int num = sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_Xuannv_PartThreeSearchLoverCountKey");
		HashSet<sbyte>[] array = new HashSet<sbyte>[3]
		{
			new HashSet<sbyte> { 0, 1, 2 },
			new HashSet<sbyte> { 3, 4, 5 },
			new HashSet<sbyte> { 6, 7, 8 }
		};
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		IReadOnlyList<CombatSkillItem> learnableCombatSkills = CombatSkillDomain.GetLearnableCombatSkills(8, arg);
		List<(ItemKey, int)> list = new List<(ItemKey, int)>();
		foreach (CombatSkillItem item in learnableCombatSkills)
		{
			if (array[num].Contains(item.Grade))
			{
				short templateId = item.TemplateId;
				short bookId = Config.CombatSkill.Instance[templateId].BookId;
				ItemKey itemKey = DomainManager.Item.CreateSkillBook(mainThreadDataContext, bookId, 5, -1, -1, (sbyte)((!isRevers) ? 100 : 0));
				DomainManager.Taiwu.GetTaiwu().AddInventoryItem(mainThreadDataContext, itemKey, 1);
				list.Add((itemKey, 1));
			}
		}
		SaveSectMainStoryEventArgBox(8);
		return list;
	}

	public static bool XuannvCombatSkillPracticeCanFightJuner()
	{
		if (XuannvHasTaiwuLearnedAllXuannvCombatSkills())
		{
			return true;
		}
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(8);
		sbyte arg = -1;
		Tester.Assert(sectMainStoryEventArgBox.Get("ConchShip_PresetKey_XuannvPartTwo_SelectedCombatSkillType", ref arg));
		int num = sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_Xuannv_PartThreeSearchLoverCountKey");
		(sbyte min, sbyte max) groupGradeRange = Grade.GetGroupGradeRange((sbyte)num);
		sbyte item = groupGradeRange.min;
		sbyte item2 = groupGradeRange.max;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		List<short> learnedCombatSkills = taiwu.GetLearnedCombatSkills();
		IReadOnlyList<CombatSkillItem> learnableCombatSkills = CombatSkillDomain.GetLearnableCombatSkills(8, arg);
		foreach (CombatSkillItem item3 in learnableCombatSkills)
		{
			if (item3.Grade <= item2 && item3.Grade >= item)
			{
				short templateId = item3.TemplateId;
				if (!learnedCombatSkills.Contains(templateId))
				{
					return false;
				}
				if (!XuannvTaiwuCanLearnCombatSkill(templateId))
				{
					return false;
				}
			}
		}
		return true;
	}

	public static void XuannvInitJunerLoverReincarnateLocations()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(8);
		if (sectMainStoryEventArgBox.Contains<short>("ConchShip_PresetKey_Xuannv_PartThree_LoverReincarnateLocation1"))
		{
			return;
		}
		IRandomSource random = Domain.MainThreadDataContext.Random;
		Span<short> span = stackalloc short[4] { 47, 49, 84, 83 };
		CollectionUtils.Shuffle(random, span, 4);
		List<SettlementInfo> list = new List<SettlementInfo>();
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(16);
		Span<short> span2 = span;
		for (int i = 0; i < span2.Length; i++)
		{
			short areaTemplateId = span2[i];
			short areaIdByAreaTemplateId = DomainManager.Map.GetAreaIdByAreaTemplateId(areaTemplateId);
			if (DomainManager.Map.IsAreaBroken(areaIdByAreaTemplateId))
			{
				continue;
			}
			MapAreaData element_Areas = DomainManager.Map.GetElement_Areas(areaIdByAreaTemplateId);
			for (int j = 0; j < 3; j++)
			{
				SettlementInfo item = element_Areas.SettlementInfos[j];
				if (item.SettlementId != settlementByOrgTemplateId.GetId() && item.SettlementId >= 0)
				{
					list.Add(item);
				}
			}
			break;
		}
		if (list.Count < 3)
		{
			Location location = DomainManager.Organization.GetSettlementByOrgTemplateId(8).GetLocation();
			sbyte stateTemplateId = (sbyte)(random.NextBool() ? 8 : 3);
			sbyte stateIdByStateTemplateId = DomainManager.Map.GetStateIdByStateTemplateId(stateTemplateId);
			List<short> list2 = ObjectPool<List<short>>.Instance.Get();
			DomainManager.Map.GetAllRegularAreaInState(stateIdByStateTemplateId, list2);
			list2.Remove(location.AreaId);
			while (list.Count < 3)
			{
				short random2 = list2.GetRandom(random);
				list2.Remove(random2);
				MapAreaData element_Areas2 = DomainManager.Map.GetElement_Areas(random2);
				for (int k = 0; k < 3; k++)
				{
					SettlementInfo item2 = element_Areas2.SettlementInfos[k];
					if (item2.SettlementId != settlementByOrgTemplateId.GetId() && item2.SettlementId >= 0)
					{
						list.Add(item2);
					}
				}
				if (list2.Count <= 0)
				{
					break;
				}
			}
			ObjectPool<List<short>>.Instance.Return(list2);
		}
		list.RemoveAll(delegate(SettlementInfo e)
		{
			sbyte orgTemplateId = e.OrgTemplateId;
			return orgTemplateId >= 1 && orgTemplateId <= 15;
		});
		CollectionUtils.Shuffle(Domain.MainThreadDataContext.Random, list);
		SettlementInfo randomResult = list.GetRandom(Domain.MainThreadDataContext.Random);
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Xuannv_PartThree_LoverReincarnateLocation1", randomResult.SettlementId);
		if (list.Count > 1)
		{
			list.RemoveAll((SettlementInfo e) => e.SettlementId == randomResult.SettlementId);
		}
		randomResult = list.GetRandom(Domain.MainThreadDataContext.Random);
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Xuannv_PartThree_LoverReincarnateLocation2", randomResult.SettlementId);
		if (list.Count > 1)
		{
			list.RemoveAll((SettlementInfo e) => e.SettlementId == randomResult.SettlementId);
		}
		randomResult = list.GetRandom(Domain.MainThreadDataContext.Random);
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_Xuannv_PartThree_LoverReincarnateLocation3", randomResult.SettlementId);
		SaveSectMainStoryEventArgBox(8);
	}

	public static void XuannvCreateSearchLoverAdventure()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(8);
		int num = sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_Xuannv_PartThreeSearchLoverCountKey");
		if (1 == 0)
		{
		}
		short num2 = num switch
		{
			0 => 174, 
			1 => 172, 
			2 => 173, 
			_ => -1, 
		};
		if (1 == 0)
		{
		}
		short num3 = num2;
		if (num3 < 0)
		{
			return;
		}
		short settlementIdByOrgTemplateId = GetSettlementIdByOrgTemplateId(8);
		Settlement xuannvSettlement = DomainManager.Organization.GetSettlement(settlementIdByOrgTemplateId);
		List<short> settlementLocationsByOrgTemplateId = GetSettlementLocationsByOrgTemplateId(8);
		List<Location> list = settlementLocationsByOrgTemplateId.ConvertAll((short e) => new Location(xuannvSettlement.GetLocation().AreaId, e));
		int num4 = 0;
		for (int count = list.Count; num4 < count; num4++)
		{
			if (!CheckBlockHasAdventure(list[num4]))
			{
				TryCreateAdventureSite(list[num4].AreaId, list[num4].BlockId, num3, setBlockVisible: true);
				break;
			}
		}
		sectMainStoryEventArgBox.Remove<int>("ConchShip_PresetKey_XuannvStory_PartThree_LastDateOfAdventureIllusionOfMirror");
		SaveSectMainStoryEventArgBox(8);
	}

	public static bool XuannvInquireSecretGuestOptionOne(EventArgBox argBox)
	{
		if (!IsExtraTaskInProgress(141))
		{
			return false;
		}
		int charId = argBox.GetInt("CharacterId");
		if (IsInAnySect(charId) || CharacterIsInTaiwuGroup(charId))
		{
			return false;
		}
		short areaIdByAreaTemplateId = GetAreaIdByAreaTemplateId(23);
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		if (character.GetLocation().AreaId != areaIdByAreaTemplateId)
		{
			return false;
		}
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(8);
		int id = character.GetId();
		if (sectMainStoryEventArgBox.Contains<int>("ConchShip_PresetKey_Xuannv_NoneSectNpcInquireSecretGuest1") && sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_Xuannv_NoneSectNpcInquireSecretGuest1") == id)
		{
			return false;
		}
		if (sectMainStoryEventArgBox.Contains<int>("ConchShip_PresetKey_Xuannv_NoneSectNpcInquireSecretGuest2") && sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_Xuannv_NoneSectNpcInquireSecretGuest2") == id)
		{
			return false;
		}
		if (sectMainStoryEventArgBox.Contains<int>("ConchShip_PresetKey_Xuannv_NoneSectNpcInquireSecretGuest3") && sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_Xuannv_NoneSectNpcInquireSecretGuest3") == id)
		{
			return false;
		}
		return true;
	}

	public static bool XuannvInquireSecretGuestOptionTwo(EventArgBox argBox)
	{
		if (!IsExtraTaskInProgress(143))
		{
			return false;
		}
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		if (CharacterIsInTaiwuGroup(character.GetId()))
		{
			return false;
		}
		if (!IsInTargetOrganization(character, 8))
		{
			return false;
		}
		short areaIdByAreaTemplateId = GetAreaIdByAreaTemplateId(23);
		if (character.GetLocation().AreaId != areaIdByAreaTemplateId)
		{
			return false;
		}
		return true;
	}

	public static int XuannvCreateHeYouyuan()
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(553);
		if (orCreateFixedCharacterByTemplateId == null)
		{
			throw new Exception("failed when creating character:ReincarnationWoman");
		}
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		ConvertFixedCharacter(orCreateFixedCharacterByTemplateId, location, recreateAttributesAndQualifications: true);
		int id = orCreateFixedCharacterByTemplateId.GetId();
		XuannvMakeSureTargetCharacterNotWhiteHair(orCreateFixedCharacterByTemplateId);
		AvatarData avatar = orCreateFixedCharacterByTemplateId.GetAvatar();
		List<byte> allKeys = AvatarSkinColors.Instance.GetAllKeys();
		byte item = 0;
		allKeys.Remove(item);
		avatar.ColorSkinId = allKeys.GetRandom(Domain.MainThreadDataContext.Random);
		orCreateFixedCharacterByTemplateId.SetAvatar(avatar, Domain.MainThreadDataContext);
		SaveArgToSectMainStory(8, "ConchShip_PresetKey_XuannvStory_HeYouyuan_CharId", id);
		return id;
	}

	public static int XuannvCreateReliveCharacter()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(8);
		sbyte gender = sectMainStoryEventArgBox.GetSbyte("ConchShip_PresetKey_XuannStoryPartOne_GuessGenderKey");
		short areaIdByAreaTemplateId = GetAreaIdByAreaTemplateId(8);
		MapAreaData element_Areas = DomainManager.Map.GetElement_Areas(areaIdByAreaTemplateId);
		short settlementId = element_Areas.SettlementInfos.GetRandom(Domain.MainThreadDataContext.Random).SettlementId;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		sbyte grade = (sbyte)Domain.MainThreadDataContext.Random.Next(0, 7);
		short age = 16;
		if (taiwu.GetAgeGroup() <= 1)
		{
			age = taiwu.GetCurrAge();
		}
		GameData.Domains.Character.Character character = CreateIntelligentCharacter(location, gender, age, 900, settlementId, grade);
		if (taiwu.GetAgeGroup() == 2)
		{
			ItemKey srcItemKey = AddItemToRole(character, 3, 4, 1, -1);
			ChangeEquipment(character.GetId(), -1, 4, srcItemKey);
		}
		string text = sectMainStoryEventArgBox.GetString("ConchShip_PresetKey_XuannStoryPartOne_OptionMarkKey");
		if (1 == 0)
		{
		}
		sbyte b = text switch
		{
			"A" => 0, 
			"B" => 1, 
			"C" => 2, 
			"D" => 3, 
			"E" => 4, 
			_ => GameData.Domains.Character.BehaviorType.GetRandomBehaviorType(Domain.MainThreadDataContext.Random), 
		};
		if (1 == 0)
		{
		}
		sbyte behaviorType = b;
		character.SetBaseMorality(GameData.Domains.Character.BehaviorType.GetMiddleMoralityByBehaviorType(behaviorType), Domain.MainThreadDataContext);
		if (character.GetAgeGroup() == 2 && taiwu.GetAgeGroup() == 2)
		{
			ApplyRelationBecomeAdore(character, taiwu, targetLoveBack: false);
		}
		int sectXuannvUnlockedMusicCount = DomainManager.Extra.GetSectXuannvUnlockedMusicCount();
		short num = 0;
		for (int num2 = SectMainStoryRelatedConstants.XuannvUnlockMusicCountToFavorability.Length - 1; num2 >= 0; num2--)
		{
			var (num3, num4) = SectMainStoryRelatedConstants.XuannvUnlockMusicCountToFavorability[num2];
			if (sectXuannvUnlockedMusicCount >= num3)
			{
				num = num4;
				break;
			}
		}
		int id = character.GetId();
		DirectlySetFavorabilities(id, taiwu.GetId(), num, num);
		SetCharBaseLifeSkillQualification(id, 0, 90);
		SetCharBaseLifeSkillQualification(id, 2, 90);
		SaveArgToSectMainStory(8, "ConchShip_PresetKey_XuannvStory_SecretReincarnationNPC_CharId", id);
		return character.GetId();
	}

	public static bool XuannvShouldShowRandomHeYouyuanWord(GameData.Domains.Character.Character character)
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(8);
		if (character.GetId() != sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_XuannvStory_HeYouyuan_CharId"))
		{
			return false;
		}
		if (character.GetOrganizationInfo().OrgTemplateId != 8)
		{
			return false;
		}
		return CheckProbability(50);
	}

	public static void XuannvMakeSureTargetCharacterNotWhiteHair(GameData.Domains.Character.Character character)
	{
		if (character == null)
		{
			throw new Exception("null character can not XuannvMakeSureTargetCharacterNotWhiteHair");
		}
		AvatarData avatar = character.GetAvatar();
		AvatarGroup avatarGroup = AvatarManager.Instance.GetAvatarGroup(avatar.AvatarId);
		while (avatar.FrontHairId == 0 || avatar.BackHairId == 0)
		{
			(avatar.FrontHairId, avatar.BackHairId) = avatarGroup.GetRandomHairs(Domain.MainThreadDataContext.Random);
		}
		List<byte> allKeys = AvatarHairColors.Instance.GetAllKeys();
		byte item = 42;
		allKeys.Remove(item);
		avatar.ColorBackHairId = (avatar.ColorFrontHairId = allKeys.GetRandom(Domain.MainThreadDataContext.Random));
		character.SetAvatar(avatar, Domain.MainThreadDataContext);
	}

	public static void XuannvAdjustShiWeizhiAvatar(GameData.Domains.Character.Character character)
	{
		if (character == null)
		{
			throw new Exception("null character can not XuannvAdjustShiWeizhiAvatar");
		}
		XuannvMakeSureTargetCharacterNotWhiteHair(character);
		AvatarData avatar = character.GetAvatar();
		avatar.ColorSkinId = 0;
		character.SetAvatar(avatar, Domain.MainThreadDataContext);
	}

	public static void XuannvUpdateLoverLocationInArgBox()
	{
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(8);
		int num = sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_Xuannv_PartThreeSearchLoverCountKey");
		short settlementId = sectMainStoryEventArgBox.GetShort("ConchShip_PresetKey_Xuannv_PartThree_LoverReincarnateLocation1");
		switch (num)
		{
		case 1:
			settlementId = sectMainStoryEventArgBox.GetShort("ConchShip_PresetKey_Xuannv_PartThree_LoverReincarnateLocation2");
			break;
		case 2:
			settlementId = sectMainStoryEventArgBox.GetShort("ConchShip_PresetKey_Xuannv_PartThree_LoverReincarnateLocation3");
			break;
		}
		Location settlementLocation = GetSettlementLocation(settlementId);
		SaveArgToSectMainStory(8, "ConchShip_PresetKey_Xuannv_LoverReincarnateLocation", settlementLocation);
	}

	public static void XuannvTryUnlockCurrentLocationMusic()
	{
		if (DomainManager.Map.IsTraveling)
		{
			return;
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		MapBlockData block = DomainManager.Map.GetBlock(location);
		if (block.IsCityTown())
		{
			short templateId = block.GetConfig().TemplateId;
			if (!DomainManager.Extra.CheckIsUnlockedSectXuannvMusicByMapBlockId(templateId))
			{
				DomainManager.Extra.UnlockSectXuannvMusicByMapBlockId(Domain.MainThreadDataContext, templateId);
			}
			MapAreaData element_Areas = DomainManager.Map.GetElement_Areas(location.AreaId);
			sbyte stateID = element_Areas.GetConfig().StateID;
			if (!DomainManager.Extra.CheckIsUnlockedSectXuannvMusicByMapStateId(stateID))
			{
				DomainManager.Extra.UnlockSectXuannvMusicByMapStateId(Domain.MainThreadDataContext, stateID);
			}
		}
	}

	public static void XuannvUnlockSectXuannvMusicOfTaiwuVillage()
	{
		DomainManager.Extra.UnlockSectXuannvMusicOfTaiwuVillage(Domain.MainThreadDataContext);
	}

	public static bool XuannvHasUnlockStateMusicByMapStateTemplateId(sbyte mapStateTemplateId)
	{
		return DomainManager.Extra.CheckIsUnlockedSectXuannvMusicByMapStateId(mapStateTemplateId);
	}

	public static bool XuannvHasUnlockAnyMapStateMusic()
	{
		for (sbyte b = 1; b <= 15; b++)
		{
			if (XuannvHasUnlockStateMusicByMapStateTemplateId(b))
			{
				return true;
			}
		}
		return false;
	}

	public static bool XuannvHasUnlockBlockMusicByMapBlockTemplateId(short mapBlockTemplateId)
	{
		return DomainManager.Extra.CheckIsUnlockedSectXuannvMusicByMapBlockId(mapBlockTemplateId);
	}

	public static bool XuannvHasUnlockAnyMainCityMusic()
	{
		for (short num = 1; num <= 15; num++)
		{
			if (XuannvHasUnlockBlockMusicByMapBlockTemplateId(num))
			{
				return true;
			}
		}
		return false;
	}

	public static bool XuannvHasUnlockAnySectMusic()
	{
		for (short num = 19; num <= 33; num++)
		{
			if (XuannvHasUnlockBlockMusicByMapBlockTemplateId(num))
			{
				return true;
			}
		}
		return false;
	}

	public static int XuannvGetSectXuannvUnlockedMusicCount()
	{
		return DomainManager.Extra.GetSectXuannvUnlockedMusicCount();
	}

	public static void XuannvEvaluateMusicByMapBlockId(short mapBlockTemplateId)
	{
		DomainManager.Extra.EvaluateSectXuannvMusicByMapBlockId(Domain.MainThreadDataContext, mapBlockTemplateId);
	}

	public static void XuannvEvaluateMusicByMapStateId(sbyte mapStateTemplateId)
	{
		DomainManager.Extra.EvaluateSectXuannvMusicByMapStateId(Domain.MainThreadDataContext, mapStateTemplateId);
	}

	public static int CreateMirrorCharacter(bool isMale, string familyName, string firstName)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int id = taiwu.GetId();
		sbyte orgTemplateId = 16;
		sbyte b = (sbyte)(isMale ? 1 : 0);
		bool transgender = taiwu.GetTransgender();
		short age = 16;
		short num = taiwu.GetTemplateId();
		CharacterItem characterItem = Config.Character.Instance[num];
		if (characterItem.CreatingType != 1)
		{
			sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(taiwu.GetLocation().AreaId);
			sbyte sectID = MapState.Instance[stateTemplateIdByAreaId].SectID;
			num = OrganizationDomain.GetCharacterTemplateId(sectID, stateTemplateIdByAreaId, b);
		}
		IntelligentCharacterCreationInfo intelligentCharacterCreationInfo = new IntelligentCharacterCreationInfo(taiwu.GetLocation(), new OrganizationInfo(orgTemplateId, 0, principal: true, DomainManager.Organization.GetSettlementIdByOrgTemplateId(orgTemplateId)), num);
		intelligentCharacterCreationInfo.Age = age;
		intelligentCharacterCreationInfo.BirthMonth = DomainManager.World.GetCurrMonthInYear();
		intelligentCharacterCreationInfo.BaseAttraction = taiwu.GetBaseAttraction();
		intelligentCharacterCreationInfo.Avatar = taiwu.GetAvatar();
		intelligentCharacterCreationInfo.SpecifyGenome = true;
		intelligentCharacterCreationInfo.Genome = taiwu.GetGenome();
		intelligentCharacterCreationInfo.ReincarnationCharId = -2;
		intelligentCharacterCreationInfo.InitializeSectSkills = false;
		intelligentCharacterCreationInfo.LifeSkillQualificationGrowthType = taiwu.GetLifeSkillQualificationGrowthType();
		intelligentCharacterCreationInfo.CombatSkillQualificationGrowthType = taiwu.GetCombatSkillQualificationGrowthType();
		intelligentCharacterCreationInfo.Gender = b;
		intelligentCharacterCreationInfo.Transgender = ((taiwu.GetGender() == b) ? transgender : (!transgender));
		IntelligentCharacterCreationInfo info = intelligentCharacterCreationInfo;
		GameData.Domains.Character.Character character = DomainManager.Character.CreateIntelligentCharacter(mainThreadDataContext, ref info);
		int id2 = character.GetId();
		int customSurnameId = (string.IsNullOrEmpty(familyName) ? (-1) : DomainManager.World.RegisterCustomText(mainThreadDataContext, familyName));
		int num2 = (string.IsNullOrEmpty(firstName) ? (-1) : DomainManager.World.RegisterCustomText(mainThreadDataContext, firstName));
		FullName fullName = CharacterDomain.GenerateRandomHanName(mainThreadDataContext.Random, customSurnameId, -1, b, 0);
		if (num2 >= 0)
		{
			fullName.SetCustomGivenName(num2);
		}
		character.SetFullName(fullName, mainThreadDataContext);
		List<short> learnedCombatSkills = character.GetLearnedCombatSkills();
		List<GameData.Domains.CombatSkill.CombatSkill> list = ObjectPool<List<GameData.Domains.CombatSkill.CombatSkill>>.Instance.Get();
		list.Clear();
		foreach (short learnedCombatSkill in taiwu.GetLearnedCombatSkills())
		{
			GameData.Domains.CombatSkill.CombatSkill element_CombatSkills = DomainManager.CombatSkill.GetElement_CombatSkills(new CombatSkillKey(id, learnedCombatSkill));
			GameData.Domains.CombatSkill.CombatSkill combatSkill = GameData.Serializer.Serializer.CreateCopy(element_CombatSkills);
			combatSkill.OfflineSetCharId(id2);
			combatSkill.OfflineSetSpecialEffectId(-1L);
			list.Add(combatSkill);
			learnedCombatSkills.Add(learnedCombatSkill);
		}
		DomainManager.CombatSkill.RegisterCombatSkills(id2, list);
		DomainManager.Character.AutoActivateReadCombatSkillNormalPages(mainThreadDataContext, list, id2);
		DomainManager.Extra.CopyCombatSkillProficiency(mainThreadDataContext, id, id2);
		ObjectPool<List<GameData.Domains.CombatSkill.CombatSkill>>.Instance.Return(list);
		character.SetLearnedCombatSkills(learnedCombatSkills, mainThreadDataContext);
		character.CopyCombatSkillEquipmentFrom(mainThreadDataContext, taiwu);
		DomainManager.SpecialEffect.AddAllBrokenSkillEffects(mainThreadDataContext, character);
		character.SetLoopingNeigong(taiwu.GetLoopingNeigong(), mainThreadDataContext);
		character.SetCombatSkillAttainmentPanels(taiwu.GetCombatSkillAttainmentPanels().ToArray(), mainThreadDataContext);
		List<GameData.Domains.Character.LifeSkillItem> learnedLifeSkills = character.GetLearnedLifeSkills();
		learnedLifeSkills.Clear();
		learnedLifeSkills.AddRange(taiwu.GetLearnedLifeSkills());
		character.SetLearnedLifeSkills(learnedLifeSkills, mainThreadDataContext);
		character.SetConsummateLevel(taiwu.GetConsummateLevel(), mainThreadDataContext);
		character.SetMainAttributeInterest(taiwu.GetMainAttributeInterest(), mainThreadDataContext);
		character.SetBaseMainAttributes(taiwu.GetBaseMainAttributes(), mainThreadDataContext);
		character.ClearGeneticFeatures(mainThreadDataContext);
		short groupFeature = taiwu.GetGroupFeature(171);
		if (groupFeature >= 0)
		{
			character.AddFeature(mainThreadDataContext, groupFeature, removeMutexFeature: true);
		}
		else
		{
			character.RemoveFeatureGroup(mainThreadDataContext, 171);
		}
		character.AddFeature(mainThreadDataContext, 415);
		foreach (short featureId in taiwu.GetFeatureIds())
		{
			if (featureId == 169 && isMale)
			{
				character.AddFeature(mainThreadDataContext, 168);
			}
			else if (featureId == 168 && !isMale)
			{
				character.AddFeature(mainThreadDataContext, 169);
			}
			else if (CharacterFeature.Instance[featureId].GeneticProb == 100)
			{
				character.AddFeature(mainThreadDataContext, featureId);
			}
		}
		character.SetBaseMorality((short)(-taiwu.GetBaseMorality()), mainThreadDataContext);
		AddRelation(id, id2, 16384);
		AddRelation(id2, id, 16384);
		DomainManager.Character.DirectlySetFavorabilities(mainThreadDataContext, character.GetId(), id, 30000, 30000);
		character.SetLifeSkillTypeInterest(taiwu.GetLifeSkillTypeInterest(), mainThreadDataContext);
		character.SetCombatSkillTypeInterest(taiwu.GetCombatSkillTypeInterest(), mainThreadDataContext);
		LifeSkillShorts baseLifeSkillQualifications = taiwu.GetBaseLifeSkillQualifications();
		character.SetBaseLifeSkillQualifications(ref baseLifeSkillQualifications, mainThreadDataContext);
		CombatSkillShorts baseCombatSkillQualifications = taiwu.GetBaseCombatSkillQualifications();
		character.SetBaseCombatSkillQualifications(ref baseCombatSkillQualifications, mainThreadDataContext);
		character.SetSkillQualificationBonuses(new List<SkillQualificationBonus>(taiwu.GetSkillQualificationBonuses()), mainThreadDataContext);
		RemoveAllInventoryAndEquippedItems(character);
		ResourceInts resources = default(ResourceInts);
		resources.Initialize();
		character.SetResources(ref resources, mainThreadDataContext);
		character.SetAvatar(mainThreadDataContext, new AvatarData(taiwu.GetAvatar()));
		NeiliAllocation baseNeiliAllocation = default(NeiliAllocation);
		baseNeiliAllocation.Initialize();
		character.SetBaseNeiliAllocation(baseNeiliAllocation, mainThreadDataContext);
		character.SetExtraNeili(taiwu.GetExtraNeili(), mainThreadDataContext);
		baseNeiliAllocation = default(NeiliAllocation);
		baseNeiliAllocation.Initialize();
		taiwu.SetBaseNeiliAllocation(baseNeiliAllocation, mainThreadDataContext);
		DomainManager.Extra.SetExtraNeiliAllocationProgress(mainThreadDataContext, character.GetId(), DomainManager.Extra.GetOrInitExtraNeiliAllocationProgress(mainThreadDataContext, taiwu.GetId()));
		character.SetExtraNeiliAllocation(taiwu.GetExtraNeiliAllocation(), mainThreadDataContext);
		taiwu.SetCurrNeili(0, mainThreadDataContext);
		character.SetCurrNeili(0, mainThreadDataContext);
		character.SetCurrMainAttributes(character.GetMaxMainAttributes(), mainThreadDataContext);
		character.SetHealth(character.GetLeftMaxHealth(), mainThreadDataContext);
		DomainManager.Character.CompleteCreatingCharacter(character.GetId());
		DomainManager.Extra.SectXuannvSaveMirrorCharacters(mainThreadDataContext, id, id2);
		AvatarExtraData characterAvatarExtraData = DomainManager.Extra.GetCharacterAvatarExtraData(mainThreadDataContext, taiwu.GetId());
		if (characterAvatarExtraData.IsValid())
		{
			DomainManager.Extra.TryAddCharacterAvatarExtraData(mainThreadDataContext, character.GetId(), characterAvatarExtraData);
		}
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		lifeRecordCollection.AddSectMainStoryXuannvBirthOfMirrorCreatedImposture(id2, DomainManager.World.GetCurrDate(), id2);
		return character.GetId();
	}

	public static bool IsCharacterMirrored(int id)
	{
		return DomainManager.Extra.SectXuannvIsCharacterMirrored(id);
	}

	public static bool IsCharacterMirrorImage(int id)
	{
		return DomainManager.Extra.SectXuannvIsCharacterMirrorImage(id);
	}

	public static bool IsMirrorImageUsed()
	{
		return DomainManager.Extra.SectXuannvIsMirrorImageUsed();
	}

	public static bool SectMainStory_Xuehou_Trigger_1()
	{
		if (InTutorialChapter())
		{
			return false;
		}
		if (GetSectMainStoryTaskStatus(15) != 0)
		{
			return false;
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(15);
		bool arg = false;
		bool flag = sectMainStoryEventArgBox.Get("ConchShip_PresetKey_XuehouStoryPartOneTriggered", ref arg);
		bool arg2 = false;
		bool flag2 = sectMainStoryEventArgBox.Get("ConchShip_PresetKey_StillAtYangzhou", ref arg2);
		if (IsCharacterAtTargetSectLocation(taiwu, 35) && (!flag || !arg) && (!flag2 || !arg2) && !sectMainStoryEventArgBox.Contains<int>(SectMainStoryEventArgKeys.TriggeringStatus))
		{
			return true;
		}
		return false;
	}

	public static void KillXuehouFollower()
	{
		List<GameData.Domains.Character.Character> sectCharList = GetSectCharList(15, 0, 8);
		for (int num = sectCharList.Count - 1; num >= 0; num--)
		{
			if (sectCharList[num].GetAgeGroup() < 2)
			{
				sectCharList.RemoveAt(num);
			}
		}
		sectCharList.Sort((GameData.Domains.Character.Character l, GameData.Domains.Character.Character r) => l.GetOrganizationInfo().Grade.CompareTo(r.GetOrganizationInfo().Grade));
		if (sectCharList.Count > 0)
		{
			GameData.Domains.Character.Character character = sectCharList[0];
			DomainManager.Character.MakeCharacterDead(Domain.MainThreadDataContext, character, 0);
		}
	}

	public static GameData.Domains.Character.Character GetXuehouComingCharacter()
	{
		List<GameData.Domains.Character.Character> sectCharList = GetSectCharList(15, 0, 5);
		for (int i = 0; i < sectCharList.Count; i++)
		{
			if (sectCharList[i].GetAgeGroup() == 2)
			{
				return sectCharList[i];
			}
		}
		return null;
	}

	public static sbyte GetJixiFavorabilityType()
	{
		return DomainManager.World.GetJixiFavorabilityType();
	}

	public static GameData.Domains.Character.Character TryGetJixi()
	{
		return DomainManager.World.TryGetJixi();
	}

	public static int MeetSkeletonWithBellExtraProb(int graveId)
	{
		if (!XuehouCanGetBell(graveId))
		{
			return 0;
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(15);
		int num = sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_MeetSkeletonWithBellExtraProb");
		int num2 = taiwu.GetConsummateLevel() * 8 + num;
		sectMainStoryEventArgBox.Set("ConchShip_PresetKey_MeetSkeletonWithBellExtraProb", num2);
		return num2;
	}

	public static bool XuehouCanGetBell(int graveId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		if (!DomainManager.Extra.IsExtraTaskInProgress(119))
		{
			return false;
		}
		if (taiwu.GetInventory().GetInventoryItemCount(12, 246) > 0)
		{
			return false;
		}
		DomainManager.Character.TryGetElement_Graves(graveId, out var element);
		if (element == null)
		{
			return false;
		}
		DeadCharacter deadCharacter = DomainManager.Character.GetDeadCharacter(element.GetId());
		if (element.GetLocation().AreaId == DomainManager.Organization.GetSettlementByOrgTemplateId(15).GetLocation().AreaId && deadCharacter.OrganizationInfo.OrgTemplateId == 15)
		{
			return true;
		}
		return false;
	}

	public static int GetXuehouSkeletonGraveId()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		DomainManager.Map.GetNeighborBlocks(location.AreaId, location.BlockId, list);
		for (int i = 0; i < list.Count; i++)
		{
			MapBlockData mapBlockData = list[i];
			MapBlockData blockData = DomainManager.Map.GetBlockData(mapBlockData.AreaId, mapBlockData.BlockId);
			if (blockData.GraveSet == null)
			{
				continue;
			}
			foreach (int item in blockData.GraveSet)
			{
				DeadCharacter deadCharacter = DomainManager.Character.GetDeadCharacter(item);
				sbyte consummateLevel = deadCharacter.GetConsummateLevel();
				if (XuehouCanGetBell(item) && AgeGroup.GetAgeGroup(deadCharacter.CurrAge) == 2 && Math.Abs(consummateLevel - taiwu.GetConsummateLevel()) <= 2)
				{
					return item;
				}
			}
		}
		ObjectPool<List<MapBlockData>>.Instance.Return(list);
		return -1;
	}

	public static void GenerateRandomBloodLightInXuehou()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.GenerateRandomBloodLightInXuehou(mainThreadDataContext);
	}

	public static bool IsLocationContainsBloodLight(Location location)
	{
		return DomainManager.Extra.IsLocationContainsBloodLight(location);
	}

	public static void RemoveBloodLightInLocation(Location location)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.RemoveBloodLightInLocation(mainThreadDataContext, location);
	}

	public static bool JixiAdventureTwoPassOrDisappear()
	{
		return DomainManager.World.JixiAdventurePass(2, 0) || DomainManager.World.JixiAdventureDisappear(2);
	}

	public static bool JixiAdventureThreePassOrDisappear()
	{
		return DomainManager.World.JixiAdventurePass(3, 0) || DomainManager.World.JixiAdventureDisappear(3);
	}

	public static bool CanTriggerJixiPassLegacyTask()
	{
		bool flag = DomainManager.Extra.IsExtraTaskChainInProgress(29);
		bool flag2 = DomainManager.Extra.IsExtraTaskInProgress(125);
		bool flag3 = DomainManager.Extra.IsExtraTaskInProgress(126);
		bool flag4 = DomainManager.Extra.IsExtraTaskInProgress(134);
		return flag || flag2 || flag3 || flag4;
	}

	public static void JixiGrowUp(short oldCharTemplateId, short newCharTemplateId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.World.JixiGrowUp(mainThreadDataContext, oldCharTemplateId, newCharTemplateId);
	}

	public static void JixiMovementFollow(short templateId)
	{
		Tester.Assert(templateId >= 537 && templateId <= 539, "templateId is >= Config.Character.DefKey.JixiBaby and <= Config.Character.DefKey.JixiAdult");
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		int fixedCharacterIdByTemplateId = GetFixedCharacterIdByTemplateId(templateId);
		Tester.Assert(fixedCharacterIdByTemplateId >= 0, "charId >= 0");
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(fixedCharacterIdByTemplateId);
		DomainManager.Character.JixiMovementFollowTaiwu(mainThreadDataContext, element_Objects);
	}

	public static bool IsShowSpecialTalk(EventArgBox argBox)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		GameData.Domains.Character.Character character = argBox.GetCharacter("CharacterId");
		sbyte favorabilityType = GetFavorabilityType(character, taiwu);
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(15);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_JixiFavorite1TalkTriggered", ref arg);
		bool arg2 = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_JixiFavorite2TalkTriggered", ref arg2);
		bool arg3 = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_JixiFavorite3TalkTriggered", ref arg3);
		bool arg4 = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_JixiFavorite4TalkTriggered", ref arg4);
		bool arg5 = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_JixiFavorite5TalkTriggered", ref arg5);
		if ((!arg && favorabilityType == 1) || (!arg2 && favorabilityType == 2) || (!arg3 && favorabilityType == 3) || (!arg4 && favorabilityType == 4) || (!arg5 && favorabilityType == 5))
		{
			return true;
		}
		return false;
	}

	public static void RemoveJixiAdventure()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		AreaAdventureData adventuresInArea = DomainManager.Adventure.GetAdventuresInArea(taiwuVillageLocation.AreaId);
		List<Location> list = new List<Location>();
		foreach (KeyValuePair<short, AdventureSiteData> adventureSite in adventuresInArea.AdventureSites)
		{
			if (adventureSite.Value.TemplateId == 163 || adventureSite.Value.TemplateId == 161 || adventureSite.Value.TemplateId == 162)
			{
				list.Add(new Location(taiwuVillageLocation.AreaId, adventureSite.Key));
			}
		}
		for (int i = 0; i < list.Count; i++)
		{
			DomainManager.Adventure.RemoveAdventureSite(mainThreadDataContext, list[i].AreaId, list[i].BlockId, isTimeout: false, isComplete: false);
		}
	}

	public static bool IsJixiFree()
	{
		return DomainManager.World.IsJixiFree();
	}

	public static ItemKey GetJixiRandomCarrier()
	{
		GameData.Domains.Character.Character character = TryGetJixi();
		Inventory inventory = character.GetInventory();
		List<ItemKey> list = new List<ItemKey>();
		foreach (KeyValuePair<ItemKey, int> item in inventory.Items)
		{
			if (item.Key.ItemType == 4)
			{
				list.Add(item.Key);
			}
		}
		return list.GetRandom(Domain.MainThreadDataContext.Random);
	}

	public static bool XuehouJixiTalkPossessionUseTaiwuBody()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(15);
		int arg = -1;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_AwakeJixiTaiwuId", ref arg);
		int arg2 = taiwu.GetId();
		if (!sectMainStoryEventArgBox.Get("ConchShip_PresetKey_AwakeJixiTaiwuSoulId", ref arg2))
		{
			arg2 = taiwu.GetId();
		}
		int num = taiwu.GetId();
		if (DomainManager.Extra.TryGetElement_SectJingangPossessionCharacters(taiwu.GetId(), out var value))
		{
			num = value.SoulCharId;
		}
		if (taiwu.GetId() == arg && arg2 != num)
		{
			return true;
		}
		return false;
	}

	public static bool XuehouJixiTalkPossessionUseTaiwuSoul()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		EventArgBox sectMainStoryEventArgBox = GetSectMainStoryEventArgBox(15);
		int arg = -1;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_AwakeJixiTaiwuId", ref arg);
		int arg2 = taiwu.GetId();
		if (!sectMainStoryEventArgBox.Get("ConchShip_PresetKey_AwakeJixiTaiwuSoulId", ref arg2))
		{
			arg2 = taiwu.GetId();
		}
		int num = taiwu.GetId();
		if (DomainManager.Extra.TryGetElement_SectJingangPossessionCharacters(taiwu.GetId(), out var value))
		{
			num = value.SoulCharId;
		}
		if (taiwu.GetId() != arg && (num == arg2 || num == arg))
		{
			return true;
		}
		return false;
	}

	public static void XuehouMeetJixiSaveTaiwuData(GameData.Domains.Character.Character taiwu)
	{
		SaveArgToSectMainStory(15, "ConchShip_PresetKey_AwakeJixiTaiwuId", taiwu.GetId());
		SaveArgToSectMainStory(15, "ConchShip_PresetKey_AwakeJixiTaiwuGender", taiwu.GetGender());
		if (DomainManager.Extra.TryGetElement_SectJingangPossessionCharacters(taiwu.GetId(), out var value))
		{
			SaveArgToSectMainStory(15, "ConchShip_PresetKey_AwakeJixiTaiwuSoulId", value.SoulCharId);
		}
		else
		{
			SaveArgToSectMainStory(15, "ConchShip_PresetKey_AwakeJixiTaiwuSoulId", taiwu.GetId());
		}
	}

	public static void JixiFullyHealTaiwu()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Injuries injuries = taiwu.GetInjuries();
		injuries.Initialize();
		taiwu.SetInjuries(injuries, Domain.MainThreadDataContext);
		PoisonInts poisoned = taiwu.GetPoisoned();
		poisoned.Initialize();
		taiwu.SetPoisoned(ref poisoned, Domain.MainThreadDataContext);
		short leftMaxHealth = taiwu.GetLeftMaxHealth();
		taiwu.SetHealth(leftMaxHealth, Domain.MainThreadDataContext);
	}

	public static void SettlementTreasurySetInfo(short buildingTemplateId, EventArgBox argBox)
	{
		Settlement taiwuLocationSettlement = GetTaiwuLocationSettlement();
		sbyte currentTreasuryLayer = DomainManager.Organization.GetCurrentTreasuryLayer();
		SettlementTreasury treasury = DomainManager.Organization.GetTreasury(taiwuLocationSettlement.GetId(), currentTreasuryLayer);
		argBox.Set("SettlementId", taiwuLocationSettlement.GetId());
		argBox.Set("AreaId", taiwuLocationSettlement.GetLocation().AreaId);
		bool flag = SettlementIsSect(taiwuLocationSettlement.GetId());
		argBox.Set("IsSect", flag);
		if (flag)
		{
			SectSettlementSetGuardInfo(taiwuLocationSettlement, argBox);
		}
		else
		{
			int num = 0;
			DataContext mainThreadDataContext = Domain.MainThreadDataContext;
			foreach (int guard in taiwuLocationSettlement.GetGuards(mainThreadDataContext, argBox.GetSbyte("CurrentPage")))
			{
				argBox.Set($"Guard{++num}", guard);
			}
			argBox.Set("GuardCount", num);
		}
		bool flag2 = argBox.GetSbyte("CurrentPage") == 1;
		int arg = ((!flag) ? (flag2 ? GlobalConfig.Instance.TreasuryRquireSpiritualDebtMid : GlobalConfig.Instance.TreasuryRquireSpiritualDebtHigh) : (flag2 ? GlobalConfig.Instance.TreasuryRquireApprovingMid : GlobalConfig.Instance.TreasuryRquireApprovingHigh));
		argBox.Set("SupportValue", arg);
	}

	public static Settlement GetTaiwuLocationSettlement()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		Location location2 = DomainManager.Map.GetBlock(location).GetRootBlock().GetLocation();
		return DomainManager.Organization.GetSettlementByLocation(location2);
	}

	public static void SectSettlementSetGuardInfo(Settlement settlement, EventArgBox argBox)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		IntList intList = IntList.Create();
		intList.Items = settlement.GetGuards(mainThreadDataContext, argBox.GetSbyte("CurrentPage")).ToList();
		int num = 0;
		foreach (int item in intList.Items)
		{
			argBox.Set($"Guard{++num}", item);
		}
		argBox.Set("UsefulGuards", (ISerializableGameData)(object)intList);
		argBox.Set("GuardCount", intList.Items.Count);
	}

	[Obsolete("Use settlement.GetGuards(context, layer) directly generate possibly missing NonIntelligentGuard if needed")]
	public static void CreateNonIntelligentGuard(SettlementTreasury settlementTreasury, EventArgBox argBox, bool isSect)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		Location location2 = DomainManager.Map.GetBlock(location).GetRootBlock().GetLocation();
		Settlement settlementByLocation = DomainManager.Organization.GetSettlementByLocation(location2);
		int num = 0;
		foreach (int guard in settlementByLocation.GetGuards(mainThreadDataContext, 0))
		{
			argBox.Set($"Guard{++num}", guard);
		}
		argBox.Set("GuardCount", num);
	}

	public static short GetTaiwuLocationSettlementId()
	{
		Settlement taiwuLocationSettlement = GetTaiwuLocationSettlement();
		return taiwuLocationSettlement.GetId();
	}

	public static bool SettlementIsSect(short settlementId)
	{
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		return Config.Organization.Instance[settlement.GetOrgTemplateId()].IsSect;
	}

	public static (bool canUse, bool wasPreviouslyAllowed) SettlementTreasuryCanUse(short settlementId, EventArgBox argBox)
	{
		bool flag = false;
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		sbyte arg = 0;
		argBox.Get("CurrentPage", ref arg);
		if (arg == 0)
		{
			flag = true;
		}
		else
		{
			bool flag2 = SettlementIsSect(settlementId);
			bool flag3 = arg == 1;
			if (flag2)
			{
				sbyte orgTemplateId = settlement.GetOrgTemplateId();
				int num = (flag3 ? GlobalConfig.Instance.TreasuryRquireApprovingMid : GlobalConfig.Instance.TreasuryRquireApprovingHigh);
				flag = GetSectApprovingRate(orgTemplateId) >= num * 10;
			}
			else
			{
				short areaId = settlement.GetLocation().AreaId;
				int num2 = (flag3 ? GlobalConfig.Instance.TreasuryRquireSpiritualDebtMid : GlobalConfig.Instance.TreasuryRquireSpiritualDebtHigh);
				flag = DomainManager.Extra.GetAreaSpiritualDebt(areaId) >= num2;
			}
		}
		bool item = settlement.HasTriggeredAllowEntryEvent[arg];
		settlement.HasTriggeredAllowEntryEvent[arg] = flag;
		return (canUse: flag, wasPreviouslyAllowed: item);
	}

	public static void SettleTreasuryOperate(EventArgBox argBox)
	{
		short taiwuLocationSettlementId = GetTaiwuLocationSettlementId();
		bool arg = false;
		argBox.Get("TakeEffect", ref arg);
		bool arg2 = false;
		argBox.Get("StartCombat", ref arg2);
		bool arg3 = false;
		argBox.Get("IsSect", ref arg3);
		bool arg4 = false;
		argBox.Get("Restart", ref arg4);
		DomainManager.Organization.SettleTreasuryOperate(Domain.MainThreadDataContext, taiwuLocationSettlementId, arg, arg2, arg3, arg4);
		if (!arg2)
		{
			GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.SettlementTreasuryEffect);
		}
	}

	public static void SettlementTreasuryBreakingEffect(EventArgBox argBox)
	{
		short taiwuLocationSettlementId = GetTaiwuLocationSettlementId();
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		RecordRoleFameAction(taiwu, 79, -1, 1);
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		bool flag = SettlementIsSect(taiwuLocationSettlementId);
		sbyte b = argBox.GetSbyte("CurrentPage");
		if (1 == 0)
		{
		}
		short num = b switch
		{
			0 => 0, 
			1 => 1, 
			2 => 2, 
			_ => throw new ArgumentOutOfRangeException("argBox", "EventArgKeys.CurrentPage value is out of valid range"), 
		};
		if (1 == 0)
		{
		}
		short index = num;
		SettlementTreasuryEventEffectItem effectCfg = SettlementTreasuryEventEffect.Instance[index];
		(CharacterSet, CharacterSet, CharacterSet, CharacterSet) tuple = DomainManager.Organization.ApplySettlementTreasuryEventEffect(mainThreadDataContext, effectCfg, taiwuLocationSettlementId, 0, DomainManager.Organization.GetCurrentTreasuryLayer());
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		int id = taiwu.GetId();
		foreach (int item in tuple.Item1.GetCollection())
		{
			bool flag2 = tuple.Item2.Contains(item);
			bool flag3 = tuple.Item4.Contains(item);
			if (flag2 && flag3)
			{
				lifeRecordCollection.AddIntrudeTreasuryCancelSupportMakeEnemy(item, currDate, id, taiwuLocationSettlementId);
			}
			else if (flag2)
			{
				lifeRecordCollection.AddIntrudeTreasuryMakeEnemyOthers(item, currDate, id, taiwuLocationSettlementId);
			}
			else if (flag3)
			{
				lifeRecordCollection.AddIntrudeTreasuryCancelSupport(item, currDate, id, taiwuLocationSettlementId);
			}
			else
			{
				lifeRecordCollection.AddIntrudeTreasuryLostMorale(item, currDate, id, taiwuLocationSettlementId);
			}
		}
		if (tuple.Item1.GetCount() != 0)
		{
			int count = tuple.Item2.GetCount();
			int count2 = tuple.Item4.GetCount();
			if (count > 0 && count2 > 0)
			{
				lifeRecordCollection.AddIntrudeTreasuryBeCancelSupportMakeEnemy(id, currDate, taiwuLocationSettlementId);
			}
			else if (count > 0)
			{
				lifeRecordCollection.AddIntrudeTreasuryBeMakeEnemyOthers(id, currDate, taiwuLocationSettlementId);
			}
			else if (count2 > 0)
			{
				lifeRecordCollection.AddIntrudeTreasuryBeCancelSupport(id, currDate, taiwuLocationSettlementId);
			}
			else
			{
				lifeRecordCollection.AddIntrudeTreasuryBeLostMorale2(id, currDate, taiwuLocationSettlementId);
			}
		}
		if (!flag)
		{
			int num2 = effectCfg.CalcSpiritualDebtChange(0);
			if (num2 != 0)
			{
				lifeRecordCollection.AddIntrudeTreasuryBeLostMorale(id, currDate, taiwuLocationSettlementId, (float)Math.Abs(num2) / 10f);
			}
		}
		SettlementTreasuryRecordCollection settlementTreasuryRecordCollection = DomainManager.Extra.GetSettlementTreasuryRecordCollection(mainThreadDataContext, taiwuLocationSettlementId);
		if (flag)
		{
			settlementTreasuryRecordCollection.AddIntrudeSectTreasury(currDate, taiwuLocationSettlementId, id);
		}
		else
		{
			settlementTreasuryRecordCollection.AddIntrudeTownTreasury(currDate, taiwuLocationSettlementId, id);
		}
		DomainManager.Extra.SetSettlementTreasuryRecordCollection(mainThreadDataContext, taiwuLocationSettlementId, settlementTreasuryRecordCollection);
	}

	public static void SettlementTreasuryStoreEffect(EventArgBox argBox)
	{
		short taiwuLocationSettlementId = GetTaiwuLocationSettlementId();
		Settlement settlement = DomainManager.Organization.GetSettlement(taiwuLocationSettlementId);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		bool flag = SettlementIsSect(taiwuLocationSettlementId);
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		int id = taiwu.GetId();
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		argBox.Get("StoreTreasuryInventory", out Inventory arg);
		int totalContribution = arg.GetTotalContribution(settlement);
		SettlementTreasuryRecordCollection settlementTreasuryRecordCollection = DomainManager.Extra.GetSettlementTreasuryRecordCollection(mainThreadDataContext, taiwuLocationSettlementId);
		if (flag)
		{
			settlementTreasuryRecordCollection.AddDonateSectTreasury(currDate, taiwuLocationSettlementId, id);
		}
		else
		{
			settlementTreasuryRecordCollection.AddDonateTownTreasury(currDate, taiwuLocationSettlementId, id);
		}
		DomainManager.Extra.SetSettlementTreasuryRecordCollection(mainThreadDataContext, taiwuLocationSettlementId, settlementTreasuryRecordCollection);
		if (totalContribution <= 0)
		{
			return;
		}
		short index = (short)(flag ? 4 : 7);
		SettlementTreasuryEventEffectItem effectCfg = SettlementTreasuryEventEffect.Instance[index];
		(CharacterSet, CharacterSet, CharacterSet, CharacterSet) tuple = DomainManager.Organization.ApplySettlementTreasuryEventEffect(mainThreadDataContext, effectCfg, taiwuLocationSettlementId, totalContribution, DomainManager.Organization.GetCurrentTreasuryLayer());
		foreach (int item in tuple.Item1.GetCollection())
		{
			if (tuple.Item3.Contains(item))
			{
				lifeRecordCollection.AddDonateTreasuryProvideSupport(item, currDate, id, taiwuLocationSettlementId);
			}
			else
			{
				lifeRecordCollection.AddDonateTreasuryGetMorale(item, currDate, id, taiwuLocationSettlementId);
			}
		}
		if (tuple.Item1.GetCount() != 0)
		{
			int count = tuple.Item3.GetCount();
			if (count > 0)
			{
				lifeRecordCollection.AddDonateTreasuryBeProvideSupport(id, currDate, taiwuLocationSettlementId);
			}
			else
			{
				lifeRecordCollection.AddDonateTreasuryGetMorale2(id, currDate, taiwuLocationSettlementId);
			}
		}
		if (!flag)
		{
			int num = effectCfg.CalcSpiritualDebtChange(totalContribution);
			if (num != 0)
			{
				lifeRecordCollection.AddDonateTreasuryBeGetMorale(id, currDate, taiwuLocationSettlementId, (float)Math.Abs(num) / 10f);
			}
		}
		if (totalContribution >= Config.Accessory.Instance[(short)8].BaseValue / 15)
		{
			short fameMultiplier = SettlementTreasuryEventEffectHelper.CalcFameMultiplierByContribution(totalContribution);
			RecordRoleFameAction(taiwu, 81, -1, fameMultiplier);
		}
	}

	public static void SettlementTreasuryStealEffect(EventArgBox argBox)
	{
		short taiwuLocationSettlementId = GetTaiwuLocationSettlementId();
		Settlement settlement = DomainManager.Organization.GetSettlement(taiwuLocationSettlementId);
		argBox.Get("StealTreasuryInventory", out Inventory arg);
		int totalContribution = arg.GetTotalContribution(settlement);
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		bool flag = SettlementIsSect(taiwuLocationSettlementId);
		sbyte b = argBox.GetSbyte("CurrentPage");
		if (1 == 0)
		{
		}
		short num = b switch
		{
			0 => 0, 
			1 => 1, 
			2 => 2, 
			_ => throw new ArgumentOutOfRangeException("argBox", "EventArgKeys.CurrentPage value is out of valid range"), 
		};
		if (1 == 0)
		{
		}
		short index = num;
		SettlementTreasuryEventEffectItem effectCfg = SettlementTreasuryEventEffect.Instance[index];
		(CharacterSet, CharacterSet, CharacterSet, CharacterSet) tuple = DomainManager.Organization.ApplySettlementTreasuryEventEffect(mainThreadDataContext, effectCfg, taiwuLocationSettlementId, totalContribution, DomainManager.Organization.GetCurrentTreasuryLayer());
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		short fameMultiplier = SettlementTreasuryEventEffectHelper.CalcFameMultiplierByContribution(totalContribution);
		RecordRoleFameAction(taiwu, 80, -1, fameMultiplier);
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		int id = taiwu.GetId();
		foreach (int item in tuple.Item1.GetCollection())
		{
			bool flag2 = tuple.Item2.Contains(item);
			bool flag3 = tuple.Item4.Contains(item);
			if (flag2 && flag3)
			{
				lifeRecordCollection.AddPlunderTreasuryCancelSupportMakeEnemy(item, currDate, id, taiwuLocationSettlementId);
			}
			else if (flag2)
			{
				lifeRecordCollection.AddPlunderTreasuryMakeEnemyOthers(item, currDate, id, taiwuLocationSettlementId);
			}
			else if (flag3)
			{
				lifeRecordCollection.AddPlunderTreasuryCancelSupport(item, currDate, id, taiwuLocationSettlementId);
			}
			else
			{
				lifeRecordCollection.AddPlunderTreasuryLostMorale(item, currDate, id, taiwuLocationSettlementId);
			}
		}
		if (tuple.Item1.GetCount() != 0)
		{
			int count = tuple.Item2.GetCount();
			int count2 = tuple.Item4.GetCount();
			if (count > 0 && count2 > 0)
			{
				lifeRecordCollection.AddPlunderTreasuryBeCancelSupportMakeEnemy(id, currDate, taiwuLocationSettlementId);
			}
			else if (count > 0)
			{
				lifeRecordCollection.AddPlunderTreasuryBeMakeEnemyOthers(id, currDate, taiwuLocationSettlementId);
			}
			else if (count2 > 0)
			{
				lifeRecordCollection.AddPlunderTreasuryBeCancelSupport(id, currDate, taiwuLocationSettlementId);
			}
			else
			{
				lifeRecordCollection.AddPlunderTreasuryBeLostMorale2(id, currDate, taiwuLocationSettlementId);
			}
		}
		if (!flag)
		{
			int num2 = effectCfg.CalcSpiritualDebtChange(totalContribution);
			if (num2 != 0)
			{
				lifeRecordCollection.AddPlunderTreasuryBeLostMorale(id, currDate, taiwuLocationSettlementId, (float)Math.Abs(num2) / 10f);
			}
		}
	}

	public static byte GetSettlementTreasuryAlterTime(short settlementId)
	{
		return DomainManager.Organization.GetSettlementTreasuryAlterTime(Domain.MainThreadDataContext, settlementId);
	}

	public static void GiveSettlementTreasuryResource(sbyte resourceType, int amount, sbyte orgTemplateId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId);
		GiveSettlementTreasuryResource(resourceType, amount, settlementByOrgTemplateId.GetId());
	}

	public static void GiveSettlementTreasuryResource(sbyte resourceType, int amount, short settlementId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		sbyte currentTreasuryLayer = DomainManager.Organization.GetCurrentTreasuryLayer();
		SettlementLayeredTreasuries treasuries = settlement.Treasuries;
		treasuries.GetTreasury(currentTreasuryLayer).Resources.Add(resourceType, amount);
		DomainManager.Extra.SetTreasuries(mainThreadDataContext, settlement.GetId(), treasuries, needUpdateTotalValue: true);
	}

	public static void SetSettlementTreasuryAlterTime(short settlementId, int time = -1)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		if (time == -1)
		{
			time = GlobalConfig.Instance.TreasuryAlterTime[Math.Clamp(GetGuardCombatLevel() - 1, 0, 2)];
		}
		DomainManager.Organization.SetSettlementTreasuryAlterTime(mainThreadDataContext, settlementId, (byte)time);
	}

	public static sbyte CheckTreasuryLayerItemGradeRange(EventArgBox argBox)
	{
		return DomainManager.Organization.CheckTreasuryLayerItemGradeRange(argBox);
	}

	public static void StartExchangeBooks(int charId, string exchangeFinishEvent = "", EventArgBox argBox = null)
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenBookTrade, charId);
		Domain.SetListenerWithActionName(exchangeFinishEvent, argBox, "ExchangeBookComplete");
	}

	public static void StartExchangeBooksByFavor(int charId, string exchangeFinishEvent = "", EventArgBox argBox = null)
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenBookTrade, charId, arg2: true);
		Domain.SetListenerWithActionName(exchangeFinishEvent, argBox, "ExchangeBookComplete");
	}

	public static void StartExchangeBooksByApprove(int charId, string exchangeFinishEvent = "", EventArgBox argBox = null)
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenBookTrade, charId, arg2: false);
		Domain.SetListenerWithActionName(exchangeFinishEvent, argBox, "ExchangeBookComplete");
	}

	public static void PushLifeSkillCombatForceSilentResult(int targetCharId, sbyte type, bool result)
	{
		sbyte behaviorType = DomainManager.Character.GetElement_Objects(targetCharId).GetBehaviorType();
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.LifeSkillCombatForceSilentResult, type, result, behaviorType);
	}

	public static void StartMerchantAction(int charId, string tradeFinishEvent = "", EventArgBox argBox = null)
	{
		OpenShopEventArguments arg = new OpenShopEventArguments
		{
			Id = charId,
			MerchantSourceType = 0
		};
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenShop, arg);
		Domain.SetListenerWithActionName(tradeFinishEvent, argBox, "ShopActionComplete");
	}

	public static void StartCaravanShopAction(int caravanId, string tradeFinishEvent = "", EventArgBox argBox = null)
	{
		OpenShopEventArguments arg = new OpenShopEventArguments
		{
			Id = caravanId,
			MerchantSourceType = 5
		};
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenShop, arg);
		Domain.SetListenerWithActionName(tradeFinishEvent, argBox, "ShopActionComplete");
	}

	public static void StartSettlementTreasuryShopAction(short settlementId, int guardCharId, string tradeFinishEvent = "", EventArgBox argBox = null)
	{
		sbyte currentTreasuryLayer = (sbyte)((argBox != null && argBox.GetSbyte("CurrentPage") >= 0) ? argBox.GetSbyte("CurrentPage") : 0);
		DomainManager.Organization.SetSettlementTreasuryFirstGuardChar(guardCharId);
		DomainManager.Organization.SetCurrentTreasuryLayer(currentTreasuryLayer);
		OpenShopEventArguments arg = new OpenShopEventArguments
		{
			SettlementId = settlementId,
			MerchantSourceType = 3,
			CurrPage = (argBox?.GetSbyte("CurrentPage") ?? 0)
		};
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenShop, arg);
		if (argBox != null && argBox.GetSbyte("CurrentPage") >= 0)
		{
			Domain.SetListenerWithActionName(tradeFinishEvent, argBox, "ShopActionComplete");
		}
	}

	public static void OpenSettlementPrison(short settlementId, bool isBreaking, int guardCharId = -1, string endEvent = "", EventArgBox argBox = null)
	{
		DomainManager.Organization.SetSettlementPrisonGuardCharId(guardCharId);
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenSettlementPrison, settlementId, isBreaking);
		Domain.SetListenerWithActionName(endEvent, argBox, "SettlementPrisonComplete");
	}

	public static bool RequestRoleJoinGroup(int characterId)
	{
		if (!CharacterIsInTaiwuGroup(characterId))
		{
			DomainManager.Taiwu.JoinGroup(Domain.MainThreadDataContext, characterId);
			ShowGetItemPageForCharacters(new List<int> { characterId }, isVillager: false);
			DomainManager.Adventure.AddCharacterToResultDisplay(characterId);
		}
		return true;
	}

	public static bool RequestRoleLeaveGroup(int charId)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element) && element.GetTemplateId() == 836)
		{
			DomainManager.Extra.GearMateLeaveGroup(Domain.MainThreadDataContext, charId);
		}
		else
		{
			DomainManager.Taiwu.LeaveGroup(Domain.MainThreadDataContext, charId);
		}
		return CharacterIsInTaiwuGroup(charId);
	}

	public static void JoinGroup(int characterId)
	{
		DomainManager.Taiwu.JoinGroup(Domain.MainThreadDataContext, characterId);
	}

	public static void AddCharacterToResultDisplay(int characterId)
	{
		DomainManager.Adventure.AddCharacterToResultDisplay(characterId);
	}

	public static void SelectBabyOfCharFromTeammateRequest(EventArgBox argBox, int parentCharId, string babyBoxKey)
	{
		EventSelectCharacterData eventSelectCharacterData = new EventSelectCharacterData();
		argBox.Set("SelectCharacterData", (ISerializableGameData)(object)eventSelectCharacterData);
		eventSelectCharacterData.FilterList = new List<CharacterSelectFilter>();
		CharacterSelectFilter item = new CharacterSelectFilter
		{
			SelectKey = babyBoxKey,
			AvailableCharactersDisplayDataList = new List<CharacterDisplayData>()
		};
		foreach (int item2 in DomainManager.Taiwu.GetGroupCharIds().GetCollection())
		{
			if (item2 != DomainManager.Taiwu.GetTaiwuCharId() && DomainManager.Character.TryGetElement_Objects(item2, out var element) && element.GetAgeGroup() == 0 && DomainManager.Character.HasRelation(item2, parentCharId, 1))
			{
				item.AvailableCharactersDisplayDataList.Add(DomainManager.Character.GetCharacterDisplayData(item2));
			}
		}
		eventSelectCharacterData.FilterList.Add(item);
	}

	public static void StartSelectTeammate(EventArgBox argBox, CharacterSelectFilter filter, bool includeTaiwu, bool needAdult, Action onSelectFinish = null, List<int> excludeCharIds = null)
	{
		Tester.Assert(filter.FilterTemplateId == -1);
		if (!argBox.Get("SelectCharacterData", out EventSelectCharacterData arg))
		{
			arg = new EventSelectCharacterData();
			argBox.Set("SelectCharacterData", (ISerializableGameData)(object)arg);
		}
		if (arg.FilterList == null)
		{
			arg.FilterList = new List<CharacterSelectFilter>();
		}
		if (onSelectFinish != null)
		{
			arg.OnSelectComplete = onSelectFinish;
		}
		CharacterSet groupCharIds = DomainManager.Taiwu.GetGroupCharIds();
		filter.AvailableCharactersDisplayDataList = new List<CharacterDisplayData>();
		foreach (int item in groupCharIds.GetCollection())
		{
			if ((item == DomainManager.Taiwu.GetTaiwuCharId() && !includeTaiwu) || (excludeCharIds != null && excludeCharIds.Contains(item)))
			{
				continue;
			}
			if (needAdult)
			{
				if (DomainManager.Character.TryGetElement_Objects(item, out var element) && element.GetAgeGroup() >= 2)
				{
					filter.AvailableCharactersDisplayDataList.Add(DomainManager.Character.GetCharacterDisplayData(item));
				}
			}
			else
			{
				filter.AvailableCharactersDisplayDataList.Add(DomainManager.Character.GetCharacterDisplayData(item));
			}
		}
		AddSpecialTeammateToFilter(ref filter);
		arg.FilterList.Add(filter);
	}

	private static void AddSpecialTeammateToFilter(ref CharacterSelectFilter filter)
	{
		IReadOnlySet<int> specialGroup = DomainManager.Extra.GetSpecialGroup(DomainManager.Taiwu.GetTaiwuCharId());
		foreach (int item in specialGroup)
		{
			if (!DomainManager.Character.TryGetElement_Objects(item, out var element))
			{
				throw new Exception($"Trying to find {item} in {DomainManager.Taiwu.GetTaiwuCharId()}'s group, but target is no longer alive.");
			}
			filter.AvailableCharactersDisplayDataList.Add(DomainManager.Character.GetCharacterDisplayData(element.GetId()));
		}
	}

	public static void StartSelectTeammateAndPrisoner(EventArgBox argBox, CharacterSelectFilter filter, bool avoidBaby, Action onSelectFinish = null, List<int> excludeCharIds = null)
	{
		Tester.Assert(filter.FilterTemplateId == -1);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		if (!argBox.Get("SelectCharacterData", out EventSelectCharacterData arg))
		{
			arg = new EventSelectCharacterData();
			argBox.Set("SelectCharacterData", (ISerializableGameData)(object)arg);
		}
		if (arg.FilterList == null)
		{
			arg.FilterList = new List<CharacterSelectFilter>();
		}
		if (onSelectFinish != null)
		{
			arg.OnSelectComplete = onSelectFinish;
		}
		CharacterSet groupCharIds = DomainManager.Taiwu.GetGroupCharIds();
		filter.AvailableCharactersDisplayDataList = new List<CharacterDisplayData>();
		HashSet<int> collection = groupCharIds.GetCollection();
		List<int> list = collection.ToList();
		if (DomainManager.Character.TryGetKidnappedCharacters(taiwu.GetId(), out var list2))
		{
			list.AddRange(list2.GetCollection().ConvertAll((KidnappedCharacter e) => e.CharId));
		}
		foreach (int item in list)
		{
			if (item == DomainManager.Taiwu.GetTaiwuCharId() || (excludeCharIds != null && excludeCharIds.Contains(item)))
			{
				continue;
			}
			if (avoidBaby)
			{
				if (DomainManager.Character.TryGetElement_Objects(item, out var element) && element.GetAgeGroup() != 0)
				{
					filter.AvailableCharactersDisplayDataList.Add(DomainManager.Character.GetCharacterDisplayData(item));
				}
			}
			else
			{
				filter.AvailableCharactersDisplayDataList.Add(DomainManager.Character.GetCharacterDisplayData(item));
			}
		}
		AddSpecialTeammateToFilter(ref filter);
		short arg2 = -1;
		argBox.Get("SettlementId", ref arg2);
		SettlementBountyDisplayData settlementBountyDisplayData = DomainManager.Organization.GetSettlementBountyDisplayData(arg2);
		Dictionary<int, sbyte> dictionary = settlementBountyDisplayData.BountyCharacterDisplayDataDict.ToDictionary((KeyValuePair<int, CharacterDisplayDataForSettlementBounty> v) => v.Key, (KeyValuePair<int, CharacterDisplayDataForSettlementBounty> v) => v.Value.SettlementBounty.PunishmentSeverity);
		sbyte currOrgTemplateId = (sbyte)settlementBountyDisplayData.OrgTemplateId;
		foreach (CharacterDisplayData availableCharactersDisplayData in filter.AvailableCharactersDisplayDataList)
		{
			if (dictionary.ContainsKey(availableCharactersDisplayData.CharacterId))
			{
				availableCharactersDisplayData.BountyPunishmentSeverity = dictionary[availableCharactersDisplayData.CharacterId];
				availableCharactersDisplayData.CurrOrgTemplate = currOrgTemplateId;
				availableCharactersDisplayData.BountyOrgTemplate = currOrgTemplateId;
			}
		}
		filter.AvailableCharactersDisplayDataList = (from x in filter.AvailableCharactersDisplayDataList.Select((CharacterDisplayData item, int index) => new
			{
				Item = item,
				Index = index
			})
			orderby (x.Item.CurrOrgTemplate != currOrgTemplateId) ? 1 : 0, (x.Item.CurrOrgTemplate == currOrgTemplateId) ? x.Item.BountyPunishmentSeverity : int.MinValue descending, x.Index
			select x.Item).ToList();
		arg.FilterList.Add(filter);
	}

	public static void StartSelectPrisonerOfCharacter(EventArgBox argBox, CharacterSelectFilter filter, GameData.Domains.Character.Character character, Action onSelectFinish = null)
	{
		Tester.Assert(filter.FilterTemplateId == -1);
		if (!argBox.Get("SelectCharacterData", out EventSelectCharacterData arg))
		{
			arg = new EventSelectCharacterData();
			argBox.Set("SelectCharacterData", (ISerializableGameData)(object)arg);
		}
		if (arg.FilterList == null)
		{
			arg.FilterList = new List<CharacterSelectFilter>();
		}
		if (onSelectFinish != null)
		{
			arg.OnSelectComplete = onSelectFinish;
		}
		filter.AvailableCharactersDisplayDataList = new List<CharacterDisplayData>();
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		Settlement settlement = DomainManager.Organization.GetSettlement(organizationInfo.SettlementId);
		Sect sect = (Sect)settlement;
		KidnappedCharacterList kidnappedCharacters = DomainManager.Character.GetKidnappedCharacters(character.GetId());
		foreach (KidnappedCharacter item in kidnappedCharacters.GetCollection())
		{
			Tester.Assert(item.CharId != DomainManager.Taiwu.GetTaiwuCharId());
			sbyte fugitiveBountySect = DomainManager.Organization.GetFugitiveBountySect(item.CharId);
			if (fugitiveBountySect >= 0)
			{
				SettlementBounty bounty = sect.Prison.GetBounty(item.CharId);
				if (bounty.CurrentHunterId == character.GetId())
				{
					filter.AvailableCharactersDisplayDataList.Add(DomainManager.Character.GetCharacterDisplayData(item.CharId));
				}
			}
		}
		arg.FilterList.Add(filter);
	}

	public static void StartSelectApprovedTaiwu(EventArgBox argBox, short settlementId, short targetApprovingRate, Action onSelectFinish = null, List<int> excludeCharIds = null)
	{
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		if (!argBox.Get("SelectCharacterData", out EventSelectCharacterData arg))
		{
			arg = new EventSelectCharacterData();
			argBox.Set("SelectCharacterData", (ISerializableGameData)(object)arg);
		}
		if (arg.SelectApprovedTaiwu == null)
		{
			arg.SelectApprovedTaiwu = new SelectApprovedTaiwu();
		}
		if (onSelectFinish != null)
		{
			arg.OnSelectComplete = onSelectFinish;
		}
		List<int> list = new List<int>();
		settlement.GetMembers().GetAllMembers(list);
		for (int i = 0; i < list.Count; i++)
		{
			int num = list[i];
			if ((excludeCharIds == null || !excludeCharIds.Contains(num)) && DomainManager.Organization.TryGetElement_SectCharacters(num, out var element) && !DomainManager.Extra.IsLegendaryBookConsumed(num) && element.GetApprovedTaiwu() && element.GetApprovingRate() > 0)
			{
				arg.SelectApprovedTaiwu.CharacterApprovingRate.Add(element.GetId(), element.GetApprovingRate());
				arg.SelectApprovedTaiwu.TargetApprovingRate = targetApprovingRate;
			}
		}
		ProfessionData professionData = DomainManager.Extra.GetProfessionData(17);
		if (professionData == null || !(professionData.SkillsData is DukeSkillsData))
		{
			return;
		}
		DukeSkillsData dukeSkillsData = (DukeSkillsData)professionData.SkillsData;
		foreach (var allOwner in dukeSkillsData.GetAllOwners())
		{
			arg.SelectApprovedTaiwu.DukeTitleCharIdList.Add(allOwner.CharacterId);
		}
	}

	public static void StartSelectCompletelyInfectedPrisoner(EventArgBox argBox, CharacterSelectFilter filter, Action onSelectFinish = null)
	{
		Tester.Assert(filter.FilterTemplateId == -1);
		if (!argBox.Get("SelectCharacterData", out EventSelectCharacterData arg))
		{
			arg = new EventSelectCharacterData();
			argBox.Set("SelectCharacterData", (ISerializableGameData)(object)arg);
		}
		if (arg.FilterList == null)
		{
			arg.FilterList = new List<CharacterSelectFilter>();
		}
		if (onSelectFinish != null)
		{
			arg.OnSelectComplete = onSelectFinish;
		}
		KidnappedCharacterList kidnappedCharacters = DomainManager.Character.GetKidnappedCharacters(EventArgBox.TaiwuCharacterId);
		filter.AvailableCharactersDisplayDataList = new List<CharacterDisplayData>();
		foreach (KidnappedCharacter item in kidnappedCharacters.GetCollection())
		{
			if (DomainManager.Character.TryGetElement_Objects(item.CharId, out var element) && element.IsCompletelyInfected())
			{
				filter.AvailableCharactersDisplayDataList.Add(DomainManager.Character.GetCharacterDisplayData(item.CharId));
			}
		}
		arg.FilterList.Add(filter);
	}

	public static void SelectTaiwuRelatedCharacterForRecommendFriend(EventArgBox argBox, string saveKey, int charId)
	{
		EventSelectCharacterData eventSelectCharacterData = new EventSelectCharacterData();
		eventSelectCharacterData.FilterList = new List<CharacterSelectFilter>();
		CharacterSelectFilter item = new CharacterSelectFilter
		{
			SelectKey = saveKey,
			FilterTemplateId = -1,
			AvailableCharactersDisplayDataList = new List<CharacterDisplayData>()
		};
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		HashSet<int> hashSet = new HashSet<int>();
		DomainManager.Character.GetAllRelatedCharIds(taiwuCharId, hashSet, includeGeneral: false);
		HashSet<int> hashSet2 = new HashSet<int>();
		DomainManager.Character.GetAllRelatedCharIds(charId, hashSet2, includeGeneral: false);
		foreach (int item2 in hashSet)
		{
			if (!hashSet2.Contains(item2) && item2 != charId && DomainManager.Character.TryGetElement_Objects(item2, out var element) && element.GetCreatingType() != 0 && element.GetAgeGroup() != 0 && !element.IsCompletelyInfected())
			{
				item.AvailableCharactersDisplayDataList.Add(DomainManager.Character.GetCharacterDisplayData(item2));
			}
		}
		eventSelectCharacterData.FilterList.Add(item);
		argBox.Set("SelectCharacterData", (ISerializableGameData)(object)eventSelectCharacterData);
	}

	public static void SelectTaiwuRelatedCharacterForAlienate(EventArgBox argBox, string saveKey, int charId)
	{
		EventSelectCharacterData eventSelectCharacterData = new EventSelectCharacterData();
		eventSelectCharacterData.FilterList = new List<CharacterSelectFilter>();
		CharacterSelectFilter item = new CharacterSelectFilter
		{
			SelectKey = saveKey,
			FilterTemplateId = -1,
			AvailableCharactersDisplayDataList = new List<CharacterDisplayData>()
		};
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		HashSet<int> hashSet = new HashSet<int>();
		DomainManager.Character.GetAllRelatedCharIds(taiwuCharId, hashSet, includeGeneral: false);
		foreach (int item2 in hashSet)
		{
			if (item2 != charId && DomainManager.Character.TryGetElement_Objects(item2, out var element) && element.GetCreatingType() != 0 && element.GetAgeGroup() != 0 && !element.IsCompletelyInfected())
			{
				item.AvailableCharactersDisplayDataList.Add(DomainManager.Character.GetCharacterDisplayData(item2));
			}
		}
		eventSelectCharacterData.FilterList.Add(item);
		argBox.Set("SelectCharacterData", (ISerializableGameData)(object)eventSelectCharacterData);
	}

	public static void SelectTaiwuTeammateForMediation(EventArgBox argBox, string saveKey, int charId)
	{
		EventSelectCharacterData eventSelectCharacterData = new EventSelectCharacterData();
		eventSelectCharacterData.FilterList = new List<CharacterSelectFilter>();
		CharacterSelectFilter filter = new CharacterSelectFilter
		{
			SelectKey = saveKey,
			FilterTemplateId = -1,
			AvailableCharactersDisplayDataList = new List<CharacterDisplayData>()
		};
		HashSet<int> relatedCharIds = DomainManager.Character.GetRelatedCharIds(charId, 32768);
		foreach (int item in DomainManager.Taiwu.GetGroupCharIds().GetCollection())
		{
			if (item != charId && relatedCharIds.Contains(item) && DomainManager.Character.TryGetElement_Objects(item, out var element) && element.GetCreatingType() != 0 && element.GetAgeGroup() != 0 && !element.IsCompletelyInfected())
			{
				filter.AvailableCharactersDisplayDataList.Add(DomainManager.Character.GetCharacterDisplayData(item));
			}
		}
		AddSpecialTeammateToFilter(ref filter);
		eventSelectCharacterData.FilterList.Add(filter);
		argBox.Set("SelectCharacterData", (ISerializableGameData)(object)eventSelectCharacterData);
	}

	public static HashSet<int> GetTaiwuAndGroupCharIds()
	{
		return DomainManager.Taiwu.GetGroupCharIds().GetCollection();
	}

	public static void SelectTaiwuTeammateForMatchmaking(EventArgBox argBox, string saveKey, int charId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"can not find character of id {charId} to SelectTaiwuTeammateForMatchmaking");
		}
		EventSelectCharacterData eventSelectCharacterData = new EventSelectCharacterData();
		eventSelectCharacterData.FilterList = new List<CharacterSelectFilter>();
		CharacterSelectFilter filter = new CharacterSelectFilter
		{
			SelectKey = saveKey,
			FilterTemplateId = -1,
			AvailableCharactersDisplayDataList = new List<CharacterDisplayData>()
		};
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		HashSet<int> relatedCharIds = DomainManager.Character.GetRelatedCharIds(charId, 32768);
		foreach (int item in DomainManager.Taiwu.GetGroupCharIds().GetCollection())
		{
			if (item != charId && !relatedCharIds.Contains(item) && DomainManager.Character.TryGetElement_Objects(item, out var element2) && element2.GetCreatingType() != 0 && element2.GetAgeGroup() == 2 && !element2.IsCompletelyInfected())
			{
				sbyte favorabilityType = FavorabilityType.GetFavorabilityType(DomainManager.Character.GetFavorability(item, taiwuCharId));
				if (favorabilityType >= 4 && IsOppositeGender(element2, element) && RelationTypeHelper.AllowAddingHusbandOrWifeRelation(item, charId))
				{
					filter.AvailableCharactersDisplayDataList.Add(DomainManager.Character.GetCharacterDisplayData(item));
				}
			}
		}
		AddSpecialTeammateToFilter(ref filter);
		eventSelectCharacterData.FilterList.Add(filter);
		argBox.Set("SelectCharacterData", (ISerializableGameData)(object)eventSelectCharacterData);
	}

	public static void SelectCharacterFromCharIdList(EventArgBox argBox, string saveKey, List<int> charIdList)
	{
		EventSelectCharacterData eventSelectCharacterData = new EventSelectCharacterData();
		eventSelectCharacterData.FilterList = new List<CharacterSelectFilter>();
		CharacterSelectFilter item = new CharacterSelectFilter
		{
			SelectKey = saveKey,
			FilterTemplateId = -1,
			AvailableCharactersDisplayDataList = new List<CharacterDisplayData>()
		};
		if (charIdList != null && charIdList.Count > 0)
		{
			item.AvailableCharactersDisplayDataList.AddRange(DomainManager.Character.GetCharacterDisplayDataList(charIdList));
		}
		eventSelectCharacterData.FilterList.Add(item);
		argBox.Set("SelectCharacterData", (ISerializableGameData)(object)eventSelectCharacterData);
	}

	public static void SelectCharacterFromCharIdHashSet(EventArgBox argBox, string saveKey, HashSet<int> charIdSet)
	{
		List<int> list = new List<int>();
		list.AddRange(charIdSet);
		SelectCharacterFromCharIdList(argBox, saveKey, list);
	}

	public static void TaiwuSelectItem(EventArgBox argBox, SelectItemFilter filter, Action onSelectFinish = null, bool includeEquipment = true, bool includeTransfer = true)
	{
		if (!argBox.Get("SelectItemInfo", out EventSelectItemData arg))
		{
			arg = new EventSelectItemData();
			argBox.Set("SelectItemInfo", (ISerializableGameData)(object)arg);
		}
		if (arg.CanSelectItemList == null)
		{
			arg.CanSelectItemList = new List<ItemDisplayData>();
		}
		if (onSelectFinish != null)
		{
			arg.OnSelectFinish = onSelectFinish;
		}
		if (arg.FilterList == null)
		{
			arg.FilterList = new List<SelectItemFilter>();
		}
		arg.FilterList.Add(filter);
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		if (filter.DisplayDataFilterId != 0)
		{
			List<ItemDisplayData> allInventoryItems = DomainManager.Character.GetAllInventoryItems(character.GetId());
			if (includeEquipment)
			{
				List<ItemDisplayData> allEquipmentItems = DomainManager.Character.GetAllEquipmentItems(character.GetId());
				allInventoryItems.AddRange(allEquipmentItems.Where((ItemDisplayData d) => d.Key.IsValid()));
			}
			Predicate<ItemDisplayData> filter2 = ItemDisplayDataFilters.GetFilter(filter.DisplayDataFilterId);
			if (filter2 == null)
			{
				return;
			}
			{
				foreach (ItemDisplayData itemDisplayData in allInventoryItems)
				{
					if (filter2(itemDisplayData) && !arg.CanSelectItemList.Exists((ItemDisplayData d) => d.Key.Equals(itemDisplayData.Key)))
					{
						arg.CanSelectItemList.Add(itemDisplayData);
					}
				}
				return;
			}
		}
		List<(ItemKey, int)> items = new List<(ItemKey, int)>();
		CharacterItemFilterWrappers.FindByItemFilterRule(character, filter.FilterTemplateId, items, searchInventory: true, includeEquipment);
		List<ItemDisplayData> itemDisplayData2 = CharacterDomain.GetItemDisplayData(character.GetId(), items, ItemSourceType.Inventory);
		foreach (ItemDisplayData itemDisplayData3 in itemDisplayData2)
		{
			if (!arg.CanSelectItemList.Exists((ItemDisplayData d) => d.Key.Equals(itemDisplayData3.Key)) && (includeTransfer || ItemTemplateHelper.IsTransferable(itemDisplayData3.Key.ItemType, itemDisplayData3.Key.TemplateId)))
			{
				arg.CanSelectItemList.Add(itemDisplayData3);
			}
		}
	}

	public static void SelectCharacterItemRequest(int charId, EventArgBox argBox, SelectItemFilter filter, Action onSelectFinish = null, bool includeEquipment = true, bool skipAddItem = false)
	{
		SelectCharacterItemRequestWithResource(charId, argBox, filter, onSelectFinish, includeEquipment, skipAddItem);
	}

	public static void SelectCharacterItemRequestWithResource(int charId, EventArgBox argBox, SelectItemFilter filter, Action onSelectFinish = null, bool includeEquipment = true, bool skipAddItem = false, bool onlyResource = false, bool expectResource = false)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		if (element_Objects == null)
		{
			throw new Exception("EventHelper SelectCharacterItemRequest Exception: can not find character!");
		}
		if (!argBox.Get("SelectItemInfo", out EventSelectItemData arg))
		{
			arg = new EventSelectItemData();
			argBox.Set("SelectItemInfo", (ISerializableGameData)(object)arg);
		}
		if (arg.CanSelectItemList == null)
		{
			arg.CanSelectItemList = new List<ItemDisplayData>();
		}
		if (onSelectFinish != null)
		{
			arg.OnSelectFinish = onSelectFinish;
		}
		if (arg.FilterList == null)
		{
			arg.FilterList = new List<SelectItemFilter>();
		}
		arg.FilterList.Add(filter);
		if (skipAddItem)
		{
			return;
		}
		if (filter.DisplayDataFilterId != 0)
		{
			List<ItemDisplayData> allInventoryItems = DomainManager.Character.GetAllInventoryItems(charId);
			if (includeEquipment)
			{
				List<ItemDisplayData> allEquipmentItems = DomainManager.Character.GetAllEquipmentItems(charId);
				allInventoryItems.AddRange(allEquipmentItems.Where((ItemDisplayData d) => d.Key.IsValid()));
			}
			Predicate<ItemDisplayData> filter2 = ItemDisplayDataFilters.GetFilter(filter.DisplayDataFilterId);
			if (filter2 == null)
			{
				return;
			}
			ushort displayDataFilterId = filter.DisplayDataFilterId;
			bool flag = ((displayDataFilterId == 2 || displayDataFilterId == 5) ? true : false);
			bool flag2 = flag;
			if (!onlyResource)
			{
				foreach (ItemDisplayData itemDisplayData in allInventoryItems)
				{
					if (filter2(itemDisplayData) && !arg.CanSelectItemList.Exists((ItemDisplayData d) => d.Key.Equals(itemDisplayData.Key)))
					{
						arg.CanSelectItemList.Add(itemDisplayData);
					}
				}
			}
			if (!flag2 || expectResource)
			{
				return;
			}
			ResourceInts resources = element_Objects.GetResources();
			for (int num = 0; num < 8; num++)
			{
				int num2 = resources[num];
				if (num2 > 0)
				{
					short templateId = Convert.ToInt16(321 + num);
					ItemKey key = new ItemKey(12, 0, templateId, 0);
					ItemDisplayData item = new ItemDisplayData
					{
						Key = key,
						Amount = num2
					};
					arg.CanSelectItemList.Add(item);
				}
			}
			return;
		}
		List<(ItemKey, int)> items = new List<(ItemKey, int)>();
		CharacterItemFilterWrappers.FindByItemFilterRule(element_Objects, filter.FilterTemplateId, items, searchInventory: true, includeEquipment);
		List<ItemDisplayData> itemDisplayData2 = CharacterDomain.GetItemDisplayData(charId, items, ItemSourceType.Inventory);
		foreach (ItemDisplayData itemDisplayData3 in itemDisplayData2)
		{
			if (!arg.CanSelectItemList.Exists((ItemDisplayData d) => d.Key.Equals(itemDisplayData3.Key)))
			{
				arg.CanSelectItemList.Add(itemDisplayData3);
			}
		}
	}

	public static void ExcludeItemsForEventSelectItemData(EventArgBox eventArgBox, ushort matcherId)
	{
		if (!eventArgBox.Get("SelectItemInfo", out EventSelectItemData arg) || arg == null)
		{
			return;
		}
		Predicate<ItemDisplayData> filter = ItemDisplayDataFilters.GetFilter(matcherId);
		if (filter == null)
		{
			return;
		}
		for (int num = arg.CanSelectItemList.Count - 1; num >= 0; num--)
		{
			ItemDisplayData itemDisplayData = arg.CanSelectItemList[num];
			bool flag = ((matcherId == 2 || matcherId == 5) ? true : false);
			if ((!flag || !ItemTemplateHelper.MiscResourceCanExchange(itemDisplayData.Key.ItemType, itemDisplayData.Key.TemplateId)) && !filter(itemDisplayData))
			{
				arg.CanSelectItemList.RemoveAt(num);
			}
		}
	}

	public static void AddLegacyPoint(short templateId, int percent = 100)
	{
		DomainManager.Taiwu.AddLegacyPoint(Domain.MainThreadDataContext, templateId, percent);
	}

	public static void MakeAppointment(int charId, short settlementId)
	{
		if (settlementId < 0)
		{
			AdaptableLog.Warning($"Invalid target settlement {settlementId} for appointment with {charId}");
		}
		else
		{
			DomainManager.Taiwu.AddAppointment(Domain.MainThreadDataContext, charId, settlementId);
		}
	}

	public static void TriggerLegacyPassingEvent(bool isTaiwuDying, string onFinishEvent = "")
	{
		if (DomainManager.Map.IsTraveling)
		{
			DomainManager.Map.StopTravel(Domain.MainThreadDataContext);
		}
		Domain.ClearAllTriggeredEvent();
		Domain.OnEvent_NeedToPassLegacy(isTaiwuDying, onFinishEvent);
		DomainManager.World.GetMonthlyEventCollection().Clear();
	}

	public static void ClearAllTriggeredEvent()
	{
		Domain.ClearAllTriggeredEvent();
	}

	public static void SetTaiwuAsLeaderOfTaiwuVillage()
	{
		OrganizationInfo destOrgInfo = new OrganizationInfo
		{
			OrgTemplateId = 16,
			Grade = 8,
			Principal = true,
			SettlementId = DomainManager.Taiwu.GetTaiwuVillageSettlementId()
		};
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		DomainManager.Organization.ChangeOrganization(Domain.MainThreadDataContext, taiwu, destOrgInfo);
		OrganizationInfo groupOrganization = new OrganizationInfo(16, 0, principal: true, DomainManager.Taiwu.GetTaiwuVillageSettlementId());
		SetGroupOrganization(groupOrganization);
	}

	public static void SetGroupOrganization(OrganizationInfo organizationInfo)
	{
		HashSet<int> collection = DomainManager.Taiwu.GetGroupCharIds().GetCollection();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		foreach (int item in collection)
		{
			if (item != taiwuCharId)
			{
				GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(item);
				DomainManager.Organization.ChangeOrganization(Domain.MainThreadDataContext, element_Objects, organizationInfo);
			}
		}
	}

	[Obsolete]
	public static void SelectSuccessor(EventArgBox argBox, bool isRandomSuccessor, string nextEvent)
	{
		DomainManager.Taiwu.SetLegacyPassingState(Domain.MainThreadDataContext, (sbyte)((!isRandomSuccessor) ? 1 : 2));
		Domain.SetListenerWithActionName(nextEvent, argBox, "PassingLegacyComplete");
	}

	public static void StartPassingLegacy(EventArgBox argBox, string nextEvent)
	{
		bool arg = false;
		bool flag = HasTeammates(ignoreBaby: true);
		argBox.Get("IsTaiwuDying", ref arg);
		DomainManager.Taiwu.SetIsTaiwuDying(arg);
		DomainManager.Taiwu.SetLegacyPassingState(Domain.MainThreadDataContext, (sbyte)(flag ? 1 : 2));
		Domain.SetListenerWithActionName(nextEvent, argBox, "PassingLegacyComplete");
	}

	public static void MarkTaiwuDieOfCombatWithXiangshuAttacking()
	{
		DomainManager.Taiwu.SetIsTaiwuDieOfCombatWithXiangshu(value: true, Domain.MainThreadDataContext);
	}

	public static string FinishPassingLegacy(EventArgBox argBox, sbyte behaviorType)
	{
		string arg = string.Empty;
		DomainManager.Taiwu.SetLegacyPassingState(Domain.MainThreadDataContext, 0);
		argBox.Get("OnFinishPassingLegacyEvent", ref arg);
		argBox.Remove<string>("OnFinishPassingLegacyEvent");
		return arg;
	}

	public static int GetGroupCount()
	{
		return GetValidGroupCharacterCount(ignoreBaby: false, ignoreChild: false, ignoreTaiwu: true);
	}

	public static int GetValidGroupCharacterCount(bool ignoreBaby, bool ignoreChild, bool ignoreTaiwu)
	{
		HashSet<int> collection = DomainManager.Taiwu.GetGroupCharIds().GetCollection();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int num = 0;
		foreach (int item in collection)
		{
			if ((!ignoreBaby || DomainManager.Character.GetElement_Objects(item).GetAgeGroup() != 0) && (!ignoreChild || DomainManager.Character.GetElement_Objects(item).GetAgeGroup() != 1) && (!ignoreTaiwu || item != taiwuCharId))
			{
				num++;
			}
		}
		return num;
	}

	public static bool HasTeammateCommandInTaiwuGroup()
	{
		HashSet<int> collection = DomainManager.Taiwu.GetGroupCharIds().GetCollection();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		foreach (int item in collection)
		{
			if (item != taiwuCharId)
			{
				IReadOnlyList<sbyte> charOriginalTeammateCommands = DomainManager.Extra.GetCharOriginalTeammateCommands(Domain.MainThreadDataContext, item);
				if (charOriginalTeammateCommands != null && charOriginalTeammateCommands.Count > 0)
				{
					return true;
				}
			}
		}
		return false;
	}

	public static int GetAdultGroupCharacterCount()
	{
		return GetValidGroupCharacterCount(ignoreBaby: true, ignoreChild: true, ignoreTaiwu: true);
	}

	public static bool CharacterIsInTaiwuGroup(int charId)
	{
		return DomainManager.Taiwu.IsInGroup(charId);
	}

	public static short GetTaiwuFavorabilityHotChangeValue()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		short attraction = taiwu.GetAttraction();
		sbyte fame = taiwu.GetFame();
		return (short)Math.Min(32767, 600 + attraction / 3 + Math.Max(fame, -100) * 3);
	}

	public static Location GetTaiwuVillageLocation()
	{
		return DomainManager.Taiwu.GetTaiwuVillageLocation();
	}

	public static bool IsTaiwuAtVillageLocation()
	{
		return DomainManager.Taiwu.GetTaiwu().GetLocation() == GetTaiwuVillageLocation();
	}

	public static void TeleportMoveTaiwuToLocation(Location location)
	{
		short areaId = location.AreaId;
		Tester.Assert(areaId >= 0 && areaId < 135);
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Map.StopTravel(mainThreadDataContext);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		if (taiwu.GetLocation().AreaId != location.AreaId)
		{
			DomainManager.Map.QuickTravel(mainThreadDataContext, location.AreaId);
		}
		TeleportMoveTaiwuToBlock(location.BlockId);
	}

	public static void TaiwuBeKidnapped(Location location, int hunterCharId)
	{
		ClearTrivialMonthlyEvents();
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.TaiwuBeKidnapped, location, hunterCharId);
	}

	public static void TeleportMoveTaiwuToBlock(short destBlockId)
	{
		DomainManager.Map.SetTeleportMove(teleport: true);
		DomainManager.Map.Move(Domain.MainThreadDataContext, destBlockId, notCostTime: true);
		DomainManager.Map.SetTeleportMove(teleport: false);
		Domain.SetTaiwuLocationDirtyFlag();
	}

	public static void AllocateGenericGrid(sbyte equipType)
	{
		DomainManager.Taiwu.AllocateGenericGrid(Domain.MainThreadDataContext, equipType);
	}

	public static void DeallocateGenericGrid(sbyte equipType)
	{
		DomainManager.Taiwu.DeallocateGenericGrid(Domain.MainThreadDataContext, equipType);
	}

	public static bool TryGetAppointmentOfCharacter(int charId, out short settlementId)
	{
		settlementId = -1;
		if (!DomainManager.Character.IsCharacterAlive(charId))
		{
			return false;
		}
		if (!DomainManager.Character.TryGetCharacterPrioritizedAction(charId, out var action) || !(action is AppointmentAction appointmentAction))
		{
			return false;
		}
		Location realTargetLocation = appointmentAction.Target.GetRealTargetLocation();
		Settlement settlementByLocation = DomainManager.Organization.GetSettlementByLocation(realTargetLocation);
		if (settlementByLocation == null)
		{
			return false;
		}
		settlementId = settlementByLocation.GetId();
		return true;
	}

	public static void RemoveAppointmentOfCharacter(int charId)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var _) && DomainManager.Character.TryGetCharacterPrioritizedAction(charId, out var action) && action is AppointmentAction appointmentAction)
		{
			DomainManager.Extra.SetPrioritizedActionCooldown(Domain.MainThreadDataContext, charId, appointmentAction.ActionType, PrioritizedActions.Instance[appointmentAction.ActionType].ActionCoolDown);
			DomainManager.Character.RemoveCharacterPrioritizedAction(Domain.MainThreadDataContext, charId);
		}
	}

	public static void TryAddRandomPositiveFeature()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		List<short> featureIds = taiwu.GetFeatureIds();
		List<CharacterFeatureItem> curFeatureItemList = featureIds.ConvertAll<CharacterFeatureItem>(CharacterFeature.Instance.GetItem);
		List<short[]> canAddFeatureIdList = new List<short[]>();
		CharacterFeature.Instance.Iterate(delegate(CharacterFeatureItem cell)
		{
			if (cell.Mergeable && cell.Level == 1 && curFeatureItemList.Find((CharacterFeatureItem e) => e.MutexGroupId == cell.MutexGroupId) == null)
			{
				canAddFeatureIdList.Add(new short[2] { cell.TemplateId, cell.AppearProb });
			}
			return true;
		});
		if (canAddFeatureIdList.Count > 0)
		{
			short[] randomCellFromWeightCore = GetRandomCellFromWeightCore(canAddFeatureIdList);
			featureIds.Add(randomCellFromWeightCore[0]);
			taiwu.SetFeatureIds(featureIds, Domain.MainThreadDataContext);
		}
	}

	public static ItemKey AddItemToWareHouse(sbyte itemType, short templateId, int amount)
	{
		ItemKey itemKey = DomainManager.Item.CreateItem(Domain.MainThreadDataContext, itemType, templateId);
		DomainManager.Taiwu.WarehouseAdd(Domain.MainThreadDataContext, itemKey, amount);
		return itemKey;
	}

	public static bool IsCharacterBirthday(int charId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"can not get character,Id = {charId}");
		}
		return element.GetBirthMonth() == DomainManager.World.GetCurrMonthInYear();
	}

	public static void ReEnterBlock(EventArgBox argBox)
	{
		if (argBox != null && argBox.Get<Location>("BlockFrom", out Location arg) && argBox.Get<Location>("BlockTo", out Location arg2))
		{
			Domain.OnEvent_TaiwuBlockChanged(arg, arg2);
		}
	}

	public static bool TaiwuGroupHaveAdult()
	{
		return GetValidGroupCharacterCount(ignoreBaby: true, ignoreChild: true, ignoreTaiwu: false) > 0;
	}

	public static bool TaiwuPrisonerHaveInfectedCharacter()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		if (!taiwu.IsActiveExternalRelationState(2))
		{
			return false;
		}
		KidnappedCharacterList kidnappedCharacters = DomainManager.Character.GetKidnappedCharacters(taiwu.GetId());
		foreach (KidnappedCharacter item in kidnappedCharacters.GetCollection())
		{
			if (DomainManager.Character.TryGetElement_Objects(item.CharId, out var element) && element.IsCompletelyInfected())
			{
				return true;
			}
		}
		return false;
	}

	public static bool IsCharacterChangingTaiwuVillagerMerchantType(GameData.Domains.Character.Character character)
	{
		VillagerRoleBase villagerRole = DomainManager.Extra.GetVillagerRole(character.GetId());
		return villagerRole is VillagerRoleMerchant villagerRoleMerchant && villagerRoleMerchant.CurrentMerchantType != villagerRoleMerchant.DesignatedMerchantType && villagerRoleMerchant.DesignatedMerchantType != 7;
	}

	public static string GetChangingTaiwuVillagerMerchantTypeContent(GameData.Domains.Character.Character character)
	{
		VillagerRoleBase villagerRole = DomainManager.Extra.GetVillagerRole(character.GetId());
		if (villagerRole is VillagerRoleMerchant { DesignatedMerchantType: var b } villagerRoleMerchant)
		{
			if (b == 7)
			{
				b = villagerRoleMerchant.SelfDecideMerchantType;
			}
			return Config.MerchantType.Instance[b].TaiwuVillagerMerchantChangingTypeContent;
		}
		throw new Exception($"can not get character villager role,Id = {character.GetId()}");
	}

	public static void UpdateConsummateLevelBrokenFeature()
	{
		DomainManager.Taiwu.UpdateConsummateLevelBrokenFeature(Domain.MainThreadDataContext);
	}

	public static void AddFuyuFaith(int delta, bool showNotification = false)
	{
		DomainManager.Extra.AddFuyuFaith(Domain.MainThreadDataContext, delta);
		if (delta > 0 && showNotification)
		{
			DomainManager.World.GetInstantNotificationCollection().AddGainFuyuFaith3(delta);
		}
	}

	public static int GetFuyuFaithLevel(GameData.Domains.Character.Character character, int value)
	{
		return Math.Max(0, GlobalConfig.FuyuFaithLevel.Where((int x) => x <= value).Count() - 1);
	}

	public static int GetFuyuFaithDebtByLevel(GameData.Domains.Character.Character character, int value)
	{
		return GlobalConfig.FuyuFaithDebtByLevel[value] * GlobalConfig.Instance.FuyuFaithDebtFactor / 100;
	}

	public static int GetFuyuFaithFavorByLevel(GameData.Domains.Character.Character character, int value)
	{
		return GlobalConfig.FuyuFaithFavorByLevel[value];
	}

	public static int GetFuyuFaithGiftLevelByLevel(GameData.Domains.Character.Character character, int value)
	{
		return Math.Min(8, Math.Min(GameData.Domains.World.SharedMethods.GetXiangshuLevel(DomainManager.World.GetXiangshuProgress()) + GlobalConfig.FuyuFaithAddGiftLevel[value], value));
	}

	public static int GetMaxAcceptableFuyuFaith(GameData.Domains.Character.Character character)
	{
		return GlobalConfig.FuyuFaithLevel[^1];
	}

	[Obsolete("StartSelectTeammate")]
	public static void SelectTeammateRequest(EventArgBox argBox, CharacterSelectFilter filter, bool includeTaiwu, Action onSelectFinish = null)
	{
		SelectTeammateRequestWithExclude(argBox, filter, includeTaiwu, onSelectFinish);
	}

	[Obsolete("StartSelectTeammate")]
	public static void SelectTeammateRequestWithExclude(EventArgBox argBox, CharacterSelectFilter filter, bool includeTaiwu, Action onSelectFinish = null, int excludeCharId = -1)
	{
		if (!argBox.Get("SelectCharacterData", out EventSelectCharacterData arg))
		{
			arg = new EventSelectCharacterData();
			argBox.Set("SelectCharacterData", (ISerializableGameData)(object)arg);
		}
		if (arg.FilterList == null)
		{
			arg.FilterList = new List<CharacterSelectFilter>();
		}
		if (onSelectFinish != null)
		{
			arg.OnSelectComplete = onSelectFinish;
		}
		CharacterSet groupCharIds = DomainManager.Taiwu.GetGroupCharIds();
		filter.AvailableCharactersDisplayDataList = new List<CharacterDisplayData>();
		if (filter.FilterTemplateId == -1)
		{
			foreach (int item in groupCharIds.GetCollection())
			{
				if ((item != DomainManager.Taiwu.GetTaiwuCharId() || includeTaiwu) && item != excludeCharId)
				{
					filter.AvailableCharactersDisplayDataList.Add(DomainManager.Character.GetCharacterDisplayData(item));
				}
			}
		}
		else
		{
			List<Predicate<GameData.Domains.Character.Character>> predicates = new List<Predicate<GameData.Domains.Character.Character>>();
			GameData.Domains.Character.Filters.CharacterFilterRules.ToPredicates(filter.FilterTemplateId, predicates, -1);
			foreach (int item2 in groupCharIds.GetCollection())
			{
				if ((item2 != DomainManager.Taiwu.GetTaiwuCharId() || includeTaiwu) && item2 != excludeCharId && DomainManager.Character.TryGetElement_Objects(item2, out var element) && CharacterMatchers.MatchAll(element, predicates))
				{
					filter.AvailableCharactersDisplayDataList.Add(DomainManager.Character.GetCharacterDisplayData(item2));
				}
			}
		}
		arg.FilterList.Add(filter);
	}

	[Obsolete("StartSelectCompletelyInfectedPrisoner")]
	public static void SelectCompletelyInfectedPrisoner(EventArgBox argBox, CharacterSelectFilter filter, Action onSelectFinish = null)
	{
		if (!argBox.Get("SelectCharacterData", out EventSelectCharacterData arg))
		{
			arg = new EventSelectCharacterData();
			argBox.Set("SelectCharacterData", (ISerializableGameData)(object)arg);
		}
		if (arg.FilterList == null)
		{
			arg.FilterList = new List<CharacterSelectFilter>();
		}
		if (onSelectFinish != null)
		{
			arg.OnSelectComplete = onSelectFinish;
		}
		KidnappedCharacterList kidnappedCharacters = DomainManager.Character.GetKidnappedCharacters(EventArgBox.TaiwuCharacterId);
		filter.AvailableCharactersDisplayDataList = new List<CharacterDisplayData>();
		if (filter.FilterTemplateId == -1)
		{
			foreach (KidnappedCharacter item in kidnappedCharacters.GetCollection())
			{
				if (DomainManager.Character.TryGetElement_Objects(item.CharId, out var _))
				{
					filter.AvailableCharactersDisplayDataList.Add(DomainManager.Character.GetCharacterDisplayData(item.CharId));
				}
			}
		}
		else
		{
			List<Predicate<GameData.Domains.Character.Character>> predicates = new List<Predicate<GameData.Domains.Character.Character>>();
			GameData.Domains.Character.Filters.CharacterFilterRules.ToPredicates(filter.FilterTemplateId, predicates, -1);
			foreach (KidnappedCharacter item2 in kidnappedCharacters.GetCollection())
			{
				if (DomainManager.Character.TryGetElement_Objects(item2.CharId, out var element2) && CharacterMatchers.MatchAll(element2, predicates))
				{
					filter.AvailableCharactersDisplayDataList.Add(DomainManager.Character.GetCharacterDisplayData(item2.CharId));
				}
			}
		}
		arg.FilterList.Add(filter);
	}

	[Obsolete]
	public static void TaiwuSelectItemRequest(EventArgBox argBox, SelectItemFilter filter, Action onSelectFinish = null, bool includeEquipment = true)
	{
		if (!argBox.Get("SelectItemInfo", out EventSelectItemData arg))
		{
			arg = new EventSelectItemData();
			argBox.Set("SelectItemInfo", (ISerializableGameData)(object)arg);
		}
		if (arg.CanSelectItemList == null)
		{
			arg.CanSelectItemList = new List<ItemDisplayData>();
		}
		if (onSelectFinish != null)
		{
			arg.OnSelectFinish = onSelectFinish;
		}
		if (arg.FilterList == null)
		{
			arg.FilterList = new List<SelectItemFilter>();
		}
		arg.FilterList.Add(filter);
		GameData.Domains.Character.Character character = argBox.GetCharacter("RoleTaiwu");
		if (filter.DisplayDataFilterId != 0)
		{
			List<ItemDisplayData> allInventoryItems = DomainManager.Character.GetAllInventoryItems(character.GetId());
			if (includeEquipment)
			{
				List<ItemDisplayData> allEquipmentItems = DomainManager.Character.GetAllEquipmentItems(character.GetId());
				allInventoryItems.AddRange(allEquipmentItems.Where((ItemDisplayData d) => d.Key.IsValid()));
			}
			Predicate<ItemDisplayData> filter2 = ItemDisplayDataFilters.GetFilter(filter.DisplayDataFilterId);
			if (filter2 == null)
			{
				return;
			}
			{
				foreach (ItemDisplayData itemDisplayData in allInventoryItems)
				{
					if (filter2(itemDisplayData) && !arg.CanSelectItemList.Exists((ItemDisplayData d) => d.Key.Equals(itemDisplayData.Key)))
					{
						arg.CanSelectItemList.Add(itemDisplayData);
					}
				}
				return;
			}
		}
		List<(ItemKey, int)> items = new List<(ItemKey, int)>();
		CharacterItemFilterWrappers.FindByItemFilterRule(character, filter.FilterTemplateId, items, searchInventory: true, includeEquipment);
		List<ItemDisplayData> itemDisplayData2 = CharacterDomain.GetItemDisplayData(character.GetId(), items, ItemSourceType.Inventory);
		foreach (ItemDisplayData itemDisplayData3 in itemDisplayData2)
		{
			if (!arg.CanSelectItemList.Exists((ItemDisplayData d) => d.Key.Equals(itemDisplayData3.Key)))
			{
				arg.CanSelectItemList.Add(itemDisplayData3);
			}
		}
	}

	[Obsolete("Use EventHelper.ChangeMainStoryLineProgress instead.")]
	public static void GameOver()
	{
		ChangeMainStoryLineProgress(99);
	}

	public static sbyte GetTaiwuTotalReadingProgress(int bookItemId)
	{
		return DomainManager.Taiwu.GetTotalReadingProgress(bookItemId);
	}

	public static bool GetIsDreamBack()
	{
		return DomainManager.Extra.GetIsDreamBack();
	}

	public static void DreamBackSetAudioSetting(bool isOn)
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.DreamBackSetAudioSetting, isOn);
	}

	public static void TriggerTaiwuCrossArchive(bool isCross, sbyte worldIndex = -1)
	{
		if (isCross)
		{
			Tester.Assert(worldIndex >= 0, "Wrong worldIndex");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.TaiwuCrossArchive, isCross, worldIndex);
		DreamBackSetAudioSetting(isOn: false);
	}

	public static void CreateFuyuHiltGuiderOnMap()
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(684);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		MoveFixedCharacter(orCreateFixedCharacterByTemplateId, taiwu.GetLocation());
		List<MapBlockData> mapBlockList = ObjectPool<List<MapBlockData>>.Instance.Get();
		mapBlockList.Clear();
		DomainManager.Map.GetLocationByDistance(taiwu.GetLocation(), 2, 2, ref mapBlockList);
		TriggerExtraTask(43, 260);
		if (mapBlockList.Count <= 0)
		{
			return;
		}
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		MapBlockData block = DomainManager.Map.GetBlock(taiwuVillageLocation);
		ByteCoordinate blockPos = block.GetBlockPos();
		byte b = byte.MaxValue;
		MapBlockData mapBlockData = new MapBlockData();
		foreach (MapBlockData item in mapBlockList)
		{
			byte manhattanDistanceToPos = item.GetManhattanDistanceToPos(blockPos.X, blockPos.Y);
			if (manhattanDistanceToPos < b)
			{
				b = manhattanDistanceToPos;
				mapBlockData = item;
			}
		}
		if (!mapBlockData.Visible)
		{
			mapBlockData.SetVisible(visible: true, mainThreadDataContext);
		}
		SaveGlobalArg("ConchShip_PresetKey_FuyuHiltGuiding", value: true);
	}

	public static void TriggerFuyuHiltGuiding(short moveCount, string nextEventGuid = "", EventArgBox argBox = null)
	{
		if (!string.IsNullOrEmpty(nextEventGuid))
		{
			AddEventInListenWithActionName(nextEventGuid, argBox, "FuyuMoveFinish");
		}
		int fixedCharacterIdByTemplateId = GetFixedCharacterIdByTemplateId(684);
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(fixedCharacterIdByTemplateId);
		Location location = element_Objects.GetLocation();
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		List<short> arg = CharacterDomain.CalcFuyuHiltMovementPath(location, taiwuVillageLocation, moveCount);
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.FuyuHiltMove, arg);
	}

	public static void FinishFuyuHiltGuiding()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Map.SetCrossArchiveLockMoveTime(value: false, mainThreadDataContext);
		TaiwuCrossArchiveCureInjuriesAndPoisoned();
		SaveGlobalArg("ConchShip_PresetKey_FuyuHiltGuiding", value: false);
		FinishExtraTask(43, 260);
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.FuyuHiltGuidingFinish);
		DreamBackSetAudioSetting(isOn: true);
	}

	public static void HideOverwrittenTaiwuOnMap()
	{
		GameData.Domains.Character.Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(685);
		RemoveNonIntelligentCharacter(orCreateFixedCharacterByTemplateId);
	}

	public static string GetCrossArchiveSectName()
	{
		sbyte stateSectOrgTemplateId = GetStateSectOrgTemplateId(GetStateIdByAreaId(EventArgBox.TaiwuVillageAreaId));
		return Config.Organization.Instance[stateSectOrgTemplateId].Name;
	}

	public static string GetCrossArchiveTaiwuAgeGenderName()
	{
		return "<Language Key=" + GetCrossArchiveTaiwuAgeGenderNameOnlyKey() + "/>";
	}

	public static string GetCrossArchiveTaiwuAgeGenderNameOnlyKey()
	{
		AvatarRelatedData overwrittenTaiwuAvatarRelatedData = DomainManager.Extra.GetOverwrittenTaiwuAvatarRelatedData();
		NameRelatedData overwrittenTaiwuName = DomainManager.Extra.GetOverwrittenTaiwuName();
		sbyte index = 0;
		if (overwrittenTaiwuAvatarRelatedData.DisplayAge >= 16)
		{
			index = 1;
		}
		if (overwrittenTaiwuAvatarRelatedData.DisplayAge >= GlobalConfig.Instance.AgeShowWrinkle2)
		{
			index = 2;
		}
		return TaiwuEventTagHandler._taiwuCrossArchiveAgeGender[index][overwrittenTaiwuName.Gender];
	}

	public static void TaiwuPlaceCrossArchiveInventory()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		DomainManager.Map.CreateDreamBackLocation(mainThreadDataContext, location, EDreamBackLocationType.Inventory);
	}

	public static void TaiwuPlaceCrossArchiveLifeSkill()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		DomainManager.Map.CreateDreamBackLocation(mainThreadDataContext, location, EDreamBackLocationType.LifeSkill);
	}

	public static void TaiwuPlaceCrossArchiveCombatSkill()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		DomainManager.Map.CreateDreamBackLocation(mainThreadDataContext, location, EDreamBackLocationType.CombatSkill);
	}

	public static void TaiwuFindMemoryAddInjured()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		ChangeRoleBodyPartInjuryByLevel(taiwu, isInnerInjury: false, 3, 5);
	}

	public static void TaiwuFindMemoryAddPoisoned()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		sbyte b = (sbyte)mainThreadDataContext.Random.Next(0, 4);
		for (sbyte b2 = b; b2 < b + 3; b2++)
		{
			ChangePoisonByType(taiwu, b2, 500, 1);
		}
	}

	public static void TaiwuFindMemoryAddDisorderOfQi()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		ChangeRoleDisorderOfQi(taiwu, 2000);
	}

	public static void UnpackUnhandledCrossArchiveGameData(sbyte stateType, bool inheritData = true, bool overwriteEquipments = false)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.UnpackUnhandledCrossArchiveGameData(mainThreadDataContext, stateType, inheritData, overwriteEquipments);
		if (stateType == 4)
		{
			EventArgBox fiveLoongEventArgBox = GetFiveLoongEventArgBox();
			fiveLoongEventArgBox.Set("ConchShip_TaiwuCrossArchiveInheritBuilding", inheritData);
			SetFiveLoongEventArgBox(fiveLoongEventArgBox);
		}
	}

	public static bool IsDreamBackStateUnlocked(sbyte stateType)
	{
		return DomainManager.Extra.IsDreamBackStateUnlocked(stateType);
	}

	public static bool HaveConflictCombatSkill()
	{
		return DomainManager.Extra.HaveConflictCombatSkill();
	}

	public static AvatarRelatedData GetOverwrittenTaiwuAvatarRelatedData()
	{
		return DomainManager.Extra.GetOverwrittenTaiwuAvatarRelatedData();
	}

	public static void SetOverwrittenTaiwuAvatarRelatedData(EventArgBox argBox)
	{
		int num = CreateNonIntelligentCharacter(241);
		argBox.Set("OverwrittenTaiwu", num);
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character characterById = GetCharacterById(num);
		AvatarRelatedData overwrittenTaiwuAvatarRelatedData = GetOverwrittenTaiwuAvatarRelatedData();
		characterById.SetAvatar(overwrittenTaiwuAvatarRelatedData.AvatarData, mainThreadDataContext);
		argBox.Set("TargetCharacterDisplayingClothId", overwrittenTaiwuAvatarRelatedData.ClothingDisplayId);
		argBox.Set("TargetCharacterDisplayAge", overwrittenTaiwuAvatarRelatedData.DisplayAge);
		string crossArchiveTaiwuAgeGenderNameOnlyKey = GetCrossArchiveTaiwuAgeGenderNameOnlyKey();
		SetRightRoleNameKey(crossArchiveTaiwuAgeGenderNameOnlyKey);
	}

	public static void SaveCrossArchiveTaiwuAvatar()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		AvatarRelatedData avatarRelatedData = new AvatarRelatedData();
		avatarRelatedData.AvatarData = taiwu.GetAvatar();
		avatarRelatedData.ClothingDisplayId = taiwu.GetClothingDisplayId();
		avatarRelatedData.DisplayAge = taiwu.GetCurrAge();
		SaveGlobalArg("ConchShip_PresetKey_TaiwuCrossArchiveAvatarData", avatarRelatedData);
		SaveGlobalArg("ConchShip_PresetKey_TaiwuCrossArchiveDisplayName", GetCharacterDisplayName(taiwu));
	}

	public static void SetCrossArchiveTaiwuAvatar(EventArgBox argBox)
	{
		int num = CreateNonIntelligentCharacter(241);
		argBox.Set("CrossArchiveTaiwu", num);
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character characterById = GetCharacterById(num);
		EventArgBox globalArgBox = GetGlobalArgBox();
		globalArgBox.Get("ConchShip_PresetKey_TaiwuCrossArchiveAvatarData", out AvatarRelatedData arg);
		characterById.SetAvatar(arg.AvatarData, mainThreadDataContext);
		argBox.Set("TargetCharacterDisplayingClothId", arg.ClothingDisplayId);
		argBox.Set("TargetCharacterDisplayAge", arg.DisplayAge);
		string rightRoleNameKey = globalArgBox.GetString("ConchShip_PresetKey_TaiwuCrossArchiveDisplayName");
		SetRightRoleNameKey(rightRoleNameKey);
	}

	public static void TaiwuCrossArchiveCureInjuriesAndPoisoned()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Injuries injuries = default(Injuries);
		injuries.Initialize();
		PoisonInts poisoned = default(PoisonInts);
		poisoned.Initialize();
		foreach (int item in DomainManager.Taiwu.GetGroupCharIds().GetCollection())
		{
			GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(item);
			element_Objects.SetInjuries(injuries, mainThreadDataContext);
			element_Objects.SetPoisoned(ref poisoned, mainThreadDataContext);
			ItemKey itemKey = element_Objects.GetEquipment()[11];
			if (itemKey.IsValid())
			{
				ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey);
				baseItem.SetCurrDurability(baseItem.GetMaxDurability(), mainThreadDataContext);
			}
		}
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		KidnappedCharacterList someoneKidnapCharacters = DomainManager.Character.GetSomeoneKidnapCharacters(taiwu.GetId());
		if (someoneKidnapCharacters == null)
		{
			return;
		}
		foreach (KidnappedCharacter item2 in someoneKidnapCharacters.GetCollection())
		{
			GameData.Domains.Character.Character element_Objects2 = DomainManager.Character.GetElement_Objects(item2.CharId);
			element_Objects2.SetInjuries(injuries, mainThreadDataContext);
			element_Objects2.SetPoisoned(ref poisoned, mainThreadDataContext);
			ItemKey itemKey2 = element_Objects2.GetEquipment()[11];
			if (itemKey2.IsValid())
			{
				ItemBase baseItem2 = DomainManager.Item.GetBaseItem(itemKey2);
				baseItem2.SetCurrDurability(baseItem2.GetMaxDurability(), mainThreadDataContext);
			}
		}
	}

	public static void CureTaiwuInjuriesAndPoisoned()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		Injuries injuries = default(Injuries);
		injuries.Initialize();
		PoisonInts poisoned = default(PoisonInts);
		poisoned.Initialize();
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		taiwu.SetInjuries(injuries, mainThreadDataContext);
		taiwu.SetPoisoned(ref poisoned, mainThreadDataContext);
	}

	public static bool IsDreamBack()
	{
		return DomainManager.Extra.IsDreamBack();
	}

	public static void ApplyAndResetLegacy()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Taiwu.ApplyAndResetLegacy(mainThreadDataContext, DomainManager.Taiwu.GetTaiwu());
	}

	public static void ChangeAuthorityToLegacyPoint()
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		taiwu.ChangeResource(mainThreadDataContext, 7, DomainManager.Taiwu.GetLegacyPoint() / 4);
	}

	public static bool TryGetDreamBackLifeRecordByRelatedCharId(int charId, out short templateId)
	{
		return DomainManager.Extra.TryGetDreamBackLifeRecordByRelatedCharId(charId, out templateId);
	}

	public static bool IsDejaVuEventCharacter(int charId)
	{
		return DomainManager.Extra.GetDejaVuEventCharacters().Contains(charId);
	}

	public static void AddDejaVuEventCharacter(int charId)
	{
		CharacterSet dejaVuEventCharacters = DomainManager.Extra.GetDejaVuEventCharacters();
		Tester.Assert(!dejaVuEventCharacters.Contains(charId), $"DejaVuEventCharacters already contains charId{charId}");
		dejaVuEventCharacters.Add(charId);
		DomainManager.Extra.SetDejaVuEventCharacters(dejaVuEventCharacters, Domain.MainThreadDataContext);
	}

	public static bool IsPastRelationship(int charId)
	{
		return DomainManager.Extra.GetDreamBackRelationTypeWithTaiwu(charId).Item1 != 0;
	}

	public static bool IsPastTaiwu(int charId)
	{
		return DomainManager.Extra.IsDreamBackPreviousTaiwu(charId);
	}

	public static bool IsPastLastTaiwu(int charId)
	{
		return charId == DomainManager.Extra.GetDreamBackTaiwuCharId();
	}

	public static void AddTargetJoinGroup(int charId)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Taiwu.JoinGroup(mainThreadDataContext, charId);
	}

	public static sbyte GetTargetBehaviorType(int charId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		return element_Objects.GetBehaviorType();
	}

	public static void ChangePastTaiwuToCurrentTaiwuFavorability(int charId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		short favorability = GetFavorability(element_Objects, taiwu);
		short num = 0;
		if (favorability > 30000)
		{
			num = (short)(favorability - 30000);
			ChangeFavorabilityOptional(element_Objects, taiwu, (short)(-num), 4);
		}
		else
		{
			num = (short)(30000 - favorability);
			ChangeFavorabilityOptional(element_Objects, taiwu, num, 4);
		}
	}

	public static bool IsPastLikeEachOther(int charId)
	{
		(ushort, ushort) dreamBackRelationTypeWithTaiwu = DomainManager.Extra.GetDreamBackRelationTypeWithTaiwu(charId);
		bool flag = RelationType.HasRelation(dreamBackRelationTypeWithTaiwu.Item1, 16384);
		bool flag2 = RelationType.HasRelation(dreamBackRelationTypeWithTaiwu.Item2, 16384);
		return flag && flag2;
	}

	public static bool IsTargetCanGetMarried(int charId)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		bool flag = DomainManager.Character.OrgAndMonkTypeAllowMarriage(charId);
		bool flag2 = IsTargetAdult(charId);
		bool flag3 = IsTargetLikeTaiwuGender(charId);
		int aliveSpouse = DomainManager.Character.GetAliveSpouse(charId);
		int aliveSpouse2 = DomainManager.Character.GetAliveSpouse(taiwu.GetId());
		return flag && flag2 && flag3 && aliveSpouse < 0 && aliveSpouse2 < 0;
	}

	public static ushort GetPastSelfRelationToTaiwu(int charId)
	{
		return DomainManager.Extra.GetDreamBackRelationTypeWithTaiwu(charId).Item1;
	}

	public static short GetTargetPastSelfTaiwuFavorabilityLevel(int charId)
	{
		return 0;
	}

	public static bool IsTargetAdult(int charId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		return element_Objects.GetAgeGroup() == 2;
	}

	public static bool IsTargetAgeOlderThanTaiwu(int charId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		return element_Objects.GetActualAge() > taiwu.GetActualAge();
	}

	public static bool IsTargetLikeTaiwuGender(int charId)
	{
		GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		return element_Objects.GetBisexual() ? (element_Objects.GetGender() == taiwu.GetGender()) : (element_Objects.GetGender() != taiwu.GetGender());
	}

	public static short GetTargetPastSelfTaiwuPriorityRelation(int charId)
	{
		ushort pastSelfRelationToTaiwu = GetPastSelfRelationToTaiwu(charId);
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Genealogy genealogy = DomainManager.Character.GetGenealogy(taiwu.GetId());
		if (RelationType.HasRelation(pastSelfRelationToTaiwu, 32768))
		{
			return 9;
		}
		if (RelationType.HasRelation(pastSelfRelationToTaiwu, 73))
		{
			return 0;
		}
		if (RelationType.HasRelation(pastSelfRelationToTaiwu, 1024))
		{
			return 1;
		}
		if (RelationType.HasRelation(pastSelfRelationToTaiwu, 146))
		{
			return 2;
		}
		if (RelationType.HasRelation(pastSelfRelationToTaiwu, 292))
		{
			return 3;
		}
		if (RelationType.HasRelation(pastSelfRelationToTaiwu, 512))
		{
			return 4;
		}
		if (RelationType.HasRelation(pastSelfRelationToTaiwu, 16384))
		{
			return 5;
		}
		if (RelationType.HasRelation(pastSelfRelationToTaiwu, 8192))
		{
			return 6;
		}
		if (charId == genealogy.GrandfatherId || charId == genealogy.GrandmotherId || charId == genealogy.MaternalGrandfatherId || charId == genealogy.MaternalGrandmotherId)
		{
			return 7;
		}
		if (DomainManager.Extra.IsCharacterDreamBackTaiwuGrandchild(charId))
		{
			return 8;
		}
		return -1;
	}

	public static bool HasTravelingEventBeenTriggered(short templateId)
	{
		return DomainManager.Extra.HasTravelingEventBeenTriggered(templateId);
	}

	public static int GetTravelingEventTypeTriggerCount(ETravelingEventType type)
	{
		return DomainManager.Extra.GetTravelingEventTypeTriggerCount(type);
	}

	public static void SetOnHandlingTravelingEventBlock(bool blockOperation)
	{
		DomainManager.Map.SetOnHandlingTravelingEventBlock(blockOperation, Domain.MainThreadDataContext);
	}

	public static void TreasureEnterBattle(string afterEvent, EventArgBox argBox)
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.FindTreasureMaterial);
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "FindTreasureMaterial");
		}
	}

	public static void GenerateTreasureLifeRecordToTaiwu(TreasureFindResult result, bool win)
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		DomainManager.Extra.FindTreasureGenerateLifeRecord(taiwuCharId, result, !win);
	}

	public static ItemKey ApplyTreasureResultToTaiwu(TreasureFindResult result)
	{
		List<ItemKey> list = ObjectPool<List<ItemKey>>.Instance.Get();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		DomainManager.Extra.FindTreasureApplyResult(Domain.MainThreadDataContext, taiwuCharId, result, list);
		ItemKey result2 = ItemKey.Invalid;
		foreach (ItemKey item in list)
		{
			if (item.ItemType == 12 && item.TemplateId == result.MaterialTemplateId)
			{
				result2 = item;
			}
		}
		ObjectPool<List<ItemKey>>.Instance.Return(list);
		return result2;
	}

	[Obsolete("not available method anymore")]
	public static void ProgressTutorialShowDialog(string dialogTitle = "", string dialogContent = "", string confirmEvent = "", EventArgBox argBox = null)
	{
	}

	public static void BackToTutorialChapterMenu(int chapter)
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.BackToTutorialChapterMenu, chapter);
		DomainManager.TutorialChapter.SetInGuiding(value: false, Domain.MainThreadDataContext);
	}

	public static void SetMoveEnable(bool enable)
	{
		DomainManager.TutorialChapter.SetCanMove(enable, Domain.MainThreadDataContext);
	}

	public static void SetOpenCharacterMenuEnable(bool enable)
	{
		DomainManager.TutorialChapter.SetCanOpenCharacterMenu(enable, Domain.MainThreadDataContext);
	}

	public static void PlayGuideVideo(string videoName)
	{
		DomainManager.TutorialChapter.SetGuidVideoName(videoName, Domain.MainThreadDataContext);
	}

	public static void SetAdvanceMonthEnable(bool enable)
	{
		DomainManager.TutorialChapter.SetCanAdvanceMonth(enable, Domain.MainThreadDataContext);
	}

	public static void SetTutorialForceNextCoordinate(byte x, byte y)
	{
		if (x == byte.MaxValue && y == byte.MaxValue)
		{
			DomainManager.TutorialChapter.SetNextForceLocation(Location.Invalid, Domain.MainThreadDataContext);
			return;
		}
		ByteCoordinate byteCoordinate = new ByteCoordinate(x, y);
		short blockId = ByteCoordinate.CoordinateToIndex(byteCoordinate, DomainManager.TutorialChapter.TutorialAreaSize);
		DomainManager.TutorialChapter.SetNextForceLocation(new Location(136, blockId), Domain.MainThreadDataContext);
	}

	public static ByteCoordinate GetTutorialCoordinateFromLocation(Location location)
	{
		return ByteCoordinate.IndexToCoordinate(location.BlockId, DomainManager.TutorialChapter.TutorialAreaSize);
	}

	public static Location GetTutorialForceNextLocation()
	{
		return DomainManager.TutorialChapter.GetNextForceLocation();
	}

	public static void ActiveChapter7NeiliAllocateFlag()
	{
		DomainManager.TutorialChapter.SetNeiliAllocateFitChapter7(value: true, Domain.MainThreadDataContext);
	}

	public static void SetHuanxinDying(bool dying)
	{
		DomainManager.TutorialChapter.SetHuanxinDying(dying, Domain.MainThreadDataContext);
	}

	public static void SetHuanxinSurprised(bool surprised)
	{
		DomainManager.TutorialChapter.SetHuanxinSurprised(surprised, Domain.MainThreadDataContext);
	}

	public static void SetCanShowEnterIndustry(bool canShowEnterIndustry)
	{
		DomainManager.TutorialChapter.SetCanShowEnterIndustry(canShowEnterIndustry, Domain.MainThreadDataContext);
	}

	public static bool IsLocationMatchTutorialCoordinate(Location location, byte x, byte y)
	{
		ByteCoordinate byteCoordinate = new ByteCoordinate(x, y);
		short blockId = ByteCoordinate.CoordinateToIndex(byteCoordinate, DomainManager.TutorialChapter.TutorialAreaSize);
		return location.Equals(new Location(136, blockId));
	}

	public static Location GetTutorialLocationByCoordinate(byte x, byte y)
	{
		ByteCoordinate byteCoordinate = new ByteCoordinate(x, y);
		short blockId = ByteCoordinate.CoordinateToIndex(byteCoordinate, DomainManager.TutorialChapter.TutorialAreaSize);
		return new Location(136, blockId);
	}

	public static void RemoveCenterBambooHouseOfTutorialArea()
	{
		Location tutorialLocationByCoordinate = GetTutorialLocationByCoordinate(9, 9);
		List<BuildingBlockData> buildingBlockList = DomainManager.Building.GetBuildingBlockList(tutorialLocationByCoordinate);
		foreach (BuildingBlockData item in buildingBlockList)
		{
			if (item.TemplateId == 257 || item.TemplateId == 258)
			{
				BuildingBlockKey blockKey = new BuildingBlockKey(tutorialLocationByCoordinate.AreaId, tutorialLocationByCoordinate.BlockId, item.BlockIndex);
				DomainManager.Building.ResetAllChildrenBlocks(Domain.MainThreadDataContext, blockKey, 0, -1);
				break;
			}
		}
	}

	public static bool TutorialAreaHasCompletedBambooHouse()
	{
		Location tutorialLocationByCoordinate = GetTutorialLocationByCoordinate(9, 9);
		List<BuildingBlockData> buildingBlockList = DomainManager.Building.GetBuildingBlockList(tutorialLocationByCoordinate);
		foreach (BuildingBlockData item in buildingBlockList)
		{
			if (item.TemplateId == 257 || item.TemplateId == 258)
			{
				if (item.CanUse())
				{
					return true;
				}
				return false;
			}
		}
		return false;
	}

	public static void SetWorldResourceCollectionStatus(bool isOn)
	{
		if (isOn)
		{
			DomainManager.World.SetWorldFunctionsStatus(Domain.MainThreadDataContext, 5);
		}
		else
		{
			DomainManager.World.ResetWorldFunctionsStatus(Domain.MainThreadDataContext, 5);
		}
	}

	public static void StartListenXuXianGongCombatDistance(string listenerEventGuid, EventArgBox argBox)
	{
		Domain.SetListenerWithActionName(listenerEventGuid, argBox, "CombatDistanceWithEnemyChanged");
		Events.RegisterHandler_DistanceChanged(OnCombatWithXuXianGongDistanceChange);
		DomainManager.Combat.ForbidNormalAttackInTutorial(DomainManager.Taiwu.GetTaiwuCharId());
	}

	private static void OnCombatWithXuXianGongDistanceChange(DataContext context, CombatCharacter mover, short distanceOffset, bool isMove, bool isForced)
	{
		if (isMove && !isForced && distanceOffset < 0)
		{
			short currentDistance = DomainManager.Combat.GetCurrentDistance();
			if (currentDistance == 40)
			{
				Events.UnRegisterHandler_DistanceChanged(OnCombatWithXuXianGongDistanceChange);
				Domain.TriggerListener("CombatDistanceWithEnemyChanged", value: true);
				DomainManager.Combat.ClearMobilityAndForbidRecover(context, mover.GetId());
				DomainManager.Combat.PermitNormalAttackInTutorial(DomainManager.Taiwu.GetTaiwuCharId());
			}
		}
	}

	public static void StartListenHuanXinMiss(string listenerEventGuid, EventArgBox argBox)
	{
		DomainManager.Combat.SetAttackForceMiss(DomainManager.Taiwu.GetTaiwuCharId(), 3);
		Domain.SetListenerWithActionName(listenerEventGuid, argBox, "CombatNormalAttackEnd");
		DomainManager.TutorialChapter.Counter = 0;
		DomainManager.TutorialChapter.CounterTarget = 3;
		Events.RegisterHandler_NormalAttackAllEnd(OnHuanXinAttackMiss);
	}

	private static void OnHuanXinAttackMiss(DataContext context, CombatCharacter attacker, CombatCharacter defender)
	{
		if (attacker.GetId() == DomainManager.Taiwu.GetTaiwuCharId())
		{
			DomainManager.TutorialChapter.Counter++;
			if (DomainManager.TutorialChapter.Counter >= DomainManager.TutorialChapter.CounterTarget)
			{
				Events.UnRegisterHandler_NormalAttackAllEnd(OnHuanXinAttackMiss);
				Domain.TriggerListener("CombatNormalAttackEnd", value: true);
			}
		}
	}

	public static void StartListenHuanxinBeatXuXianGong(string listenerEventGuid, EventArgBox argBox)
	{
		DomainManager.Combat.SetAttackForceHit(DomainManager.Taiwu.GetTaiwuCharId(), 3);
		Domain.SetListenerWithActionName(listenerEventGuid, argBox, "CombatNormalAttackEnd");
		DomainManager.TutorialChapter.Counter = 0;
		DomainManager.TutorialChapter.CounterTarget = 3;
		Events.RegisterHandler_NormalAttackAllEnd(OnHuanxinAttackHit);
	}

	private static void OnHuanxinAttackHit(DataContext context, CombatCharacter attacker, CombatCharacter defender)
	{
		if (attacker.GetId() == DomainManager.Taiwu.GetTaiwuCharId())
		{
			DomainManager.TutorialChapter.Counter++;
			if (DomainManager.TutorialChapter.Counter >= DomainManager.TutorialChapter.CounterTarget)
			{
				Events.UnRegisterHandler_NormalAttackAllEnd(OnHuanxinAttackHit);
				Domain.TriggerListener("CombatNormalAttackEnd", value: true);
			}
		}
	}

	public static void HuanxinAppendKaiHeSordSkill()
	{
		if (DomainManager.TutorialChapter.InGuiding)
		{
			DomainManager.Combat.AppendEquipAttackSkill(Domain.MainThreadDataContext, DomainManager.Taiwu.GetTaiwuCharId(), 552);
		}
	}

	public static void HuanxinAppendCombatSkill(short skillId)
	{
		if (DomainManager.TutorialChapter.InGuiding)
		{
			CombatCharacter combatCharacter = DomainManager.Combat.GetCombatCharacter(isAlly: true);
			DomainManager.Combat.AddTrick(Domain.MainThreadDataContext, combatCharacter, Config.CombatSkill.Instance[skillId].TrickCost);
			DomainManager.Combat.GmCmd_ForceRecoverBreathAndStance(Domain.MainThreadDataContext);
			DomainManager.Combat.AppendEquipAttackSkill(Domain.MainThreadDataContext, DomainManager.Taiwu.GetTaiwuCharId(), skillId);
			DomainManager.Combat.SetSkillToMaxRange(Domain.MainThreadDataContext, DomainManager.Taiwu.GetTaiwuCharId(), skillId);
			DomainManager.Combat.SetSkillAttackForceHit(DomainManager.Taiwu.GetTaiwuCharId(), forceHit: true);
			DomainManager.Combat.AddSkillPower(Domain.MainThreadDataContext, DomainManager.Taiwu.GetTaiwuCharId(), skillId, 1000);
		}
	}

	public static void HuanxinAppendWujiJianshi()
	{
		HuanxinAppendCombatSkill(540);
	}

	public static void HuanxinAppendDamoJianfa()
	{
		HuanxinAppendCombatSkill(548);
	}

	public static void HuanxinAppendWanhuaShiSiJian()
	{
		HuanxinAppendCombatSkill(557);
	}

	public static void HuanxinAppendZhanAoDaoFa()
	{
		HuanxinAppendCombatSkill(593);
	}

	public static void HuanxinLostAllMobility()
	{
		DomainManager.Combat.ClearMobilityAndForbidRecover(Domain.MainThreadDataContext, DomainManager.Taiwu.GetTaiwuCharId());
	}

	public static void StartListenAttackSkillCast(string listenerGuid, EventArgBox argBox)
	{
		Events.RegisterHandler_AttackSkillAttackEnd(OnAttackSkillAttackEnd);
		Domain.SetListenerWithActionName(listenerGuid, argBox, "CombatOver");
		static void OnAttackSkillAttackEnd(CombatContext context, sbyte hitType, bool hit, int index)
		{
			if (context.AttackerId == DomainManager.Taiwu.GetTaiwuCharId() && index == 3)
			{
				Events.UnRegisterHandler_AttackSkillAttackEnd(OnAttackSkillAttackEnd);
				int defenderId = context.DefenderId;
				DomainManager.Combat.AddInjury(Domain.MainThreadDataContext, defenderId, 5, isInner: false, 6);
				DomainManager.Combat.AddInjury(Domain.MainThreadDataContext, defenderId, 6, isInner: false, 6);
				DomainManager.Combat.AddInjury(Domain.MainThreadDataContext, defenderId, 1, isInner: false, 6);
				DomainManager.Combat.AddInjury(Domain.MainThreadDataContext, defenderId, 3, isInner: false, 6);
				DomainManager.Combat.AddInjury(Domain.MainThreadDataContext, defenderId, 4, isInner: false, 6);
				DomainManager.Combat.AddInjury(Domain.MainThreadDataContext, defenderId, 0, isInner: false, 6);
			}
		}
	}

	public static ItemKey AddTianShuXuanJiByAdoptiveFatherToHuanXin()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		ItemKey itemKey = DomainManager.Item.CreateSkillBook(Domain.MainThreadDataContext, 870, 5, 0, -1, 50);
		taiwu.AddInventoryItem(Domain.MainThreadDataContext, itemKey, 1);
		DomainManager.Item.GetBaseItem(itemKey).SetMaxDurability(99, Domain.MainThreadDataContext);
		DomainManager.Item.GetBaseItem(itemKey).SetCurrDurability(99, Domain.MainThreadDataContext);
		return itemKey;
	}

	public unsafe static void HuanxinSavedByFuyuSwordAndAutoAllocateNeili()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		taiwu.ChangeConsummateLevel(Domain.MainThreadDataContext, 18);
		taiwu.ChangeExtraNeili(Domain.MainThreadDataContext, 32000);
		taiwu.ChangeCurrNeili(Domain.MainThreadDataContext, 32000);
		for (int i = 0; i < 100; i++)
		{
			NeiliAllocation neiliAllocation = taiwu.GetNeiliAllocation();
			if (neiliAllocation.Items[1] < 90)
			{
				taiwu.AllocateNeili(Domain.MainThreadDataContext, 1);
			}
			if (neiliAllocation.Items[3] < 90)
			{
				taiwu.AllocateNeili(Domain.MainThreadDataContext, 3);
			}
			if (neiliAllocation.Items[0] < 90)
			{
				taiwu.AllocateNeili(Domain.MainThreadDataContext, 0);
			}
			if (neiliAllocation.Items[2] < 90)
			{
				taiwu.AllocateNeili(Domain.MainThreadDataContext, 2);
			}
		}
	}

	public static void SetHuanxinImmuneInjury()
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		DomainManager.Combat.SetDefeatMarkImmunity(taiwu.GetId(), outerInjuryImmunity: true, innerInjuryImmunity: true, mindImmunity: true, flawImmunity: true, acupointImmunity: true);
	}

	public static void StartListenOnLittleMonkCastSkillEnd(int castSkillCharId, string listenerGuid, EventArgBox argBox)
	{
		Events.RegisterHandler_CastSkillEnd(OnLittleMonkCastAttackSkillEnd);
		Domain.SetListenerWithActionName(listenerGuid, argBox, "CombatSkillCastEnd");
		static void OnHuanxinNormalAttackEnd(DataContext context, CombatCharacter attacker, CombatCharacter defender)
		{
			if (attacker == DomainManager.Combat.GetCombatCharacter(isAlly: true))
			{
				Events.UnRegisterHandler_NormalAttackAllEnd(OnHuanxinNormalAttackEnd);
				Domain.TriggerListener("CombatSkillCastEnd", value: true);
			}
		}
		void OnLittleMonkCastAttackSkillEnd(DataContext context, int charId, bool isAlly, short skillId, sbyte power, bool interrupted)
		{
			if (castSkillCharId == charId)
			{
				Events.UnRegisterHandler_CastSkillEnd(OnLittleMonkCastAttackSkillEnd);
				CombatCharacter combatCharacter = DomainManager.Combat.GetCombatCharacter(isAlly: true);
				if (combatCharacter.StateMachine.GetCurrentStateType() == CombatCharacterStateType.PrepareAttack || combatCharacter.GetReserveNormalAttack())
				{
					Events.RegisterHandler_NormalAttackAllEnd(OnHuanxinNormalAttackEnd);
				}
				else
				{
					Domain.TriggerListener("CombatSkillCastEnd", value: true);
				}
			}
		}
	}

	public static void StartListenHuanxinSkillPrepareEnd(string listenerGuid, EventArgBox argBox)
	{
		Events.RegisterHandler_PrepareSkillEnd(OnPrepareSkillEnd);
		Domain.SetListenerWithActionName(listenerGuid, argBox, "CombatSkillPrepareEnd");
		static void OnPrepareSkillEnd(DataContext context, int charId, bool isAlly, short skillId)
		{
			if (DomainManager.Taiwu.GetTaiwuCharId() == charId)
			{
				Events.UnRegisterHandler_PrepareSkillEnd(OnPrepareSkillEnd);
				Domain.TriggerListener("CombatSkillPrepareEnd", value: true);
			}
		}
	}

	public static void StartListenHuanxinCastSkillEndInTutorial7(string listenerGuid, EventArgBox argBox)
	{
		Events.RegisterHandler_AttackSkillAttackEnd(OnAttackSkillAttackEnd);
		Domain.SetListenerWithActionName(listenerGuid, argBox, "CombatOver");
		static void OnAttackSkillAttackEnd(CombatContext context, sbyte hitType, bool hit, int index)
		{
			if (context.AttackerId == DomainManager.Taiwu.GetTaiwuCharId() && index == 3)
			{
				Events.UnRegisterHandler_AttackSkillAttackEnd(OnAttackSkillAttackEnd);
				int defenderId = context.DefenderId;
				DomainManager.Combat.AddInjury(Domain.MainThreadDataContext, defenderId, 5, isInner: false, 6);
				DomainManager.Combat.AddInjury(Domain.MainThreadDataContext, defenderId, 6, isInner: false, 6);
				DomainManager.Combat.AddInjury(Domain.MainThreadDataContext, defenderId, 1, isInner: false, 6);
				DomainManager.Combat.AddInjury(Domain.MainThreadDataContext, defenderId, 3, isInner: false, 6);
				DomainManager.Combat.AddInjury(Domain.MainThreadDataContext, defenderId, 4, isInner: false, 6);
				DomainManager.Combat.AddInjury(Domain.MainThreadDataContext, defenderId, 0, isInner: false, 6);
			}
		}
	}

	public static void StopAutoStartCombat()
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.StopAutoStartCombat);
	}

	public static short GetTutorialChapter()
	{
		return DomainManager.TutorialChapter.GetTutorialChapter();
	}

	public static bool InTutorialChapter()
	{
		return GetTutorialChapter() > 0;
	}

	public static sbyte GetXiangshuProgress()
	{
		return DomainManager.World.GetXiangshuProgress();
	}

	public static sbyte GetXiangshuLevel()
	{
		return DomainManager.World.GetXiangshuLevel();
	}

	public static void ChangeMainStoryLineProgress(short progress)
	{
		DomainManager.World.ChangeMainStoryLineProgress(Domain.MainThreadDataContext, progress);
	}

	public static void SetWorldFunctionsStatus(byte worldFunctionType)
	{
		DomainManager.World.SetWorldFunctionsStatus(Domain.MainThreadDataContext, worldFunctionType);
		if (worldFunctionType == 25)
		{
			MonthlyActionKey key = new MonthlyActionKey(2, 0);
			Domain.HandleMonthlyAction(Domain.MainThreadDataContext, key);
		}
	}

	public static XiangshuAvatarTaskStatus GetXiangshuAvatarTaskStatus(sbyte xiangshuAvatarId)
	{
		return DomainManager.World.GetElement_XiangshuAvatarTaskStatuses(xiangshuAvatarId);
	}

	public static void SetJuniorXiangshuTaskStatus(sbyte xiangshuAvatarId, sbyte taskStatus)
	{
		if (xiangshuAvatarId >= 9)
		{
			throw new Exception("Invalid xiangshu avatarId to set task status");
		}
		XiangshuAvatarTaskStatus element_XiangshuAvatarTaskStatuses = DomainManager.World.GetElement_XiangshuAvatarTaskStatuses(xiangshuAvatarId);
		element_XiangshuAvatarTaskStatuses.JuniorXiangshuTaskStatus = taskStatus;
		DomainManager.World.SetElement_XiangshuAvatarTaskStatuses(xiangshuAvatarId, element_XiangshuAvatarTaskStatuses, Domain.MainThreadDataContext);
	}

	public static void SetXiangshuDisplayStatus(sbyte xiangshuAvatarId, sbyte displayStatus)
	{
		Domain.SetRightRoleXiangshuDisplayData(new sbyte[2] { xiangshuAvatarId, displayStatus }, Domain.MainThreadDataContext);
	}

	public static string GetCurrentMonthName()
	{
		sbyte currMonthInYear = DomainManager.World.GetCurrMonthInYear();
		return Month.Instance[currMonthInYear].Name;
	}

	public static bool AdvancingMonthStateNotInProcess()
	{
		return DomainManager.World.GetAdvancingMonthState() == 0;
	}

	public static bool SmallVillageXiangshu(short orgTemplateId)
	{
		return GameData.Domains.World.SharedMethods.SmallVillageXiangshu(orgTemplateId);
	}

	public static void AdvanceDays(sbyte days)
	{
		DomainManager.World.AdvanceDaysInMonth(Domain.MainThreadDataContext, days);
	}

	public static void ClearTrivialMonthlyEvents()
	{
		DomainManager.World.ClearTrivialMonthlyEvents(Domain.MainThreadDataContext);
	}

	public static void Log(string logInfo)
	{
		AdaptableLog.Info(logInfo);
	}

	public static void ToEvent(string toEventGuid)
	{
		Domain.ToEvent(toEventGuid);
	}

	public static void AddOptionToEvent(string targetEventGuid, string srcEventGuid, string optionKey)
	{
		if (!string.IsNullOrEmpty(targetEventGuid) && !string.IsNullOrEmpty(srcEventGuid) && !string.IsNullOrEmpty(optionKey))
		{
			Domain.GetEvent(targetEventGuid)?.AddOption((srcEventGuid, optionKey));
		}
	}

	public static bool IsTriggeredEvent(string targetEventGuid)
	{
		return Domain.IsTriggeredEvent(targetEventGuid);
	}

	public static int GetEventTriggeredCount(string targetEventGuid)
	{
		return Domain.GetEventTriggeredCount(targetEventGuid);
	}

	public static void SetStopAutoNextEvent(bool stopFlag)
	{
		Domain.SetStopAutoNextEvent(stopFlag);
	}

	[Obsolete]
	public static void AddEventInListen(string eventGuid, EventArgBox argBox)
	{
		Domain.SetListener(eventGuid, argBox);
	}

	public static void AddEventInListenWithActionName(string eventGuid, EventArgBox argBox, string actionName)
	{
		Domain.SetListenerWithActionName(eventGuid, argBox, actionName);
	}

	public static void RemoveEventInListenWithActionName(string eventGuid, string actionName)
	{
		Domain.RemoveEventInListenWithActionName(eventGuid, actionName);
	}

	public static void SetInteractionCooldown(int targetCharId, int interactionType, int cooldown)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.SetTaiwuInteractionCooldown(mainThreadDataContext, targetCharId, interactionType, cooldown);
	}

	public static void RemoveInteractionCooldown(int targetCharId, int interactionType)
	{
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		DomainManager.Extra.RemoveTaiwuInteractionCooldown(mainThreadDataContext, targetCharId, interactionType);
	}

	public static int GetInteractionCooldown(int targetCharId, int interactionType)
	{
		return DomainManager.Extra.GetTaiwuInteractionCooldown(targetCharId, interactionType);
	}

	public static bool IsInteractionInCooldown(int targetCharId, int interactionType)
	{
		return GetInteractionCooldown(targetCharId, interactionType) > 0;
	}

	public static bool CheckProbability(int value)
	{
		return Domain.MainThreadDataContext.Random.CheckPercentProb(value);
	}

	public static int GetRandom(int min = 0, int max = 100)
	{
		return Domain.MainThreadDataContext.Random.Next(min, max);
	}

	public static T Sample<T>(this IList<T> list)
	{
		if (list == null || list.Count <= 0)
		{
			return default(T);
		}
		return list[Domain.MainThreadDataContext.Random.Next(0, list.Count)];
	}

	public static string HandleStringTag(string targetString, EventArgBox box, TaiwuEvent eventData)
	{
		return TaiwuEventTagHandler.DecodeTag(targetString, box, eventData);
	}

	public static string GetCharacterName(int charId, bool realName = false)
	{
		return DomainManager.Character.GetName(charId, realName);
	}

	public static short GetTotalVillagerCount()
	{
		return DomainManager.Taiwu.GetTotalVillagerCount();
	}

	public static short GetAvailableVillagerCount()
	{
		return DomainManager.Taiwu.GetAvailableVillagerCount();
	}

	public static short GetWorkingVillagerCount()
	{
		return DomainManager.Taiwu.GetWorkingVillagerCount();
	}

	public static bool[] GetRoleBookReadState(int roleId, ItemKey bookItemKey)
	{
		return DomainManager.Character.GetCharBookReadState(roleId, bookItemKey);
	}

	public static int[] GetRandomCellFromWeightCore(IList<int[]> list)
	{
		return RandomUtils.GenerateRandomWeightCell(Domain.MainThreadDataContext.Random, list);
	}

	public static short[] GetRandomCellFromWeightCore(IList<short[]> list)
	{
		return RandomUtils.GenerateRandomWeightCell(Domain.MainThreadDataContext.Random, list);
	}

	public static List<short[]> GetRandomListFromWeightCore(IList<short[]> list, int count)
	{
		List<short[]> result = new List<short[]>();
		RandomUtils.GenerateRandomWeightCellList(Domain.MainThreadDataContext.Random, list, count, ref result);
		return result;
	}

	public static void StartLifeSkillCombat(int characterId, sbyte lifeSKillType, string onFinishEventId, EventArgBox argBox)
	{
		Events.RaiseLifeSkillCombatStarted(Domain.MainThreadDataContext);
		Domain.SetListenerWithActionName(onFinishEventId, argBox, "LifeSkillBattleComplete");
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenLifeSkillCombat, characterId, lifeSKillType, arg3: false);
	}

	public static void StartLifeSkillCombatHideTaiwuAudience(int characterId, sbyte lifeSKillType, string onFinishEventId, EventArgBox argBox)
	{
		Events.RaiseLifeSkillCombatStarted(Domain.MainThreadDataContext);
		Domain.SetListenerWithActionName(onFinishEventId, argBox, "LifeSkillBattleComplete");
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenLifeSkillCombat, characterId, lifeSKillType, arg3: true);
	}

	public static void StartLifeSkillCombatWithRandomEnemy(short templateId, sbyte lifeSKillType, string onFinishEventId, EventArgBox argBox)
	{
		int num = CreateNonIntelligentCharacter(templateId);
		argBox.Set("EnemyId", num);
		StartLifeSkillCombat(num, lifeSKillType, onFinishEventId, argBox);
	}

	public static void StartCricketCombat(int enemyId, string onFinishEventId, EventArgBox argBox)
	{
		AddCricketBattleDisplayEvent(enemyId, onFinishEventId, argBox, withConfig: false, doubleDamage: false, onlyNoInjuryCricket: false, 0, 8);
	}

	public static void StartCricketCombatWithConfig(int characterId, bool doubleDamage, bool onlyNoInjuryCricket, sbyte minGrade, sbyte maxGrade, string onFinishEventId, EventArgBox argBox)
	{
		AddCricketBattleDisplayEvent(characterId, onFinishEventId, argBox, withConfig: true, doubleDamage, onlyNoInjuryCricket, minGrade, maxGrade);
	}

	public static void AddCricketBattleDisplayEvent(int enemyId, string onFinishEventId, EventArgBox argBox, bool withConfig = false, bool doubleDamage = false, bool onlyNoInjuryCricket = false, sbyte minGrade = 0, sbyte maxGrade = 8)
	{
		EventCricketBettingData cricketBettingData = DomainManager.TaiwuEvent.GetCricketBettingData();
		if (cricketBettingData.IsConfirmed)
		{
			cricketBettingData.IsComplete = false;
			cricketBettingData.IsConfirmed = false;
			SetInteractionCooldown(enemyId, 7);
			Events.RaiseCricketCombatStarted(Domain.MainThreadDataContext);
			Domain.SetListenerWithActionName(onFinishEventId, argBox, "CricketCombatOver");
			if (withConfig)
			{
				GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenCricketBattleWithConfig, enemyId, cricketBettingData.Wager, cricketBettingData.BetRewards[cricketBettingData.Index], doubleDamage, onlyNoInjuryCricket, minGrade, maxGrade);
			}
			else
			{
				GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenCricketBattle, enemyId, cricketBettingData.Wager, cricketBettingData.BetRewards[cricketBettingData.Index]);
			}
		}
		else if (!cricketBettingData.IsComplete)
		{
			DomainManager.Item.SetCricketBattleConfig(minGrade, maxGrade, onlyNoInjuryCricket);
			GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
			int id = taiwu.GetId();
			cricketBettingData.IsValid = true;
			cricketBettingData.BetRewards = DomainManager.Item.SelectCricketWagers(Domain.MainThreadDataContext, enemyId);
			cricketBettingData.BetItems = DomainManager.Character.GetAllInventoryItems(id);
			cricketBettingData.BetCharacters = new List<CharacterDisplayData>();
			cricketBettingData.BetCharacterValueMap.Clear();
			cricketBettingData.BetItems.Insert(0, new ItemDisplayData());
			for (sbyte b = 0; b < 8; b++)
			{
				int resource = taiwu.GetResource(b);
				if (resource > 0)
				{
					short templateId = Convert.ToInt16(321 + b);
					ItemKey key = new ItemKey(12, 0, templateId, 0);
					ItemDisplayData item = new ItemDisplayData
					{
						Key = key,
						Amount = resource
					};
					cricketBettingData.BetItems.Add(item);
				}
			}
			foreach (int item2 in DomainManager.Taiwu.GetGroupCharIds().GetCollection())
			{
				if (IsCharacterAdult(item2) && item2 != id && item2 != enemyId)
				{
					cricketBettingData.BetCharacters.Add(DomainManager.Character.GetCharacterDisplayData(item2));
				}
			}
			if (DomainManager.Character.TryGetKidnappedCharacters(id, out var list))
			{
				foreach (KidnappedCharacter item3 in list.GetCollection())
				{
					if (IsCharacterAdult(item3.CharId) && item3.CharId != enemyId)
					{
						cricketBettingData.BetCharacters.Add(DomainManager.Character.GetCharacterDisplayData(item3.CharId));
					}
				}
			}
			foreach (CharacterDisplayData betCharacter in cricketBettingData.BetCharacters)
			{
				GameData.Domains.Character.Character element_Objects = DomainManager.Character.GetElement_Objects(betCharacter.CharacterId);
				cricketBettingData.BetCharacterValueMap[betCharacter.CharacterId] = Wager.CreateChar(betCharacter.CharacterId).CalcWagerValue(0, element_Objects.GetFame(), element_Objects.GetAttraction(), element_Objects.GetPhysiologicalAge(), element_Objects.GetGender(), element_Objects.GetOrganizationInfo().Grade);
			}
		}
		else
		{
			cricketBettingData.IsComplete = false;
		}
		Domain.SetCricketBettingData(cricketBettingData, Domain.MainThreadDataContext);
	}

	public static void StartShavingAction(int cutterCharId, int targetCharId, string shavingFinishEventId, EventArgBox argBox)
	{
		Domain.SetListenerWithActionName(shavingFinishEventId, argBox, "CharacterShaveComplete");
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.StartShavingActionByEvent, cutterCharId, targetCharId, -1);
	}

	public static void StartShavingActionWithTimeLimit(int cutterCharId, int targetCharId, string shavingFinishEventId, int time, EventArgBox argBox)
	{
		Domain.SetListenerWithActionName(shavingFinishEventId, argBox, "CharacterShaveComplete");
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.StartShavingActionByEvent, cutterCharId, targetCharId, time);
	}

	public static bool IsFunctionUnlock(byte functionId)
	{
		return DomainManager.World.GetWorldFunctionsStatus(functionId);
	}

	public static void PlayCg(string cgName, string onCompleteEventId, EventArgBox argBox)
	{
		Domain.SetListenerWithActionName(onCompleteEventId, argBox, "CgPlayActionFinish");
		Domain.SetCgName(cgName, Domain.MainThreadDataContext);
	}

	public static void StartDoctorAction(int charId, string onCompleteEventId = "", EventArgBox argBox = null, bool expensiveHeal = false)
	{
		Domain.SetListenerWithActionName(onCompleteEventId, argBox, "HealActionComplete");
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.StartDoctorHeal, charId, expensiveHeal);
	}

	public static bool HasEvent(string guid)
	{
		return Domain.GetEvent(guid) != null;
	}

	public static bool IsAvailableCharacterId(int charId)
	{
		return GameData.Domains.Character.Character.IsCharacterIdValid(charId);
	}

	public static MonthlyEventCollection GetMonthlyEventCollection()
	{
		return DomainManager.World.GetMonthlyEventCollection();
	}

	public static LifeRecordCollection GetLifeRecordCollection()
	{
		return DomainManager.LifeRecord.GetLifeRecordCollection();
	}

	public static TravelingEventCollection GetTravelingEventCollection()
	{
		return DomainManager.Extra.GetTravelingEventCollection();
	}

	public static void CommitLifeRecords()
	{
		DomainManager.LifeRecord.CommitCurrLifeRecords();
	}

	public static void SetOnHandlingMonthlyEventBlock(bool blockOperation)
	{
		DomainManager.World.SetOnHandingMonthlyEventBlock(blockOperation, Domain.MainThreadDataContext);
	}

	public static void SetAssassinationTarget(string charName)
	{
		if (string.IsNullOrEmpty(charName))
		{
			throw new Exception("can not set empty character name to Assassination");
		}
		DomainManager.Character.SetTargetedForAssassination(charName, Domain.MainThreadDataContext);
	}

	[Obsolete("Use SetCooldown instead")]
	public static void LogCharacterInteractDate(int charId, string logKeyPrefix)
	{
		int currDate = DomainManager.World.GetCurrDate();
		string key = $"{logKeyPrefix}_{charId}";
		GetGlobalArgBox().Set(key, currDate);
	}

	public static void SetInteractionCooldown(int targetCharId, short optionTemplateId)
	{
		DomainManager.TaiwuEvent.SetInteractionEventOptionCooldown(targetCharId, optionTemplateId);
	}

	public static void SetEventSeriesTexture(string textureName)
	{
		Domain.SeriesEventTexture = textureName;
	}

	public static int GetGameDate()
	{
		return DomainManager.World.GetCurrDate();
	}

	public static sbyte GetCurrMonthInYear()
	{
		return DomainManager.World.GetCurrMonthInYear();
	}

	public static int GetDaysLeftInCurrentMonth()
	{
		return DomainManager.World.GetLeftDaysInCurrMonth();
	}

	public static void OpenPictureShowPage(string picturePath, string textureType, string countDownActionName, int intParam = -1, float countDownTime = -1f, string modName = "")
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenPictureShow, picturePath, textureType, countDownActionName, intParam, countDownTime, modName);
	}

	public static void SetEventCgTextureData(string texturePath, float tweenTime, string modName = "")
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.ShowEventCgTexture, texturePath, tweenTime);
	}

	public static void BlockEventLogImmediateStatusCheck()
	{
		Domain.BlockEventLogImmediateStatusCheck();
	}

	public static void ShowGetItemPageForItems(List<(ItemKey, int)> itemList, string afterEvent = "", EventArgBox argBox = null, bool autoToWareHouse = false)
	{
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "GetItemShowed");
		}
		List<ItemDisplayData> list = new List<ItemDisplayData>();
		ItemList2DisplayData(itemList, list);
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenGetItem_Item, list, autoToWareHouse, arg3: false, arg4: true);
		if (!string.IsNullOrEmpty(afterEvent) && argBox != null)
		{
			Domain.CheckTaiwuStatusImmediately();
		}
	}

	public static void ShowGetItemPageForItems(List<(ItemKey, int)> itemList, List<(ItemKey, int)> resourceList, string afterEvent = "", EventArgBox argBox = null, bool autoToWareHouse = false)
	{
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "GetItemShowed");
		}
		List<ItemDisplayData> list = new List<ItemDisplayData>();
		ItemList2DisplayData(itemList, list);
		ResourceList2DisplayData(resourceList, list);
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenGetItem_Item, list, autoToWareHouse, arg3: false, arg4: true);
		if (!string.IsNullOrEmpty(afterEvent) && argBox != null)
		{
			Domain.CheckTaiwuStatusImmediately();
		}
	}

	private static void ItemList2DisplayData(List<(ItemKey, int)> itemList, List<ItemDisplayData> resultList)
	{
		resultList.AddRange(DomainManager.Item.GetItemDisplayDataList(itemList.ConvertAll(((ItemKey, int) e) => e.Item1), DomainManager.Taiwu.GetTaiwuCharId()));
		foreach (ItemDisplayData data in resultList)
		{
			int num = itemList.FindIndex(((ItemKey, int) e) => e.Item1.Equals(data.Key));
			if (num >= 0)
			{
				data.Amount = itemList[num].Item2;
			}
		}
	}

	private static void ResourceList2DisplayData(List<(ItemKey, int)> resourceList, List<ItemDisplayData> resultList)
	{
		for (int i = 0; i < resourceList.Count; i++)
		{
			ItemDisplayData itemDisplayData = new ItemDisplayData(resourceList[i].Item1.ItemType, resourceList[i].Item1.TemplateId);
			itemDisplayData.Amount = resourceList[i].Item2;
			resultList.Add(itemDisplayData);
		}
	}

	public static void ShowGetItemPageForSingleItem(ItemKey itemKey)
	{
		ItemDisplayData itemDisplayData = DomainManager.Item.GetItemDisplayData(itemKey);
		List<ItemDisplayData> arg = new List<ItemDisplayData> { itemDisplayData };
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenGetItem_Item, arg);
	}

	public static void ShowWarehouse(ItemSourceType itemSourceType, string afterEvent = "", EventArgBox argBox = null)
	{
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "WarehouseShowed");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenWarehouse, (int)itemSourceType);
	}

	public static void ShowGetItemAgainPageForItems(List<(ItemKey, int)> itemList, string afterEvent = "", EventArgBox argBox = null, bool autoToWareHouse = false)
	{
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "GetItemShowed");
		}
		List<ItemDisplayData> itemDisplayDataList = DomainManager.Item.GetItemDisplayDataList(itemList.ConvertAll(((ItemKey, int) e) => e.Item1), DomainManager.Taiwu.GetTaiwuCharId());
		foreach (ItemDisplayData data in itemDisplayDataList)
		{
			int num = itemList.FindIndex(((ItemKey, int) e) => e.Item1.Equals(data.Key));
			if (num >= 0)
			{
				data.Amount = itemList[num].Item2;
			}
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenGetItem_Item, itemDisplayDataList, autoToWareHouse, arg3: false, arg4: false);
	}

	public static void ShowSectMainStoryEndScroll(short orgTemplateId, bool goodEnd, string afterEvent = "", EventArgBox argBox = null)
	{
		InstantNotificationCollection instantNotificationCollection = DomainManager.World.GetInstantNotificationCollection();
		short settlementIdByOrgTemplateId = DomainManager.Organization.GetSettlementIdByOrgTemplateId((sbyte)orgTemplateId);
		if (goodEnd)
		{
			instantNotificationCollection.AddSettlementStoryGoodEnd(settlementIdByOrgTemplateId);
		}
		else
		{
			instantNotificationCollection.AddSettlementStoryBadEnd(settlementIdByOrgTemplateId);
		}
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "SectMainStoryScrollShowed");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.SectMainStoryEndScroll, orgTemplateId, goodEnd);
	}

	public static void ShowSelectMapArea(string afterEvent, EventArgBox argBox)
	{
		Domain.SetListenerWithActionName(afterEvent, argBox, "SelectMapAreaOver");
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenSelectMapArea);
	}

	public static void CloseCharacterMenu()
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.CloseCharacterMenu);
	}

	public static void ShowGetItemPageForChicken(short chickenTemplateId, string afterEvent = "", EventArgBox argBox = null)
	{
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "GetItemShowed");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenGetItem_Chicken, chickenTemplateId);
	}

	public static void ShowGetItemPageForCharacters(List<int> charIdList, bool isVillager, string afterEvent = "", EventArgBox argBox = null)
	{
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "GetItemShowed");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenGetItem_Character, charIdList, isVillager);
	}

	public static void ShowTaiwuGetSecretInformation(int metaId, string afterEvent = "", EventArgBox argBox = null)
	{
		if (!string.IsNullOrEmpty(afterEvent))
		{
			AddEventInListenWithActionName(afterEvent, argBox, "GetItemShowed");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenGetItem_SecretInformation, metaId);
	}

	public static void SetLeftRoleNameKey(string nameKey)
	{
		Domain.SetLeftRoleAlternativeName(nameKey, Domain.MainThreadDataContext);
	}

	public static void SetRightRoleNameKey(string nameKey)
	{
		Domain.SetRightRoleAlternativeName(nameKey, Domain.MainThreadDataContext);
	}

	public static void AddAudioCommand(string audioName, bool isMusic, bool isLoop)
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.PlayAudioCommand, audioName, isMusic, isLoop);
	}

	public static void SetMainStoryBgm(string audioName)
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.SetMainStoryBgm, audioName);
	}

	public static void AddMediaCommand(string mediaName, bool canJump, string onFinishAction, int intParam = -1)
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.PlayMediaCommand, mediaName, canJump, onFinishAction, intParam);
	}

	public static bool GetRestrictOptionsBehaviorType()
	{
		return DomainManager.World.GetRestrictOptionsBehaviorType();
	}

	public static bool GetHasFinishedGameEver()
	{
		return DomainManager.Global.GetGlobalFlag(0);
	}

	public static void SetHasFinishedGame()
	{
		DomainManager.Global.SetGlobalFlag(Domain.MainThreadDataContext, 0, value: true);
	}

	public static void SetHasFinishedPastPerformArea()
	{
		DomainManager.Global.SetGlobalFlag(Domain.MainThreadDataContext, 1, value: true);
	}

	public static void GetHasDreamBackArchive(Action<bool> onGetExistAction)
	{
		string text = Path.Combine(GameData.ArchiveData.Common.ArchiveBaseDir, $"world_{GetCurrentArchiveId() + 1}/local.sav.sp");
		Log("" + File.Exists(text) + "" + text);
		onGetExistAction(File.Exists(text));
	}

	public static void SaveArchiveForDreamBack()
	{
		SaveGlobalArg("IsDreamBackArchive", value: true);
		DomainManager.Global.SaveEnding(Domain.MainThreadDataContext);
		RemoveFromGlobalArgBox<bool>("IsDreamBackArchive");
	}

	public static sbyte GetCurrentArchiveId()
	{
		return GameData.ArchiveData.Common.GetCurrArchiveId();
	}

	public static bool IsApologeticGiftDlcExist()
	{
		return true;
	}

	public static bool IsDlcInstalled(uint dlcAppId)
	{
		return DlcManager.IsDlcInstalled(dlcAppId);
	}

	public static void SetItemListOfLeft(int charId, ItemKey[] itemKeyArray)
	{
		if (itemKeyArray == null)
		{
			Domain.SetItemListOfLeft(new ItemDisplayData[3], Domain.MainThreadDataContext);
			return;
		}
		List<ItemDisplayData> itemDisplayDataList = DomainManager.Item.GetItemDisplayDataList(new List<ItemKey>(itemKeyArray), charId);
		Domain.SetItemListOfLeft(itemDisplayDataList.ToArray(), Domain.MainThreadDataContext);
	}

	public static void SetItemListOfRight(int charId, ItemKey[] itemKeyArray)
	{
		if (itemKeyArray == null)
		{
			Domain.SetItemListOfRight(new ItemDisplayData[3], Domain.MainThreadDataContext);
			return;
		}
		List<ItemDisplayData> itemDisplayDataList = DomainManager.Item.GetItemDisplayDataList(new List<ItemKey>(itemKeyArray), charId);
		Domain.SetItemListOfRight(itemDisplayDataList.ToArray(), Domain.MainThreadDataContext);
	}

	public static void SetCoverCricketJarGradeList(List<sbyte> gradeList)
	{
		Domain.SetCoverCricketJarGradeListForRight(gradeList, Domain.MainThreadDataContext);
	}

	public static void SetItemShowForCricketBattleGuess(bool flag)
	{
		Domain.SetShowItemWithCricketBattleGuess(flag, Domain.MainThreadDataContext);
	}

	public static void SetLockInputState(bool flag)
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.SetEventLockInputState, flag);
	}

	public static int GetOptionVisibleCountInRange(string guid, EventArgBox argBox, int startIndex, int endIndex)
	{
		TaiwuEvent taiwuEvent = DomainManager.TaiwuEvent.GetEvent(guid);
		taiwuEvent.ArgBox = argBox;
		TaiwuEventOption[] eventOptions = taiwuEvent.EventConfig.EventOptions;
		int num = 0;
		for (int i = startIndex; i <= endIndex; i++)
		{
			if (eventOptions[i].IsVisible)
			{
				num++;
			}
		}
		return num;
	}

	public static int GetExtendOptionVisibleCount(string guid, EventArgBox argBox)
	{
		TaiwuEvent taiwuEvent = DomainManager.TaiwuEvent.GetEvent(guid);
		int num = 0;
		for (int i = 0; i < taiwuEvent.ExtendEventOptions.Count; i++)
		{
			(string, string) tuple = taiwuEvent.ExtendEventOptions[i];
			TaiwuEvent taiwuEvent2 = DomainManager.TaiwuEvent.GetEvent(tuple.Item1);
			taiwuEvent2.ArgBox = argBox;
			TaiwuEventOption taiwuEventOption = taiwuEvent2.EventConfig[tuple.Item2];
			if (taiwuEventOption.IsVisible)
			{
				num++;
			}
		}
		return num;
	}

	public static int GetOptionCount(string guid)
	{
		TaiwuEvent taiwuEvent = DomainManager.TaiwuEvent.GetEvent(guid);
		return taiwuEvent.EventConfig.EventOptions.Length;
	}

	public static void ShowDialogFromEvent(string dialogTitle, string dialogContent, sbyte dialogType, string nextEventGuid = "", EventArgBox argBox = null)
	{
		if (!string.IsNullOrEmpty(nextEventGuid))
		{
			AddEventInListenWithActionName(nextEventGuid, argBox, "DialogChoiceMade");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.ShowDialogFromEvent, dialogTitle, dialogContent, dialogType);
	}

	public static void CheckSensitiveWord(string checkStr, string nextEventGuid = "", EventArgBox argBox = null)
	{
		if (!string.IsNullOrEmpty(nextEventGuid))
		{
			AddEventInListenWithActionName(nextEventGuid, argBox, "CheckSensitiveWord");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.CheckSensitiveWord, checkStr);
	}

	public static void ShowEventConfirmWindow(string titleLanguageKey, string contentLanguageKey, bool showBtnNo = true, string extraFormatString = "", string nextEventGuid = "", EventArgBox argBox = null)
	{
		if (!string.IsNullOrEmpty(nextEventGuid))
		{
			AddEventInListenWithActionName(nextEventGuid, argBox, "DialogChoiceMade");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.ShowEventConfirmWindow, titleLanguageKey, contentLanguageKey, showBtnNo, extraFormatString);
	}

	public static void OpenSelectLegacy(string nextEventGuid = "", EventArgBox argBox = null)
	{
		if (!string.IsNullOrEmpty(nextEventGuid))
		{
			AddEventInListenWithActionName(nextEventGuid, argBox, "SelectLegacyComplete");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenSelectLegacy);
	}

	public static void OpenCombatConflict()
	{
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenCombatConflict);
	}

	public static string GetCharacterFeatureDesc(short featureId)
	{
		return CharacterFeature.Instance[featureId].Desc;
	}

	public static void OpenYuanshanMiniGame(int stage, string nextEventGuid = "", EventArgBox argBox = null)
	{
		if (stage < 0 || stage >= 3)
		{
			throw new Exception($"YuanshanMiniGame stage = {stage} out of range [0,3)");
		}
		if (!string.IsNullOrEmpty(nextEventGuid))
		{
			AddEventInListenWithActionName(nextEventGuid, argBox, "FinishYuanshanMiniGame");
		}
		uint arg = 3u;
		if (DomainManager.Extra.IsExtraTaskInProgress(398))
		{
			arg = 2u;
		}
		else if (DomainManager.Extra.IsExtraTaskInProgress(395))
		{
			arg = 1u;
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.ShowYuanshanMiniGame, stage, arg);
	}

	public static int ProcessYuanshanMiniGameResults(EventArgBox argBox)
	{
		int arg = 0;
		if (!argBox.Get("YuanshanMiniGameStage", ref arg))
		{
			arg = 0;
		}
		return arg;
	}

	public static void AddFuyuFaith(GameData.Domains.Character.Character character, int value)
	{
		character.ExtendDarkAshWithFuyuFaith(Domain.MainThreadDataContext, value);
	}

	public static void OpenCraftsmanPanelUI(int charId, sbyte craftsmanPanelType, string nextEventGuid, EventArgBox argBox)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var _))
		{
			if (!string.IsNullOrEmpty(nextEventGuid))
			{
				AddEventInListenWithActionName(nextEventGuid, argBox, "FinishCraftsmanPanelUI");
			}
			GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenCraftsmanPanelUI, charId, craftsmanPanelType);
		}
	}

	public static void OpenCityPunishmentSeverityCustomizeUI(int charId, string nextEventGuid, EventArgBox argBox)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return;
		}
		Settlement settlement = DomainManager.Organization.GetSettlement(element.GetOrganizationInfo().SettlementId);
		if (settlement != null)
		{
			sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(settlement.GetLocation().AreaId);
			bool arg = settlement is Sect;
			if (!string.IsNullOrEmpty(nextEventGuid))
			{
				AddEventInListenWithActionName(nextEventGuid, argBox, "FinishCityPunishmentSeverityCustomizeUI");
			}
			argBox.Set("AreaId", settlement.GetLocation().AreaId);
			bool hasVillageHead;
			(int, int) specialCustomizedSeverityRangeAndAvailableAmount = DomainManager.Extra.GetSpecialCustomizedSeverityRangeAndAvailableAmount(settlement.GetId(), out hasVillageHead);
			GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenCityPunishmentSeverityCustomizeUI, stateTemplateIdByAreaId, arg, specialCustomizedSeverityRangeAndAvailableAmount.Item1, specialCustomizedSeverityRangeAndAvailableAmount.Item2, hasVillageHead);
		}
	}

	public static void OpenSpiritualDebtInteractionShaolin(int charId, string nextEventGuid = "", EventArgBox argBox = null)
	{
		if (!string.IsNullOrEmpty(nextEventGuid))
		{
			AddEventInListenWithActionName(nextEventGuid, argBox, "FinishSpiritualDebtInteractionShaolin");
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.OpenSpiritualDebtInteractionShaolin, charId);
	}

	public static void SpiritualDebtInteractionWudang(short combatSkillTemplateId, int count)
	{
		GameData.Domains.Character.Character taiwu = DomainManager.Taiwu.GetTaiwu();
		DataContext mainThreadDataContext = Domain.MainThreadDataContext;
		CombatSkillItem skillCfg = Config.CombatSkill.Instance[combatSkillTemplateId];
		for (int i = 0; i < count; i++)
		{
			var (obtainedNeili, num, extraNeiliAllocationProgress) = CombatSkillDomain.CalcNeigongLoopingEffect(mainThreadDataContext.Random, taiwu, skillCfg, includeReference: false);
			DomainManager.CombatSkill.ApplyNeigongLoopingEffect(mainThreadDataContext, taiwu, combatSkillTemplateId, obtainedNeili, extraNeiliAllocationProgress);
			if (num != 0)
			{
				taiwu.ChangeDisorderOfQiRandomRecovery(mainThreadDataContext, num);
			}
		}
	}

	public static void SpiritualDebtInteractionRanshan(int bookId, int count)
	{
		if (DomainManager.Item.TryGetElement_SkillBooks(bookId, out var element))
		{
			List<int> charIds = new List<int> { DomainManager.Taiwu.GetTaiwuCharId() };
			bool isCombatSkill = element.IsCombatSkillBook();
			for (int i = 0; i < count; i++)
			{
				DomainManager.Extra.ReadBook(Domain.MainThreadDataContext, bookId, charIds, isCombatSkill, out var _);
			}
		}
	}

	public static void SpiritualDebtInteractionShaolin(int charId, EventArgBox argBox)
	{
		argBox.Get<GameData.Utilities.ShortList>("SelectedFameActions", out GameData.Utilities.ShortList arg);
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return;
		}
		foreach (short item in arg.Items)
		{
			FameActionItem fameActionItem = FameAction.Instance[item];
			ChangeFameActionDuration(element, item, -fameActionItem.ReductionTime, isCostAuthority: true);
		}
	}

	public static IEnumerable<(GameData.Domains.Character.Character Character, short Favor)> GetGuardsAndFavors(short settlementId, sbyte guardLayer)
	{
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		if (settlement == null)
		{
			AdaptableLog.TagWarning("EventHelper", $"Settlement {settlementId} is null.", appendWarningMessage: true);
			yield break;
		}
		foreach (var guardsAndFavor in settlement.GetGuardsAndFavors(Domain.MainThreadDataContext, Math.Clamp(guardLayer, 0, 2)))
		{
			yield return guardsAndFavor;
		}
	}

	public static (byte, sbyte) ReadGuardStatus(EventArgBox eventArgBox)
	{
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		return ((location.IsValid() && DomainManager.Organization.GetSettlementByOrgTemplateId(MapDomain.GetSectOrgTemplateIdByStateTemplateId(DomainManager.Map.GetStateTemplateIdByAreaId(location.AreaId))) is Sect sect) ? sect.PrisonEnteredStatus : ((byte)eventArgBox.GetInt("CustomStatus")), (sbyte)eventArgBox.GetInt("CurrentPage"));
	}

	public static void WriteGuardStatus(byte enterState, sbyte currPage)
	{
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		if (location.IsValid() && DomainManager.Organization.GetSettlementByOrgTemplateId(MapDomain.GetSectOrgTemplateIdByStateTemplateId(DomainManager.Map.GetStateTemplateIdByAreaId(location.AreaId))) is Sect sect)
		{
			sect.PrisonEnteredStatus = enterState;
		}
		GameData.GameDataBridge.GameDataBridge.AddDisplayEvent(DisplayEventType.SwitchGuardedPageStatus, enterState, currPage);
	}

	public static void WriteGuardStatusDirectly(EventArgBox eventArgBox, byte enterState)
	{
		eventArgBox.Set("CustomStatus", enterState);
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		if (location.IsValid() && DomainManager.Organization.GetSettlementByOrgTemplateId(MapDomain.GetSectOrgTemplateIdByStateTemplateId(DomainManager.Map.GetStateTemplateIdByAreaId(location.AreaId))) is Sect sect)
		{
			sect.PrisonEnteredStatus = enterState;
		}
	}

	public static void WriteGuardStatusForEvent(EventArgBox eventArgBox, string guid)
	{
		Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
		eventArgBox.Set("CustomStatus", (location.IsValid() && DomainManager.Organization.GetSettlementByOrgTemplateId(MapDomain.GetSectOrgTemplateIdByStateTemplateId(DomainManager.Map.GetStateTemplateIdByAreaId(location.AreaId))) is Sect sect) ? sect.PrisonEnteredStatus : 0);
		eventArgBox.Set("CurrentPage", 0);
		eventArgBox.Set("OpenSettlementPrison", arg: true);
		if (guid != null)
		{
			ToEvent(guid);
		}
	}

	public static void AbandonToNearbySettlement(GameData.Domains.Character.Character baby, int motherCharId, bool nearTaiwuVillage = true)
	{
		DomainManager.Character.AbandonToNearbySettlement(Domain.MainThreadDataContext, baby, motherCharId, nearTaiwuVillage);
	}

	public static void AbandonToNearbySettlement(GameData.Domains.Character.Character baby, int motherCharId, short settlementId)
	{
		DomainManager.Character.AbandonToNearbySettlement(Domain.MainThreadDataContext, baby, motherCharId, settlementId);
	}

	public static void AssignChildToAdopter(GameData.Domains.Character.Character adopter, GameData.Domains.Character.Character adoptedChild, int motherCharId)
	{
		DomainManager.Character.AssignChildToAdopter(Domain.MainThreadDataContext, adopter, adoptedChild, motherCharId);
	}

	public static int GetRandomValidAdopterInSettlement(short settlementId)
	{
		return DomainManager.Character.GetRandomValidAdopterInSettlement(Domain.MainThreadDataContext.Random, DomainManager.Organization.GetSettlement(DomainManager.Taiwu.GetTaiwuVillageSettlementId()));
	}

	public static void SetCharacterUnamedStatus(GameData.Domains.Character.Character character, bool unamed)
	{
		character.SetCharacterUnamedStatus(Domain.MainThreadDataContext, unamed);
	}
}
