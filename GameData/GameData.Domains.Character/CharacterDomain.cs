using System;
using System.Collections;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Runtime.CompilerServices;
using System.Text;
using System.Threading.Tasks;
using Config;
using Config.ConfigCells;
using Config.ConfigCells.Character;
using GameData.ArchiveData;
using GameData.Combat.Math;
using GameData.Common;
using GameData.Common.SingleValueCollection;
using GameData.DLC;
using GameData.DLC.FiveLoong;
using GameData.Dependencies;
using GameData.DomainEvents;
using GameData.Domains.Adventure;
using GameData.Domains.Building;
using GameData.Domains.Character.Ai;
using GameData.Domains.Character.Ai.PrioritizedAction;
using GameData.Domains.Character.AvatarSystem;
using GameData.Domains.Character.AvatarSystem.AvatarRes;
using GameData.Domains.Character.Creation;
using GameData.Domains.Character.Display;
using GameData.Domains.Character.Filters;
using GameData.Domains.Character.ParallelModifications;
using GameData.Domains.Character.Relation;
using GameData.Domains.Character.Relation.RelationTree;
using GameData.Domains.Character.SortFilter;
using GameData.Domains.Character.TemporaryModification;
using GameData.Domains.Combat;
using GameData.Domains.CombatSkill;
using GameData.Domains.Extra;
using GameData.Domains.Global;
using GameData.Domains.Global.Inscription;
using GameData.Domains.Information;
using GameData.Domains.Information.Collection;
using GameData.Domains.Item;
using GameData.Domains.Item.Display;
using GameData.Domains.Item.Filters;
using GameData.Domains.LifeRecord;
using GameData.Domains.Map;
using GameData.Domains.Map.Filters;
using GameData.Domains.Merchant;
using GameData.Domains.Organization;
using GameData.Domains.Taiwu;
using GameData.Domains.Taiwu.Profession;
using GameData.Domains.Taiwu.Profession.SkillsData;
using GameData.Domains.Taiwu.VillagerRole;
using GameData.Domains.TaiwuEvent;
using GameData.Domains.TaiwuEvent.EventHelper;
using GameData.Domains.World;
using GameData.Domains.World.MonthlyEvent;
using GameData.Domains.World.Notification;
using GameData.GameDataBridge;
using GameData.Serializer;
using GameData.Utilities;
using NLog;
using Redzen.Random;
using TaiwuModdingLib.Core.Utils;

namespace GameData.Domains.Character;

[GameDataDomain(4)]
public class CharacterDomain : BaseGameDataDomain
{
	private struct SimulateCombatContext
	{
		public Character CharA;

		public List<Character> TeamA;

		public Character CharB;

		public List<Character> TeamB;

		public CombatType CombatType;

		public AiHelper.NpcCombatResultType CombatResultType;

		public bool ForceResult;

		public int ExpMultiplier;

		public Character WinnerChar => IsVictory() ? CharA : CharB;

		public Character LoserChar => IsVictory() ? CharB : CharA;

		public List<Character> WinnerTeam => IsVictory() ? TeamA : TeamB;

		public List<Character> LoserTeam => IsVictory() ? TeamB : TeamA;

		public bool IsVictory()
		{
			return CombatResultType == AiHelper.NpcCombatResultType.MajorVictory || CombatResultType == AiHelper.NpcCombatResultType.MinorVictory;
		}

		public bool IsMajor()
		{
			return CombatResultType == AiHelper.NpcCombatResultType.MajorVictory || CombatResultType == AiHelper.NpcCombatResultType.MajorDefeat;
		}
	}

	private static readonly Logger Logger = LogManager.GetCurrentClassLogger();

	[DomainData(DomainDataType.ObjectCollection, true, false, true, true, CollectionCapacity = 8192)]
	private readonly Dictionary<int, Character> _objects;

	[DomainData(DomainDataType.SingleValue, true, false, false, false)]
	private int _nextObjectId;

	[DomainData(DomainDataType.SingleValueCollection, true, false, false, false, CollectionCapacity = 65536)]
	private readonly Dictionary<int, DeadCharacter> _deadCharacters;

	[DomainData(DomainDataType.SingleValueCollection, true, false, false, false)]
	private readonly Dictionary<int, DeadCharDeletionState> _deadCharDeletionStates;

	[DomainData(DomainDataType.SingleValueCollection, true, false, false, false)]
	private readonly SortedSetAsDictionary<IntPair> _recentDeadCharacters;

	[DomainData(DomainDataType.SingleValueCollection, true, false, false, false)]
	private readonly SortedSetAsDictionary<IntPair> _waitingReincarnationChars;

	[DomainData(DomainDataType.ObjectCollection, true, false, true, true, CollectionCapacity = 16384)]
	private readonly Dictionary<int, Grave> _graves;

	[DomainData(DomainDataType.SingleValueCollection, true, false, false, false)]
	private readonly Dictionary<int, PregnantState> _pregnantStates;

	[DomainData(DomainDataType.SingleValueCollection, true, false, true, false)]
	private readonly Dictionary<int, int> _pregnancyLockEndDates;

	[DomainData(DomainDataType.SingleValue, true, false, true, true)]
	private CharacterSet _unguardedChars;

	[DomainData(DomainDataType.SingleValueCollection, true, false, false, false)]
	private readonly Dictionary<int, KidnappedCharacterList> _kidnappedChars;

	[DomainData(DomainDataType.SingleValueCollection, true, false, false, false)]
	private readonly Dictionary<RelationKey, RelatedCharacter> _relations;

	[DomainData(DomainDataType.SingleValueCollection, true, false, false, false)]
	private readonly Dictionary<ParentAndChild, int> _actualBloodParents;

	[DomainData(DomainDataType.SingleValueCollection, true, false, false, false)]
	private readonly Dictionary<int, CharacterSet> _characterGroups;

	[DomainData(DomainDataType.SingleValueCollection, true, false, true, false)]
	private readonly Dictionary<int, int> _joinGroupDates;

	[DomainData(DomainDataType.SingleValueCollection, true, false, false, false)]
	private readonly Dictionary<int, Debts> _debtsToTaiwu;

	[DomainData(DomainDataType.SingleValueCollection, true, false, false, false)]
	private readonly Dictionary<int, GameData.Utilities.ShortList> _soldLibrarySkillBooks;

	[DomainData(DomainDataType.SingleValueCollection, true, false, false, false)]
	[Obsolete("This field is only for archive module. Cannot use to do anything.")]
	private readonly Dictionary<int, CombatResourcesObsolete> _usedCombatResourceObsoletes;

	[DomainData(DomainDataType.SingleValueCollection, true, false, false, false)]
	private readonly Dictionary<int, AvatarElementsGrownDates> _avatarElementGrowthProgress;

	[DomainData(DomainDataType.SingleValue, true, false, true, true)]
	private string _targetedForAssassination;

	[DomainData(DomainDataType.SingleValueCollection, true, false, false, false)]
	private readonly Dictionary<int, PrioritizedActionWrapper> _prioritizedActions;

	[DomainData(DomainDataType.SingleValueCollection, true, false, true, true)]
	private readonly Dictionary<int, CrossAreaMoveInfo> _crossAreaMoveInfos;

	[DomainData(DomainDataType.SingleValueCollection, true, false, false, false)]
	private readonly Dictionary<int, CharacterSet> _ongoingVengeances;

	[Obsolete]
	[DomainData(DomainDataType.SingleValue, true, false, true, true)]
	private CharacterSet _mournedOthersChars;

	[DomainData(DomainDataType.SingleValueCollection, false, false, true, true)]
	private Dictionary<int, CharacterList> _subscriberOrders;

	private readonly SortedList<long, int> _topThousandCharDescendingRanking = new SortedList<long, int>(Comparer<long>.Create((long x, long y) => y.CompareTo(x)));

	private readonly List<Character> _attackerTeamsCache = new List<Character>();

	private readonly List<Character> _defenderTeamsCache = new List<Character>();

	private readonly Dictionary<int, CombatResources> _usedCombatResources = new Dictionary<int, CombatResources>();

	private const int RecentDeadDuration = 12;

	private const int DeadDuration = 120;

	private const int ReincarnationMinInterval = 7;

	private static readonly short[] FavorDecrementPercentsOfDebt = new short[5] { 140, 130, 150, 160, 170 };

	private static readonly short[] FavorIncrementPercentsOfDebt = new short[5] { 110, 120, 100, 90, 80 };

	private static Debts _tmpDebts = new Debts();

	private static List<short> _normalPositiveBasicFeaturesPool;

	private static List<short> _normalNegativeBasicFeaturesPool;

	private static List<short> _protagonistPositiveBasicFeaturesPool;

	private static List<short> _protagonistNegativeBasicFeaturesPool;

	private CharacterSortFilter _characterSortFilter;

	private Dictionary<short, int> _fixedCharactersCache;

	private Dictionary<int, short> _fixedEnemyCache;

	private Dictionary<short, int> _convertedFixedCharactersCache;

	private const int GraveNeighborBlockMaxCount = 9;

	private const int GraveSkeletonSpawnChance = 50;

	private List<MapBlockData> _graveNeighborBlocks;

	private List<(ItemKey itemKey, int amount)>[] _graveNeighborItems;

	private Dictionary<int, int> _skeletonCharacterCache;

	private static short[] PregenerateHereticTemplateIds = new short[9] { 232, 242, 262, 267, 272, 277, 282, 287, 292 };

	private static short[] PregenerateRighteousTemplateIds = new short[9] { 307, 308, 309, 310, 311, 312, 313, 314, 315 };

	private const int TotalPregeneratedCityTownGuardCount = 288;

	private static Dictionary<sbyte, List<short>[]> _randomEnemyCharTemplateCache;

	[DomainData(DomainDataType.SingleValue, true, false, false, false, ArrayElementsCount = 288)]
	private int[] _pregeneratedCityTownGuards;

	[DomainData(DomainDataType.SingleValue, true, false, false, false)]
	private List<int> _pregeneratedRandomEnemies;

	private Dictionary<int, int> _infantMap;

	private HashSet<int> _infectedCharSet;

	private const int LuckEventSelectCharCount = 100;

	private (int charId, bool isPositive, bool isAvoided) _predictedLuckEvent;

	[DomainData(DomainDataType.SingleValue, false, false, true, false)]
	private Location _forceRebelLocation;

	[DomainData(DomainDataType.SingleValue, false, false, true, false)]
	private Location _forceKindLocation;

	[DomainData(DomainDataType.SingleValue, true, false, true, false)]
	private int _avoidDeathCharId;

	private Location _tripleAdoreLocation;

	private Location _tripleHateLocation;

	private Location _doubleAgeIncreaseLocation;

	private Location _noAgeIncreaseLocation;

	private static readonly HashSet<int> LockMovementCharSet = new HashSet<int>();

	private static AStarMap _xiangshuMovementMap = new AStarMap();

	private static AStarMap _fuyuHiltMovementMap = new AStarMap();

	private static short[] _randomHanNameSurnameIds;

	private static int[] _randomHanNameSurnameAccumulativeWeights;

	private static int[] _randomHanNameUnattachedTotalCounts;

	private static int[] _randomHanNameAttachedTotalCounts;

	private HashSet<int> _legendaryBookChallengers = new HashSet<int>();

	private List<Location> _yuanShanEnemyLocations = new List<Location>();

	private short _shiXiangEnemyAreaId;

	private List<short> _shiXiangEnemyBlockIds = new List<short>();

	private Dictionary<int, (int, int)> _charactersWithInfantNearBy = new Dictionary<int, (int, int)>();

	private Dictionary<int, int> _characterWithInfantWithBloodRelation = new Dictionary<int, int>();

	private HashSet<int> _eMeiPsychotics = new HashSet<int>();

	public ConcurrentBag<int> BaihuaManicCharIds = new ConcurrentBag<int>();

	private const int InitialFabricatedFavorSettingsLenght = 7;

	private static readonly HashSet<int> EmptyCharacterSet = new HashSet<int>();

	private static readonly short[] InitialFabricatedFavorOfRelationTypes = new short[119]
	{
		0, 0, 0, 0, 0, 0, 0, 26000, 26000, 22000,
		18000, 18000, -30000, 30000, 26000, 26000, 22000, 18000, 18000, -30000,
		30000, 22000, 22000, 18000, 14000, 14000, -30000, 25999, 22000, 22000,
		18000, 14000, 14000, -21999, 25999, 22000, 22000, 18000, 14000, 14000,
		-21999, 25999, 14000, 14000, 10000, 6000, 6000, -21999, 17999, 22000,
		22000, 18000, 14000, 14000, -5999, 25999, 22000, 22000, 18000, 14000,
		14000, -5999, 25999, 14000, 14000, 10000, 6000, 6000, -5999, 17999,
		14000, 22000, 18000, 22000, 14000, 6000, 25999, 18000, 26000, 22000,
		26000, 18000, -30000, 30000, 14000, 22000, 18000, 22000, 14000, -21999,
		25999, 14000, 22000, 18000, 22000, 14000, -21999, 25999, 10000, 18000,
		14000, 18000, 10000, 6000, 21999, 10000, 18000, 14000, 18000, 10000,
		-21999, 21999, -22000, -10000, -18000, -10000, -22000, -30000, -6000
	};

	private static readonly short[] InitialMentorFabricatedFavorOfSects = new short[105]
	{
		18000, 18000, 14000, 10000, 10000, 10000, 21999, 22000, 22000, 18000,
		14000, 14000, 6000, 25999, 26000, 26000, 22000, 18000, 18000, 14000,
		30000, 26000, 26000, 22000, 18000, 18000, 10000, 30000, 14000, 14000,
		10000, 6000, 6000, 6000, 17999, 26000, 26000, 22000, 18000, 18000,
		-21999, 30000, 18000, 18000, 14000, 10000, 10000, -5999, 21999, 6000,
		6000, 2000, -2000, -2000, 6000, 9999, 22000, 22000, 18000, 14000,
		14000, -9999, 25999, 14000, 14000, 10000, 6000, 6000, -21999, 17999,
		14000, 14000, 10000, 6000, 6000, -17999, 17999, 26000, 26000, 22000,
		18000, 18000, 6000, 30000, 14000, 14000, 10000, 6000, 6000, -21999,
		17999, 22000, 22000, 18000, 14000, 14000, 10000, 25999, 6000, 6000,
		2000, -2000, -2000, -30000, 9999
	};

	private static readonly short[] FavorabilityFactorOfGradeDifferences = new short[17]
	{
		140, 135, 130, 125, 120, 115, 110, 105, 100, 95,
		90, 85, 80, 75, 70, 65, 60
	};

	private static readonly (short positive, short negative)[] BaseChangedFavorabilitiesOfChangingHobby = new(short, short)[5]
	{
		(0, 0),
		(1000, 1000),
		(-1000, 1000),
		(1000, -1000),
		(-1000, -1000)
	};

	private static readonly sbyte[] FavorabilityChangingFactorsOfChangingHobby = new sbyte[13]
	{
		0, 0, 25, 50, 75, 100, 100, 100, 75, 50,
		25, 0, 0
	};

	private Dictionary<int, RelatedCharacters> _relatedCharIds;

	public const int BloodFatherIdNone = -1;

	public const int BloodMotherIdNone = -2;

	private Dictionary<int, List<ParentAndChild>> _nominalBloodParentRelations;

	private readonly Dictionary<int, CharacterModificationRecords> _characterTemporaryModifications = new Dictionary<int, CharacterModificationRecords>();

	private Character _currTemporaryModifyingCharacter;

	private readonly List<(RevertibleCharacterPropertyType type, RevertibleCharacterPropertyValue value)> _currTemporaryModifyingValues = new List<(RevertibleCharacterPropertyType, RevertibleCharacterPropertyValue)>();

	private static readonly DataInfluence[][] CacheInfluences = new DataInfluence[30][];

	private static readonly DataInfluence[][] CacheInfluencesObjects = new DataInfluence[119][];

	private readonly ObjectCollectionDataStates _dataStatesObjects = new ObjectCollectionDataStates(119, 8192);

	public readonly ObjectCollectionHelperData HelperDataObjects;

	private static readonly DataInfluence[][] CacheInfluencesGraves = new DataInfluence[7][];

	private readonly ObjectCollectionDataStates _dataStatesGraves = new ObjectCollectionDataStates(7, 16384);

	public readonly ObjectCollectionHelperData HelperDataGraves;

	private SingleValueCollectionModificationCollection<int> _modificationsPregnancyLockEndDates = SingleValueCollectionModificationCollection<int>.Create();

	private SingleValueCollectionModificationCollection<int> _modificationsJoinGroupDates = SingleValueCollectionModificationCollection<int>.Create();

	private SingleValueCollectionModificationCollection<int> _modificationsCrossAreaMoveInfos = SingleValueCollectionModificationCollection<int>.Create();

	private SingleValueCollectionModificationCollection<int> _modificationsSubscriberOrders = SingleValueCollectionModificationCollection<int>.Create();

	private Queue<uint> _pendingLoadingOperationIds;

	private readonly List<int> _creatingCharIds = new List<int>();

	private readonly HashSet<int> _temporaryIntelligentCharIds = new HashSet<int>();

	public CharacterSortFilter CharacterSortFilter => _characterSortFilter;

	public Location TripleAdoreLocation => _tripleAdoreLocation;

	public Location TripleHateLocation => _tripleHateLocation;

	[Obsolete]
	public Location DoubleAgeIncreaseLocation => _doubleAgeIncreaseLocation;

	[Obsolete]
	public Location NoAgeIncreaseLocation => _noAgeIncreaseLocation;

	private void OnInitializedDomainData()
	{
		InitializeGraveItemsRelatedData();
		ResetLuckEventPrediction();
	}

	private void InitializeOnInitializeGameDataModule()
	{
		InitializeRandomHanNameInfo();
		InitializeBasicFeaturesPools();
		InitializeRandomEnemyCharTemplateCache();
		AvatarManager.Instance = new AvatarManager();
		AvatarManager.Instance.InitAvatarCore(displayMode: false);
	}

	private void InitializeOnEnterNewWorld()
	{
		_nextObjectId = 0;
		_avoidDeathCharId = -1;
		InitializeRelations();
		InitializeNominalBloodParentRelations();
		InitializeInfectedCharSet();
		InitializeInfantMap();
		InitializeFixedCharactersCache();
		InitializeSkeletonCharacterCache();
		InitializeXiangshuLocations();
		Events.RegisterHandler_AdvanceMonthFinish(RecoverCombatResources);
	}

	private void OnLoadedArchiveData()
	{
		InitializeRelations();
		InitializeNominalBloodParentRelations();
		InitializeInfectedCharSet();
		InitializeInfantMap();
		InitializeFixedCharactersCache();
		InitializeSkeletonCharacterCache();
		InitializeXiangshuLocations();
		DataUid uid = new DataUid(0, 1, ulong.MaxValue);
		GameData.GameDataBridge.GameDataBridge.AddPostDataModificationHandler(uid, "RegisterPrevBookOwnerCopiesAsTemporaryCharacters", RegisterPrevBookOwnerCopiesAsTemporaryCharacters);
		GameData.GameDataBridge.GameDataBridge.AddPostDataModificationHandler(uid, "ComplementPregeneratedRandomEnemies", ComplementPregeneratedRandomEnemies);
		Events.RegisterHandler_AdvanceMonthFinish(RecoverCombatResources);
		DomainManager.World.UpdatePopulationRelatedData();
	}

	public unsafe override void FixAbnormalDomainArchiveData(DataContext context)
	{
		bool flag = DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 50);
		bool flag2 = DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 70, 36);
		bool flag3 = DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 71);
		bool flag4 = !DomainManager.World.IsCurrWorldAfterVersion(0, 0, 74, 10);
		bool flag5 = DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 74, 14);
		ClearObsoleteRelationData(context);
		FixIncompleteRelation(context);
		FixAbnormalDebts(context);
		FixDuplicateLifeSkills(context);
		FixAbnormalExtraNeiliAllocationByProgress(context);
		if (DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 74, 39))
		{
			FixAbnormalInfectedCharacterInPrisonAndBlock(context);
		}
		RemoveAbnormalInfectedCharacterGroup(context);
		RemoveDuplicateCharacterLocationAtBlocks(context);
		RemoveDuplicateKidnappedCharacters(context);
		RemoveAbnormalSkeletonCharacters(context);
		RemoveAbnormalCrossAreaTravelingCharacters(context);
		if (DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 69))
		{
			MigratePrioritizedActionCooldown(context);
		}
		if (DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 71, 82))
		{
			FixAbnormalPrioritizedAction71(context);
		}
		if (DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 73, 42) && DomainManager.World.IsCurrWorldAfterVersion(0, 0, 73))
		{
			FixAbnormalPrioritizedAction73(context);
		}
		if (flag4)
		{
			UpgradeCombatSkillEquipmentData(context);
		}
		if (DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 79))
		{
			InitializeCombatSkillProficiencies(context);
		}
		HashSet<ItemKey> hashSet = new HashSet<ItemKey>(1048576);
		hashSet.UnionWith(DomainManager.Taiwu.WarehouseItems.Keys);
		hashSet.UnionWith(DomainManager.Extra.TreasuryItems.Keys);
		HashSet<int> hashSet2 = new HashSet<int>();
		DomainManager.TaiwuEvent.CollectUnreleasedCalledCharacters(hashSet2);
		HashSet<int> hashSet3 = new HashSet<int>();
		DomainManager.Extra.GetAllPrevLegendaryBookOwnerCopies(context, hashSet3);
		foreach (int item in hashSet3)
		{
			if (!DomainManager.Character.TryGetElement_Objects(item, out var element))
			{
				continue;
			}
			Location location = element.GetLocation();
			if (location.IsValid())
			{
				MapBlockData block = DomainManager.Map.GetBlock(location);
				if (block.CharacterSet != null && block.CharacterSet.Contains(item))
				{
					Events.RaiseCharacterLocationChanged(context, item, location, Location.Invalid);
					Logger.Warn($"Removing temporary character {element} from map.");
				}
				if (block.InfectedCharacterSet != null && block.InfectedCharacterSet.Contains(item))
				{
					Events.RaiseInfectedCharacterLocationChanged(context, item, location, Location.Invalid);
					Logger.Warn($"Removing temporary character {element} from map.");
				}
			}
			else
			{
				element.SetLocation(DomainManager.Taiwu.GetTaiwuVillageLocation(), context);
			}
		}
		Dictionary<int, Character> dictionary = new Dictionary<int, Character>();
		int key;
		foreach (KeyValuePair<int, Character> @object in _objects)
		{
			@object.Deconstruct(out key, out var value);
			int num = key;
			Character character = value;
			FixCharacterConsummateLevel(context, character);
			if (hashSet3.Contains(num))
			{
				continue;
			}
			PreexistenceCharIds preexistenceCharIds = character.GetPreexistenceCharIds();
			if (preexistenceCharIds.Count > 0 && preexistenceCharIds.CharIds[0] >= 0)
			{
				int charIds = preexistenceCharIds.CharIds[0];
				if (dictionary.TryGetValue(charIds, out var value2))
				{
					Logger.Warn($"Removing duplicate preexisting character {charIds} of {character} (already reincarnated as {value2})");
					character.ClearPreexistenceCharIds(context);
				}
				else
				{
					dictionary.Add(charIds, character);
				}
			}
			if (character.IsActiveExternalRelationState(4) && !hashSet2.Contains(num))
			{
				character.DeactivateExternalRelationState(context, 4);
				Logger.Warn($"Canceling called by adventure state for {num}");
			}
			if (flag)
			{
				FixAbnormalInsectFeature(context, character);
			}
			if (flag3)
			{
				DomainManager.Organization.TryAddSectMemberFeature(context, character, character.GetOrganizationInfo());
			}
			if (flag2)
			{
				List<short> featureIds = character.GetFeatureIds();
				featureIds.Sort(CharacterFeatureHelper.FeatureComparer);
				character.SetFeatureIds(featureIds, context);
			}
			FixAbnormalFeature(context, character);
			FixAbnormalGroupState(context, character);
			FixAbnormalCharacterLocation(context, character);
			if (flag5 && character.GetCreatingType() == 1 && character.GetAgeGroup() == 2)
			{
				GenerateCharacterProfession(context, character);
			}
			FixAbnormalPregnantState(context, character);
			FixAbnormalCharacterOrganization(context, character);
			FixAbnormalCharacterCombatSkillBreakoutCount(context, character);
			FixInventoryAndEquippedItem(context, character, hashSet);
			FixCharacterMaxNeili(context, character);
			FixCharacterCurrNeili(context, character);
			FixMerchantCharToType(context, character);
			FixErrorEatItems(context, character);
			FixQualifications(context, character);
			FixAbnormalAvatar(context, character);
			FixAbnormalExtraNeiliAllocationByProgressForNonEvolutionaryType(context, character);
			FixSpecialIdentityCharacterOrganizationAndIdentity(context, character);
			FixAbnormalConsumedOwner(context, character);
			FixAbnormalIdealSect(context, character);
			FixAbnormalGuardFeature(context, character);
			int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
			if (num == taiwuCharId)
			{
				FixAbnormalTaiwuExtraNeiliAllocation(context, character);
			}
			FixAbnormalCombatSkillPageActivation(context, character);
		}
		FixAbnormalChickenFeatures(context);
		List<ItemKey> obj = context.AdvanceMonthRelatedData.ItemKeys.Occupy();
		foreach (KeyValuePair<int, Grave> grafe in _graves)
		{
			grafe.Deconstruct(out key, out var value3);
			int value4 = key;
			Grave grave = value3;
			Inventory inventory = grave.GetInventory();
			obj.Clear();
			obj.AddRange(inventory.Items.Keys);
			bool flag6 = false;
			foreach (ItemKey item2 in obj)
			{
				if (ItemTemplateHelper.IsPureStackable(item2))
				{
					continue;
				}
				if (DomainManager.Item.ItemExists(item2))
				{
					if (!hashSet.Add(item2))
					{
						Logger.Warn($"Removing duplicate item {item2} in grave {value4}");
						inventory.OfflineRemove(item2, inventory.Items[item2]);
						flag6 = true;
					}
				}
				else
				{
					Logger.Warn($"Removing ghost item {item2} in grave {value4}");
					inventory.OfflineRemove(item2, inventory.Items[item2]);
					flag6 = true;
				}
			}
			if (flag6)
			{
				grave.SetInventory(inventory, context);
			}
		}
		context.AdvanceMonthRelatedData.ItemKeys.Release(ref obj);
		foreach (int value5 in _fixedCharactersCache.Values)
		{
			Character character2 = _objects[value5];
			if (character2.GetLeaderId() == DomainManager.Taiwu.GetTaiwuCharId())
			{
				continue;
			}
			context.Equipping.SelectEquipments(context, _objects[value5], isOutOfTaiwuGroup: true);
			ItemKey[] equipment = character2.GetEquipment();
			for (int i = 0; i < equipment.Length; i++)
			{
				ItemKey itemKey = equipment[i];
				if (itemKey.IsValid() && ItemTemplateHelper.GetItemSubType(itemKey.ItemType, itemKey.TemplateId) == 16)
				{
					EquipmentBase baseEquipment = DomainManager.Item.GetBaseEquipment(itemKey);
					short equipmentEffectId = baseEquipment.GetEquipmentEffectId();
					if (equipmentEffectId >= 0)
					{
						baseEquipment.SetEquipmentEffectId(-1, context);
					}
				}
			}
		}
		FixInteractedCharacters(context);
		FixElopeWithLoveWrongState(context);
		FixKidnappedCharResistance(context);
	}

	private void FixAbnormalTaiwuExtraNeiliAllocation(DataContext context, Character character)
	{
		short maxExtraNeiliAllocation = GlobalConfig.Instance.MaxExtraNeiliAllocation;
		int neiliAllocationMaxProgress = CombatSkillDomain.GetNeiliAllocationMaxProgress();
		if (!DomainManager.Extra.TryGetExtraNeiliAllocationProgress(character.GetId(), out var result))
		{
			return;
		}
		NeiliAllocation extraNeiliAllocation = character.GetExtraNeiliAllocation();
		for (int i = 0; i < 4; i++)
		{
			if (result.Items[i] >= neiliAllocationMaxProgress && extraNeiliAllocation[i] < maxExtraNeiliAllocation)
			{
				extraNeiliAllocation[i] = maxExtraNeiliAllocation;
			}
		}
		character.SetExtraNeiliAllocation(extraNeiliAllocation, context);
	}

	private void FixAbnormalCombatSkillPageActivation(DataContext context, Character character)
	{
		List<short> learnedCombatSkillIds;
		int charId;
		if (DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 79, 21))
		{
			learnedCombatSkillIds = character.GetLearnedCombatSkills();
			charId = character.GetId();
			DomainManager.Character.AutoActivateReadCombatSkillNormalPages(context, IterLearnedCombatSkills(), charId);
		}
		IEnumerable<GameData.Domains.CombatSkill.CombatSkill> IterLearnedCombatSkills()
		{
			using List<short>.Enumerator enumerator = learnedCombatSkillIds.GetEnumerator();
			while (enumerator.MoveNext())
			{
				CombatSkillKey skillKey = new CombatSkillKey(skillTemplateId: enumerator.Current, charId: charId);
				if (DomainManager.CombatSkill.TryGetElement_CombatSkills(skillKey, out var combatSkill))
				{
					yield return combatSkill;
					combatSkill = null;
				}
			}
		}
	}

	private void FixSpecialIdentityCharacterOrganizationAndIdentity(DataContext context, Character character)
	{
		if (!DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 74))
		{
			return;
		}
		short templateId = character.GetTemplateId();
		CharacterItem characterItem = Config.Character.Instance[templateId];
		if (!string.IsNullOrEmpty(characterItem.SpecialGradeName))
		{
			OrganizationInfo organizationInfo = character.GetOrganizationInfo();
			if (organizationInfo.OrgTemplateId == 0 && characterItem.OrganizationInfo.OrgTemplateId != 0)
			{
				organizationInfo.OrgTemplateId = characterItem.OrganizationInfo.OrgTemplateId;
				organizationInfo.Grade = characterItem.OrganizationInfo.Grade;
				character.SetOrganizationInfo(organizationInfo, context);
			}
		}
	}

	private void FixAbnormalConsumedOwner(DataContext context, Character character)
	{
		if (!DomainManager.Extra.IsLegendaryBookConsumed(character.GetId()))
		{
			return;
		}
		DomainManager.Organization.ChangeOrganization(context, character, OrganizationInfo.None);
		Location location = character.GetLocation();
		if (!location.IsValid() || location.AreaId >= 45)
		{
			return;
		}
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		DomainManager.Map.GetAllBrokenAreaInState(DomainManager.Map.GetStateIdByAreaId(location.AreaId), list);
		if (list.Count > 0)
		{
			CollectionUtils.Shuffle(context.Random, list);
			List<MapBlockData> list2 = ObjectPool<List<MapBlockData>>.Instance.Get();
			short areaId = list[0];
			DomainManager.Adventure.GetValidBlocksForRandomEnemy(areaId, -1, -1, onAdventureSite: true, onSettlement: true, nearTaiwu: true, list2);
			if (list2.Count > 0)
			{
				CollectionUtils.Shuffle(context.Random, list2);
				Location location2 = list2[0].GetLocation();
				DomainManager.Character.LeaveGroup(context, character, bringWards: false);
				character.SetLocation(location2, context);
				Events.RaiseCharacterLocationChanged(context, character.GetId(), location, location2);
			}
			ObjectPool<List<MapBlockData>>.Instance.Return(list2);
		}
		ObjectPool<List<short>>.Instance.Return(list);
		Logger.Info($"Fix Abnormal Consumed Character: {character}");
	}

	private void FixAbnormalIdealSect(DataContext context, Character character)
	{
		sbyte idealSect = character.GetIdealSect();
		if (idealSect <= 0)
		{
			List<sbyte> randomIdealSects = character.Template.RandomIdealSects;
			sbyte b = ((randomIdealSects != null && randomIdealSects.Count > 0) ? randomIdealSects.GetRandom(context.Random) : ((sbyte)((character.Template.IdealSect > 0) ? character.Template.IdealSect : (-1))));
			if (idealSect != b)
			{
				character.SetIdealSect(b, context);
				Logger.Info($"Fix Abnormal Character Ideal Sect: {character}, {idealSect} -> {b}");
			}
		}
	}

	private void FixAbnormalGuardFeature(DataContext context, Character character)
	{
		if (character.GetCreatingType() == 1 && DomainManager.Organization.CharacterTreasuryGuardInfo(character.GetId()) == 0 && character.RemoveFeatureGroup(context, 536))
		{
			Logger.Info($"Fix Abnormal Character Guard Feature: {character}");
		}
	}

	private void ClearObsoleteRelationData(DataContext context)
	{
		int count = _relations.Count;
		foreach (var (charId, deadCharacter2) in _deadCharacters)
		{
			RemoveAllGeneralRelations(context, charId);
		}
		int count2 = _relations.Count;
		Logger.Info($"Clearing obsolete relations: {count} => {count2}");
		int num2 = count2 + _objects.Count * 64;
		if (count > num2)
		{
			_relations.TrimExcess(num2);
			Logger.Info($"Trimming relation dict capacity to {num2}");
		}
	}

	private void RemoveAbnormalSkeletonCharacters(DataContext context)
	{
		foreach (var (num3, num4) in _skeletonCharacterCache)
		{
			if (_objects.TryGetValue(num3, out var value) && _deadCharacters.TryGetValue(num4, out var value2) && (value.GetGender() != value2.Gender || value.GetAgeGroup() != 2))
			{
				Logger.Warn($"Removing abnormal skeleton character {num3} of grave {num4}");
				RemoveNonIntelligentCharacter(context, value);
			}
		}
	}

	private void RemoveAbnormalCrossAreaTravelingCharacters(DataContext context)
	{
		foreach (var (num2, crossAreaMoveInfo2) in _crossAreaMoveInfos)
		{
			if (!TryGetElement_Objects(num2, out var element))
			{
				Logger.Warn($"Invalid travel info: {num2}(dead) from {crossAreaMoveInfo2.FromAreaId} to {crossAreaMoveInfo2.ToAreaId}");
				RemoveCrossAreaTravelInfo(context, num2);
			}
			else if (element.GetLocation().IsValid())
			{
				Logger.Warn($"Invalid travel info: {num2} from {crossAreaMoveInfo2.FromAreaId} to {crossAreaMoveInfo2.ToAreaId}");
				RemoveCrossAreaTravelInfo(context, num2);
			}
		}
	}

	private void FixAbnormalAvatar(DataContext context, Character character)
	{
		AvatarData avatar = character.GetAvatar();
		AvatarGroup avatarGroup = AvatarManager.Instance.GetAvatarGroup(avatar.AvatarId);
		if (avatarGroup.IsHairless(avatar.FrontHairId, avatar.BackHairId))
		{
			(avatar.FrontHairId, avatar.BackHairId) = avatarGroup.GetRandomHairs(context.Random);
			character.SetAvatar(avatar, context);
			Logger.Warn($"Fixing abnormal hairless avatar for character {character}.");
		}
	}

	private void FixAbnormalExtraNeiliAllocationByProgressForNonEvolutionaryType(DataContext context, Character character)
	{
		if (DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 71, 78) && CreatingType.IsNonEvolutionaryType(character.GetCreatingType()))
		{
			IntList orInitExtraNeiliAllocationProgress = DomainManager.Extra.GetOrInitExtraNeiliAllocationProgress(context, character.GetId());
			CharacterItem template = character.Template;
			sbyte[] extraNeiliAllocationProgress = template.ExtraNeiliAllocationProgress;
			for (int i = 0; i < 4; i++)
			{
				int extraNeiliAllocationProgressByExtraNeiliAllocation = CombatSkillDomain.GetExtraNeiliAllocationProgressByExtraNeiliAllocation(extraNeiliAllocationProgress[i]);
				orInitExtraNeiliAllocationProgress.Items[i] = extraNeiliAllocationProgressByExtraNeiliAllocation;
			}
			DomainManager.CombatSkill.SetCharacterExtraNeiliAllocationAndProgress(context, character, orInitExtraNeiliAllocationProgress, canOverMax: true);
		}
	}

	private void FixAbnormalChickenFeatures(DataContext context)
	{
		Stopwatch stopwatch = Stopwatch.StartNew();
		foreach (KeyValuePair<int, Character> @object in _objects)
		{
			@object.Deconstruct(out var key, out var value);
			int num = key;
			Character character = value;
			List<short> chickenFeatures = character.GetChickenFeatures();
			ChickenBlessingInfoData value2;
			bool flag = DomainManager.Building.TryGetElement_ChickenBlessingInfoData(num, out value2);
			foreach (short item in chickenFeatures)
			{
				int characterTemporaryFeaturesExpireDate = DomainManager.Extra.GetCharacterTemporaryFeaturesExpireDate(new IntPair(num, item));
				if (characterTemporaryFeaturesExpireDate == -1)
				{
					if (flag && value2.RemainingMonths.TryGetValue(item, out var value3))
					{
						characterTemporaryFeaturesExpireDate = DomainManager.World.GetCurrDate() + value3;
						DomainManager.Extra.RegisterCharacterTemporaryFeature(context, num, item, characterTemporaryFeaturesExpireDate);
					}
					else
					{
						characterTemporaryFeaturesExpireDate = DomainManager.World.GetCurrDate() + CharacterFeature.Instance[item].Duration;
						DomainManager.Extra.RegisterCharacterTemporaryFeature(context, num, item, characterTemporaryFeaturesExpireDate);
					}
				}
			}
		}
		DomainManager.Building.ClearChickenBlessingInfo(context);
		stopwatch.Stop();
		Logger.Info($"FixAbnormalChickenFeatures cost time: {stopwatch.ElapsedMilliseconds}ms");
	}

	private void FixIncompleteRelation(DataContext context)
	{
		List<RelationKey> list = null;
		foreach (var (num2, character2) in _objects)
		{
			if (!_relatedCharIds.TryGetValue(num2, out var value))
			{
				continue;
			}
			foreach (int item in value.General.GetCollection())
			{
				RelationKey relationKey = new RelationKey(item, num2);
				if (_objects.ContainsKey(item) && !_relations.ContainsKey(relationKey))
				{
					if (list == null)
					{
						list = new List<RelationKey>();
					}
					list.Add(relationKey);
				}
			}
		}
		if (list == null)
		{
			return;
		}
		foreach (RelationKey item2 in list)
		{
			RelationKey key = new RelationKey(item2.RelatedCharId, item2.CharId);
			RelatedCharacter relatedCharacter = _relations[key];
			AddRelationInternal(context, item2.CharId, item2.RelatedCharId, 0, relatedCharacter.EstablishmentDate);
			Logger.Warn($"Add missing relation between {_objects[item2.CharId]} and {_objects[item2.RelatedCharId]}");
		}
	}

	private unsafe void FixErrorEatItems(DataContext context, Character character)
	{
		EatingItems eatingItems = character.GetEatingItems();
		if (character.GetCreatingType() != 1)
		{
			bool flag = false;
			for (int i = 0; i < 9; i++)
			{
				ItemKey itemKey = (ItemKey)eatingItems.ItemKeys[i];
				if (EatingItems.IsValid(itemKey))
				{
					Logger.Warn($"Removing non-intelligent character {character}'s eating item: {itemKey}");
					flag = true;
				}
			}
			if (flag)
			{
				character.ClearEatingItems(context);
			}
			return;
		}
		for (int j = 0; j < 9; j++)
		{
			ItemKey itemKey2 = (ItemKey)eatingItems.ItemKeys[j];
			if (EatingItems.IsValid(itemKey2) && ItemTemplateHelper.GetItemSubType(itemKey2.ItemType, itemKey2.TemplateId) != 802 && !DomainManager.Item.ItemExists(itemKey2))
			{
				eatingItems.ItemKeys[j] = (ulong)ItemKey.Invalid;
				character.SetEatingItems(ref eatingItems, context);
				Logger.Warn($"Removing character {character} eatItems,ItemType: {itemKey2.ItemType},TemplateIdï¼š {itemKey2.TemplateId}");
			}
		}
	}

	private unsafe void FixQualifications(DataContext context, Character character)
	{
		if (DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 79))
		{
			CombatSkillShorts baseCombatSkillQualifications = character.GetBaseCombatSkillQualifications();
			if (FixSegment(baseCombatSkillQualifications.Items, 14))
			{
				character.SetBaseCombatSkillQualifications(ref baseCombatSkillQualifications, context);
			}
			LifeSkillShorts baseLifeSkillQualifications = character.GetBaseLifeSkillQualifications();
			if (FixSegment(baseLifeSkillQualifications.Items, 16))
			{
				character.SetBaseLifeSkillQualifications(ref baseLifeSkillQualifications, context);
			}
		}
		unsafe bool FixSegment(short* arr, int len)
		{
			bool result = false;
			for (int i = 0; i < len; i++)
			{
				if (arr[i] < 0)
				{
					result = true;
					AdaptableLog.TagWarning("FixQualifications", $"fixed invalid qualification {arr[i]} on {character}");
					arr[i] = 0;
				}
			}
			return result;
		}
	}

	private void FixAbnormalDebts(DataContext context)
	{
		int[] array = _debtsToTaiwu.Keys.ToArray();
		int[] array2 = array;
		foreach (int num in array2)
		{
			if (_debtsToTaiwu[num] == null)
			{
				RemoveElement_DebtsToTaiwu(num, context);
				Logger.Warn($"Removing invalid debt to taiwu ({num}).");
			}
		}
	}

	private void FixDuplicateLifeSkills(DataContext context)
	{
		HashSet<short> hashSet = new HashSet<short>();
		HashSet<int> collection = DomainManager.Taiwu.GetGroupCharIds().GetCollection();
		foreach (int item in collection)
		{
			Character character = _objects[item];
			List<LifeSkillItem> learnedLifeSkills = character.GetLearnedLifeSkills();
			hashSet.Clear();
			int num = 0;
			bool flag = false;
			while (num < learnedLifeSkills.Count)
			{
				LifeSkillItem lifeSkillItem = learnedLifeSkills[num];
				if (!hashSet.Add(lifeSkillItem.SkillTemplateId))
				{
					learnedLifeSkills.RemoveAt(num);
					Logger.Warn($"Removing {character}'s duplicate life skill {LifeSkill.Instance[lifeSkillItem.SkillTemplateId].Name} ({lifeSkillItem.SkillTemplateId}).");
					flag = true;
				}
				else
				{
					num++;
				}
			}
			if (flag)
			{
				character.SetLearnedLifeSkills(learnedLifeSkills, context);
			}
		}
	}

	private unsafe void FixAbnormalExtraNeiliAllocationByProgress(DataContext context)
	{
		if (DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 71, 71))
		{
			Character taiwu = DomainManager.Taiwu.GetTaiwu();
			int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
			IntList orInitExtraNeiliAllocationProgress = DomainManager.Extra.GetOrInitExtraNeiliAllocationProgress(context, taiwuCharId);
			int neiliAllocationMaxProgress = CombatSkillDomain.GetNeiliAllocationMaxProgress();
			NeiliAllocation extraNeiliAllocation = default(NeiliAllocation);
			extraNeiliAllocation.Initialize();
			for (int i = 0; i < 4; i++)
			{
				extraNeiliAllocation.Items[i] = (short)CombatSkillDomain.GetExtraNeiliAllocationByProgress(Math.Clamp(orInitExtraNeiliAllocationProgress.Items[i], 0, neiliAllocationMaxProgress));
			}
			taiwu.SetExtraNeiliAllocation(extraNeiliAllocation, context);
		}
	}

	private void RemoveDuplicateCharacterLocationAtBlocks(DataContext context)
	{
		ConcurrentBag<(MapBlockData block, Character character)> duplicateCharacterBlocks = new ConcurrentBag<(MapBlockData, Character)>();
		Parallel.For(0, 139, delegate(int i)
		{
			CollectDuplicateCharacterLocationBlocksInArea(i, duplicateCharacterBlocks);
		});
		if (duplicateCharacterBlocks.Count <= 0)
		{
			return;
		}
		Logger.Warn($"{duplicateCharacterBlocks.Count} duplicate characters found.");
		foreach (var (mapBlockData, character) in duplicateCharacterBlocks)
		{
			Logger.Warn($"Removing character {character} at ({mapBlockData.AreaId}, {mapBlockData.BlockId})");
			mapBlockData.RemoveCharacter(character.GetId());
			mapBlockData.RemoveInfectedCharacter(character.GetId());
			DomainManager.Map.SetBlockData(context, mapBlockData);
		}
	}

	private void FixAbnormalInfectedCharacterInPrisonAndBlock(DataContext context)
	{
		foreach (int item in _infectedCharSet)
		{
			Character character = _objects[item];
			if (character.IsActiveExternalRelationState(32))
			{
				Location validLocation = character.GetValidLocation();
				MapBlockData block = DomainManager.Map.GetBlock(validLocation);
				if (block.InfectedCharacterSet != null && block.InfectedCharacterSet.Contains(item))
				{
					Logger.Warn($"Removing infected prisoner {character} from block {validLocation}.");
					Events.RaiseInfectedCharacterLocationChanged(context, item, validLocation, Location.Invalid);
				}
			}
		}
	}

	private void RemoveAbnormalInfectedCharacterGroup(DataContext context)
	{
		foreach (int item in _infectedCharSet)
		{
			Character character = _objects[item];
			int leaderId = character.GetLeaderId();
			Location location = character.GetLocation();
			if (character.GetLeaderId() < 0)
			{
				continue;
			}
			Logger.Warn($"Removing infected character {character} from group with leader {leaderId} at {location}");
			LeaveGroup(context, character, bringWards: false);
			location = character.GetLocation();
			if (location.IsValid())
			{
				MapBlockData block = DomainManager.Map.GetBlock(location);
				if (block.CharacterSet.Contains(item))
				{
					block.RemoveCharacter(item);
					block.AddInfectedCharacter(item);
					DomainManager.Map.SetBlockData(context, block);
					Logger.Warn($"Re-adjusting infected character {character}'s location at {location}.");
				}
			}
		}
	}

	private void RemoveDuplicateKidnappedCharacters(DataContext context)
	{
		Dictionary<int, int> dictionary = ObjectPool<Dictionary<int, int>>.Instance.Get();
		dictionary.Clear();
		int key;
		foreach (KeyValuePair<int, KidnappedCharacterList> kidnappedChar in _kidnappedChars)
		{
			kidnappedChar.Deconstruct(out key, out var value);
			int num = key;
			KidnappedCharacterList kidnappedCharacterList = value;
			foreach (KidnappedCharacter item in kidnappedCharacterList.GetCollection())
			{
				int charId = item.CharId;
				if (!_objects.TryGetValue(charId, out var value2))
				{
					dictionary[charId] = num;
					continue;
				}
				if (value2.GetKidnapperId() != num)
				{
					dictionary[charId] = num;
					continue;
				}
				Location location = value2.GetLocation();
				if (location.IsValid())
				{
					MapBlockData block = DomainManager.Map.GetBlock(location);
					if (block.RemoveCharacter(charId) || block.RemoveInfectedCharacter(charId))
					{
						Logger.Warn($"Removing duplicated kidnapped character {charId} by {num} at ({block.AreaId},{block.BlockId})");
						DomainManager.Map.SetBlockData(context, block);
						value2.SetLocation(Location.Invalid, context);
					}
				}
			}
		}
		foreach (KeyValuePair<int, int> item2 in dictionary)
		{
			item2.Deconstruct(out key, out var value3);
			int num2 = key;
			int num3 = value3;
			KidnappedCharacterList kidnappedCharacterList2 = _kidnappedChars[num3];
			kidnappedCharacterList2.Remove(num2);
			if (kidnappedCharacterList2.GetCount() > 0)
			{
				SetElement_KidnappedChars(num3, kidnappedCharacterList2, context);
			}
			else
			{
				RemoveElement_KidnappedChars(num2, context);
				Character character = _objects[num3];
				character.DeactivateExternalRelationState(context, 2);
			}
			Logger.Warn($"Removing kidnap relation: {num3} kidnapped {num2}.");
		}
		ObjectPool<Dictionary<int, int>>.Instance.Return(dictionary);
	}

	private void CollectDuplicateCharacterLocationBlocksInArea(int areaId, ConcurrentBag<(MapBlockData block, Character character)> duplicateCharacterBlocks)
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		Span<MapBlockData> areaBlocks = DomainManager.Map.GetAreaBlocks((short)areaId);
		int i = 0;
		for (int length = areaBlocks.Length; i < length; i++)
		{
			Location other = new Location((short)areaId, (short)i);
			HashSet<int> hashSet = areaBlocks[i].CharacterSet;
			if (hashSet != null)
			{
				foreach (int item in hashSet)
				{
					Character element_Objects = DomainManager.Character.GetElement_Objects(item);
					if (!element_Objects.GetLocation().Equals(other))
					{
						duplicateCharacterBlocks.Add((areaBlocks[i], element_Objects));
					}
					else if (element_Objects.GetLeaderId() == taiwuCharId)
					{
						duplicateCharacterBlocks.Add((areaBlocks[i], element_Objects));
					}
				}
			}
			else
			{
				hashSet = EmptyCharacterSet;
			}
			HashSet<int> infectedCharacterSet = areaBlocks[i].InfectedCharacterSet;
			if (infectedCharacterSet == null)
			{
				continue;
			}
			foreach (int item2 in infectedCharacterSet)
			{
				Character element_Objects2 = DomainManager.Character.GetElement_Objects(item2);
				if (!element_Objects2.GetLocation().Equals(other))
				{
					duplicateCharacterBlocks.Add((areaBlocks[i], element_Objects2));
				}
				else if (element_Objects2.GetLeaderId() == taiwuCharId)
				{
					duplicateCharacterBlocks.Add((areaBlocks[i], element_Objects2));
				}
				else if (hashSet.Contains(item2))
				{
					duplicateCharacterBlocks.Add((areaBlocks[i], element_Objects2));
				}
			}
		}
	}

	private void FixInventoryAndEquippedItem(DataContext context, Character character, HashSet<ItemKey> worldCharacterItems)
	{
		bool flag = DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 74, 23);
		bool flag2 = DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 74, 23);
		bool versionNeedRepairSectAccessory = DomainManager.Item.VersionNeedRepairSectAccessory;
		int id = character.GetId();
		Inventory inventory = character.GetInventory();
		List<ItemKey> obj = context.AdvanceMonthRelatedData.ItemKeys.Occupy();
		obj.AddRange(inventory.Items.Keys);
		bool flag3 = false;
		for (int i = 0; i < obj.Count; i++)
		{
			ItemKey itemKey = obj[i];
			int num = inventory.Items[itemKey];
			if (!ItemTemplateHelper.CheckTemplateValid(itemKey.ItemType, itemKey.TemplateId))
			{
				Logger.Warn($"Removing {character}'s inventory item {itemKey.Id} with invalid template: ItemType {itemKey.ItemType}, TemplateId {itemKey.TemplateId}");
				inventory.OfflineRemove(itemKey, num);
				if (DomainManager.Item.ItemExists(itemKey))
				{
					DomainManager.Item.ForceRemoveItem(context, itemKey);
				}
				flag3 = true;
			}
			else if (DomainManager.Item.ItemExists(itemKey))
			{
				ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey);
				ItemKey itemKey2 = baseItem.GetItemKey();
				if (!itemKey.Equals(itemKey2))
				{
					Logger.Warn($"Fixing {character}'s inventory item {itemKey}'s refine effect.");
					inventory.OfflineRemove(itemKey, num);
					inventory.OfflineAdd(itemKey2, num);
					flag3 = true;
				}
				if (ItemTemplateHelper.IsPureStackable(itemKey2))
				{
					continue;
				}
				if (num > 1)
				{
					Logger.Warn($"Fixing character {character}'s stacked non-stackable item {itemKey2}");
					inventory.Items[itemKey2] = 1;
					flag3 = true;
				}
				if (!worldCharacterItems.Add(itemKey2))
				{
					Logger.Warn($"Removing character {character}'s duplicate item {itemKey2}");
					inventory.OfflineRemove(itemKey2, 1);
					flag3 = true;
				}
				if (flag && ModificationStateHelper.IsActive(itemKey.ModificationState, 1))
				{
					ItemKey itemKey3 = ItemKey.Invalid;
					FullPoisonEffects value;
					if (DomainManager.Item.HasOldPoisonEffects(itemKey))
					{
						if (!DomainManager.Item.GetOldPoisonEffects(itemKey).HasPoison)
						{
							itemKey3 = DomainManager.Item.RemoveOldPoisonEffect(context, itemKey2);
						}
					}
					else if (!DomainManager.Item.PoisonEffects.TryGetValue(itemKey.Id, out value) || !value.IsValid)
					{
						itemKey3 = DomainManager.Item.RemovePoisonEffect(context, itemKey2);
					}
					if (itemKey3.IsValid())
					{
						inventory.OfflineRemove(itemKey2, 1);
						inventory.OfflineAdd(itemKey3, 1);
						flag3 = true;
						Logger.Warn($"Fixing abnormal item poison effect in {character}'s inventory: {itemKey2} => {itemKey3}");
					}
				}
				if (flag2 && ModificationStateHelper.IsActive(itemKey.ModificationState, 8))
				{
					inventory.OfflineRemove(itemKey2, 1);
					DomainManager.Item.RemoveItem(context, itemKey2);
					ItemKey itemKey4 = DomainManager.Item.CreateItem(context, itemKey2.ItemType, itemKey2.TemplateId);
					inventory.OfflineAdd(itemKey4, 1);
					ItemBase baseItem2 = DomainManager.Item.GetBaseItem(itemKey4);
					baseItem2.SetOwner(ItemOwnerType.CharacterInventory, character.GetId());
					flag3 = true;
					Logger.Warn($"Fixing abnormal item extra goods data in {character}'s inventory: {itemKey2} => {itemKey4}");
				}
				if (versionNeedRepairSectAccessory)
				{
					Inventory inventory2 = ((character.GetId() == DomainManager.Taiwu.GetTaiwuCharId()) ? null : inventory);
					flag3 = DomainManager.Item.RemoveRefinedEffectsAndReturnMaterial(context, itemKey2, inventory2, out var resultItem);
					if (flag3)
					{
						inventory.OfflineRemove(itemKey2);
						inventory.OfflineAdd(resultItem.GetItemKey(), 1);
						Logger.Warn($"Fixing sect accessory item refine data in {character}'s inventory: {itemKey2} => {resultItem.GetItemKey()}");
					}
				}
			}
			else
			{
				Logger.Warn($"Removing ghost item {itemKey} from {character}'s inventory.");
				inventory.OfflineRemove(itemKey, num);
				flag3 = true;
			}
		}
		context.AdvanceMonthRelatedData.ItemKeys.Release(ref obj);
		if (flag3)
		{
			character.SetInventory(inventory, context);
		}
		ItemKey[] equipment = character.GetEquipment();
		for (int j = 0; j < equipment.Length; j++)
		{
			ItemKey itemKey5 = equipment[j];
			if (!itemKey5.IsValid())
			{
				continue;
			}
			if (!ItemTemplateHelper.CheckTemplateValid(itemKey5.ItemType, itemKey5.TemplateId))
			{
				Logger.Warn($"Removing {character}'s equipped item {itemKey5.Id} with invalid template: ItemType {itemKey5.ItemType}, TemplateId {itemKey5.TemplateId}");
				equipment[j] = ItemKey.Invalid;
				character.SetEquipment(equipment, context);
				if (DomainManager.Item.ItemExists(itemKey5))
				{
					DomainManager.Item.ForceRemoveItem(context, itemKey5);
				}
			}
			else if (DomainManager.Item.ItemExists(itemKey5))
			{
				EquipmentBase baseEquipment = DomainManager.Item.GetBaseEquipment(itemKey5);
				if (baseEquipment.GetTemplateId() != itemKey5.TemplateId || baseEquipment.GetId() != itemKey5.Id)
				{
					equipment[j] = ItemKey.Invalid;
					character.SetEquipment(equipment, context);
					DomainManager.Item.ForceRemoveItem(context, itemKey5);
					Logger.Warn($"Removing {character}'s equipped item {itemKey5} whose key differs from object ({baseEquipment.GetType().Name}, {baseEquipment.GetTemplateId()}, {baseEquipment.GetId()}).");
					continue;
				}
				ItemKey itemKey6 = baseEquipment.GetItemKey();
				if (!itemKey5.Equals(itemKey6))
				{
					Logger.Warn($"Fixing {character}'s equipment {itemKey5}'s refine effect.");
					equipment[j] = itemKey6;
					character.SetEquipment(equipment, context);
				}
				if (inventory.Items.ContainsKey(itemKey5))
				{
					inventory.OfflineRemove(itemKey5);
					character.SetInventory(inventory, context);
					Logger.Warn($"Removing {itemKey5} from {id}'s inventory because it already exists in equipments.");
				}
				else if (!worldCharacterItems.Add(itemKey6))
				{
					Logger.Warn($"Removing character {character}'s duplicate item {itemKey6}");
					if (baseEquipment.GetEquippedCharId() == id)
					{
						baseEquipment.SetEquippedCharId(-1, context);
					}
					equipment[j] = ItemKey.Invalid;
					character.SetEquipment(equipment, context);
				}
				else if (baseEquipment.GetEquippedCharId() != id && character.GetCreatingType() == 1)
				{
					Logger.Warn($"Fixing {character}'s equipment {itemKey5}'s equipped char id.");
					baseEquipment.SetEquippedCharId(id, context);
				}
				if (flag && ModificationStateHelper.IsActive(itemKey5.ModificationState, 1))
				{
					ItemKey itemKey7 = ItemKey.Invalid;
					FullPoisonEffects value2;
					if (DomainManager.Item.HasOldPoisonEffects(itemKey5))
					{
						if (!DomainManager.Item.GetOldPoisonEffects(itemKey5).HasPoison)
						{
							itemKey7 = DomainManager.Item.RemoveOldPoisonEffect(context, itemKey6);
						}
					}
					else if (!DomainManager.Item.PoisonEffects.TryGetValue(itemKey5.Id, out value2) || !value2.IsValid)
					{
						itemKey7 = DomainManager.Item.RemovePoisonEffect(context, itemKey6);
					}
					if (itemKey7.IsValid())
					{
						equipment[j] = itemKey7;
						character.SetEquipment(equipment, context);
						Logger.Warn($"Fixing abnormal item poison effect in {character}'s equipments: {itemKey6} => {itemKey7}");
					}
				}
				if (flag2 && ModificationStateHelper.IsActive(itemKey5.ModificationState, 8))
				{
					DomainManager.Item.RemoveItem(context, itemKey6);
					ItemKey itemKey8 = DomainManager.Item.CreateItem(context, itemKey5.ItemType, itemKey5.TemplateId);
					ItemBase baseItem3 = DomainManager.Item.GetBaseItem(itemKey8);
					baseItem3.SetOwner(ItemOwnerType.CharacterEquipment, character.GetId());
					equipment[j] = itemKey8;
					character.SetEquipment(equipment, context);
					Logger.Warn($"Fixing abnormal item extra goods data in {character}'s equipments: {itemKey6} => {itemKey8}");
				}
				if (versionNeedRepairSectAccessory)
				{
					Inventory inventory3 = ((character.GetId() == DomainManager.Taiwu.GetTaiwuCharId()) ? null : inventory);
					if (DomainManager.Item.RemoveRefinedEffectsAndReturnMaterial(context, itemKey6, inventory3, out var resultItem2))
					{
						equipment[j] = resultItem2.GetItemKey();
						character.SetEquipment(equipment, context);
						Logger.Warn($"Fixing sect accessory item refine data in {character}'s equipments: {itemKey6} => {resultItem2.GetItemKey()}");
					}
				}
			}
			else
			{
				equipment[j] = ItemKey.Invalid;
				character.SetEquipment(equipment, context);
				Logger.Warn($"Removing ghost item {itemKey5} from {id}'s equipment.");
			}
		}
	}

	private void FixAbnormalPregnantState(DataContext context, Character character)
	{
		if (character.GetFeatureIds().Contains(197) && !_pregnantStates.ContainsKey(character.GetId()))
		{
			var (text, text2) = GetRealName(character);
			character.RemoveFeature(context, 197);
			Logger.Warn($"Fixing character {character.GetId()} ({text + text2})'s pregnant state. ");
		}
	}

	private void FixAbnormalCharacterOrganization(DataContext context, Character character)
	{
		if (character.GetCreatingType() != 1)
		{
			return;
		}
		int id = character.GetId();
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		SettlementCharacter settlementChar2;
		if (organizationInfo.SettlementId < 0)
		{
			if (organizationInfo.OrgTemplateId == 20 && !character.GetFeatureIds().Contains(218))
			{
				DomainManager.Organization.JoinNearbyVillageTownAsBeggar(context, character, -1);
				(string surname, string givenName) realName = GetRealName(character);
				string item = realName.surname;
				string item2 = realName.givenName;
				OrganizationItem organizationItem = Config.Organization.Instance[organizationInfo.OrgTemplateId];
				OrganizationItem organizationItem2 = Config.Organization.Instance[character.GetOrganizationInfo().OrgTemplateId];
				Logger.Warn($"Fixing character {character} ({item + item2})'s organization - {organizationItem.Name} => {organizationItem2.Name}");
			}
			else if (OrganizationDomain.IsLargeSect(organizationInfo.OrgTemplateId))
			{
				organizationInfo.SettlementId = DomainManager.Organization.GetSettlementIdByOrgTemplateId(organizationInfo.OrgTemplateId);
				if (!DomainManager.Organization.TryGetSettlementCharacter(id, out var _))
				{
					var (text, text2) = GetRealName(character);
					Logger.Warn($"Fixing character {character} ({text + text2})'s organization - {Config.Organization.Instance[organizationInfo.OrgTemplateId].Name}");
					DomainManager.Organization.JoinOrganization(context, character, organizationInfo);
				}
				character.SetOrganizationInfo(organizationInfo, context);
			}
		}
		else if (!DomainManager.Organization.TryGetSettlementCharacter(id, out settlementChar2))
		{
			var (text3, text4) = GetRealName(character);
			Logger.Warn($"Fixing character {character} ({text3 + text4})'s organization - {Config.Organization.Instance[organizationInfo.OrgTemplateId].Name}");
			DomainManager.Organization.JoinOrganization(context, character, organizationInfo);
		}
	}

	private void FixAbnormalCharacterCombatSkillBreakoutCount(DataContext context, Character character)
	{
		if (Config.Character.Instance[character.GetTemplateId()].CreatingType != 0)
		{
			return;
		}
		Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(character.GetId());
		foreach (var (index, combatSkill2) in charCombatSkills)
		{
			if (combatSkill2.GetBreakoutStepsCount() > GlobalConfig.Instance.BreakoutMaxAvailableStepsCount)
			{
				Logger.Warn($"Fixing character {character.GetId()} ({character.GetSurname() + character.GetGivenName()})'s skill {Config.CombatSkill.Instance[index]} breakout step.");
				combatSkill2.SetBreakoutStepsCount(GlobalConfig.Instance.BreakoutMaxAvailableStepsCount, context);
			}
		}
	}

	private void FixCharacterConsummateLevel(DataContext context, Character character)
	{
		sbyte consummateLevel = character.GetConsummateLevel();
		if (consummateLevel < 0 || consummateLevel >= ConsummateLevel.Instance.Count)
		{
			sbyte b = (sbyte)Math.Clamp(consummateLevel, 0, ConsummateLevel.Instance.Count - 1);
			character.SetConsummateLevel(b, context);
			Logger.Warn($"Fixing {character}'s abnormal consummate level: {consummateLevel} => {b}");
		}
	}

	private unsafe void FixCharacterMaxNeili(DataContext context, Character character)
	{
		Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(character.GetId());
		foreach (KeyValuePair<short, GameData.Domains.CombatSkill.CombatSkill> item in charCombatSkills)
		{
			item.Deconstruct(out var key, out var value);
			short index = key;
			GameData.Domains.CombatSkill.CombatSkill combatSkill = value;
			short obtainedNeili = combatSkill.GetObtainedNeili();
			if (obtainedNeili < 0)
			{
				short totalObtainableNeili = combatSkill.GetTotalObtainableNeili();
				combatSkill.SetObtainedNeili(totalObtainableNeili, context);
				Logger.Warn($"Fixing {character}'s abnormal combat skill {Config.CombatSkill.Instance[index].Name}'s obtained neili {obtainedNeili} => {totalObtainableNeili}");
			}
		}
		NeiliAllocation baseNeiliAllocation = character.GetBaseNeiliAllocation();
		if (baseNeiliAllocation.GetTotal() < 0)
		{
			character.ResetBaseNeiliAllocation(context);
			Logger.Warn($"Fixing {character}'s abnormal base neili allocation: {baseNeiliAllocation} => {character.GetBaseNeiliAllocation()}");
			return;
		}
		int maxNeili = character.GetMaxNeili();
		sbyte consummateLevel = character.GetConsummateLevel();
		short maxTotalNeiliAllocationConsideringFeature = CombatHelper.GetMaxTotalNeiliAllocationConsideringFeature(consummateLevel, character.GetFeatureIds());
		if (maxNeili >= 0)
		{
			return;
		}
		NeiliAllocation neiliAllocation = baseNeiliAllocation;
		for (int i = 0; i < 4; i++)
		{
			if (neiliAllocation.Items[i] > 100)
			{
				neiliAllocation.Items[i] = 100;
			}
		}
		character.SetBaseNeiliAllocation(neiliAllocation, context);
		while (character.GetMaxNeili() < 0 || neiliAllocation.GetTotal() > maxTotalNeiliAllocationConsideringFeature)
		{
			sbyte b = -1;
			int num = 0;
			for (sbyte b2 = 0; b2 < 4; b2++)
			{
				if (neiliAllocation.Items[b2] > num)
				{
					num = neiliAllocation.Items[b2];
					b = b2;
				}
			}
			if (b >= 0)
			{
				neiliAllocation.Items[b] = (short)(num - 1);
				character.SetBaseNeiliAllocation(neiliAllocation, context);
			}
		}
		Logger.Warn($"Fixing {character}'s abnormal base neili allocation: {baseNeiliAllocation} => {neiliAllocation}");
		Logger.Warn($"Fixing {character}'s abnormal max neili: {maxNeili} => {character.GetMaxNeili()}");
	}

	private void FixCharacterCurrNeili(DataContext context, Character character)
	{
		int currNeili = character.GetCurrNeili();
		if (currNeili < 0)
		{
			int maxNeili = character.GetMaxNeili();
			character.SetCurrNeili(maxNeili, context);
			Logger.Warn($"Fix abnormal currNeili for {character}: {currNeili} => {maxNeili}");
		}
	}

	private void FixAbnormalGroupState(DataContext context, Character character)
	{
		int id = character.GetId();
		int leaderId = character.GetLeaderId();
		if (leaderId >= 0 && (leaderId != DomainManager.Taiwu.GetTaiwuCharId() || !DomainManager.Taiwu.IsInGroup(id)) && !_joinGroupDates.ContainsKey(id))
		{
			IReadOnlySet<int> specialGroup = DomainManager.Extra.GetSpecialGroup(leaderId);
			if (!specialGroup.Contains(id))
			{
				character.SetLeaderId(-1, context);
				Logger.Warn($"Fixing character {id}'s invalid group state with leader {leaderId}.");
			}
		}
	}

	private unsafe void FixAbnormalInsectFeature(DataContext context, Character character)
	{
		List<short> featureIds = character.GetFeatureIds();
		if (featureIds.Contains(339))
		{
			int id = character.GetId();
			RelatedCharacters relatedCharacters = GetRelatedCharacters(id);
			int* ptr = stackalloc int[2];
			GetActualBloodParents(id, relatedCharacters, ptr);
			int num = ptr[1];
			int num2 = *ptr;
			if (num >= 0 && num2 >= 0 && num != num2 && !IsInsect(num, num2))
			{
				character.RemoveFeature(context, 339);
				Logger.Warn($"Removing character {character}'s abnormal insect feature.");
			}
		}
	}

	private void FixAbnormalFeature(DataContext context, Character character)
	{
		bool flag = false;
		int id = character.GetId();
		List<short> featureIds = character.GetFeatureIds();
		for (int num = featureIds.Count - 1; num >= 0; num--)
		{
			short num2 = featureIds[num];
			CharacterFeatureItem characterFeatureItem = CharacterFeature.Instance[num2];
			int date;
			if (characterFeatureItem == null)
			{
				featureIds.RemoveAt(num);
				Logger.Warn($"Removing character {character}'s invalid feature {num2}.");
				flag = true;
			}
			else if (characterFeatureItem.Duration > 0 && !DomainManager.Extra.TryGetTemporaryFeatureExpireDate(id, num2, out date) && character.GetCreatingType() == 1)
			{
				DomainManager.Extra.RegisterCharacterTemporaryFeature(context, id, num2);
				Logger.Warn($"Fixing character {character}'s feature {characterFeatureItem.Name}'s expiring date.");
				flag = true;
			}
		}
		if (flag)
		{
			character.SetFeatureIds(featureIds, context);
		}
	}

	private void FixAbnormalCharacterLocation(DataContext context, Character character)
	{
		int id = character.GetId();
		Location location = character.GetLocation();
		int leaderId = character.GetLeaderId();
		if (character.GetCreatingType() != 1 || character.IsActiveExternalRelationState(60))
		{
			return;
		}
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		if (taiwuCharId == id || character.GetKidnapperId() >= 0)
		{
			return;
		}
		if (location.IsValid())
		{
			MapBlockData block = DomainManager.Map.GetBlock(location);
			if (character.IsCompletelyInfected())
			{
				if (block.InfectedCharacterSet != null && block.InfectedCharacterSet.Contains(id))
				{
					if (!block.IsPassable())
					{
						short randomEdgeBlock = DomainManager.Map.GetRandomEdgeBlock(context.Random, block.AreaId, (sbyte)context.Random.Next(4));
						GroupMove(context, character, new Location(location.AreaId, randomEdgeBlock));
						Logger.Warn($"Fixing character {character}'s not passable location {location}");
					}
					return;
				}
				if (DomainManager.Taiwu.IsInGroup(id))
				{
					return;
				}
				block.AddInfectedCharacter(id);
				DomainManager.Map.SetBlockData(context, block);
				Logger.Warn($"Fixing character {character}'s hidden state at {location}");
			}
			else
			{
				if (block.CharacterSet != null && block.CharacterSet.Contains(id))
				{
					if (!block.IsPassable())
					{
						short randomEdgeBlock2 = DomainManager.Map.GetRandomEdgeBlock(context.Random, block.AreaId, (sbyte)context.Random.Next(4));
						GroupMove(context, character, new Location(location.AreaId, randomEdgeBlock2));
						Logger.Warn($"Fixing character {character}'s not passable location {location}");
					}
					return;
				}
				if (DomainManager.Taiwu.IsInGroup(id))
				{
					return;
				}
				block.AddCharacter(id);
				DomainManager.Map.SetBlockData(context, block);
				Logger.Warn($"Fixing character {character}'s hidden state at {location}");
			}
		}
		else if (character.IsCrossAreaTraveling() || leaderId == taiwuCharId)
		{
			return;
		}
		if (leaderId >= 0)
		{
			Location location2 = _objects[leaderId].GetLocation();
			if (!location2.Equals(location))
			{
				Events.RaiseCharacterLocationChanged(context, id, location, location2);
				character.SetLocation(location2, context);
				Logger.Warn($"Fixing character {character}'s location from {location} to {character.GetLocation()}");
			}
			else if (!location2.IsValid())
			{
				Location birthLocation = character.GetBirthLocation();
				Location targetLocation = (birthLocation.IsValid() ? birthLocation : DomainManager.Taiwu.GetTaiwuVillageLocation());
				GroupMove(context, character, targetLocation);
				Logger.Warn($"Fixing character {character}'s location from {location} to {character.GetLocation()}");
			}
		}
		else if (!location.IsValid())
		{
			Location birthLocation2 = character.GetBirthLocation();
			Location location3 = (birthLocation2.IsValid() ? birthLocation2 : DomainManager.Taiwu.GetTaiwuVillageLocation());
			if (character.IsCompletelyInfected())
			{
				Events.RaiseInfectedCharacterLocationChanged(context, id, location, location3);
			}
			else
			{
				Events.RaiseCharacterLocationChanged(context, id, location, location3);
			}
			character.SetLocation(location3, context);
			Logger.Warn($"Fixing character {character}'s location from {location} to {character.GetLocation()}");
		}
	}

	private void FixMerchantCharToType(DataContext context, Character character)
	{
		int id = character.GetId();
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		OrganizationItem organizationItem = Config.Organization.Instance[organizationInfo.OrgTemplateId];
		OrganizationMemberItem orgMemberConfig = OrganizationDomain.GetOrgMemberConfig(organizationInfo);
		List<sbyte> identityInteractConfig = orgMemberConfig.IdentityInteractConfig;
		sbyte type2;
		if (organizationItem.IsCivilian && organizationInfo.Grade == 4 && identityInteractConfig != null && identityInteractConfig.Contains(4))
		{
			if (!DomainManager.Extra.TryGetMerchantCharToType(id, out var _))
			{
				MerchantData value;
				sbyte b = ((!DomainManager.Merchant.TryGetMerchantData(id, out value)) ? ((sbyte)context.Random.Next(7)) : value.MerchantType);
				DomainManager.Extra.AddMerchantCharToType(id, b, context);
				Logger.Warn($"Fix abnormal merchant type for {character}: _ => {b}.");
			}
		}
		else if (DomainManager.Extra.TryGetMerchantCharToType(id, out type2))
		{
			VillagerRoleBase villagerRole = DomainManager.Extra.GetVillagerRole(id);
			if (!(villagerRole is VillagerRoleMerchant))
			{
				DomainManager.Extra.RemoveMerchantCharToType(id, context);
				Logger.Warn($"Fix abnormal merchant type for {character}: {type2} => _");
			}
		}
	}

	private unsafe void MigratePrioritizedActionCooldown(DataContext context)
	{
		int currDate = DomainManager.World.GetCurrDate();
		foreach (var (charId, character2) in _objects)
		{
			if (DomainManager.Extra.TryPopAiActionCooldownData(context, charId, 0, 9, out var date))
			{
				DomainManager.Extra.SetPrioritizedActionCooldown(context, charId, 9, (short)(date - currDate));
			}
			PrioritizedActionCooldownSbytes prioritizedActionCooldowns = character2.GetPrioritizedActionCooldowns();
			for (sbyte b = 0; b < 9; b++)
			{
				if (prioritizedActionCooldowns.Items[b] > 0)
				{
					DomainManager.Extra.SetPrioritizedActionCooldown(context, charId, b, prioritizedActionCooldowns.Items[b]);
				}
			}
			prioritizedActionCooldowns.SetAllActionCooldown(0);
			character2.SetPrioritizedActionCooldowns(prioritizedActionCooldowns, context);
		}
	}

	private void FixAbnormalPrioritizedAction73(DataContext context)
	{
		foreach (var (charId, character2) in _objects)
		{
			if (TryGetCharacterPrioritizedAction(charId, out var action) && action.ActionType == 18)
			{
				Logger.Warn($"fix abnormal prioritized action target location: {character2}, {action.Target.GetRealTargetLocation()} ");
				Location targetLocation = character2.CalcFurthestEscapeDestination(context.Random);
				action.Target = new NpcTravelTarget(targetLocation, action.Target.RemainingMonth);
				SetCharacterPrioritizedAction(context, charId);
			}
		}
	}

	private void FixAbnormalPrioritizedAction71(DataContext context)
	{
		foreach (var (num2, character2) in _objects)
		{
			if (TryGetCharacterPrioritizedAction(num2, out var action))
			{
				if (action.ActionType == 11)
				{
					SectStoryShixiangToFightEnemyAction sectStoryShixiangToFightEnemyAction = new SectStoryShixiangToFightEnemyAction
					{
						Target = action.Target
					};
					DomainManager.Character.RemoveCharacterPrioritizedAction(context, num2);
					DomainManager.Character.AddCharacterPrioritizedAction(context, num2, sectStoryShixiangToFightEnemyAction);
					Logger.Warn($"fix abnormal prioritized action: {num2}, {sectStoryShixiangToFightEnemyAction.ActionType} ");
				}
				else if (action.ActionType == 12)
				{
					AdoptInfantAction adoptInfantAction = new AdoptInfantAction
					{
						Target = action.Target
					};
					DomainManager.Character.RemoveCharacterPrioritizedAction(context, num2);
					DomainManager.Character.AddCharacterPrioritizedAction(context, num2, adoptInfantAction);
					Logger.Warn($"fix abnormal prioritized action: {num2}, {adoptInfantAction.ActionType} ");
				}
			}
		}
	}

	private void FixInteractedCharacters(DataContext context)
	{
		if (!DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 74, 11))
		{
			return;
		}
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		foreach (var (num2, character2) in _objects)
		{
			if (TryGetRelation(taiwuCharId, num2, out var _))
			{
				DomainManager.Extra.AddInteractedCharacter(context, num2);
			}
		}
	}

	public void FixElopeWithLoveWrongState(DataContext context)
	{
		if (!DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 75))
		{
			return;
		}
		foreach (KeyValuePair<int, Character> @object in _objects)
		{
			if (!@object.Value.IsActiveExternalRelationState(32) || !@object.Value.GetLocation().IsValid() || @object.Value.IsActiveExternalRelationState(16))
			{
				continue;
			}
			sbyte prisonerSect = DomainManager.Organization.GetPrisonerSect(@object.Key);
			if (prisonerSect != -1)
			{
				Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(prisonerSect);
				if (settlementByOrgTemplateId != null && settlementByOrgTemplateId is Sect sect)
				{
					sect.RemovePrisoner(context, @object.Key);
					Logger.Warn($"Remove prison state beacuse {@object.Key} location is valid");
				}
			}
		}
		EventArgBox globalEventArgumentBox = DomainManager.TaiwuEvent.GetGlobalEventArgumentBox();
		for (short num = 0; num < 45; num++)
		{
			AreaAdventureData adventuresInArea = DomainManager.Adventure.GetAdventuresInArea(num);
			foreach (KeyValuePair<short, AdventureSiteData> adventureSite in adventuresInArea.AdventureSites)
			{
				if (adventureSite.Value.TemplateId == 28)
				{
					int objectId = globalEventArgumentBox.GetInt("StoryForeverLoverId");
					if (TryGetElement_Objects(objectId, out var element) && element.IsActiveExternalRelationState(32))
					{
						DomainManager.Adventure.RemoveAdventureSite(context, num, adventureSite.Key, isTimeout: false, isComplete: false);
						globalEventArgumentBox.Remove<int>("StoryForeverLoverId");
						Logger.Warn($"Remove ElopeWithLove Adventure beacuse {element} is hide state");
						return;
					}
				}
			}
		}
	}

	private void InitializeCombatSkillProficiencies(DataContext context)
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		foreach (var (num2, character2) in _objects)
		{
			if (num2 != taiwuCharId)
			{
				DomainManager.Extra.InitCombatSkillProficiency(context, character2);
			}
		}
		Logger.Warn($"{_objects.Count - 1} characters' proficiency data has been initialized");
	}

	public void SortCharacterListByLifeSkill(List<int> managerList, sbyte lifeSkillType)
	{
		managerList.Sort((int l, int r) => _objects[l].GetLifeSkillAttainment(lifeSkillType).CompareTo(_objects[r].GetLifeSkillAttainment(lifeSkillType)));
	}

	[DomainMethod]
	public List<IntPair> SortCharacterListByMaxCombatSkill(List<int> managerList)
	{
		managerList.Sort((int l, int r) => _objects[l].GetMaxCombatSkillAttainment().CompareTo(_objects[r].GetMaxCombatSkillAttainment()));
		List<IntPair> list = new List<IntPair>();
		for (int num = 0; num < managerList.Count; num++)
		{
			list.Add(new IntPair(managerList[num], _objects[managerList[num]].GetMaxCombatSkillAttainment()));
		}
		return list;
	}

	[DomainMethod]
	public (sbyte, short) GetCharacterMaxCombatSkillAttainment(int charId)
	{
		return _objects[charId].GetMaxCombatSkillAttainmentType();
	}

	private void FixKidnappedCharResistance(DataContext context)
	{
		if ((object)DomainManager.World.GetCurrWorldGameVersion() != null && !DomainManager.World.IsCurrWorldBeforeVersion(0, 0, 79))
		{
			return;
		}
		List<int> list = _kidnappedChars.Keys.ToList();
		foreach (int item in list)
		{
			KidnappedCharacterList kidnappedCharacterList = _kidnappedChars[item];
			if (kidnappedCharacterList == null || kidnappedCharacterList.GetCount() == 0)
			{
				continue;
			}
			foreach (KidnappedCharacter item2 in kidnappedCharacterList.GetCollection())
			{
				item2.ExtraResistance = 0;
			}
			SetElement_KidnappedChars(item, kidnappedCharacterList, context);
		}
	}

	public bool HandleAttackAction(DataContext context, Character selfChar, Character targetChar)
	{
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int id = selfChar.GetId();
		int id2 = targetChar.GetId();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int leaderId = selfChar.GetLeaderId();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		Location location = selfChar.GetLocation();
		if (id == taiwuCharId)
		{
			AiHelper.NpcCombatResultType npcCombatResultType = SimulateCharacterCombat(context, selfChar, targetChar, CombatType.Beat, isGroupCombat: false);
			bool flag = (uint)npcCombatResultType <= 1u;
			bool flag2 = flag;
			if (flag2)
			{
				SimulateCharacterCombatResult(context, selfChar, targetChar, -2147483647, -2147483647, 100);
			}
			else
			{
				SimulateCharacterCombatResult(context, targetChar, selfChar, -2147483647, -2147483647, 100);
			}
			return flag2;
		}
		if (leaderId >= 0 && leaderId == targetChar.GetLeaderId())
		{
			LeaveGroup(context, selfChar);
		}
		if (taiwuCharId == id2)
		{
			AddLockMovementCharSet(id);
			MonthlyEventCollection monthlyEventCollection = DomainManager.World.GetMonthlyEventCollection();
			if (selfChar.IsCompletelyInfected())
			{
				if (DomainManager.Extra.IsAiActionInCooldown(id, 3, 1))
				{
					return false;
				}
				monthlyEventCollection.AddInfectedCharacterAttack(location, id);
				DomainManager.Extra.AddAiActionCooldown(context, id, 3, 1, 3);
			}
			else if (DomainManager.LegendaryBook.IsCharacterActingCrazy(selfChar))
			{
				if (DomainManager.Extra.IsAiActionInCooldown(id, 3, 2))
				{
					return false;
				}
				switch (selfChar.GetLegendaryBookOwnerState())
				{
				case 1:
					monthlyEventCollection.AddLegendaryBookShockedAttack(taiwuCharId, location, id);
					break;
				case 2:
					monthlyEventCollection.AddLegendaryBookInsaneAttack(taiwuCharId, location, id);
					break;
				case 3:
					monthlyEventCollection.AddLegendaryBookConsumedAttack(taiwuCharId, location, id);
					break;
				}
				DomainManager.Extra.AddAiActionCooldown(context, id, 3, 2, 3);
			}
			else
			{
				if (DomainManager.Extra.IsAiActionInCooldown(id, 3, 0))
				{
					return false;
				}
				monthlyEventCollection.AddRevengeAttack(id2, location, id);
				DomainManager.Extra.AddAiActionCooldown(context, id, 3, 0, 3);
			}
			return true;
		}
		if (location.Equals(taiwu.GetLocation()) && (targetChar.GetLeaderId() == taiwuCharId || (CheckRequestHelpFromTaiwu(context.Random, id2, taiwuCharId) && CheckNeedProtection(targetChar, selfChar))) && !selfChar.IsCompletelyInfected() && !DomainManager.LegendaryBook.IsCharacterActingCrazy(selfChar))
		{
			MonthlyEventCollection monthlyEventCollection2 = DomainManager.World.GetMonthlyEventCollection();
			monthlyEventCollection2.AddAskProtectByRevengeAttack(id2, location, id, taiwuCharId);
			return true;
		}
		MapBlockData block = DomainManager.Map.GetBlock(location);
		if (block.CharacterSet != null)
		{
			foreach (int item in block.CharacterSet)
			{
				if (item == id || !TryGetCharacterPrioritizedAction(item, out var action) || action.ActionType != 2 || action.Target.TargetCharId != id2)
				{
					continue;
				}
				Character element_Objects = GetElement_Objects(item);
				if (element_Objects.NeedToAvoidCombat(CombatType.Die) || DomainManager.LegendaryBook.IsCharacterActingCrazy(element_Objects))
				{
					continue;
				}
				SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
				int dataOffset = secretInformationCollection.AddOfferProtection(item, id2, id);
				int num = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
				if (IsTaiwuPeople(item) || IsTaiwuPeople(id2))
				{
					MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
					monthlyNotificationCollection.AddProtectRelativeOrFriend(item, id2, id);
				}
				lifeRecordCollection.AddOfferProtection(item, currDate, id2, location);
				AiHelper.NpcCombatResultType npcCombatResultType2 = SimulateCharacterCombat(context, selfChar, element_Objects, CombatType.Die);
				if ((uint)npcCombatResultType2 <= 1u)
				{
					SimulateCharacterCombatResult(context, selfChar, element_Objects, 60, 60, 60);
					return true;
				}
				SimulateCharacterCombatResult(context, element_Objects, selfChar, 60, 60, 60);
				return false;
			}
		}
		AiHelper.NpcCombatResultType npcCombatResultType3 = SimulateCharacterCombat(context, selfChar, targetChar, CombatType.Die);
		if ((uint)npcCombatResultType3 <= 1u)
		{
			SimulateCharacterCombatResult(context, selfChar, targetChar, 60, 60, 60);
			return true;
		}
		SimulateCharacterCombatResult(context, targetChar, selfChar, 60, 60, 60);
		return false;
	}

	public void ApplyPlotHarmActionEffect(DataContext context, Character selfChar, Character targetChar, ItemKey itemKey)
	{
		short lifeSkillAttainment = selfChar.GetLifeSkillAttainment(8);
		int damage = CalcPlotHarmActionBaseDamage(lifeSkillAttainment);
		targetChar.TakeRandomDamage(context, damage);
		if (itemKey.IsValid())
		{
			selfChar.RemoveInventoryItem(context, itemKey, 1, deleteItem: false);
			ApplyMedicineEffectForPlotHarm(context, selfChar, itemKey);
		}
	}

	public bool HandlePlotHarmAction(DataContext context, Character selfChar, Character targetChar, ItemKey itemKey, sbyte actionPhase = -1)
	{
		int id = selfChar.GetId();
		int id2 = targetChar.GetId();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		Location location = selfChar.GetLocation();
		selfChar.ChangeCurrMainAttribute(context, 4, -GlobalConfig.Instance.HarmfulActionCost);
		if (actionPhase < 0)
		{
			actionPhase = selfChar.GetPlotHarmActionPhase(context.Random, targetChar);
		}
		if (actionPhase >= 4)
		{
			SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
			int dataOffset = secretInformationCollection.AddPlotHarmEnemy(id, id2);
			int num = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
			ApplyPlotHarmActionEffect(context, selfChar, targetChar, itemKey);
		}
		switch (actionPhase)
		{
		case 0:
			if (itemKey.IsValid())
			{
				lifeRecordCollection.AddPlotHarmEnemyFail12(id, currDate, id2, location, itemKey.ItemType, itemKey.TemplateId);
			}
			else
			{
				lifeRecordCollection.AddPlotHarmEnemyFail1(id, currDate, id2, location);
			}
			break;
		case 1:
			if (itemKey.IsValid())
			{
				lifeRecordCollection.AddPlotHarmEnemyFail22(id, currDate, id2, location, itemKey.ItemType, itemKey.TemplateId);
			}
			else
			{
				lifeRecordCollection.AddPlotHarmEnemyFail2(id, currDate, id2, location);
			}
			break;
		case 2:
			if (itemKey.IsValid())
			{
				lifeRecordCollection.AddPlotHarmEnemyFail32(id, currDate, id2, location, itemKey.ItemType, itemKey.TemplateId);
			}
			else
			{
				lifeRecordCollection.AddPlotHarmEnemyFail3(id, currDate, id2, location);
			}
			break;
		case 3:
			if (itemKey.IsValid())
			{
				lifeRecordCollection.AddPlotHarmEnemyFail42(id, currDate, id2, location, itemKey.ItemType, itemKey.TemplateId);
			}
			else
			{
				lifeRecordCollection.AddPlotHarmEnemyFail4(id, currDate, id2, location);
			}
			break;
		case 4:
			if (itemKey.IsValid())
			{
				lifeRecordCollection.AddPlotHarmEnemySucceed2(id, currDate, id2, location, itemKey.ItemType, itemKey.TemplateId);
			}
			else
			{
				lifeRecordCollection.AddPlotHarmEnemySucceed(id, currDate, id2, location);
			}
			if (id != taiwuCharId && id2 != taiwuCharId)
			{
				AiHelper.NpcCombatResultType npcCombatResultType = SimulateCharacterCombat(context, selfChar, targetChar, CombatType.Die);
				if ((uint)npcCombatResultType <= 1u)
				{
					SimulateCharacterCombatResult(context, selfChar, targetChar, 30, 50, 60);
				}
				else
				{
					SimulateCharacterCombatResult(context, targetChar, selfChar, 30, 50, 60);
				}
			}
			else if (DomainManager.World.GetAdvancingMonthState() != 0 && DomainManager.World.GetAdvancingMonthState() != 20)
			{
				if (id2 == taiwuCharId)
				{
					MonthlyEventCollection monthlyEventCollection2 = DomainManager.World.GetMonthlyEventCollection();
					monthlyEventCollection2.AddCatchEnemyPlotHarm(id2, location, id);
				}
				else if (id == taiwuCharId)
				{
					AiHelper.NpcCombatResultType npcCombatResultType2 = SimulateCharacterCombat(context, selfChar, targetChar, CombatType.Beat, isGroupCombat: false);
					if ((uint)npcCombatResultType2 <= 1u)
					{
						SimulateCharacterCombatResult(context, selfChar, targetChar, -2147483647, -2147483647, 100);
					}
					else
					{
						SimulateCharacterCombatResult(context, targetChar, selfChar, -2147483647, -2147483647, 100);
					}
				}
			}
			return true;
		default:
			if (itemKey.IsValid())
			{
				lifeRecordCollection.AddPlotHarmEnemySucceedAndEscaped2(id, currDate, id2, location, itemKey.ItemType, itemKey.TemplateId);
			}
			else
			{
				lifeRecordCollection.AddPlotHarmEnemySucceedAndEscaped(id, currDate, id2, location);
			}
			if (id2 == taiwuCharId && DomainManager.World.GetAdvancingMonthState() != 0 && DomainManager.World.GetAdvancingMonthState() != 20)
			{
				MonthlyEventCollection monthlyEventCollection = DomainManager.World.GetMonthlyEventCollection();
				monthlyEventCollection.AddEnemyPlotHarmAndEscape(id2, location);
			}
			return true;
		}
		return false;
	}

	public void ApplyPoisonActionEffect(DataContext context, Character selfChar, Character targetChar, ItemKey itemKey)
	{
		short lifeSkillAttainment = selfChar.GetLifeSkillAttainment(9);
		(sbyte level, int amount) tuple = CalcPoisonActionBaseLevelAndAmount(lifeSkillAttainment);
		sbyte item = tuple.level;
		int item2 = tuple.amount;
		sbyte poisonType = (sbyte)context.Random.Next(6);
		targetChar.ChangePoisoned(context, poisonType, item, item2);
		if (itemKey.IsValid())
		{
			selfChar.RemoveInventoryItem(context, itemKey, 1, deleteItem: false);
			targetChar.AddEatingItem(context, itemKey);
		}
	}

	public bool HandlePoisonAction(DataContext context, Character selfChar, Character targetChar, ItemKey itemKey, sbyte actionPhase = -1)
	{
		int id = selfChar.GetId();
		int id2 = targetChar.GetId();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		Location location = selfChar.GetLocation();
		selfChar.ChangeCurrMainAttribute(context, 4, -GlobalConfig.Instance.HarmfulActionCost);
		if (actionPhase < 0)
		{
			actionPhase = selfChar.GetPoisonActionPhase(context.Random, targetChar);
		}
		if (actionPhase >= 4)
		{
			SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
			int dataOffset = secretInformationCollection.AddPoisonEnemy(id, id2);
			int num = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
			ApplyPoisonActionEffect(context, selfChar, targetChar, itemKey);
		}
		switch (actionPhase)
		{
		case 0:
			if (itemKey.IsValid())
			{
				lifeRecordCollection.AddPoisonEnemyFail1(id, currDate, id2, location, itemKey.ItemType, itemKey.TemplateId);
			}
			else
			{
				lifeRecordCollection.AddPoisonEnemyFail12(id, currDate, id2, location);
			}
			break;
		case 1:
			if (itemKey.IsValid())
			{
				lifeRecordCollection.AddPoisonEnemyFail2(id, currDate, id2, location, itemKey.ItemType, itemKey.TemplateId);
			}
			else
			{
				lifeRecordCollection.AddPoisonEnemyFail22(id, currDate, id2, location);
			}
			break;
		case 2:
			if (itemKey.IsValid())
			{
				lifeRecordCollection.AddPoisonEnemyFail3(id, currDate, id2, location, itemKey.ItemType, itemKey.TemplateId);
			}
			else
			{
				lifeRecordCollection.AddPoisonEnemyFail32(id, currDate, id2, location);
			}
			break;
		case 3:
			if (itemKey.IsValid())
			{
				lifeRecordCollection.AddPoisonEnemyFail4(id, currDate, id2, location, itemKey.ItemType, itemKey.TemplateId);
			}
			else
			{
				lifeRecordCollection.AddPoisonEnemyFail42(id, currDate, id2, location);
			}
			break;
		case 4:
			if (itemKey.IsValid())
			{
				lifeRecordCollection.AddPoisonEnemySucceed(id, currDate, id2, location, itemKey.ItemType, itemKey.TemplateId);
			}
			else
			{
				lifeRecordCollection.AddPoisonEnemySucceed2(id, currDate, id2, location);
			}
			if (id != taiwuCharId && id2 != taiwuCharId)
			{
				AiHelper.NpcCombatResultType npcCombatResultType = SimulateCharacterCombat(context, selfChar, targetChar, CombatType.Die);
				if ((uint)npcCombatResultType <= 1u)
				{
					SimulateCharacterCombatResult(context, selfChar, targetChar, 30, 50, 60);
				}
				else
				{
					SimulateCharacterCombatResult(context, targetChar, selfChar, 30, 50, 60);
				}
			}
			else if (DomainManager.World.GetAdvancingMonthState() != 0 && DomainManager.World.GetAdvancingMonthState() != 20)
			{
				if (id2 == taiwuCharId)
				{
					MonthlyEventCollection monthlyEventCollection2 = DomainManager.World.GetMonthlyEventCollection();
					monthlyEventCollection2.AddCatchEnemyPoison(id2, location, id);
				}
				else if (id == taiwuCharId)
				{
					AiHelper.NpcCombatResultType npcCombatResultType2 = SimulateCharacterCombat(context, selfChar, targetChar, CombatType.Beat, isGroupCombat: false);
					if ((uint)npcCombatResultType2 <= 1u)
					{
						SimulateCharacterCombatResult(context, selfChar, targetChar, -2147483647, -2147483647, 100);
					}
					else
					{
						SimulateCharacterCombatResult(context, targetChar, selfChar, -2147483647, -2147483647, 100);
					}
				}
			}
			return true;
		default:
			if (itemKey.IsValid())
			{
				lifeRecordCollection.AddPoisonEnemySucceedAndEscaped(id, currDate, id2, location, itemKey.ItemType, itemKey.TemplateId);
			}
			else
			{
				lifeRecordCollection.AddPoisonEnemySucceedAndEscaped2(id, currDate, id2, location);
			}
			if (id2 == taiwuCharId && DomainManager.World.GetAdvancingMonthState() != 0 && DomainManager.World.GetAdvancingMonthState() != 20)
			{
				MonthlyEventCollection monthlyEventCollection = DomainManager.World.GetMonthlyEventCollection();
				monthlyEventCollection.AddEnemyPoisonAndEscape(id2, location);
			}
			return true;
		}
		return false;
	}

	public bool HandleRapeAction(DataContext context, Character selfChar, Character targetChar)
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int id = selfChar.GetId();
		int id2 = targetChar.GetId();
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		Location location = selfChar.GetLocation();
		int currDate = DomainManager.World.GetCurrDate();
		short fertility = selfChar.GetFertility();
		bool flag = id2 != DomainManager.Taiwu.GetTaiwuCharId() && selfChar.GetCombatPower() > targetChar.GetCombatPower() && fertility > 50;
		if (flag)
		{
			selfChar.MakeLove(context, targetChar, isRape: true);
		}
		if (flag)
		{
			lifeRecordCollection.AddRapeSucceed(id, currDate, id2, location);
			DomainManager.Character.AddRelation(context, id2, id, 32768, currDate);
			DomainManager.Character.ChangeFavorabilityOptionalMonthlyEvolution(context, targetChar, selfChar, -30000);
			int dataOffset = secretInformationCollection.AddRape(id, id2);
			int num = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
		}
		else
		{
			if (id2 == taiwuCharId)
			{
				monthlyNotificationCollection.AddRapeFailure(id, location, id2);
			}
			lifeRecordCollection.AddRapeFail(id, currDate, id2, location);
			DomainManager.Character.AddRelation(context, id2, id, 32768, currDate);
			DomainManager.Character.ChangeFavorabilityOptionalMonthlyEvolution(context, targetChar, selfChar, -30000);
		}
		return flag;
	}

	public ItemKey SelectMostEffectivePoisonToUse(Character selfChar, Character targetChar)
	{
		EatingItems eatingItems = targetChar.GetEatingItems();
		int availableEatingSlotsCount = eatingItems.GetAvailableEatingSlotsCount(targetChar.GetCurrMaxEatingSlotsCount());
		if (availableEatingSlotsCount <= 0)
		{
			return ItemKey.Invalid;
		}
		int num = -1;
		ItemKey result = ItemKey.Invalid;
		foreach (ItemKey key in selfChar.GetInventory().Items.Keys)
		{
			if (key.ItemType == 8)
			{
				MedicineItem medicineItem = Config.Medicine.Instance[key.TemplateId];
				if (medicineItem.EffectType == EMedicineEffectType.ApplyPoison && medicineItem.Grade > num)
				{
					num = medicineItem.Grade;
					result = key;
				}
			}
		}
		return result;
	}

	private bool CheckRequestHelpFromTaiwu(IRandomSource random, int targetCharId, int taiwuCharId)
	{
		if (!TryGetRelation(targetCharId, taiwuCharId, out var relation))
		{
			return false;
		}
		sbyte favorabilityType = FavorabilityType.GetFavorabilityType(relation.Favorability);
		return favorabilityType >= 4 && random.CheckPercentProb(50 + (favorabilityType - 4) * 20);
	}

	private bool CheckNeedProtection(Character defender, Character attacker)
	{
		return defender.GetCombatPower() <= attacker.GetCombatPower() * 75 / 100;
	}

	private static int CalcPlotHarmActionBaseDamage(short attainment)
	{
		short[] plotHarmActionAttainmentThresholds = GlobalConfig.Instance.PlotHarmActionAttainmentThresholds;
		for (int num = plotHarmActionAttainmentThresholds.Length - 1; num >= 0; num--)
		{
			short num2 = plotHarmActionAttainmentThresholds[num];
			if (attainment >= num2)
			{
				return num + 1;
			}
		}
		return 1;
	}

	private static (sbyte level, int amount) CalcPoisonActionBaseLevelAndAmount(short attainment)
	{
		short[] poisonActionAttainmentThresholds = GlobalConfig.Instance.PoisonActionAttainmentThresholds;
		int num = attainment / 5;
		if (num <= 0)
		{
			num = 1;
		}
		for (int num2 = poisonActionAttainmentThresholds.Length - 1; num2 >= 0; num2--)
		{
			short num3 = poisonActionAttainmentThresholds[num2];
			int num4 = num2 + 1;
			if (attainment >= num3)
			{
				return (level: (sbyte)num4, amount: num * num4 * 10);
			}
		}
		return (level: 1, amount: num * 10);
	}

	private static void ApplyMedicineEffectForPlotHarm(DataContext context, Character character, ItemKey itemKey)
	{
		Tester.Assert(itemKey.ItemType == 8);
		MedicineItem medicineItem = Config.Medicine.Instance[itemKey.TemplateId];
		Injuries injuries = character.GetInjuries();
		if (medicineItem.EffectType == EMedicineEffectType.RecoverInnerInjury || medicineItem.EffectType == EMedicineEffectType.RecoverOuterInjury)
		{
			bool isInnerInjury = medicineItem.EffectType == EMedicineEffectType.RecoverInnerInjury;
			sbyte delta = (sbyte)medicineItem.EffectValue;
			for (int i = 0; i < medicineItem.InjuryRecoveryTimes; i++)
			{
				sbyte bodyPartType = (sbyte)context.Random.Next(7);
				injuries.Change(bodyPartType, isInnerInjury, delta);
			}
		}
		character.AddEatingItemWithoutInstantEffects(context, itemKey);
	}

	public void SetSubscriberOrder(DataContext context, int oldId, int newId, int artisanId)
	{
		if (oldId >= 0 && TryGetElement_SubscriberOrders(oldId, out var value))
		{
			value.Remove(artisanId);
			SetElement_SubscriberOrders(oldId, value, context);
		}
		if (TryGetElement_SubscriberOrders(newId, out var value2))
		{
			if (!value2.Contains(artisanId))
			{
				value2.Add(artisanId);
				SetElement_SubscriberOrders(newId, value2, context);
			}
		}
		else
		{
			value2 = default(CharacterList);
			value2.Add(artisanId);
			AddElement_SubscriberOrders(newId, value2, context);
		}
	}

	public void RemoveSubscriberOrder(DataContext context, int subscriberId, int artisanId)
	{
		if (subscriberId >= 0 && TryGetElement_SubscriberOrders(subscriberId, out var value))
		{
			value.Remove(artisanId);
			SetElement_SubscriberOrders(subscriberId, value, context);
		}
	}

	public void AssassinationByJieqing(DataContext context)
	{
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		if (!string.IsNullOrEmpty(_targetedForAssassination))
		{
			foreach (Character value in _objects.Values)
			{
				if (value.GetCreatingType() != 1 || IsTemporaryIntelligentCharacter(value.GetId()) || AgeGroup.GetAgeGroup(value.GetActualAge()) != 2)
				{
					continue;
				}
				(string surname, string givenName) realName = GetRealName(value);
				string item = realName.surname;
				string item2 = realName.givenName;
				string text = item + item2;
				if (_targetedForAssassination != text || !context.Random.CheckPercentProb(45 - value.GetOrganizationInfo().Grade * 5))
				{
					continue;
				}
				if (value.GetId() == taiwuCharId)
				{
					DomainManager.World.SetTaiwuDying();
				}
				else
				{
					DomainManager.Character.MakeCharacterDead(context, value, 7);
				}
				SetTargetedForAssassination(string.Empty, context);
				break;
			}
		}
		if (DomainManager.World.GetMainStoryLineProgress() < 6 || !DomainManager.Item.HasTrackedSpecialItems(12, 225))
		{
			return;
		}
		foreach (Character value2 in _objects.Values)
		{
			if (value2.GetCreatingType() != 1 || value2.GetId() == taiwuCharId || IsTemporaryIntelligentCharacter(value2.GetId()))
			{
				continue;
			}
			ItemKey wuYingFromCharacterInventory = DomainManager.Item.GetWuYingFromCharacterInventory(value2);
			if (wuYingFromCharacterInventory.IsValid() && context.Random.CheckPercentProb(90 - value2.GetOrganizationInfo().Grade * 10))
			{
				ItemBase baseItem = DomainManager.Item.GetBaseItem(wuYingFromCharacterInventory);
				baseItem.SetCurrDurability((short)(baseItem.GetCurrDurability() - 1), context);
				if (baseItem.GetCurrDurability() <= 0)
				{
					value2.RemoveInventoryItem(context, wuYingFromCharacterInventory, 1, deleteItem: true);
				}
				DomainManager.Character.MakeCharacterDead(context, value2, 8);
			}
		}
	}

	public void Test_AssassinationImplementations()
	{
		List<string> list = new List<string> { "ä»»æˆ‘è¡Œ", "å¤ä¸‰é€š", "å¼ æ— å¿Œ", "äº‘è¥„" };
		List<Character> list2 = new List<Character>();
		Stopwatch stopwatch = new Stopwatch();
		list2.Clear();
		stopwatch.Restart();
		foreach (Character value in _objects.Values)
		{
			var (text, text2) = GetRealName(value);
			if (list.Contains(text + text2))
			{
				list2.Add(value);
			}
		}
		Logger.Warn($"Time Cost with implementation 2 in ticks: {stopwatch.ElapsedTicks}");
		list2.Clear();
		stopwatch.Restart();
		foreach (string target in list)
		{
			FindIntelligentCharacters((Character character) => CharacterMatchers.MatchRealName(character, target), list2);
		}
		Logger.Warn($"Time Cost with implementation 1 in ticks: {stopwatch.ElapsedTicks}");
		list2.Clear();
		stopwatch.Restart();
		foreach (string target2 in list)
		{
			MapCharacterFilter.ParallelFind((Character character) => CharacterMatchers.MatchRealName(character, target2), list2, 0, 135);
		}
		Logger.Warn($"Time Cost with implementation 3 in ticks: {stopwatch.ElapsedTicks}");
	}

	[DomainMethod]
	public bool CharacterShaveAvatar(DataContext context, int cutterCharId, int shaveCharId, AvatarData shaveResult)
	{
		if (TryGetElement_Objects(cutterCharId, out var element) && TryGetElement_Objects(shaveCharId, out var element2))
		{
			AvatarData avatar = element2.GetAvatar();
			bool flag = avatar.FrontHairId != shaveResult.FrontHairId || avatar.BackHairId != shaveResult.BackHairId || avatar.ColorFrontHairId != shaveResult.ColorFrontHairId || avatar.ColorBackHairId != shaveResult.ColorBackHairId;
			bool flag2 = avatar.GetGrowableElementShowingState(0) != shaveResult.GetGrowableElementShowingState(0);
			bool flag3 = avatar.Beard1Id != shaveResult.Beard1Id || avatar.ColorBeard1Id != shaveResult.ColorBeard1Id;
			bool flag4 = avatar.GetGrowableElementShowingState(1) != shaveResult.GetGrowableElementShowingState(1);
			bool flag5 = avatar.Beard2Id != shaveResult.Beard2Id || avatar.ColorBeard2Id != shaveResult.ColorBeard2Id;
			bool flag6 = avatar.GetGrowableElementShowingState(2) != shaveResult.GetGrowableElementShowingState(2);
			bool flag7 = avatar.EyebrowId != shaveResult.EyebrowId || avatar.EyebrowDistancePercent != shaveResult.EyebrowDistancePercent || avatar.EyebrowAngle != shaveResult.EyebrowAngle || avatar.EyebrowHeight != shaveResult.EyebrowHeight || avatar.EyebrowScale != shaveResult.EyebrowScale || avatar.ColorEyebrowId != shaveResult.ColorEyebrowId;
			bool flag8 = avatar.GetGrowableElementShowingState(6) != shaveResult.GetGrowableElementShowingState(6);
			int percentProb = 40 + element.GetLifeSkillAttainment(5) / 5;
			bool flag9 = context.Random.CheckPercentProb(percentProb);
			if (!flag9)
			{
				bool flag10 = flag2 || !flag;
				bool flag11 = flag4 || !flag3;
				bool flag12 = flag6 || !flag5;
				bool flag13 = flag8 || !flag7;
				flag9 = flag10 && flag11 && flag12 && flag13;
			}
			bool flag14 = false;
			bool flag15 = false;
			bool flag16 = false;
			if (flag9)
			{
				AvatarGroup avatarGroup = AvatarManager.Instance.GetAvatarGroup(avatar.AvatarId);
				if (flag4)
				{
					shaveResult.SetGrowableElementShowingState(1, show: false);
					DomainManager.Character.InitializeAvatarElementGrowthProgress(context, shaveCharId, 1);
				}
				if (flag6)
				{
					shaveResult.SetGrowableElementShowingState(2, show: false);
					DomainManager.Character.InitializeAvatarElementGrowthProgress(context, shaveCharId, 2);
				}
				if (flag8)
				{
					shaveResult.SetGrowableElementShowingState(6, show: false);
					DomainManager.Character.InitializeAvatarElementGrowthProgress(context, shaveCharId, 6);
				}
				short attraction = element2.GetAttraction();
				avatarGroup = AvatarManager.Instance.GetAvatarGroup(shaveResult.AvatarId);
				CheckShaveResult(avatarGroup, shaveResult, flag, flag3, flag5, flag7);
				element2.SetAvatar(shaveResult, context);
				short attraction2 = element2.GetAttraction();
				if (attraction2 >= attraction)
				{
					element2.AddFeature(context, 496, removeMutexFeature: true);
				}
				else
				{
					element2.AddFeature(context, 497, removeMutexFeature: true);
				}
			}
			else
			{
				element2.AddFeature(context, 498, removeMutexFeature: true);
				if (flag)
				{
					avatar.ResetGrowableElementShowingState(0);
					DomainManager.Character.InitializeAvatarElementGrowthProgress(context, shaveCharId, 0);
					flag14 = true;
				}
				if (flag3 || flag5)
				{
					avatar.ResetGrowableElementShowingState(1);
					avatar.ResetGrowableElementShowingState(2);
					DomainManager.Character.InitializeAvatarElementGrowthProgress(context, shaveCharId, 1);
					DomainManager.Character.InitializeAvatarElementGrowthProgress(context, shaveCharId, 2);
					flag15 = true;
				}
				if (flag7)
				{
					avatar.ResetGrowableElementShowingState(6);
					DomainManager.Character.InitializeAvatarElementGrowthProgress(context, shaveCharId, 6);
					flag16 = true;
				}
				element2.SetAvatar(avatar, context);
			}
			DomainManager.TaiwuEvent.SetListenerEventActionBoolArg("CharacterShaveComplete", "ShaveSuccess", flag9);
			if (!flag9)
			{
				if (flag14)
				{
					DomainManager.TaiwuEvent.SetListenerEventActionBoolArg("CharacterShaveComplete", "ShaveHairFailFlag", value: true);
				}
				if (flag15)
				{
					DomainManager.TaiwuEvent.SetListenerEventActionBoolArg("CharacterShaveComplete", "ShaveBeardFailFlag", value: true);
				}
				if (flag16)
				{
					DomainManager.TaiwuEvent.SetListenerEventActionBoolArg("CharacterShaveComplete", "ShaveEyebrowFailFlag", value: true);
				}
				DomainManager.TaiwuEvent.TriggerListener("CharacterShaveComplete", value: true);
			}
			return flag9;
		}
		return false;
	}

	[DomainMethod]
	public AvatarData GetAvatarData(DataContext context, int charId)
	{
		TryGetElement_Objects(charId, out var element);
		return element.GetAvatar();
	}

	private bool CheckShaveResult(AvatarGroup avatarGroup, AvatarData shaveResult, bool hairInfoChanged, bool beard1InfoChanged, bool beard2InfoChanged, bool eyebrowInfoChanged)
	{
		bool result = true;
		if (hairInfoChanged && shaveResult.FrontHairId == avatarGroup.Hair1Res[0].Id)
		{
			result = false;
			AdaptableLog.Warning($"front hair can not set to id {avatarGroup.Hair1Res[0].Id} through shave");
		}
		if (hairInfoChanged && shaveResult.BackHairId == avatarGroup.Hair2Res[0].Id && shaveResult.FrontHairId == avatarGroup.Hair1Res[0].Id)
		{
			result = false;
			AdaptableLog.Warning($"back hair can not set to id {avatarGroup.Hair2Res[0].Id} through shave");
		}
		if (beard1InfoChanged && avatarGroup.Beard1Res.CheckIndex(0) && shaveResult.Beard1Id == avatarGroup.Beard1Res[0].Id)
		{
			result = false;
			AdaptableLog.Warning($"beard1 can not set to id {avatarGroup.Hair2Res[0].Id} through shave");
		}
		if (beard2InfoChanged && avatarGroup.Beard2Res.CheckIndex(0) && shaveResult.Beard2Id == avatarGroup.Beard2Res[0].Id)
		{
			result = false;
			AdaptableLog.Warning($"beard2 can not set to id {avatarGroup.Hair2Res[0].Id} through shave");
		}
		if (eyebrowInfoChanged && shaveResult.EyebrowId == avatarGroup.EyeBrowRes[0].Id)
		{
			result = false;
			AdaptableLog.Warning($"eyebrow can not set to id {avatarGroup.EyeBrowRes[0].Id} through shave");
		}
		return result;
	}

	public AvatarElementsGrownDates GetAvatarElementGrowthProgress(int charId)
	{
		return _avatarElementGrowthProgress[charId];
	}

	public bool TryGetAvatarElementGrowthProgress(int charId, out AvatarElementsGrownDates growthDates)
	{
		return _avatarElementGrowthProgress.TryGetValue(charId, out growthDates);
	}

	public void SetAvatarElementGrowthProgress(DataContext context, int charId, ref AvatarElementsGrownDates dates)
	{
		SetElement_AvatarElementGrowthProgress(charId, ref dates, context);
	}

	public unsafe void InitializeAvatarElementGrowthProgress(DataContext context, int charId, sbyte elementType)
	{
		AvatarElementsGrownDates value;
		bool flag = _avatarElementGrowthProgress.TryGetValue(charId, out value);
		if (!flag)
		{
			value.Initialize();
		}
		sbyte b = GlobalConfig.Instance.AvatarElementGrowthDurations[elementType];
		value.Items[elementType] = DomainManager.World.GetCurrDate() + b;
		if (flag)
		{
			SetElement_AvatarElementGrowthProgress(charId, ref value, context);
		}
		else
		{
			AddElement_AvatarElementGrowthProgress(charId, ref value, context);
		}
	}

	public int GetTopThousandCharacterRanking(int charId)
	{
		int num = _topThousandCharDescendingRanking.IndexOfValue(charId);
		if (num == -1)
		{
			return int.MaxValue;
		}
		return num + 1;
	}

	public void UpdateTopThousandCharRanking()
	{
		_topThousandCharDescendingRanking.Clear();
		List<Settlement> list = new List<Settlement>();
		DomainManager.Organization.GetAllSettlements(list);
		foreach (Settlement item in list)
		{
			for (int i = 1; i <= 1000; i++)
			{
				long rankingInfo = item.GetRankingInfo(i);
				if (rankingInfo == 0)
				{
					break;
				}
				int value = (int)(rankingInfo & 0xFFFFFFFFu);
				_topThousandCharDescendingRanking.Add(rankingInfo, value);
				if (_topThousandCharDescendingRanking.Count > 1000)
				{
					long num = _topThousandCharDescendingRanking.Keys[1000];
					_topThousandCharDescendingRanking.RemoveAt(1000);
					if (num == rankingInfo)
					{
						break;
					}
				}
			}
		}
	}

	public static bool TryRemoveCombatSkillFromAttainmentPanel(DataContext context, Character character, short targetSkillTemplateId)
	{
		short[] combatSkillAttainmentPanels = character.GetCombatSkillAttainmentPanels();
		CombatSkillItem combatSkillItem = Config.CombatSkill.Instance[targetSkillTemplateId];
		sbyte type = combatSkillItem.Type;
		sbyte grade = combatSkillItem.Grade;
		if (CombatSkillAttainmentPanelsHelper.Get(combatSkillAttainmentPanels, type, grade) != targetSkillTemplateId)
		{
			return false;
		}
		short eligibleCombatSkillOfAttainmentPanel = GetEligibleCombatSkillOfAttainmentPanel(character.GetId(), type, grade);
		CombatSkillAttainmentPanelsHelper.Set(combatSkillAttainmentPanels, type, grade, eligibleCombatSkillOfAttainmentPanel);
		character.SetCombatSkillAttainmentPanels(combatSkillAttainmentPanels, context);
		return true;
	}

	private static short GetEligibleCombatSkillOfAttainmentPanel(int charId, sbyte combatSkillType, sbyte grade)
	{
		Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(charId);
		foreach (KeyValuePair<short, GameData.Domains.CombatSkill.CombatSkill> item in charCombatSkills)
		{
			item.Deconstruct(out var key, out var value);
			short num = key;
			GameData.Domains.CombatSkill.CombatSkill combatSkill = value;
			CombatSkillItem combatSkillItem = Config.CombatSkill.Instance[num];
			if (combatSkillItem.Type == combatSkillType && combatSkillItem.Grade == grade)
			{
				ushort activationState = combatSkill.GetActivationState();
				if (CombatSkillStateHelper.IsBrokenOut(activationState) && !combatSkill.GetRevoked())
				{
					return num;
				}
			}
		}
		return -1;
	}

	[DomainMethod]
	public void AllocateNeili(DataContext context, int charId, byte neiliAllocationType)
	{
		Character element_Objects = GetElement_Objects(charId);
		element_Objects.AllocateNeili(context, neiliAllocationType);
		if (charId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			DomainManager.Extra.SetTaiwuMaxNeiliAllocation(element_Objects.GetBaseNeiliAllocation(), context);
		}
	}

	[DomainMethod]
	public void DeallocateNeili(DataContext context, int charId, byte neiliAllocationType)
	{
		Character character = _objects[charId];
		character.DeallocateNeili(context, neiliAllocationType);
		if (charId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			DomainManager.Extra.SetTaiwuMaxNeiliAllocation(character.GetBaseNeiliAllocation(), context);
		}
	}

	[DomainMethod]
	public short GetChangeOfQiDisorder(int charId)
	{
		if (TryGetElement_Objects(charId, out var element))
		{
			return element.GetChangeOfQiDisorder();
		}
		return 0;
	}

	[DomainMethod]
	public int GetAddConsummateLevelRequiredMonth(int charId)
	{
		if (!TryGetElement_Objects(charId, out var element))
		{
			return int.MaxValue;
		}
		sbyte consummateLevel = element.GetConsummateLevel();
		if (consummateLevel >= element.GetMaxConsummateLevel())
		{
			return int.MaxValue;
		}
		int num = DomainManager.Extra.GetCharacterConsummateLevelProgress(charId);
		int num2 = GlobalConfig.Instance.ConsummateLevelProgressSpeed[element.GetOrganizationInfo().Grade];
		int num3 = GlobalConfig.Instance.ConsummateLevelProgressThreshold[consummateLevel];
		int num4 = 0;
		do
		{
			num += num2;
			num4++;
		}
		while (num < num3);
		return num4;
	}

	public unsafe void SimulateCharacterCombatResult(DataContext context, Character winner, Character loser, int killBaseChance, int kidnapBaseChance, int releaseBaseChance)
	{
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		Location location = winner.GetLocation();
		if (!location.IsValid())
		{
			location = winner.GetValidLocation();
		}
		int defeatMarksCountOutOfCombat = CombatDomain.GetDefeatMarksCountOutOfCombat(loser);
		int percentProb = (30 - defeatMarksCountOutOfCombat) * 100 / 30;
		bool flag = loser.IsCompletelyInfected();
		bool flag2 = loser.GetId() == _avoidDeathCharId;
		if (flag2)
		{
			flag2 = TransferAvoidDeathCharInjuries(context);
		}
		int leaderId = winner.GetLeaderId();
		int leaderId2 = loser.GetLeaderId();
		if (leaderId >= 0 && leaderId == leaderId2)
		{
			if (leaderId2 == loser.GetId())
			{
				DomainManager.Character.LeaveGroup(context, winner);
			}
			else
			{
				DomainManager.Character.LeaveGroup(context, loser);
			}
		}
		if (flag || context.Random.CheckPercentProb(percentProb))
		{
			lifeRecordCollection.AddEnemyEscape(winner.GetId(), currDate, loser.GetId(), location);
			if (loser.GetLocation().IsValid())
			{
				EscapeToRandomNearbyBlock(context, loser);
			}
			return;
		}
		if (loser.GetAgeGroup() == 2)
		{
			Personalities personalities = winner.GetPersonalities();
			sbyte behaviorType = winner.GetBehaviorType();
			AiHelper.CombatResultHandleType[] array = AiHelper.NpcCombat.ResultHandleTypePriorities[behaviorType];
			for (int i = 0; i < 3; i++)
			{
				switch (array[i])
				{
				case AiHelper.CombatResultHandleType.Kill:
				{
					if (!context.Random.CheckPercentProb(killBaseChance + personalities.Items[3]) || flag2)
					{
						break;
					}
					short aiActionRateAdjust = DomainManager.Extra.GetAiActionRateAdjust(winner.GetId(), 7, -1);
					int percentProb2 = AiHelper.NpcCombat.HandleEnemyInPublicChance[behaviorType] - aiActionRateAdjust;
					CombatResultHandle_KillEnemy(context, winner, loser, context.Random.CheckPercentProb(percentProb2));
					return;
				}
				case AiHelper.CombatResultHandleType.Kidnap:
					if (context.Random.CheckPercentProb(kidnapBaseChance + personalities.Items[1]))
					{
						short aiActionRateAdjust2 = DomainManager.Extra.GetAiActionRateAdjust(winner.GetId(), 8, -1);
						int percentProb3 = AiHelper.NpcCombat.HandleEnemyInPublicChance[behaviorType] - aiActionRateAdjust2;
						CombatResultHandle_KidnapEnemy(context, winner, loser, context.Random.CheckPercentProb(percentProb3));
						return;
					}
					break;
				case AiHelper.CombatResultHandleType.Release:
					if (context.Random.CheckPercentProb(releaseBaseChance + personalities.Items[0]))
					{
						CombatResultHandle_ReleaseEnemy(context, winner, loser);
						return;
					}
					break;
				}
			}
		}
		CombatResultHandle_ReleaseEnemy(context, winner, loser);
	}

	public void CombatResultHandle_KillEnemy(DataContext context, Character winner, Character loser, bool isInPublic)
	{
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		int id = winner.GetId();
		int id2 = loser.GetId();
		CharacterDeathInfo characterDeathInfo = new CharacterDeathInfo(loser.GetValidLocation());
		characterDeathInfo.KillerId = id;
		CharacterDeathInfo deathInfo = characterDeathInfo;
		if (isInPublic)
		{
			MakeCharacterDead(context, loser, 4, deathInfo);
			lifeRecordCollection.AddKillInPublic(id, currDate, id2, deathInfo.Location);
			SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
			int dataOffset = secretInformationCollection.AddKillInPublic(id, id2);
			int num = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
		}
		else
		{
			MakeCharacterDead(context, loser, 3, deathInfo);
			lifeRecordCollection.AddKillInPrivate(id, currDate, id2, deathInfo.Location);
			SecretInformationCollection secretInformationCollection2 = DomainManager.Information.GetSecretInformationCollection();
			int dataOffset2 = secretInformationCollection2.AddKillInPrivate(id, id2);
			int num2 = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset2);
		}
	}

	public void CombatResultHandle_KidnapEnemy(DataContext context, Character winner, Character loser, bool isInPublic)
	{
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		Location location = winner.GetLocation();
		int id = winner.GetId();
		int id2 = loser.GetId();
		if (IsTaiwuPeople(id))
		{
			MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
			monthlyNotificationCollection.AddDisappear(id2, location);
		}
		ItemKey inventoryRope = winner.GetInventoryRope(context, winner.GetOrganizationInfo().Grade);
		AddKidnappedCharacter(context, winner, loser, inventoryRope);
		if (isInPublic)
		{
			SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
			int dataOffset = ((DomainManager.Organization.GetFugitiveBountySect(id2) >= 0) ? secretInformationCollection.AddKidnapForPunishment(id, id2) : secretInformationCollection.AddKidnapInPublic(id, id2));
			int num = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
			lifeRecordCollection.AddKidnapInPublic(id, currDate, id2, location, inventoryRope.ItemType, inventoryRope.TemplateId);
		}
		else
		{
			SecretInformationCollection secretInformationCollection2 = DomainManager.Information.GetSecretInformationCollection();
			int dataOffset2 = secretInformationCollection2.AddKidnapInPrivate(id, id2);
			int num2 = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset2);
			lifeRecordCollection.AddKidnapInPrivate(id, currDate, id2, location, inventoryRope.ItemType, inventoryRope.TemplateId);
		}
	}

	public void CombatResultHandle_ReleaseEnemy(DataContext context, Character winner, Character loser)
	{
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		Location location = winner.GetLocation();
		if (!location.IsValid())
		{
			location = winner.GetValidLocation();
		}
		EscapeToRandomNearbyBlock(context, loser);
		lifeRecordCollection.AddReleaseLoser(winner.GetId(), currDate, loser.GetId(), location);
	}

	public int CalcExpGain(sbyte targetGrade, int expGainRatio)
	{
		return AiHelper.CombatRelatedConstants.ExpGainLevels[targetGrade] * expGainRatio / 100;
	}

	public void GetTaiwuCombatEnemyTeam(DataContext context, Character targetChar, CombatType combatType, List<int> enemyList)
	{
		List<Character> list = ObjectPool<List<Character>>.Instance.Get();
		list.Clear();
		if (combatType == CombatType.Beat || combatType == CombatType.Die)
		{
			int leaderId = targetChar.GetLeaderId();
			if (leaderId >= 0)
			{
				AddGroupCharactersToCombatTeam(targetChar.GetId(), leaderId, list, combatType);
			}
			AddGuardsToCombatTeam(context, targetChar, list, createRealGuard: true);
			GetStrongestThreeAndSelf(targetChar, list);
			list.Sort((Character a, Character b) => -a.GetCombatPower().CompareTo(b.GetCombatPower()));
		}
		else
		{
			list.Add(targetChar);
		}
		foreach (Character item in list)
		{
			enemyList.Add(item.GetId());
		}
		ObjectPool<List<Character>>.Instance.Return(list);
	}

	public void SimulateRandomEnemyAttackNpc(DataContext context, Character attackerChar, Character defenderChar, int attackCount, int maxDefendCount, CombatType combatType)
	{
		_attackerTeamsCache.Clear();
		_defenderTeamsCache.Clear();
		_attackerTeamsCache.Add(attackerChar);
		_defenderTeamsCache.Add(defenderChar);
		SimulateAttacks(context, _attackerTeamsCache, _defenderTeamsCache, attackCount, maxDefendCount, combatType);
	}

	[Obsolete]
	public AiHelper.NpcCombatResultType SimulateRandomEnemyAttack(DataContext context, MapTemplateEnemyInfo mapTemplateEnemyInfo, Character attackedChar)
	{
		return SimulateEnemyAttack(context, mapTemplateEnemyInfo.TemplateId, attackedChar);
	}

	internal AiHelper.NpcCombatResultType SimulateEnemyAttackWithEnemyChar(DataContext context, short enemyTemplateId, Character attackedChar, out Character enemyChar)
	{
		CharacterItem characterItem = Config.Character.Instance[enemyTemplateId];
		byte creatingType = characterItem.CreatingType;
		if (1 == 0)
		{
		}
		Character character = creatingType switch
		{
			2 => (characterItem.RandomEnemyId < 0) ? null : GetPregeneratedRandomEnemy(characterItem.RandomEnemyId), 
			3 => DomainManager.Extra.GetPregeneratedFixedEnemy(characterItem.TemplateId), 
			_ => null, 
		};
		if (1 == 0)
		{
		}
		enemyChar = character;
		if (enemyChar == null)
		{
			Logger.AppendWarning($"{attackedChar.GetId()} is attacked by enemy {characterItem.Surname}{characterItem.GivenName}({characterItem.TemplateId}) without valid config.");
			return AiHelper.NpcCombatResultType.MajorDefeat;
		}
		return SimulateCharacterCombat(context, enemyChar, attackedChar, CombatType.Beat);
	}

	public AiHelper.NpcCombatResultType SimulateEnemyAttack(DataContext context, short enemyTemplateId, Character attackedChar)
	{
		Character enemyChar;
		return SimulateEnemyAttackWithEnemyChar(context, enemyTemplateId, attackedChar, out enemyChar);
	}

	public int GetSimulateCharacterCombatWinRate(DataContext context, Character charA, Character charB, int minPowerA = 1, int minPowerB = 1, bool needCalcPower = true)
	{
		int powerA = (needCalcPower ? Math.Max(minPowerA, charA.GetCombatPower()) : minPowerA);
		int powerB = (needCalcPower ? Math.Max(minPowerB, charB.GetCombatPower()) : minPowerB);
		bool charAInvincible = charA.IsInvincibleInNpcCombat();
		bool charBInvincible = charB.IsInvincibleInNpcCombat();
		return GetSimulateCharacterCombatWinRate(powerA, powerB, charAInvincible, charBInvincible, context.Random.NextBool());
	}

	public int GetSimulateCharacterCombatWinRate(int powerA, int powerB, bool charAInvincible, bool charBInvincible, bool forceResult)
	{
		return (!(charAInvincible != charBInvincible && forceResult)) ? (powerA * 50 / Math.Max(1, powerB)) : (charAInvincible ? 100 : 0);
	}

	public AiHelper.NpcCombatResultType SimulateCharacterCombat(DataContext context, Character charA, Character charB, CombatType combatType, bool isGroupCombat = true, int expMultiplier = 1)
	{
		int id = charA.GetId();
		int id2 = charB.GetId();
		List<Character> list = ObjectPool<List<Character>>.Instance.Get();
		List<Character> list2 = ObjectPool<List<Character>>.Instance.Get();
		list.Clear();
		list2.Clear();
		if (isGroupCombat)
		{
			int leaderId = charA.GetLeaderId();
			int leaderId2 = charB.GetLeaderId();
			if (leaderId != leaderId2)
			{
				if (leaderId >= 0)
				{
					AddGroupCharactersToCombatTeam(id, leaderId, list, combatType);
				}
				if (leaderId2 >= 0)
				{
					AddGroupCharactersToCombatTeam(id2, leaderId2, list2, combatType);
				}
			}
			AddGuardsToCombatTeam(context, charA, list);
			AddGuardsToCombatTeam(context, charB, list2);
		}
		GetStrongestThreeAndSelf(charA, list);
		GetStrongestThreeAndSelf(charB, list2);
		int powerA = Math.Max(1, list.Sum((Character character) => character.GetCombatPower()));
		int val = Math.Max(1, list2.Sum((Character character) => character.GetCombatPower()));
		bool flag = charA.IsInvincibleInNpcCombat();
		bool flag2 = charB.IsInvincibleInNpcCombat();
		SimulateCombatContext combatContext = new SimulateCombatContext
		{
			CharA = charA,
			TeamA = list,
			CharB = charB,
			TeamB = list2,
			CombatType = combatType,
			ExpMultiplier = expMultiplier,
			ForceResult = (flag != flag2 && context.Random.NextBool())
		};
		int simulateCharacterCombatWinRate = GetSimulateCharacterCombatWinRate(powerA, Math.Max(1, val), flag, flag2, combatContext.ForceResult);
		if (simulateCharacterCombatWinRate >= 100)
		{
			combatContext.CombatResultType = AiHelper.NpcCombatResultType.MajorVictory;
			ApplyMajorVictoryResult(context, ref combatContext);
		}
		else if (context.Random.CheckPercentProb(simulateCharacterCombatWinRate))
		{
			combatContext.CombatResultType = AiHelper.NpcCombatResultType.MinorVictory;
			ApplyMinorVictoryResult(context, ref combatContext);
		}
		else if (simulateCharacterCombatWinRate > 50)
		{
			combatContext.CombatResultType = AiHelper.NpcCombatResultType.MinorDefeat;
			ApplyMinorVictoryResult(context, ref combatContext);
		}
		else
		{
			combatContext.CombatResultType = AiHelper.NpcCombatResultType.MajorDefeat;
			ApplyMajorVictoryResult(context, ref combatContext);
		}
		ObjectPool<List<Character>>.Instance.Return(list);
		ObjectPool<List<Character>>.Instance.Return(list2);
		return combatContext.CombatResultType;
	}

	private void ApplyMajorVictoryResult(DataContext context, ref SimulateCombatContext combatContext)
	{
		HashSet<int> item = ObjectPool<HashSet<int>>.Instance.Get();
		Character winnerChar = combatContext.WinnerChar;
		List<Character> winnerTeam = combatContext.WinnerTeam;
		Character loserChar = combatContext.LoserChar;
		List<Character> loserTeam = combatContext.LoserTeam;
		SimulateAttacks(context, winnerTeam, loserTeam, 4, 0, combatContext.CombatType);
		int delta = CalcExpGain(loserChar.GetOrganizationInfo().Grade, 100) * combatContext.ExpMultiplier;
		winnerChar.ChangeExp(context, delta);
		loserChar.ChangeExp(context, delta);
		AddCombatResultRecords(context, ref combatContext);
		ObjectPool<HashSet<int>>.Instance.Return(item);
	}

	private void ApplyMinorVictoryResult(DataContext context, ref SimulateCombatContext combatContext)
	{
		HashSet<int> item = ObjectPool<HashSet<int>>.Instance.Get();
		Character winnerChar = combatContext.WinnerChar;
		List<Character> winnerTeam = combatContext.WinnerTeam;
		Character loserChar = combatContext.LoserChar;
		List<Character> loserTeam = combatContext.LoserTeam;
		SimulateAttacks(context, winnerTeam, loserTeam, 2, 0, combatContext.CombatType);
		SimulateAttacks(context, loserTeam, winnerTeam, 1, 0, combatContext.CombatType);
		int delta = CalcExpGain(loserChar.GetOrganizationInfo().Grade, 100) * combatContext.ExpMultiplier;
		winnerChar.ChangeExp(context, delta);
		loserChar.ChangeExp(context, delta);
		AddCombatResultRecords(context, ref combatContext);
		ObjectPool<HashSet<int>>.Instance.Return(item);
	}

	private void AddCombatResultRecords(DataContext context, ref SimulateCombatContext combatContext)
	{
		Character winnerChar = combatContext.WinnerChar;
		Character loserChar = combatContext.LoserChar;
		int currDate = DomainManager.World.GetCurrDate();
		int id = winnerChar.GetId();
		int id2 = loserChar.GetId();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		if (winnerChar.GetCreatingType() != 1)
		{
			Location location = loserChar.GetLocation();
			sbyte orgTemplateId = winnerChar.GetOrganizationInfo().OrgTemplateId;
			short templateId = winnerChar.GetTemplateId();
			switch (orgTemplateId)
			{
			case 18:
				lifeRecordCollection.AddDefeatedByRighteousRandomEnemy(id2, currDate, location, templateId);
				if (IsTaiwuPeople(id2))
				{
					monthlyNotificationCollection.AddDefeatedByRighteousRandomEnemy(id2, location, templateId);
				}
				break;
			default:
				if (orgTemplateId != 19)
				{
					if (templateId >= 210 && templateId <= 227)
					{
						lifeRecordCollection.AddDefeatedByAnimal(id2, currDate, location, templateId);
						if (IsTaiwuPeople(id2))
						{
							monthlyNotificationCollection.AddDefeatedByAnimal(id2, location, templateId);
						}
					}
					break;
				}
				goto case 17;
			case 17:
				lifeRecordCollection.AddDefeatedByHereticRandomEnemy(id2, currDate, location, templateId);
				if (IsTaiwuPeople(id2))
				{
					monthlyNotificationCollection.AddDefeatedByHereticRandomEnemy(id2, location, templateId);
				}
				break;
			}
			return;
		}
		if (loserChar.GetCreatingType() != 1)
		{
			Location location2 = winnerChar.GetLocation();
			sbyte orgTemplateId2 = loserChar.GetOrganizationInfo().OrgTemplateId;
			short templateId2 = loserChar.GetTemplateId();
			switch (orgTemplateId2)
			{
			case 18:
				if (combatContext.ForceResult)
				{
					List<short> featureIds3 = winnerChar.GetFeatureIds();
					if (featureIds3.Contains(484))
					{
						lifeRecordCollection.AddCleanBodyDefeatRighteousRandomEnemy(id, currDate, location2, templateId2);
					}
					else if (featureIds3.Contains(485))
					{
						lifeRecordCollection.AddEvilBodyDefeatRighteousRandomEnemy(id, currDate, location2, templateId2);
					}
					else
					{
						lifeRecordCollection.AddKillRighteousRandomEnemy(id, currDate, location2, templateId2);
					}
				}
				else
				{
					lifeRecordCollection.AddKillRighteousRandomEnemy(id, currDate, location2, templateId2);
				}
				if (IsTaiwuPeople(id))
				{
					monthlyNotificationCollection.AddKillRighteousRandomEnemy(id, location2, templateId2);
				}
				break;
			default:
				if (orgTemplateId2 != 19)
				{
					if (templateId2 < 210 || templateId2 > 227)
					{
						break;
					}
					if (combatContext.ForceResult)
					{
						List<short> featureIds = winnerChar.GetFeatureIds();
						if (featureIds.Contains(484))
						{
							lifeRecordCollection.AddEvilBodyDefeatAnimal(id, currDate, location2, templateId2);
						}
						else if (featureIds.Contains(485))
						{
							lifeRecordCollection.AddEvilBodyDefeatAnimal(id, currDate, location2, templateId2);
						}
						else
						{
							lifeRecordCollection.AddKillAnimal(id, currDate, location2, templateId2);
						}
					}
					else
					{
						lifeRecordCollection.AddKillAnimal(id, currDate, location2, templateId2);
					}
					if (IsTaiwuPeople(id))
					{
						monthlyNotificationCollection.AddKillAnimal(id, location2, templateId2);
					}
					break;
				}
				goto case 17;
			case 17:
				if (combatContext.ForceResult)
				{
					List<short> featureIds2 = winnerChar.GetFeatureIds();
					if (featureIds2.Contains(484))
					{
						lifeRecordCollection.AddCleanBodyDefeatHereticRandomEnemy(id, currDate, location2, templateId2);
					}
					else if (featureIds2.Contains(485))
					{
						lifeRecordCollection.AddEvilBodyDefeatHereticRandomEnemy(id, currDate, location2, templateId2);
					}
					else
					{
						lifeRecordCollection.AddKillHereticRandomEnemy(id, currDate, location2, templateId2);
					}
				}
				else
				{
					lifeRecordCollection.AddKillHereticRandomEnemy(id, currDate, location2, templateId2);
				}
				if (IsTaiwuPeople(id))
				{
					monthlyNotificationCollection.AddKillHereticRandomEnemy(id, location2, templateId2);
				}
				break;
			}
			return;
		}
		Location location3 = winnerChar.GetLocation();
		if (combatContext.IsMajor())
		{
			if (combatContext.ForceResult)
			{
				List<short> featureIds4 = winnerChar.GetFeatureIds();
				if (featureIds4.Contains(484))
				{
					lifeRecordCollection.AddCleanBodyReincarnationSuccess(id, currDate, id2, location3, (sbyte)combatContext.CombatType);
				}
				else if (featureIds4.Contains(485))
				{
					lifeRecordCollection.AddEvilBodyReincarnationSuccess(id, currDate, id2, location3, (sbyte)combatContext.CombatType);
				}
				else
				{
					lifeRecordCollection.AddMajorVictoryInCombat(id, currDate, id2, location3, (sbyte)combatContext.CombatType);
				}
			}
			else
			{
				lifeRecordCollection.AddMajorVictoryInCombat(id, currDate, id2, location3, (sbyte)combatContext.CombatType);
			}
			SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
			int dataOffset = secretInformationCollection.AddMajorVictoryInCombat(id, id2);
			int num = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
		}
		else
		{
			lifeRecordCollection.AddVictoryInCombat(id, currDate, id2, location3, (sbyte)combatContext.CombatType);
			SecretInformationCollection secretInformationCollection2 = DomainManager.Information.GetSecretInformationCollection();
			int dataOffset2 = secretInformationCollection2.AddMinorVictoryInCombat(id, id2);
			int num2 = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset2);
		}
	}

	private void SimulateAttacks(DataContext context, List<Character> attackerTeam, List<Character> defenderTeam, int attackCount, int maxDefendCount, CombatType combatType)
	{
		List<GameData.Domains.CombatSkill.CombatSkill> list = ObjectPool<List<GameData.Domains.CombatSkill.CombatSkill>>.Instance.Get();
		SelectBestScoreCombatSkillsInTeam(attackerTeam, list, attackCount);
		Character character = attackerTeam.Max((Character a, Character b) => a.GetCombatPower().CompareTo(b.GetCombatPower()));
		ItemKey defaultWeaponItemKey = DomainManager.Item.GetDefaultWeaponItemKey(context, 0);
		for (int num = 0; num < attackCount; num++)
		{
			Character random = defenderTeam.GetRandom(context.Random);
			if (random.GetCreatingType() != 1)
			{
				continue;
			}
			if (num < list.Count)
			{
				GameData.Domains.CombatSkill.CombatSkill combatSkill = list[num];
				int charId = combatSkill.GetId().CharId;
				Character element_Objects = GetElement_Objects(charId);
				short skillTemplateId = combatSkill.GetId().SkillTemplateId;
				ItemKey weaponKey = SelectWeapon(context.Random, element_Objects, skillTemplateId);
				if (!weaponKey.IsValid())
				{
					weaponKey = defaultWeaponItemKey;
				}
				DomainManager.Combat.NpcSimplifiedAttack(context, element_Objects, random, combatSkill, weaponKey, combatType);
			}
			else
			{
				Character character2 = character;
				ItemKey weaponKey2 = SelectWeapon(context.Random, character2, -1);
				if (!weaponKey2.IsValid())
				{
					weaponKey2 = defaultWeaponItemKey;
				}
				DomainManager.Combat.NpcSimplifiedAttack(context, character2, random, null, weaponKey2, combatType);
			}
		}
		list.Clear();
		ObjectPool<List<GameData.Domains.CombatSkill.CombatSkill>>.Instance.Return(list);
	}

	private void AddGroupCharactersToCombatTeam(int charId, int leaderId, List<Character> team, CombatType combatType)
	{
		if (leaderId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			return;
		}
		foreach (int item in GetGroup(leaderId).GetCollection())
		{
			if (item != charId)
			{
				if (!TryGetElement_Objects(item, out var element))
				{
					throw new Exception($"Trying to find {item} in {leaderId}'s group, but target is no longer alive.");
				}
				if (element.GetAgeGroup() != 0 && !element.NeedToAvoidCombat(combatType))
				{
					team.Add(element);
				}
			}
		}
		AddSpecialGroupCharactersToCombatTeam(charId, team, combatType);
	}

	private void AddSpecialGroupCharactersToCombatTeam(int charId, List<Character> team, CombatType combatType)
	{
		IReadOnlySet<int> specialGroup = DomainManager.Extra.GetSpecialGroup(charId);
		foreach (int item in specialGroup)
		{
			if (!TryGetElement_Objects(item, out var element))
			{
				throw new Exception($"Trying to find {item} in {charId}'s group, but target is no longer alive.");
			}
			if (!element.NeedToAvoidCombat(combatType))
			{
				team.Add(element);
			}
		}
	}

	private void AddCharactersToCombatTeam(int charId, int leaderId, IEnumerable<int> group, List<Character> team, CombatType combatType)
	{
		foreach (int item in group)
		{
			if (item != charId)
			{
				if (!TryGetElement_Objects(item, out var element))
				{
					throw new Exception($"Trying to find {item} in {leaderId}'s group, but target is no longer alive.");
				}
				if (element.GetAgeGroup() != 0 && !element.NeedToAvoidCombat(combatType))
				{
					team.Add(element);
				}
			}
		}
	}

	private void AddGuardsToCombatTeam(DataContext context, Character character, List<Character> team, bool createRealGuard = false)
	{
		if (!HasGuard(character.GetId(), character))
		{
			return;
		}
		Span<short> span = stackalloc short[3];
		SpanList<short> templateIds = span;
		GetGuards(context, character, ref templateIds);
		if (createRealGuard)
		{
			SpanList<short>.Enumerator enumerator = templateIds.GetEnumerator();
			while (enumerator.MoveNext())
			{
				short current = enumerator.Current;
				Character character2 = CreateRandomEnemy(context, current);
				CompleteCreatingCharacter(character2.GetId());
				DomainManager.Adventure.AddTemporaryEnemyId(character2.GetId());
				team.Add(character2);
			}
		}
		else
		{
			SpanList<short>.Enumerator enumerator2 = templateIds.GetEnumerator();
			while (enumerator2.MoveNext())
			{
				short current2 = enumerator2.Current;
				short randomEnemyId = Config.Character.Instance[current2].RandomEnemyId;
				team.Add(GetPregeneratedRandomEnemy(randomEnemyId));
			}
		}
	}

	private void GetStrongestThreeAndSelf(Character character, List<Character> team)
	{
		team.Sort((Character a, Character b) => -a.GetCombatPower().CompareTo(b.GetCombatPower()));
		if (team.Count > 3)
		{
			team.RemoveRange(3, team.Count - 3);
		}
		team.Add(character);
	}

	private void SelectBestScoreCombatSkillsInTeam(List<Character> team, List<GameData.Domains.CombatSkill.CombatSkill> combatSkills, int amountToSelect)
	{
		combatSkills.Clear();
		foreach (Character item in team)
		{
			ArraySegmentList<short> attack = item.GetCombatSkillEquipment().Attack;
			Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(item.GetId());
			ArraySegmentList<short>.Enumerator enumerator2 = attack.GetEnumerator();
			while (enumerator2.MoveNext())
			{
				short current2 = enumerator2.Current;
				if (current2 >= 0)
				{
					combatSkills.Add(charCombatSkills[current2]);
				}
			}
		}
		combatSkills.Sort((GameData.Domains.CombatSkill.CombatSkill a, GameData.Domains.CombatSkill.CombatSkill b) => -a.GetBaseScore().CompareTo(b.GetBaseScore()));
		if (combatSkills.Count > amountToSelect)
		{
			combatSkills.RemoveRange(amountToSelect, combatSkills.Count - amountToSelect);
		}
	}

	private short SelectBestDefendSkill(GameData.Domains.CombatSkill.CombatSkill attackSkill, Character defender)
	{
		return -1;
	}

	private unsafe ItemKey SelectWeapon(IRandomSource random, Character character, short skillTemplateId)
	{
		ItemKey[] equipment = character.GetEquipment();
		sbyte[] array = EquipmentSlot.EquipmentType2Slots[0];
		sbyte* ptr = stackalloc sbyte[(int)(uint)array.Length];
		int num = 0;
		sbyte[] array2 = array;
		foreach (sbyte b in array2)
		{
			ItemKey itemKey = equipment[b];
			if (!itemKey.IsValid())
			{
				continue;
			}
			GameData.Domains.Item.Weapon element_Weapons = DomainManager.Item.GetElement_Weapons(itemKey.Id);
			if (skillTemplateId >= 0)
			{
				List<sbyte> tricks = element_Weapons.GetTricks();
				if (WeaponHasNeedTrick(skillTemplateId, tricks))
				{
					ptr[num] = b;
					num++;
				}
			}
			else
			{
				ptr[num] = b;
				num++;
			}
		}
		if (num == 0)
		{
			return ItemKey.Invalid;
		}
		return equipment[ptr[random.Next(num)]];
	}

	private bool WeaponHasNeedTrick(short skillTemplateId, List<sbyte> weaponTricks)
	{
		List<NeedTrick> trickCost = Config.CombatSkill.Instance[skillTemplateId].TrickCost;
		for (int i = 0; i < trickCost.Count; i++)
		{
			if (!weaponTricks.Contains(trickCost[i].TrickType))
			{
				return false;
			}
		}
		return true;
	}

	[DomainMethod]
	public bool IsCarrierDurabilityRunningOut(int charId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return false;
		}
		ItemKey itemKey = element.GetEquipment()[11];
		if (!itemKey.IsValid())
		{
			return false;
		}
		ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey);
		return baseItem.IsDurabilityRunningOut();
	}

	[DomainMethod]
	public CombatResources GetUsableCombatResources(int charId)
	{
		CombatResources max = CombatResourcesHelper.GetMax(GetElement_Objects(charId));
		_usedCombatResources.TryGetValue(charId, out var value);
		return max.Sub(value);
	}

	public CombatResources GetUsedCombatResources(int charId)
	{
		_usedCombatResources.TryGetValue(charId, out var value);
		return value;
	}

	public void UseCombatResources(DataContext context, int charId, EHealActionType type, sbyte delta = 1)
	{
		CombatResources orDefault = _usedCombatResources.GetOrDefault(charId);
		orDefault.Change(type, delta);
		_usedCombatResources[charId] = orDefault;
	}

	public void RecoverCombatResources(DataContext context)
	{
		_usedCombatResources.Clear();
	}

	public void RecoverHealCombatResources(DataContext context, int charId)
	{
		CombatResources orDefault = _usedCombatResources.GetOrDefault(charId);
		orDefault.Set(EHealActionType.Healing, 0);
		_usedCombatResources[charId] = orDefault;
	}

	public void RecoverDetoxCombatResources(DataContext context, int charId)
	{
		CombatResources orDefault = _usedCombatResources.GetOrDefault(charId);
		orDefault.Set(EHealActionType.Detox, 0);
		_usedCombatResources[charId] = orDefault;
	}

	private void UpgradeCombatSkillEquipmentData(DataContext context)
	{
		Logger.Warn("Upgrading combat skill equipment data.");
		Span<short> span = stackalloc short[48];
		SpanList<short> spanList = span;
		foreach (var (charId, character2) in _objects)
		{
			spanList.Clear();
			if (DomainManager.Extra.TryGetCharacterEquippedCombatSkills(charId, out var _))
			{
				continue;
			}
			short[] equippedCombatSkills = character2.GetEquippedCombatSkills();
			Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(charId);
			short[] array = equippedCombatSkills;
			foreach (short num2 in array)
			{
				if (num2 >= 0 && !spanList.Contains(num2) && charCombatSkills.ContainsKey(num2))
				{
					spanList.Add(num2);
				}
			}
			if (spanList.Count != 0)
			{
				CombatSkillHelper.InitializeEquippedSkills(equippedCombatSkills);
				CombatSkillEquipment combatSkillEquipment = character2.GetCombatSkillEquipment();
				combatSkillEquipment.OfflineClear();
				SpanList<short>.Enumerator enumerator2 = spanList.GetEnumerator();
				while (enumerator2.MoveNext())
				{
					short current = enumerator2.Current;
					combatSkillEquipment.OfflineAddSkill(current);
				}
				character2.ApplyCombatSkillEquipmentModification(context, combatSkillEquipment);
			}
		}
	}

	[DomainMethod]
	public sbyte[] GetCombatSkillSlotCounts(int charId)
	{
		sbyte[] array = new sbyte[6];
		if (!TryGetElement_Objects(charId, out var element))
		{
			return array;
		}
		sbyte combatSkillSlotCounts = element.GetCombatSkillSlotCounts(array);
		array[5] = combatSkillSlotCounts;
		return array;
	}

	[DomainMethod]
	public sbyte[] GetCombatSkillExtraSlotCounts(int charId)
	{
		sbyte[] array = new sbyte[5];
		if (!TryGetElement_Objects(charId, out var element))
		{
			return array;
		}
		element.GetCombatSkillExtraSlotCounts(array);
		return array;
	}

	[DomainMethod]
	public void AddEquippedCombatSkill(DataContext context, int charId, short skillTemplateId)
	{
		Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		element_Objects.AddEquippedCombatSkill(context, skillTemplateId);
	}

	[DomainMethod]
	public void RemoveEquippedCombatSkill(DataContext context, int charId, short skillTemplateId)
	{
		Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		element_Objects.RemoveEquippedCombatSkill(context, skillTemplateId);
	}

	[DomainMethod]
	public void UnequipAllCombatSkills(DataContext context, int charId)
	{
		if (_objects.TryGetValue(charId, out var value))
		{
			value.ClearCombatSkillEquipment(context);
		}
	}

	[DomainMethod]
	public void AutoEquipCombatSkills(DataContext context, int charId, short combatConfigTemplateId = -1)
	{
		if (_objects.TryGetValue(charId, out var value))
		{
			context.Equipping.EquipCombatSkills(context, value, combatConfigTemplateId);
		}
	}

	[DomainMethod]
	public void AutoEquipItems(DataContext context, int charId)
	{
		Character character = _objects[charId];
		context.Equipping.EquipItems(context, character);
	}

	[DomainMethod]
	public void AutoSetCombatSkillAttainmentPanels(DataContext context, int charId)
	{
		Character character = _objects[charId];
		context.Equipping.SetInitialCombatSkillAttainmentPanels(context, character);
	}

	[DomainMethod]
	public void AutoAllocateNeili(DataContext context, int charId)
	{
		Character character = _objects[charId];
		context.Equipping.AllocateNeili(context, character);
	}

	[DomainMethod]
	public void UpdateCombatSkillPlan(DataContext context, int charId, int planId)
	{
		if (charId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			DomainManager.Taiwu.UpdateCombatSkillPlan(context, planId);
			return;
		}
		Character character = _objects[charId];
		CharacterCombatSkillConfiguration characterCombatSkillConfiguration = DomainManager.Extra.TryGetCharacterCombatSkillConfiguration(charId) ?? new CharacterCombatSkillConfiguration(character);
		if (planId != characterCombatSkillConfiguration.CurrentPlanId)
		{
			characterCombatSkillConfiguration.OfflineRecordCombatSkillPlan(character, characterCombatSkillConfiguration.CurrentPlanId);
		}
		characterCombatSkillConfiguration.CurrentPlanId = planId;
		DomainManager.Extra.SetCharacterMasteredCombatSkills(context, charId, new GameData.Utilities.ShortList(characterCombatSkillConfiguration.CombatSkillMasterPlans[planId]));
		DomainManager.Character.ApplyCombatSkillPlan(context, character, characterCombatSkillConfiguration.CombatSkillEquipPlans[planId]);
		DomainManager.Extra.SetCharacterCombatSkillConfiguration(context, charId, characterCombatSkillConfiguration);
	}

	[DomainMethod]
	public void DuplicateCurrentCombatSkillPlan(DataContext context, int charId)
	{
		if (charId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			DomainManager.Taiwu.CopyCombatSkillPlan(context);
			return;
		}
		Character character = _objects[charId];
		CharacterCombatSkillConfiguration characterCombatSkillConfiguration = DomainManager.Extra.TryGetCharacterCombatSkillConfiguration(charId);
		if (characterCombatSkillConfiguration == null)
		{
			characterCombatSkillConfiguration = new CharacterCombatSkillConfiguration(character);
		}
		int planCount = characterCombatSkillConfiguration.PlanCount;
		if (planCount != 9)
		{
			characterCombatSkillConfiguration.OfflineRecordCombatSkillPlan(character, characterCombatSkillConfiguration.CurrentPlanId);
			characterCombatSkillConfiguration.OfflineRecordCombatSkillPlan(character, planCount);
			characterCombatSkillConfiguration.CurrentPlanId = planCount;
			DomainManager.Extra.SetCharacterCombatSkillConfiguration(context, charId, characterCombatSkillConfiguration);
		}
	}

	[DomainMethod]
	public void AppendCombatSkillPlan(DataContext context, int charId)
	{
		if (charId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			DomainManager.Taiwu.AppendCombatSkillPlan(context);
			return;
		}
		CharacterCombatSkillConfiguration characterCombatSkillConfiguration = DomainManager.Extra.TryGetCharacterCombatSkillConfiguration(charId);
		Character element_Objects = GetElement_Objects(charId);
		if (characterCombatSkillConfiguration == null)
		{
			characterCombatSkillConfiguration = new CharacterCombatSkillConfiguration(element_Objects);
		}
		int planCount = characterCombatSkillConfiguration.PlanCount;
		if (planCount != 9)
		{
			characterCombatSkillConfiguration.OfflineUpdateMaxPlanCount(planCount + 1);
			DomainManager.Extra.SetCharacterCombatSkillConfiguration(context, charId, characterCombatSkillConfiguration);
			UpdateCombatSkillPlan(context, charId, planCount);
		}
	}

	[DomainMethod]
	public void DeleteCombatSkillPlan(DataContext context, int charId, int planId)
	{
		if (charId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			DomainManager.Taiwu.DeleteCombatSkillPlan(context);
			return;
		}
		CharacterCombatSkillConfiguration characterCombatSkillConfiguration = DomainManager.Extra.TryGetCharacterCombatSkillConfiguration(charId);
		Character element_Objects = GetElement_Objects(charId);
		if (characterCombatSkillConfiguration == null)
		{
			characterCombatSkillConfiguration = new CharacterCombatSkillConfiguration(element_Objects);
		}
		int planCount = characterCombatSkillConfiguration.PlanCount;
		if (planCount != 1)
		{
			characterCombatSkillConfiguration.OfflineDeleteCombatSkillPlan(planId);
			DomainManager.Extra.SetCharacterCombatSkillConfiguration(context, charId, characterCombatSkillConfiguration);
			UpdateCombatSkillPlan(context, charId, characterCombatSkillConfiguration.CurrentPlanId);
		}
	}

	[DomainMethod]
	public (int, int) GetCurrentPlanIdAndPlanCount(int charId)
	{
		if (charId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			return (DomainManager.Taiwu.GetCurrCombatSkillPlanId(), DomainManager.Extra.GetUnlockedCombatSkillPlanCount());
		}
		CharacterCombatSkillConfiguration characterCombatSkillConfiguration = DomainManager.Extra.TryGetCharacterCombatSkillConfiguration(charId);
		if (characterCombatSkillConfiguration == null)
		{
			return (0, 1);
		}
		return (characterCombatSkillConfiguration.CurrentPlanId, characterCombatSkillConfiguration.PlanCount);
	}

	[DomainMethod]
	public byte[] GetGenericGridAllocation(int charId)
	{
		if (charId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			return DomainManager.Taiwu.GetGenericGridAllocation();
		}
		CharacterCombatSkillConfiguration characterCombatSkillConfiguration = DomainManager.Extra.TryGetCharacterCombatSkillConfiguration(charId);
		if (characterCombatSkillConfiguration == null)
		{
			return new byte[4];
		}
		return characterCombatSkillConfiguration.CurrentEquipPlan.GenericGridAllocation;
	}

	[DomainMethod]
	public unsafe void AllocateGenericGrid(DataContext context, int charId, sbyte equipType)
	{
		if (charId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			DomainManager.Taiwu.AllocateGenericGrid(context, equipType);
			return;
		}
		if (equipType < 1)
		{
			throw new Exception($"Invalid generic grid type:{equipType}");
		}
		sbyte* pointer = stackalloc sbyte[5];
		Span<sbyte> slotCounts = new Span<sbyte>(pointer, 5);
		Character element_Objects = GetElement_Objects(charId);
		sbyte combatSkillSlotCounts = element_Objects.GetCombatSkillSlotCounts(slotCounts);
		CharacterCombatSkillConfiguration characterCombatSkillConfiguration = DomainManager.Extra.TryGetCharacterCombatSkillConfiguration(charId) ?? new CharacterCombatSkillConfiguration(element_Objects);
		CombatSkillPlan currentEquipPlan = characterCombatSkillConfiguration.CurrentEquipPlan;
		int num = equipType - 1;
		int genericAllocationNextCost = CombatSkillHelper.GetGenericAllocationNextCost(equipType, currentEquipPlan.GenericGridAllocation[num]);
		int num2 = element_Objects.ApplyGenericCombatSkillSlotAllocations(slotCounts, combatSkillSlotCounts);
		if (genericAllocationNextCost > num2)
		{
			throw new InvalidOperationException("No more available generic grid");
		}
		currentEquipPlan.GenericGridAllocation[equipType - 1]++;
		DomainManager.Extra.SetCharacterCombatSkillConfiguration(context, charId, characterCombatSkillConfiguration);
	}

	[DomainMethod]
	public void DeallocateGenericGrid(DataContext context, int charId, sbyte equipType)
	{
		if (charId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			DomainManager.Taiwu.DeallocateGenericGrid(context, equipType);
			return;
		}
		if (equipType < 1)
		{
			throw new Exception($"Invalid generic grid type:{equipType}");
		}
		Character element_Objects = GetElement_Objects(charId);
		CharacterCombatSkillConfiguration characterCombatSkillConfiguration = DomainManager.Extra.TryGetCharacterCombatSkillConfiguration(charId) ?? new CharacterCombatSkillConfiguration(element_Objects);
		CombatSkillPlan currentEquipPlan = characterCombatSkillConfiguration.CurrentEquipPlan;
		if (currentEquipPlan.GenericGridAllocation[equipType - 1] == 0)
		{
			throw new Exception($"No generic grid allocated in type:{equipType}");
		}
		currentEquipPlan.GenericGridAllocation[equipType - 1]--;
		DomainManager.Extra.SetCharacterCombatSkillConfiguration(context, charId, characterCombatSkillConfiguration);
	}

	[DomainMethod]
	public void SetCombatSkillPlanLock(DataContext context, int charId, bool isLocked)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
			Tester.Assert(element.GetId() != taiwuCharId);
			Tester.Assert(element.GetLeaderId() == taiwuCharId);
			CharacterCombatSkillConfiguration characterCombatSkillConfiguration = DomainManager.Extra.TryGetCharacterCombatSkillConfiguration(charId) ?? new CharacterCombatSkillConfiguration(element);
			if (characterCombatSkillConfiguration.IsCombatSkillLocked != isLocked)
			{
				characterCombatSkillConfiguration.IsCombatSkillLocked = isLocked;
				DomainManager.Extra.SetCharacterCombatSkillConfiguration(context, charId, characterCombatSkillConfiguration);
			}
		}
	}

	[DomainMethod]
	public bool IsCombatSkillEquipmentLocked(int charId)
	{
		return DomainManager.Extra.TryGetCharacterCombatSkillConfiguration(charId)?.IsCombatSkillLocked ?? false;
	}

	[DomainMethod]
	public void SetCombatSkillAttainmentLock(DataContext context, int charId, bool isLocked)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
			Tester.Assert(element.GetId() != taiwuCharId);
			Tester.Assert(element.GetLeaderId() == taiwuCharId);
			CharacterCombatSkillConfiguration characterCombatSkillConfiguration = DomainManager.Extra.TryGetCharacterCombatSkillConfiguration(charId) ?? new CharacterCombatSkillConfiguration(element);
			if (characterCombatSkillConfiguration.IsCombatSkillAttainmentLocked != isLocked)
			{
				characterCombatSkillConfiguration.IsCombatSkillAttainmentLocked = isLocked;
				DomainManager.Extra.SetCharacterCombatSkillConfiguration(context, charId, characterCombatSkillConfiguration);
			}
		}
	}

	[DomainMethod]
	public bool IsCombatSkillAttainmentLocked(int charId)
	{
		return DomainManager.Extra.TryGetCharacterCombatSkillConfiguration(charId)?.IsCombatSkillAttainmentLocked ?? false;
	}

	[DomainMethod]
	public void SetNeiliAllocationLock(DataContext context, int charId, bool isLocked)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
			Tester.Assert(element.GetId() != taiwuCharId);
			Tester.Assert(element.GetLeaderId() == taiwuCharId);
			CharacterCombatSkillConfiguration characterCombatSkillConfiguration = DomainManager.Extra.TryGetCharacterCombatSkillConfiguration(charId) ?? new CharacterCombatSkillConfiguration(element);
			if (characterCombatSkillConfiguration.IsNeiliAllocationLocked != isLocked)
			{
				characterCombatSkillConfiguration.IsNeiliAllocationLocked = isLocked;
				DomainManager.Extra.SetCharacterCombatSkillConfiguration(context, charId, characterCombatSkillConfiguration);
			}
		}
	}

	[DomainMethod]
	public bool IsNeiliAllocationLocked(int charId)
	{
		return DomainManager.Extra.TryGetCharacterCombatSkillConfiguration(charId)?.IsNeiliAllocationLocked ?? false;
	}

	public void ApplyCombatSkillAttainmentPanels(DataContext context, Character character, short[] panels)
	{
		short[] combatSkillAttainmentPanels = character.GetCombatSkillAttainmentPanels();
		CombatSkillAttainmentPanelsHelper.CopyAll(panels, combatSkillAttainmentPanels);
		character.SetCombatSkillAttainmentPanels(combatSkillAttainmentPanels, context);
		int id = character.GetId();
		Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(id);
		foreach (short num in combatSkillAttainmentPanels)
		{
			if (num >= 0 && (!charCombatSkills.TryGetValue(num, out var value) || value.GetRevoked()))
			{
				TryRemoveCombatSkillFromAttainmentPanel(context, character, num);
			}
		}
	}

	public void ApplyNeiliAllocation(DataContext context, Character character, NeiliAllocation targetAllocation)
	{
		character.ResetBaseNeiliAllocation(context);
		NeiliAllocation current = character.GetBaseNeiliAllocation();
		int maxNeili = character.GetMaxNeili();
		int currNeili = character.GetCurrNeili();
		CombatHelper.TryAllocateToTargetAllocation(targetAllocation, ref current, maxNeili, ref currNeili);
		character.SetBaseNeiliAllocation(current, context);
		character.SpecifyCurrNeili(context, currNeili);
	}

	public void ApplyCombatSkillPlan(DataContext context, Character character, CombatSkillPlan plan)
	{
		int id = character.GetId();
		Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(id);
		CombatSkillEquipment combatSkillEquipment = character.GetCombatSkillEquipment();
		for (sbyte b = 0; b < 5; b++)
		{
			short[] skillList = plan.GetSkillList(b);
			combatSkillEquipment.OfflineEnsureCapacity(b, skillList.Length);
			ArraySegmentList<short> array = combatSkillEquipment[b];
			array.Clear();
			short[] array2 = skillList;
			foreach (short num in array2)
			{
				if (num >= 0 && charCombatSkills.TryGetValue(num, out var value) && !value.GetRevoked() && array.IndexOf(num) < 0)
				{
					array.Add(num);
				}
			}
		}
		character.ApplyCombatSkillEquipmentModification(context, combatSkillEquipment);
	}

	[Obsolete("Use CombatSkillEquipment.IsCombatSkillEquipped instead.")]
	public static bool IsCombatSkillsEquipped(short skillId, short[] equippedCombatSkills, sbyte equipType)
	{
		int num = CombatSkillHelper.SlotBeginIndexes[equipType];
		int num2 = CombatSkillHelper.SlotEndIndexes[equipType];
		for (int i = num; i < num2; i++)
		{
			if (equippedCombatSkills[i] == skillId)
			{
				return true;
			}
		}
		return false;
	}

	public static sbyte GetCombatSkillsCostedGrid(int charId, CombatSkillEquipment skillEquipment, sbyte equipType)
	{
		ArraySegmentList<short> arraySegmentList = skillEquipment[equipType];
		sbyte b = 0;
		ArraySegmentList<short>.Enumerator enumerator = arraySegmentList.GetEnumerator();
		while (enumerator.MoveNext())
		{
			short current = enumerator.Current;
			if (current >= 0)
			{
				b += DomainManager.CombatSkill.GetCombatSkillGridCost(charId, current);
			}
		}
		return b;
	}

	[Obsolete]
	public static bool ClearExceedCombatSkills(int charId, short[] equippedCombatSkills, sbyte equipType)
	{
		sbyte b = CombatSkillHelper.MaxSlotCounts[equipType];
		int num = CombatSkillHelper.SlotBeginIndexes[equipType];
		int num2 = CombatSkillHelper.SlotEndIndexes[equipType];
		int num3 = 0;
		Span<short> span = stackalloc short[equippedCombatSkills.Length];
		SpanList<short> spanList = span;
		for (int i = num; i < num2; i++)
		{
			short num4 = equippedCombatSkills[i];
			if (num4 >= 0)
			{
				spanList.Add(num4);
				equippedCombatSkills[i] = -1;
				num3++;
			}
		}
		int num5 = 0;
		int num6 = num;
		for (int j = 0; j < spanList.Count; j++)
		{
			short num7 = spanList[j];
			sbyte combatSkillGridCost = DomainManager.CombatSkill.GetCombatSkillGridCost(charId, num7);
			if (num6 - num + combatSkillGridCost <= b)
			{
				equippedCombatSkills[num6] = num7;
				num6 += combatSkillGridCost;
				num5++;
			}
		}
		return num3 > num5;
	}

	[DomainMethod]
	public (int, int) GetCombatSkillAttainment(int charId, sbyte type)
	{
		return (charId, GetElement_Objects(charId).GetCombatSkillAttainment(type));
	}

	[DomainMethod]
	public int[] GetAllCombatSkillAttainment(int charId)
	{
		int[] array = new int[14];
		for (sbyte b = 0; b < 14; b++)
		{
			array[b] = GetElement_Objects(charId).GetCombatSkillAttainment(b);
		}
		return array;
	}

	[DomainMethod]
	public (int, int) GetLifeSkillAttainment(int charId, sbyte type)
	{
		if (TryGetElement_Objects(charId, out var element))
		{
			return (charId, element.GetLifeSkillAttainment(type));
		}
		return (-1, -1);
	}

	[DomainMethod]
	public int[] GetAllLifeSkillAttainment(int charId)
	{
		int[] array = new int[16];
		for (sbyte b = 0; b < 16; b++)
		{
			array[b] = GetElement_Objects(charId).GetLifeSkillAttainment(b);
		}
		return array;
	}

	[DomainMethod]
	public void LearnCombatSkill(DataContext context, int charId, short skillTemplateId, ushort readingState = 0)
	{
		Character element_Objects = GetElement_Objects(charId);
		List<short> learnedCombatSkills = element_Objects.GetLearnedCombatSkills();
		if (learnedCombatSkills.Contains(skillTemplateId))
		{
			throw new Exception($"Combat skill already learned. TemplateId:{skillTemplateId}");
		}
		element_Objects.LearnNewCombatSkill(context, skillTemplateId, readingState);
	}

	[DomainMethod]
	public void LearnLifeSkill(DataContext context, int charId, short skillTemplateId, byte readingState = 0)
	{
		Character element_Objects = GetElement_Objects(charId);
		if (element_Objects.FindLearnedLifeSkillIndex(skillTemplateId) >= 0)
		{
			throw new Exception($"Life skill {LifeSkill.Instance[skillTemplateId]} already learned.");
		}
		element_Objects.LearnNewLifeSkill(context, skillTemplateId, readingState);
	}

	public bool HasUnlearnedSectCombatSkills(int charId, sbyte orgTemplateId, sbyte combatSkillType)
	{
		Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(charId);
		IReadOnlyList<CombatSkillItem> learnableCombatSkills = CombatSkillDomain.GetLearnableCombatSkills(orgTemplateId, combatSkillType);
		foreach (CombatSkillItem item in learnableCombatSkills)
		{
			if (charCombatSkills.ContainsKey(item.TemplateId))
			{
				return true;
			}
		}
		return false;
	}

	public void RevokeCombatSkill(DataContext context, Character character, short skillTemplateId)
	{
		int id = character.GetId();
		CombatSkillKey objectId = new CombatSkillKey(id, skillTemplateId);
		GameData.Domains.CombatSkill.CombatSkill element_CombatSkills = DomainManager.CombatSkill.GetElement_CombatSkills(objectId);
		RemoveEquippedCombatSkill(context, id, skillTemplateId);
		TryRemoveCombatSkillFromAttainmentPanel(context, character, skillTemplateId);
		if (character.GetLoopingNeigong() == skillTemplateId)
		{
			character.SetLoopingNeigong(-1, context);
		}
		character.ResetBaseNeiliAllocation(context);
		int num = character.GetCurrNeili() - element_CombatSkills.GetObtainedNeili();
		if (num < 0)
		{
			num = 0;
		}
		character.SetCurrNeili(num, context);
		element_CombatSkills.SetRevoked(revoked: true, context);
	}

	public static bool IsLoopable(GameData.Domains.CombatSkill.CombatSkill skill)
	{
		CombatSkillItem combatSkillItem = Config.CombatSkill.Instance[skill.GetId().SkillTemplateId];
		if (combatSkillItem.EquipType != 0)
		{
			return false;
		}
		ushort activationState = skill.GetActivationState();
		if (!CombatSkillStateHelper.IsBrokenOut(activationState))
		{
			return false;
		}
		return !skill.GetRevoked();
	}

	[Obsolete("Use AddEquippedCombatSkill, RemoveEquippedCombatSkill instead.")]
	[DomainMethod]
	public void SetCombatSkillSlot(DataContext context, int charId, sbyte equipType, int index, short skillTemplateId)
	{
	}

	public void RemoveNonIntelligentCharacter(DataContext context, Character character)
	{
		Tester.Assert(character.GetCreatingType() != 1);
		int id = character.GetId();
		Events.RaiseNonIntelligentCharacterRemoved(context, character);
		RemoveElement_Objects(id);
		RemoveAllRelations(context, id, removeRelatedRelations: true);
		switch (character.GetCreatingType())
		{
		case 0:
		{
			short templateId = character.GetTemplateId();
			DomainManager.Extra.RemoveInteractedCharacter(context, id);
			_fixedCharactersCache.Remove(templateId);
			switch (templateId)
			{
			case 43:
				_tripleAdoreLocation = Location.Invalid;
				break;
			case 45:
				SetForceKindLocation(Location.Invalid, context);
				break;
			case 165:
			case 166:
			case 167:
			case 168:
			case 169:
			case 170:
			case 171:
			case 172:
			case 173:
				_tripleHateLocation = Location.Invalid;
				break;
			case 183:
			case 184:
			case 185:
			case 186:
			case 187:
			case 188:
			case 189:
			case 190:
			case 191:
				SetForceRebelLocation(Location.Invalid, context);
				break;
			}
			break;
		}
		case 2:
		{
			if (_skeletonCharacterCache.TryGetValue(id, out var value))
			{
				_skeletonCharacterCache.Remove(id);
				_graves[value].SetSkeletonCharId(-1, context);
			}
			break;
		}
		}
		RemoveAllItemsBeforeRemovingCharacter(context, character);
	}

	public void RemoveTemporaryIntelligentCharacter(DataContext context, Character character)
	{
		Tester.Assert(character.GetCreatingType() == 1);
		Tester.Assert(IsTemporaryIntelligentCharacter(character.GetId()));
		int id = character.GetId();
		RemoveElement_Objects(id);
		Tester.Assert(!_pregnantStates.ContainsKey(id));
		Tester.Assert(character.GetKidnapperId() < 0);
		Tester.Assert(!_kidnappedChars.ContainsKey(id));
		RemoveAllRelations(context, id, removeRelatedRelations: true);
		DomainManager.Extra.RemoveInteractedCharacter(context, id);
		Tester.Assert(!_debtsToTaiwu.ContainsKey(id));
		if (_avatarElementGrowthProgress.ContainsKey(id))
		{
			RemoveElement_AvatarElementGrowthProgress(id, context);
		}
		Events.RaiseTemporaryIntelligentCharacterRemoved(context, character);
		RemoveAllItemsBeforeRemovingCharacter(context, character);
		UnregisterTemporaryIntelligentCharacter(id);
	}

	public void RemoveXiangshuInfection(DataContext context, Character character, byte targetInfectionValue)
	{
		character.AddFeature(context, 216, removeMutexFeature: true);
		character.SetXiangshuInfection(targetInfectionValue, context);
		Events.RaiseXiangshuInfectionFeatureChanged(context, character, 216);
	}

	[DomainMethod]
	public DeadCharacter TryGetDeadCharacter(int charId)
	{
		DeadCharacter value;
		return _deadCharacters.TryGetValue(charId, out value) ? value : null;
	}

	public bool TryGetDeadCharacter(int charId, out DeadCharacter character)
	{
		return _deadCharacters.TryGetValue(charId, out character);
	}

	public DeadCharacter GetDeadCharacter(int charId)
	{
		return _deadCharacters[charId];
	}

	public DeadCharacter TryGetDeadCharacterByTemplateId(short templateId)
	{
		foreach (KeyValuePair<int, DeadCharacter> deadCharacter in _deadCharacters)
		{
			if (deadCharacter.Value.TemplateId == templateId)
			{
				return deadCharacter.Value;
			}
		}
		return null;
	}

	public int TryGetDeadCharacterIdByTemplateId(short templateId)
	{
		foreach (KeyValuePair<int, DeadCharacter> deadCharacter in _deadCharacters)
		{
			if (deadCharacter.Value.TemplateId == templateId)
			{
				return deadCharacter.Key;
			}
		}
		return -1;
	}

	public bool IsCharacterAlive(int charId)
	{
		return _objects.ContainsKey(charId);
	}

	public bool IsCharacterDeadAndRemoved(int charId)
	{
		return !_objects.ContainsKey(charId) && !_deadCharacters.ContainsKey(charId);
	}

	public sbyte GetAliveOrDeadCharacterGender(int charId)
	{
		if (_objects.TryGetValue(charId, out var value))
		{
			return value.GetGender();
		}
		if (_deadCharacters.TryGetValue(charId, out var value2))
		{
			return value2.Gender;
		}
		return -1;
	}

	public OrganizationInfo GetAliveOrgDeadCharacterOrgInfo(int charId)
	{
		if (_objects.TryGetValue(charId, out var value))
		{
			return value.GetOrganizationInfo();
		}
		if (_deadCharacters.TryGetValue(charId, out var value2))
		{
			return value2.OrganizationInfo;
		}
		return new OrganizationInfo(-1, -1, principal: true, -1);
	}

	public bool OrgAndMonkTypeAllowMarriage(int charId)
	{
		if (_objects.TryGetValue(charId, out var value))
		{
			return value.OrgAndMonkTypeAllowMarriage();
		}
		if (_deadCharacters.TryGetValue(charId, out var value2))
		{
			return value2.OrgAndMonkTypeAllowMarriage();
		}
		return false;
	}

	public bool TryGetCharacterPrioritizedAction(int charId, out BasePrioritizedAction action)
	{
		action = (_prioritizedActions.TryGetValue(charId, out var value) ? value.Action : null);
		return action != null;
	}

	public void SetCharacterPrioritizedAction(DataContext context, int charId)
	{
		if (_prioritizedActions.TryGetValue(charId, out var value))
		{
			SetElement_PrioritizedActions(charId, value, context);
		}
	}

	public PrioritizedActionWrapper AddCharacterPrioritizedAction(DataContext context, int charId, BasePrioritizedAction action)
	{
		PrioritizedActionWrapper prioritizedActionWrapper = new PrioritizedActionWrapper
		{
			ActionType = action.ActionType,
			Action = action
		};
		AddElement_PrioritizedActions(charId, prioritizedActionWrapper, context);
		return prioritizedActionWrapper;
	}

	public void StartCharacterPrioritizedAction(DataContext context, Character character, BasePrioritizedAction action)
	{
		int id = character.GetId();
		if (TryGetCharacterPrioritizedAction(id, out var action2))
		{
			action2.OnInterrupt(context, character);
			RemoveElement_PrioritizedActions(id, context);
			character.ResetPrioritizedActionCooldown(context, action.ActionType, isFailToCreate: false);
		}
		AddCharacterPrioritizedAction(context, id, action);
		action.OnStart(context, character);
	}

	public void RemoveCharacterPrioritizedAction(DataContext context, int charId)
	{
		RemoveElement_PrioritizedActions(charId, context);
	}

	public void AddOngoingVengeance(DataContext context, int avengerId, int targetCharId)
	{
		if (_ongoingVengeances.TryGetValue(targetCharId, out var value))
		{
			value.Add(avengerId);
			SetElement_OngoingVengeances(targetCharId, value, context);
		}
		else
		{
			value = default(CharacterSet);
			value.Add(avengerId);
			AddElement_OngoingVengeances(targetCharId, value, context);
		}
	}

	public bool IsTargetForVengeance(int targetCharId)
	{
		return _ongoingVengeances.ContainsKey(targetCharId);
	}

	public void FinishOngoingVengeance(DataContext context, int avengerId, int targetCharId)
	{
		if (_ongoingVengeances.TryGetValue(targetCharId, out var value))
		{
			value.Remove(avengerId);
			if (value.GetCount() <= 0)
			{
				RemoveElement_OngoingVengeances(targetCharId, context);
			}
			else
			{
				SetElement_OngoingVengeances(targetCharId, value, context);
			}
		}
	}

	[Obsolete]
	public void AddMournedOthers(DataContext context, int charId)
	{
		_mournedOthersChars.Add(charId);
		SetMournedOthersChars(_mournedOthersChars, context);
	}

	[Obsolete]
	public void ClearMournedOthersChars(DataContext context)
	{
		_mournedOthersChars.Clear();
		SetMournedOthersChars(_mournedOthersChars, context);
	}

	[DomainMethod]
	public List<short> GetTitles(int charId)
	{
		if (_objects.TryGetValue(charId, out var value))
		{
			List<short> list = new List<short>();
			value.GetTitles(list);
			return list;
		}
		if (_deadCharacters.TryGetValue(charId, out var value2))
		{
			return value2.TitleIds;
		}
		return new List<short>();
	}

	[DomainMethod]
	public sbyte GetFameType(int charId)
	{
		if (_objects.TryGetValue(charId, out var value))
		{
			return value.GetFameType();
		}
		if (_deadCharacters.TryGetValue(charId, out var value2))
		{
			return value2.FameType;
		}
		return 3;
	}

	[DomainMethod]
	public bool IsReclusive(int charId)
	{
		if (!_objects.TryGetValue(charId, out var value))
		{
			return false;
		}
		if (!IsTemporaryIntelligentCharacter(charId))
		{
			return false;
		}
		if (value.GetSrcCharId() >= 0)
		{
			return false;
		}
		OrganizationInfo organizationInfo = value.GetOrganizationInfo();
		OrganizationMemberItem orgMemberConfig = OrganizationDomain.GetOrgMemberConfig(organizationInfo);
		return orgMemberConfig.RestrictPrincipalAmount;
	}

	[DomainMethod]
	public sbyte GetHighestGradeCombatSkillById(int charId)
	{
		CharacterDisplayData characterDisplayData = GetCharacterDisplayData(charId);
		if (characterDisplayData.OrgInfo.SettlementId < 0)
		{
			return -1;
		}
		Settlement settlement = DomainManager.Organization.GetSettlement(characterDisplayData.OrgInfo.SettlementId);
		short approvingRate = settlement.CalcApprovingRate();
		return OrganizationDomain.GetHighestGradeOfTeachableCombatSkill(approvingRate);
	}

	[DomainMethod]
	public short GetLeftMaxHealth(int charId)
	{
		if (!_objects.TryGetValue(charId, out var value))
		{
			return 0;
		}
		return value.GetLeftMaxHealth();
	}

	[DomainMethod]
	public sbyte GetHealthType(int charId)
	{
		if (!_objects.TryGetValue(charId, out var value))
		{
			return 5;
		}
		return (sbyte)value.GetHealthType();
	}

	[DomainMethod]
	public short GetHealthRecovery(int charId)
	{
		Character element;
		return (short)(TryGetElement_Objects(charId, out element) ? element.GetHealthRecovery(element.IsCompletelyInfected()) : 0);
	}

	[DomainMethod]
	public short GetDisplayingAge(int charId)
	{
		if (TryGetElement_Objects(charId, out var element))
		{
			return element.GetCurrAge();
		}
		PredefinedLog.Show(34, charId);
		return -1;
	}

	[DomainMethod]
	public short GetPhysiologicalAge(int charId)
	{
		if (TryGetElement_Objects(charId, out var element))
		{
			return element.GetPhysiologicalAge();
		}
		PredefinedLog.Show(34, charId);
		return -1;
	}

	[DomainMethod]
	public byte GetPhysiologicalAgeAffector(int charId)
	{
		if (TryGetElement_Objects(charId, out var element))
		{
			AgeAffector ageAffector = AgeAffector.None;
			if (element.GetCurrAge() != element.GetPhysiologicalAge())
			{
				ageAffector = (AgeAffector)((uint)ageAffector | (uint)((element.GetGender() == 0) ? 8 : 4));
			}
			if (element.IsTaiwu())
			{
				if (DomainManager.Extra.IsProfessionalSkillUnlockedAndEquipped(48))
				{
					ageAffector |= AgeAffector.TaoismActive;
				}
				else if (ProfessionSkillHandle.TaoistMonkSkill_HasSurvivedAllTribulation())
				{
					ageAffector |= AgeAffector.TaoismPassive;
				}
			}
			return (byte)ageAffector;
		}
		PredefinedLog.Show(34, charId);
		return 0;
	}

	public static short GetCharacterTemplateIdInGroup(short groupId, sbyte consummateLevel)
	{
		Tester.Assert(groupId >= 0);
		CharacterItem characterItem = Config.Character.Instance[groupId];
		CharacterItem characterItem2 = Config.Character.Instance[groupId + 1];
		if (characterItem2.GroupId != groupId)
		{
			return groupId;
		}
		if (characterItem2.ConsummateLevel > characterItem.ConsummateLevel)
		{
			CharacterItem characterItem3 = characterItem;
			CharacterItem characterItem4 = characterItem3;
			while (characterItem3 != null && characterItem3.GroupId == groupId)
			{
				if (characterItem3.ConsummateLevel >= consummateLevel)
				{
					return characterItem3.TemplateId;
				}
				characterItem4 = characterItem3;
				characterItem3 = Config.Character.Instance[characterItem4.TemplateId + 1];
			}
			return characterItem4.TemplateId;
		}
		CharacterItem characterItem5 = characterItem;
		CharacterItem characterItem6 = characterItem5;
		while (characterItem5 != null && characterItem5.GroupId == groupId)
		{
			if (characterItem5.ConsummateLevel < consummateLevel)
			{
				return characterItem6.TemplateId;
			}
			characterItem6 = characterItem5;
			characterItem5 = Config.Character.Instance[characterItem6.TemplateId + 1];
		}
		return characterItem6.TemplateId;
	}

	public static int GetLivedMonths(short age, sbyte birthMonth)
	{
		int num = DomainManager.World.GetCurrMonthInYear() - birthMonth;
		if (num < 0)
		{
			num += 12;
		}
		return age * 12 + num;
	}

	public static int CalcEscapeSuccessRate(sbyte consummateLevelA, sbyte consummateLevelB)
	{
		return Math.Clamp((consummateLevelA - consummateLevelB + 2) * 25, 0, 100);
	}

	public static int CalcBirthDate(short age, sbyte birthMonth)
	{
		if (age >= 0)
		{
			return DomainManager.World.GetCurrDate() - GetLivedMonths(age, birthMonth);
		}
		return -393216 + birthMonth;
	}

	public static (short year, sbyte month) CalcBirthYearAndMonth(int birthDate)
	{
		int num = ((birthDate >= 0) ? (birthDate / 12) : ((birthDate - 11) / 12));
		int num2 = birthDate - num * 12;
		return (year: (short)num, month: (sbyte)num2);
	}

	public static short CalcAge(int birthDate)
	{
		int currDate = DomainManager.World.GetCurrDate();
		int num = (currDate - birthDate) / 12;
		return (short)((num >= 32767) ? (-1) : ((short)num));
	}

	public void FindIntelligentCharacters(Predicate<Character> predicate, List<Character> results)
	{
		foreach (KeyValuePair<int, Character> @object in _objects)
		{
			Character value = @object.Value;
			if (value.GetCreatingType() == 1 && !DomainManager.Extra.IsPrevLegendaryBookOwnerCopy(@object.Key) && predicate(value))
			{
				results.Add(value);
			}
		}
	}

	public void FindGrave(Predicate<Grave> predicate, List<Grave> results)
	{
		foreach (KeyValuePair<int, Grave> grafe in _graves)
		{
			Grave value = grafe.Value;
			if (predicate(value))
			{
				results.Add(value);
			}
		}
	}

	public void FindIntelligentCharacters(List<Predicate<Character>> predicates, List<Character> results)
	{
		foreach (KeyValuePair<int, Character> @object in _objects)
		{
			Character value = @object.Value;
			short templateId = value.GetTemplateId();
			if (Config.Character.Instance[templateId].CreatingType == 1 && !DomainManager.Extra.IsPrevLegendaryBookOwnerCopy(@object.Key) && CharacterMatchers.MatchAll(value, predicates))
			{
				results.Add(value);
			}
		}
	}

	[DomainMethod]
	public MainAttributes GetMainAttributesRecoveries(int charId)
	{
		if (TryGetElement_Objects(charId, out var element))
		{
			return element.GetMainAttributesRecoveries();
		}
		return default(MainAttributes);
	}

	[DomainMethod]
	public sbyte GetInscriptionStatus(int charId)
	{
		sbyte b = 0;
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		if (charId == taiwuCharId)
		{
			return -1;
		}
		Character character = _objects[charId];
		if (DomainManager.World.GetMainStoryLineProgress() < 8)
		{
			return -3;
		}
		if (character.GetTemplateId() == 836)
		{
			return -1;
		}
		if (DomainManager.Global.IsCharacterInscribed(new InscribedCharacterKey(DomainManager.World.GetWorldId(), charId)))
		{
			b |= 2;
		}
		if (DomainManager.Extra.SectXuannvIsCharacterMirrorImage(charId))
		{
			b |= 4;
		}
		int leaderId = character.GetLeaderId();
		bool flag = DomainManager.Extra.GetSpecialGroup(leaderId)?.Contains(charId) ?? false;
		if (!DomainManager.Taiwu.IsInGroup(charId) && !flag)
		{
			b |= 8;
		}
		if (character.GetAgeGroup() != 2)
		{
			b |= 0x10;
		}
		short favorability = GetFavorability(charId, taiwuCharId);
		if (favorability == short.MinValue)
		{
			b |= 0x20;
		}
		if (character.GetCreatingType() != 1)
		{
			if (!flag)
			{
				return -2;
			}
			b |= 0x40;
		}
		sbyte favorabilityType = FavorabilityType.GetFavorabilityType(favorability);
		if (favorabilityType < 6)
		{
			b |= 0x20;
		}
		return b;
	}

	[DomainMethod]
	public int[] GetCharacterBirthDate(int charId)
	{
		int[] array = new int[2] { charId, -2147483648 };
		if (TryGetElement_Objects(charId, out var element))
		{
			array[1] = element.GetBirthDate();
		}
		DeadCharacter deadCharacter = TryGetDeadCharacter(charId);
		if (deadCharacter != null)
		{
			array[1] = deadCharacter.BirthDate;
		}
		if (array[1] <= int.MinValue)
		{
			throw new Exception($"{charId} get birthDate failed exception: character has not exist ever");
		}
		return array;
	}

	public static void UnionWithInteractableCharacters(HashSet<int> result, HashSet<int> charIds)
	{
		foreach (int charId in charIds)
		{
			Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
			if (!element_Objects.IsActiveExternalRelationState(60) && element_Objects.GetLegendaryBookOwnerState() <= 1)
			{
				result.Add(charId);
			}
		}
	}

	public void ResetAllAdvanceMonthStatus()
	{
		foreach (Character value in _objects.Values)
		{
			value.ResetAdvanceMonthStatus();
		}
	}

	[DomainMethod]
	public void GmCmd_SetCharBaseNeiliProportionOfFiveElements(DataContext context, int charId, NeiliProportionOfFiveElements fiveElements)
	{
		if (_objects.TryGetValue(charId, out var value) && fiveElements.SumCheck() == 100)
		{
			value.SetBaseNeiliProportionOfFiveElements(fiveElements, context);
			if (DomainManager.Combat.TryGetElement_CombatCharacterDict(charId, out var element))
			{
				element.SetNeiliType(value.GetNeiliType(), context);
			}
		}
	}

	[DomainMethod]
	public void GmCmd_ChangeCharDisorderOfQi(DataContext context, int charId, int delta)
	{
		if (_objects.TryGetValue(charId, out var value))
		{
			int num = value.CalcDisorderOfQiDelta(delta);
			short disorderOfQi = value.GetDisorderOfQi();
			short disorderOfQi2 = (short)Math.Clamp(disorderOfQi + num, DisorderLevelOfQi.MinValue, DisorderLevelOfQi.MaxValue);
			value.SetDisorderOfQi(disorderOfQi2, context);
		}
	}

	public void ParallelCreateNewbornChildren(DataContext context, Character mother, bool isDystocia, bool isMotherDead)
	{
		IRandomSource random = context.Random;
		CreateNewBornChildrenModification createNewBornChildrenModification = new CreateNewBornChildrenModification();
		createNewBornChildrenModification.IsDystocia = isDystocia;
		createNewBornChildrenModification.IsMotherDead = isMotherDead;
		int id = mother.GetId();
		PregnantState element_PregnantStates = GetElement_PregnantStates(id);
		int fatherId = element_PregnantStates.FatherId;
		Character element = null;
		DeadCharacter value = null;
		Genome genome = default(Genome);
		if (fatherId >= 0)
		{
			if (!TryGetElement_Objects(fatherId, out element))
			{
				TryGetElement_DeadCharacters(fatherId, out value);
			}
		}
		else
		{
			Genome.CreateRandom(random, ref genome);
		}
		Location location = mother.GetLocation();
		if (!location.IsValid())
		{
			location = mother.GetValidLocation();
		}
		sbyte stateIdByAreaId = DomainManager.Map.GetStateIdByAreaId(location.AreaId);
		element_PregnantStates.CreateMotherRelation = element_PregnantStates.CreateMotherRelation && mother.OrgAndMonkTypeAllowMarriage();
		bool createMotherRelation = element_PregnantStates.CreateMotherRelation;
		bool flag3;
		if (element_PregnantStates.CreateFatherRelation && fatherId >= 0)
		{
			bool flag = element?.OrgAndMonkTypeAllowMarriage() ?? value.OrgAndMonkTypeAllowMarriage();
			int aliveSpouse = DomainManager.Character.GetAliveSpouse(fatherId);
			int aliveSpouse2 = DomainManager.Character.GetAliveSpouse(id);
			bool flag2 = DomainManager.Character.HasRelation(fatherId, id, 1024);
			element_PregnantStates.CreateFatherRelation = element_PregnantStates.CreateFatherRelation && (aliveSpouse < 0 || flag2) && (aliveSpouse2 < 0 || flag2) && flag;
			flag3 = element_PregnantStates.CreateFatherRelation;
		}
		else
		{
			element_PregnantStates.CreateFatherRelation = false;
			flag3 = false;
		}
		Character father = element;
		DeadCharacter deadFather = value;
		int fatherCharId = fatherId;
		if (!flag3 && createMotherRelation)
		{
			int aliveSpouse3 = GetAliveSpouse(id);
			if (aliveSpouse3 >= 0 && aliveSpouse3 != fatherId)
			{
				DeadCharacter value2;
				if (TryGetElement_Objects(aliveSpouse3, out var element2))
				{
					if (element2.OrgAndMonkTypeAllowMarriage())
					{
						flag3 = true;
						fatherCharId = aliveSpouse3;
						father = element2;
					}
				}
				else if (TryGetElement_DeadCharacters(aliveSpouse3, out value2) && value2.OrgAndMonkTypeAllowMarriage())
				{
					flag3 = true;
					fatherCharId = aliveSpouse3;
					deadFather = value2;
				}
			}
		}
		OrganizationInfo organizationInfo;
		short num;
		bool flag4;
		(organizationInfo, num, flag4) = GetMainParentInfo(mother, father, createMotherRelation, flag3, isMotherDead);
		if (num < 0)
		{
			num = ((stateIdByAreaId >= 0) ? MapState.Instance[stateIdByAreaId + 1].TemplateCharacterIds[0] : MapState.Instance[DomainManager.World.GetTaiwuVillageStateTemplateId()].TemplateCharacterIds[0]);
		}
		if (flag4)
		{
			element_PregnantStates.CreateMotherRelation = false;
			element_PregnantStates.CreateFatherRelation = false;
		}
		sbyte random2 = Gender.GetRandom(random);
		(short baseAttraction, AvatarData avatar) tuple2 = GenerateMainChildAvatar(random, mother, element, value, random2);
		short item = tuple2.baseAttraction;
		AvatarData item2 = tuple2.avatar;
		OrganizationItem organizationItem = Config.Organization.Instance[organizationInfo.OrgTemplateId];
		short index = organizationItem.Members[organizationInfo.Grade];
		OrganizationMemberItem organizationMemberItem = OrganizationMember.Instance[index];
		OrganizationMemberItem organizationMemberItem2;
		if (organizationMemberItem.ChildGrade >= 0)
		{
			short index2 = organizationItem.Members[organizationMemberItem.ChildGrade];
			organizationMemberItem2 = OrganizationMember.Instance[index2];
		}
		else
		{
			organizationMemberItem2 = OrganizationMember.Instance[(short)0];
			organizationItem = Config.Organization.Instance[(sbyte)0];
			if (!flag4)
			{
				DefaultInterpolatedStringHandler defaultInterpolatedStringHandler = new DefaultInterpolatedStringHandler(77, 4);
				defaultInterpolatedStringHandler.AppendLiteral("Main parent ");
				defaultInterpolatedStringHandler.AppendFormatted(organizationItem.Name);
				defaultInterpolatedStringHandler.AppendFormatted(organizationMemberItem.GradeName);
				defaultInterpolatedStringHandler.AppendLiteral(" cannot have child but child is not abandoned (mother:");
				defaultInterpolatedStringHandler.AppendFormatted(mother);
				defaultInterpolatedStringHandler.AppendLiteral(", father:");
				defaultInterpolatedStringHandler.AppendFormatted((element == null) ? ((object)value) : ((object)element));
				defaultInterpolatedStringHandler.AppendLiteral(").");
				throw new Exception(defaultInterpolatedStringHandler.ToStringAndClear());
			}
		}
		createNewBornChildrenModification.AdoptedByKidnapper = false;
		int kidnapperId = mother.GetKidnapperId();
		if (kidnapperId >= 0 && kidnapperId != DomainManager.Taiwu.GetTaiwuCharId())
		{
			Character element_Objects = DomainManager.Character.GetElement_Objects(mother.GetKidnapperId());
			OrganizationMemberItem orgMemberConfig = OrganizationDomain.GetOrgMemberConfig(element_Objects.GetOrganizationInfo());
			switch (element_Objects.GetBehaviorType())
			{
			case 0:
			case 1:
				if (flag4 && random.CheckPercentProb(50) && element_Objects.GetMonkType() == 0 && orgMemberConfig.ChildGrade >= 0)
				{
					createNewBornChildrenModification.AdoptedByKidnapper = true;
				}
				createNewBornChildrenModification.IsMotherFree = true;
				createNewBornChildrenModification.IsBabyFree = true;
				break;
			case 2:
				if (flag4 && random.CheckPercentProb(50) && element_Objects.GetMonkType() == 0 && orgMemberConfig.ChildGrade >= 0)
				{
					createNewBornChildrenModification.AdoptedByKidnapper = true;
				}
				createNewBornChildrenModification.IsBabyFree = true;
				break;
			default:
				flag4 = true;
				break;
			}
		}
		int num2 = 1;
		IntPair directedSamsaraInfo = GetDirectedSamsaraInfo(id);
		if (directedSamsaraInfo.First < 0)
		{
			int num3 = random.Next(100);
			num2 = ((num3 < 3) ? 3 : ((num3 >= 8) ? 1 : 2));
		}
		createNewBornChildrenModification.ChildrenMods = new CreateIntelligentCharacterModification[num2];
		createNewBornChildrenModification.IsInsect = fatherId >= 0 && random.CheckPercentProb(GlobalConfig.Instance.CongenitalMalformationProbability) && TryGetRelation(id, fatherId, out var _) && IsInsect(id, fatherId);
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		sbyte currMonthInYear = DomainManager.World.GetCurrMonthInYear();
		for (int i = 0; i < createNewBornChildrenModification.ChildrenMods.Length; i++)
		{
			sbyte b = ((i > 0 && random.CheckPercentProb(25)) ? Gender.Flip(random2) : random2);
			Location location2 = location;
			sbyte grade = (sbyte)((organizationMemberItem2.Gender < 0 || organizationMemberItem2.Gender == b) ? organizationMemberItem2.Grade : 0);
			short settlementId = (short)((organizationInfo.OrgTemplateId == organizationItem.TemplateId) ? organizationInfo.SettlementId : (-1));
			OrganizationInfo orgInfo = new OrganizationInfo(organizationItem.TemplateId, grade, principal: true, settlementId);
			short charTemplateId = GenerateTemplateId(num, b);
			AvatarData avatar = item2?.GenerateMultipleBirthChildAvatar(random, b);
			sbyte b2 = 8;
			if (directedSamsaraInfo.First < 0)
			{
				b2 = DomainManager.Taiwu.OfflinePopStateNewCharacterLegacyGrowingGrade(stateIdByAreaId);
				if (b2 >= 0)
				{
					createNewBornChildrenModification.LegacyGrowingGradeState = stateIdByAreaId;
				}
			}
			IntelligentCharacterCreationInfo intelligentCharacterCreationInfo = new IntelligentCharacterCreationInfo(location2, orgInfo, charTemplateId);
			intelligentCharacterCreationInfo.GrowingSectGrade = b2;
			intelligentCharacterCreationInfo.MotherCharId = id;
			intelligentCharacterCreationInfo.Mother = mother;
			intelligentCharacterCreationInfo.PregnantState = element_PregnantStates;
			intelligentCharacterCreationInfo.FatherCharId = fatherCharId;
			intelligentCharacterCreationInfo.Father = father;
			intelligentCharacterCreationInfo.DeadFather = deadFather;
			intelligentCharacterCreationInfo.ActualFatherCharId = fatherId;
			intelligentCharacterCreationInfo.ActualFather = element;
			intelligentCharacterCreationInfo.ActualDeadFather = value;
			intelligentCharacterCreationInfo.MultipleBirthCount = (sbyte)num2;
			intelligentCharacterCreationInfo.Age = 0;
			intelligentCharacterCreationInfo.BirthMonth = currMonthInYear;
			intelligentCharacterCreationInfo.BaseAttraction = item;
			intelligentCharacterCreationInfo.Avatar = avatar;
			intelligentCharacterCreationInfo.ReincarnationCharId = directedSamsaraInfo.First;
			intelligentCharacterCreationInfo.DestinyType = directedSamsaraInfo.Second;
			intelligentCharacterCreationInfo.AllowRandomGrowingGradeAdjust = fatherId != taiwuCharId && id != taiwuCharId;
			IntelligentCharacterCreationInfo info = intelligentCharacterCreationInfo;
			if (fatherId < 0)
			{
				info.SpecifyGenome = true;
				Genome.Inherit(random, ref mother.GetGenome(), ref genome, ref info.Genome);
			}
			createNewBornChildrenModification.ChildrenMods[i] = ParallelCreateIntelligentCharacter(context, ref info, recordModification: false);
		}
		ParallelModificationsRecorder parallelModificationsRecorder = context.ParallelModificationsRecorder;
		parallelModificationsRecorder.RecordType(ParallelModificationType.CreateNewbornChildren);
		parallelModificationsRecorder.RecordParameterClass(createNewBornChildrenModification);
	}

	public IntPair GetDirectedSamsaraInfo(int motherId)
	{
		BuddhistMonkSkillsData skillsData = DomainManager.Extra.GetProfessionData(6).GetSkillsData<BuddhistMonkSkillsData>();
		int directedSamsara = skillsData.GetDirectedSamsara(motherId);
		if (directedSamsara >= 0)
		{
			return new IntPair(directedSamsara, -1);
		}
		if (DomainManager.Building.TryGetElement_SamsaraPlatformBornDict(motherId, out var value))
		{
			return value;
		}
		return new IntPair(-1, -1);
	}

	private Character PartialComplementCreateNewbornChild(DataContext context, CreateIntelligentCharacterModification mod)
	{
		int num = GenerateNextObjectId(context);
		Character self = mod.Self;
		self.OfflineSetId(num);
		mod.ReincarnationCharId = PickReincarnationChar(context, self.GetBirthDate(), mod.ReincarnationCharId);
		if (mod.ReincarnationCharId >= 0)
		{
			self.OfflineSetPreexistenceCharId(context, mod.ReincarnationCharId);
		}
		ModifySavedSoulCharacter(context, mod, self);
		AddElement_Objects(num, self);
		StartCreatingCharacter(num);
		if (self.GetAgeGroup() == 0)
		{
			AddInfant(num);
		}
		DomainManager.CombatSkill.RegisterCombatSkills(num, mod.CombatSkills);
		AutoActivateReadCombatSkillNormalPages(context, mod.CombatSkills, num);
		self.AddEquipmentAndInventoryItems(context, mod.Equipment, mod.Inventory);
		self.AddSkillBooksAndWeapons(context, mod.InventorySkillBooks, mod.SkillWeaponIds);
		self.UpdateHobbyExpirationDate(context);
		DomainManager.Information.RegisterInformation(num, context);
		if (mod.ReincarnationCharId >= 0)
		{
			Events.RaiseCharacterReincarnated(context, self, mod.ReincarnationCharId);
		}
		Events.RaiseCharacterCreated(context, self);
		CompleteCreatingCharacter(num);
		return self;
	}

	public void ComplementCreateNewbornChildren(DataContext context, CreateNewBornChildrenModification mod)
	{
		CreateIntelligentCharacterModification[] childrenMods = mod.ChildrenMods;
		bool isDystocia = mod.IsDystocia;
		bool isMotherDead = mod.IsMotherDead;
		bool isMotherFree = mod.IsMotherFree;
		int currDate = DomainManager.World.GetCurrDate();
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		MonthlyEventCollection monthlyEventCollection = DomainManager.World.GetMonthlyEventCollection();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int motherCharId = childrenMods[0].MotherCharId;
		int fatherCharId = childrenMods[0].FatherCharId;
		Character element_Objects = DomainManager.Character.GetElement_Objects(motherCharId);
		Location location = element_Objects.GetLocation();
		if (!location.IsValid())
		{
			location = element_Objects.GetValidLocation();
		}
		bool flag = DomainManager.Taiwu.IsInGroup(motherCharId) || fatherCharId == taiwuCharId;
		Character element;
		bool flag2 = TryGetElement_Objects(fatherCharId, out element);
		bool flag3 = childrenMods[0].CreateMotherRelation && !isMotherDead && (isMotherFree || element_Objects.GetKidnapperId() < 0) && !element_Objects.IsCompletelyInfected() && !element_Objects.IsActiveExternalRelationState(32);
		bool flag4 = childrenMods[0].CreateFatherRelation && flag2 && element.GetKidnapperId() < 0 && !element.IsCompletelyInfected() && !element.IsActiveExternalRelationState(32);
		bool abandonChildren = !flag3 && !flag4;
		PregnantState element_PregnantStates = GetElement_PregnantStates(motherCharId);
		int actualFatherId = ((element_PregnantStates.FatherId == fatherCharId) ? (-1) : element_PregnantStates.FatherId);
		int kidnapperId = element_Objects.GetKidnapperId();
		if (kidnapperId >= 0 && isMotherFree)
		{
			lifeRecordCollection.AddReleaseKidnappedCharacter(kidnapperId, currDate, motherCharId, location);
			RemoveKidnappedCharacter(context, motherCharId, kidnapperId, isEscaped: false);
		}
		if (mod.LegacyGrowingGradeState >= 0)
		{
			SByteList element_StateNewCharacterLegacyGrowingGrades = DomainManager.Taiwu.GetElement_StateNewCharacterLegacyGrowingGrades(mod.LegacyGrowingGradeState);
			DomainManager.Taiwu.SetElement_StateNewCharacterLegacyGrowingGrades(mod.LegacyGrowingGradeState, element_StateNewCharacterLegacyGrowingGrades, context);
		}
		CreateIntelligentCharacterModification[] array = childrenMods;
		foreach (CreateIntelligentCharacterModification childrenMod in array)
		{
			if (!flag2)
			{
				childrenMod.Father = null;
			}
			PartialComplementCreateNewbornChild(context, childrenMod);
			int id = childrenMod.Self.GetId();
			sbyte gender = childrenMod.Self.GetGender();
			if (mod.IsInsect)
			{
				childrenMod.Self.AddFeature(context, 339);
			}
			if (childrenMod.Self.GetGender() == 1)
			{
				if (flag)
				{
					monthlyNotificationCollection.AddMotherGiveBirthToBoy(motherCharId, location);
				}
				lifeRecordCollection.AddGiveBirthToBoy(motherCharId, currDate, id, location);
				if (childrenMod.CreateFatherRelation && flag2)
				{
					lifeRecordCollection.AddBecomeFatherToNewBornBoy(fatherCharId, currDate, motherCharId, location, childrenMod.Self.GetId());
					GameData.Domains.Character.Ai.PersonalNeed personalNeed = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(20, motherCharId);
					element.AddPersonalNeed(context, personalNeed);
				}
			}
			else
			{
				if (flag)
				{
					monthlyNotificationCollection.AddMotherGiveBirthToGirl(motherCharId, element_Objects.GetLocation());
				}
				lifeRecordCollection.AddGiveBirthToGirl(motherCharId, currDate, id, location);
				if (childrenMod.CreateFatherRelation && flag2)
				{
					lifeRecordCollection.AddBecomeFatherToNewBornGirl(fatherCharId, currDate, motherCharId, location, childrenMod.Self.GetId());
					GameData.Domains.Character.Ai.PersonalNeed personalNeed2 = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(20, motherCharId);
					element.AddPersonalNeed(context, personalNeed2);
				}
			}
			int dataOffset = ((fatherCharId >= 0) ? secretInformationCollection.AddGiveBirthToChild2(motherCharId, id, fatherCharId) : secretInformationCollection.AddGiveBirthToChild(motherCharId, id));
			int num = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
			if (isDystocia)
			{
				if (isMotherDead)
				{
					if (motherCharId == taiwuCharId)
					{
						if (gender == 1)
						{
							monthlyEventCollection.AddDystociaButHaveChildBoyTaiwu(taiwuCharId, location, id);
						}
						else
						{
							monthlyEventCollection.AddDystociaButHaveChildGirlTaiwu(taiwuCharId, location, id);
						}
					}
					else if (fatherCharId == taiwuCharId && childrenMod.CreateFatherRelation)
					{
						if (gender == 1)
						{
							monthlyEventCollection.AddDystociaButHaveChildBoyWife(motherCharId, location, id);
						}
						else
						{
							monthlyEventCollection.AddDystociaButHaveChildGirlWife(motherCharId, location, id);
						}
					}
				}
				else if (motherCharId == taiwuCharId)
				{
					if (gender == 1)
					{
						monthlyEventCollection.AddDystociaAndHaveChildBoyTaiwu(taiwuCharId, location, id);
					}
					else
					{
						monthlyEventCollection.AddDystociaAndHaveChildGirlTaiwu(taiwuCharId, location, id);
					}
				}
				else if (fatherCharId == taiwuCharId && childrenMod.CreateFatherRelation)
				{
					if (gender == 1)
					{
						monthlyEventCollection.AddDystociaAndHaveChildBoyWife(motherCharId, location, id);
					}
					else
					{
						monthlyEventCollection.AddDystociaAndHaveChildGirlWife(motherCharId, location, id);
					}
				}
			}
			else if (motherCharId == taiwuCharId)
			{
				if (gender == 1)
				{
					monthlyEventCollection.AddHaveChildBoyTaiwu(motherCharId, location, id);
				}
				else
				{
					monthlyEventCollection.AddHaveChildGirlTaiwu(motherCharId, location, id);
				}
			}
			else if (fatherCharId == taiwuCharId && childrenMod.CreateFatherRelation)
			{
				if (gender == 1)
				{
					monthlyEventCollection.AddHaveChildBoyWife(motherCharId, location, id);
				}
				else
				{
					monthlyEventCollection.AddHaveChildGirlWife(motherCharId, location, id);
				}
			}
			if (kidnapperId == taiwuCharId)
			{
				Events.RegisterHandler_PassingLegacyWhileAdvancingMonth(delegate(DataContext threadContext)
				{
					bool flag5 = IsCharacterAlive(motherCharId);
					bool flag6 = IsCharacterAlive(fatherCharId);
					if (abandonChildren || (!flag5 && !flag6))
					{
						AbandonNewbornChild(threadContext, childrenMod.Self, null, motherCharId, (actualFatherId >= 0) ? actualFatherId : fatherCharId);
					}
					else
					{
						HandleNotAbandonedNewbornChildRelationsAndGroup(context, childrenMod.Self, motherCharId, fatherCharId, actualFatherId, childrenMod.CreateMotherRelation, childrenMod.CreateFatherRelation, flag5, flag6);
					}
				});
				continue;
			}
			if (mod.IsBabyFree)
			{
				lifeRecordCollection.AddReleaseKidnappedCharacter(kidnapperId, currDate, id, location);
			}
			if (abandonChildren)
			{
				Character element2 = null;
				if (mod.AdoptedByKidnapper)
				{
					TryGetElement_Objects(kidnapperId, out element2);
				}
				AbandonNewbornChild(context, childrenMod.Self, element2, motherCharId, fatherCharId);
			}
			else
			{
				HandleNotAbandonedNewbornChildRelationsAndGroup(context, childrenMod.Self, motherCharId, fatherCharId, actualFatherId, childrenMod.CreateMotherRelation, childrenMod.CreateFatherRelation, !isMotherDead, flag2);
			}
		}
		if (kidnapperId == taiwuCharId)
		{
			int id2 = childrenMods[0].Self.GetId();
			int charId = ((childrenMods.Length > 1) ? childrenMods[1].Self.GetId() : (-1));
			int charId2 = ((childrenMods.Length > 2) ? childrenMods[2].Self.GetId() : (-1));
			monthlyEventCollection.AddCaptiveHaveChild(taiwuCharId, motherCharId, id2, charId, charId2, fatherCharId, actualFatherId);
			AddLockMovementCharSet(motherCharId);
		}
		if (motherCharId == taiwuCharId)
		{
			CreateIntelligentCharacterModification[] array2 = childrenMods;
			foreach (CreateIntelligentCharacterModification createIntelligentCharacterModification in array2)
			{
				DomainManager.Taiwu.ApplyPrenatalEducationBonus(context, createIntelligentCharacterModification.Self);
			}
			DomainManager.Taiwu.ClearPrenatalEducationBonus(context);
		}
		if ((motherCharId == taiwuCharId || fatherCharId == taiwuCharId) && HasRelation(motherCharId, fatherCharId, 1024))
		{
			DomainManager.Taiwu.AddLegacyPoint(context, 4);
		}
	}

	public void HandleNotAbandonedNewbornChildRelationsAndGroup(DataContext context, Character baby, int motherCharId, int fatherCharId, int actualFatherId, bool createMotherRelation, bool createFatherRelation, bool isMotherAlive, bool isFatherAlive)
	{
		int id = baby.GetId();
		Location location = baby.GetLocation();
		SetBloodRelatedRelations(context, id, motherCharId, fatherCharId, actualFatherId, createMotherRelation, createFatherRelation);
		DomainManager.Organization.JoinOrganization(context, baby, baby.GetOrganizationInfo());
		if (createMotherRelation && isMotherAlive && _objects.TryGetValue(motherCharId, out var value) && value.GetKidnapperId() < 0 && !value.IsCompletelyInfected() && !value.IsActiveExternalRelationState(32))
		{
			Location location2 = value.GetLocation();
			if (!location.Equals(location2))
			{
				Events.RaiseCharacterLocationChanged(context, id, location, location2);
				baby.SetLocation(location2, context);
			}
			else
			{
				Events.RaiseCharacterLocationChanged(context, id, Location.Invalid, location2);
			}
			if (DomainManager.Taiwu.IsInGroup(value.GetId()))
			{
				DomainManager.Taiwu.JoinGroup(context, id, showNotification: false);
			}
			else
			{
				JoinGroup(context, baby, value);
			}
			return;
		}
		if (createFatherRelation && isFatherAlive && _objects.TryGetValue(fatherCharId, out var value2) && value2.GetKidnapperId() < 0 && !value2.IsCompletelyInfected() && !value2.IsActiveExternalRelationState(32))
		{
			Location location3 = value2.GetLocation();
			if (!location.Equals(location3))
			{
				Events.RaiseCharacterLocationChanged(context, id, location, location3);
				baby.SetLocation(location3, context);
			}
			else
			{
				Events.RaiseCharacterLocationChanged(context, id, Location.Invalid, location3);
			}
			if (DomainManager.Taiwu.IsInGroup(value2.GetId()))
			{
				DomainManager.Taiwu.JoinGroup(context, id, showNotification: false);
			}
			else
			{
				JoinGroup(context, baby, value2);
			}
			return;
		}
		int aliveMentor = GetAliveMentor(id);
		if (aliveMentor < 0)
		{
			throw new Exception($"newborn child {id}(child of {motherCharId} and {fatherCharId}) is not abandoned but has nowhere to go.");
		}
		Character character = _objects[aliveMentor];
		Location location4 = character.GetLocation();
		if (!location.Equals(location4))
		{
			Events.RaiseCharacterLocationChanged(context, id, location, location4);
			baby.SetLocation(location4, context);
		}
		else
		{
			Events.RaiseCharacterLocationChanged(context, id, Location.Invalid, location4);
		}
		if (DomainManager.Taiwu.IsInGroup(aliveMentor))
		{
			DomainManager.Taiwu.JoinGroup(context, id);
		}
		else
		{
			JoinGroup(context, baby, character);
		}
	}

	public void AbandonNewbornChild(DataContext context, Character baby, Character assignedAdopter, int motherCharId, int fatherCharId)
	{
		int id = baby.GetId();
		if (_objects.TryGetValue(motherCharId, out var value))
		{
			value.ChangeHappiness(context, AiHelper.UpdateStatusConstants.LostChildHappinessChange[value.GetBehaviorType()]);
			GameData.Domains.Character.Ai.PersonalNeed personalNeed = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(19, id);
			value.AddPersonalNeed(context, personalNeed);
			GameData.Domains.Character.Ai.PersonalNeed personalNeed2 = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed((sbyte)25, (ushort)64);
			baby.AddPersonalNeed(context, personalNeed2);
		}
		SetBloodRelatedRelations(context, id, motherCharId, fatherCharId, -1, createMotherRelation: false, createFatherRelation: false);
		if (assignedAdopter != null)
		{
			if (assignedAdopter.GetId() != DomainManager.Taiwu.GetTaiwuCharId() && assignedAdopter.GetOrganizationInfo().OrgTemplateId == 16)
			{
				AddPotentialAdopterToInfant(id, assignedAdopter.GetId());
				DomainManager.World.GetMonthlyEventCollection().AddTaiwuVillagerAdoptOrphan(assignedAdopter.GetId(), id, motherCharId);
			}
			else
			{
				AssignChildToAdopter(context, assignedAdopter, baby, motherCharId);
			}
			return;
		}
		int aliveMentor = DomainManager.Character.GetAliveMentor(id);
		if (aliveMentor >= 0)
		{
			Character element_Objects = DomainManager.Character.GetElement_Objects(aliveMentor);
			DomainManager.Character.AssignChildToMentor(context, element_Objects, baby, motherCharId);
			return;
		}
		OrganizationInfo aliveOrgDeadCharacterOrgInfo = DomainManager.Character.GetAliveOrgDeadCharacterOrgInfo(motherCharId);
		int objectId = DomainManager.Character.SelectRandomAdopter(context.Random, baby, aliveOrgDeadCharacterOrgInfo.OrgTemplateId);
		TryGetElement_Objects(objectId, out assignedAdopter);
		if (assignedAdopter == null)
		{
			AbandonToNearbySettlement(context, baby, motherCharId);
		}
		else if (assignedAdopter.GetOrganizationInfo().OrgTemplateId == 16)
		{
			AddPotentialAdopterToInfant(id, assignedAdopter.GetId());
			DomainManager.World.GetMonthlyEventCollection().AddTaiwuVillagerAdoptOrphan(assignedAdopter.GetId(), id, motherCharId);
		}
		else
		{
			AssignChildToAdopter(context, assignedAdopter, baby, motherCharId);
		}
	}

	internal void AbandonToNearbySettlement(DataContext context, Character baby, int motherCharId, bool nearTaiwuVillage = false)
	{
		MapDomain map = DomainManager.Map;
		Location obj = (nearTaiwuVillage ? DomainManager.Taiwu.GetTaiwuVillageLocation() : baby.GetLocation());
		sbyte stateIdByAreaId = map.GetStateIdByAreaId(obj.AreaId);
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		DomainManager.Map.GetStateSettlementIds(stateIdByAreaId, list);
		list.RemoveAll((short x) => x == DomainManager.Taiwu.GetTaiwuVillageSettlementId());
		short settlementId = (short)((list.Count == 0) ? (-1) : list.GetRandom(context.Random));
		ObjectPool<List<short>>.Instance.Return(list);
		AbandonToNearbySettlement(context, baby, motherCharId, settlementId);
	}

	internal void AbandonToNearbySettlement(DataContext context, Character baby, int motherCharId, short settlementId)
	{
		AddInfant(baby.GetId());
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
		OrganizationInfo organizationInfo = new OrganizationInfo(settlement.GetOrgTemplateId(), 0, principal: true, settlementId);
		baby.SetOrganizationInfo(organizationInfo, context);
		Events.RaiseCharacterLocationChanged(context, baby.GetId(), baby.GetLocation(), settlement.GetLocation());
		baby.SetLocation(settlement.GetLocation(), context);
		DomainManager.Organization.JoinOrganization(context, baby, organizationInfo);
		lifeRecordCollection.AddAbandonChild(motherCharId, currDate, baby.GetId(), settlementId);
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		int dataOffset = secretInformationCollection.AddAbandonChild(motherCharId, baby.GetId());
		DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
	}

	private int SelectRandomAdopter(IRandomSource random, Character abandonedChild, sbyte motherOrgTemplateId)
	{
		List<sbyte> abandonedBabyOrganizations = Config.Organization.Instance[motherOrgTemplateId].AbandonedBabyOrganizations;
		sbyte orgTemplateId = (sbyte)((abandonedBabyOrganizations.Count > 0) ? abandonedBabyOrganizations[random.Next(abandonedBabyOrganizations.Count)] : (random.NextBool() ? 16 : OrganizationDomain.GetRandomSectOrgTemplateId(random, abandonedChild.GetGender())));
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId);
		int randomValidAdopterInSettlement = GetRandomValidAdopterInSettlement(random, settlementByOrgTemplateId);
		if (randomValidAdopterInSettlement < 0)
		{
			settlementByOrgTemplateId = DomainManager.Organization.GetSettlement(DomainManager.Taiwu.GetTaiwuVillageSettlementId());
			randomValidAdopterInSettlement = GetRandomValidAdopterInSettlement(random, settlementByOrgTemplateId);
		}
		return randomValidAdopterInSettlement;
	}

	internal void AssignChildToAdopter(DataContext context, Character adopter, Character adoptedChild, int motherCharId)
	{
		int currDate = DomainManager.World.GetCurrDate();
		int id = adopter.GetId();
		OrganizationInfo organizationInfo = adopter.GetOrganizationInfo();
		int id2 = adoptedChild.GetId();
		if (organizationInfo.SettlementId != adoptedChild.GetOrganizationInfo().SettlementId)
		{
			sbyte childGrade = OrganizationDomain.GetOrgMemberConfig(organizationInfo).ChildGrade;
			OrganizationInfo organizationInfo2 = new OrganizationInfo(organizationInfo.OrgTemplateId, childGrade, principal: true, organizationInfo.SettlementId);
			adoptedChild.SetOrganizationInfo(organizationInfo2, context);
			DomainManager.Organization.JoinOrganization(context, adoptedChild, organizationInfo2);
		}
		else
		{
			DomainManager.Organization.JoinOrganization(context, adoptedChild, adoptedChild.GetOrganizationInfo());
		}
		FullName fullName = GenerateRandomChildName(context, adoptedChild.GetGender(), adopter.GetFullName());
		adoptedChild.SetFullName(fullName, context);
		Location location = adopter.GetLocation();
		if (!location.Equals(adoptedChild.GetLocation()))
		{
			Events.RaiseCharacterLocationChanged(context, id2, adoptedChild.GetLocation(), location);
			adoptedChild.SetLocation(location, context);
		}
		else
		{
			Events.RaiseCharacterLocationChanged(context, id2, Location.Invalid, location);
		}
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		lifeRecordCollection.AddAbandonChild(motherCharId, currDate, id2, adoptedChild.GetOrganizationInfo().SettlementId);
		short relatedRecordId = (short)((adopter?.GetGender() == 1) ? 46 : 47);
		if (adoptedChild.GetGender() == 1)
		{
			lifeRecordCollection.AddAdoptSon(id, currDate, id2, location, relatedRecordId);
		}
		else
		{
			lifeRecordCollection.AddAdoptDaughter(id, currDate, id2, location, relatedRecordId);
		}
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		int dataOffset = secretInformationCollection.AddAbandonChild(motherCharId, id2);
		DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
		AddAdoptiveParentRelations(context, id2, id, currDate);
		int aliveSpouse = DomainManager.Character.GetAliveSpouse(id);
		if (aliveSpouse >= 0)
		{
			DomainManager.Character.AddAdoptiveParentRelations(context, id2, aliveSpouse, currDate);
		}
		if (DomainManager.Taiwu.IsInGroup(adopter.GetId()))
		{
			DomainManager.Taiwu.JoinGroup(context, id2);
		}
		else
		{
			JoinGroup(context, adoptedChild, adopter);
		}
	}

	private void AssignChildToMentor(DataContext context, Character mentor, Character child, int motherCharId)
	{
		int currDate = DomainManager.World.GetCurrDate();
		int id = child.GetId();
		Location location = mentor.GetLocation();
		Location location2 = child.GetLocation();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		lifeRecordCollection.AddAbandonChild(motherCharId, currDate, id, child.GetOrganizationInfo().SettlementId);
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		int dataOffset = secretInformationCollection.AddAbandonChild(motherCharId, id);
		DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
		if (!location.Equals(location2))
		{
			Events.RaiseCharacterLocationChanged(context, id, location2, location);
			child.SetLocation(location, context);
		}
		else
		{
			Events.RaiseCharacterLocationChanged(context, id, Location.Invalid, location);
		}
		DomainManager.Organization.JoinOrganization(context, child, child.GetOrganizationInfo());
		JoinGroup(context, child, mentor);
	}

	public unsafe override void PackCrossArchiveGameData(CrossArchiveGameData crossArchiveGameData)
	{
		crossArchiveGameData.NextObjectId = _nextObjectId;
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		int id = taiwu.GetId();
		crossArchiveGameData.TaiwuChar = taiwu;
		crossArchiveGameData.DreamBackTaiwuAbridged = GetAbridgeCharacter(id);
		crossArchiveGameData.TaiwuResources = taiwu.GetResources();
		crossArchiveGameData.TaiwuExp = taiwu.GetExp();
		crossArchiveGameData.FuyuFaith = DomainManager.Extra.GetFuyuFaith();
		HashSet<int> hashSet = new HashSet<int>();
		GetAllRelatedCharIds(id, hashSet);
		crossArchiveGameData.AbridgedCharacters = new Dictionary<int, AbridgedCharacter>();
		foreach (int item in hashSet)
		{
			PackAbridgedCharacter(crossArchiveGameData, item);
		}
		Genealogy genealogy = GetGenealogy(id);
		PackAbridgedCharacter(crossArchiveGameData, genealogy.GrandfatherId);
		PackAbridgedCharacter(crossArchiveGameData, genealogy.GrandmotherId);
		PackAbridgedCharacter(crossArchiveGameData, genealogy.MaternalGrandfatherId);
		PackAbridgedCharacter(crossArchiveGameData, genealogy.MaternalGrandmotherId);
		foreach (SpouseAndChildren spouse in genealogy.Spouses)
		{
			PackSpouseAndChildren(spouse);
		}
		crossArchiveGameData.Genealogy = genealogy;
		crossArchiveGameData.PreexistenceDeadCharacters = new Dictionary<int, DeadCharacter>();
		PreexistenceCharIds preexistenceCharIds = taiwu.GetPreexistenceCharIds();
		int i = 0;
		for (int count = preexistenceCharIds.Count; i < count; i++)
		{
			int num = preexistenceCharIds.CharIds[i];
			DeadCharacter deadCharacter = DomainManager.Character.TryGetDeadCharacter(num);
			if (deadCharacter != null)
			{
				crossArchiveGameData.PreexistenceDeadCharacters.Add(num, deadCharacter);
			}
		}
		ItemKey[] equipment = taiwu.GetEquipment();
		ItemKey[] array = equipment;
		for (int j = 0; j < array.Length; j++)
		{
			ItemKey itemKey = array[j];
			if (itemKey.IsValid())
			{
				DomainManager.Item.PackCrossArchiveItem(crossArchiveGameData, itemKey);
			}
		}
		Inventory inventory = taiwu.GetInventory();
		foreach (ItemKey key in inventory.Items.Keys)
		{
			DomainManager.Item.PackCrossArchiveItem(crossArchiveGameData, key);
		}
		void PackSpouseAndChildren(SpouseAndChildren spouseAndChildren)
		{
			PackAbridgedCharacter(crossArchiveGameData, spouseAndChildren.SpouseCharId);
			if (spouseAndChildren.Children != null)
			{
				foreach (CharIdAndRelation child in spouseAndChildren.Children)
				{
					PackAbridgedCharacter(crossArchiveGameData, child.CharId);
				}
			}
			if (spouseAndChildren.BloodChildrenSpouses != null)
			{
				foreach (SpousesAndChildren bloodChildrenSpouse in spouseAndChildren.BloodChildrenSpouses)
				{
					PackSpousesAndChildren(bloodChildrenSpouse);
				}
			}
		}
		void PackSpousesAndChildren(SpousesAndChildren spousesAndChildren)
		{
			PackAbridgedCharacter(crossArchiveGameData, spousesAndChildren.CoreCharId);
			if (spousesAndChildren.Spouses != null)
			{
				foreach (SpouseAndChildren spouse2 in spousesAndChildren.Spouses)
				{
					PackSpouseAndChildren(spouse2);
				}
			}
		}
	}

	public unsafe override void UnpackCrossArchiveGameData(DataContext context, CrossArchiveGameData crossArchiveGameData)
	{
		_nextObjectId = Math.Max(crossArchiveGameData.NextObjectId, _nextObjectId);
		SetNextObjectId(_nextObjectId, context);
		DomainManager.Extra.SetFuyuFaith(crossArchiveGameData.FuyuFaith, context);
		DomainManager.Extra.SaveOverwrittenTaiwu(context);
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		RemoveElement_Objects(taiwuCharId);
		Dictionary<int, int> dictionary = new Dictionary<int, int>();
		ref PreexistenceCharIds preexistenceCharIds = ref crossArchiveGameData.TaiwuChar.GetPreexistenceCharIds();
		int i = 0;
		for (int count = preexistenceCharIds.Count; i < count; i++)
		{
			int key = preexistenceCharIds.CharIds[i];
			if (!crossArchiveGameData.PreexistenceDeadCharacters.TryGetValue(key, out var _))
			{
				preexistenceCharIds.CharIds[i] = -1;
				continue;
			}
			int num = GenerateNextObjectId(context);
			dictionary.Add(key, num);
			preexistenceCharIds.CharIds[i] = num;
		}
		foreach (KeyValuePair<int, DeadCharacter> preexistenceDeadCharacter in crossArchiveGameData.PreexistenceDeadCharacters)
		{
			preexistenceDeadCharacter.Deconstruct(out var key2, out var value2);
			int key3 = key2;
			DeadCharacter deadCharacter = value2;
			int elementId = dictionary[key3];
			PreexistenceCharIds preexistenceCharIds2 = deadCharacter.PreexistenceCharIds;
			int j = 0;
			for (int count2 = preexistenceCharIds2.Count; j < count2; j++)
			{
				int key4 = preexistenceCharIds2.CharIds[j];
				if (!crossArchiveGameData.PreexistenceDeadCharacters.TryGetValue(key4, out var _))
				{
					preexistenceCharIds2.CharIds[j] = -1;
					continue;
				}
				if (!dictionary.TryGetValue(key4, out var value4))
				{
					Logger.Warn($"Invalid character id as preexistence char {value4}");
					value4 = -1;
				}
				preexistenceCharIds2.CharIds[j] = value4;
			}
			deadCharacter.PreexistenceCharIds = preexistenceCharIds2;
			AddElement_DeadCharacters(elementId, deadCharacter, context);
		}
		taiwu.OfflineInheritCrossArchiveCharacter(crossArchiveGameData.TaiwuChar);
		List<short> featureIds = taiwu.GetFeatureIds();
		if (_pregnantStates.ContainsKey(taiwuCharId))
		{
			featureIds.Add(197);
		}
		AddElement_Objects(taiwuCharId, taiwu);
		if (taiwu.GetAgeGroup() == 1)
		{
			taiwu.ReAdjustClothingByAge(context);
		}
		MainAttributes maxMainAttributes = taiwu.GetMaxMainAttributes();
		MainAttributes currMainAttributes = taiwu.GetCurrMainAttributes();
		for (sbyte b = 0; b < 6; b++)
		{
			currMainAttributes.Items[b] = Math.Min(currMainAttributes.Items[b], maxMainAttributes.Items[b]);
		}
		taiwu.SetCurrMainAttributes(currMainAttributes, context);
	}

	public void UnpackCrossArchiveGameData_Items(DataContext context, CrossArchiveGameData crossArchiveGameData, bool overwriteEquipments)
	{
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Inventory inventory = taiwu.GetInventory();
		ItemKey[] equipment = taiwu.GetEquipment();
		int id = taiwu.GetId();
		ItemKey[] equipment2 = crossArchiveGameData.TaiwuChar.GetEquipment();
		for (int i = 0; i < equipment2.Length; i++)
		{
			ItemKey itemKey = equipment2[i];
			if (!itemKey.IsValid())
			{
				continue;
			}
			ItemKey itemKey2 = DomainManager.Item.UnpackCrossArchiveItem(context, crossArchiveGameData, itemKey.Id);
			if (itemKey.ItemType == 3 && (Config.Clothing.Instance[itemKey.TemplateId].AgeGroup != 2 || taiwu.GetAgeGroup() != 2))
			{
				if (itemKey2.IsValid())
				{
					DomainManager.Item.RemoveItem(context, itemKey2);
					crossArchiveGameData.UnpackedItems.Remove(itemKey2.Id);
				}
				equipment2[i] = equipment[i];
			}
			else
			{
				equipment2[i] = itemKey2;
				if (itemKey2.IsValid())
				{
					DomainManager.Item.SetOwner(itemKey2, ItemOwnerType.CharacterInventory, id);
					inventory.OfflineAdd(itemKey2, 1);
				}
			}
		}
		if (overwriteEquipments)
		{
			taiwu.ChangeEquipment(context, equipment2);
		}
		Inventory inventory2 = crossArchiveGameData.TaiwuChar.GetInventory();
		foreach (var (itemKey4, amount) in inventory2.Items)
		{
			if (!ItemTemplateHelper.IsInheritable(itemKey4.ItemType, itemKey4.TemplateId))
			{
				continue;
			}
			ItemKey itemKey5 = DomainManager.Item.UnpackCrossArchiveItem(context, crossArchiveGameData, itemKey4.Id);
			if (!itemKey5.IsValid())
			{
				continue;
			}
			if (itemKey4.ItemType == 12)
			{
				if (Config.Misc.Instance[itemKey4.TemplateId].ItemSubType == 1202)
				{
					int num2 = itemKey4.TemplateId - 211;
					DomainManager.LegendaryBook.RegisterOwner(context, taiwu, (sbyte)num2);
				}
				else if (itemKey4.TemplateId == 199)
				{
					if (inventory.GetInventoryItemCount(itemKey4.ItemType, itemKey4.TemplateId) > 0 || DomainManager.Building.IsTaiwuVillageHaveSpecifyBuilding(50))
					{
						continue;
					}
				}
				else if (itemKey4.TemplateId == 198 && (inventory.GetInventoryItemCount(itemKey4.ItemType, itemKey4.TemplateId) > 0 || DomainManager.Building.IsTaiwuVillageHaveSpecifyBuilding(51)))
				{
					continue;
				}
			}
			ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey5);
			baseItem.ResetOwner();
			baseItem.SetOwner(ItemOwnerType.CharacterInventory, id);
			inventory.OfflineAdd(itemKey5, amount);
		}
		taiwu.SetInventory(inventory, context);
		inventory2.Items.Clear();
		RemoveDlcDuplicateClothing(context, fixArchiveData: false);
	}

	public void RemoveDlcDuplicateClothing(DataContext context, bool fixArchiveData)
	{
		foreach (ClothingItem item in (IEnumerable<ClothingItem>)Config.Clothing.Instance)
		{
			if (!string.IsNullOrEmpty(item.DlcName))
			{
				RemoveDuplicateClothing(context, item.TemplateId, fixArchiveData);
			}
		}
	}

	private void RemoveDuplicateClothing(DataContext context, short templateId, bool fixArchiveData)
	{
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Inventory inventory = taiwu.GetInventory();
		ItemKey[] equipment = taiwu.GetEquipment();
		int inventoryItemCount = inventory.GetInventoryItemCount(3, templateId);
		int num = 0;
		if (equipment[4].TemplateId == templateId && inventoryItemCount >= 1)
		{
			num = inventoryItemCount;
		}
		else if (inventoryItemCount >= 2)
		{
			num = inventoryItemCount - 1;
		}
		for (int i = 0; i < num; i++)
		{
			ItemKey inventoryItemKey = inventory.GetInventoryItemKey(3, templateId);
			if (inventoryItemKey.IsValid())
			{
				taiwu.RemoveInventoryItem(context, inventoryItemKey, 1, deleteItem: true);
				if (fixArchiveData)
				{
					Logger.Warn($"FixArchiveData with RemoveDuplicateClothing Func,Clothing templateId:{inventoryItemKey.TemplateId},itemKey.Id:{inventoryItemKey.Id}");
				}
			}
		}
	}

	public void UnpackCrossArchiveGameData_LifeSkills(DataContext context, CrossArchiveGameData crossArchiveGameData)
	{
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		List<LifeSkillItem> learnedLifeSkills = crossArchiveGameData.TaiwuChar.GetLearnedLifeSkills();
		List<LifeSkillItem> learnedLifeSkills2 = taiwu.GetLearnedLifeSkills();
		List<LifeSkillItem> list = new List<LifeSkillItem>();
		foreach (LifeSkillItem item2 in learnedLifeSkills)
		{
			int num = taiwu.FindLearnedLifeSkillIndex(item2.SkillTemplateId);
			if (num >= 0)
			{
				LifeSkillItem item = learnedLifeSkills2[num];
				item.ReadingState |= item2.ReadingState;
				list.Add(item);
			}
			else
			{
				list.Add(item2);
			}
		}
		taiwu.SetLearnedLifeSkills(list, context);
		learnedLifeSkills.Clear();
	}

	private void PackAbridgedCharacter(CrossArchiveGameData crossArchiveGameData, int charId)
	{
		if (!crossArchiveGameData.AbridgedCharacters.ContainsKey(charId) && charId >= 0)
		{
			AbridgedCharacter abridgeCharacter = GetAbridgeCharacter(charId);
			if (abridgeCharacter != null)
			{
				crossArchiveGameData.AbridgedCharacters.Add(charId, abridgeCharacter);
			}
		}
	}

	public AbridgedCharacter GetAbridgeCharacter(int charId)
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		RelationKey key = new RelationKey(charId, taiwuCharId);
		RelationKey key2 = new RelationKey(taiwuCharId, charId);
		ushort selfRelationToTaiwu = ushort.MaxValue;
		ushort taiwuRelationToSelf = ushort.MaxValue;
		if (charId != taiwuCharId)
		{
			if (_relations.TryGetValue(key, out var value))
			{
				selfRelationToTaiwu = value.RelationType;
			}
			if (_relations.TryGetValue(key2, out var value2))
			{
				taiwuRelationToSelf = value2.RelationType;
			}
		}
		if (_objects.TryGetValue(charId, out var value3))
		{
			return new AbridgedCharacter
			{
				Id = value3.GetId(),
				CharTemplateId = value3.GetTemplateId(),
				Gender = value3.GetGender(),
				ActualAge = value3.GetActualAge(),
				CurrAge = value3.GetCurrAge(),
				MonkType = value3.GetMonkType(),
				Avatar = value3.GetAvatar(),
				ClothingDisplayId = value3.GetClothingDisplayId(),
				FullName = value3.GetFullName(),
				OrganizationInfo = value3.GetOrganizationInfo(),
				MonasticTitle = value3.GetMonasticTitle(),
				CustomDisplayNameId = DomainManager.Extra.GetCharacterCustomDisplayName(charId),
				SelfRelationToTaiwu = selfRelationToTaiwu,
				TaiwuRelationToSelf = taiwuRelationToSelf,
				AliveState = 0,
				Location = value3.GetLocation(),
				BirthDate = value3.GetBirthDate()
			};
		}
		Grave value5;
		if (_deadCharacters.TryGetValue(charId, out var value4))
		{
			return new AbridgedCharacter
			{
				Id = charId,
				CharTemplateId = value4.TemplateId,
				Gender = value4.Gender,
				ActualAge = value4.GetActualAge(),
				CurrAge = value4.CurrAge,
				MonkType = value4.MonkType,
				Avatar = value4.Avatar,
				ClothingDisplayId = value4.ClothingDisplayId,
				FullName = value4.FullName,
				OrganizationInfo = value4.OrganizationInfo,
				MonasticTitle = value4.MonasticTitle,
				CustomDisplayNameId = DomainManager.Extra.GetCharacterCustomDisplayName(charId),
				SelfRelationToTaiwu = selfRelationToTaiwu,
				TaiwuRelationToSelf = taiwuRelationToSelf,
				AliveState = 1,
				Location = (_graves.TryGetValue(charId, out value5) ? value5.GetLocation() : Location.Invalid),
				BirthDate = value4.BirthDate
			};
		}
		Logger.Info($"Unable to find character {charId} for creating abridged data.");
		return null;
	}

	public (Dictionary<short, int> Total, Dictionary<short, int> Child, Dictionary<short, int> Adult, Dictionary<short, int> Semi, Dictionary<short, int> Old) CalcCharacterBelongStatDict()
	{
		Dictionary<short, int> dictionary = new Dictionary<short, int>();
		Dictionary<short, int> dictionary2 = new Dictionary<short, int>();
		Dictionary<short, int> dictionary3 = new Dictionary<short, int>();
		Dictionary<short, int> dictionary4 = new Dictionary<short, int>();
		Dictionary<short, int> dictionary5 = new Dictionary<short, int>();
		foreach (Character value in _objects.Values)
		{
			if (value.GetCreatingType() != 1 || value.GetDarkAshProtector() != 0)
			{
				continue;
			}
			short settlementId = value.GetOrganizationInfo().SettlementId;
			if (!dictionary.TryAdd(settlementId, 1))
			{
				dictionary[settlementId]++;
			}
			short actualAge = value.GetActualAge();
			short num = actualAge;
			if (num < 40)
			{
				if (num < 16)
				{
					if (!dictionary2.TryAdd(settlementId, 1))
					{
						dictionary2[settlementId]++;
					}
				}
				else if (!dictionary3.TryAdd(settlementId, 1))
				{
					dictionary3[settlementId]++;
				}
			}
			else if (num < 70)
			{
				if (!dictionary4.TryAdd(settlementId, 1))
				{
					dictionary4[settlementId]++;
				}
			}
			else if (!dictionary5.TryAdd(settlementId, 1))
			{
				dictionary5[settlementId]++;
			}
		}
		return (Total: dictionary, Child: dictionary2, Adult: dictionary3, Semi: dictionary4, Old: dictionary5);
	}

	public Dictionary<short, ((int Exceed, int Total) Adult, (int Exceed, int Total) Semi, (int Exceed, int Total) Old)> CalcExceedPopulations(IRandomSource random, IEnumerable<short> settlementIds, Dictionary<short, int> childs, Dictionary<short, int> adults, Dictionary<short, int> semis, Dictionary<short, int> olds)
	{
		short num = WorldCreation.DefValue.WorldPopulation.InfluenceFactors[DomainManager.World.GetWorldPopulationType()];
		Dictionary<short, ((int, int), (int, int), (int, int))> dictionary = new Dictionary<short, ((int, int), (int, int), (int, int))>();
		foreach (short settlementId in settlementIds)
		{
			childs.TryGetValue(settlementId, out var _);
			adults.TryGetValue(settlementId, out var value2);
			semis.TryGetValue(settlementId, out var value3);
			olds.TryGetValue(settlementId, out var value4);
			Settlement settlement = ((settlementId >= 0) ? DomainManager.Organization.GetSettlement(settlementId) : null);
			if (settlement == null)
			{
				continue;
			}
			int num2 = settlement.OrganizationConfig.PopulationThreshold * random.Next(100, GlobalConfig.Instance.PopulationLimitRandomRateMax) / 100;
			int num3 = value4 + value3 + value2 - num2 * num / 100;
			int num4 = value3 - value2 / 2;
			int num5 = value4 - value2 / 3;
			if (num3 <= 0 && num4 <= 0 && num5 <= 0)
			{
				continue;
			}
			int num6 = value2;
			int num7 = value3 * 3;
			int num8 = value4 * 6;
			int num9 = num6 + num7 + num8;
			if (num9 > 0)
			{
				num6 = num6 * num3 / num9;
				num7 = num7 * num3 / num9;
				num8 = num8 * num3 / num9;
			}
			num6 = Math.Min(num6, value2);
			num7 = Math.Min(Math.Max(num4, num7), value3);
			num8 = Math.Min(Math.Max(num5, num8), value4);
			if ((num6 | num7 | num8) == 0)
			{
				continue;
			}
			short? num10 = settlement?.GetLocation().AreaId;
			if (num10.HasValue)
			{
				short valueOrDefault = num10.GetValueOrDefault();
				if (valueOrDefault >= 0 && valueOrDefault <= 135)
				{
					dictionary[settlementId] = ((num6, value2), (num7, value3), (num8, value4));
				}
			}
		}
		return dictionary;
	}

	public void MarkExceedPopulations(DataContext context, Dictionary<short, ((int Exceed, int Total) Adult, (int Exceed, int Total) Semi, (int Exceed, int Total) Old)> plan)
	{
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		foreach (Character value2 in _objects.Values)
		{
			if (value2.GetCreatingType() != 1 || value2.GetDarkAshProtector() != 0)
			{
				continue;
			}
			short settlementId = value2.GetOrganizationInfo().SettlementId;
			if (!plan.TryGetValue(settlementId, out ((int, int), (int, int), (int, int)) value))
			{
				continue;
			}
			short actualAge = value2.GetActualAge();
			short num = actualAge;
			bool flag;
			if (num < 40)
			{
				if (num < 16)
				{
					continue;
				}
				if (flag = context.Random.Next(value.Item1.Item2--) < value.Item1.Item1)
				{
					value.Item1.Item1--;
				}
			}
			else if (num < 70)
			{
				if (flag = context.Random.Next(value.Item2.Item2--) < value.Item2.Item1)
				{
					value.Item2.Item1--;
				}
			}
			else if (flag = context.Random.Next(value.Item3.Item2--) < value.Item3.Item1)
			{
				value.Item3.Item1--;
			}
			if (flag)
			{
				value2.AddDarkAsh(context, lifeRecordCollection);
			}
			plan[settlementId] = value;
		}
	}

	public void AddDarkAshNotifications()
	{
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		HashSet<int> hashSet = new HashSet<int>();
		GetTaiwuPeople(hashSet);
		foreach (int item in hashSet)
		{
			if (TryGetElement_Objects(item, out var element) && element.ShouldNotifyDarkAshInfected(out var duration))
			{
				monthlyNotificationCollection.AddFamilyGetInfected(item, duration);
			}
		}
		foreach (int followingNpc in DomainManager.Extra.GetFollowingNpcList())
		{
			if (TryGetElement_Objects(followingNpc, out var element2) && element2.ShouldNotifyDarkAshInfected(out var duration2))
			{
				monthlyNotificationCollection.AddFocusedGetInfected(followingNpc, duration2);
			}
		}
	}

	public void PostAdvanceMonthCalcDarkAsh(DataContext context)
	{
		(Dictionary<short, int>, Dictionary<short, int>, Dictionary<short, int>, Dictionary<short, int>, Dictionary<short, int>) tuple = DomainManager.Character.CalcCharacterBelongStatDict();
		Dictionary<short, ((int, int), (int, int), (int, int))> plan = DomainManager.Character.CalcExceedPopulations(context.Random, tuple.Item1.Keys, tuple.Item2, tuple.Item3, tuple.Item4, tuple.Item5);
		DomainManager.Character.MarkExceedPopulations(context, plan);
		AddDarkAshNotifications();
		int currDate = DomainManager.World.GetCurrDate();
		int[] array = DomainManager.Extra.GetAllDarkAshCounterData().ToArray();
		foreach (int num in array)
		{
			if (DomainManager.Extra.TryGetDarkAshCounterData(num, out var data))
			{
				if (data.ExpiredDate2 - currDate <= 0 || !TryGetElement_Objects(num, out var element))
				{
					DomainManager.Extra.RemoveDarkAshCounterData(context, num);
				}
				else if ((element.GetDarkAshProtector() & 0xFFFFFD09u) != 0)
				{
					DomainManager.Extra.SetDarkAshCounterData(context, num, data.OfflineApplyFaithChangeToExtraData(currDate - 1, 1));
				}
			}
		}
	}

	public void MakeCharacterDead(DataContext context, Character character, short deathType)
	{
		CharacterDeathInfo deathInfo = new CharacterDeathInfo(character.GetValidLocation());
		MakeCharacterDead(context, character, deathType, deathInfo);
	}

	public void MakeCharacterDead(DataContext context, Character character, short deathType, CharacterDeathInfo deathInfo)
	{
		Tester.Assert(character.GetCreatingType() == 1);
		Tester.Assert(!IsTemporaryIntelligentCharacter(character.GetId()));
		CharacterDeathTypeItem characterDeathTypeItem = CharacterDeathType.Instance[deathType];
		int id = character.GetId();
		int num = ((deathInfo.DeathDate == int.MinValue) ? DomainManager.World.GetCurrDate() : deathInfo.DeathDate);
		DeadCharacter value = DeadCharacterHelper.CreateDeadCharacter(character, num);
		Logger.Info($"{character} is dead at age {character.GetCurrAge()}.({characterDeathTypeItem.Name}:{deathInfo})");
		if (character.GetHealth() > 0)
		{
			character.SetHealth(0, context);
		}
		int leaderId = character.GetLeaderId();
		Location location = character.GetLocation();
		if (!location.IsValid())
		{
			if ((leaderId < 0 || id == leaderId) && _crossAreaMoveInfos.TryGetValue(leaderId, out var value2))
			{
				location = DomainManager.Map.CrossAreaTravelInfoToLocation(value2);
				GroupMove(context, character, location);
			}
			else
			{
				location = character.GetValidLocation();
				character.SetLocation(location, context);
			}
		}
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		if (DomainManager.Taiwu.IsCharacterFollowedByTaiwu(id))
		{
			if (deathType == 16)
			{
				monthlyNotificationCollection.AddFocusedDieByInfected(id, deathInfo.Location);
			}
			else
			{
				monthlyNotificationCollection.AddDieNotice(id, deathInfo.Location);
			}
		}
		if (characterDeathTypeItem.DefaultMonthlyNotification >= 0 && (!characterDeathTypeItem.NotifyTaiwuPeopleOnly || character.GetOrganizationInfo().OrgTemplateId == 16 || DomainManager.Character.IsTaiwuPeople(id)))
		{
			monthlyNotificationCollection.AddDeathNotification(id, characterDeathTypeItem, ref deathInfo);
		}
		RemoveCrossAreaTravelInfo(context, id);
		if (id == DomainManager.Extra.GetKidnappedTravelData().HunterCharId)
		{
			if (DomainManager.World.GetAdvancingMonthState() == 0)
			{
				DomainManager.TaiwuEvent.OnEvent_TaiwuBeHuntedHunterDie(id);
			}
			else
			{
				MonthlyEventCollection monthlyEventCollection = DomainManager.World.GetMonthlyEventCollection();
				monthlyEventCollection.AddTaiwuBeHuntedHunterDie(id, DomainManager.Taiwu.GetTaiwuCharId());
				DomainManager.World.IsTaiwuHunterDie = true;
			}
		}
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		int dataOffset = secretInformationCollection.AddDie(id, location);
		DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
		RemoveAllKidnappedChars(context, character, isEscaped: true);
		HandleLoveToken(context, character);
		RemoveElement_Objects(id);
		_infectedCharSet.Remove(id);
		if (_pregnantStates.ContainsKey(id))
		{
			RemoveElement_PregnantStates(id, context);
		}
		if (_pregnancyLockEndDates.ContainsKey(id))
		{
			RemoveElement_PregnancyLockEndDates(id, context);
		}
		if (TryGetCharacterPrioritizedAction(id, out var action))
		{
			action.OnCharacterDead(context, character);
			RemoveElement_PrioritizedActions(id, context);
		}
		if (_ongoingVengeances.TryGetValue(id, out var value3))
		{
			value3.Clear();
			RemoveElement_OngoingVengeances(id, context);
		}
		int kidnapperId = character.GetKidnapperId();
		if (kidnapperId >= 0)
		{
			RemoveKidnappedCharacter(context, id, kidnapperId, isEscaped: true);
		}
		if (_debtsToTaiwu.ContainsKey(id))
		{
			RemoveElement_DebtsToTaiwu(id, context);
		}
		if (_avatarElementGrowthProgress.ContainsKey(id))
		{
			RemoveElement_AvatarElementGrowthProgress(id, context);
		}
		HashSet<int> hashSet = ObjectPool<HashSet<int>>.Instance.Get();
		GetClosePeople(context.Random, character, hashSet, 100);
		hashSet.Remove(id);
		foreach (int item in hashSet)
		{
			if (!TryGetRelation(item, id, out var relation) || relation.RelationType == 0)
			{
				continue;
			}
			Character character2 = _objects[item];
			for (sbyte b = 1; b < 17; b++)
			{
				ushort relationType = RelationType.GetRelationType(b);
				if (RelationType.HasRelation(relation.RelationType, relationType))
				{
					GameData.Domains.Character.Ai.PersonalNeed personalNeed = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(25, relationType);
					character2.AddPersonalNeed(context, personalNeed);
				}
			}
		}
		if (leaderId >= 0)
		{
			DomainManager.Character.LeaveGroup(context, character, bringWards: false);
		}
		Events.RaiseIntelligentCharacterDead(context, character, characterDeathTypeItem, ref deathInfo);
		character.OnDeathTransferWugKings(context, location);
		ResetEquippedItemCharId(context, character);
		RemoveNonBuryableItemsInInventory(context, character, location);
		RemoveInfant(id);
		AddElement_DeadCharacters(id, value, context);
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		sbyte advancingMonthState = DomainManager.World.GetAdvancingMonthState();
		if ((advancingMonthState == 0 || advancingMonthState == 20) ? true : false)
		{
			hashSet.Remove(taiwuCharId);
		}
		Character character3 = (characterDeathTypeItem.FindUndertaker ? SelectUndertaker(context, character, hashSet) : null);
		ObjectPool<HashSet<int>>.Instance.Return(hashSet);
		Location randomGraveBlock = DomainManager.Map.GetRandomGraveBlock(context.Random, location);
		if (character3 != null)
		{
			if (character3.GetId() == taiwuCharId)
			{
				MonthlyEventCollection monthlyEventCollection2 = DomainManager.World.GetMonthlyEventCollection();
				monthlyEventCollection2.AddDie(id, location);
				Grave grave = new Grave(context, character, randomGraveBlock, 0);
				AddElement_Graves(id, grave);
				Events.RaiseGraveLocationChanged(context, id, Location.Invalid, grave.GetLocation());
			}
			else
			{
				int resource = character3.GetResource(6);
				sbyte b2 = Grave.CalcGraveLevel(resource);
				if (b2 == 0)
				{
					GameData.Domains.Character.Ai.PersonalNeed personalNeed2 = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(8, 6, GlobalConfig.Instance.GraveLevelMoneyCosts[^1]);
					character3.AddPersonalNeed(context, personalNeed2);
				}
				else
				{
					character3.ChangeResource(context, 6, -GlobalConfig.Instance.GraveLevelMoneyCosts[b2]);
				}
				Grave grave2 = new Grave(context, character, randomGraveBlock, b2);
				AddElement_Graves(id, grave2);
				Events.RaiseGraveLocationChanged(context, id, Location.Invalid, grave2.GetLocation());
				dataOffset = secretInformationCollection.AddBuildGrave(character3.GetId(), id);
				int num2 = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
				LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
				lifeRecordCollection.AddBuildGrave(character3.GetId(), num, id, grave2.GetLocation());
			}
		}
		else
		{
			Grave grave3 = new Grave(context, character, randomGraveBlock, 0);
			AddElement_Graves(id, grave3);
			Events.RaiseGraveLocationChanged(context, id, Location.Invalid, grave3.GetLocation());
		}
		IntPair elementId = new IntPair(num, id);
		AddElement_RecentDeadCharacters(elementId, default(VoidValue), context);
		AddElement_WaitingReincarnationChars(elementId, default(VoidValue), context);
		character.RemoveMerchantType(context);
		RemoveAllGeneralRelations(context, id);
		DomainManager.Extra.RemoveDyingCharacters(context, id);
	}

	[Obsolete]
	public void Die(DataContext context, Character character, bool findUndertaker, int deathDate = int.MinValue)
	{
		MakeCharacterDead(context, character, 0);
	}

	public Character SelectUndertaker(DataContext context, Character character, HashSet<int> closeCharIds)
	{
		if (closeCharIds.Count == 0)
		{
			return null;
		}
		int id = character.GetId();
		int factionId = character.GetFactionId();
		sbyte b = character.GetFameType();
		if (b == -2)
		{
			b = (sbyte)(context.Random.NextBool() ? 4 : 2);
		}
		int num = 0;
		Character character2 = null;
		CharacterMatcherItem canBeUndertaker = CharacterMatcher.DefValue.CanBeUndertaker;
		foreach (int closeCharId in closeCharIds)
		{
			Character character3 = _objects[closeCharId];
			if (!canBeUndertaker.Match(character3))
			{
				continue;
			}
			int num2 = Grave.CalcGraveLevel(character3.GetResource(6));
			if (TryGetRelation(closeCharId, id, out var relation))
			{
				sbyte favorabilityType = FavorabilityType.GetFavorabilityType(relation.Favorability);
				num2 += ((favorabilityType >= 2) ? (favorabilityType - 2) : 0);
				ushort relationType = relation.RelationType;
				if (RelationType.HasRelation(relationType, 1024) || RelationType.ContainParentRelations(relationType) || RelationType.ContainChildRelations(relationType))
				{
					num2 += 5;
				}
				else if (RelationType.ContainBrotherOrSisterRelations(relationType) || RelationType.HasRelation(relationType, 16384) || RelationType.HasRelation(relationType, 512))
				{
					num2 += 4;
				}
				else if (RelationType.HasRelation(relationType, 2048))
				{
					num2 += 3;
				}
				else if (RelationType.HasRelation(relationType, 8192))
				{
					num2 += 2;
				}
				else if (factionId >= 0 && character3.GetFactionId() == factionId)
				{
					num2++;
				}
			}
			else if (factionId >= 0 && character3.GetFactionId() == factionId)
			{
				num2++;
			}
			switch (character3.GetBehaviorType())
			{
			case 0:
			{
				sbyte b2 = character3.GetFameType();
				if (b2 == -2)
				{
					b2 = (sbyte)(context.Random.NextBool() ? 4 : 2);
				}
				num2 = ((!FameType.IsSameSide(b, b2)) ? (num2 - 2) : (num2 + 2));
				break;
			}
			case 1:
				num2 += 4;
				break;
			case 3:
				num2 += context.Random.Next(-5, 6);
				break;
			case 4:
				num2 -= 4;
				break;
			}
			if (num2 > num)
			{
				num = num2;
				character2 = character3;
			}
			else if (num2 == num && character2 != null && closeCharId > character2.GetId())
			{
				num = num2;
				character2 = character3;
			}
		}
		return character2;
	}

	public void TryRemoveRecentDeadCharacters(DataContext context)
	{
		int num = DomainManager.World.GetCurrDate() - 12;
		List<IntPair> list = new List<IntPair>();
		foreach (KeyValuePair<IntPair, VoidValue> recentDeadCharacter in _recentDeadCharacters)
		{
			IntPair key = recentDeadCharacter.Key;
			int first = key.First;
			if (first < num)
			{
				int second = key.Second;
				DomainManager.LifeRecord.Remove(second);
				list.Add(key);
			}
		}
		Logger.Info($"Removing recent dead characters life records {list.Count}/{_recentDeadCharacters.Count}");
		int i = 0;
		for (int count = list.Count; i < count; i++)
		{
			RemoveElement_RecentDeadCharacters(list[i], context);
		}
	}

	public void TryRemoveDeadCharacters(DataContext context)
	{
		int num = DomainManager.World.GetCurrDate() - 120;
		List<int> list = new List<int>();
		List<int> previousTaiwuIds = DomainManager.Taiwu.GetPreviousTaiwuIds();
		foreach (KeyValuePair<int, DeadCharacter> deadCharacter in _deadCharacters)
		{
			int key = deadCharacter.Key;
			DeadCharacter value = deadCharacter.Value;
			if (value.DeathDate < num && _deadCharDeletionStates.TryGetValue(key, out var value2) && value2.GraveRemoved && value2.DeletedFromOthersPreexistence && !previousTaiwuIds.Contains(key))
			{
				list.Add(key);
			}
		}
		Logger.Info($"Removing dead characters: {list.Count}/{_deadCharacters.Count}");
		int i = 0;
		for (int count = list.Count; i < count; i++)
		{
			int num2 = list[i];
			DomainManager.Extra.RemoveCharacterCustomDisplayName(context, num2);
			DomainManager.Extra.RemoveSecretInformationShopCharacterData(context, num2);
			RemoveElement_DeadCharacters(num2, context);
			RemoveElement_DeadCharDeletionStates(num2, context);
			RemoveAllRelations(context, num2, removeRelatedRelations: false);
			DomainManager.Extra.RemoveInteractedCharacter(context, num2);
		}
	}

	public unsafe void RecordDeletedFromOthersPreexistence(DataContext context, ref PreexistenceCharIds preexistenceCharIds)
	{
		int i = 0;
		for (int count = preexistenceCharIds.Count; i < count; i++)
		{
			int num = preexistenceCharIds.CharIds[i];
			if (_deadCharDeletionStates.TryGetValue(num, out var value))
			{
				value.DeletedFromOthersPreexistence = true;
				SetElement_DeadCharDeletionStates(num, value, context);
			}
			else
			{
				value.DeletedFromOthersPreexistence = true;
				AddElement_DeadCharDeletionStates(num, value, context);
			}
		}
	}

	public void UpdateIntelligentCharacterAliveStates(DataContext context)
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		List<Character> list = ObjectPool<List<Character>>.Instance.Get();
		List<MapBlockData> list2 = ObjectPool<List<MapBlockData>>.Instance.Get();
		list2.Add(null);
		int currDate = DomainManager.World.GetCurrDate();
		foreach (var (num2, character2) in _objects)
		{
			if (character2.GetDarkAshProtector() == 32 && DomainManager.Extra.GetCharacterTemporaryFeaturesExpireDate(new IntPair(num2, 758)) <= currDate)
			{
				if (character2.GetCreatingType() == 1)
				{
					list.Add(character2);
					DomainManager.Extra.AddDyingCharacters(context, character2.GetId(), 16);
					continue;
				}
				AdaptableLog.TagWarning("DarkAsh", "character {character} is not IntelligentCharacter thus won't die with DarkAsh");
			}
			if (character2.GetHealth() > 0)
			{
				DomainManager.Extra.RemoveDyingCharacters(context, num2);
			}
			else
			{
				if (character2.GetCreatingType() != 1 || _temporaryIntelligentCharIds.Contains(num2) || character2.GetFeatureIds().Contains(337) || (character2.GetLocation().AreaId == 137 && character2.Template.CreatingType == 0))
				{
					continue;
				}
				if (DomainManager.Extra.IsCharacterDying(num2))
				{
					if (num2 == taiwuCharId)
					{
						DomainManager.World.SetTaiwuDying();
					}
					else
					{
						list.Add(character2);
					}
				}
				else
				{
					DomainManager.Extra.AddDyingCharacters(context, num2, -1);
				}
			}
		}
		foreach (Character item in list)
		{
			int id = item.GetId();
			short enemyTemplateId = (short)Math.Clamp(298 + item.GetConsummateLevel() / 2, 298, 306);
			if (DomainManager.Extra.TryGetCharacterDyingType(id, out var type))
			{
				DomainManager.Character.MakeCharacterDead(context, item, type);
				if (type == 16 && DomainManager.Character.TryGetElement_Graves(id, out var element) && element.GetLocation().IsValid())
				{
					list2[0] = DomainManager.Map.GetBlock(element.GetLocation());
					DomainManager.Adventure.CreateTemporaryEnemiesOnValidBlocks(context, Location.Invalid, enemyTemplateId, 1, list2);
				}
			}
			else
			{
				short kidnappingEnemyNestAdventure = item.GetKidnappingEnemyNestAdventure();
				if (kidnappingEnemyNestAdventure < 0)
				{
					DomainManager.Character.MakeCharacterDead(context, item, (short)((item.GetLeftMaxHealth() <= 0) ? 1 : 2));
					continue;
				}
				DomainManager.Character.MakeCharacterDead(context, item, 5, new CharacterDeathInfo(item.GetValidLocation())
				{
					AdventureId = kidnappingEnemyNestAdventure
				});
			}
		}
		ObjectPool<List<Character>>.Instance.Return(list);
		ObjectPool<List<MapBlockData>>.Instance.Return(list2);
	}

	public void PrepareTaiwuInheritor(DataContext context, Character inheritor, Character taiwu)
	{
		int id = inheritor.GetId();
		List<LifeSkillItem> learnedLifeSkills = inheritor.GetLearnedLifeSkills();
		learnedLifeSkills.Clear();
		inheritor.SetLearnedLifeSkills(learnedLifeSkills, context);
		DomainManager.SpecialEffect.RemoveAllEquippedSkillEffects(context, inheritor);
		DomainManager.SpecialEffect.RemoveAllBrokenSkillEffects(context, inheritor);
		DomainManager.Character.UnequipAllCombatSkills(context, id);
		inheritor.SetLoopingNeigong(-1, context);
		inheritor.ResetBaseNeiliAllocation(context);
		short[] combatSkillAttainmentPanels = inheritor.GetCombatSkillAttainmentPanels();
		CombatSkillAttainmentPanelsHelper.Initialize(combatSkillAttainmentPanels);
		inheritor.SetCombatSkillAttainmentPanels(combatSkillAttainmentPanels, context);
		List<short> learnedCombatSkills = inheritor.GetLearnedCombatSkills();
		learnedCombatSkills.Clear();
		inheritor.SetLearnedCombatSkills(learnedCombatSkills, context);
		DomainManager.Extra.RemoveCharacterEquippedCombatSkills(context, id);
		DomainManager.Extra.RemoveCharacterCombatSkillConfiguration(context, id);
		DomainManager.CombatSkill.RemoveAllCombatSkills(id);
		inheritor.SetLovingItemRevealed(lovingItemRevealed: true, context);
		inheritor.SetHatingItemRevealed(hatingItemRevealed: true, context);
		inheritor.RemoveFeatureGroup(context, 204);
		List<short> featureIds = inheritor.GetFeatureIds();
		for (sbyte b = 0; b < 14; b++)
		{
			CombatSkillTypeItem combatSkillTypeItem = Config.CombatSkillType.Instance[b];
			featureIds.Remove(combatSkillTypeItem.LegendaryBookFeature);
		}
		inheritor.SetFeatureIds(featureIds, context);
		ClearDebtsToTaiwu(context);
		int kidnapperId = inheritor.GetKidnapperId();
		if (kidnapperId >= 0)
		{
			RemoveKidnappedCharacter(context, id, kidnapperId, isEscaped: true);
		}
		if (taiwu != null)
		{
			DomainManager.Character.DirectlySetFavorabilities(context, taiwu.GetId(), id, 30000, 30000);
		}
	}

	public void TestAddPregnantState(DataContext context, Character mother, Character father)
	{
		PregnantState value = new PregnantState(mother, father, isRaped: false);
		AddElement_PregnantStates(mother.GetId(), value, context);
	}

	public void GetTaiwuVillageDeadCharacter(HashSet<int> resultSet)
	{
		foreach (var (item, deadCharacter2) in _deadCharacters)
		{
			if (deadCharacter2.OrganizationInfo.OrgTemplateId == 16)
			{
				resultSet.Add(item);
			}
		}
	}

	private void RemoveNonBuryableItemsInInventory(DataContext context, Character character, Location location)
	{
		List<ItemKey> list = ObjectPool<List<ItemKey>>.Instance.Get();
		List<MapBlockData> list2 = ObjectPool<List<MapBlockData>>.Instance.Get();
		DomainManager.Map.GetRealNeighborBlocks(location.AreaId, location.BlockId, list2, 2, includeCenter: true);
		list.Clear();
		Inventory inventory = character.GetInventory();
		int id = character.GetId();
		foreach (var (itemKey2, _) in inventory.Items)
		{
			if (itemKey2.ItemType == 11)
			{
				MapBlockData block = list2[context.Random.Next(list2.Count)];
				DomainManager.Item.RemoveOwner(itemKey2, ItemOwnerType.CharacterInventory, id);
				DomainManager.Map.AddBlockItem(context, block, itemKey2, 1);
				list.Add(itemKey2);
			}
			else if (itemKey2.ItemType == 4 && ItemTemplateHelper.GetResourceType(itemKey2.ItemType, itemKey2.TemplateId) == 0)
			{
				MapBlockData block2 = list2[context.Random.Next(list2.Count)];
				DomainManager.Item.RemoveOwner(itemKey2, ItemOwnerType.CharacterInventory, id);
				DomainManager.Map.AddBlockItem(context, block2, itemKey2, 1);
				list.Add(itemKey2);
			}
			else if (!ItemDomain.CanItemBeLost(itemKey2))
			{
				DomainManager.Item.RemoveItem(context, itemKey2);
				list.Add(itemKey2);
			}
		}
		foreach (ItemKey item in list)
		{
			inventory.OfflineRemove(item);
		}
		ObjectPool<List<ItemKey>>.Instance.Return(list);
		ObjectPool<List<MapBlockData>>.Instance.Return(list2);
	}

	private void ResetEquippedItemCharId(DataContext context, Character character)
	{
		ItemKey[] equipment = character.GetEquipment();
		for (int i = 0; i < equipment.Length; i++)
		{
			ItemKey itemKey = equipment[i];
			if (itemKey.IsValid())
			{
				EquipmentBase baseEquipment = DomainManager.Item.GetBaseEquipment(itemKey);
				baseEquipment.SetEquippedCharId(-1, context);
			}
		}
	}

	private void HandleLoveToken(DataContext context, Character character)
	{
		if (!InteractOfLove.IsInstalled())
		{
			return;
		}
		int id = character.GetId();
		bool flag = DomainManager.Taiwu.IsInGroup(id);
		bool flag2 = DomainManager.Extra.IsTaiwuLover(id);
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		bool flag3 = character.GetKidnapperId() == taiwu.GetId();
		List<ItemKey> list = ObjectPool<List<ItemKey>>.Instance.Get();
		foreach (var (item, _) in character.GetInventory().Items)
		{
			if (ModificationStateHelper.IsActive(item.ModificationState, 4))
			{
				list.Add(item);
			}
		}
		if (flag2 && (flag || flag3))
		{
			foreach (ItemKey item2 in list)
			{
				DomainManager.Character.TransferInventoryItem(context, character, taiwu, item2, 1);
				InteractOfLove.SetLoveTokenHolder(context, item2, taiwu.GetId());
			}
		}
		else
		{
			foreach (ItemKey item3 in list)
			{
				DomainManager.Extra.RemoveLoveTokenData(context, item3);
			}
		}
		ObjectPool<List<ItemKey>>.Instance.Return(list);
	}

	private void RecordGraveRemoved(DataContext context, int charId)
	{
		if (_deadCharDeletionStates.TryGetValue(charId, out var value))
		{
			value.GraveRemoved = true;
			SetElement_DeadCharDeletionStates(charId, value, context);
		}
		else
		{
			value.GraveRemoved = true;
			AddElement_DeadCharDeletionStates(charId, value, context);
		}
	}

	public void GetAllWaitingReincarnationCharIds(HashSet<int> charIds)
	{
		charIds.Clear();
		foreach (IntPair item in _waitingReincarnationChars.Collection)
		{
			charIds.Add(item.Second);
		}
	}

	private int PickReincarnationChar(DataContext context, int birthDate, int presetReincarnationCharId = -1, bool disableSavedSoul = false)
	{
		if (presetReincarnationCharId == -2)
		{
			return -1;
		}
		SortedSet<IntPair> collection = _waitingReincarnationChars.Collection;
		if (collection.Count <= 0)
		{
			if (context.Random.CheckPercentProb(GlobalConfig.Instance.AnimalSamsaraChance))
			{
				return CreateDeadAnimal(context, birthDate - 7);
			}
			return -1;
		}
		IntPair elementId = collection.Min;
		int num = -1;
		ProfessionData professionData = DomainManager.Extra.GetProfessionData(6);
		BuddhistMonkSkillsData skillsData = professionData.GetSkillsData<BuddhistMonkSkillsData>();
		if (presetReincarnationCharId >= 0)
		{
			foreach (IntPair item in collection)
			{
				if (item.Second != presetReincarnationCharId)
				{
					continue;
				}
				elementId = item;
				num = item.Second;
				break;
			}
		}
		else
		{
			if (context.Random.CheckPercentProb(GlobalConfig.Instance.AnimalSamsaraChance))
			{
				return CreateDeadAnimal(context, birthDate - 7);
			}
			foreach (IntPair item2 in collection)
			{
				int second = item2.Second;
				if (item2.First + 7 > birthDate)
				{
					return -1;
				}
				if (DomainManager.Building.IsCharOnSamsaraPlatform(second) || skillsData.IsDirectedSamsaraCharacter(second) || (DomainManager.Extra.IsSavedSoul(second) && disableSavedSoul))
				{
					continue;
				}
				elementId = item2;
				num = second;
				break;
			}
		}
		if (num < 0)
		{
			return -1;
		}
		RemoveElement_WaitingReincarnationChars(elementId, context);
		return num;
	}

	private int CreateDeadAnimal(DataContext context, int deathDate)
	{
		int num = GenerateNextObjectId(context);
		short random = GameData.Domains.Map.SharedConstValue.AnimalCharIdGroups.GetRandom(context.Random).GetRandom(context.Random);
		DeadCharacter deadCharacter = DeadCharacterHelper.CreateDeadCharacter(context.Random, random, deathDate);
		deadCharacter.FeatureIds.Clear();
		deadCharacter.FeatureIds.AddRange(Config.Character.Instance[random].FeatureIds);
		AddElement_DeadCharacters(num, deadCharacter, context);
		return num;
	}

	[DomainMethod]
	public Debts GetDebts(int targetCharId)
	{
		Debts value;
		return _debtsToTaiwu.TryGetValue(targetCharId, out value) ? value : null;
	}

	public void DirectlyAddDebt(DataContext context, int targetCharId, long worth, bool isEquivalent)
	{
		Debts debts = DomainManager.Character.GetDebts(targetCharId);
		if (debts == null)
		{
			debts = new Debts();
			if (isEquivalent)
			{
				debts.LendEquivalentToTaiwu(worth);
			}
			else
			{
				debts.LendNonequivalentToTaiwu(worth);
			}
			DomainManager.Character.AddElement_DebtsToTaiwu(targetCharId, debts, context);
		}
		else
		{
			if (isEquivalent)
			{
				debts.LendEquivalentToTaiwu(worth);
			}
			else
			{
				debts.LendNonequivalentToTaiwu(worth);
			}
			SetElement_DebtsToTaiwu(targetCharId, debts, context);
		}
	}

	public void DirectlyReduceDebt(DataContext context, int targetCharId, long worth, bool isEquivalent)
	{
		Debts debts = DomainManager.Character.GetDebts(targetCharId);
		if (debts != null)
		{
			if (isEquivalent)
			{
				debts.BorrowEquivalentFromTaiwu(worth);
			}
			else
			{
				debts.BorrowNonequivalentFromTaiwu(worth);
			}
			SetElement_DebtsToTaiwu(targetCharId, debts, context);
		}
	}

	public void LendResourceToTaiwu(DataContext context, Character character, long worth)
	{
		int id = character.GetId();
		if (!_debtsToTaiwu.TryGetValue(id, out var value))
		{
			value = new Debts();
			value.LendEquivalentToTaiwu(worth);
			AddElement_DebtsToTaiwu(id, value, context);
		}
		else
		{
			value.LendEquivalentToTaiwu(worth);
			SetElement_DebtsToTaiwu(id, value, context);
		}
	}

	public void BorrowResourceFromTaiwu(DataContext context, Character character, long worth)
	{
		int id = character.GetId();
		if (!_debtsToTaiwu.TryGetValue(id, out var value))
		{
			value = new Debts();
			value.BorrowEquivalentFromTaiwu(worth);
			AddElement_DebtsToTaiwu(id, value, context);
		}
		else
		{
			value.BorrowEquivalentFromTaiwu(worth);
			SetElement_DebtsToTaiwu(id, value, context);
		}
	}

	public void LendItemToTaiwu(DataContext context, Character character, ItemKey itemKey, int amount)
	{
		int id = character.GetId();
		long num = Debts.ItemToWorth(itemKey.ItemType, itemKey.TemplateId);
		if (num != 0)
		{
			if (!_debtsToTaiwu.TryGetValue(id, out var value))
			{
				value = new Debts();
				value.LendNonequivalentToTaiwu(num, amount);
				AddElement_DebtsToTaiwu(id, value, context);
			}
			else
			{
				value.LendNonequivalentToTaiwu(num, amount);
				SetElement_DebtsToTaiwu(id, value, context);
			}
		}
	}

	public void LendItemListToTaiwu(DataContext context, Character character, List<ItemKey> keyList)
	{
		Tester.Assert(keyList != null);
		foreach (ItemKey key in keyList)
		{
			LendItemToTaiwu(context, character, key, 1);
		}
	}

	public void BorrowItemFromTaiwu(DataContext context, Character character, ItemKey itemKey, int amount)
	{
		int id = character.GetId();
		ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey);
		long num = Debts.ItemToWorth(itemKey.ItemType, itemKey.TemplateId);
		if (num != 0)
		{
			if (!_debtsToTaiwu.TryGetValue(id, out var value))
			{
				value = new Debts();
				value.BorrowNonequivalentFromTaiwu(num, amount);
				AddElement_DebtsToTaiwu(id, value, context);
			}
			else
			{
				value.BorrowNonequivalentFromTaiwu(num, amount);
				SetElement_DebtsToTaiwu(id, value, context);
			}
		}
	}

	public void BorrowItemListFromTaiwu(DataContext context, Character character, List<ItemKey> keyList)
	{
		Tester.Assert(keyList != null);
		Tester.Assert(keyList.Count > 0);
		foreach (ItemKey key in keyList)
		{
			BorrowItemFromTaiwu(context, character, key, 1);
		}
	}

	public short CalcMaxFavorabilityToTaiwu(Character character)
	{
		if (!_debtsToTaiwu.TryGetValue(character.GetId(), out var value))
		{
			return 30000;
		}
		int num = CalcMaxFavorabilityDecrementToTaiwu(character, value);
		return (short)Math.Max(30000 - num, -30000);
	}

	[DomainMethod]
	public short CalcMaxFavorabilityToTaiwuById(int charId)
	{
		if (TryGetElement_Objects(charId, out var element))
		{
			if (!_debtsToTaiwu.TryGetValue(element.GetId(), out var value))
			{
				return 30000;
			}
			return value.GetMaxFavorabilityWithDebt();
		}
		return 30000;
	}

	[DomainMethod]
	public long GetMaxWorthCanBeLentToTaiwu(int charId)
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		if (charId == taiwuCharId)
		{
			return 0L;
		}
		RelationKey key = new RelationKey(charId, taiwuCharId);
		if (!_relations.TryGetValue(key, out var value))
		{
			return 0L;
		}
		short favorability = value.Favorability;
		int num = favorability - GlobalConfig.Instance.MinFavorabilityAfterTransferring;
		if (num <= 0)
		{
			return 0L;
		}
		Character character = _objects[charId];
		short num2 = CalcMaxFavorabilityToTaiwu(character);
		int num3 = num2 - GlobalConfig.Instance.MinFavorabilityAfterTransferring;
		if (num3 <= 0)
		{
			return 0L;
		}
		long val = (long)num * 10L;
		long val2 = (long)num3 * 10L;
		return Math.Min(val, val2);
	}

	[DomainMethod]
	public (sbyte debtChangeType, short favorLevelChangeType) CheckDebtChange(int charId, ResourceInts resources)
	{
		Debts src = GetDebts(charId);
		if (src != null)
		{
			GameData.Serializer.Serializer.CopyTo(ref src, ref _tmpDebts);
		}
		else
		{
			_tmpDebts.Clear();
		}
		for (sbyte b = 0; b < 8; b++)
		{
			int num = resources.Get(b);
			long num2 = Debts.ResourceAmountToWorth(b, Math.Abs(num));
			if (num2 > 0)
			{
				if (num > 0)
				{
					_tmpDebts.BorrowEquivalentFromTaiwu(num2);
				}
				else
				{
					_tmpDebts.LendEquivalentToTaiwu(num2);
				}
			}
		}
		long num3 = src?.Equivalent ?? 0;
		long equivalent = _tmpDebts.Equivalent;
		int num4 = 0;
		(long positiveWorth, long negativeWorth) resourcesWorth = GetResourcesWorth(ref resources);
		long item = resourcesWorth.positiveWorth;
		long item2 = resourcesWorth.negativeWorth;
		bool flag = item > item2;
		long value = Math.Abs(item - item2);
		int num5 = AiHelper.GeneralActionConstants.GetResourceFavorabilityChange(6, (int)Math.Clamp(value, 0L, 2147483647L));
		if (!flag)
		{
			num5 = -num5;
		}
		num4 += num5;
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		short favorability = GetFavorability(charId, taiwuCharId);
		short item3 = (short)Math.Clamp(favorability + num4, -30000, _tmpDebts.GetMaxFavorabilityWithDebt());
		if (equivalent > num3)
		{
			return (debtChangeType: 0, favorLevelChangeType: item3);
		}
		if (equivalent < num3 && equivalent < 0)
		{
			return (debtChangeType: 4, favorLevelChangeType: item3);
		}
		if (equivalent == num3)
		{
			return (debtChangeType: 1, favorLevelChangeType: item3);
		}
		if (equivalent == 0)
		{
			return (debtChangeType: 3, favorLevelChangeType: item3);
		}
		return (debtChangeType: 2, favorLevelChangeType: item3);
	}

	[DomainMethod]
	public bool CheckFavorabilityBeforeTransferring(int charId, ResourceInts resources)
	{
		Character character = _objects[charId];
		sbyte grade = character.GetOrganizationInfo().Grade;
		short num = GlobalConfig.Instance.WorthFactorsOfGrade[grade];
		sbyte behaviorType = character.GetBehaviorType();
		short num2 = FavorIncrementPercentsOfDebt[behaviorType];
		short num3 = FavorDecrementPercentsOfDebt[behaviorType];
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		RelationKey key = new RelationKey(charId, taiwuCharId);
		int favorability = _relations[key].Favorability;
		int num6;
		long num4;
		if (_debtsToTaiwu.TryGetValue(character.GetId(), out var value))
		{
			num4 = value.GetTotalWorthLentToTaiwu();
			int num5 = (int)Math.Clamp(num4 / num, -2147483648L, 2147483647L);
			num6 = Math.Max(30000 - num5, -30000);
		}
		else
		{
			num4 = 0L;
			num6 = 30000;
		}
		(long positiveWorth, long negativeWorth) resourcesWorth = GetResourcesWorth(ref resources);
		long item = resourcesWorth.positiveWorth;
		long item2 = resourcesWorth.negativeWorth;
		long num7 = item / num * num2 / 100;
		long num8 = item2 / num * num3 / 100;
		short num9 = (short)Math.Clamp(favorability + num7 - num8, -30000L, 30000L);
		if (num9 < favorability && num9 < GlobalConfig.Instance.MinFavorabilityAfterTransferring)
		{
			return false;
		}
		num4 += item2 - item;
		if (num4 > 0)
		{
			int num10 = (int)Math.Clamp(num4 / num, -2147483648L, 2147483647L);
			int num11 = Math.Max(30000 - num10, -30000);
			if (num11 < num6 && num11 < GlobalConfig.Instance.MinFavorabilityAfterTransferring)
			{
				return false;
			}
		}
		return true;
	}

	public bool CheckFavorabilityAfterTransferring(Character character, short oriFavor, short oriMaxFavor)
	{
		var (num, num2) = GetFavorAndMaxFavorToTaiwu(character);
		if (num < oriFavor && num < GlobalConfig.Instance.MinFavorabilityAfterTransferring)
		{
			return false;
		}
		if (num2 < oriMaxFavor && num2 < GlobalConfig.Instance.MinFavorabilityAfterTransferring)
		{
			return false;
		}
		return true;
	}

	private static int CalcMaxFavorabilityDecrementToTaiwu(Character character, Debts debts)
	{
		long totalWorthLentToTaiwu = debts.GetTotalWorthLentToTaiwu();
		long value = totalWorthLentToTaiwu / 10;
		return (int)Math.Clamp(value, -2147483648L, 2147483647L);
	}

	private (short favor, short maxFavor) GetFavorAndMaxFavorToTaiwu(Character character)
	{
		int id = character.GetId();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		RelationKey key = new RelationKey(id, taiwuCharId);
		short favorability = _relations[key].Favorability;
		short item = CalcMaxFavorabilityToTaiwu(character);
		return (favor: favorability, maxFavor: item);
	}

	[DomainMethod]
	public short GetClothingDisplayId(int charId)
	{
		if (_objects.TryGetValue(charId, out var value))
		{
			return value.GetClothingDisplayId();
		}
		if (_deadCharacters.TryGetValue(charId, out var value2))
		{
			return value2.ClothingDisplayId;
		}
		return 0;
	}

	[DomainMethod]
	public List<CharacterDisplayData> GetCharacterDisplayDataList(List<int> charIdList)
	{
		List<CharacterDisplayData> list = new List<CharacterDisplayData>();
		if (charIdList == null)
		{
			return list;
		}
		foreach (int charId in charIdList)
		{
			CharacterDisplayData characterDisplayData = GetCharacterDisplayData(charId);
			list.Add(characterDisplayData);
		}
		return list;
	}

	[DomainMethod]
	public List<AvatarRelatedData> GetAvatarRelatedDataList(List<int> charIdList)
	{
		List<AvatarRelatedData> list = new List<AvatarRelatedData>();
		for (int i = 0; i < charIdList.Count; i++)
		{
			list.Add(GetElement_Objects(charIdList[i]).GenerateAvatarRelatedData());
		}
		return list;
	}

	[DomainMethod]
	public AvatarRelatedData GetAvatarRelatedData(int charId)
	{
		return GetElement_Objects(charId).GenerateAvatarRelatedData();
	}

	[DomainMethod]
	public List<short> GetCharacterLifeSkillAttainmentList(List<int> charIdList, sbyte lifeSkillType)
	{
		List<short> list = new List<short>();
		if (charIdList != null)
		{
			foreach (int charId in charIdList)
			{
				list.Add(_objects[charId].GetLifeSkillAttainment(lifeSkillType));
			}
		}
		return list;
	}

	private CharacterDisplayData GetCharacterDisplayDataWithPotentialSuccessor(int charId, bool calcSuccessor)
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		CharacterDisplayData characterDisplayData;
		if (_objects.ContainsKey(charId))
		{
			Character element_Objects = GetElement_Objects(charId);
			OrganizationInfo organizationInfo = element_Objects.GetOrganizationInfo();
			bool completelyInfected = element_Objects.IsCompletelyInfected();
			characterDisplayData = new CharacterDisplayData
			{
				CharacterId = charId,
				TemplateId = element_Objects.GetTemplateId(),
				CreatingType = element_Objects.GetCreatingType(),
				Gender = element_Objects.GetGender(),
				FullName = element_Objects.GetFullName(),
				MonkType = element_Objects.GetMonkType(),
				MonasticTitle = element_Objects.GetMonasticTitle(),
				AvatarRelatedData = element_Objects.GenerateAvatarRelatedData(),
				PhysiologicalAge = element_Objects.GetPhysiologicalAge(),
				CurrAge = element_Objects.GetCurrAge(),
				OrgInfo = organizationInfo,
				BehaviorType = element_Objects.GetBehaviorType(),
				FameType = element_Objects.GetFameType(),
				FavorabilityToTaiwu = GetFavorability(charId, taiwuCharId),
				TitleIds = new List<short>(),
				CompletelyInfected = completelyInfected,
				ValidKidnapSlotCount = (byte)element_Objects.GetKidnapMaxSlotCount(),
				AliveState = 0,
				Location = element_Objects.GetLocation(),
				BirthDate = element_Objects.GetBirthDate(),
				ExternalRelationState = element_Objects.GetExternalRelationState(),
				LegendaryBookOwnerState = element_Objects.GetLegendaryBookOwnerState(),
				CustomDisplayNameId = DomainManager.Extra.GetCharacterCustomDisplayName(charId),
				CanNotSpeak = element_Objects.CanNotSpeak,
				IsFollowedByTaiwu = DomainManager.Taiwu.IsCharacterFollowedByTaiwu(charId),
				NickNameId = DomainManager.Taiwu.GetFollowingNpcNickNameId(charId),
				ExtraNameTextTemplateId = element_Objects.GetExtraNameTextTemplateId(),
				IdealSect = element_Objects.GetIdealSect(),
				DarkAshProtector = element_Objects.GetDarkAshProtector(),
				DarkAshCounter = element_Objects.GetDarkAshCounter(),
				Happiness = element_Objects.GetHappiness()
			};
			if (calcSuccessor && element_Objects.GetOrganizationInfo().SettlementId >= 0 && DomainManager.Organization.TryGetSettlementCharacter(charId, out var settlementChar))
			{
				characterDisplayData.IsApproveTaiwu = settlementChar.GetApprovedTaiwu();
				characterDisplayData.ApproveTaiwu = settlementChar.GetApprovingRate();
				characterDisplayData.InfluencePower = settlementChar.GetInfluencePower();
				short settlementId = settlementChar.GetSettlementId();
				SettlementTreasury treasury = DomainManager.Organization.GetTreasury(element_Objects.GetOrganizationInfo());
				characterDisplayData.Contribution = treasury.GetMemberContribution(element_Objects);
				characterDisplayData.ContributionPerMonth = element_Objects.GetContributionPerMonth();
				characterDisplayData.SettlementTreasuryGuardInfo = DomainManager.Organization.CharacterTreasuryGuardInfo(charId);
				if (settlementId >= 0)
				{
					Settlement settlement = DomainManager.Organization.GetSettlement(settlementId);
					ObjectPool<List<int>> instance = ObjectPool<List<int>>.Instance;
					List<int> list = instance.Get();
					OrganizationInfo orgInfo = organizationInfo;
					orgInfo.SettlementId = settlementId;
					list.Clear();
					settlement.GetOrganizationMemberPotentialSuccessorsForDisplay(charId, orgInfo, list);
					if (list.Count > 0)
					{
						characterDisplayData.OrganizationMemberPotentialSuccessor = GetCharacterDisplayDataWithPotentialSuccessor(list[0], calcSuccessor: false);
					}
					instance.Return(list);
				}
			}
			element_Objects.GetTitles(characterDisplayData.TitleIds);
			characterDisplayData.BountyPunishmentSeverity = -1;
			sbyte sectOrgTemplateId;
			SettlementBounty bounty = DomainManager.Organization.GetBounty(charId, out sectOrgTemplateId);
			if (bounty != null)
			{
				characterDisplayData.BountyPunishmentSeverity = bounty.PunishmentSeverity;
				characterDisplayData.BountyOrgTemplate = sectOrgTemplateId;
			}
		}
		else if (_deadCharacters.ContainsKey(charId))
		{
			DeadCharacter deadCharacter = _deadCharacters[charId];
			characterDisplayData = new CharacterDisplayData
			{
				CharacterId = charId,
				TemplateId = deadCharacter.TemplateId,
				Gender = deadCharacter.Gender,
				CurrAge = deadCharacter.CurrAge,
				FullName = deadCharacter.FullName,
				MonkType = deadCharacter.MonkType,
				MonasticTitle = deadCharacter.MonasticTitle,
				AvatarRelatedData = deadCharacter.GenerateAvatarRelatedData(),
				OrgInfo = deadCharacter.OrganizationInfo,
				BehaviorType = BehaviorType.GetBehaviorType(deadCharacter.Morality),
				FameType = deadCharacter.FameType,
				FavorabilityToTaiwu = GetFavorability(charId, taiwuCharId),
				AliveState = 1,
				Location = (_graves.TryGetValue(charId, out var value) ? value.GetLocation() : Location.Invalid),
				BirthDate = deadCharacter.BirthDate,
				CustomDisplayNameId = DomainManager.Extra.GetCharacterCustomDisplayName(charId),
				IsFollowedByTaiwu = DomainManager.Taiwu.IsCharacterFollowedByTaiwu(charId),
				NickNameId = DomainManager.Taiwu.GetFollowingNpcNickNameId(charId),
				ExtraNameTextTemplateId = -1,
				IdealSect = -1
			};
		}
		else
		{
			characterDisplayData = new CharacterDisplayData
			{
				CharacterId = charId,
				AliveState = 2,
				Location = Location.Invalid,
				AvatarRelatedData = new AvatarRelatedData(),
				IsFollowedByTaiwu = DomainManager.Taiwu.IsCharacterFollowedByTaiwu(charId),
				NickNameId = DomainManager.Taiwu.GetFollowingNpcNickNameId(charId),
				IdealSect = -1
			};
			characterDisplayData.AvatarRelatedData.AvatarData = new AvatarData();
		}
		return characterDisplayData;
	}

	[DomainMethod]
	public CharacterDisplayData GetCharacterDisplayData(int charId)
	{
		return GetCharacterDisplayDataWithPotentialSuccessor(charId, calcSuccessor: true);
	}

	[DomainMethod]
	public CharacterLocationDisplayData GetCharacterLocationDisplayData(int charId)
	{
		CharacterLocationDisplayData result = new CharacterLocationDisplayData();
		result.CharacterId = charId;
		result.IsCapturedInStoneRoom = false;
		if (_objects.ContainsKey(charId))
		{
			result.DisplayType = 0;
			Character element_Objects = GetElement_Objects(charId);
			Location location = element_Objects.GetLocation();
			result.Location = location;
			int kidnapperId = element_Objects.GetKidnapperId();
			if (kidnapperId >= 0)
			{
				result.DisplayType = 1;
				result.Kidnapper = GetCharacterDisplayData(kidnapperId);
				result.Location = result.Kidnapper.Location;
			}
			if (element_Objects.IsActiveExternalRelationState(4))
			{
				AdventureSiteData adventureSite = DomainManager.Adventure.GetAdventureSite(location.AreaId, location.BlockId);
				result.AdventureSite = adventureSite;
			}
			else if (element_Objects.IsActiveExternalRelationState(32))
			{
				sbyte prisonerSect = DomainManager.Organization.GetPrisonerSect(element_Objects.GetId());
				Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(prisonerSect);
				result.Location = settlementByOrgTemplateId.GetLocation();
			}
			byte externalRelationState = element_Objects.GetExternalRelationState();
			result.IsCapturedInStoneRoom = ExternalRelationStateHelper.IsActive(externalRelationState, 8);
			GetBlockData();
			if (result.AdventureSite == null)
			{
				result.AdventureSite = new AdventureSiteData
				{
					TemplateId = -1
				};
			}
			else
			{
				result.DisplayType = 2;
			}
			result.FullBlockName = DomainManager.Map.GetBlockFullName(result.Location);
		}
		else if (_deadCharacters.ContainsKey(charId))
		{
			result.DisplayType = 3;
			result.Location = (_graves.TryGetValue(charId, out var value) ? value.GetLocation() : Location.Invalid);
			result.FullBlockName = DomainManager.Map.GetBlockFullName(result.Location);
			GetBlockData();
			result.AdventureSite = new AdventureSiteData
			{
				TemplateId = -1
			};
		}
		else
		{
			result.DisplayType = -1;
			result.Location = Location.Invalid;
			result.FullBlockName = DomainManager.Map.GetBlockFullName(result.Location);
			result.AdventureSite = new AdventureSiteData
			{
				TemplateId = -1
			};
		}
		return result;
		void GetBlockData()
		{
			if (result.Location.IsValid())
			{
				MapBlockData blockData = DomainManager.Map.GetBlockData(result.Location.AreaId, result.Location.BlockId);
				result.BlockData = blockData;
				if (blockData.RootBlockId >= 0)
				{
					result.RootBlockData = DomainManager.Map.GetBlockData(result.Location.AreaId, blockData.RootBlockId);
				}
			}
		}
	}

	[DomainMethod]
	public CharacterDisplayDataForTooltip GetCharacterDisplayDataForTooltip(int charId)
	{
		if (_objects.TryGetValue(charId, out var value))
		{
			return GetCharacterDisplayDataForTooltip(value);
		}
		Logger.Warn($"Trying to get display data for dead character {charId}");
		return null;
	}

	public CharacterDisplayDataForTooltip GetCharacterDisplayDataForTooltip(Character character)
	{
		int id = character.GetId();
		bool flag = DomainManager.Character.IsInteractedWithTaiwu(id);
		return new CharacterDisplayDataForTooltip
		{
			Id = character.GetId(),
			TemplateId = character.GetTemplateId(),
			CreatingType = character.GetCreatingType(),
			OrganizationInfo = character.GetOrganizationInfo(),
			Age = character.GetCurrAge(),
			FullName = character.GetFullName(),
			MonkType = character.GetMonkType(),
			MonasticTitle = character.GetMonasticTitle(),
			CustomDisplayNameId = DomainManager.Extra.GetCharacterCustomDisplayName(id),
			BehaviorType = character.GetBehaviorType(),
			Attraction = character.GetAttraction(),
			AvatarRelatedData = character.GenerateAvatarRelatedData(),
			MainAttributes = character.GetMaxMainAttributes(),
			FeatureIds = character.GetFeatureIds(),
			Gender = character.GetGender(),
			Transgender = character.GetTransgender(),
			CombatSkillQualifications = character.GetCombatSkillQualifications(),
			CombatSkillQualificationGrowthType = character.GetCombatSkillQualificationGrowthType(),
			LifeSkillQualifications = character.GetLifeSkillQualifications(),
			LifeSkillQualificationGrowthType = character.GetLifeSkillQualificationGrowthType(),
			Personalities = character.GetPersonalities(),
			TeammateCommands = DomainManager.Extra.GetCharTeammateCommands(DataContextManager.GetCurrentThreadDataContext(), id),
			NickNameId = DomainManager.Taiwu.GetFollowingNpcNickNameId(id),
			LifeSkillAttainments = character.GetLifeSkillAttainments(),
			FavorabilityToTaiwu = (flag ? DomainManager.Character.GetFavorability(id, DomainManager.Taiwu.GetTaiwuCharId()) : short.MinValue),
			IsInteractedCharacter = flag
		};
	}

	[DomainMethod]
	public List<GraveDisplayData> GetTaiwuRelatedGraveDisplayDataList()
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		HashSet<int> hashSet = new HashSet<int>();
		GetAllRelatedDeadCharIds(taiwuCharId, hashSet, includeGeneral: true);
		List<int> list = new List<int>();
		foreach (int item in hashSet)
		{
			list.Add(item);
		}
		return GetGraveDisplayDataList(list);
	}

	[DomainMethod]
	public List<GraveDisplayData> GetGraveDisplayDataList(List<int> charIdList)
	{
		List<GraveDisplayData> list = new List<GraveDisplayData>();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		foreach (int charId in charIdList)
		{
			DeadCharacter element_DeadCharacters = GetElement_DeadCharacters(charId);
			Grave element_Graves = GetElement_Graves(charId);
			GraveDisplayData graveDisplayData = new GraveDisplayData
			{
				Id = charId,
				TemplateId = element_DeadCharacters.TemplateId,
				OrgSettlementId = element_DeadCharacters.OrganizationInfo.SettlementId,
				Principal = element_DeadCharacters.OrganizationInfo.Principal,
				Level = element_Graves.GetLevel(),
				Durability = element_Graves.GetDurability(),
				FavorabilityToTaiwu = GetFavorability(charId, taiwuCharId)
			};
			GetNameRelatedData(charId, element_DeadCharacters, ref graveDisplayData.NameData);
			list.Add(graveDisplayData);
		}
		return list;
	}

	[DomainMethod]
	public List<CharacterDisplayDataForRelations> GetCharacterDisplayDataListForRelations(List<int> charIds)
	{
		List<CharacterDisplayDataForRelations> list = new List<CharacterDisplayDataForRelations>();
		if (charIds == null)
		{
			return list;
		}
		int i = 0;
		for (int count = charIds.Count; i < count; i++)
		{
			int num = charIds[i];
			CharacterDisplayDataForRelations item = new CharacterDisplayDataForRelations
			{
				CharacterId = num,
				NameAndLifeRelatedData = GetNameAndLifeRelatedData(num)
			};
			sbyte lifeState = item.NameAndLifeRelatedData.LifeState;
			sbyte b = lifeState;
			if (b != 0)
			{
				if (b != 1)
				{
					continue;
				}
				DeadCharacter element_DeadCharacters = GetElement_DeadCharacters(num);
				item.AvatarRelatedData = element_DeadCharacters.GenerateAvatarRelatedData();
				item.CreatingType = Config.Character.Instance[element_DeadCharacters.TemplateId].CreatingType;
				if (TryGetElement_Graves(num, out var element))
				{
					item.Location = element.GetLocation();
				}
				else
				{
					item.Location = Location.Invalid;
				}
			}
			else
			{
				Character element_Objects = GetElement_Objects(num);
				item.AvatarRelatedData = element_Objects.GenerateAvatarRelatedData();
				item.Location = element_Objects.GetLocation();
				item.CreatingType = element_Objects.GetCreatingType();
				if (item.Location.IsValid())
				{
					MapBlockData block = DomainManager.Map.GetBlock(item.Location);
					if (block == null || block.CharacterSet == null || !block.CharacterSet.Contains(num))
					{
						item.Location = Location.Invalid;
					}
				}
			}
			list.Add(item);
		}
		return list;
	}

	[DomainMethod]
	public List<CharacterDisplayDataForRelations> GetCharacterDisplayDataListForRelationsWithRelationType(int currCharId, List<int> charIds)
	{
		List<CharacterDisplayDataForRelations> characterDisplayDataListForRelations = GetCharacterDisplayDataListForRelations(charIds);
		for (int i = 0; i < characterDisplayDataListForRelations.Count; i++)
		{
			CharacterDisplayDataForRelations value = characterDisplayDataListForRelations[i];
			int characterId = value.CharacterId;
			ushort item = GetRelationBetweenCharacters(characterId, currCharId).Item1;
			value.RelationType = item;
			characterDisplayDataListForRelations[i] = value;
		}
		return characterDisplayDataListForRelations;
	}

	public int GetKidnappedCharacterCount(int charId)
	{
		KidnappedCharacterList value;
		return _kidnappedChars.TryGetValue(charId, out value) ? value.GetCount() : 0;
	}

	[DomainMethod]
	public KidnappedCharacterList GetSomeoneKidnapCharacters(int charId)
	{
		_kidnappedChars.TryGetValue(charId, out var value);
		return value;
	}

	[DomainMethod]
	public List<KidnappedCharacterDisplayData> GetKidnappedCharacterDisplayData(int charId)
	{
		KidnappedCharacterList someoneKidnapCharacters = GetSomeoneKidnapCharacters(charId);
		if (someoneKidnapCharacters == null || someoneKidnapCharacters.GetCount() == 0)
		{
			return null;
		}
		List<KidnappedCharacterDisplayData> list = new List<KidnappedCharacterDisplayData>();
		Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		foreach (KidnappedCharacter item in someoneKidnapCharacters.GetCollection())
		{
			KidnappedCharacterDisplayData kidnappedCharacterDisplayData = new KidnappedCharacterDisplayData();
			kidnappedCharacterDisplayData.KidnappedCharacter = item;
			kidnappedCharacterDisplayData.CharacterDisplayData = DomainManager.Character.GetCharacterDisplayData(item.CharId);
			kidnappedCharacterDisplayData.TotalResistance = CalcKidnappedCharacterTotalResistance(element_Objects, item);
			int exceedingAmount = Math.Max(0, someoneKidnapCharacters.GetCount() - element_Objects.GetKidnapMaxSlotCount());
			kidnappedCharacterDisplayData.EscapeRate = item.CalcEscapeRate(kidnappedCharacterDisplayData.TotalResistance, exceedingAmount);
			list.Add(kidnappedCharacterDisplayData);
		}
		return list;
	}

	[DomainMethod]
	public CharacterAttributeDisplayData GetCharacterAttributeDisplayData(int charId)
	{
		Character element_Objects = GetElement_Objects(charId);
		CharacterAttributeDisplayData characterAttributeDisplayData = new CharacterAttributeDisplayData();
		characterAttributeDisplayData.CurMainAttributes = element_Objects.GetCurrMainAttributes();
		characterAttributeDisplayData.MaxMainAttributes = element_Objects.GetMaxMainAttributes();
		characterAttributeDisplayData.AtkHitAttribute = element_Objects.GetHitValues();
		characterAttributeDisplayData.AtkPenetrability = element_Objects.GetPenetrations();
		characterAttributeDisplayData.DefHitAttribute = element_Objects.GetAvoidValues();
		characterAttributeDisplayData.DefPenetrability = element_Objects.GetPenetrationResists();
		characterAttributeDisplayData.RecoveryOfStanceAndBreath = element_Objects.GetRecoveryOfStanceAndBreath();
		characterAttributeDisplayData.MoveSpeed = element_Objects.GetMoveSpeed();
		characterAttributeDisplayData.RecoveryOfFlaw = element_Objects.GetRecoveryOfFlaw();
		characterAttributeDisplayData.CastSpeed = element_Objects.GetCastSpeed();
		characterAttributeDisplayData.RecoveryOfBlockedAcupoint = element_Objects.GetRecoveryOfBlockedAcupoint();
		characterAttributeDisplayData.WeaponSwitchSpeed = element_Objects.GetWeaponSwitchSpeed();
		characterAttributeDisplayData.AttackSpeed = element_Objects.GetAttackSpeed();
		characterAttributeDisplayData.InnerRatio = element_Objects.GetInnerRatio();
		characterAttributeDisplayData.RecoveryOfQiDisorder = element_Objects.GetRecoveryOfQiDisorder();
		return characterAttributeDisplayData;
	}

	[DomainMethod]
	public unsafe CharacterSamsaraData GetCharacterSamsaraData(int charId)
	{
		List<DeadCharacter> list = new List<DeadCharacter>();
		Character element_Objects = GetElement_Objects(charId);
		PreexistenceCharIds preexistenceCharIds = element_Objects.GetPreexistenceCharIds();
		int i = 0;
		for (int count = preexistenceCharIds.Count; i < count; i++)
		{
			int charId2 = preexistenceCharIds.CharIds[i];
			DeadCharacter item = DomainManager.Character.TryGetDeadCharacter(charId2);
			list.Add(item);
		}
		return new CharacterSamsaraData
		{
			DeadCharacters = list,
			PreexistenceCharIds = preexistenceCharIds
		};
	}

	[DomainMethod]
	public unsafe CharacterAttributeDisplayData GetEquipmentCompareData(DataContext context, int charId, sbyte srcSlot, sbyte destSlot, ItemKey srcItemKey)
	{
		Character element_Objects = GetElement_Objects(charId);
		ItemKey srcItemKey2 = ((destSlot >= 0) ? element_Objects.GetEquipment()[destSlot] : ItemKey.Invalid);
		if (srcSlot >= 0)
		{
			srcItemKey = element_Objects.GetEquipment()[srcSlot];
		}
		element_Objects.ChangeEquipment(context, srcSlot, destSlot, srcItemKey);
		CharacterAttributeDisplayData characterAttributeDisplayData = GetCharacterAttributeDisplayData(charId);
		if (srcSlot < 0 && srcItemKey2.IsValid())
		{
			element_Objects.ChangeEquipment(context, srcSlot, destSlot, srcItemKey2);
		}
		else
		{
			element_Objects.ChangeEquipment(context, destSlot, srcSlot, srcItemKey);
		}
		MainAttributes currMainAttributes = element_Objects.GetCurrMainAttributes();
		MainAttributes maxMainAttributes = element_Objects.GetMaxMainAttributes();
		HitOrAvoidInts hitValues = element_Objects.GetHitValues();
		HitOrAvoidInts avoidValues = element_Objects.GetAvoidValues();
		OuterAndInnerInts penetrations = element_Objects.GetPenetrations();
		OuterAndInnerInts penetrationResists = element_Objects.GetPenetrationResists();
		OuterAndInnerShorts recoveryOfStanceAndBreath = element_Objects.GetRecoveryOfStanceAndBreath();
		for (sbyte b = 0; b < 6; b++)
		{
			ref short reference = ref characterAttributeDisplayData.CurMainAttributes.Items[b];
			reference -= currMainAttributes.Items[b];
			ref short reference2 = ref characterAttributeDisplayData.MaxMainAttributes.Items[b];
			reference2 -= maxMainAttributes.Items[b];
		}
		for (sbyte b2 = 0; b2 < 4; b2++)
		{
			ref int reference3 = ref characterAttributeDisplayData.AtkHitAttribute.Items[b2];
			reference3 -= hitValues.Items[b2];
			ref int reference4 = ref characterAttributeDisplayData.DefHitAttribute.Items[b2];
			reference4 -= avoidValues.Items[b2];
		}
		characterAttributeDisplayData.AtkPenetrability.Outer -= penetrations.Outer;
		characterAttributeDisplayData.AtkPenetrability.Inner -= penetrations.Inner;
		characterAttributeDisplayData.DefPenetrability.Outer -= penetrationResists.Outer;
		characterAttributeDisplayData.DefPenetrability.Inner -= penetrationResists.Inner;
		characterAttributeDisplayData.RecoveryOfStanceAndBreath.Outer -= recoveryOfStanceAndBreath.Outer;
		characterAttributeDisplayData.RecoveryOfStanceAndBreath.Inner -= recoveryOfStanceAndBreath.Inner;
		characterAttributeDisplayData.MoveSpeed -= element_Objects.GetMoveSpeed();
		characterAttributeDisplayData.RecoveryOfFlaw -= element_Objects.GetRecoveryOfFlaw();
		characterAttributeDisplayData.CastSpeed -= element_Objects.GetCastSpeed();
		characterAttributeDisplayData.RecoveryOfBlockedAcupoint -= element_Objects.GetRecoveryOfBlockedAcupoint();
		characterAttributeDisplayData.WeaponSwitchSpeed -= element_Objects.GetWeaponSwitchSpeed();
		characterAttributeDisplayData.AttackSpeed -= element_Objects.GetAttackSpeed();
		characterAttributeDisplayData.InnerRatio -= element_Objects.GetInnerRatio();
		characterAttributeDisplayData.RecoveryOfQiDisorder -= element_Objects.GetRecoveryOfQiDisorder();
		return characterAttributeDisplayData;
	}

	[DomainMethod]
	public List<GroupCharDisplayData> GetGroupCharDisplayDataList(DataContext context, List<int> charIdList)
	{
		List<GroupCharDisplayData> list = new List<GroupCharDisplayData>();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		foreach (int charId in charIdList)
		{
			if (_objects.ContainsKey(charId))
			{
				Character element_Objects = GetElement_Objects(charId);
				AvatarData avatar = element_Objects.GetAvatar();
				GroupCharDisplayData item = new GroupCharDisplayData
				{
					CharacterId = charId,
					CharacterTemplateId = element_Objects.GetTemplateId(),
					NameData = GetNameRelatedData(charId),
					CurrAge = element_Objects.GetCurrAge(),
					ActualAge = element_Objects.GetActualAge(),
					BirthDate = element_Objects.GetBirthDate(),
					Health = element_Objects.GetHealth(),
					MaxLeftHealth = element_Objects.GetLeftMaxHealth(),
					DefeatMarkCount = (sbyte)CombatDomain.GetDefeatMarksCountOutOfCombat(element_Objects),
					Charm = element_Objects.GetAttraction(),
					BehaviorType = element_Objects.GetBehaviorType(),
					Fame = element_Objects.GetFame(),
					Happiness = ((DomainManager.Combat.IsInCombat() && DomainManager.Combat.IsCharInCombat(charId)) ? DomainManager.Combat.GetElement_CombatCharacterDict(charId).GetHappiness() : element_Objects.GetHappiness()),
					FavorabilityToTaiwu = GetFavorability(charId, taiwuCharId),
					IsInteractedWithTaiwu = DomainManager.Character.IsInteractedWithTaiwu(charId),
					PreexistenceCharCount = (short)element_Objects.GetPreexistenceCharIds().Count,
					AttackMedal = element_Objects.GetFeatureMedalValue(0),
					DefenceMedal = element_Objects.GetFeatureMedalValue(1),
					WisdomMedal = element_Objects.GetFeatureMedalValue(2),
					MaxMainAttributes = element_Objects.GetMaxMainAttributes(),
					Penetrations = element_Objects.GetPenetrations(),
					PenetrationResists = element_Objects.GetPenetrationResists(),
					HitValues = element_Objects.GetHitValues(),
					AvoidValues = element_Objects.GetAvoidValues(),
					DisorderOfQi = element_Objects.GetDisorderOfQi(),
					LifeSkillQualifications = element_Objects.GetLifeSkillQualifications(),
					LifeSkillGrowthType = element_Objects.GetLifeSkillQualificationGrowthType(),
					CombatSkillQualifications = element_Objects.GetCombatSkillQualifications(),
					CombatSkillGrowthType = element_Objects.GetCombatSkillQualificationGrowthType(),
					Personalities = element_Objects.GetPersonalities(),
					Resources = element_Objects.GetResources(),
					CurrInventoryLoad = element_Objects.GetCurrInventoryLoad(),
					MaxInventoryLoad = element_Objects.GetMaxInventoryLoad(),
					KidnapCount = (sbyte)GetKidnappedCharacterCount(charId),
					Gender = element_Objects.GetGender(),
					PhysiologicalAge = element_Objects.GetPhysiologicalAge(),
					ClothDisplayId = element_Objects.GetClothingDisplayId(),
					FaceVisible = (!avatar.ShowVeil && !avatar.ShowMask(element_Objects.GetClothingDisplayId())),
					CreatingType = element_Objects.GetCreatingType(),
					Command = DomainManager.Extra.GetCharTeammateCommandsSByteList(context, charId),
					AdvancedCommand = DomainManager.Extra.GetAdvancedCharTeammateCommandsSByteList(charId),
					ConsummateLevel = element_Objects.GetConsummateLevel(),
					IsSpecialGroupMember = DomainManager.Extra.IsSpecialGroupMember(element_Objects)
				};
				list.Add(item);
			}
		}
		return list;
	}

	[DomainMethod]
	public List<(int, short)> GetDefeatMarkCountList(List<int> charIdList)
	{
		List<(int, short)> list = new List<(int, short)>();
		foreach (int charId in charIdList)
		{
			list.Add((charId, (short)CombatDomain.GetDefeatMarksCountOutOfCombat(GetElement_Objects(charId))));
		}
		return list;
	}

	[DomainMethod]
	public List<CharacterDisplayDataForUltimateSelect> GetCharacterDisplayDataListForUltimateSelect(List<int> charIdList)
	{
		if (charIdList == null || charIdList.Count <= 0)
		{
			return null;
		}
		return charIdList.ConvertAll<CharacterDisplayDataForUltimateSelect>(GetCharacterDisplayDataForUltimateSelect);
	}

	private CharacterDisplayDataForUltimateSelect GetCharacterDisplayDataForUltimateSelect(int charId)
	{
		return GetCharacterDisplayDataForUltimateSelect(_objects[charId]);
	}

	private CharacterDisplayDataForUltimateSelect GetCharacterDisplayDataForUltimateSelect(Character character)
	{
		int id = character.GetId();
		return new CharacterDisplayDataForUltimateSelect
		{
			CharacterId = character.GetId(),
			CreatingType = character.GetCreatingType(),
			NameRelatedData = DomainManager.Character.GetNameRelatedData(id),
			AvatarRelatedData = DomainManager.Character.GetAvatarRelatedData(id),
			BirthDate = character.GetBirthDate(),
			CurrAge = character.GetCurrAge(),
			Charm = character.GetAttraction(),
			Gender = character.GetGender(),
			HappinessType = character.GetHappinessType(),
			BehaviorType = character.GetBehaviorType(),
			FameType = character.GetFameType(),
			OrganizationInfo = character.GetOrganizationInfo(),
			IsReclusiveChar = DomainManager.Character.IsReclusive(id),
			LocationNameData = DomainManager.Map.GetBlockFullName(character.GetLocation()),
			Health = character.GetHealth(),
			LeftMaxHealth = character.GetLeftMaxHealth(),
			FavorabilityToTaiwu = DomainManager.Character.GetFavorability(id, DomainManager.Taiwu.GetTaiwuCharId()),
			PreexistenceCharCount = (short)character.GetPreexistenceCharIds().Count,
			AttackMedal = character.GetFeatureMedalValue(0),
			DefenceMedal = character.GetFeatureMedalValue(1),
			WisdomMedal = character.GetFeatureMedalValue(2),
			ConsummateLevel = character.GetConsummateLevel(),
			BirthMonth = character.GetBirthMonth(),
			MaxMainAttributes = character.GetMaxMainAttributes(),
			Penetrations = character.GetPenetrations(),
			PenetrationResists = character.GetPenetrationResists(),
			HitValues = character.GetHitValues(),
			AvoidValues = character.GetAvoidValues(),
			DisorderOfQi = character.GetDisorderOfQi(),
			LifeSkillQualifications = character.GetLifeSkillQualifications(),
			LifeSkillGrowthType = character.GetLifeSkillQualificationGrowthType(),
			CombatSkillQualifications = character.GetCombatSkillQualifications(),
			CombatSkillGrowthType = character.GetCombatSkillQualificationGrowthType(),
			Personalities = character.GetPersonalities(),
			Resources = character.GetResources(),
			CurrInventoryLoad = character.GetCurrInventoryLoad(),
			MaxInventoryLoad = character.GetMaxInventoryLoad(),
			KidnapCount = (sbyte)DomainManager.Character.GetKidnappedCharacterCount(id),
			NeiliProportionOfFiveElements = character.GetNeiliProportionOfFiveElements(),
			VillagerNeedWaitTime = DomainManager.Taiwu.GetVillagerNeedWaitTime(id, DomainManager.Character.CharacterSortFilter)
		};
	}

	[DomainMethod]
	public CharacterDisplayDataForMapBlock GetCharacterDisplayDataForMapBlock(int charId)
	{
		if (!TryGetElement_Objects(charId, out var element))
		{
			return null;
		}
		DataContext currentThreadDataContext = DataContextManager.GetCurrentThreadDataContext();
		CharacterDisplayDataForMapBlock characterDisplayDataForMapBlock = new CharacterDisplayDataForMapBlock
		{
			CharacterId = element.GetId(),
			TemplateId = element.GetTemplateId(),
			CreatingType = element.GetCreatingType(),
			NameRelatedData = DomainManager.Character.GetNameRelatedData(charId),
			AvatarRelatedData = DomainManager.Character.GetAvatarRelatedData(charId),
			Age = element.GetCurrAge(),
			Charm = element.GetAttraction(),
			Gender = element.GetGender(),
			HappinessType = element.GetHappinessType(),
			BehaviorType = element.GetBehaviorType(),
			FameType = element.GetFameType(),
			OrganizationInfo = element.GetOrganizationInfo(),
			IsReclusiveChar = DomainManager.Character.IsReclusive(charId),
			Health = element.GetHealth(),
			LeftMaxHealth = element.GetLeftMaxHealth(),
			PreexistenceCharCount = (short)element.GetPreexistenceCharIds().Count,
			AttackMedal = element.GetFeatureMedalValue(0),
			DefenceMedal = element.GetFeatureMedalValue(1),
			WisdomMedal = element.GetFeatureMedalValue(2),
			ConsummateLevel = element.GetConsummateLevel(),
			BirthMonth = element.GetBirthMonth(),
			DisorderOfQi = element.GetDisorderOfQi(),
			NeiliProportionOfFiveElements = element.GetNeiliProportionOfFiveElements(),
			Injuries = element.GetInjuries(),
			Poisons = element.GetPoisoned(),
			TeammateCommands = DomainManager.Extra.GetCharTeammateCommands(currentThreadDataContext, charId),
			LoveAndHateItemInfo = DomainManager.Character.GetCharacterLoveAndHateItemInfo(currentThreadDataContext, charId),
			FavorabilityToTaiwu = (DomainManager.Character.IsInteractedWithTaiwu(charId) ? GetFavorability(charId, DomainManager.Taiwu.GetTaiwuCharId()) : short.MinValue),
			MainAttributes = element.GetMaxMainAttributes(),
			CurrMainAttributes = element.GetCurrMainAttributes(),
			LifeSkillQualifications = element.GetLifeSkillQualifications(),
			LifeSkillAttainments = element.GetLifeSkillAttainments(),
			LifeSkillGrowthType = element.GetLifeSkillQualificationGrowthType(),
			CombatSkillQualifications = element.GetCombatSkillQualifications(),
			CombatSkillAttainments = element.GetCombatSkillAttainments(),
			CombatSkillGrowthType = element.GetCombatSkillQualificationGrowthType(),
			FeatureIds = element.GetFeatureIds(),
			EquipmentArray = element.GetEquipment(),
			SkillBookCountArray = DomainManager.Character.GetSkillBookLibraryGradeCount(charId),
			LegendaryBookTypeList = DomainManager.LegendaryBook.GetCharOwnedBookTypes(charId),
			TitleIdList = new List<short>()
		};
		element.GetTitles(characterDisplayDataForMapBlock.TitleIdList);
		if (DomainManager.Organization.TryGetSettlementCharacter(charId, out var settlementChar))
		{
			characterDisplayDataForMapBlock.InfluencePower = settlementChar.GetInfluencePower();
		}
		Dictionary<ItemKey, int>.KeyCollection keys = element.GetInventory().Items.Keys;
		characterDisplayDataForMapBlock.HighestGradeItemArray = (from k in keys.Where(delegate(ItemKey k)
			{
				sbyte itemType = k.ItemType;
				return itemType != 0 && itemType != 10 && ItemTemplateHelper.GetItemSubType(k.ItemType, k.TemplateId) != 1202;
			})
			group k by (ItemType: k.ItemType, TemplateId: k.TemplateId) into g
			select g.First() into k
			orderby ItemTemplateHelper.GetGrade(k.ItemType, k.TemplateId) descending
			select k).Take(0..10).ToArray();
		characterDisplayDataForMapBlock.HighestGradeCombatSkillBookArray = (from k in keys
			where ItemTemplateHelper.GetItemSubType(k.ItemType, k.TemplateId) == 1001
			group k by (ItemType: k.ItemType, TemplateId: k.TemplateId) into g
			select g.First() into k
			orderby ItemTemplateHelper.GetGrade(k.ItemType, k.TemplateId) descending
			select k).Take(0..5).ToArray();
		characterDisplayDataForMapBlock.HighestGradeLifeSkillBookArray = (from k in keys
			where ItemTemplateHelper.GetItemSubType(k.ItemType, k.TemplateId) == 1000
			group k by (ItemType: k.ItemType, TemplateId: k.TemplateId) into g
			select g.First() into k
			orderby ItemTemplateHelper.GetGrade(k.ItemType, k.TemplateId) descending
			select k).Take(0..5).ToArray();
		CharacterDisplayDataForMapBlock characterDisplayDataForMapBlock2 = characterDisplayDataForMapBlock;
		(Dictionary<short, bool>, int) visibleCharacterInteractionEventOptions = DomainManager.TaiwuEvent.GetVisibleCharacterInteractionEventOptions(charId);
		characterDisplayDataForMapBlock.VisibleCharacterInteractionEventOptionDict = visibleCharacterInteractionEventOptions.Item1;
		characterDisplayDataForMapBlock2.NoInteractionReason = visibleCharacterInteractionEventOptions.Item2;
		characterDisplayDataForMapBlock.RelationshipToTaiwuList = new List<short>(RelationDisplayType.Instance.Count);
		characterDisplayDataForMapBlock.RelationshipCountDict = new Dictionary<short, int>(RelationDisplayType.Instance.Count);
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		RelatedCharacters relatedCharacters = DomainManager.Character.GetRelatedCharacters(charId);
		RelatedCharacter relation;
		bool flag = DomainManager.Character.TryGetRelation(taiwuCharId, charId, out relation);
		for (sbyte b = 0; b < 17; b++)
		{
			sbyte typeId = b;
			ushort relationType = RelationType.GetRelationType(typeId);
			RelationDisplayTypeItem relationDisplayTypeItem = null;
			RelationDisplayType.Instance.Iterate(delegate(RelationDisplayTypeItem r)
			{
				if (r.RelationTypeIds.Contains(typeId))
				{
					relationDisplayTypeItem = r;
					return false;
				}
				return true;
			});
			if (relationDisplayTypeItem != null)
			{
				short templateId = relationDisplayTypeItem.TemplateId;
				if (flag && RelationType.HasRelation(relation.RelationType, relationType))
				{
					characterDisplayDataForMapBlock.RelationshipToTaiwuList.Add(templateId);
				}
				HashSet<int> hashSet = relatedCharacters?.GetCharacterSet(relationType).GetCollection();
				int num = hashSet?.Count ?? 0;
				characterDisplayDataForMapBlock.RelationshipCountDict.TryGetValue(templateId, out var value);
				value += num;
				characterDisplayDataForMapBlock.RelationshipCountDict[templateId] = value;
				if (num > 0)
				{
					List<int> list = hashSet.ToList();
					list.Sort(delegate(int a, int charId2)
					{
						bool value2 = DomainManager.Character.IsCharacterAlive(a);
						return DomainManager.Character.IsCharacterAlive(charId2).CompareTo(value2);
					});
					switch (relationType)
					{
					case 1:
						characterDisplayDataForMapBlock.BloodParentCharDataList = DomainManager.Character.GetCharacterDisplayDataList(list);
						characterDisplayDataForMapBlock.BloodParentCharDataList = characterDisplayDataForMapBlock.BloodParentCharDataList.OrderByDescending((CharacterDisplayData d) => d.Gender).ToList();
						break;
					case 2:
						characterDisplayDataForMapBlock.BloodChildCharDataList = DomainManager.Character.GetCharacterDisplayDataList(list);
						break;
					case 4:
						characterDisplayDataForMapBlock.BloodBrotherOrSisterCharDataList = DomainManager.Character.GetCharacterDisplayDataList(list);
						break;
					case 1024:
						characterDisplayDataForMapBlock.HusbandOrWifeCharDataList = DomainManager.Character.GetCharacterDisplayDataList(list);
						break;
					}
				}
			}
		}
		List<short> learnedCombatSkills = element.GetLearnedCombatSkills();
		characterDisplayDataForMapBlock.LearnedCombatSkillCountArray = (from g in learnedCombatSkills.GroupBy((short id) => Config.CombatSkill.Instance[id].Grade, (sbyte grade, IEnumerable<short> source) => new
			{
				grade = grade,
				amount = (short)source.Count()
			})
			select g.amount).ToArray();
		characterDisplayDataForMapBlock.LearnedHighestGradeNeigongCombatSkillArray = (from id in learnedCombatSkills
			where Config.CombatSkill.Instance[id].Type == 0
			orderby Config.CombatSkill.Instance[id].Grade descending
			select id).Take(0..6).ToArray();
		characterDisplayDataForMapBlock.LearnedHighestGradePosingCombatSkillArray = (from id in learnedCombatSkills
			where Config.CombatSkill.Instance[id].Type == 1
			orderby Config.CombatSkill.Instance[id].Grade descending
			select id).Take(0..6).ToArray();
		characterDisplayDataForMapBlock.LearnedHighestGradeStuntCombatSkillArray = (from id in learnedCombatSkills
			where Config.CombatSkill.Instance[id].Type == 2
			orderby Config.CombatSkill.Instance[id].Grade descending
			select id).Take(0..6).ToArray();
		characterDisplayDataForMapBlock.LearnedHighestGradeAttackCombatSkillArray = (from id in learnedCombatSkills
			where Config.CombatSkill.Instance[id].EquipType == 1
			orderby Config.CombatSkill.Instance[id].Grade descending
			select id).Take(0..6).ToArray();
		return characterDisplayDataForMapBlock;
	}

	[DomainMethod]
	public List<bool> GetCharacterAllBodyPartExists(int charId)
	{
		Character character = _objects[charId];
		List<bool> list = new List<bool>();
		for (sbyte b = 0; b < 7; b++)
		{
			List<bool> list2 = list;
			if (1 == 0)
			{
			}
			bool item = b switch
			{
				3 => character.GetHaveLeftArm(), 
				4 => character.GetHaveRightArm(), 
				5 => character.GetHaveLeftLeg(), 
				6 => character.GetHaveRightLeg(), 
				_ => true, 
			};
			if (1 == 0)
			{
			}
			list2.Add(item);
		}
		return list;
	}

	public Dictionary<short, HashSet<int>> GetAreaMerchantCharDict(int merchantType)
	{
		Dictionary<short, HashSet<int>> dictionary = new Dictionary<short, HashSet<int>>();
		foreach (KeyValuePair<int, Character> @object in _objects)
		{
			@object.Deconstruct(out var key, out var value);
			int num = key;
			Character character = value;
			OrganizationInfo organizationInfo = character.GetOrganizationInfo();
			OrganizationItem organizationItem = Config.Organization.Instance[organizationInfo.OrgTemplateId];
			short index = organizationItem.Members[organizationInfo.Grade];
			OrganizationMemberItem organizationMemberItem = OrganizationMember.Instance[index];
			if (character.GetCurrAge() >= organizationMemberItem.IdentityActiveAge && character.GetCreatingType() == 1 && DomainManager.Extra.GetMerchantCharToType(num) == merchantType)
			{
				short areaId = character.GetValidLocation().AreaId;
				MapAreaData areaByAreaId = DomainManager.Map.GetAreaByAreaId(areaId);
				short templateId = areaByAreaId.GetTemplateId();
				if (!dictionary.TryGetValue(templateId, out var value2))
				{
					value2 = (dictionary[templateId] = new HashSet<int>());
				}
				value2.Add(num);
			}
		}
		return dictionary;
	}

	public void UpdateDistantMarriages(DataContext context)
	{
		int num = 0;
		int num2 = 0;
		int num3 = 0;
		foreach (KeyValuePair<int, Character> @object in _objects)
		{
			@object.Deconstruct(out var key, out var value);
			int num4 = key;
			Character character = value;
			EMarriageAgeGroup marriageAgeGroup = character.GetMarriageAgeGroup();
			if (!CanStartDistantMarriage(character))
			{
				continue;
			}
			num++;
			int distantMarriageChance = marriageAgeGroup.GetDistantMarriageChance();
			if (context.Random.CheckPercentProb(distantMarriageChance))
			{
				num2++;
				if (UpdateDistantMarriage(context, character))
				{
					num3++;
				}
			}
		}
		Logger.Info($"[DistantMarriage] PassConditionCount={num}, PassSuccessRateCheckCount={num2}, FoundTargetCount={num3}");
	}

	private bool UpdateDistantMarriage(DataContext context, Character character)
	{
		var (character2, eDistantMarriageType) = SelectDistantMarriageTarget(context, character);
		if (character2 == null)
		{
			return false;
		}
		int id = character.GetId();
		int id2 = character2.GetId();
		short settlementId = character.GetOrganizationInfo().SettlementId;
		short settlementId2 = character2.GetOrganizationInfo().SettlementId;
		int currDate = DomainManager.World.GetCurrDate();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		switch (eDistantMarriageType)
		{
		case EDistantMarriageType.SameArea:
			lifeRecordCollection.AddSameAreaDistantMarriage(id, currDate, settlementId2, id2);
			lifeRecordCollection.AddSameAreaDistantMarriage(id2, currDate, settlementId, id);
			if (IsTaiwuPeople(id))
			{
				monthlyNotificationCollection.AddNpcLongDistanceMarriage0(settlementId, id, settlementId2, id2);
			}
			else if (IsTaiwuPeople(id2))
			{
				monthlyNotificationCollection.AddNpcLongDistanceMarriage0(settlementId2, id2, settlementId, id);
			}
			break;
		case EDistantMarriageType.SameState:
			lifeRecordCollection.AddSameStateDistantMarriage(id, currDate, settlementId2, id2);
			lifeRecordCollection.AddSameStateDistantMarriage(id2, currDate, settlementId, id);
			if (IsTaiwuPeople(id))
			{
				monthlyNotificationCollection.AddNpcLongDistanceMarriage1(settlementId, id, settlementId2, id2);
			}
			else if (IsTaiwuPeople(id2))
			{
				monthlyNotificationCollection.AddNpcLongDistanceMarriage1(settlementId2, id2, settlementId, id);
			}
			break;
		case EDistantMarriageType.NeighborStates:
			lifeRecordCollection.AddDifferentStateDistantMarriage(id, currDate, settlementId2, id2);
			lifeRecordCollection.AddDifferentStateDistantMarriage(id2, currDate, settlementId, id);
			if (IsTaiwuPeople(id))
			{
				monthlyNotificationCollection.AddNpcLongDistanceMarriage2(settlementId, id, settlementId2, id2);
			}
			else if (IsTaiwuPeople(id2))
			{
				monthlyNotificationCollection.AddNpcLongDistanceMarriage2(settlementId2, id2, settlementId, id);
			}
			break;
		}
		character.AddPersonalNeed(context, GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(23, id2));
		character2.AddPersonalNeed(context, GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(23, id));
		DomainManager.Character.AddHusbandOrWifeRelations(context, id, id2, currDate);
		DomainManager.Organization.UpdateOrganizationAfterMarriage(context, character, character2);
		return true;
	}

	private Character SelectDistantMarriageTargetSameArea(DataContext context, Character selfChar, Settlement selfSettlement)
	{
		List<int> obj = context.AdvanceMonthRelatedData.TargetCharIdList.Occupy();
		MapAreaData element_Areas = DomainManager.Map.GetElement_Areas(selfSettlement.GetLocation().AreaId);
		short id = selfSettlement.GetId();
		Character character = null;
		SettlementInfo[] settlementInfos = element_Areas.SettlementInfos;
		for (int i = 0; i < settlementInfos.Length; i++)
		{
			SettlementInfo settlementInfo = settlementInfos[i];
			if (settlementInfo.SettlementId >= 0 && settlementInfo.SettlementId != id)
			{
				Settlement settlement = DomainManager.Organization.GetSettlement(settlementInfo.SettlementId);
				OrgMemberCollection members = settlement.GetMembers();
				members.GetAllMembers(obj);
				character = SelectDistantMarriageTarget(selfChar, obj, character);
			}
		}
		context.AdvanceMonthRelatedData.TargetCharIdList.Release(ref obj);
		return character;
	}

	private Character SelectDistantMarriageTargetSameState(DataContext context, Character selfChar, Settlement selfSettlement)
	{
		Location location = selfSettlement.GetLocation();
		sbyte stateIdByAreaId = DomainManager.Map.GetStateIdByAreaId(location.AreaId);
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		Character character = null;
		DomainManager.Map.GetAllAreaInState(stateIdByAreaId, list);
		List<int> obj = context.AdvanceMonthRelatedData.TargetCharIdList.Occupy();
		foreach (short item in list)
		{
			if (item == location.AreaId)
			{
				continue;
			}
			MapAreaData element_Areas = DomainManager.Map.GetElement_Areas(item);
			SettlementInfo[] settlementInfos = element_Areas.SettlementInfos;
			for (int i = 0; i < settlementInfos.Length; i++)
			{
				SettlementInfo settlementInfo = settlementInfos[i];
				if (settlementInfo.SettlementId >= 0)
				{
					Settlement settlement = DomainManager.Organization.GetSettlement(settlementInfo.SettlementId);
					OrgMemberCollection members = settlement.GetMembers();
					members.GetAllMembers(obj);
					character = SelectDistantMarriageTarget(selfChar, obj, character);
				}
			}
		}
		ObjectPool<List<short>>.Instance.Return(list);
		context.AdvanceMonthRelatedData.TargetCharIdList.Release(ref obj);
		return character;
	}

	private Character SelectDistantMarriageTargetNeighborStates(DataContext context, Character selfChar, Settlement selfSettlement)
	{
		List<short> list = ObjectPool<List<short>>.Instance.Get();
		Location location = selfSettlement.GetLocation();
		sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(location.AreaId);
		sbyte[] neighborStates = MapState.Instance[stateTemplateIdByAreaId].NeighborStates;
		List<int> obj = context.AdvanceMonthRelatedData.TargetCharIdList.Occupy();
		Character character = null;
		sbyte[] array = neighborStates;
		foreach (sbyte stateTemplateId in array)
		{
			sbyte stateIdByStateTemplateId = DomainManager.Map.GetStateIdByStateTemplateId(stateTemplateId);
			DomainManager.Map.GetAllAreaInState(stateIdByStateTemplateId, list);
			foreach (short item in list)
			{
				MapAreaData element_Areas = DomainManager.Map.GetElement_Areas(item);
				SettlementInfo[] settlementInfos = element_Areas.SettlementInfos;
				for (int j = 0; j < settlementInfos.Length; j++)
				{
					SettlementInfo settlementInfo = settlementInfos[j];
					if (settlementInfo.SettlementId >= 0)
					{
						Settlement settlement = DomainManager.Organization.GetSettlement(settlementInfo.SettlementId);
						OrgMemberCollection members = settlement.GetMembers();
						members.GetAllMembers(obj);
						character = SelectDistantMarriageTarget(selfChar, obj, character);
					}
				}
			}
		}
		context.AdvanceMonthRelatedData.TargetCharIdList.Release(ref obj);
		ObjectPool<List<short>>.Instance.Return(list);
		return character;
	}

	private (Character targetChar, EDistantMarriageType type) SelectDistantMarriageTarget(DataContext context, Character character)
	{
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		Settlement settlement = DomainManager.Organization.GetSettlement(organizationInfo.SettlementId);
		Character character2 = SelectDistantMarriageTargetSameArea(context, character, settlement);
		if (character2 != null)
		{
			return (targetChar: character2, type: EDistantMarriageType.SameArea);
		}
		Character character3 = SelectDistantMarriageTargetSameState(context, character, settlement);
		if (character3 != null)
		{
			return (targetChar: character3, type: EDistantMarriageType.SameState);
		}
		Character character4 = SelectDistantMarriageTargetNeighborStates(context, character, settlement);
		if (character4 != null)
		{
			return (targetChar: character4, type: EDistantMarriageType.NeighborStates);
		}
		return (targetChar: null, type: EDistantMarriageType.None);
	}

	private Character SelectDistantMarriageTarget(Character character, IEnumerable<int> charIds, Character defaultTargetChar = null)
	{
		Character character2 = defaultTargetChar;
		foreach (int charId in charIds)
		{
			Character element_Objects = GetElement_Objects(charId);
			if (CanBeDistantMarriageTarget(character, element_Objects))
			{
				if (character2 == null)
				{
					character2 = element_Objects;
				}
				else if (CompareCharacterForDistantMarriageTarget(character, element_Objects, character2) > 0)
				{
					character2 = element_Objects;
				}
			}
		}
		return character2;
	}

	private int CompareCharacterForDistantMarriageTarget(Character selfChar, Character first, Character second)
	{
		sbyte grade = first.GetOrganizationInfo().Grade;
		sbyte grade2 = second.GetOrganizationInfo().Grade;
		if (grade != grade2)
		{
			return grade.CompareTo(grade2);
		}
		short currAge = first.GetCurrAge();
		short currAge2 = second.GetCurrAge();
		if (currAge != currAge2)
		{
			return currAge2.CompareTo(currAge);
		}
		int id = selfChar.GetId();
		int id2 = first.GetId();
		int id3 = second.GetId();
		if (!TryGetRelation(id, id2, out var relation))
		{
			relation = CreateFakeRelation(selfChar, first);
		}
		if (!TryGetRelation(id2, id, out var relation2))
		{
			relation2 = CreateFakeRelation(first, selfChar);
		}
		if (!TryGetRelation(id, id3, out var relation3))
		{
			relation3 = CreateFakeRelation(selfChar, second);
		}
		if (!TryGetRelation(id3, id, out var relation4))
		{
			relation4 = CreateFakeRelation(second, selfChar);
		}
		int startRelationSuccessRate_BoyOrGirlFriend = AiHelper.Relation.GetStartRelationSuccessRate_BoyOrGirlFriend(selfChar, first, relation, relation2);
		int startRelationSuccessRate_BoyOrGirlFriend2 = AiHelper.Relation.GetStartRelationSuccessRate_BoyOrGirlFriend(selfChar, second, relation3, relation4);
		if (startRelationSuccessRate_BoyOrGirlFriend != startRelationSuccessRate_BoyOrGirlFriend2)
		{
			return startRelationSuccessRate_BoyOrGirlFriend.CompareTo(startRelationSuccessRate_BoyOrGirlFriend2);
		}
		return id2.CompareTo(id3);
	}

	private RelatedCharacter CreateFakeRelation(Character selfChar, Character relatedChar)
	{
		OrganizationMemberItem orgMemberConfig = selfChar.GetOrganizationInfo().GetOrgMemberConfig();
		sbyte behaviorType = selfChar.GetBehaviorType();
		(short, sbyte, sbyte, short, sbyte, sbyte, OrganizationMemberItem) initialFavorabilityRelatedDataOfAliveChar = GetInitialFavorabilityRelatedDataOfAliveChar(relatedChar);
		int num = CalcInitialFavorability(orgMemberConfig, initialFavorabilityRelatedDataOfAliveChar.Item1, initialFavorabilityRelatedDataOfAliveChar.Item2, initialFavorabilityRelatedDataOfAliveChar.Item3, initialFavorabilityRelatedDataOfAliveChar.Item4, behaviorType, initialFavorabilityRelatedDataOfAliveChar.Item5, hasTaiwu: false, selfIsNotIntelligentCharacter: false);
		return new RelatedCharacter(0, (short)num, -1);
	}

	private bool CanStartDistantMarriage(Character character)
	{
		if (!character.IsInteractableAsIntelligentCharacter())
		{
			return false;
		}
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		if (organizationInfo.OrgTemplateId == 16 || organizationInfo.OrgTemplateId == 0 || organizationInfo.SettlementId < 0 || !organizationInfo.Principal || OrganizationDomain.IsSect(organizationInfo.OrgTemplateId) || character.GetOrganizationInfo().GetOrgMemberConfig().ChildGrade < 0)
		{
			return false;
		}
		if (!MapAreaData.IsRegularArea(character.GetLocation().AreaId))
		{
			return false;
		}
		return GetAliveSpouse(character.GetId()) < 0 && character.GetMonkType() == 0 && !character.GetBisexual() && !character.IsInTaiwuGroup() && !DomainManager.Character.IsTemporaryIntelligentCharacter(character.GetId());
	}

	private bool CanBeDistantMarriageTarget(Character selfChar, Character targetChar)
	{
		if (selfChar.GetGender() == targetChar.GetGender())
		{
			return false;
		}
		if (!CanStartDistantMarriage(targetChar))
		{
			return false;
		}
		EMarriageAgeGroup marriageAgeGroup = selfChar.GetMarriageAgeGroup();
		if (!marriageAgeGroup.CheckMarriageTargetGradeInRange(selfChar.GetInteractionGrade(), targetChar.GetInteractionGrade()))
		{
			return false;
		}
		if (!marriageAgeGroup.CheckMarriageTargetAgeInRange(targetChar.GetGender(), targetChar.GetCurrAge()))
		{
			return false;
		}
		int id = selfChar.GetId();
		int id2 = targetChar.GetId();
		if (!RelationTypeHelper.AllowAddingHusbandOrWifeRelation(id, id2))
		{
			return false;
		}
		if (HasEnemyRelationWithFamily(id, id2) || HasEnemyRelationWithFamily(id2, id))
		{
			return false;
		}
		return true;
	}

	public void UpdateAdoreRelationsInMarriage(DataContext context)
	{
		HashSet<RelationKey> hashSet = new HashSet<RelationKey>();
		foreach (var (num2, character2) in _objects)
		{
			if (!character2.IsInteractableAsIntelligentCharacter())
			{
				continue;
			}
			int aliveSpouse = GetAliveSpouse(num2);
			if (aliveSpouse >= 0)
			{
				RelationKey item = new RelationKey(aliveSpouse, num2);
				if (!hashSet.Contains(item) && context.Random.CheckPercentProb(GlobalConfig.Instance.HusbandAndWifeStartAdoreChance) && !DomainManager.Extra.IsAiActionInCooldown(num2, 4, 0) && !DomainManager.Extra.IsAiActionInCooldown(aliveSpouse, 4, 0) && (!HasRelation(num2, aliveSpouse, 16384) || !HasRelation(num2, aliveSpouse, 16384)))
				{
					hashSet.Add(new RelationKey(num2, aliveSpouse));
				}
			}
		}
		sbyte husbandAndWifeStartAdoreCooldown = GlobalConfig.Instance.HusbandAndWifeStartAdoreCooldown;
		int num3 = 0;
		foreach (RelationKey item2 in hashSet)
		{
			DomainManager.Extra.AddAiActionCooldown(context, item2.CharId, 4, 0, husbandAndWifeStartAdoreCooldown);
			DomainManager.Extra.AddAiActionCooldown(context, item2.RelatedCharId, 4, 0, husbandAndWifeStartAdoreCooldown);
			Character character3 = _objects[item2.CharId];
			Character character4 = _objects[item2.RelatedCharId];
			RelatedCharacter relation = GetRelation(item2.CharId, item2.RelatedCharId);
			RelatedCharacter relation2 = GetRelation(item2.RelatedCharId, item2.CharId);
			bool flag = !RelationType.HasRelation(relation.RelationType, 16384) && UpdateOneWayAdoreRelationInMarriage(context, character3, character4, relation, relation2);
			bool flag2 = !RelationType.HasRelation(relation2.RelationType, 16384) && UpdateOneWayAdoreRelationInMarriage(context, character4, character3, relation2, relation);
			if (flag || flag2)
			{
				num3++;
			}
		}
		Logger.Info($"Adore Relations In Marriage: {num3}/{hashSet.Count}");
	}

	private static bool UpdateOneWayAdoreRelationInMarriage(DataContext context, Character selfChar, Character targetChar, RelatedCharacter selfToTarget, RelatedCharacter targetToSelf)
	{
		int startRelationSuccessRate_Adored = AiHelper.Relation.GetStartRelationSuccessRate_Adored(selfChar, targetChar, selfToTarget, targetToSelf);
		if (!context.Random.CheckPercentProb(startRelationSuccessRate_Adored))
		{
			return false;
		}
		int id = selfChar.GetId();
		int id2 = targetChar.GetId();
		int currDate = DomainManager.World.GetCurrDate();
		DomainManager.Character.AddRelation(context, id, id2, 16384, currDate);
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		lifeRecordCollection.AddAdoreInMarriage(id, currDate, id2);
		GameData.Domains.Character.Ai.PersonalNeed personalNeed = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(23, id2);
		selfChar.AddPersonalNeed(context, personalNeed);
		return true;
	}

	public IEnumerable<int> ExcludeInfant(IEnumerable<int> members)
	{
		Character element;
		return members.Where((int charId) => TryGetElement_Objects(charId, out element) && element.GetAgeGroup() != 0);
	}

	public IEnumerable<Character> ExcludeInfant(IEnumerable<Character> members)
	{
		return members.Where((Character character) => character.GetAgeGroup() != 0);
	}

	[DomainMethod]
	public int GetFeatureMedalValue(int charId, sbyte medalType)
	{
		Character element_Objects = GetElement_Objects(charId);
		return element_Objects.GetFeatureMedalValue(medalType);
	}

	[DomainMethod]
	public List<(int, short)> GetFeatureMedalValueList(List<int> charIdList, sbyte medalType)
	{
		List<(int, short)> list = new List<(int, short)>();
		foreach (int charId in charIdList)
		{
			list.Add((charId, (short)GetElement_Objects(charId).GetFeatureMedalValue(medalType)));
		}
		return list;
	}

	private static void InitializeBasicFeaturesPools()
	{
		_normalPositiveBasicFeaturesPool = new List<short>();
		_normalNegativeBasicFeaturesPool = new List<short>();
		_protagonistPositiveBasicFeaturesPool = new List<short>();
		_protagonistNegativeBasicFeaturesPool = new List<short>();
		foreach (CharacterFeatureItem item in (IEnumerable<CharacterFeatureItem>)CharacterFeature.Instance)
		{
			if (item == null || !item.Basic)
			{
				continue;
			}
			if (item.CandidateGroupId == 0)
			{
				for (int i = 0; i < item.AppearProb; i++)
				{
					_normalPositiveBasicFeaturesPool.Add(item.TemplateId);
				}
				for (int j = 0; j < item.ProtagonistAppearProb; j++)
				{
					_protagonistPositiveBasicFeaturesPool.Add(item.TemplateId);
				}
				continue;
			}
			if (item.CandidateGroupId == 1)
			{
				for (int k = 0; k < item.AppearProb; k++)
				{
					_normalNegativeBasicFeaturesPool.Add(item.TemplateId);
				}
				for (int l = 0; l < item.ProtagonistAppearProb; l++)
				{
					_protagonistNegativeBasicFeaturesPool.Add(item.TemplateId);
				}
				continue;
			}
			for (int m = 0; m < item.AppearProb; m++)
			{
				_normalPositiveBasicFeaturesPool.Add(item.TemplateId);
				_normalNegativeBasicFeaturesPool.Add(item.TemplateId);
			}
			for (int n = 0; n < item.ProtagonistAppearProb; n++)
			{
				_protagonistPositiveBasicFeaturesPool.Add(item.TemplateId);
				_protagonistNegativeBasicFeaturesPool.Add(item.TemplateId);
			}
		}
	}

	public static short GetBirthdayFeatureId(sbyte month)
	{
		return (short)(183 + month);
	}

	public unsafe static short GenerateOneYearOldCatchFeature(IRandomSource random)
	{
		sbyte* ptr = stackalloc sbyte[12];
		int num = 0;
		for (int i = 0; i < 12; i++)
		{
			int index = 171 + i;
			num += (ptr[i] = CharacterFeature.Instance[index].AppearProb);
		}
		int randomWeightedElement = CollectionUtils.GetRandomWeightedElement(random, ptr, 12, num);
		return (short)(171 + randomWeightedElement);
	}

	public static short GetMergeableFeatureIdByLevel(short groupId, sbyte level)
	{
		if (level > 0)
		{
			return (short)(groupId + (level - 1));
		}
		if (level < 0)
		{
			return (short)(groupId + (2 - level));
		}
		return -1;
	}

	public static (short groupId, short featureId) GetRandomBasicFeature(IRandomSource random, bool isProtagonist, sbyte gender, bool isPositive, Dictionary<short, short> featureGroup2Id)
	{
		List<short> featuresPool = ((!isProtagonist) ? (isPositive ? _normalPositiveBasicFeaturesPool : _normalNegativeBasicFeaturesPool) : (isPositive ? _protagonistPositiveBasicFeaturesPool : _protagonistNegativeBasicFeaturesPool));
		return GetRandomFeatureFromPool(random, gender, featuresPool, featureGroup2Id);
	}

	public static (short groupId, short featureId) GetRandomBasicFeature(IRandomSource random, bool isProtagonist, sbyte gender, bool isPositive, sbyte medalType, Dictionary<short, short> featureGroup2Id, sbyte maxLevel = 3)
	{
		List<short> list = ((!isProtagonist) ? (isPositive ? _normalPositiveBasicFeaturesPool : _normalNegativeBasicFeaturesPool) : (isPositive ? _protagonistPositiveBasicFeaturesPool : _protagonistNegativeBasicFeaturesPool));
		List<short> list2 = list;
		if (medalType != 3 && isPositive)
		{
			list2 = ObjectPool<List<short>>.Instance.Get();
			list2.Clear();
			foreach (short item in list)
			{
				if (CharacterFeature.Instance[item].FeatureMedals[medalType].Values.Count > 0 && CharacterFeature.Instance[item].Level <= maxLevel)
				{
					list2.Add(item);
				}
			}
		}
		(short, short) randomFeatureFromPool = GetRandomFeatureFromPool(random, gender, list2, featureGroup2Id);
		if (list2 != list)
		{
			ObjectPool<List<short>>.Instance.Return(list2);
		}
		return randomFeatureFromPool;
	}

	public static (short groupId, short featureId) GetRandomFeatureFromPool(IRandomSource random, sbyte gender, List<short> featuresPool, Dictionary<short, short> featureGroup2Id)
	{
		int count = featuresPool.Count;
		int num = count;
		for (int i = 0; i < num; i++)
		{
			short num2 = featuresPool[random.Next(count)];
			CharacterFeatureItem characterFeatureItem = CharacterFeature.Instance[num2];
			if (!featureGroup2Id.ContainsKey(characterFeatureItem.MutexGroupId) && (characterFeatureItem.Gender == -1 || characterFeatureItem.Gender == gender))
			{
				return (groupId: characterFeatureItem.MutexGroupId, featureId: num2);
			}
		}
		Logger.Warn("GetRandomBasicFeature: give up due to exceeding maxTryCount.");
		return (groupId: -1, featureId: -1);
	}

	[DomainMethod]
	public CharacterList InitializeCharacterSortFilter(CharacterSortFilterSettings sortFilterSettings)
	{
		_characterSortFilter = new CharacterSortFilter(sortFilterSettings, "CN");
		return _characterSortFilter.GetCharacterList(sortFilterSettings.FilterSubId);
	}

	[DomainMethod]
	public CharacterList UpdateSortFilterSettings(CharacterSortFilterSettings sortFilterSettings)
	{
		if (_characterSortFilter == null || !_characterSortFilter.CheckFilterSettingsMatch(sortFilterSettings))
		{
			_characterSortFilter = new CharacterSortFilter(sortFilterSettings, "CN");
		}
		_characterSortFilter.Sort(sortFilterSettings);
		return _characterSortFilter.GetCharacterList(sortFilterSettings.FilterSubId);
	}

	[DomainMethod]
	public CharacterList FindNameInCurrentSortFilter(string name)
	{
		return _characterSortFilter?.FindByName(name) ?? default(CharacterList);
	}

	[DomainMethod]
	public void ClearCharacterSortFilter()
	{
		_characterSortFilter = null;
	}

	[DomainMethod]
	public List<int> GetFilteredCharacterCounts()
	{
		return _characterSortFilter?.GetCounts();
	}

	[DomainMethod]
	public List<int> GetMaxSortingTypeCharIds(List<int> sortingTypes, sbyte filterSubId)
	{
		return _characterSortFilter?.GetMaxSortingTypeCharIds(sortingTypes, filterSubId);
	}

	private void InitializeFixedCharactersCache()
	{
		_fixedCharactersCache = new Dictionary<short, int>();
		_convertedFixedCharactersCache = new Dictionary<short, int>();
		foreach (var (value, character2) in _objects)
		{
			if (Config.Character.Instance[character2.GetTemplateId()].CreatingType != 0)
			{
				continue;
			}
			OrganizationInfo organizationInfo = character2.GetOrganizationInfo();
			if (organizationInfo.OrgTemplateId != 16 || organizationInfo.Grade != 8)
			{
				if (character2.GetCreatingType() == 0)
				{
					_fixedCharactersCache.Add(character2.GetTemplateId(), value);
				}
				else if (!_convertedFixedCharactersCache.TryAdd(character2.GetTemplateId(), value))
				{
					Logger.Warn($"Duplicate converted fixed character detected {character2}");
				}
			}
		}
	}

	[DomainMethod]
	public int GetFixedCharacterIdByTemplateId(short templateId)
	{
		if (_fixedCharactersCache.TryGetValue(templateId, out var value))
		{
			return value;
		}
		return -1;
	}

	public bool TryGetConvertedFixedCharacterByTemplateId(short templateId, out Character character)
	{
		if (_convertedFixedCharactersCache.TryGetValue(templateId, out var value))
		{
			return _objects.TryGetValue(value, out character);
		}
		character = null;
		return false;
	}

	public bool TryGetFixedCharacterByTemplateId(short templateId, out Character character)
	{
		Tester.Assert(Config.Character.Instance[templateId].CreatingType == 0);
		if (_fixedCharactersCache.TryGetValue(templateId, out var value))
		{
			character = _objects[value];
			return true;
		}
		character = null;
		return false;
	}

	public Character GetOrCreateFixedCharacterByTemplateId(DataContext context, short templateId)
	{
		Tester.Assert(Config.Character.Instance[templateId].CreatingType == 0);
		if (_fixedCharactersCache.TryGetValue(templateId, out var value))
		{
			return _objects[value];
		}
		Character character = CreateFixedCharacter(context, templateId);
		CompleteCreatingCharacter(character.GetId());
		return character;
	}

	public void RegisterFeatureForAllXiangshuAvatars(DataContext context, short featureId)
	{
		foreach (KeyValuePair<short, int> item in _fixedCharactersCache)
		{
			item.Deconstruct(out var key, out var value);
			short index = key;
			int key2 = value;
			CharacterItem characterItem = Config.Character.Instance[index];
			if (characterItem.XiangshuType == 1)
			{
				Character character = _objects[key2];
				character.AddFeature(context, featureId);
			}
		}
	}

	public void UnregisterFeatureForAllXiangshuAvatars(DataContext context, short featureId)
	{
		foreach (KeyValuePair<short, int> item in _fixedCharactersCache)
		{
			item.Deconstruct(out var key, out var value);
			short index = key;
			int key2 = value;
			CharacterItem characterItem = Config.Character.Instance[index];
			if (characterItem.XiangshuType == 1)
			{
				Character character = _objects[key2];
				character.RemoveFeature(context, featureId);
			}
		}
	}

	public Character ReplaceFixedCharacter(DataContext context, short oldCharTemplateId, short newCharTemplateId)
	{
		Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(context, oldCharTemplateId);
		Character orCreateFixedCharacterByTemplateId2 = GetOrCreateFixedCharacterByTemplateId(context, newCharTemplateId);
		Events.RaiseFixedCharacterLocationChanged(context, orCreateFixedCharacterByTemplateId2.GetId(), orCreateFixedCharacterByTemplateId2.GetLocation(), orCreateFixedCharacterByTemplateId.GetLocation());
		orCreateFixedCharacterByTemplateId2.SetLocation(orCreateFixedCharacterByTemplateId.GetLocation(), context);
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		short favorability = GetFavorability(orCreateFixedCharacterByTemplateId.GetId(), taiwuCharId);
		if (favorability != short.MinValue)
		{
			SetFavorability(context, orCreateFixedCharacterByTemplateId2.GetId(), taiwuCharId, favorability);
			SetFavorability(context, taiwuCharId, orCreateFixedCharacterByTemplateId2.GetId(), favorability);
		}
		DomainManager.Character.RemoveNonIntelligentCharacter(context, orCreateFixedCharacterByTemplateId);
		return orCreateFixedCharacterByTemplateId2;
	}

	[DomainMethod]
	public void MoveFuyuHiltLocation(DataContext context, Location targetLocation, bool hide = false)
	{
		int fixedCharacterIdByTemplateId = GetFixedCharacterIdByTemplateId(684);
		Character character = _objects[fixedCharacterIdByTemplateId];
		if (hide)
		{
			Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
			if (targetLocation.Equals(taiwuVillageLocation))
			{
				RemoveNonIntelligentCharacter(context, character);
				Character character2 = DomainManager.Character.CreateFixedCharacter(context, 685);
				DomainManager.Character.CompleteCreatingCharacter(character2.GetId());
				AvatarRelatedData overwrittenTaiwuAvatarRelatedData = DomainManager.Extra.GetOverwrittenTaiwuAvatarRelatedData();
				character2.SetAvatar(overwrittenTaiwuAvatarRelatedData.AvatarData, context);
				character2.SetCurrAge(overwrittenTaiwuAvatarRelatedData.DisplayAge, context);
				character2.SetFullName(DomainManager.Extra.GetOverwrittenTaiwuName().FullName, context);
				short templateId = DomainManager.Item.GetClothingItemByDisplayId(overwrittenTaiwuAvatarRelatedData.ClothingDisplayId).TemplateId;
				character2.ForceReplaceClothing(context, templateId);
				Events.RaiseFixedCharacterLocationChanged(context, character2.GetId(), character2.GetLocation(), targetLocation);
				character2.SetLocation(targetLocation, context);
			}
		}
		else
		{
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), character.GetLocation(), targetLocation);
			character.SetLocation(targetLocation, context);
		}
	}

	[DomainMethod]
	public int GetOrCreateSwordTombCharacterIdForNormalInformation(DataContext context, sbyte xiangshuAvatarId)
	{
		sbyte xiangshuLevel = DomainManager.World.GetXiangshuLevel();
		short currentLevelXiangshuTemplateId = XiangshuAvatarIds.GetCurrentLevelXiangshuTemplateId(xiangshuAvatarId, xiangshuLevel);
		Character orCreateFixedCharacterByTemplateId = GetOrCreateFixedCharacterByTemplateId(context, currentLevelXiangshuTemplateId);
		return orCreateFixedCharacterByTemplateId.GetId();
	}

	[DomainMethod]
	public void GmCmd_SimulateNpcCombat(DataContext context, int charIdA, int charIdB, sbyte combatType, int killBaseChance, int kidnapBaseChance, int releaseBaseChance)
	{
		Character element_Objects = GetElement_Objects(charIdA);
		Character element_Objects2 = GetElement_Objects(charIdB);
		AiHelper.NpcCombatResultType npcCombatResultType = SimulateCharacterCombat(context, element_Objects, element_Objects2, (CombatType)combatType);
		if ((uint)npcCombatResultType <= 1u)
		{
			SimulateCharacterCombatResult(context, element_Objects, element_Objects2, killBaseChance, kidnapBaseChance, releaseBaseChance);
		}
		else
		{
			SimulateCharacterCombatResult(context, element_Objects2, element_Objects, killBaseChance, kidnapBaseChance, releaseBaseChance);
		}
	}

	[DomainMethod]
	public List<CharIdAndName> GmCmd_GetAllCharacterName()
	{
		List<CharIdAndName> list = new List<CharIdAndName>();
		foreach (int key in _objects.Keys)
		{
			var (text, text2) = GetRealName(key);
			list.Add(new CharIdAndName(key, text + text2));
		}
		return list;
	}

	[DomainMethod]
	public void GmCmd_ChangeFavorability(DataContext context, int selfCharId, int relatedCharId, short delta)
	{
		Character element_Objects = GetElement_Objects(selfCharId);
		Character element_Objects2 = GetElement_Objects(relatedCharId);
		DirectlyChangeFavorabilityOptional(context, element_Objects, element_Objects2, delta, -1);
	}

	[DomainMethod]
	public void GmCmd_ClearFameActionRecords(DataContext context, int charId)
	{
		if (!TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"Failed to find character of id: {charId}");
		}
		List<FameActionRecord> fameActionRecords = element.GetFameActionRecords();
		fameActionRecords.Clear();
		element.SetFameActionRecords(fameActionRecords, context);
	}

	[DomainMethod]
	public void GmCmd_RecordFameAction(DataContext context, int charId, short fameActionId, int targetCharId = -1, short fameMultiplier = 1)
	{
		if (!TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"Failed to find character of id: {charId}");
		}
		element.RecordFameAction(context, fameActionId, targetCharId, fameMultiplier);
	}

	[DomainMethod]
	public void GmCmd_AddCharacterExtraTitle(DataContext context, int charId, short titleTemplateId, int duration = -1)
	{
		if (!TryGetElement_Objects(charId, out var _))
		{
			throw new Exception($"Failed to find character of id: {charId}");
		}
		DomainManager.Extra.AddCharacterExtraTitle(context, charId, titleTemplateId, DomainManager.World.GetCurrDate() + duration);
	}

	[DomainMethod]
	public void GmCmd_CreateRandomIntelligentCharacters(DataContext context, int charCount, sbyte orgTemplateId, bool createHere)
	{
		IRandomSource random = context.Random;
		OrganizationItem orgConfig = Config.Organization.Instance[orgTemplateId];
		Settlement settlement = DomainManager.Organization.GetSettlementByOrgTemplateId(orgTemplateId);
		BitArray gradePrincipalFullList = new BitArray(8, defaultValue: false);
		for (int i = 0; i < charCount; i++)
		{
			sbyte b = (sbyte)random.Next(0, 8);
			if (orgTemplateId == 16)
			{
				b = 0;
			}
			while (b > 0 && CheckPrincipalFull(b))
			{
				b--;
			}
			short index = orgConfig.Members[b];
			OrganizationMemberItem organizationMemberItem = OrganizationMember.Instance[index];
			Location location;
			short areaId;
			if (createHere)
			{
				location = DomainManager.Taiwu.GetTaiwu().GetLocation();
				areaId = ((settlement == null) ? ((short)random.Next(45)) : settlement.GetLocation().AreaId);
			}
			else
			{
				if (settlement == null)
				{
					areaId = (short)random.Next(45);
					short mainSettlementMainBlockId = DomainManager.Map.GetMainSettlementMainBlockId(areaId);
					location = new Location(areaId, mainSettlementMainBlockId);
				}
				else
				{
					location = settlement.GetLocation();
				}
				areaId = location.AreaId;
			}
			short settlementIdByOrgTemplateId = DomainManager.Organization.GetSettlementIdByOrgTemplateId(orgTemplateId);
			sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(areaId);
			sbyte b2 = ((organizationMemberItem.Gender == -1) ? Gender.GetRandom(random) : organizationMemberItem.Gender);
			short num = Config.Organization.Instance[orgTemplateId].CharTemplateIds[b2];
			if (num < 0)
			{
				num = MapDomain.GetCharacterTemplateId(stateTemplateIdByAreaId, b2);
			}
			IntelligentCharacterCreationInfo info = new IntelligentCharacterCreationInfo(location, new OrganizationInfo(orgTemplateId, b, principal: true, settlementIdByOrgTemplateId), num);
			Character character = DomainManager.Character.CreateIntelligentCharacter(context, ref info);
			DomainManager.Character.CompleteCreatingCharacter(character.GetId());
		}
		bool CheckPrincipalFull(sbyte gradeId)
		{
			if (gradePrincipalFullList[gradeId])
			{
				return true;
			}
			short index2 = orgConfig.Members[gradeId];
			OrganizationMemberItem organizationMemberItem2 = OrganizationMember.Instance[index2];
			if (settlement != null && organizationMemberItem2.RestrictPrincipalAmount)
			{
				int num2 = 0;
				HashSet<int> members = settlement.GetMembers().GetMembers(gradeId);
				foreach (int item in members)
				{
					if (DomainManager.Character.TryGetElement_Objects(item, out var element) && element.GetOrganizationInfo().Principal)
					{
						num2++;
					}
				}
				return gradePrincipalFullList[gradeId] = num2 >= organizationMemberItem2.Amount;
			}
			return false;
		}
	}

	[DomainMethod]
	public void GmCmd_ForceChangeOrganization(DataContext context, int charId, sbyte orgTemplateId)
	{
		short settlementIdByOrgTemplateId = DomainManager.Organization.GetSettlementIdByOrgTemplateId(orgTemplateId);
		OrganizationInfo info = new OrganizationInfo(orgTemplateId, 0, principal: true, settlementIdByOrgTemplateId);
		GmCmd_ForceChangeOrganization(context, charId, info);
	}

	[DomainMethod]
	public bool GmCmd_ForceChangeOrganizationByName(DataContext context, int charId, string settlementName)
	{
		List<Settlement> list = new List<Settlement>();
		DomainManager.Organization.GetAllSettlements(list);
		foreach (Settlement item in list)
		{
			if (item.GetNameRelatedData().GetName() == settlementName)
			{
				GmCmd_ForceChangeOrganization(context, charId, new OrganizationInfo(item.GetOrgTemplateId(), 0, principal: true, item.GetId()));
				return true;
			}
		}
		return false;
	}

	private void GmCmd_ForceChangeOrganization(DataContext context, int charId, OrganizationInfo info)
	{
		Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		if (element_Objects.GetOrganizationInfo().OrgTemplateId != info.OrgTemplateId)
		{
			if (info.OrgTemplateId == 16 && charId == DomainManager.Taiwu.GetTaiwuCharId())
			{
				OrganizationInfo groupOrganization = new OrganizationInfo(info.OrgTemplateId, 0, principal: true, info.SettlementId);
				info.Grade = 8;
				EventHelper.SetGroupOrganization(groupOrganization);
			}
			DomainManager.Organization.ChangeOrganization(context, element_Objects, info);
		}
	}

	[DomainMethod]
	public bool GmCmd_ForceChangeGrade(DataContext context, int charId, sbyte grade, bool principal)
	{
		Character element_Objects = DomainManager.Character.GetElement_Objects(charId);
		OrganizationInfo organizationInfo = element_Objects.GetOrganizationInfo();
		if (organizationInfo.SettlementId < 0)
		{
			return false;
		}
		if (grade == 8 && principal)
		{
			sbyte orgTemplateId = element_Objects.GetOrganizationInfo().OrgTemplateId;
			OrganizationItem organizationItem = Config.Organization.Instance[orgTemplateId];
			short index = organizationItem.Members[8];
			OrganizationMemberItem organizationMemberItem = OrganizationMember.Instance[index];
			int num = 0;
			Settlement settlement = DomainManager.Organization.GetSettlement(organizationInfo.SettlementId);
			OrgMemberCollection members = settlement.GetMembers();
			HashSet<int> members2 = members.GetMembers(8);
			foreach (int item in members2)
			{
				if (DomainManager.Character.TryGetElement_Objects(item, out var element) && element.GetOrganizationInfo().Principal)
				{
					num++;
				}
			}
			if (num >= organizationMemberItem.Amount)
			{
				return false;
			}
		}
		DomainManager.Organization.ChangeGrade(context, element_Objects, grade, principal);
		int aliveSpouse = DomainManager.Character.GetAliveSpouse(charId);
		if (aliveSpouse >= 0)
		{
			Character element_Objects2 = DomainManager.Character.GetElement_Objects(aliveSpouse);
			DomainManager.Organization.UpdateGradeAccordingToSpouse(context, element_Objects2, element_Objects);
		}
		return true;
	}

	[DomainMethod]
	public void GmCmd_Die(DataContext context, int charId)
	{
		if (!TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"Failed to find character of id: {charId}");
		}
		if (charId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			EventHelper.TriggerLegacyPassingEvent(isTaiwuDying: true);
		}
		else
		{
			MakeCharacterDead(context, element, 0);
		}
		DomainManager.TaiwuEvent.GMCharacterDie(charId);
	}

	[DomainMethod]
	public void GmCmd_ResetHairGrowth(DataContext context, int charId)
	{
		if (!TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"Failed to find character of id: {charId}");
		}
		AvatarData avatar = element.GetAvatar();
		avatar.ResetGrowableElementShowingState(0);
		DomainManager.Character.InitializeAvatarElementGrowthProgress(context, charId, 0);
		element.SetAvatar(avatar, context);
	}

	[DomainMethod]
	public int GmCmd_GetAliveCharByPreexistenceChar(int preexistenceCharId)
	{
		return GmCmd_GetAliveCharByPreexistenceCharInternal(preexistenceCharId)?.GetId() ?? (-1);
	}

	private static Character GmCmd_GetAliveCharByPreexistenceCharInternal(int preexistenceCharId)
	{
		List<Character> list = new List<Character>();
		DomainManager.Character.FindIntelligentCharacters((Character character) => CharacterMatchers.MatchPreexistenceChar(character, preexistenceCharId), list);
		if (list.Count > 1)
		{
			throw new Exception($"More than one alive character own the preexistence: {preexistenceCharId}");
		}
		if (list.Count == 1)
		{
			return list[0];
		}
		return null;
	}

	[DomainMethod]
	public void GmCmd_LogCharacterSamsaraInfo()
	{
		foreach (KeyValuePair<int, Character> @object in _objects)
		{
			PreexistenceCharIds preexistenceCharIds = @object.Value.GetPreexistenceCharIds();
			if (preexistenceCharIds.Count > 0)
			{
				(string surname, string givenName) realName = GetRealName(@object.Value.GetId());
				string item = realName.surname;
				string item2 = realName.givenName;
				Location location = @object.Value.GetLocation();
				MapAreaData element_Areas = DomainManager.Map.GetElement_Areas(location.AreaId);
				MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
				Logger.Info($"{element_Areas.GetConfig().Name} {blockData.GetConfig().Name}: {item}{item2} preexistenceCharIds.Count = {preexistenceCharIds.Count}");
			}
		}
	}

	public void GmCmd_KillSamsara(DataContext context)
	{
		List<int> list = new List<int>();
		foreach (KeyValuePair<int, Character> @object in _objects)
		{
			if (@object.Value.GetCreatingType() == 1)
			{
				PreexistenceCharIds preexistenceCharIds = @object.Value.GetPreexistenceCharIds();
				if (preexistenceCharIds.Count > 0)
				{
					list.Add(@object.Value.GetId());
				}
			}
		}
		foreach (int item in list)
		{
			GmCmd_Die(context, item);
		}
	}

	[DomainMethod]
	public unsafe void GmCmd_EditExtraNeiliAllocation(DataContext context, int characterId, NeiliAllocation allocation)
	{
		Character element_Objects = DomainManager.Character.GetElement_Objects(characterId);
		IntList extraNeiliAllocationProgress = IntList.Create();
		for (int i = 0; i < 4; i++)
		{
			extraNeiliAllocationProgress.Items.Add(CombatSkillDomain.GetExtraNeiliAllocationProgressByExtraNeiliAllocation(allocation.Items[i]));
		}
		DomainManager.CombatSkill.SetCharacterExtraNeiliAllocationAndProgress(context, element_Objects, extraNeiliAllocationProgress, canOverMax: true);
	}

	[DomainMethod]
	public void GmCmd_MakeCharacterKidnapped(DataContext context, int characterId, int targetCharacterId)
	{
		Character element_Objects = DomainManager.Character.GetElement_Objects(characterId);
		Character element_Objects2 = DomainManager.Character.GetElement_Objects(targetCharacterId);
		ItemKey itemKey = DomainManager.Item.CreateItem(context, 12, 73);
		element_Objects.AddInventoryItem(context, itemKey, 1);
		if (DomainManager.Taiwu.IsInGroup(targetCharacterId))
		{
			DomainManager.Taiwu.LeaveGroup(context, targetCharacterId, bringWards: false);
		}
		AddKidnappedCharacter(context, element_Objects, element_Objects2, itemKey);
	}

	[DomainMethod]
	public bool GmCmd_MoveIntelligentCharacter(DataContext context, int charId, Location destLocation)
	{
		if (DomainManager.Character.TryGetElement_Graves(charId, out var element))
		{
			Events.RaiseGraveLocationChanged(context, charId, element.GetLocation(), destLocation);
			element.SetLocation(destLocation, context);
			return true;
		}
		if (charId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			return false;
		}
		Character element_Objects = GetElement_Objects(charId);
		if (element_Objects.GetCreatingType() == 0)
		{
			Events.RaiseFixedCharacterLocationChanged(context, element_Objects.GetId(), element_Objects.GetLocation(), destLocation);
			element_Objects.SetLocation(destLocation, context);
			return true;
		}
		Tester.Assert(element_Objects.GetCreatingType() == 1);
		Tester.Assert(!IsTemporaryIntelligentCharacter(charId));
		if (!element_Objects.GetLocation().IsValid())
		{
			return false;
		}
		int leaderId = element_Objects.GetLeaderId();
		if (leaderId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			return false;
		}
		if (leaderId >= 0)
		{
			LeaveGroup(context, element_Objects);
		}
		GroupMove(context, element_Objects, destLocation);
		return true;
	}

	[DomainMethod]
	public void GmCmd_RandomizeRelationShipsInSettlement(DataContext context, sbyte orgTemplateId)
	{
		ushort[] array = new ushort[8] { 64, 512, 1024, 2048, 4096, 8192, 16384, 32768 };
		short settlementIdByOrgTemplateId = DomainManager.Organization.GetSettlementIdByOrgTemplateId(orgTemplateId);
		List<int> list = new List<int>();
		DomainManager.Organization.GetSettlement(settlementIdByOrgTemplateId).GetMembers().GetAllMembers(list);
		foreach (int item in list)
		{
			int num = list[context.Random.Next(list.Count)];
			if (num == item)
			{
				continue;
			}
			int lastSpouse = GetLastSpouse(num);
			if (lastSpouse >= 0 && lastSpouse == item)
			{
				continue;
			}
			ushort num2 = array[context.Random.Next(array.Length)];
			if (!RelationTypeHelper.AllowAddingRelation(item, num, num2))
			{
				continue;
			}
			switch (num2)
			{
			case 64:
				AddAdoptiveParentRelations(context, item, num);
				if (lastSpouse >= 0)
				{
					AddAdoptiveParentRelations(context, item, lastSpouse);
				}
				break;
			case 1024:
				AddHusbandOrWifeRelations(context, item, num);
				break;
			default:
				AddRelation(context, item, num, num2);
				break;
			}
		}
	}

	[DomainMethod]
	public void GmCmd_MakeCharacterHaveSex(DataContext context, int selfCharId, int targetCharId, bool isRaped, int pregnantRemainTime)
	{
		if (!TryGetElement_Objects(selfCharId, out var element) || !TryGetElement_Objects(targetCharId, out var element2) || element.GetGender() == element2.GetGender())
		{
			return;
		}
		Character character = ((element.GetGender() == 1) ? element : element2);
		Character character2 = ((element.GetGender() == 0) ? element : element2);
		character2.AddFeature(context, 196, removeMutexFeature: true);
		character.AddFeature(context, 196, removeMutexFeature: true);
		if (!character2.GetFeatureIds().Contains(197) && element.GetFertility() > 0 && element2.GetFertility() > 0 && !TryGetElement_PregnancyLockEndDates(character2.GetId(), out var _))
		{
			CreatePregnantState(context, character2, character, isRaped);
			if (TryGetElement_PregnantStates(character2.GetId(), out var value2))
			{
				int currDate = DomainManager.World.GetCurrDate();
				value2.ExpectedBirthDate = currDate + pregnantRemainTime;
				SetElement_PregnantStates(character2.GetId(), value2, context);
			}
			character2.AddFeature(context, 197, removeMutexFeature: true);
		}
	}

	[DomainMethod]
	public int GmCmd_GetCharacterPregnancyLockEndDates(DataContext context, int charId)
	{
		if (TryGetElement_PregnancyLockEndDates(charId, out var value))
		{
			return value;
		}
		return -1;
	}

	[DomainMethod]
	public List<int> GmCmd_GetCharacterActualBloodParents(DataContext context, int charId)
	{
		List<int> list = new List<int>();
		if (TryGetElement_Objects(charId, out var _))
		{
			int bloodParent = GetBloodParent(charId, 1);
			int bloodParent2 = GetBloodParent(charId, 0);
			list.Add(bloodParent);
			list.Add(bloodParent2);
			list.Add(TryGetActualBloodParent(bloodParent, charId, out var actualParentId) ? actualParentId : (-1));
			list.Add(TryGetActualBloodParent(bloodParent2, charId, out var actualParentId2) ? actualParentId2 : (-1));
		}
		else
		{
			list.Add(-1);
			list.Add(-1);
			list.Add(-1);
			list.Add(-1);
		}
		return list;
	}

	[DomainMethod]
	public List<List<CharacterDisplayData>> GmCmd_GetAllGroupMembers()
	{
		CharacterDomain character = DomainManager.Character;
		List<int> list = new List<int>();
		List<List<CharacterDisplayData>> list2 = new List<List<CharacterDisplayData>>();
		foreach (KeyValuePair<int, CharacterSet> characterGroup in _characterGroups)
		{
			list.Clear();
			list.AddRange(characterGroup.Value.GetCollection());
			list.Remove(characterGroup.Key);
			list.Insert(0, characterGroup.Key);
			list2.Add(character.GetCharacterDisplayDataList(list));
		}
		return list2;
	}

	[DomainMethod]
	public void GmCmd_GenerateRandomRefinedItemToCharacter(DataContext context, int charId, sbyte itemType, int times)
	{
		Character element_Objects = GetElement_Objects(charId);
		IRandomSource random = context.Random;
		short[] list = (from m in Config.Material.Instance
			where m.RefiningEffect >= 0
			select m.TemplateId).ToArray();
		ItemDomain item = DomainManager.Item;
		sbyte itemType2 = itemType;
		if (1 == 0)
		{
		}
		int num = itemType switch
		{
			2 => random.Next(0, Config.Accessory.Instance.Count), 
			1 => random.Next(0, Config.Armor.Instance.Count), 
			4 => random.Next(0, Config.Carrier.Instance.Count), 
			3 => random.Next(0, Config.Clothing.Instance.Count), 
			11 => random.Next(0, Config.Cricket.Instance.Count), 
			7 => random.Next(0, Config.Food.Instance.Count), 
			5 => random.Next(0, Config.Material.Instance.Count), 
			8 => random.Next(0, Config.Medicine.Instance.Count), 
			12 => random.Next(0, Config.Misc.Instance.Count), 
			0 => random.Next(0, Config.Weapon.Instance.Count), 
			6 => random.Next(0, Config.CraftTool.Instance.Count), 
			10 => random.Next(0, Config.SkillBook.Instance.Count), 
			9 => random.Next(0, Config.TeaWine.Instance.Count), 
			_ => -1, 
		};
		if (1 == 0)
		{
		}
		ItemKey itemKey = item.CreateItem(context, itemType2, (short)num);
		ItemBase itemBase = DomainManager.Item.GetBaseItem(itemKey);
		times = Math.Min(times, 5);
		for (int num2 = 0; num2 < times; num2++)
		{
			itemBase = DomainManager.Item.SetRefinedEffects(context, itemBase, num2, list.GetRandom(random)).item;
		}
		element_Objects.AddInventoryItem(context, itemBase.GetItemKey(), 1);
	}

	[DomainMethod]
	public void GmCmd_ChangeInjury(DataContext context, int charId, bool isInnerInjury, sbyte bodyPartType, sbyte delta)
	{
		if (!TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"Failed to find character of id: {charId}");
		}
		element.ChangeInjury(context, bodyPartType, isInnerInjury, delta);
	}

	[DomainMethod]
	public void GmCmd_SetCurReadingEvent(DataContext context, int charId)
	{
		if (!TryGetElement_Objects(charId, out var _))
		{
			throw new Exception($"Failed to find character of id: {charId}");
		}
		ItemKey curReadingBook = DomainManager.Taiwu.GetCurReadingBook();
		DomainManager.Extra.AddReadingEventBookId(context, curReadingBook.Id);
	}

	[DomainMethod]
	public void GmCmd_SetCurLoopingEvent(DataContext context, int charId)
	{
		if (!TryGetElement_Objects(charId, out var _))
		{
			throw new Exception($"Failed to find character of id: {charId}");
		}
		DomainManager.Taiwu.AddLoopingEvent(context);
	}

	[DomainMethod]
	public void GmCmd_ChangePoisonByType(DataContext context, int charId, sbyte poisonType, int changeValue)
	{
		if (!TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"Failed to find character of id: {charId}");
		}
		element.ChangePoisoned(context, poisonType, 3, changeValue);
	}

	[DomainMethod]
	public void GmCmd_AddFeature(DataContext context, int charId, short templateId)
	{
		if (!TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"Failed to find character of id: {charId}");
		}
		element.AddFeature(context, templateId, removeMutexFeature: true);
	}

	[DomainMethod]
	public void GmCmd_RemoveFeature(DataContext context, int charId, short templateId)
	{
		if (!TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"Failed to find character of id: {charId}");
		}
		element.RemoveFeature(context, templateId);
	}

	[DomainMethod]
	public void GmCmd_SetFeatures(DataContext context, int charId, List<short> features)
	{
		if (!TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"Failed to find character of id: {charId}");
		}
		element.SetFeatureIds(features, context);
	}

	[DomainMethod]
	public void GmCmd_SetAdventurePersonalities(DataContext context, int charId, int[] personalities)
	{
		if (!TryGetElement_Objects(charId, out var _))
		{
			throw new Exception($"Failed to find character of id: {charId}");
		}
		DomainManager.Adventure.SetPersonalities(personalities, context);
	}

	[DomainMethod]
	public void GmCmd_SetCurrNeili(DataContext context, int charId, int value)
	{
		if (!TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"Failed to find character of id: {charId}");
		}
		if (value < 0 || value > element.GetMaxNeili())
		{
			Logger.Info($"The value must be in range : [0, {element.GetMaxNeili()}]");
		}
		else
		{
			element.SetCurrNeili(value, context);
		}
	}

	[DomainMethod]
	public void GmCmd_AddPoisonedInventoryItem(DataContext context, int charId, sbyte baseItemType, short baseItemId, short poisonId1, short poisonId2, short poisonId3)
	{
		if (!TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"Failed to find character of id: {charId}");
		}
		ItemKey itemKey = DomainManager.Item.CreateItem(context, baseItemType, baseItemId);
		ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey);
		ItemBase itemBase = baseItem;
		if (poisonId1 >= 0)
		{
			itemBase = DomainManager.Item.SetAttachedPoisons(context, itemBase, poisonId1, add: true).item;
		}
		if (poisonId2 >= 0)
		{
			itemBase = DomainManager.Item.SetAttachedPoisons(context, itemBase, poisonId2, add: true).item;
		}
		if (poisonId3 >= 0)
		{
			itemBase = DomainManager.Item.SetAttachedPoisons(context, itemBase, poisonId3, add: true).item;
		}
		DomainManager.Item.SetPoisonsIdentified(context, itemKey, isIdentified: true);
		element.AddInventoryItem(context, itemBase.GetItemKey(), 1);
	}

	[DomainMethod]
	public void GmCmd_AddPoisonedEatingItem(DataContext context, int charId, sbyte baseItemType, short baseItemId, short poisonId1, short poisonId2, short poisonId3)
	{
		if (!TryGetElement_Objects(charId, out var element))
		{
			throw new Exception($"Failed to find character of id: {charId}");
		}
		ItemKey itemKey = DomainManager.Item.CreateItem(context, baseItemType, baseItemId);
		ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey);
		ItemBase itemBase = baseItem;
		if (poisonId1 >= 0)
		{
			itemBase = DomainManager.Item.SetAttachedPoisons(context, itemBase, poisonId1, add: true).item;
		}
		if (poisonId2 >= 0)
		{
			itemBase = DomainManager.Item.SetAttachedPoisons(context, itemBase, poisonId2, add: true).item;
		}
		if (poisonId3 >= 0)
		{
			itemBase = DomainManager.Item.SetAttachedPoisons(context, itemBase, poisonId3, add: true).item;
		}
		element.AddEatingItem(context, itemBase.GetItemKey());
	}

	[DomainMethod]
	public void GmCmd_ForgetCombatSkill(DataContext context, int charId, short skillTemplateId)
	{
		Character element_Objects = GetElement_Objects(charId);
		List<short> learnedCombatSkills = element_Objects.GetLearnedCombatSkills();
		if (!learnedCombatSkills.Contains(skillTemplateId))
		{
			throw new Exception($"Combat skill not learned. TemplateId:{skillTemplateId}");
		}
		element_Objects.RemoveEquippedCombatSkill(context, skillTemplateId);
		if (charId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			DomainManager.Taiwu.UnregisterCombatSkill(context, skillTemplateId);
			DomainManager.Taiwu.ClearBreakPlate(context, skillTemplateId, fromGmCmd: true);
		}
		DomainManager.CombatSkill.RemoveCombatSkill(charId, skillTemplateId);
		learnedCombatSkills.Remove(skillTemplateId);
		element_Objects.SetLearnedCombatSkills(learnedCombatSkills, context);
		TryRemoveCombatSkillFromAttainmentPanel(context, element_Objects, skillTemplateId);
	}

	[DomainMethod]
	public void GmCmd_RevokeCombatSkill(DataContext context, int charId, List<short> skillTemplateIdList)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return;
		}
		for (int i = 0; i < skillTemplateIdList.Count; i++)
		{
			short skillTemplateId = skillTemplateIdList[i];
			CombatSkillKey objectId = new CombatSkillKey(charId, skillTemplateId);
			GameData.Domains.CombatSkill.CombatSkill element_CombatSkills = DomainManager.CombatSkill.GetElement_CombatSkills(objectId);
			if (!element_CombatSkills.GetRevoked())
			{
				DomainManager.Character.RevokeCombatSkill(context, element, skillTemplateIdList[i]);
			}
		}
	}

	[DomainMethod]
	public void GmCmd_SetLearnedLifeSkills(DataContext context, int charId, List<LifeSkillItem> learnedLifeSkills)
	{
		Character element_Objects = GetElement_Objects(charId);
		List<LifeSkillItem> learnedLifeSkills2 = element_Objects.GetLearnedLifeSkills();
		foreach (LifeSkillItem skill in learnedLifeSkills)
		{
			if (!learnedLifeSkills2.Any((LifeSkillItem prev) => prev.SkillTemplateId == skill.SkillTemplateId) && skill.IsAllPagesRead())
			{
				DomainManager.Information.GainLifeSkillInformationToCharacter(context, charId, LifeSkill.Instance[skill.SkillTemplateId].Type);
			}
		}
		element_Objects.SetLearnedLifeSkills(learnedLifeSkills, context);
		if (DomainManager.Taiwu.GetTaiwuCharId() != charId)
		{
			return;
		}
		HashSet<short> hashSet = new HashSet<short>();
		TaiwuLifeSkill lifeSkill;
		foreach (LifeSkillItem learnedLifeSkill in learnedLifeSkills)
		{
			hashSet.Add(learnedLifeSkill.SkillTemplateId);
			if (DomainManager.Taiwu.TryGetTaiwuLifeSkill(learnedLifeSkill.SkillTemplateId, out lifeSkill))
			{
				DomainManager.Taiwu.UnregisterLifeSkill(context, learnedLifeSkill.SkillTemplateId);
			}
			DomainManager.Taiwu.RegisterLifeSkill(context, learnedLifeSkill);
			DomainManager.Extra.CreateLifeSkillCombatCard(context, learnedLifeSkill);
		}
		foreach (LifeSkillItem item in learnedLifeSkills2)
		{
			if (!hashSet.Contains(item.SkillTemplateId) && DomainManager.Taiwu.TryGetTaiwuLifeSkill(item.SkillTemplateId, out lifeSkill))
			{
				DomainManager.Taiwu.UnregisterLifeSkill(context, item.SkillTemplateId);
			}
		}
	}

	[DomainMethod]
	public void GmCmd_GetCricket(DataContext context, short colorId, short partId, int grade = -1, short winsCount = 0, short lossesCount = 0)
	{
		ItemKey itemKey = ((grade == -1) ? DomainManager.Item.CreateCricket(context, colorId, partId) : DomainManager.Item.CreateCricket(context, (short)grade));
		GameData.Domains.Item.Cricket element_Crickets = DomainManager.Item.GetElement_Crickets(itemKey.Id);
		element_Crickets.SetWinsCount(winsCount, context);
		element_Crickets.SetLossesCount(lossesCount, context);
		element_Crickets.SetCurrDurability((short)context.Random.Next(0, element_Crickets.GetMaxDurability() + 1), context);
		DomainManager.Taiwu.GetTaiwu().AddInventoryItem(context, itemKey, 1);
	}

	[DomainMethod]
	public void GmCmd_AddRelation(DataContext context, int charId, int relatedCharId, ushort addingType)
	{
		switch (addingType)
		{
		case 1:
			AddBloodParentRelations(context, charId, relatedCharId, addingType);
			break;
		case 8:
			AddStepParentRelations(context, charId, relatedCharId, addingType);
			break;
		case 64:
			AddAdoptiveParentRelations(context, charId, relatedCharId, addingType);
			break;
		case 1024:
			AddHusbandOrWifeRelations(context, charId, relatedCharId, addingType);
			break;
		default:
			AddRelation(context, charId, relatedCharId, addingType);
			break;
		}
	}

	[DomainMethod]
	public void GmCmd_RemoveRelation(DataContext context, int charId, int relatedCharId, ushort removeType)
	{
		DomainManager.Character.ChangeRelationType(context, charId, relatedCharId, removeType, 0);
		ushort oppositeRelationType = RelationType.GetOppositeRelationType(removeType);
		DomainManager.Character.ChangeRelationType(context, relatedCharId, charId, oppositeRelationType, 0);
	}

	private void InitializeSkeletonCharacterCache()
	{
		if (_skeletonCharacterCache == null)
		{
			_skeletonCharacterCache = new Dictionary<int, int>();
		}
		_skeletonCharacterCache.Clear();
		foreach (KeyValuePair<int, Grave> grafe in _graves)
		{
			grafe.Deconstruct(out var key, out var value);
			int value2 = key;
			Grave grave = value;
			int skeletonCharId = grave.GetSkeletonCharId();
			if (skeletonCharId >= 0)
			{
				_skeletonCharacterCache.Add(skeletonCharId, value2);
			}
		}
	}

	public int GetSkeletonSourceGraveId(int skeletonCharId)
	{
		if (_skeletonCharacterCache.TryGetValue(skeletonCharId, out var value))
		{
			return value;
		}
		return -1;
	}

	public void GenerateSkeletons(DataContext context)
	{
		for (short num = 0; num < 45; num++)
		{
			Span<MapBlockData> areaBlocks = DomainManager.Map.GetAreaBlocks(num);
			Span<MapBlockData> span = areaBlocks;
			for (int i = 0; i < span.Length; i++)
			{
				MapBlockData mapBlockData = span[i];
				if (mapBlockData.GetConfig().SubType != EMapBlockSubType.Ruin || mapBlockData.GraveSet == null)
				{
					continue;
				}
				foreach (int item in mapBlockData.GraveSet)
				{
					Grave grave = _graves[item];
					int skeletonCharId = grave.GetSkeletonCharId();
					if (skeletonCharId < 0 && context.Random.CheckPercentProb(50))
					{
						CreateSkeletonCharacter(context, grave);
					}
				}
			}
		}
	}

	public void CreateGraveForFixedCharacter(DataContext context, Character fixedCharacter, Location location, sbyte level, int deathDate = int.MinValue)
	{
		Tester.Assert(fixedCharacter.GetCreatingType() == 0);
		int id = fixedCharacter.GetId();
		deathDate = ((deathDate == int.MinValue) ? DomainManager.World.GetCurrDate() : deathDate);
		DeadCharacter deadCharacter = DeadCharacterHelper.CreateDeadCharacter(fixedCharacter, deathDate);
		FullName fullName = ConvertFixedCharacterName(context, fixedCharacter.GetTemplateId(), fixedCharacter.GetGender());
		deadCharacter.FullName = fullName;
		AddElement_DeadCharacters(id, deadCharacter, context);
		Grave grave = new Grave(context, fixedCharacter, location, level);
		AddElement_Graves(id, grave);
		grave.SetLocation(location, context);
		Events.RaiseGraveLocationChanged(context, id, Location.Invalid, grave.GetLocation());
		RemoveNonIntelligentCharacter(context, fixedCharacter);
	}

	public DeadCharacter SectMainStoryJingangCreateDeadMonk(DataContext context, Character fixedCharacter)
	{
		Tester.Assert(fixedCharacter.GetCreatingType() == 0);
		int id = fixedCharacter.GetId();
		int currDate = DomainManager.World.GetCurrDate();
		DeadCharacter deadCharacter = DeadCharacterHelper.CreateDeadCharacter(fixedCharacter, currDate);
		FullName fullName = ConvertFixedCharacterName(context, fixedCharacter.GetTemplateId(), fixedCharacter.GetGender());
		deadCharacter.FullName = fullName;
		AddElement_DeadCharacters(id, deadCharacter, context);
		RemoveNonIntelligentCharacter(context, fixedCharacter);
		return deadCharacter;
	}

	public bool IsGraveProtected(Grave grave)
	{
		int id = grave.GetId();
		Location location = grave.GetLocation();
		MapBlockData block = DomainManager.Map.GetBlock(location);
		if (block.CharacterSet == null)
		{
			return false;
		}
		foreach (int item in block.CharacterSet)
		{
			if (DomainManager.Taiwu.TryGetElement_VillagerWork(item, out var value) && value.WorkType == 12 && value.GraveId == id)
			{
				return true;
			}
		}
		return false;
	}

	public void DecayGraves(DataContext context)
	{
		List<Grave> list = new List<Grave>();
		HashSet<int> hashSet = ObjectPool<HashSet<int>>.Instance.Get();
		DomainManager.Taiwu.GetKeptGraves(hashSet);
		foreach (KeyValuePair<int, Grave> grafe in _graves)
		{
			if (!hashSet.Contains(grafe.Key))
			{
				Grave value = grafe.Value;
				short durability = value.GetDurability();
				if (durability > 1)
				{
					value.SetDurability((short)(durability - 1), context);
				}
				else
				{
					list.Add(value);
				}
			}
		}
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int i = 0;
		for (int count = list.Count; i < count; i++)
		{
			Grave grave = list[i];
			RemoveGrave(context, grave);
		}
		ObjectPool<HashSet<int>>.Instance.Return(hashSet);
	}

	public void RemoveGrave(DataContext context, Grave grave)
	{
		int id = grave.GetId();
		Location location = grave.GetLocation();
		int skeletonCharId = grave.GetSkeletonCharId();
		if (skeletonCharId >= 0)
		{
			RemoveNonIntelligentCharacter(context, _objects[skeletonCharId]);
		}
		ClearGraveItemsRelatedData();
		if (location.IsValid())
		{
			DomainManager.Map.GetRealNeighborBlocks(location.AreaId, location.BlockId, _graveNeighborBlocks, 1, includeCenter: true);
		}
		if (_graveNeighborBlocks.Count > 0)
		{
			Inventory inventory = grave.GetInventory();
			int count = _graveNeighborBlocks.Count;
			foreach (var (itemKey2, item) in inventory.Items)
			{
				if (ItemTemplateHelper.GetGrade(itemKey2.ItemType, itemKey2.TemplateId) >= 6)
				{
					int num2 = context.Random.Next(count);
					_graveNeighborItems[num2].Add((itemKey2, item));
					DomainManager.Item.RemoveOwner(itemKey2, ItemOwnerType.Grave, id);
				}
				else
				{
					DomainManager.Item.RemoveItem(context, itemKey2);
				}
			}
			for (int i = 0; i < count; i++)
			{
				List<(ItemKey, int)> list = _graveNeighborItems[i];
				if (list.Count > 0)
				{
					DomainManager.Map.AddBlockItems(context, _graveNeighborBlocks[i], list);
				}
			}
		}
		else
		{
			DomainManager.Item.RemoveItems(context, grave.GetInventory().Items);
			Logger.Warn($"Grave {grave.GetId()} is at invalid location; all items are destroyed.");
		}
		RemoveElement_Graves(id);
		DomainManager.LifeRecord.RemoveDead(id);
		RecordGraveRemoved(context, id);
		if (DomainManager.Character.IsTaiwuPeople(id))
		{
			DomainManager.World.GetMonthlyNotificationCollection().AddGraveDestroyed(id);
		}
		Events.RaiseGraveLocationChanged(context, id, grave.GetLocation(), Location.Invalid);
	}

	private void InitializeGraveItemsRelatedData()
	{
		_graveNeighborBlocks = new List<MapBlockData>();
		_graveNeighborItems = new List<(ItemKey, int)>[9];
		for (int i = 0; i < 9; i++)
		{
			_graveNeighborItems[i] = new List<(ItemKey, int)>();
		}
	}

	private void ClearGraveItemsRelatedData()
	{
		_graveNeighborBlocks.Clear();
		for (int i = 0; i < 9; i++)
		{
			_graveNeighborItems[i].Clear();
		}
	}

	public void UpdateGroupFavorabilities(DataContext context)
	{
		foreach (CharacterSet value in _characterGroups.Values)
		{
			HashSet<int> collection = value.GetCollection();
			foreach (int item in collection)
			{
				Character character = _objects[item];
				(short, short) tuple = AiHelper.UpdateStatusConstants.SameGroupFavorabilityChange[character.GetBehaviorType()];
				foreach (int item2 in collection)
				{
					if (item != item2)
					{
						Character relatedChar = _objects[item2];
						int baseDelta = context.Random.Next((int)tuple.Item1, tuple.Item2 + 1);
						ChangeFavorabilityOptionalMonthlyEvolution(context, character, relatedChar, baseDelta);
					}
				}
			}
		}
		DomainManager.Taiwu.UpdateTaiwuGroupFavorabilities(context);
	}

	public void JoinGroup(DataContext context, Character character, Character targetLeader)
	{
		int leaderId = character.GetLeaderId();
		if (leaderId >= 0)
		{
			return;
		}
		int id = character.GetId();
		int id2 = targetLeader.GetId();
		int leaderId2 = targetLeader.GetLeaderId();
		int currDate = DomainManager.World.GetCurrDate();
		if (id == DomainManager.Taiwu.GetTaiwuCharId())
		{
			DomainManager.Taiwu.JoinGroup(context, id);
			return;
		}
		if (character.IsCreatedWithFixedTemplate())
		{
			character.SetLeaderId(id2, context);
			DomainManager.Extra.AddSpecialGroupCharacter(context, id2, id);
			return;
		}
		CharacterSet value;
		if (leaderId2 < 0)
		{
			value = default(CharacterSet);
			value.Add(id);
			character.SetLeaderId(id2, context);
			AddElement_JoinGroupDates(id, currDate, context);
			value.Add(id2);
			targetLeader.SetLeaderId(id2, context);
			AddElement_JoinGroupDates(id2, currDate, context);
			AddElement_CharacterGroups(id2, value, context);
		}
		else
		{
			value = GetElement_CharacterGroups(leaderId2);
			value.Add(id);
			character.SetLeaderId(leaderId2, context);
			AddElement_JoinGroupDates(id, currDate, context);
			SetElement_CharacterGroups(leaderId2, value, context);
		}
		foreach (int item in value.GetCollection())
		{
			if (item != id)
			{
				TryCreateRelation(context, id, item);
			}
		}
		Location location = character.GetLocation();
		Location location2 = targetLeader.GetLocation();
		if (!location.Equals(location2))
		{
			character.SetLocation(location2, context);
			Events.RaiseCharacterLocationChanged(context, id, location, location2);
		}
	}

	[DomainMethod]
	public List<int> GetGroupSet(DataContext context, int charId)
	{
		if (TryGetElement_Objects(charId, out var element))
		{
			List<int> list = new List<int>();
			int leaderId = element.GetLeaderId();
			if (!_characterGroups.TryGetValue(leaderId, out var value))
			{
				if (leaderId == DomainManager.Taiwu.GetTaiwuCharId())
				{
					foreach (int item in DomainManager.Taiwu.GetGroupCharIds().GetCollection())
					{
						list.Add(item);
					}
				}
				else
				{
					list.Add(charId);
				}
			}
			else
			{
				list.Add(leaderId);
				foreach (int item2 in value.GetCollection())
				{
					if (!list.Contains(item2))
					{
						list.Add(item2);
					}
				}
			}
			int i = 0;
			for (int count = list.Count; i < count; i++)
			{
				int leaderId2 = list[i];
				IReadOnlySet<int> specialGroup = DomainManager.Extra.GetSpecialGroup(leaderId2);
				list.AddRange(specialGroup);
			}
			return list;
		}
		throw new Exception($"{charId} is not an exist alive character");
	}

	public void LeaveGroup(DataContext context, Character character, bool bringWards = true)
	{
		int id = character.GetId();
		int leaderId = character.GetLeaderId();
		if (leaderId < 0)
		{
			return;
		}
		if (leaderId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			DomainManager.Taiwu.LeaveGroup(context, id, bringWards);
			return;
		}
		if (character.IsCreatedWithFixedTemplate())
		{
			character.SetLeaderId(-1, context);
			DomainManager.Extra.TryRemoveSpecialGroupCharacter(context, leaderId, id);
			return;
		}
		CharacterSet characterSet = _characterGroups[leaderId];
		HashSet<int> hashSet = ObjectPool<HashSet<int>>.Instance.Get();
		if (bringWards)
		{
			GetWardsInGroup(character, characterSet, hashSet);
		}
		Location location = character.GetLocation();
		if (!location.IsValid())
		{
			location = character.GetValidLocation();
		}
		if (leaderId == id)
		{
			foreach (int item in characterSet.GetCollection())
			{
				if (TryGetElement_Objects(item, out var element))
				{
					element.SetLeaderId(-1, context);
					if (!element.GetLocation().IsValid())
					{
						element.SetLocation(location, context);
					}
				}
				RemoveElement_JoinGroupDates(item, context);
			}
			characterSet.Clear();
			RemoveElement_CharacterGroups(leaderId, context);
			if (bringWards)
			{
				ChangeGroup(context, hashSet, character);
			}
			ObjectPool<HashSet<int>>.Instance.Return(hashSet);
			return;
		}
		characterSet.Remove(id);
		RemoveElement_JoinGroupDates(id, context);
		if (characterSet.GetCount() > 1)
		{
			SetElement_CharacterGroups(leaderId, characterSet, context);
		}
		else
		{
			RemoveElement_CharacterGroups(leaderId, context);
			RemoveElement_JoinGroupDates(leaderId, context);
			if (TryGetElement_Objects(leaderId, out var element2))
			{
				element2.SetLeaderId(-1, context);
			}
		}
		if (_objects.ContainsKey(id))
		{
			if (!character.GetLocation().IsValid())
			{
				character.SetLocation(location, context);
			}
			character.SetLeaderId(-1, context);
		}
		if (bringWards)
		{
			ChangeGroup(context, hashSet, character);
		}
		ObjectPool<HashSet<int>>.Instance.Return(hashSet);
	}

	public void GetWardsInGroup(Character character, CharacterSet group, HashSet<int> wards)
	{
		wards.Clear();
		if (character.GetAgeGroup() == 0)
		{
			return;
		}
		RelatedCharacters relatedCharacters = _relatedCharIds[character.GetId()];
		HashSet<int> collection = group.GetCollection();
		int id = character.GetId();
		sbyte gender = character.GetGender();
		foreach (int item in collection)
		{
			Character character2 = _objects[item];
			if (character2.GetAgeGroup() == 0 && item != id && !HasBetterGuardianInGroup(id, GetRelation(id, item).RelationType, gender, item, collection))
			{
				wards.Add(item);
			}
		}
	}

	private bool HasBetterGuardianInGroup(int selfCharId, ushort relationType, sbyte selfGender, int wardCharId, HashSet<int> group)
	{
		bool flag = !RelationType.HasRelation(relationType, 2);
		if (!flag && selfGender == 0)
		{
			return false;
		}
		bool flag2 = flag && !RelationType.HasRelation(relationType, 16);
		int num = 0;
		foreach (int item in group)
		{
			if (item == selfCharId || item == wardCharId)
			{
				continue;
			}
			Character character = _objects[item];
			if (character.GetAgeGroup() == 0)
			{
				continue;
			}
			num++;
			sbyte gender = character.GetGender();
			RelatedCharacter relation = GetRelation(wardCharId, item);
			if (RelationType.HasRelation(relation.RelationType, 1) && gender <= selfGender)
			{
				return true;
			}
			if (flag)
			{
				if (RelationType.HasRelation(relation.RelationType, 8) && gender <= selfGender)
				{
					return true;
				}
				if (flag2 && RelationType.HasRelation(relation.RelationType, 64) && item <= selfGender)
				{
					return true;
				}
			}
		}
		return num > 0;
	}

	public void ChangeGroup(DataContext context, HashSet<int> memberIds, Character targetLeader)
	{
		int id = targetLeader.GetId();
		foreach (int memberId in memberIds)
		{
			Character character = _objects[memberId];
			int leaderId = character.GetLeaderId();
			if (leaderId >= 0 && leaderId != id)
			{
				LeaveGroup(context, character);
			}
			JoinGroup(context, character, targetLeader);
		}
	}

	public void HideCharacterOnMap(DataContext context, Character character, byte hideCharacterState, bool bringWards = true)
	{
		Tester.Assert(character.GetCreatingType() == 1);
		Tester.Assert((hideCharacterState & 0x3C) != 0);
		int id = character.GetId();
		Location location = character.GetLocation();
		LeaveGroup(context, character, bringWards);
		character.ActiveExternalRelationState(context, hideCharacterState);
		if (character.IsCompletelyInfected())
		{
			Events.RaiseInfectedCharacterLocationChanged(context, id, location, Location.Invalid);
		}
		else
		{
			Events.RaiseCharacterLocationChanged(context, id, location, Location.Invalid);
		}
	}

	public void UnhideCharacterOnMap(DataContext context, Character character, byte hideCharacterState)
	{
		Tester.Assert(character.GetCreatingType() == 1);
		Tester.Assert((hideCharacterState & 0x3C) != 0);
		if (!character.IsActiveExternalRelationState(hideCharacterState))
		{
			return;
		}
		character.DeactivateExternalRelationState(context, hideCharacterState);
		if (!character.IsActiveExternalRelationState(60))
		{
			int id = character.GetId();
			Location location = character.GetLocation();
			if (character.IsCompletelyInfected())
			{
				Events.RaiseInfectedCharacterLocationChanged(context, id, Location.Invalid, location);
			}
			else
			{
				Events.RaiseCharacterLocationChanged(context, id, Location.Invalid, location);
			}
		}
	}

	public void GroupMove(DataContext context, Character character, Location targetLocation)
	{
		if (character.GetKidnapperId() >= 0)
		{
			return;
		}
		int leaderId = character.GetLeaderId();
		Location location = character.GetLocation();
		int id = character.GetId();
		if (leaderId < 0)
		{
			RemoveCrossAreaTravelInfo(context, id);
			if (character.IsCompletelyInfected())
			{
				Events.RaiseInfectedCharacterLocationChanged(context, id, location, targetLocation);
			}
			else
			{
				Events.RaiseCharacterLocationChanged(context, id, location, targetLocation);
			}
			character.SetLocation(targetLocation, context);
			return;
		}
		RemoveCrossAreaTravelInfo(context, leaderId);
		if (!TryGetElement_CharacterGroups(leaderId, out var value))
		{
			return;
		}
		foreach (int item in value.GetCollection())
		{
			Character character2 = _objects[item];
			Events.RaiseCharacterLocationChanged(context, item, character2.GetLocation(), targetLocation);
			character2.SetLocation(targetLocation, context);
		}
	}

	public bool IsInTheSameGroup(int charIdA, int charIdB)
	{
		Character value;
		Character value2;
		return _objects.TryGetValue(charIdA, out value) && _objects.TryGetValue(charIdB, out value2) && value.GetLeaderId() >= 0 && value.GetLeaderId() == value2.GetLeaderId();
	}

	public CharacterSet GetGroup(int leaderId)
	{
		return _characterGroups[leaderId];
	}

	public bool HasNonBabyMemberInGroup(int leaderId)
	{
		if (leaderId < 0 || !_characterGroups.TryGetValue(leaderId, out var value))
		{
			return false;
		}
		foreach (int item in value.GetCollection())
		{
			if (_objects[item].GetAgeGroup() != 0 && leaderId != item)
			{
				return true;
			}
		}
		return false;
	}

	public void UpdateExceedingGroupChars(DataContext context)
	{
		Dictionary<int, CharacterSet> dictionary = new Dictionary<int, CharacterSet>();
		List<long> list = ObjectPool<List<long>>.Instance.Get();
		CharacterMatcherItem canBeRemovedFromGroup = CharacterMatcher.DefValue.CanBeRemovedFromGroup;
		int key;
		CharacterSet value;
		foreach (KeyValuePair<int, CharacterSet> characterGroup in _characterGroups)
		{
			characterGroup.Deconstruct(out key, out value);
			int num = key;
			CharacterSet characterSet = value;
			HashSet<int> collection = characterSet.GetCollection();
			if (collection.Count <= AiHelper.FixedActionConstants.NpcGroupSoftMaxCount)
			{
				continue;
			}
			int num2 = collection.Count - AiHelper.FixedActionConstants.NpcGroupSoftMaxCount;
			list.Clear();
			foreach (int item in collection)
			{
				if (item == num)
				{
					continue;
				}
				Character character = _objects[item];
				if (canBeRemovedFromGroup.Match(character))
				{
					RelatedCharacter relation = GetRelation(item, num);
					if (!RelationType.HasRelation(relation.RelationType, 1024) && !RelationType.ContainParentRelations(relation.RelationType))
					{
						list.Add(((long)relation.Favorability << 32) + item);
					}
				}
			}
			if (list.Count <= num2)
			{
				num2 = list.Count;
			}
			else
			{
				list.Sort();
			}
			if (num2 > 0)
			{
				CharacterSet value2 = default(CharacterSet);
				for (int i = 0; i < num2; i++)
				{
					long num3 = list[i];
					int charId = (int)num3;
					value2.Add(charId);
				}
				if (value2.GetCount() > 0)
				{
					dictionary.Add(num, value2);
				}
			}
		}
		foreach (KeyValuePair<int, CharacterSet> item2 in dictionary)
		{
			item2.Deconstruct(out key, out value);
			int key2 = key;
			CharacterSet characterSet2 = value;
			CharacterSet characterSet3 = _characterGroups[key2];
			foreach (int item3 in characterSet2.GetCollection())
			{
				LeaveGroup(context, _objects[item3]);
				if (characterSet3.GetCount() <= AiHelper.FixedActionConstants.NpcGroupSoftMaxCount)
				{
					break;
				}
			}
		}
		ObjectPool<List<long>>.Instance.Return(list);
	}

	public int GetCharacterWisdomCount(int characterId)
	{
		return GetElement_Objects(characterId).GetFeatureMedalValue(2);
	}

	public int GetCharactersWisdomCount(IEnumerable<int> characterIds)
	{
		return characterIds.Sum((Func<int, int>)GetCharacterWisdomCount);
	}

	[DomainMethod]
	public int GetCharacterWisdomCountById(int characterId)
	{
		return GetCharacterWisdomCount(characterId);
	}

	[DomainMethod]
	public int GetCharacterListWisdomCount(List<int> charIdList)
	{
		int characterId = charIdList[0];
		charIdList.RemoveAll((int id) => id < 0);
		int num = DomainManager.Character.GetCharacterWisdomCount(characterId) * (4 - (charIdList.Count - 1));
		for (int num2 = 1; num2 < charIdList.Count; num2++)
		{
			num += DomainManager.Character.GetCharacterWisdomCount(charIdList[num2]);
		}
		return num;
	}

	[DomainMethod]
	public List<int> GetCharacterWisdomList(List<int> charIdList)
	{
		List<int> list = new List<int>();
		int characterId = charIdList[0];
		list.Add(DomainManager.Character.GetCharacterWisdomCount(characterId) * (4 - (charIdList.Count - 1)));
		for (int i = 1; i < charIdList.Count; i++)
		{
			list.Add(Character.IsCharacterIdValid(charIdList[i]) ? DomainManager.Character.GetCharacterWisdomCount(charIdList[i]) : 0);
		}
		return list;
	}

	public int CreateNonIntelligentCharacter(DataContext context, short templateId)
	{
		CharacterItem characterItem = Config.Character.Instance[templateId];
		byte creatingType = characterItem.CreatingType;
		if (creatingType == 0 && DomainManager.Character.TryGetFixedCharacterByTemplateId(templateId, out var character))
		{
			return character.GetId();
		}
		if (1 == 0)
		{
		}
		Character character2 = creatingType switch
		{
			0 => DomainManager.Character.CreateFixedCharacter(context, templateId), 
			2 => DomainManager.Character.CreateRandomEnemy(context, templateId), 
			3 => DomainManager.Character.CreateFixedEnemy(context, templateId), 
			_ => throw new ArgumentOutOfRangeException("templateId", $"character with template id {templateId} is neither fixed character nor random enemy"), 
		};
		if (1 == 0)
		{
		}
		Character character3 = character2;
		int id = character3.GetId();
		DomainManager.Character.CompleteCreatingCharacter(id);
		DomainManager.Adventure.AddTemporaryEnemyId(id);
		if (creatingType == 2)
		{
			sbyte percentProb = 50;
			Location location = DomainManager.Taiwu.GetTaiwu().GetLocation();
			if (location.IsValid() && (characterItem.OrganizationInfo.OrgTemplateId == 17 || characterItem.OrganizationInfo.OrgTemplateId == 18) && context.Random.CheckPercentProb(percentProb))
			{
				HashSet<int> hashSet = ObjectPool<HashSet<int>>.Instance.Get();
				DomainManager.Extra.GetLegendaryBookConsumedCharacters(hashSet);
				for (sbyte b = 0; b < 14; b++)
				{
					int owner = DomainManager.LegendaryBook.GetOwner(b);
					if (owner >= 0 && DomainManager.Character.TryGetElement_Objects(owner, out var element) && element.GetLegendaryBookOwnerState() >= 1 && element.GetLocation().AreaId == location.AreaId)
					{
						character3.AddFeature(context, 340);
						break;
					}
				}
				ObjectPool<HashSet<int>>.Instance.Return(hashSet);
			}
			short curAdventureId = DomainManager.Adventure.GetCurAdventureId();
			if (curAdventureId >= 0 && DomainManager.Adventure.AdventureCfg.Type == 4)
			{
				sbyte enemyNestTemplateId = AdventureDomain.GetEnemyNestTemplateId(curAdventureId);
				if (enemyNestTemplateId >= 0 && EnemyNest.Instance[enemyNestTemplateId].Leader == templateId)
				{
					character3.AddFeature(context, 403);
				}
			}
		}
		return id;
	}

	public bool HasGroup(int charId)
	{
		CharacterSet value;
		return TryGetElement_CharacterGroups(charId, out value) && value.GetCount() > 1;
	}

	private static void InitializeRandomEnemyCharTemplateCache()
	{
		_randomEnemyCharTemplateCache = new Dictionary<sbyte, List<short>[]>();
		HashSet<short> hashSet = new HashSet<short>();
		foreach (EnemyNestItem item in (IEnumerable<EnemyNestItem>)EnemyNest.Instance)
		{
			if (item.Members != null)
			{
				hashSet.UnionWith(item.Members);
			}
		}
		foreach (CharacterItem item2 in (IEnumerable<CharacterItem>)Config.Character.Instance)
		{
			if (item2.CreatingType == 2 && ((item2.OrganizationInfo.OrgTemplateId != 18 && item2.OrganizationInfo.OrgTemplateId != 17) || hashSet.Contains(item2.TemplateId)))
			{
				List<short>[] array;
				if (!_randomEnemyCharTemplateCache.ContainsKey(item2.OrganizationInfo.OrgTemplateId))
				{
					array = new List<short>[9];
					_randomEnemyCharTemplateCache.Add(item2.OrganizationInfo.OrgTemplateId, array);
				}
				else
				{
					array = _randomEnemyCharTemplateCache[item2.OrganizationInfo.OrgTemplateId];
				}
				List<short>[] array2 = array;
				int grade = item2.OrganizationInfo.Grade;
				if (array2[grade] == null)
				{
					array2[grade] = new List<short>();
				}
				array[item2.OrganizationInfo.Grade].Add(item2.TemplateId);
			}
		}
	}

	public static short GetRandomEnemyCharTemplateId(IRandomSource random, sbyte orgTemplateId, sbyte expectedGrade)
	{
		if (!_randomEnemyCharTemplateCache.TryGetValue(orgTemplateId, out var value))
		{
			return -1;
		}
		for (sbyte b = expectedGrade; b >= 0; b--)
		{
			if (value[b] != null && value[b].Count > 0)
			{
				return value[b].GetRandom(random);
			}
		}
		return -1;
	}

	public void CreatePregeneratedCityTownGuards(DataContext context)
	{
		for (sbyte b = 0; b < 16; b++)
		{
			for (sbyte b2 = 0; b2 < 9; b2++)
			{
				short templateId = PregenerateHereticTemplateIds[b2];
				Character character = CreateRandomEnemy(context, templateId);
				int num = CalcPregeneratedCityTownGuardIndex(b, isHeretic: true, b2);
				_pregeneratedCityTownGuards[num] = character.GetId();
				CompleteCreatingCharacter(character.GetId());
				short templateId2 = PregenerateRighteousTemplateIds[b2];
				Character character2 = CreateRandomEnemy(context, templateId2);
				int num2 = CalcPregeneratedCityTownGuardIndex(b, isHeretic: false, b2);
				_pregeneratedCityTownGuards[num2] = character2.GetId();
				CompleteCreatingCharacter(character2.GetId());
			}
		}
		SetPregeneratedCityTownGuards(_pregeneratedCityTownGuards, context);
	}

	public void CreatePregeneratedRandomEnemies(DataContext context)
	{
		_pregeneratedRandomEnemies.Clear();
		for (int i = 0; i < RandomEnemy.Instance.Count; i++)
		{
			_pregeneratedRandomEnemies.Add(-1);
		}
		for (short num = 0; num < Config.Character.Instance.Count; num++)
		{
			CharacterItem characterItem = Config.Character.Instance[num];
			if (characterItem.RandomEnemyId >= 0)
			{
				Character character = CreateRandomEnemy(context, num);
				_pregeneratedRandomEnemies[characterItem.RandomEnemyId] = character.GetId();
				CompleteCreatingCharacter(character.GetId());
			}
		}
		SetPregeneratedRandomEnemies(_pregeneratedRandomEnemies, context);
	}

	private void ComplementPregeneratedRandomEnemies(DataContext context, DataUid uid)
	{
		int count = _pregeneratedRandomEnemies.Count;
		for (int i = count; i < RandomEnemy.Instance.Count; i++)
		{
			_pregeneratedRandomEnemies.Add(-1);
		}
		for (short num = 0; num < Config.Character.Instance.Count; num++)
		{
			CharacterItem characterItem = Config.Character.Instance[num];
			if (characterItem.RandomEnemyId >= count)
			{
				Logger.Info($"Complement pregenerated random enemy: {characterItem.Surname}{characterItem.GivenName}({characterItem.TemplateId})");
				Character character = CreateRandomEnemy(context, num);
				_pregeneratedRandomEnemies[characterItem.RandomEnemyId] = character.GetId();
				CompleteCreatingCharacter(character.GetId());
			}
		}
		DomainManager.Extra.CreatePregeneratedFixedEnemies(context);
		SetPregeneratedRandomEnemies(_pregeneratedRandomEnemies, context);
		RemovePostModificationHandler(uid, "ComplementPregeneratedRandomEnemies");
	}

	public Character GetPregeneratedRandomEnemy(short randomEnemyTemplateId)
	{
		int key = _pregeneratedRandomEnemies[randomEnemyTemplateId];
		return _objects[key];
	}

	public Character GetPregeneratedCityTownGuard(sbyte stateTemplateId, bool isHeretic, sbyte grade)
	{
		int num = CalcPregeneratedCityTownGuardIndex(stateTemplateId, isHeretic, grade);
		int key = _pregeneratedCityTownGuards[num];
		return _objects[key];
	}

	private int CalcPregeneratedCityTownGuardIndex(sbyte stateTemplateId, bool isHeretic, sbyte grade)
	{
		int num = ((!isHeretic) ? 1 : 0);
		int num2 = stateTemplateId * 2 * 9;
		return num2 + num * 9 + grade;
	}

	public void GetGuards(DataContext context, Character character, ref SpanList<short> templateIds)
	{
		if (DomainManager.Merchant.TryGetMerchantData(character.GetId(), out var value) && value.MerchantTemplateId >= 0)
		{
			templateIds.AddRangeSafe(value.MerchantConfig.Guards);
			return;
		}
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		short minionGroupId = OrganizationDomain.GetOrgMemberConfig(organizationInfo).MinionGroupId;
		if (minionGroupId >= 0)
		{
			List<short> minions = MinionGroup.Instance[minionGroupId].Minions;
			templateIds.AddRangeSafe(minions);
		}
		else
		{
			if (character.GetCreatingType() != 1)
			{
				return;
			}
			sbyte fameType = character.GetFameType();
			if (fameType == -2)
			{
				int num = 0;
				bool flag = context.Random.NextBool();
				List<FameActionRecord> fameActionRecords = character.GetFameActionRecords();
				foreach (FameActionRecord item in fameActionRecords)
				{
					if (flag == item.Value > 0)
					{
						num += item.Value;
					}
				}
				fameType = FameType.GetFameType((sbyte)Math.Clamp(num, -100, 100));
			}
			int num2 = Math.Clamp(organizationInfo.Grade + Math.Abs(fameType - 3), 0, 8);
			if (fameType < 3)
			{
				templateIds.Add(PregenerateHereticTemplateIds[num2]);
			}
			else
			{
				templateIds.Add(PregenerateRighteousTemplateIds[num2]);
			}
		}
	}

	[Obsolete]
	public void GetGuardTemplateIds(DataContext context, Character character, List<short> templateIds)
	{
		Span<short> span = stackalloc short[3];
		SpanList<short> templateIds2 = span;
		GetGuards(context, character, ref templateIds2);
	}

	public bool HasGuard(int charId, Character character)
	{
		if (character.IsCompletelyInfected())
		{
			return !_unguardedChars.Contains(charId);
		}
		if (character.GetKidnapperId() >= 0)
		{
			return false;
		}
		if (character.GetSrcCharId() == DomainManager.Taiwu.GetTaiwuCharId())
		{
			return false;
		}
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		if (organizationInfo.SettlementId < 0 || organizationInfo.OrgTemplateId == 16)
		{
			return false;
		}
		Settlement settlement = DomainManager.Organization.GetSettlement(organizationInfo.SettlementId);
		if (settlement.GetLocation().AreaId >= 45)
		{
			return false;
		}
		return !_unguardedChars.Contains(charId);
	}

	public void LoseGuard(DataContext context, int charId, Character character)
	{
		_unguardedChars.Add(charId);
		SetUnguardedChars(_unguardedChars, context);
	}

	public void OfflineLoseGuard(int charId, Character character)
	{
		_unguardedChars.Add(charId);
	}

	public void RecoverGuards(DataContext context)
	{
		_unguardedChars.Clear();
		SetUnguardedChars(_unguardedChars, context);
	}

	public static bool TemplateIdIsRighteous(short templateId)
	{
		return PregenerateRighteousTemplateIds.Contains(templateId);
	}

	private void InitializeInfantMap()
	{
		_infantMap = new Dictionary<int, int>();
		foreach (KeyValuePair<int, Character> @object in _objects)
		{
			if (@object.Value.GetAgeGroup() == 0 && @object.Value.GetCreatingType() == 1)
			{
				_infantMap[@object.Key] = -1;
			}
		}
	}

	public void AddInfant(int id)
	{
		_infantMap[id] = -1;
	}

	public void RemoveInfant(int id)
	{
		_infantMap.Remove(id);
	}

	public void MarkInfantAsAdopted(int id)
	{
		_infantMap[id] = -2;
	}

	public bool InfantHasPotentialAdopter(int id)
	{
		int value;
		return _infantMap.TryGetValue(id, out value) && value != -1;
	}

	public bool IsCharacterPotentialInfantAdopter(int infantId, int charId)
	{
		int value;
		return _infantMap.TryGetValue(infantId, out value) && value == charId;
	}

	public bool IsInfantInMap(int id)
	{
		return _infantMap.ContainsKey(id);
	}

	public void AddPotentialAdopterToInfant(int infant, int adopter)
	{
		_infantMap[infant] = adopter;
	}

	public void RemovePotentialAdopterToInfant(int infant)
	{
		_infantMap[infant] = -1;
	}

	private void InitializeInfectedCharSet()
	{
		_infectedCharSet = new HashSet<int>();
		foreach (KeyValuePair<int, Character> @object in _objects)
		{
			if (@object.Value.IsCompletelyInfected())
			{
				_infectedCharSet.Add(@object.Key);
			}
		}
	}

	public void AddInfectedCharToSet(int charId)
	{
		_infectedCharSet.Add(charId);
	}

	public void RemoveInfectedCharFromSet(int charId)
	{
		_infectedCharSet.Remove(charId);
	}

	public void UpdateInfectedCharacterActions(DataContext context)
	{
		if (_infectedCharSet.Count == 0)
		{
			return;
		}
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		TakeRevengeAction takeRevengeAction = new TakeRevengeAction();
		CharacterMatcherItem canPerformInfectedAction = CharacterMatcher.DefValue.CanPerformInfectedAction;
		CharacterMatcherItem canBeAttackedByInfectedCharacter = CharacterMatcher.DefValue.CanBeAttackedByInfectedCharacter;
		foreach (int item in _infectedCharSet)
		{
			Character character = _objects[item];
			if (IsLockMovementChar(item) || !canPerformInfectedAction.Match(character))
			{
				continue;
			}
			Location location2 = character.GetLocation();
			if (!location2.IsValid())
			{
				continue;
			}
			MapBlockData block = DomainManager.Map.GetBlock(location2);
			if (block.InfectedCharacterSet == null || !block.InfectedCharacterSet.Contains(item))
			{
				continue;
			}
			int num = -1;
			if (location2.Equals(location))
			{
				num = taiwu.GetId();
			}
			else
			{
				if (block.CharacterSet == null)
				{
					continue;
				}
				List<int> obj = context.AdvanceMonthRelatedData.CharIdList.Occupy();
				obj.Clear();
				foreach (int item2 in block.CharacterSet)
				{
					if (canBeAttackedByInfectedCharacter.Match(_objects[item2]))
					{
						obj.Add(item2);
					}
				}
				num = obj.GetRandomOrDefault(context.Random, -1);
				context.AdvanceMonthRelatedData.CharIdList.Release(ref obj);
				if (num < 0)
				{
					continue;
				}
			}
			takeRevengeAction.Target = new NpcTravelTarget(num, 1);
			takeRevengeAction.Execute(context, character);
		}
	}

	[Obsolete]
	public void SetCharacterInfectionValue(Character character, byte infectionValue, DataContext context)
	{
		character.SetXiangshuInfection(infectionValue, context);
		character.UpdateXiangshuInfectionState(context);
	}

	public int GetSpiritualDebtChangeByInfected(Character character, int valueChange = 100)
	{
		sbyte grade = character.GetOrganizationInfo().Grade;
		return ((grade + 1) * (grade + 1) + 4) * 10 * valueChange / 100;
	}

	[DomainMethod]
	public CharacterLoveAndHateItemInfo GetCharacterLoveAndHateItemInfo(DataContext context, int charId)
	{
		CharacterLoveAndHateItemInfo characterLoveAndHateItemInfo = null;
		if (TryGetElement_Objects(charId, out var element))
		{
			sbyte favorabilityType = FavorabilityType.GetFavorabilityType(DomainManager.Character.GetFavorability(charId, DomainManager.Taiwu.GetTaiwuCharId()));
			if (favorabilityType >= 3 && IsInteractedWithTaiwu(charId))
			{
				element.SetLovingItemRevealed(lovingItemRevealed: true, context);
				element.SetHatingItemRevealed(hatingItemRevealed: true, context);
			}
			characterLoveAndHateItemInfo = new CharacterLoveAndHateItemInfo();
			characterLoveAndHateItemInfo.CharacterId = charId;
			characterLoveAndHateItemInfo.CreatingType = element.GetCreatingType();
			characterLoveAndHateItemInfo.LovingItemSubType = element.GetLovingItemSubType();
			characterLoveAndHateItemInfo.LovingItemRevealed = element.GetLovingItemRevealed();
			characterLoveAndHateItemInfo.HatingItemSubType = element.GetHatingItemSubType();
			characterLoveAndHateItemInfo.HatingItemRevealed = element.GetHatingItemRevealed();
			characterLoveAndHateItemInfo.HobbyExpirationDate = element.GetHobbyExpirationDate();
			characterLoveAndHateItemInfo.NeedShowFirstRevealLovingEffect = characterLoveAndHateItemInfo.LovingItemRevealed && !DomainManager.Extra.IsCharacterLovingItemRevealed(charId);
			characterLoveAndHateItemInfo.NeedShowFirstRevealHatingEffect = characterLoveAndHateItemInfo.HatingItemRevealed && !DomainManager.Extra.IsCharacterHatingItemRevealed(charId);
		}
		return characterLoveAndHateItemInfo;
	}

	[DomainMethod]
	public void TransferResourcesWithDebt(DataContext context, int srcCharId, int destCharId, ResourceInts resources, bool checkFavorability)
	{
		Character element_Objects = GetElement_Objects(srcCharId);
		Character element_Objects2 = GetElement_Objects(destCharId);
		if (element_Objects.GetCreatingType() == 1 && element_Objects2.GetCreatingType() == 1)
		{
			UpdateDebtByResourceTransfer(context, element_Objects, element_Objects2, resources, changeFavor: true);
		}
		TransferResource(context, element_Objects, element_Objects2, ref resources);
	}

	public void UpdateDebtByResourceTransfer(DataContext context, Character srcChar, Character destChar, ResourceInts resources, bool changeFavor)
	{
		int id = destChar.GetId();
		int id2 = srcChar.GetId();
		Tester.Assert(id2 != id);
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		Character character = destChar;
		if (id == taiwuCharId)
		{
			character = srcChar;
			resources = resources.GetReversed();
		}
		else if (id2 != taiwuCharId)
		{
			throw new Exception($"Neither party is taiwu: {id2}, {id}");
		}
		if (character.GetCreatingType() != 1)
		{
			return;
		}
		short num;
		short num2;
		if (changeFavor)
		{
			(num, num2) = GetFavorAndMaxFavorToTaiwu(character);
		}
		else
		{
			num = 0;
			num2 = 0;
		}
		var (num3, num4) = GetResourcesWorth(ref resources);
		if (num4 != 0)
		{
			LendResourceToTaiwu(context, character, num4);
			if (changeFavor)
			{
				short resourceFavorabilityChange = AiHelper.GeneralActionConstants.GetResourceFavorabilityChange(6, (int)Math.Clamp(num4, 0L, 2147483647L));
				Character taiwu = DomainManager.Taiwu.GetTaiwu();
				ChangeFavorabilityOptionalGiftItem(context, character, taiwu, -resourceFavorabilityChange);
			}
		}
		if (num3 != 0)
		{
			BorrowResourceFromTaiwu(context, character, num3);
			if (changeFavor)
			{
				short resourceFavorabilityChange2 = AiHelper.GeneralActionConstants.GetResourceFavorabilityChange(6, (int)Math.Clamp(num3, 0L, 2147483647L));
				Character taiwu2 = DomainManager.Taiwu.GetTaiwu();
				ChangeFavorabilityOptionalGiftItem(context, character, taiwu2, resourceFavorabilityChange2);
			}
		}
		if (changeFavor && !CheckFavorabilityAfterTransferring(character, num, num2))
		{
			var (value, value2) = GetFavorAndMaxFavorToTaiwu(character);
			Logger.Warn($"CheckFavorabilityAfterTransferring failed. Related character: {id}, oriFavor: {num}, oriMaxFavor: {num2}borrowedWorth: {num3}, lentWorth: {num4}currFavor: {value}, currMaxFavor: {value2}");
		}
	}

	public void TransferResource(DataContext context, Character srcChar, Character destChar, sbyte resourceType, int amount)
	{
		Tester.Assert(srcChar.GetId() != destChar.GetId());
		Tester.Assert(resourceType >= 0 && resourceType < 8);
		Tester.Assert(amount > 0);
		srcChar.ChangeResource(context, resourceType, -amount);
		destChar.ChangeResource(context, resourceType, amount);
	}

	public void TransferResource(DataContext context, Character srcChar, Character destChar, ref ResourceInts resources)
	{
		Tester.Assert(srcChar.GetId() != destChar.GetId());
		destChar.ChangeResources(context, ref resources);
		resources = resources.GetReversed();
		srcChar.ChangeResources(context, ref resources);
	}

	[DomainMethod]
	public void TransferInventoryItemWithDebt(DataContext context, int srcCharId, int destCharId, ItemKey itemKey, int amount, bool checkFavorability)
	{
		Character element_Objects = DomainManager.Character.GetElement_Objects(srcCharId);
		Character element_Objects2 = DomainManager.Character.GetElement_Objects(destCharId);
		ClearItemUsingState(context, itemKey, srcCharId);
		TransferInventoryItem(context, element_Objects, element_Objects2, itemKey, amount);
		if (element_Objects2.GetCreatingType() == 1 && element_Objects.GetCreatingType() == 1)
		{
			UpdateDebtByItemTransfer(context, element_Objects, element_Objects2, itemKey, amount, changeFavor: true);
		}
		InteractOfLove.SetLoveTokenHolder(context, itemKey, destCharId);
	}

	public void UpdateDebtByItemTransfer(DataContext context, Character srcChar, Character destChar, ItemKey itemKey, int amount, bool changeFavor)
	{
		int id = destChar.GetId();
		int id2 = srcChar.GetId();
		Tester.Assert(id2 != id);
		Tester.Assert(amount > 0);
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Character character = destChar;
		if (id == taiwuCharId)
		{
			character = srcChar;
			amount = -amount;
		}
		else if (id2 != taiwuCharId)
		{
			throw new Exception($"Neither party is taiwu: {id2}, {id}");
		}
		if (character.GetCreatingType() == 1)
		{
			short num;
			short num2;
			if (changeFavor)
			{
				(num, num2) = GetFavorAndMaxFavorToTaiwu(character);
			}
			else
			{
				num = 0;
				num2 = 0;
			}
			if (amount >= 0)
			{
				BorrowItemFromTaiwu(context, character, itemKey, amount);
			}
			else
			{
				LendItemToTaiwu(context, character, itemKey, -amount);
			}
			if (changeFavor)
			{
				ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey);
				int baseDelta = baseItem.GetFavorabilityChange() * amount;
				ChangeFavorabilityOptionalGiftItem(context, character, taiwu, baseDelta);
			}
			if (changeFavor && !CheckFavorabilityAfterTransferring(character, num, num2))
			{
				var (value, value2) = GetFavorAndMaxFavorToTaiwu(character);
				Logger.Warn($"CheckFavorabilityAfterTransferring failed. Related character: {id}, oriFavor: {num}, oriMaxFavor: {num2},currFavor: {value}, currMaxFavor: {value2}");
			}
		}
	}

	[DomainMethod]
	public void TransferInventoryItemListWithDebt(DataContext context, int srcCharId, int destCharId, List<ItemKey> keyList, bool checkFavorability)
	{
		Tester.Assert(srcCharId != destCharId);
		Tester.Assert(keyList != null);
		Tester.Assert(keyList.Count > 0);
		foreach (ItemKey key in keyList)
		{
			TransferInventoryItemWithDebt(context, srcCharId, destCharId, key, 1, checkFavorability);
		}
	}

	public void TransferInventoryItem(DataContext context, Character srcChar, Character destChar, ItemKey itemKey, int amount)
	{
		int id = srcChar.GetId();
		int id2 = destChar.GetId();
		Tester.Assert(id != id2);
		bool flag = !DomainManager.Taiwu.IsInGroup(id) || !DomainManager.Taiwu.IsInGroup(id2);
		srcChar.RemoveInventoryItem(context, itemKey, amount, deleteItem: false);
		destChar.AddInventoryItem(context, itemKey, amount);
		if (srcChar == DomainManager.Taiwu.GetTaiwu())
		{
			DomainManager.Extra.RecordTaiwuGiftItem(context, id2, itemKey, amount);
		}
	}

	[DomainMethod]
	public void TransferInventoryItemFromAToB(DataContext context, int charA, int charB, ItemKey itemKey, int amount)
	{
		Tester.Assert(charA >= 0 && charB >= 0);
		Tester.Assert(charA != charB);
		Character srcChar = _objects[charA];
		Character destChar = _objects[charB];
		TransferInventoryItem(context, srcChar, destChar, itemKey, amount);
	}

	public void TransferInventoryItemList(DataContext context, Character srcChar, Character destChar, List<ItemKey> keyList)
	{
		Tester.Assert(srcChar.GetId() != destChar.GetId());
		Tester.Assert(keyList != null);
		Tester.Assert(keyList.Count > 0);
		foreach (ItemKey key in keyList)
		{
			TransferInventoryItem(context, srcChar, destChar, key, 1);
		}
	}

	[DomainMethod]
	public void ChangeEquipment(DataContext context, int charId, sbyte srcSlot, sbyte destSlot, ItemKey srcItemKey)
	{
		Character element_Objects = GetElement_Objects(charId);
		element_Objects.ChangeEquipment(context, srcSlot, destSlot, srcItemKey);
	}

	[DomainMethod]
	public void CreateInventoryItem(DataContext context, int charId, sbyte itemType, short templateId, int amount)
	{
		Character element_Objects = GetElement_Objects(charId);
		element_Objects.CreateInventoryItem(context, itemType, templateId, amount);
	}

	[DomainMethod]
	public List<ItemDisplayData> GetInventoryItems(int charId, short itemSubType)
	{
		Character element_Objects = GetElement_Objects(charId);
		List<(ItemKey, int)> items = new List<(ItemKey, int)>();
		CharacterItemFilterWrappers.FindByItemSubType(element_Objects, itemSubType, items, searchInventory: true, searchEquipment: false);
		return GetItemDisplayData(charId, items, ItemSourceType.Inventory);
	}

	[DomainMethod]
	public List<ItemDisplayData> GetInventoryItemsByItemType(int charId, sbyte itemType)
	{
		Character element_Objects = GetElement_Objects(charId);
		List<(ItemKey, int)> items = new List<(ItemKey, int)>();
		CharacterItemFilterWrappers.FindByItemType(element_Objects, itemType, items, searchInventory: true, searchEquipment: false);
		return GetItemDisplayData(charId, items, ItemSourceType.Inventory);
	}

	[DomainMethod]
	public List<ItemDisplayData> GetInventoryEquipment(int charId)
	{
		Character element_Objects = GetElement_Objects(charId);
		List<(ItemKey, int)> items = new List<(ItemKey, int)>();
		CharacterItemFilterWrappers.FindEquipment(element_Objects, items, searchInventory: true, searchEquipment: false);
		return GetItemDisplayData(charId, items, ItemSourceType.Inventory);
	}

	[DomainMethod]
	public List<ItemDisplayData> GetAllInventoryItems(int charId)
	{
		Character element_Objects = GetElement_Objects(charId);
		Inventory inventory = element_Objects.GetInventory();
		return GetItemDisplayData(charId, inventory.Items, ItemSourceType.Inventory);
	}

	[DomainMethod]
	public List<ItemDisplayData> GetAllInventoryItemsExcludeValueZero(int charId)
	{
		Character element_Objects = GetElement_Objects(charId);
		Inventory inventory = element_Objects.GetInventory();
		Dictionary<ItemKey, int> dictionary = ObjectPool<Dictionary<ItemKey, int>>.Instance.Get();
		dictionary.Clear();
		foreach (KeyValuePair<ItemKey, int> item in inventory.Items)
		{
			if (DomainManager.Item.GetBaseItem(item.Key).GetValue() > 0)
			{
				dictionary.Add(item.Key, item.Value);
			}
		}
		List<ItemDisplayData> itemDisplayData = GetItemDisplayData(charId, dictionary, ItemSourceType.Inventory);
		ObjectPool<Dictionary<ItemKey, int>>.Instance.Return(dictionary);
		return itemDisplayData;
	}

	[DomainMethod]
	public int GetInventoryItemAmount(int charId, sbyte itemType, short templateId)
	{
		Character element_Objects = GetElement_Objects(charId);
		List<(ItemKey, int)> list = new List<(ItemKey, int)>();
		CharacterItemFilterWrappers.FindByTemplateId(element_Objects, itemType, templateId, list, searchInventory: true, searchEquipment: false);
		int num = 0;
		int i = 0;
		for (int count = list.Count; i < count; i++)
		{
			num += list[i].Item2;
		}
		return num;
	}

	[DomainMethod]
	public List<ItemDisplayData> GetAllEquipmentItems(int charId)
	{
		List<ItemDisplayData> list = new List<ItemDisplayData>();
		ItemDisplayData itemDisplayData = null;
		if (TryGetElement_Objects(charId, out var element))
		{
			ItemKey[] equipment = element.GetEquipment();
			ItemKey[] array = equipment;
			for (int i = 0; i < array.Length; i++)
			{
				ItemKey itemKey = array[i];
				if (itemKey.IsValid())
				{
					list.Add(DomainManager.Item.GetItemDisplayData(DomainManager.Item.GetBaseItem(itemKey), 1, charId, 0));
				}
				else
				{
					list.Add(itemDisplayData ?? (itemDisplayData = new ItemDisplayData()));
				}
			}
		}
		else
		{
			for (int j = 0; j < 12; j++)
			{
				list.Add(itemDisplayData ?? (itemDisplayData = new ItemDisplayData()));
			}
		}
		return list;
	}

	[DomainMethod]
	public ItemDisplayData GetInventoryItemDisplayData(int charId, ItemKey itemKey)
	{
		ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey);
		return DomainManager.Item.GetItemDisplayData(baseItem, GetElement_Objects(charId).GetInventory().Items[itemKey], charId, 1);
	}

	[DomainMethod]
	public bool InventoryContainsItem(int charId, ItemKey itemKey)
	{
		Character element_Objects = GetElement_Objects(charId);
		Inventory inventory = element_Objects.GetInventory();
		return inventory.Items.ContainsKey(itemKey);
	}

	public bool[] GetCharBookReadState(int charId, ItemKey bookItemKey)
	{
		Character element_Objects = GetElement_Objects(charId);
		GameData.Domains.Item.SkillBook element_SkillBooks = DomainManager.Item.GetElement_SkillBooks(bookItemKey.Id);
		bool flag = SkillGroup.FromItemSubType(element_SkillBooks.GetItemSubType()) == 0;
		bool[] array = new bool[flag ? 5 : 6];
		if (flag)
		{
			short lifeSkillTemplateId = element_SkillBooks.GetLifeSkillTemplateId();
			int num = element_Objects.FindLearnedLifeSkillIndex(lifeSkillTemplateId);
			if (num >= 0)
			{
				LifeSkillItem lifeSkillItem = element_Objects.GetLearnedLifeSkills()[num];
				for (byte b = 0; b < 5; b++)
				{
					array[b] = lifeSkillItem.IsPageRead(b);
				}
			}
		}
		else
		{
			short combatSkillTemplateId = element_SkillBooks.GetCombatSkillTemplateId();
			if (DomainManager.CombatSkill.TryGetElement_CombatSkills(new CombatSkillKey(charId, combatSkillTemplateId), out var element))
			{
				byte pageTypes = element_SkillBooks.GetPageTypes();
				sbyte outlinePageType = SkillBookStateHelper.GetOutlinePageType(pageTypes);
				ushort readingState = element.GetReadingState();
				for (byte b2 = 0; b2 < 6; b2++)
				{
					sbyte normalPageType = SkillBookStateHelper.GetNormalPageType(pageTypes, b2);
					array[b2] = CombatSkillStateHelper.IsPageRead(readingState, CombatSkillStateHelper.GetPageInternalIndex(outlinePageType, normalPageType, b2));
				}
			}
		}
		return array;
	}

	[DomainMethod]
	public void AddEatingItem(DataContext context, int charId, ItemKey itemKey, List<sbyte> targetBodyParts = null)
	{
		Character element_Objects = GetElement_Objects(charId);
		element_Objects.RemoveInventoryItem(context, itemKey, 1, deleteItem: false);
		element_Objects.AddEatingItem(context, itemKey, targetBodyParts);
	}

	[DomainMethod]
	public SimulateEatingEffectResult SimulateEatingEffect(DataContext context, int charId, ItemKey itemKey, int amount)
	{
		if (!_objects.TryGetValue(charId, out var value))
		{
			return null;
		}
		PoisonInts poison = default(PoisonInts);
		poison.Add(ref value.GetPoisoned());
		Injuries injuries = default(Injuries);
		injuries.Initialize();
		injuries.Change(value.GetInjuries());
		short disorderOfQi = value.GetDisorderOfQi();
		short health = value.GetHealth();
		SimulateEatingEffectResult simulateEatingEffectResult = new SimulateEatingEffectResult();
		switch (itemKey.ItemType)
		{
		case 9:
		{
			int delta = Config.TeaWine.Instance[itemKey.TemplateId].DirectChangeOfQiDisorder * amount;
			(int max, int min) tuple = CFormula.RandomCalcDisorderOfQiRange(delta);
			int item = tuple.max;
			int item2 = tuple.min;
			item = value.CalcDisorderOfQiDelta(item);
			item2 = value.CalcDisorderOfQiDelta(item2);
			int val = Math.Clamp(disorderOfQi + item, 0, DisorderLevelOfQi.MaxValue);
			int val2 = Math.Clamp(disorderOfQi + item2, 0, DisorderLevelOfQi.MaxValue);
			simulateEatingEffectResult.MinDisorderOfQi = Math.Min(val, val2);
			simulateEatingEffectResult.MaxDisorderOfQi = Math.Max(val, val2);
			break;
		}
		case 8:
		{
			MedicineItem medicineItem = Config.Medicine.Instance[itemKey.TemplateId];
			MedicineEatingInstantEffect effect = new MedicineEatingInstantEffect(medicineItem);
			for (int i = 0; i < amount; i++)
			{
				switch (medicineItem.EffectType)
				{
				case EMedicineEffectType.RecoverOuterInjury:
					value.CalcMedicineEffect_RecoverInjury(ref injuries, context.Random, inner: false, ref effect);
					break;
				case EMedicineEffectType.RecoverInnerInjury:
					value.CalcMedicineEffect_RecoverInjury(ref injuries, context.Random, inner: true, ref effect);
					break;
				case EMedicineEffectType.ChangeDisorderOfQi:
					value.CalcMedicineEffect_RecoverDisorderOfQi(ref disorderOfQi, ref effect);
					simulateEatingEffectResult.MaxDisorderOfQi = (simulateEatingEffectResult.MinDisorderOfQi = disorderOfQi);
					break;
				case EMedicineEffectType.RecoverHealth:
					value.CalcMedicineEffect_RecoverHealth(ref health, ref effect);
					break;
				case EMedicineEffectType.DetoxPoison:
					value.CalcMedicineEffect_DetoxPoison(ref poison, ref effect);
					break;
				case EMedicineEffectType.ApplyPoison:
					value.CalcMedicineEffect_ApplyPoison(ref poison, ref effect);
					break;
				}
			}
			break;
		}
		}
		simulateEatingEffectResult.Health = health;
		simulateEatingEffectResult.Poisons = poison;
		simulateEatingEffectResult.Injuries = injuries;
		return simulateEatingEffectResult;
	}

	[DomainMethod]
	public ItemPowerInfo GetItemPowerInfo(int charId, ItemKey itemKey)
	{
		if (!DomainManager.Item.ItemExists(itemKey) || !DomainManager.Character.IsCharacterAlive(charId))
		{
			return ItemPowerInfo.Default;
		}
		return new ItemPowerInfo
		{
			Power = GetItemPower(charId, itemKey),
			MaxPower = GetItemMaxPower(charId, itemKey),
			RequirementsPower = GetItemRequirementsPower(charId, itemKey)
		};
	}

	public static void ClassifyItemsToLose(List<(ItemBase item, int amount)>[] classifiedItems, IReadOnlyDictionary<ItemKey, int> oriItems, bool isTaiwuInventory = false)
	{
		AdvanceMonthRelatedData.Clear(classifiedItems);
		foreach (var (itemKey2, item) in oriItems)
		{
			if (ItemDomain.CanItemBeLost(itemKey2))
			{
				ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey2);
				classifiedItems[baseItem.GetGrade() / 3].Add((baseItem, item));
			}
		}
		if (isTaiwuInventory)
		{
			RemoveTaiwuReadingBookFromClassifiedItems(classifiedItems);
		}
	}

	public static void GetLostItemsByAmount(DataContext context, int amountToLose, Dictionary<ItemKey, int> oriItems, List<(ItemBase item, int amount)> itemsToBeLost, bool isTaiwuInventory = false)
	{
		IRandomSource random = context.Random;
		List<(ItemBase, int)>[] obj = context.AdvanceMonthRelatedData.ClassifiedItems.Occupy();
		ClassifyItemsToLose(obj, oriItems, isTaiwuInventory);
		GetLostItemsByAmount(random, amountToLose, obj, itemsToBeLost);
		context.AdvanceMonthRelatedData.ClassifiedItems.Release(ref obj);
	}

	public static void GetLostItemsByAmount(IRandomSource random, int amountToLose, List<(ItemBase item, int amount)>[] classifiedItems, List<(ItemBase item, int amount)> itemsToBeLost)
	{
		int num = 0;
		int i = 0;
		for (int num2 = classifiedItems.Length; i < num2; i++)
		{
			List<(ItemBase, int)> list = classifiedItems[i];
			while (list.Count > 0 && num < amountToLose)
			{
				int index = random.Next(list.Count);
				(ItemBase, int) tuple = list[index];
				ItemBase item = tuple.Item1;
				int item2 = tuple.Item2;
				int val = ((item2 <= 1) ? 1 : (random.Next(item2) + 1));
				val = Math.Min(val, amountToLose - num);
				itemsToBeLost.Add((item, val));
				if (val >= item2)
				{
					CollectionUtils.SwapAndRemove(list, index);
				}
				else
				{
					list[index] = (item, item2 - val);
				}
				num += val;
			}
		}
	}

	public static void GetLostItemsDueToOverload(DataContext context, int overloadedWeight, IReadOnlyDictionary<ItemKey, int> oriItems, List<(ItemBase item, int amount)> itemsToBeLost, bool isTaiwuInventory = false)
	{
		itemsToBeLost.Clear();
		List<(ItemBase, int)>[] obj = context.AdvanceMonthRelatedData.ClassifiedItems.Occupy();
		ClassifyItemsToLose(obj, oriItems, isTaiwuInventory);
		int singleItemLostWeightLine = Math.Max(overloadedWeight * 20 / 100, 10);
		int num = 0;
		int i = 0;
		for (int num2 = obj.Length; i < num2; i++)
		{
			List<(ItemBase, int)> list = obj[i];
			list.RemoveAll(delegate((ItemBase item, int amount) pair)
			{
				int weight = pair.item.GetWeight();
				return weight > singleItemLostWeightLine || weight == 0;
			});
			list.Sort(((ItemBase, int) itemA, (ItemBase, int) itemB) => itemA.Item1.GetWeight().CompareTo(itemB.Item1.GetWeight()));
			while (list.Count > 0)
			{
				int index = 0;
				(ItemBase, int) tuple = list[index];
				ItemBase item = tuple.Item1;
				int item2 = tuple.Item2;
				int num3 = 1;
				itemsToBeLost.Add((item, num3));
				if (num3 >= item2)
				{
					CollectionUtils.SwapAndRemove(list, index);
				}
				else
				{
					list[index] = (item, item2 - num3);
				}
				num += item.GetWeight() * num3;
				if (num >= singleItemLostWeightLine)
				{
					context.AdvanceMonthRelatedData.ClassifiedItems.Release(ref obj);
					return;
				}
			}
		}
		context.AdvanceMonthRelatedData.ClassifiedItems.Release(ref obj);
	}

	public static void GetItemSubTypeStats(DataContext context, Dictionary<ItemKey, int> inventoryItems, ItemKey[] equipmentItems)
	{
		Dictionary<short, (sbyte, int)> dictionary = context.AdvanceMonthRelatedData.ItemSubTypeStats.Get();
		dictionary.Clear();
		foreach (KeyValuePair<ItemKey, int> inventoryItem in inventoryItems)
		{
			ItemKey key = inventoryItem.Key;
			int num = inventoryItem.Value;
			short itemSubType = ItemTemplateHelper.GetItemSubType(key.ItemType, key.TemplateId);
			sbyte b = ItemTemplateHelper.GetGrade(key.ItemType, key.TemplateId);
			if (dictionary.TryGetValue(itemSubType, out var value))
			{
				b = Math.Max(value.Item1, b);
				num = value.Item2 + num;
			}
			dictionary[itemSubType] = (b, num);
		}
		for (int i = 0; i < equipmentItems.Length; i++)
		{
			ItemKey itemKey = equipmentItems[i];
			if (itemKey.IsValid())
			{
				int num2 = 1;
				short itemSubType2 = ItemTemplateHelper.GetItemSubType(itemKey.ItemType, itemKey.TemplateId);
				sbyte b2 = ItemTemplateHelper.GetGrade(itemKey.ItemType, itemKey.TemplateId);
				if (dictionary.TryGetValue(itemSubType2, out var value2))
				{
					b2 = Math.Max(value2.Item1, b2);
					num2 = value2.Item2 + num2;
				}
				dictionary[itemSubType2] = (b2, num2);
			}
		}
	}

	public static GameData.Domains.Item.Medicine SelectMedicineToUse(DataContext context, EMedicineEffectType effectType, sbyte poisonType, int targetValue)
	{
		List<(GameData.Domains.Item.Medicine, int)>[] array = context.AdvanceMonthRelatedData.CategorizedMedicines.Get();
		int num = int.MaxValue;
		GameData.Domains.Item.Medicine result = null;
		foreach (var (medicine, num2) in array[(int)effectType])
		{
			if (poisonType == medicine.GetEffectSubType().PoisonType() && !ModificationStateHelper.IsActive(medicine.GetModificationState(), 1))
			{
				short effectValue = medicine.GetEffectValue();
				int num3 = effectValue - targetValue;
				num3 *= num3;
				if (num3 < num)
				{
					num = num3;
					result = medicine;
				}
			}
		}
		return result;
	}

	public unsafe void InitializeOwnedItems()
	{
		int value;
		ItemKey key;
		foreach (KeyValuePair<int, Character> @object in _objects)
		{
			@object.Deconstruct(out value, out var value2);
			int ownerId = value;
			Character character = value2;
			Inventory inventory = character.GetInventory();
			foreach (KeyValuePair<ItemKey, int> item in inventory.Items)
			{
				item.Deconstruct(out key, out value);
				ItemKey itemKey = key;
				DomainManager.Item.SetOwner(itemKey, ItemOwnerType.CharacterInventory, ownerId);
			}
			ItemKey[] equipment = character.GetEquipment();
			ItemKey[] array = equipment;
			for (int i = 0; i < array.Length; i++)
			{
				ItemKey itemKey2 = array[i];
				if (itemKey2.IsValid())
				{
					DomainManager.Item.SetOwner(itemKey2, ItemOwnerType.CharacterEquipment, ownerId);
				}
			}
			ref EatingItems eatingItems = ref character.GetEatingItems();
			for (int j = 0; j < 9; j++)
			{
				ItemKey itemKey3 = (ItemKey)eatingItems.ItemKeys[j];
				if (itemKey3.IsValid())
				{
					DomainManager.Item.SetOwner(itemKey3, ItemOwnerType.CharacterEatingItem, ownerId);
				}
			}
		}
		foreach (KeyValuePair<int, Grave> grafe in _graves)
		{
			grafe.Deconstruct(out value, out var value3);
			int ownerId2 = value;
			Grave grave = value3;
			Inventory inventory2 = grave.GetInventory();
			foreach (KeyValuePair<ItemKey, int> item2 in inventory2.Items)
			{
				item2.Deconstruct(out key, out value);
				ItemKey itemKey4 = key;
				DomainManager.Item.SetOwner(itemKey4, ItemOwnerType.Grave, ownerId2);
			}
		}
		foreach (KeyValuePair<int, KidnappedCharacterList> kidnappedChar in _kidnappedChars)
		{
			kidnappedChar.Deconstruct(out value, out var value4);
			int num = value;
			KidnappedCharacterList kidnappedCharacterList = value4;
			List<KidnappedCharacter> collection = kidnappedCharacterList.GetCollection();
			foreach (KidnappedCharacter item3 in collection)
			{
				ItemKey ropeItemKey = item3.RopeItemKey;
				if (ropeItemKey.IsValid())
				{
					DomainManager.Item.SetOwner(ropeItemKey, ItemOwnerType.KidnapperRope, item3.CharId);
				}
			}
		}
	}

	[DomainMethod]
	public sbyte GetCurrMaxEatingSlotsCount(int charId)
	{
		return GetElement_Objects(charId).GetCurrMaxEatingSlotsCount();
	}

	[DomainMethod]
	public int[] GetMixedPoisonTypeRelatedMarkCountArray(int charId)
	{
		Character element_Objects = GetElement_Objects(charId);
		int num = 20;
		int[] array = new int[num];
		for (sbyte b = 0; b < num; b++)
		{
			array[b] = element_Objects.GetMixedPoisonTypeRelatedMarkCount((sbyte)(b + 15));
		}
		return array;
	}

	[DomainMethod]
	public bool MerchantHasNewGoods(int charId)
	{
		if (!DomainManager.Character.TryGetElement_Objects(charId, out var element))
		{
			return false;
		}
		return DomainManager.Merchant.HasNewGoods(element);
	}

	public short GetItemPower(int charId, ItemKey itemKey)
	{
		if (itemKey.ItemType != 0 && itemKey.ItemType != 1)
		{
			throw new Exception($"Cannot get use power of item type {itemKey.ItemType}");
		}
		Character element_Objects = GetElement_Objects(charId);
		int num = ((itemKey.ItemType == 0) ? element_Objects.GetFixWeaponPower() : element_Objects.GetFixArmorPower());
		int value = ((num < 0) ? GetItemRequirementsPower(charId, itemKey) : num);
		if (DomainManager.Combat.IsCharInCombat(charId))
		{
			int orDefault = DomainManager.Combat.EquipmentPowerChangeInCombat.GetOrDefault(charId);
			value = DomainManager.SpecialEffect.ModifyValue(charId, 315, value, itemKey.Id, -1, -1, orDefault);
		}
		return (short)Math.Clamp(value, 0, 9999);
	}

	public short GetItemMaxPower(int charId, ItemKey itemKey)
	{
		if (itemKey.ItemType != 0 && itemKey.ItemType != 1)
		{
			throw new Exception($"Cannot get use power of item type {itemKey.ItemType}");
		}
		int value = CFormula.CalcItemMaxUsePower(GetElement_Objects(charId).GetWeaponSwitchSpeed());
		ushort fieldId = (ushort)((itemKey.ItemType == 0) ? 27 : 30);
		value = DomainManager.SpecialEffect.ModifyValue(charId, fieldId, value, itemKey.Id);
		return (short)Math.Clamp(value, 0, 9999);
	}

	public short GetItemRequirementsPower(int charId, ItemKey itemKey)
	{
		if (itemKey.ItemType != 0 && itemKey.ItemType != 1)
		{
			throw new Exception($"Cannot get use power of item type {itemKey.ItemType}");
		}
		Character element_Objects = GetElement_Objects(charId);
		bool flag = itemKey.ItemType == 0;
		int num = 0;
		List<PropertyAndValue> list = (flag ? Config.Weapon.Instance[itemKey.TemplateId].RequiredCharacterProperties : Config.Armor.Instance[itemKey.TemplateId].RequiredCharacterProperties);
		short itemMaxPower = GetItemMaxPower(charId, itemKey);
		int num2 = 100;
		int count = list.Count;
		if (itemKey.IsValid())
		{
			short equipmentEffectId = DomainManager.Item.GetBaseEquipment(itemKey).GetEquipmentEffectId();
			if (equipmentEffectId >= 0)
			{
				num2 += EquipmentEffect.Instance[equipmentEffectId].RequirementChange;
			}
		}
		num2 += DomainManager.SpecialEffect.GetModifyValue(charId, (ushort)(flag ? 28 : 31), (EDataModifyType)0, -1, -1, -1, (EDataSumType)0);
		if (count > 0)
		{
			for (int i = 0; i < count; i++)
			{
				PropertyAndValue propertyAndValue = list[i];
				if (propertyAndValue.Value > 0)
				{
					int propertyValue = element_Objects.GetPropertyValue((ECharacterPropertyReferencedType)propertyAndValue.PropertyId);
					int num3 = propertyAndValue.Value * num2 / 100;
					num += Math.Min(propertyValue * 100 / num3, itemMaxPower);
				}
			}
			if (count > 1)
			{
				num /= count;
			}
		}
		else
		{
			num = 100;
		}
		return (short)Math.Clamp(num, 0, itemMaxPower);
	}

	public int CalcWeaponChangeTrickValue(int charId, ItemKey itemKey, bool isFirstAttack = true, bool hit = true)
	{
		//IL_005d: Unknown result type (might be due to invalid IL or missing references)
		int num = (isFirstAttack ? GlobalConfig.Instance.FirstAttackAddChangeTrickProgress : GlobalConfig.Instance.PursueAttackAddChangeTrickProgress);
		num = num * GetWeaponChangeTrickPercent(charId, itemKey) / 100;
		if (hit)
		{
			return num;
		}
		GameData.Domains.Item.Weapon element_Weapons = DomainManager.Item.GetElement_Weapons(itemKey.Id);
		sbyte attackPreparePointCost = element_Weapons.GetAttackPreparePointCost();
		int num2 = GlobalConfig.Instance.AvoidChangeTrickProgressPercentByWeapon[attackPreparePointCost];
		return num * CValuePercent.op_Implicit(num2);
	}

	public int GetWeaponChangeTrickPercent(int charId, ItemKey itemKey)
	{
		if (itemKey.ItemType != 0)
		{
			throw new Exception($"Cannot get use ChangeTrickPercent of item type {itemKey.ItemType}");
		}
		short itemPower = GetItemPower(charId, itemKey);
		return Config.Weapon.Instance[itemKey.TemplateId].ChangeTrickPercent * itemPower / 100;
	}

	public List<(int type, int required, int actual)> GetItemRequirementsAndActualValues(int charId, ItemKey itemKey)
	{
		if (itemKey.ItemType != 0 && itemKey.ItemType != 1)
		{
			throw new Exception($"Cannot get use power of item type {itemKey.ItemType}");
		}
		Character character = ((charId >= 0) ? GetElement_Objects(charId) : null);
		List<PropertyAndValue> list = ((itemKey.ItemType == 0) ? Config.Weapon.Instance[itemKey.TemplateId].RequiredCharacterProperties : Config.Armor.Instance[itemKey.TemplateId].RequiredCharacterProperties);
		List<(int, int, int)> list2 = new List<(int, int, int)>();
		int num = 100;
		short equipmentEffectId = DomainManager.Item.GetBaseEquipment(itemKey).GetEquipmentEffectId();
		if (equipmentEffectId >= 0)
		{
			num += EquipmentEffect.Instance[equipmentEffectId].RequirementChange;
		}
		num += DomainManager.SpecialEffect.GetModifyValue(charId, (ushort)((itemKey.ItemType == 0) ? 28 : 31), (EDataModifyType)0, -1, -1, -1, (EDataSumType)0);
		for (int i = 0; i < list.Count; i++)
		{
			PropertyAndValue propertyAndValue = list[i];
			list2.Add((propertyAndValue.PropertyId, propertyAndValue.Value * num / 100, character?.GetPropertyValue((ECharacterPropertyReferencedType)propertyAndValue.PropertyId) ?? 0));
		}
		return list2;
	}

	public void RemoveAllInventoryAndEquippedItems(DataContext context, Character character)
	{
		ItemKey[] equipment = character.GetEquipment();
		for (int i = 0; i < 12; i++)
		{
			ItemKey itemKey = equipment[i];
			if (itemKey.IsValid())
			{
				DomainManager.Item.RemoveItem(context, itemKey);
				equipment[i] = ItemKey.Invalid;
			}
		}
		character.SetEquipment(equipment, context);
		Inventory inventory = character.GetInventory();
		foreach (var (itemKey3, num2) in inventory.Items)
		{
			DomainManager.Item.RemoveItem(context, itemKey3);
		}
		inventory.Items.Clear();
		character.SetInventory(inventory, context);
	}

	public ItemDisplayData.ItemUsingType GetItemUsingType(ItemKey itemKey, int charId)
	{
		bool flag = charId == DomainManager.Taiwu.GetTaiwuCharId();
		ItemDisplayData.ItemUsingType itemUsingType = ItemDisplayData.ItemUsingType.Invalid;
		if (ItemType.IsEquipmentItemType(itemKey.ItemType))
		{
			ItemKey[] equipment = DomainManager.Character.GetElement_Objects(charId).GetEquipment();
			ItemKey[] array = equipment;
			foreach (ItemKey itemKey2 in array)
			{
				if (itemKey2.Equals(itemKey))
				{
					itemUsingType = ItemDisplayData.ItemUsingType.Equiped;
					break;
				}
			}
			if (itemUsingType != ItemDisplayData.ItemUsingType.Equiped && flag && DomainManager.Taiwu.CheckItemIsInEquipmentPlan(itemKey))
			{
				itemUsingType = ItemDisplayData.ItemUsingType.EquipmentPlaned;
			}
			if (DomainManager.Extra.IsItemJiaoRelated(itemKey) && DomainManager.Extra.TryGetJiaoIdByItemKey(itemKey, out var id) && DomainManager.Extra.TryGetJiao(id, out var jiao) && jiao.GrowthStage == 2)
			{
				foreach (JiaoPool jiaoPool in DomainManager.Extra.GetJiaoPools())
				{
					if (jiaoPool.Jiaos.Count >= 2 && jiaoPool.Jiaos.Contains(id))
					{
						itemUsingType = ItemDisplayData.ItemUsingType.Breeding;
						break;
					}
				}
			}
		}
		else if (itemKey.ItemType == 10 && flag)
		{
			if (DomainManager.Taiwu.GetCurReadingBook().Equals(itemKey))
			{
				itemUsingType = ItemDisplayData.ItemUsingType.Reading;
			}
			else
			{
				ItemKey[] referenceBooks = DomainManager.Taiwu.GetReferenceBooks();
				ItemKey[] array2 = referenceBooks;
				foreach (ItemKey itemKey3 in array2)
				{
					if (itemKey3.Equals(itemKey))
					{
						itemUsingType = ItemDisplayData.ItemUsingType.Referring;
						break;
					}
				}
			}
		}
		return itemUsingType;
	}

	public void ClearItemUsingState(DataContext context, ItemKey itemKey, int charId, ItemDisplayData.ItemUsingType usingType = ItemDisplayData.ItemUsingType.Invalid)
	{
		if (usingType == ItemDisplayData.ItemUsingType.Invalid)
		{
			usingType = GetItemUsingType(itemKey, charId);
		}
		if (usingType == ItemDisplayData.ItemUsingType.Invalid)
		{
			return;
		}
		bool flag = charId == DomainManager.Taiwu.GetTaiwuCharId();
		switch (usingType)
		{
		case ItemDisplayData.ItemUsingType.Reading:
			if (flag && DomainManager.Taiwu.GetCurReadingBook().Equals(itemKey))
			{
				DomainManager.Taiwu.SetReadingBook(context, ItemKey.Invalid);
			}
			break;
		case ItemDisplayData.ItemUsingType.Referring:
			if (flag)
			{
				ItemKey[] referenceBooks = DomainManager.Taiwu.GetReferenceBooks();
				int num = Array.IndexOf(referenceBooks, itemKey);
				DomainManager.Taiwu.SetReferenceBook(context, (sbyte)num, ItemKey.Invalid);
			}
			break;
		case ItemDisplayData.ItemUsingType.Equiped:
		{
			ItemKey[] equipment = DomainManager.Character.GetElement_Objects(charId).GetEquipment();
			sbyte equipmentSlot = EquipmentSlotHelper.GetEquipmentSlot(itemKey, equipment);
			if (equipmentSlot != -1)
			{
				DomainManager.Character.ChangeEquipment(context, charId, equipmentSlot, -1, itemKey);
			}
			break;
		}
		case ItemDisplayData.ItemUsingType.EquipmentPlaned:
		{
			if (flag && DomainManager.Taiwu.FindItemInEquipmentPlan(itemKey, out var planIndex, out var slotIndex))
			{
				DomainManager.Taiwu.SetEquipmentPlan(context, ItemKey.Invalid, planIndex, slotIndex);
			}
			break;
		}
		case ItemDisplayData.ItemUsingType.Breeding:
			break;
		}
	}

	public void RandomChangeEquipmentDurability(DataContext context, Character character, sbyte itemType, bool isAdd, float percent)
	{
		List<ItemBase> list = new List<ItemBase>();
		if (isAdd)
		{
			ItemKey[] equipment = character.GetEquipment();
			for (int i = 0; i < equipment.Length; i++)
			{
				ItemKey itemKey = equipment[i];
				if (itemKey.Id < 0 || itemKey.ItemType != itemType)
				{
					continue;
				}
				WeaponItem weaponItem = Config.Weapon.Instance[itemKey.TemplateId];
				if (weaponItem.Transferable)
				{
					ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey);
					if (baseItem.GetMaxDurability() > baseItem.GetCurrDurability())
					{
						list.Add(baseItem);
					}
				}
			}
			if (list.Count != 0)
			{
				ItemBase itemBase = list[context.Random.Next(list.Count)];
				short currDurability = (short)Math.Clamp((float)itemBase.GetCurrDurability() * (1f + percent), 0f, itemBase.GetMaxDurability());
				itemBase.SetCurrDurability(currDurability, context);
			}
			return;
		}
		ItemKey[] equipment2 = character.GetEquipment();
		for (int j = 0; j < equipment2.Length; j++)
		{
			ItemKey itemKey2 = equipment2[j];
			if (itemKey2.Id >= 0 && itemKey2.ItemType == itemType)
			{
				WeaponItem weaponItem2 = Config.Weapon.Instance[itemKey2.TemplateId];
				if (weaponItem2.Transferable)
				{
					ItemBase baseItem2 = DomainManager.Item.GetBaseItem(itemKey2);
					list.Add(baseItem2);
				}
			}
		}
		if (list.Count != 0)
		{
			ItemBase itemBase2 = list[context.Random.Next(list.Count)];
			short num = (short)Math.Clamp((float)itemBase2.GetCurrDurability() * (1f - percent), 0f, itemBase2.GetMaxDurability());
			if (num == 0)
			{
				DomainManager.Taiwu.RemoveItem(context, itemBase2.GetItemKey(), 1, 1, deleteItem: true);
			}
			else
			{
				itemBase2.SetCurrDurability(num, context);
			}
		}
	}

	public void UpdateFixedCharacterEatingItems(DataContext context)
	{
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		list.Clear();
		list.AddRange(_fixedCharactersCache.Values);
		foreach (int item in list)
		{
			Character character = _objects[item];
			short templateId = character.GetTemplateId();
			short num = templateId;
			short num2 = num;
			if (num2 == 810 || num2 == 812)
			{
				character.ClearEatingItems(context);
			}
		}
		ObjectPool<List<int>>.Instance.Return(list);
	}

	[Obsolete]
	public void ConfiscateItem(DataContext context, Character character, List<Character> targetChars, List<ItemKey> itemKeys)
	{
		Location location = character.GetLocation();
		if (!location.IsValid())
		{
			location = character.GetValidLocation();
		}
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		DomainManager.Map.GetNeighborBlocks(location.AreaId, location.BlockId, list, 3);
		Inventory inventory = character.GetInventory();
		foreach (ItemKey itemKey in itemKeys)
		{
			if (itemKey.IsValid())
			{
				if (!inventory.Items.TryGetValue(itemKey, out var value))
				{
					int num = character.GetEquipment().IndexOf(itemKey);
					Tester.Assert(num >= 0);
					character.ChangeEquipment(context, (sbyte)num, -1, itemKey);
					value = 1;
				}
				if (targetChars.Count > 0)
				{
					Character random = targetChars.GetRandom(context.Random);
					DomainManager.Character.TransferInventoryItem(context, character, random, itemKey, value);
				}
				else
				{
					MapBlockData block = list[context.Random.Next(list.Count)];
					character.RemoveInventoryItem(context, itemKey, 1, deleteItem: false);
					DomainManager.Map.AddBlockItem(context, block, itemKey, 1);
				}
			}
		}
	}

	[Obsolete]
	public unsafe void ConfiscateResources(DataContext context, Character character, List<Character> targetChars, ResourceInts confiscateResources)
	{
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		for (sbyte b = 0; b < 8; b++)
		{
			int num = confiscateResources.Items[b];
			if (num != 0)
			{
				int item = num / targetChars.Count;
				int num2 = num % targetChars.Count;
				list.Clear();
				for (int i = 0; i < targetChars.Count; i++)
				{
					list.Add(item);
					if (num2 > 0 && (num2 >= targetChars.Count - i || context.Random.CheckPercentProb(50)))
					{
						list[i]++;
						num2--;
					}
				}
				character.ChangeResource(context, b, -num);
				for (int j = 0; j < targetChars.Count; j++)
				{
					targetChars[j].ChangeResource(context, b, list[j]);
				}
			}
		}
		ObjectPool<List<int>>.Instance.Return(list);
	}

	[DomainMethod]
	public static List<TemplateKeyAndCount> GetAllItemsByAreaId(short areaId)
	{
		Span<MapBlockData> areaBlocks = DomainManager.Map.GetAreaBlocks(areaId);
		Dictionary<(sbyte, short), int> dictionary = new Dictionary<(sbyte, short), int>();
		Span<MapBlockData> span = areaBlocks;
		for (int i = 0; i < span.Length; i++)
		{
			MapBlockData mapBlockData = span[i];
			if (mapBlockData.CharacterSet == null)
			{
				continue;
			}
			foreach (int item in mapBlockData.CharacterSet)
			{
				Character element_Objects = DomainManager.Character.GetElement_Objects(item);
				if (element_Objects.GetOrganizationInfo().OrgTemplateId == 16 || element_Objects.IsActiveExternalRelationState(60))
				{
					continue;
				}
				foreach (KeyValuePair<ItemKey, int> item2 in element_Objects.GetInventory().Items)
				{
					item2.Deconstruct(out var key, out var value);
					ItemKey itemKey = key;
					int num = value;
					(sbyte, short) key2 = (itemKey.ItemType, itemKey.TemplateId);
					if (dictionary.ContainsKey(key2))
					{
						dictionary[key2] += num;
					}
					else
					{
						dictionary.Add(key2, num);
					}
				}
			}
		}
		List<TemplateKeyAndCount> list = new List<TemplateKeyAndCount>();
		foreach (KeyValuePair<(sbyte, short), int> item3 in dictionary)
		{
			if (ItemTemplateHelper.IsTransferable(item3.Key.Item1, item3.Key.Item2) && ItemTemplateHelper.GetBaseValue(item3.Key.Item1, item3.Key.Item2) != 0 && ItemTemplateHelper.GetIcon(item3.Key.Item1, item3.Key.Item2) != null && !ItemTemplateHelper.IsSpecial(item3.Key.Item1, item3.Key.Item2))
			{
				list.Add(new TemplateKeyAndCount
				{
					TemplateKey = new TemplateKey(item3.Key.Item1, item3.Key.Item2),
					Count = item3.Value
				});
			}
		}
		return list;
	}

	private unsafe static (long positiveWorth, long negativeWorth) GetResourcesWorth(ref ResourceInts values)
	{
		long num = 0L;
		long num2 = 0L;
		for (int i = 0; i < 8; i++)
		{
			long num3 = (long)GlobalConfig.ResourcesWorth[i] * (long)values.Items[i];
			if (num3 >= 0)
			{
				num += num3;
			}
			else
			{
				num2 -= num3;
			}
		}
		return (positiveWorth: num, negativeWorth: num2);
	}

	private static void CreateItemDisplayData(int charId, ItemKey itemKey, int amount, List<ItemDisplayData> dataList, Dictionary<int, List<ItemDisplayData>> templateIdToDisplayListDict, ItemSourceType itemSourceType)
	{
		ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey);
		bool flag = ModificationStateHelper.IsActive(baseItem.GetModificationState(), 4);
		bool flag2 = ModificationStateHelper.IsActive(baseItem.GetModificationState(), 8);
		bool flag3 = true;
		int key = itemKey.ItemType * 10000 + itemKey.TemplateId;
		if (!templateIdToDisplayListDict.TryGetValue(key, out var value))
		{
			value = new List<ItemDisplayData>();
			templateIdToDisplayListDict.Add(key, value);
		}
		MerchantExtraGoodsData.ExtraGoodsType extraGoodsType = MerchantExtraGoodsData.ExtraGoodsType.None;
		if (baseItem.GetStackable() && !flag)
		{
			if (flag2)
			{
				extraGoodsType = DomainManager.Extra.GetExtraGoodsType(itemKey);
				if (extraGoodsType > MerchantExtraGoodsData.ExtraGoodsType.None)
				{
					ItemDisplayData itemDisplayData = value.Find((ItemDisplayData d) => d.Key.TemplateEquals(itemKey) && d.ExtraGoodsType == (sbyte)extraGoodsType);
					if (itemDisplayData != null)
					{
						for (int num = 0; num < amount; num++)
						{
							itemDisplayData.ChangeAmount(itemKey, isAdd: true);
						}
						flag3 = false;
					}
				}
			}
			else if (baseItem.GetPoisonable())
			{
				bool flag4 = ModificationStateHelper.IsActive(baseItem.GetModificationState(), 1);
				FullPoisonEffects poisonEffects = (flag4 ? DomainManager.Item.PoisonEffects[baseItem.GetId()] : new FullPoisonEffects());
				ItemDisplayData itemDisplayData = ((!poisonEffects.IsIdentified) ? value.Find((ItemDisplayData d) => (d.PoisonEffects == null || !d.PoisonEffects.IsIdentified) && d.ExtraGoodsTypeEnum == MerchantExtraGoodsType.None) : value.Find((ItemDisplayData d) => poisonEffects.SameOf(d.PoisonEffects) && d.ExtraGoodsTypeEnum == MerchantExtraGoodsType.None));
				if (itemDisplayData != null)
				{
					for (int num2 = 0; num2 < amount; num2++)
					{
						itemDisplayData.ChangeAmount(itemKey, isAdd: true);
					}
					flag3 = false;
				}
			}
		}
		if (flag3)
		{
			ItemDisplayData itemDisplayData2 = DomainManager.Item.GetItemDisplayData(baseItem, amount, charId, (sbyte)itemSourceType);
			itemDisplayData2.ExtraGoodsType = (sbyte)extraGoodsType;
			dataList.Add(itemDisplayData2);
			value.Add(itemDisplayData2);
		}
	}

	public static List<ItemDisplayData> GetItemDisplayData(int charId, List<(ItemKey itemKey, int amount)> items, ItemSourceType itemSourceType)
	{
		List<ItemDisplayData> list = new List<ItemDisplayData>();
		Dictionary<int, List<ItemDisplayData>> templateIdToDisplayListDict = new Dictionary<int, List<ItemDisplayData>>();
		int i = 0;
		for (int count = items.Count; i < count; i++)
		{
			var (itemKey, amount) = items[i];
			CreateItemDisplayData(charId, itemKey, amount, list, templateIdToDisplayListDict, itemSourceType);
		}
		return list;
	}

	public static List<ItemDisplayData> GetItemDisplayData(int charId, IReadOnlyDictionary<ItemKey, int> items, ItemSourceType itemSourceType)
	{
		List<ItemDisplayData> list = new List<ItemDisplayData>();
		Dictionary<int, List<ItemDisplayData>> templateIdToDisplayListDict = new Dictionary<int, List<ItemDisplayData>>();
		foreach (var (itemKey2, amount) in items)
		{
			CreateItemDisplayData(charId, itemKey2, amount, list, templateIdToDisplayListDict, itemSourceType);
		}
		return list;
	}

	private static void RemoveTaiwuReadingBookFromClassifiedItems(List<(ItemBase, int)>[] classifiedItems)
	{
		List<ItemKey> list = new List<ItemKey>();
		list.AddRange(DomainManager.Taiwu.GetReferenceBooks());
		list.Add(DomainManager.Taiwu.GetCurReadingBook());
		for (int i = 0; i < list.Count; i++)
		{
			ItemKey itemKey = list[i];
			if (!itemKey.IsValid())
			{
				continue;
			}
			ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey);
			List<(ItemBase, int)> list2 = classifiedItems[baseItem.GetGrade() / 3];
			for (int num = list2.Count - 1; num >= 0; num--)
			{
				if (list2[num].Item1.GetItemKey().Equals(itemKey))
				{
					list2.RemoveAt(num);
					break;
				}
			}
		}
	}

	private unsafe void RemoveAllItemsBeforeRemovingCharacter(DataContext context, Character character)
	{
		ItemKey[] equipment = character.GetEquipment();
		for (int i = 0; i < 12; i++)
		{
			ItemKey itemKey = equipment[i];
			if (itemKey.IsValid())
			{
				DomainManager.Item.RemoveItem(context, itemKey);
			}
		}
		Inventory inventory = character.GetInventory();
		foreach (var (itemKey3, num2) in inventory.Items)
		{
			if (itemKey3.IsValid())
			{
				DomainManager.Item.RemoveItem(context, itemKey3);
			}
		}
		EatingItems eatingItems = character.GetEatingItems();
		for (int j = 0; j < 9; j++)
		{
			ItemKey itemKey4 = (ItemKey)eatingItems.ItemKeys[j];
			if (itemKey4.IsValid())
			{
				DomainManager.Item.RemoveItem(context, itemKey4);
			}
		}
	}

	[Obsolete("This method is obsolete, and will removed in future, use GetItemPowerInfo instead.")]
	public (int, int) GetItemUsePowerInfo(DataContext context, int charId, ItemKey itemKey)
	{
		return (100, 100);
	}

	[Obsolete("This method is obsolete, and will removed in future, use GetItemPower instead.")]
	public int GetItemUsePower(int charId, ItemKey itemKey)
	{
		return GetItemPower(charId, itemKey);
	}

	[Obsolete("This method is obsolete, and will removed in future, use GetItemMaxPower instead.")]
	public int GetItemMaxUsePower(int charId, ItemKey itemKey)
	{
		return GetItemMaxPower(charId, itemKey);
	}

	public KidnappedCharacterList GetKidnappedCharacters(int charId)
	{
		return _kidnappedChars[charId];
	}

	public bool TryGetKidnappedCharacters(int charId, out KidnappedCharacterList list)
	{
		return _kidnappedChars.TryGetValue(charId, out list);
	}

	public void GetAllKidnappedCharacterIds(List<int> results)
	{
		foreach (KeyValuePair<int, KidnappedCharacterList> kidnappedChar in _kidnappedChars)
		{
			kidnappedChar.Deconstruct(out var key, out var value);
			int num = key;
			KidnappedCharacterList kidnappedCharacterList = value;
			List<KidnappedCharacter> collection = kidnappedCharacterList.GetCollection();
			foreach (KidnappedCharacter item in collection)
			{
				results.Add(item.CharId);
			}
		}
	}

	[DomainMethod]
	public void AddKidnappedCharacter(DataContext context, int charId, int kidnappedCharId, ItemKey ropeItemKey)
	{
		if (kidnappedCharId == DomainManager.Taiwu.GetTaiwuCharId())
		{
			throw new Exception($"Character {charId} cannot kidnap taiwu {kidnappedCharId}.");
		}
		Character element_Objects = GetElement_Objects(charId);
		Character element_Objects2 = GetElement_Objects(kidnappedCharId);
		AddKidnappedCharacter(context, element_Objects, element_Objects2, ropeItemKey);
	}

	[DomainMethod]
	public void TransferKidnappedCharacters(DataContext context, int targetKidnapperId, int sourceKidnapperId, KidnappedCharacterList kidnappedCharsToTransfer)
	{
		List<KidnappedCharacter> collection = kidnappedCharsToTransfer.GetCollection();
		if (collection.Count != 0)
		{
			KidnappedCharacterList value;
			bool flag = TryGetElement_KidnappedChars(targetKidnapperId, out value);
			if (value == null)
			{
				value = new KidnappedCharacterList();
			}
			if (!TryGetElement_KidnappedChars(sourceKidnapperId, out var value2))
			{
				throw new Exception("The source kidnapper has not kidnapped anyone.");
			}
			for (int num = collection.Count - 1; num >= 0; num--)
			{
				KidnappedCharacter kidnappedCharacter = collection[num];
				kidnappedCharacter.OfflineChangeResistance(GlobalConfig.Instance.ResistChangeOnKidnapCharacterTransfer);
				Character element_Objects = GetElement_Objects(kidnappedCharacter.CharId);
				TryCreateRelation(context, targetKidnapperId, kidnappedCharacter.CharId);
				element_Objects.SetKidnapperId(targetKidnapperId, context);
				value.Add(kidnappedCharacter);
				value2.Remove(kidnappedCharacter.CharId);
				Logger.Info($"{element_Objects} is being transfered from one kidnapper to another: {sourceKidnapperId} => {targetKidnapperId}.");
			}
			Character element_Objects2 = GetElement_Objects(sourceKidnapperId);
			Character element_Objects3 = GetElement_Objects(targetKidnapperId);
			if (value2.GetCount() == 0)
			{
				RemoveElement_KidnappedChars(sourceKidnapperId, context);
				element_Objects2.DeactivateExternalRelationState(context, 2);
			}
			else
			{
				SetElement_KidnappedChars(sourceKidnapperId, value2, context);
			}
			if (flag)
			{
				SetElement_KidnappedChars(targetKidnapperId, value, context);
			}
			else
			{
				AddElement_KidnappedChars(targetKidnapperId, value, context);
			}
			RemoveAllKidnappedChars(context, element_Objects2, isEscaped: false);
			element_Objects3.ActiveExternalRelationState(context, 2);
			kidnappedCharsToTransfer.Clear();
		}
	}

	[DomainMethod]
	public void ChangeKidnappedCharacterRope(DataContext context, int kidnapperId, int kidnappedCharId, ItemKey newRopeKey)
	{
		if (!TryGetElement_KidnappedChars(kidnapperId, out var value))
		{
			throw new Exception($"Character {kidnappedCharId} is not kidnapped by character {kidnapperId}");
		}
		for (int i = 0; i < value.GetCount(); i++)
		{
			KidnappedCharacter kidnappedCharacter = value.Get(i);
			if (kidnappedCharacter.CharId == kidnappedCharId)
			{
				DomainManager.Item.RemoveItem(context, kidnappedCharacter.RopeItemKey);
				kidnappedCharacter.RopeItemKey = newRopeKey;
				Character element_Objects = GetElement_Objects(kidnapperId);
				element_Objects.RemoveInventoryItem(context, newRopeKey, 1, deleteItem: false);
				DomainManager.Item.SetOwner(newRopeKey, ItemOwnerType.KidnapperRope, kidnappedCharId);
				SetElement_KidnappedChars(kidnapperId, value, context);
				return;
			}
		}
		throw new Exception($"Character {kidnappedCharId} is not kidnapped by character {kidnapperId}");
	}

	[DomainMethod]
	public int GetKidnapMaxSlotCount(int charId)
	{
		Character element_Objects = GetElement_Objects(charId);
		return element_Objects.GetKidnapMaxSlotCount();
	}

	[DomainMethod]
	public unsafe void TransferKidnappedCharacter(DataContext context, int targetKidnapperId, int sourceKidnapperId, KidnappedCharacter kidnappedCharData)
	{
		KidnappedCharacterList value;
		bool flag = TryGetElement_KidnappedChars(targetKidnapperId, out value);
		if (!TryGetElement_KidnappedChars(sourceKidnapperId, out var value2))
		{
			throw new Exception("The source kidnapper has not kidnapped anyone.");
		}
		Character element_Objects = GetElement_Objects(targetKidnapperId);
		Character element_Objects2 = GetElement_Objects(kidnappedCharData.CharId);
		Personalities personalities = element_Objects2.GetPersonalities();
		kidnappedCharData.ExtraResistance = personalities.Items[3];
		kidnappedCharData.KidnapBeginDate = DomainManager.World.GetCurrDate();
		element_Objects2.SetKidnapperId(targetKidnapperId, context);
		if (value == null)
		{
			value = new KidnappedCharacterList();
		}
		value.Add(kidnappedCharData);
		value2.Remove(kidnappedCharData.CharId);
		Logger.Info($"{element_Objects2} is being transfered from one kidnapper to another: {sourceKidnapperId} => {targetKidnapperId}.");
		if (value2.GetCount() == 0)
		{
			RemoveElement_KidnappedChars(sourceKidnapperId, context);
			if (DomainManager.Character.TryGetElement_Objects(sourceKidnapperId, out var element))
			{
				element.DeactivateExternalRelationState(context, 2);
			}
		}
		else
		{
			SetElement_KidnappedChars(sourceKidnapperId, value2, context);
		}
		if (flag)
		{
			SetElement_KidnappedChars(targetKidnapperId, value, context);
		}
		else
		{
			AddElement_KidnappedChars(targetKidnapperId, value, context);
		}
		element_Objects.ActiveExternalRelationState(context, 2);
	}

	[DomainMethod]
	public void RemoveKidnappedCharacter(DataContext context, int kidnappedCharId, int kidnapperId, bool isEscaped)
	{
		Character element_Objects = GetElement_Objects(kidnapperId);
		KidnappedCharacterList kidnappedCharacterList = _kidnappedChars[kidnapperId];
		int num = kidnappedCharacterList.IndexOf(kidnappedCharId);
		if (num < 0)
		{
			throw new Exception($"Character {kidnappedCharId} is not kidnapped by character {kidnapperId}");
		}
		RemoveKidnappedCharacter(context, element_Objects, kidnappedCharacterList, num, isEscaped);
	}

	public unsafe void AddKidnappedCharacter(DataContext context, Character character, Character kidnappedChar, ItemKey ropeItemKey)
	{
		Logger.Info($"{character} is kidnapping {kidnappedChar}.");
		if (kidnappedChar.GetCreatingType() == 2)
		{
			ConvertRandomEnemy(context, kidnappedChar, character.GetLocation());
		}
		else if (IsTemporaryIntelligentCharacter(kidnappedChar.GetId()))
		{
			ConvertTemporaryIntelligentCharacter(context, kidnappedChar);
		}
		TryCreateGeneralRelation(context, character, kidnappedChar);
		TransferKidnappedCharsToGrandKidnapper(context, character, kidnappedChar);
		int id = character.GetId();
		int id2 = kidnappedChar.GetId();
		Personalities personalities = kidnappedChar.GetPersonalities();
		sbyte initialResistance = personalities.Items[3];
		if (id == id2)
		{
			throw new Exception($"Character {id} cannot kidnap him or herself.");
		}
		if (kidnappedChar.GetKidnapperId() >= 0)
		{
			throw new Exception($"Character {character} cannot kidnap {kidnappedChar} who is already kidnapped by {kidnappedChar.GetKidnapperId()}.");
		}
		if (kidnappedChar.GetLeaderId() >= 0)
		{
			LeaveGroup(context, kidnappedChar, bringWards: false);
		}
		character.RemoveInventoryItem(context, ropeItemKey, 1, deleteItem: false);
		DomainManager.Item.SetOwner(ropeItemKey, ItemOwnerType.KidnapperRope, id2);
		if (!_kidnappedChars.TryGetValue(id, out var value))
		{
			value = new KidnappedCharacterList();
			value.Add(id2, initialResistance, ropeItemKey, DomainManager.World.GetCurrDate());
			AddElement_KidnappedChars(id, value, context);
		}
		else
		{
			value.Add(id2, initialResistance, ropeItemKey, DomainManager.World.GetCurrDate());
			SetElement_KidnappedChars(id, value, context);
		}
		Location location = kidnappedChar.GetLocation();
		Location invalid = Location.Invalid;
		kidnappedChar.SetLocation(invalid, context);
		if (kidnappedChar.IsCompletelyInfected())
		{
			Events.RaiseInfectedCharacterLocationChanged(context, id2, location, invalid);
		}
		else
		{
			Events.RaiseCharacterLocationChanged(context, id2, location, invalid);
		}
		kidnappedChar.SetKidnapperId(id, context);
		character.ActiveExternalRelationState(context, 2);
		Events.RaiseKidnappedStatusChanged(context, kidnappedChar, isKidnapped: true);
	}

	public void RemoveKidnappedCharacter(DataContext context, Character character, KidnappedCharacterList kidnappedChars, int slotIndex, bool isEscaped)
	{
		int id = character.GetId();
		KidnappedCharacter kidnappedCharacter = kidnappedChars.Get(slotIndex);
		ItemKey ropeItemKey = kidnappedCharacter.RopeItemKey;
		Logger.Info($"Removing {character}'s kidnapped character: {kidnappedCharacter.CharId} (isEscape={isEscaped}).");
		kidnappedChars.RemoveAt(slotIndex);
		if (kidnappedChars.GetCount() <= 0)
		{
			RemoveElement_KidnappedChars(id, context);
			character.DeactivateExternalRelationState(context, 2);
		}
		else
		{
			SetElement_KidnappedChars(id, kidnappedChars, context);
		}
		if (TryGetElement_Objects(kidnappedCharacter.CharId, out var element))
		{
			Location location = element.GetLocation();
			Location location2 = character.GetLocation();
			if (!location2.IsValid())
			{
				location2 = character.GetValidLocation();
			}
			element.SetLocation(location2, context);
			if (element.IsCompletelyInfected())
			{
				Events.RaiseInfectedCharacterLocationChanged(context, kidnappedCharacter.CharId, location, location2);
			}
			else
			{
				Events.RaiseCharacterLocationChanged(context, kidnappedCharacter.CharId, location, location2);
			}
			element.SetKidnapperId(-1, context);
			Events.RaiseKidnappedStatusChanged(context, element, isKidnapped: false);
		}
		if (ropeItemKey.IsValid())
		{
			DomainManager.Item.RemoveOwner(ropeItemKey, ItemOwnerType.KidnapperRope, kidnappedCharacter.CharId);
			if (isEscaped)
			{
				DomainManager.Item.RemoveItem(context, ropeItemKey);
			}
			else
			{
				character.AddInventoryItem(context, ropeItemKey, 1);
			}
		}
	}

	private unsafe void TransferKidnappedCharsToGrandKidnapper(DataContext context, Character targetKidnapper, Character sourceKidnapper)
	{
		int id = sourceKidnapper.GetId();
		int id2 = targetKidnapper.GetId();
		if (!TryGetElement_KidnappedChars(id, out var value))
		{
			return;
		}
		KidnappedCharacterList value2;
		bool flag = TryGetElement_KidnappedChars(id2, out value2);
		if (value2 == null)
		{
			value2 = new KidnappedCharacterList();
		}
		List<KidnappedCharacter> collection = value.GetCollection();
		for (int num = collection.Count - 1; num >= 0; num--)
		{
			KidnappedCharacter kidnappedCharacter = collection[num];
			if (!context.Random.CheckProb(40, 100))
			{
				Character element_Objects = GetElement_Objects(kidnappedCharacter.CharId);
				Personalities personalities = element_Objects.GetPersonalities();
				kidnappedCharacter.ExtraResistance = personalities.Items[3];
				kidnappedCharacter.KidnapBeginDate = DomainManager.World.GetCurrDate();
				TryCreateRelation(context, id2, kidnappedCharacter.CharId);
				element_Objects.SetKidnapperId(id2, context);
				value2.Add(kidnappedCharacter);
				value.RemoveAt(num);
				Logger.Info($"{element_Objects} is being transfered from one kidnapper to another: {id} => {id2}.");
			}
		}
		if (value.GetCount() == 0)
		{
			RemoveElement_KidnappedChars(id, context);
			sourceKidnapper.DeactivateExternalRelationState(context, 2);
		}
		else
		{
			SetElement_KidnappedChars(id, value, context);
		}
		if (flag)
		{
			SetElement_KidnappedChars(id2, value2, context);
		}
		else
		{
			AddElement_KidnappedChars(id2, value2, context);
		}
		RemoveAllKidnappedChars(context, sourceKidnapper, isEscaped: true);
		targetKidnapper.ActiveExternalRelationState(context, 2);
	}

	public void TransferKidnappedCharactersToTaiwuSuccessor(DataContext context, Character targetKidnapper, Character sourceKidnapper)
	{
		int id = sourceKidnapper.GetId();
		int id2 = targetKidnapper.GetId();
		if (TryGetElement_KidnappedChars(id, out var value))
		{
			KidnappedCharacterList value2;
			bool flag = TryGetElement_KidnappedChars(id2, out value2);
			if (value2 == null)
			{
				value2 = new KidnappedCharacterList();
			}
			List<KidnappedCharacter> collection = value.GetCollection();
			for (int num = collection.Count - 1; num >= 0; num--)
			{
				KidnappedCharacter kidnappedCharacter = collection[num];
				kidnappedCharacter.OfflineChangeResistance(GlobalConfig.Instance.ResistChangeOnKidnapCharacterTransfer);
				Character element_Objects = GetElement_Objects(kidnappedCharacter.CharId);
				TryCreateRelation(context, id2, kidnappedCharacter.CharId);
				element_Objects.SetKidnapperId(id2, context);
				value2.Add(kidnappedCharacter);
				value.RemoveAt(num);
				Logger.Info($"{element_Objects} is being transfered from one kidnapper to another: {id} => {id2}.");
			}
			if (value.GetCount() == 0)
			{
				RemoveElement_KidnappedChars(id, context);
				sourceKidnapper.DeactivateExternalRelationState(context, 2);
			}
			else
			{
				SetElement_KidnappedChars(id, value, context);
			}
			if (flag)
			{
				SetElement_KidnappedChars(id2, value2, context);
			}
			else
			{
				AddElement_KidnappedChars(id2, value2, context);
			}
			RemoveAllKidnappedChars(context, sourceKidnapper, isEscaped: true);
			targetKidnapper.ActiveExternalRelationState(context, 2);
		}
	}

	public void UpdateKidnappedCharacters(DataContext context)
	{
		int currDate = DomainManager.World.GetCurrDate();
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		MonthlyEventCollection monthlyEventCollection = DomainManager.World.GetMonthlyEventCollection();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		List<int> list2 = ObjectPool<List<int>>.Instance.Get();
		List<MapBlockData> list3 = ObjectPool<List<MapBlockData>>.Instance.Get();
		list.Clear();
		list2.Clear();
		foreach (KeyValuePair<int, KidnappedCharacterList> kidnappedChar in _kidnappedChars)
		{
			kidnappedChar.Deconstruct(out var key, out var value);
			int num = key;
			KidnappedCharacterList kidnappedCharacterList = value;
			List<KidnappedCharacter> collection = kidnappedCharacterList.GetCollection();
			Character element_Objects = GetElement_Objects(num);
			Location location = element_Objects.GetLocation();
			if (!location.IsValid())
			{
				location = element_Objects.GetValidLocation();
			}
			bool flag = IsTaiwuPeople(num);
			int count = collection.Count;
			DomainManager.Map.GetRealNeighborBlocks(location.AreaId, location.BlockId, list3, 3);
			for (int num2 = collection.Count - 1; num2 >= 0; num2--)
			{
				KidnappedCharacter kidnappedCharacter = collection[num2];
				Character element_Objects2 = GetElement_Objects(kidnappedCharacter.CharId);
				bool flag2 = IsTaiwuPeople(kidnappedCharacter.CharId);
				ChangeFavorabilityOptionalMonthlyEvolution(context, element_Objects2, element_Objects, -3000);
				RelatedCharacter relation = GetRelation(kidnappedCharacter.CharId, num);
				sbyte favorabilityType = FavorabilityType.GetFavorabilityType(relation.Favorability);
				if (favorabilityType <= -2 && !RelationType.HasRelation(relation.RelationType, 32768))
				{
					if (num == DomainManager.Taiwu.GetTaiwuCharId())
					{
						monthlyEventCollection.AddCaptiveBecomeEnemy(kidnappedCharacter.CharId, location, num);
					}
					Character.ApplyAddRelation_Enemy(context, element_Objects2, element_Objects, flag, 1);
				}
				if (!IsLockMovementChar(kidnappedCharacter.CharId))
				{
					int exceedingAmount = Math.Max(0, count - element_Objects.GetKidnapMaxSlotCount());
					int totalResistance = CalcKidnappedCharacterTotalResistance(element_Objects, kidnappedCharacter);
					int percentProb = kidnappedCharacter.CalcEscapeRate(totalResistance, exceedingAmount);
					if (context.Random.CheckPercentProb(percentProb))
					{
						ItemKey ropeItemKey = kidnappedCharacter.RopeItemKey;
						kidnappedCharacterList.RemoveAt(num2);
						MapBlockData random = list3.GetRandom(context.Random);
						Location location2 = new Location(random.AreaId, random.BlockId);
						if (element_Objects2.IsCompletelyInfected())
						{
							Events.RaiseInfectedCharacterLocationChanged(context, kidnappedCharacter.CharId, element_Objects2.GetLocation(), location2);
						}
						else
						{
							Events.RaiseCharacterLocationChanged(context, kidnappedCharacter.CharId, element_Objects2.GetLocation(), location2);
						}
						element_Objects2.SetLocation(location2, context);
						element_Objects2.SetKidnapperId(-1, context);
						Events.RaiseKidnappedStatusChanged(context, element_Objects2, isKidnapped: false);
						if (ropeItemKey.IsValid())
						{
							DomainManager.Item.RemoveItem(context, ropeItemKey);
						}
						GameData.Domains.Character.Ai.PersonalNeed personalNeed = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(21, num);
						element_Objects2.AddPersonalNeed(context, personalNeed);
						lifeRecordCollection.AddKidnappedCharacterEscaped(kidnappedCharacter.CharId, currDate, num, location);
						SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
						int dataOffset = secretInformationCollection.AddKidnappedCharacterEscaped(kidnappedCharacter.CharId, num);
						int metaDataId = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
						if (num == DomainManager.Taiwu.GetTaiwuCharId())
						{
							monthlyEventCollection.AddEscapeFromPrison(kidnappedCharacter.CharId, location, num);
						}
						if (flag2 || flag)
						{
							monthlyNotificationCollection.AddEscapeFromPrison(kidnappedCharacter.CharId, location, num);
							DomainManager.Information.ReceiveSecretInformation(context, metaDataId, DomainManager.Taiwu.GetTaiwuCharId(), flag2 ? kidnappedCharacter.CharId : num);
						}
						Logger.Info($"{element_Objects}'s kidnapped character escaped: {element_Objects2}.");
					}
				}
			}
			if (kidnappedCharacterList.GetCount() <= 0)
			{
				kidnappedCharacterList.Clear();
				list2.Add(num);
				element_Objects.DeactivateExternalRelationState(context, 2);
			}
			else
			{
				list.Add(num);
			}
		}
		foreach (int item in list2)
		{
			RemoveElement_KidnappedChars(item, context);
		}
		foreach (int item2 in list)
		{
			SetElement_KidnappedChars(item2, _kidnappedChars[item2], context);
		}
		ObjectPool<List<int>>.Instance.Return(list);
		ObjectPool<List<int>>.Instance.Return(list2);
		ObjectPool<List<MapBlockData>>.Instance.Return(list3);
	}

	private int CalcKidnappedCharacterBaseResistance(Character kidnapper, KidnappedCharacter kidnappedChar)
	{
		Character element_Objects = DomainManager.Character.GetElement_Objects(kidnappedChar.CharId);
		int num = element_Objects.GetBehaviorType() + 1;
		int num2 = num * 10;
		int num3 = GlobalConfig.Instance.MaxConsummateLevel + element_Objects.GetConsummateLevel() - kidnapper.GetConsummateLevel();
		short favorability = DomainManager.Character.GetFavorability(element_Objects.GetId(), kidnapper.GetId());
		int num4 = -favorability / 500;
		return num2 + num3 + num4;
	}

	public int CalcKidnappedCharacterTotalResistance(Character kidnapper, KidnappedCharacter kidnappedChar)
	{
		int num = CalcKidnappedCharacterBaseResistance(kidnapper, kidnappedChar);
		return num + kidnappedChar.ExtraResistance;
	}

	public void RemoveAllKidnappedChars(DataContext context, Character character, bool isEscaped)
	{
		int id = character.GetId();
		if (!_kidnappedChars.TryGetValue(id, out var value))
		{
			return;
		}
		Location location = character.GetLocation();
		List<KidnappedCharacter> collection = value.GetCollection();
		for (int i = 0; i < collection.Count; i++)
		{
			KidnappedCharacter kidnappedCharacter = collection[i];
			int charId = kidnappedCharacter.CharId;
			ItemKey ropeItemKey = kidnappedCharacter.RopeItemKey;
			if (charId >= 0 && TryGetElement_Objects(charId, out var element))
			{
				Location location2 = element.GetLocation();
				element.SetLocation(location, context);
				if (element.IsCompletelyInfected())
				{
					Events.RaiseInfectedCharacterLocationChanged(context, charId, location2, location);
				}
				else
				{
					Events.RaiseCharacterLocationChanged(context, charId, location2, location);
				}
				element.SetKidnapperId(-1, context);
			}
			if (ropeItemKey.IsValid())
			{
				DomainManager.Item.RemoveOwner(ropeItemKey, ItemOwnerType.KidnapperRope, charId);
				if (isEscaped)
				{
					DomainManager.Item.RemoveItem(context, ropeItemKey);
				}
				else
				{
					character.AddInventoryItem(context, ropeItemKey, 1);
				}
			}
		}
		value.Clear();
		RemoveElement_KidnappedChars(id, context);
		character.DeactivateExternalRelationState(context, 2);
	}

	public void SyncLifeSkillReadingStateToCharacter(DataContext context, Character sourceCharacter, Character targetCharacter, sbyte lifeSkillType)
	{
		List<LifeSkillItem> list = new List<LifeSkillItem>();
		foreach (LifeSkillItem learnedLifeSkill in targetCharacter.GetLearnedLifeSkills())
		{
			if (LifeSkill.Instance[learnedLifeSkill.SkillTemplateId].Type != lifeSkillType)
			{
				list.Add(learnedLifeSkill);
			}
		}
		foreach (LifeSkillItem learnedLifeSkill2 in sourceCharacter.GetLearnedLifeSkills())
		{
			if (LifeSkill.Instance[learnedLifeSkill2.SkillTemplateId].Type == lifeSkillType)
			{
				list.Add(learnedLifeSkill2);
			}
		}
		targetCharacter.SetLearnedLifeSkills(list, context);
	}

	public void ResetLuckEventPrediction()
	{
		_predictedLuckEvent = (charId: -1, isPositive: false, isAvoided: false);
	}

	public void AddLuckEventPrediction(int charId, bool isPositive, bool isAvoided)
	{
		_predictedLuckEvent = (charId: charId, isPositive: isPositive, isAvoided: isAvoided);
	}

	public unsafe void UpdateLuckEvents(DataContext context)
	{
		long[] array = new long[_objects.Count];
		int num = 0;
		foreach (var (num3, character2) in _objects)
		{
			if (character2.GetCreatingType() == 1 && !IsTemporaryIntelligentCharacter(num3))
			{
				Personalities personalities = character2.GetPersonalities();
				array[num] = ((long)personalities.Items[5] << 32) + num3;
				num++;
			}
		}
		if (num == 0)
		{
			return;
		}
		List<int> list = new List<int>(100);
		List<int> list2 = new List<int>(100);
		fixed (long* ptr = array)
		{
			CollectionUtils.Sort(ptr, num);
			for (int i = 0; i < num && i < 100; i++)
			{
				int num4 = (int)(ptr[i] & 0xFFFFFFFFu);
				if (num4 != _predictedLuckEvent.charId)
				{
					list2.Add(num4);
				}
				int num5 = (int)(ptr[num - 1 - i] & 0xFFFFFFFFu);
				if (num5 != _predictedLuckEvent.charId)
				{
					list.Add(num5);
				}
			}
			if (_predictedLuckEvent.charId >= 0 && !_predictedLuckEvent.isAvoided && DomainManager.Character.TryGetElement_Objects(_predictedLuckEvent.charId, out var element))
			{
				ApplyLuckEventToCharacter(context, element, _predictedLuckEvent.isPositive);
			}
			ResetLuckEventPrediction();
			ApplyLucky_Resource(context, list, 5, 15);
			ApplyLucky_Item(context, list, 3, 2, 10);
			ApplyLucky_Item(context, list, 3, 0, 5);
			ApplyLucky_Item(context, list, 3, 1, 5);
			ApplyLucky_CombatSkillBook(context, list, 3, 3);
			ApplyLucky_LifeSkillBook(context, list, 3, 5);
			ApplyLucky_Regen(context, list, 5, 8);
			ApplyUnlucky_Resource(context, list2, 5, 15);
			ApplyUnlucky_Item(context, list2, 3, 2, 10);
			ApplyUnlucky_Item(context, list2, 3, 0, 5);
			ApplyUnlucky_Item(context, list2, 3, 1, 5);
			ApplyUnlucky_CombatSkillBook(context, list2, 3, 3);
			ApplyUnlucky_LifeSkillBook(context, list2, 3, 5);
			ApplyUnlucky_Harm(context, list2, 5, 8);
		}
	}

	public void ApplyLuckEventToCharacter(DataContext context, Character character, bool isPositive)
	{
		List<int> list = new List<int>(1) { character.GetId() };
		Span<sbyte> span = stackalloc sbyte[7];
		for (sbyte b = 0; b < span.Length; b++)
		{
			span[b] = b;
		}
		CollectionUtils.Shuffle(context.Random, span, span.Length);
		Span<sbyte> span2 = span;
		for (int i = 0; i < span2.Length; i++)
		{
			sbyte b2 = span2[i];
			if (isPositive)
			{
				if (1 == 0)
				{
				}
				int num = b2 switch
				{
					0 => ApplyLucky_Resource(context, list, 1, 100), 
					1 => ApplyLucky_Item(context, list, 1, 2, 100), 
					2 => ApplyLucky_Item(context, list, 1, 0, 100), 
					3 => ApplyLucky_Item(context, list, 1, 1, 100), 
					4 => ApplyLucky_CombatSkillBook(context, list, 1, 100), 
					5 => ApplyLucky_LifeSkillBook(context, list, 1, 100), 
					6 => ApplyLucky_Regen(context, list, 1, 100), 
					_ => 0, 
				};
				if (1 == 0)
				{
				}
				int num2 = num;
				if (num2 > 0)
				{
					break;
				}
			}
			else
			{
				if (1 == 0)
				{
				}
				int num = b2 switch
				{
					0 => ApplyUnlucky_Resource(context, list, 1, 100), 
					1 => ApplyUnlucky_Item(context, list, 1, 2, 100), 
					2 => ApplyUnlucky_Item(context, list, 1, 0, 100), 
					3 => ApplyUnlucky_Item(context, list, 1, 1, 100), 
					4 => ApplyUnlucky_CombatSkillBook(context, list, 1, 100), 
					5 => ApplyUnlucky_LifeSkillBook(context, list, 1, 100), 
					6 => ApplyUnlucky_Harm(context, list, 1, 100), 
					_ => 0, 
				};
				if (1 == 0)
				{
				}
				int num3 = num;
				if (num3 > 0)
				{
					break;
				}
			}
		}
	}

	private int ApplyLucky_Resource(DataContext context, List<int> luckyChars, int amountOfChars, sbyte chance)
	{
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		MonthlyEventCollection monthlyEventCollection = DomainManager.World.GetMonthlyEventCollection();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		int currDate = DomainManager.World.GetCurrDate();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int num = 0;
		Span<int> resultIndices = stackalloc int[amountOfChars];
		RandomUtils.GetRandomUnrepeated(context.Random, 0, luckyChars.Count - 1, resultIndices);
		for (int i = 0; i < amountOfChars; i++)
		{
			if (context.Random.CheckPercentProb(chance))
			{
				int num2 = luckyChars[resultIndices[i]];
				int num3 = context.Random.Next(12000, 24001);
				sbyte b = (sbyte)context.Random.Next(7);
				int num4 = num3 / GlobalConfig.ResourcesWorth[b];
				Character character = _objects[num2];
				Location location = character.GetLocation();
				GameData.Domains.Character.Ai.PersonalNeed personalNeed = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed((sbyte)9, (sbyte)6);
				character.AddPersonalNeed(context, personalNeed);
				character.ChangeResource(context, b, num4);
				character.ChangeHappiness(context, num3 / 1000);
				lifeRecordCollection.AddUnexpectedResourceGain(num2, currDate, location, b, num4);
				monthlyNotificationCollection.AddUnexpectedlyGetResource(num2, location, num4, b);
				int dataOffset = secretInformationCollection.AddUnexpectedResourceGain(num2, b, location);
				int num5 = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
				num++;
			}
		}
		return num;
	}

	private unsafe int ApplyUnlucky_Resource(DataContext context, List<int> unluckyChars, int amountOfChars, sbyte chance)
	{
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		MonthlyEventCollection monthlyEventCollection = DomainManager.World.GetMonthlyEventCollection();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		int currDate = DomainManager.World.GetCurrDate();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int num = 0;
		Span<int> resultIndices = stackalloc int[amountOfChars];
		RandomUtils.GetRandomUnrepeated(context.Random, 0, unluckyChars.Count - 1, resultIndices);
		for (int i = 0; i < amountOfChars; i++)
		{
			if (context.Random.CheckPercentProb(chance))
			{
				int num2 = unluckyChars[resultIndices[i]];
				int num3 = context.Random.Next(12000, 24001);
				Character character = _objects[num2];
				ResourceInts resources = character.GetResources();
				sbyte b = SelectRandomResourceTypeToLose(context.Random, ref resources);
				if (b >= 0)
				{
					int num4 = Math.Min(num3 / GlobalConfig.ResourcesWorth[b], resources.Items[b]);
					Location location = character.GetLocation();
					GameData.Domains.Character.Ai.PersonalNeed personalNeed = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(8, 6, num3 / GlobalConfig.ResourcesWorth[6]);
					character.AddPersonalNeed(context, personalNeed);
					character.ChangeResource(context, b, -num4);
					character.ChangeHappiness(context, -num3 / 1000);
					lifeRecordCollection.AddUnexpectedResourceLose(num2, currDate, location, b, num4);
					monthlyNotificationCollection.AddUnexpectedlyLoseResource(num2, location, num4, b);
					int dataOffset = secretInformationCollection.AddUnexpectedResourceLose(num2, b, location);
					int num5 = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
					num++;
				}
			}
		}
		return num;
	}

	private int ApplyLucky_Item(DataContext context, List<int> luckyChars, int amountOfChars, short itemType, sbyte chance)
	{
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		MonthlyEventCollection monthlyEventCollection = DomainManager.World.GetMonthlyEventCollection();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		int currDate = DomainManager.World.GetCurrDate();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int num = 0;
		Span<int> resultIndices = stackalloc int[amountOfChars];
		RandomUtils.GetRandomUnrepeated(context.Random, 0, luckyChars.Count - 1, resultIndices);
		for (int i = 0; i < amountOfChars; i++)
		{
			if (context.Random.CheckPercentProb(chance))
			{
				int num2 = luckyChars[resultIndices[i]];
				short random = ItemSubType.Type2SubTypes[itemType].GetRandom(context.Random);
				if (ItemSubType.IsHobbyType(random))
				{
					sbyte grade = (sbyte)(context.Random.CheckProb(chance, 1000) ? 7 : 6);
					short randomItemIdInSubType = ItemDomain.GetRandomItemIdInSubType(context.Random, random, grade);
					ItemKey itemKey = DomainManager.Item.CreateItem(context, ItemSubType.GetType(random), randomItemIdInSubType);
					int baseValue = ItemTemplateHelper.GetBaseValue(itemKey.ItemType, itemKey.TemplateId);
					Character character = _objects[num2];
					Location location = character.GetLocation();
					GameData.Domains.Character.Ai.PersonalNeed personalNeed = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed((sbyte)9, (sbyte)6);
					character.AddPersonalNeed(context, personalNeed);
					character.AddInventoryItem(context, itemKey, 1);
					character.ChangeHappiness(context, baseValue / 1000);
					lifeRecordCollection.AddUnexpectedItemGain(num2, currDate, location, itemKey.ItemType, itemKey.TemplateId);
					monthlyNotificationCollection.AddUnexpectedlyGetRareItem(num2, location, itemKey.ItemType, itemKey.TemplateId);
					int dataOffset = secretInformationCollection.AddUnexpectedItemGain(num2, (ulong)itemKey, location);
					int num3 = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
					num++;
				}
			}
		}
		return num;
	}

	private int ApplyUnlucky_Item(DataContext context, List<int> unluckyChars, int amountOfChars, sbyte itemType, sbyte chance)
	{
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		MonthlyEventCollection monthlyEventCollection = DomainManager.World.GetMonthlyEventCollection();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		int currDate = DomainManager.World.GetCurrDate();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int num = 0;
		Span<int> resultIndices = stackalloc int[amountOfChars];
		RandomUtils.GetRandomUnrepeated(context.Random, 0, unluckyChars.Count - 1, resultIndices);
		for (int i = 0; i < amountOfChars; i++)
		{
			if (!context.Random.CheckPercentProb(chance))
			{
				continue;
			}
			int num2 = unluckyChars[resultIndices[i]];
			Character character = _objects[num2];
			ItemKey itemKey = SelectItemFromItemTypeToLose(context.Random, character, itemType);
			if (!itemKey.IsValid())
			{
				continue;
			}
			int baseValue = ItemTemplateHelper.GetBaseValue(itemKey.ItemType, itemKey.TemplateId);
			Location location = character.GetLocation();
			GameData.Domains.Character.Ai.PersonalNeed personalNeed = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(8, 6, baseValue / GlobalConfig.ResourcesWorth[6]);
			character.AddPersonalNeed(context, personalNeed);
			if (!character.GetInventory().Items.ContainsKey(itemKey))
			{
				ItemKey[] equipment = character.GetEquipment();
				for (int j = 0; j < equipment.Length; j++)
				{
					if (itemKey.Equals(equipment[j]))
					{
						equipment[j] = ItemKey.Invalid;
						character.SetEquipment(equipment, context);
						DomainManager.Item.RemoveItem(context, itemKey);
						break;
					}
				}
			}
			else
			{
				character.RemoveInventoryItem(context, itemKey, 1, deleteItem: true);
			}
			character.ChangeHappiness(context, -baseValue / 1000);
			lifeRecordCollection.AddUnexpectedItemLose(num2, currDate, location, itemKey.ItemType, itemKey.TemplateId);
			monthlyNotificationCollection.AddUnexpectedlyLoseRareItem(num2, location, itemKey.ItemType, itemKey.TemplateId);
			int dataOffset = secretInformationCollection.AddUnexpectedItemLose(num2, (ulong)itemKey, location);
			int num3 = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
			num++;
		}
		return num;
	}

	private int ApplyLucky_LifeSkillBook(DataContext context, List<int> luckyChars, int amountOfChars, sbyte chance)
	{
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		MonthlyEventCollection monthlyEventCollection = DomainManager.World.GetMonthlyEventCollection();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		int currDate = DomainManager.World.GetCurrDate();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int num = 0;
		Span<int> resultIndices = stackalloc int[amountOfChars];
		RandomUtils.GetRandomUnrepeated(context.Random, 0, luckyChars.Count - 1, resultIndices);
		for (int i = 0; i < amountOfChars; i++)
		{
			if (context.Random.CheckPercentProb(chance))
			{
				int num2 = luckyChars[resultIndices[i]];
				sbyte grade = (sbyte)(context.Random.CheckProb(chance, 1000) ? 7 : 6);
				short randomItemIdInSubType = ItemDomain.GetRandomItemIdInSubType(context.Random, 1000, grade);
				ItemKey itemKey = DomainManager.Item.CreateSkillBook(context, randomItemIdInSubType, -1, -1, -1, 50);
				SkillBookItem skillBookItem = Config.SkillBook.Instance[itemKey.TemplateId];
				ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey);
				Character character = _objects[num2];
				Location location = character.GetLocation();
				short readingAttainmentRequirement = SkillGradeData.Instance[skillBookItem.Grade].ReadingAttainmentRequirement;
				GameData.Domains.Character.Ai.PersonalNeed personalNeed = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(15, skillBookItem.LifeSkillType, readingAttainmentRequirement);
				character.AddPersonalNeed(context, personalNeed);
				character.AddInventoryItem(context, itemKey, 1);
				character.ChangeHappiness(context, baseItem.GetHappinessChange());
				lifeRecordCollection.AddUnexpectedSkillBookGain(num2, currDate, location, itemKey.ItemType, itemKey.TemplateId);
				monthlyNotificationCollection.AddUnexpectedlyGetLifeSkill(num2, location, itemKey.ItemType, itemKey.TemplateId);
				int dataOffset = secretInformationCollection.AddUnexpectedSkillBookGain(num2, (ulong)itemKey, location);
				int num3 = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
				num++;
			}
		}
		return num;
	}

	private int ApplyUnlucky_LifeSkillBook(DataContext context, List<int> unluckyChars, int amountOfChars, sbyte chance)
	{
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		MonthlyEventCollection monthlyEventCollection = DomainManager.World.GetMonthlyEventCollection();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		int currDate = DomainManager.World.GetCurrDate();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int num = 0;
		Span<int> resultIndices = stackalloc int[amountOfChars];
		RandomUtils.GetRandomUnrepeated(context.Random, 0, unluckyChars.Count - 1, resultIndices);
		for (int i = 0; i < amountOfChars; i++)
		{
			if (context.Random.CheckPercentProb(chance))
			{
				int num2 = unluckyChars[resultIndices[i]];
				Character character = _objects[num2];
				ItemKey itemKey = SelectItemFromItemSubTypeToLose(context.Random, character, 1000);
				if (itemKey.IsValid())
				{
					SkillBookItem skillBookItem = Config.SkillBook.Instance[itemKey.TemplateId];
					ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey);
					Location location = character.GetLocation();
					character.RemoveInventoryItem(context, itemKey, 1, deleteItem: true);
					character.ChangeHappiness(context, -baseItem.GetHappinessChange());
					lifeRecordCollection.AddUnexpectedSkillBookLose(num2, currDate, location, itemKey.ItemType, itemKey.TemplateId);
					monthlyNotificationCollection.AddUnexpectedlyLoseLifeSkill(num2, location, itemKey.ItemType, itemKey.TemplateId);
					int dataOffset = secretInformationCollection.AddUnexpectedSkillBookLose(num2, (ulong)itemKey, location);
					int num3 = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
					num++;
				}
			}
		}
		return num;
	}

	private int ApplyLucky_CombatSkillBook(DataContext context, List<int> luckyChars, int amountOfChars, sbyte chance)
	{
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		MonthlyEventCollection monthlyEventCollection = DomainManager.World.GetMonthlyEventCollection();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		int currDate = DomainManager.World.GetCurrDate();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int num = 0;
		Span<int> resultIndices = stackalloc int[amountOfChars];
		RandomUtils.GetRandomUnrepeated(context.Random, 0, luckyChars.Count - 1, resultIndices);
		for (int i = 0; i < amountOfChars; i++)
		{
			if (context.Random.CheckPercentProb(chance))
			{
				int num2 = luckyChars[resultIndices[i]];
				sbyte grade = (sbyte)(context.Random.CheckProb(chance, 1000) ? 7 : 6);
				short randomItemIdInSubType = ItemDomain.GetRandomItemIdInSubType(context.Random, 1001, grade);
				ItemKey itemKey = DomainManager.Item.CreateSkillBook(context, randomItemIdInSubType, -1, -1, -1, 50);
				SkillBookItem skillBookItem = Config.SkillBook.Instance[itemKey.TemplateId];
				ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey);
				Character character = _objects[num2];
				Location location = character.GetLocation();
				short readingAttainmentRequirement = SkillGradeData.Instance[skillBookItem.Grade].ReadingAttainmentRequirement;
				GameData.Domains.Character.Ai.PersonalNeed personalNeed = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(14, skillBookItem.CombatSkillType, readingAttainmentRequirement);
				character.AddPersonalNeed(context, personalNeed);
				character.AddInventoryItem(context, itemKey, 1);
				character.ChangeHappiness(context, baseItem.GetHappinessChange());
				lifeRecordCollection.AddUnexpectedSkillBookGain(num2, currDate, location, itemKey.ItemType, itemKey.TemplateId);
				monthlyNotificationCollection.AddUnexpectedlyGetCombatSkill(num2, location, itemKey.ItemType, itemKey.TemplateId);
				int dataOffset = secretInformationCollection.AddUnexpectedSkillBookGain(num2, (ulong)itemKey, location);
				int num3 = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
				num++;
			}
		}
		return num;
	}

	private int ApplyUnlucky_CombatSkillBook(DataContext context, List<int> unluckyChars, int amountOfChars, sbyte chance)
	{
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		MonthlyEventCollection monthlyEventCollection = DomainManager.World.GetMonthlyEventCollection();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		int currDate = DomainManager.World.GetCurrDate();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int num = 0;
		Span<int> resultIndices = stackalloc int[amountOfChars];
		RandomUtils.GetRandomUnrepeated(context.Random, 0, unluckyChars.Count - 1, resultIndices);
		for (int i = 0; i < amountOfChars; i++)
		{
			if (context.Random.CheckPercentProb(chance))
			{
				int num2 = unluckyChars[resultIndices[i]];
				Character character = _objects[num2];
				ItemKey itemKey = SelectItemFromItemSubTypeToLose(context.Random, character, 1001);
				if (itemKey.IsValid())
				{
					SkillBookItem skillBookItem = Config.SkillBook.Instance[itemKey.TemplateId];
					ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey);
					Location location = character.GetLocation();
					character.RemoveInventoryItem(context, itemKey, 1, deleteItem: true);
					character.ChangeHappiness(context, -baseItem.GetHappinessChange());
					lifeRecordCollection.AddUnexpectedSkillBookLose(num2, currDate, location, itemKey.ItemType, itemKey.TemplateId);
					monthlyNotificationCollection.AddUnexpectedlyLoseCombatSkill(num2, location, itemKey.ItemType, itemKey.TemplateId);
					int dataOffset = secretInformationCollection.AddUnexpectedSkillBookLose(num2, (ulong)itemKey, location);
					int num3 = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
					num++;
				}
			}
		}
		return num;
	}

	private int ApplyLucky_Regen(DataContext context, List<int> luckyChars, int amountOfChars, sbyte chance)
	{
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		MonthlyEventCollection monthlyEventCollection = DomainManager.World.GetMonthlyEventCollection();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		int currDate = DomainManager.World.GetCurrDate();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int num = 0;
		Span<int> resultIndices = stackalloc int[amountOfChars];
		RandomUtils.GetRandomUnrepeated(context.Random, 0, luckyChars.Count - 1, resultIndices);
		for (int i = 0; i < amountOfChars; i++)
		{
			if (!context.Random.CheckPercentProb(chance))
			{
				continue;
			}
			int num2 = luckyChars[resultIndices[i]];
			Character character = _objects[num2];
			sbyte b = SelectRandomRecoveryType(context.Random, character);
			if (b < 0)
			{
				continue;
			}
			Location location = character.GetLocation();
			switch (b)
			{
			case 0:
			{
				int num4 = 18;
				character.ChangeHealth(context, num4 * 12);
				monthlyNotificationCollection.AddUnexpectedlyGetHealth(num2, location, num4);
				lifeRecordCollection.AddUnexpectedHealthCure(num2, currDate, location, num4);
				if (num2 != taiwuCharId)
				{
				}
				break;
			}
			case 1:
			{
				Injuries injuries2 = character.GetInjuries();
				sbyte b3 = (sbyte)context.Random.Next(3, 10);
				RecoverFixedInjuries(context.Random, ref injuries2, isInnerInjury: false, b3);
				character.SetInjuries(injuries2, context);
				monthlyNotificationCollection.AddUnexpectedlyHealOuterInjury(num2, location, b3);
				lifeRecordCollection.AddUnexpectedOuterInjuryCure(num2, currDate, location, b3);
				if (num2 != taiwuCharId)
				{
				}
				break;
			}
			case 2:
			{
				Injuries injuries = character.GetInjuries();
				sbyte b2 = (sbyte)context.Random.Next(3, 10);
				RecoverFixedInjuries(context.Random, ref injuries, isInnerInjury: true, b2);
				character.SetInjuries(injuries, context);
				monthlyNotificationCollection.AddUnexpectedlyHealInnerInjury(num2, location, b2);
				lifeRecordCollection.AddUnexpectedInnerInjuryCure(num2, currDate, location, b2);
				if (num2 != taiwuCharId)
				{
				}
				break;
			}
			case 3:
			{
				PoisonInts poisoned = character.GetPoisoned();
				int totalRecoverAmount = context.Random.Next(150, 450);
				sbyte poisonType = RecoverFixedPoisoned(context.Random, ref poisoned, totalRecoverAmount);
				character.SetPoisoned(ref poisoned, context);
				monthlyNotificationCollection.AddUnexpectedlyHealPoison(num2, location, poisonType);
				lifeRecordCollection.AddUnexpectedPoisonCure(num2, currDate, location, poisonType);
				if (num2 != taiwuCharId)
				{
				}
				break;
			}
			case 4:
			{
				int num3 = context.Random.Next(3000, 6000);
				character.ChangeDisorderOfQi(context, (short)(-num3));
				monthlyNotificationCollection.AddUnexpectedlyHealQi(num2, location);
				lifeRecordCollection.AddUnexpectedDisorderOfQiCure(num2, currDate, location);
				if (num2 != taiwuCharId)
				{
				}
				break;
			}
			}
			character.ChangeHappiness(context, 15);
			int dataOffset = secretInformationCollection.AddUnexpectedCure(num2, location);
			int num5 = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
			num++;
		}
		return num;
	}

	private unsafe int ApplyUnlucky_Harm(DataContext context, List<int> unluckyChars, int amountOfChars, sbyte chance)
	{
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		MonthlyEventCollection monthlyEventCollection = DomainManager.World.GetMonthlyEventCollection();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		int currDate = DomainManager.World.GetCurrDate();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int num = 0;
		Span<int> resultIndices = stackalloc int[amountOfChars];
		RandomUtils.GetRandomUnrepeated(context.Random, 0, unluckyChars.Count - 1, resultIndices);
		for (int i = 0; i < amountOfChars; i++)
		{
			if (!context.Random.CheckPercentProb(chance))
			{
				continue;
			}
			int num2 = unluckyChars[resultIndices[i]];
			Character character = _objects[num2];
			int num3 = context.Random.Next(5);
			if (num3 < 0)
			{
				continue;
			}
			Location location = character.GetLocation();
			switch (num3)
			{
			case 0:
			{
				int num6 = 6;
				character.ChangeHealth(context, -num6 * 12);
				monthlyNotificationCollection.AddUnexpectedlyLoseHealth(num2, location, num6);
				lifeRecordCollection.AddUnexpectedHealthHarm(num2, currDate, location, num6);
				if (num2 != taiwuCharId)
				{
				}
				break;
			}
			case 1:
			{
				Injuries injuries2 = character.GetInjuries();
				sbyte b3 = (sbyte)context.Random.Next(1, 4);
				GetFixedInjuries(context.Random, ref injuries2, isInnerInjury: false, b3);
				character.SetInjuries(injuries2, context);
				monthlyNotificationCollection.AddUnexpectedlySufferOuterInjury(num2, location, b3);
				lifeRecordCollection.AddUnexpectedOuterInjuryHarm(num2, currDate, location, b3);
				if (num2 != taiwuCharId)
				{
				}
				break;
			}
			case 2:
			{
				Injuries injuries = character.GetInjuries();
				sbyte b2 = (sbyte)context.Random.Next(1, 4);
				GetFixedInjuries(context.Random, ref injuries, isInnerInjury: true, b2);
				character.SetInjuries(injuries, context);
				monthlyNotificationCollection.AddUnexpectedlySufferInneInjury(num2, location, b2);
				lifeRecordCollection.AddUnexpectedInnerInjuryHarm(num2, currDate, location, b2);
				if (num2 != taiwuCharId)
				{
				}
				break;
			}
			case 3:
			{
				PoisonInts delta = default(PoisonInts);
				int num5 = context.Random.Next(50, 150);
				sbyte b = (sbyte)context.Random.Next(6);
				ref int reference = ref delta.Items[b];
				reference += num5;
				character.DirectlyChangePoisoned(context, ref delta);
				monthlyNotificationCollection.AddUnexpectedlySufferPoison(num2, location, b);
				lifeRecordCollection.AddUnexpectedPoisonHarm(num2, currDate, location, b);
				if (num2 != taiwuCharId)
				{
				}
				break;
			}
			case 4:
			{
				int num4 = context.Random.Next(1000, 2000);
				character.ChangeDisorderOfQi(context, (short)num4);
				monthlyNotificationCollection.AddUnexpectedlySufferDisorderOfQi(num2, location);
				lifeRecordCollection.AddUnexpectedDisorderOfQiHarm(num2, currDate, location);
				if (num2 != taiwuCharId)
				{
				}
				break;
			}
			}
			character.ChangeHappiness(context, 15);
			int dataOffset = secretInformationCollection.AddUnexpectedHarm(num2, location);
			int num7 = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
			num++;
		}
		return num;
	}

	private sbyte SelectRandomRecoveryType(IRandomSource random, Character character)
	{
		Span<sbyte> span = stackalloc sbyte[5];
		int num = 0;
		if (character.GetHealth() != character.GetLeftMaxHealth())
		{
			span[num] = 0;
			num++;
		}
		if (character.GetInjuries().HasAnyInjury(isInnerInjury: false))
		{
			span[num] = 1;
			num++;
		}
		if (character.GetInjuries().HasAnyInjury(isInnerInjury: true))
		{
			span[num] = 2;
			num++;
		}
		if (character.GetPoisoned().IsNonZero())
		{
			span[num] = 3;
			num++;
		}
		if (character.GetDisorderOfQi() > 0)
		{
			span[num] = 4;
			num++;
		}
		if (num > 0)
		{
			return span[random.Next(num)];
		}
		return -1;
	}

	private unsafe sbyte SelectRandomResourceTypeToLose(IRandomSource random, ref ResourceInts resources)
	{
		Span<sbyte> span = stackalloc sbyte[7];
		int num = 0;
		for (sbyte b = 0; b < 7; b++)
		{
			if (resources.Items[b] > 0)
			{
				span[num] = b;
				num++;
			}
		}
		if (num > 0)
		{
			return span[random.Next(num)];
		}
		return -1;
	}

	private ItemKey SelectItemFromItemTypeToLose(IRandomSource random, Character character, sbyte itemType)
	{
		List<ItemKey> list = ObjectPool<List<ItemKey>>.Instance.Get();
		list.Clear();
		sbyte b = -1;
		foreach (var (item, _) in character.GetInventory().Items)
		{
			if (item.ItemType == itemType)
			{
				sbyte grade = ItemTemplateHelper.GetGrade(item.ItemType, item.TemplateId);
				if (grade > b)
				{
					list.Clear();
				}
				else if (grade < b)
				{
					continue;
				}
				list.Add(item);
			}
		}
		ItemKey[] equipment = character.GetEquipment();
		for (int i = 0; i < equipment.Length; i++)
		{
			ItemKey item2 = equipment[i];
			if (item2.IsValid() && item2.ItemType == itemType)
			{
				sbyte grade2 = ItemTemplateHelper.GetGrade(item2.ItemType, item2.TemplateId);
				if (grade2 > b)
				{
					list.Clear();
				}
				else if (grade2 < b)
				{
					continue;
				}
				list.Add(item2);
			}
		}
		ItemKey result = ItemKey.Invalid;
		if (list.Count > 0)
		{
			result = list.GetRandom(random);
		}
		ObjectPool<List<ItemKey>>.Instance.Return(list);
		return result;
	}

	private ItemKey SelectItemFromItemSubTypeToLose(IRandomSource random, Character character, short itemSubType)
	{
		List<ItemKey> list = ObjectPool<List<ItemKey>>.Instance.Get();
		list.Clear();
		sbyte b = -1;
		foreach (var (item, _) in character.GetInventory().Items)
		{
			if (ItemTemplateHelper.GetItemSubType(item.ItemType, item.TemplateId) == itemSubType)
			{
				sbyte grade = ItemTemplateHelper.GetGrade(item.ItemType, item.TemplateId);
				if (grade > b)
				{
					list.Clear();
				}
				else if (grade < b)
				{
					continue;
				}
				list.Add(item);
			}
		}
		ItemKey[] equipment = character.GetEquipment();
		for (int i = 0; i < equipment.Length; i++)
		{
			ItemKey item2 = equipment[i];
			if (item2.IsValid() && ItemTemplateHelper.GetItemSubType(item2.ItemType, item2.TemplateId) == itemSubType)
			{
				sbyte grade2 = ItemTemplateHelper.GetGrade(item2.ItemType, item2.TemplateId);
				if (grade2 > b)
				{
					list.Clear();
				}
				else if (grade2 < b)
				{
					continue;
				}
				list.Add(item2);
			}
		}
		ItemKey result = ItemKey.Invalid;
		if (list.Count > 0)
		{
			result = list.GetRandom(random);
		}
		ObjectPool<List<ItemKey>>.Instance.Return(list);
		return result;
	}

	private void RecoverFixedInjuries(IRandomSource random, ref Injuries injuries, bool isInnerInjury, sbyte totalRecoverAmount)
	{
		Span<sbyte> span = stackalloc sbyte[7];
		for (int i = 0; i < totalRecoverAmount; i++)
		{
			int num = 0;
			for (sbyte b = 0; b < 7; b++)
			{
				if (injuries.Get(b, isInnerInjury) > 0)
				{
					span[num] = b;
					num++;
				}
			}
			if (num == 0)
			{
				break;
			}
			sbyte bodyPartType = span[random.Next(num)];
			injuries.Change(bodyPartType, isInnerInjury, -1);
		}
	}

	private void GetOrHealRandomInjuriesWithoutChecking(IRandomSource random, ref Injuries injuries, int minAmount, int maxAmount)
	{
		int num = random.Next(minAmount, maxAmount + 1);
		for (int i = 0; i < num; i++)
		{
			sbyte internalIndex = (sbyte)random.Next(14);
			injuries.Change(internalIndex, 1);
		}
	}

	private unsafe void GetOrDetoxRandomPoisonsWithoutChecking(IRandomSource random, ref PoisonInts poisoned, int poisonTypeCount, int minAmount, int maxAmount)
	{
		for (int i = 0; i < poisonTypeCount; i++)
		{
			int num = random.Next(6);
			int num2 = random.Next(minAmount, maxAmount + 1);
			ref int reference = ref poisoned.Items[num];
			reference += num2;
			if (poisoned.Items[num] < 0)
			{
				poisoned.Items[num] = 0;
			}
		}
	}

	private void GetFixedInjuries(IRandomSource random, ref Injuries injuries, bool isInnerInjury, sbyte totalInjureAmount)
	{
		Span<sbyte> span = stackalloc sbyte[7];
		for (int i = 0; i < totalInjureAmount; i++)
		{
			int num = 0;
			for (sbyte b = 0; b < 7; b++)
			{
				if (injuries.Get(b, isInnerInjury) < 6)
				{
					span[num] = b;
					num++;
				}
			}
			if (num == 0)
			{
				break;
			}
			sbyte bodyPartType = span[random.Next(num)];
			injuries.Change(bodyPartType, isInnerInjury, 1);
		}
	}

	private unsafe sbyte RecoverFixedPoisoned(IRandomSource random, ref PoisonInts poisoned, int totalRecoverAmount)
	{
		Span<sbyte> span = stackalloc sbyte[6];
		int num = 0;
		for (sbyte b = 0; b < 6; b++)
		{
			if (poisoned.Items[b] > 0)
			{
				span[num] = b;
				num++;
			}
		}
		Tester.Assert(num > 0);
		sbyte b2 = span[random.Next(num)];
		Tester.Assert(b2 >= 0 && b2 < 6, $"{b2} >= 0 && {b2} < PoisonType.Count");
		int val = poisoned.Items[b2];
		int num2 = Math.Min(totalRecoverAmount, val);
		ref int reference = ref poisoned.Items[b2];
		reference -= num2;
		return b2;
	}

	private void InitializeXiangshuLocations()
	{
		_tripleHateLocation = Location.Invalid;
		_tripleAdoreLocation = Location.Invalid;
		_forceRebelLocation = Location.Invalid;
		_forceKindLocation = Location.Invalid;
		_doubleAgeIncreaseLocation = Location.Invalid;
		_noAgeIncreaseLocation = Location.Invalid;
		foreach (var (num3, key) in _fixedCharactersCache)
		{
			switch (num3)
			{
			case 43:
				_tripleAdoreLocation = _objects[key].GetLocation();
				break;
			case 45:
				_forceKindLocation = _objects[key].GetLocation();
				break;
			case 47:
				_noAgeIncreaseLocation = _objects[key].GetLocation();
				break;
			case 165:
			case 166:
			case 167:
			case 168:
			case 169:
			case 170:
			case 171:
			case 172:
			case 173:
				_tripleHateLocation = _objects[key].GetLocation();
				break;
			case 183:
			case 184:
			case 185:
			case 186:
			case 187:
			case 188:
			case 189:
			case 190:
			case 191:
				_forceRebelLocation = _objects[key].GetLocation();
				break;
			case 201:
			case 202:
			case 203:
			case 204:
			case 205:
			case 206:
			case 207:
			case 208:
			case 209:
				_doubleAgeIncreaseLocation = _objects[key].GetLocation();
				break;
			}
		}
	}

	public void OnFixedCharacterLocationChanged(DataContext context, int charId, Location srcLocation, Location destLocation)
	{
		Character character = _objects[charId];
		switch (character.GetTemplateId())
		{
		case 43:
			_tripleAdoreLocation = destLocation;
			break;
		case 45:
			SetForceKindLocation(destLocation, context);
			break;
		case 47:
			_noAgeIncreaseLocation = destLocation;
			break;
		case 165:
		case 166:
		case 167:
		case 168:
		case 169:
		case 170:
		case 171:
		case 172:
		case 173:
			_tripleHateLocation = destLocation;
			break;
		case 183:
		case 184:
		case 185:
		case 186:
		case 187:
		case 188:
		case 189:
		case 190:
		case 191:
			SetForceRebelLocation(destLocation, context);
			break;
		case 201:
		case 202:
		case 203:
		case 204:
		case 205:
		case 206:
		case 207:
		case 208:
		case 209:
			_doubleAgeIncreaseLocation = destLocation;
			break;
		}
	}

	public unsafe bool TransferAvoidDeathCharInjuries(DataContext context)
	{
		if (_avoidDeathCharId < 0)
		{
			return false;
		}
		Character character = _objects[_avoidDeathCharId];
		Location location = character.GetLocation();
		if (!location.IsValid())
		{
			location = character.GetValidLocation();
		}
		int randomCharacterInRange = GetRandomCharacterInRange(context, location, 2, includeTaiwu: true);
		if (randomCharacterInRange < 0)
		{
			return false;
		}
		Character character2 = _objects[randomCharacterInRange];
		Injuries injuries = character.GetInjuries();
		character2.ChangeInjuries(context, injuries);
		injuries.Initialize();
		character.SetInjuries(injuries, context);
		PoisonInts poisoned = character.GetPoisoned();
		for (sbyte b = 0; b < 6; b++)
		{
			character2.ChangePoisoned(context, b, 3, poisoned.Items[b]);
		}
		poisoned = default(PoisonInts);
		character.SetPoisoned(ref poisoned, context);
		character.TransferDisorderOfQi(context, character2, character.GetDisorderOfQi());
		EatingItems eatingItems = character.GetEatingItems();
		for (sbyte b2 = 0; b2 < 9; b2++)
		{
			ItemKey itemKey = (ItemKey)eatingItems.ItemKeys[b2];
			if (itemKey.ItemType == 8 && ItemTemplateHelper.GetItemSubType(itemKey.ItemType, itemKey.TemplateId) == 802)
			{
				character2.AddWug(context, itemKey.TemplateId);
				character.RemoveWug(context, itemKey.TemplateId);
			}
		}
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		int currDate = DomainManager.World.GetCurrDate();
		if (character.GetCreatingType() == 0)
		{
			lifeRecordCollection.AddWeiQiBad(randomCharacterInRange, currDate, character2.GetLocation());
		}
		else
		{
			lifeRecordCollection.AddWeiQiGood(_avoidDeathCharId, currDate, location);
		}
		if (DomainManager.World.GetAdvancingMonthState() == 0)
		{
			DomainManager.LifeRecord.CommitCurrLifeRecords();
		}
		SetAvoidDeathCharId(-1, context);
		return true;
	}

	public static void AddLockMovementCharSet(int charId)
	{
		LockMovementCharSet.Add(charId);
	}

	public static bool IsLockMovementChar(int charId)
	{
		return LockMovementCharSet.Contains(charId);
	}

	public static void ClearLockMovementCharSet()
	{
		LockMovementCharSet.Clear();
	}

	public void UpdateFixedCharacterMovements(DataContext context)
	{
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		list.Clear();
		list.AddRange(_fixedCharactersCache.Values);
		foreach (int item in list)
		{
			Character character = _objects[item];
			if (character.GetLocation().IsValid())
			{
				switch (character.GetTemplateId())
				{
				case 39:
					JuniorMonvMovement(context, character);
					break;
				case 40:
					JuniorDayueYaochangMovement(context, character);
					break;
				case 41:
					JuniorJiuhanMovement(context, character);
					break;
				case 42:
					JuniorJinHuangerMovement(context, character);
					break;
				case 43:
					JuniorYiyihouMovement(context, character);
					break;
				case 44:
					JuniorWeiQiMovement(context, character);
					break;
				case 45:
					JuniorYixiangMovement(context, character);
					break;
				case 46:
					JuniorXuefengMovement(context, character);
					break;
				case 47:
					JuniorShuFangMovement(context, character);
					break;
				case 129:
				case 130:
				case 131:
				case 132:
				case 133:
				case 134:
				case 135:
				case 136:
				case 137:
					MonvMovement(context, character);
					break;
				case 138:
				case 139:
				case 140:
				case 141:
				case 142:
				case 143:
				case 144:
				case 145:
				case 146:
					DayueYaochangMovement(context, character);
					break;
				case 147:
				case 148:
				case 149:
				case 150:
				case 151:
				case 152:
				case 153:
				case 154:
				case 155:
					JiuhanMovement(context, character);
					break;
				case 156:
				case 157:
				case 158:
				case 159:
				case 160:
				case 161:
				case 162:
				case 163:
				case 164:
					JinHuangerMovement(context, character);
					break;
				case 165:
				case 166:
				case 167:
				case 168:
				case 169:
				case 170:
				case 171:
				case 172:
				case 173:
					YiYihouMovement(context, character);
					break;
				case 174:
				case 175:
				case 176:
				case 177:
				case 178:
				case 179:
				case 180:
				case 181:
				case 182:
					WeiQiMovement(context, character);
					break;
				case 183:
				case 184:
				case 185:
				case 186:
				case 187:
				case 188:
				case 189:
				case 190:
				case 191:
					YixiangMovement(context, character);
					break;
				case 192:
				case 193:
				case 194:
				case 195:
				case 196:
				case 197:
				case 198:
				case 199:
				case 200:
					XuefengMovement(context, character);
					break;
				case 201:
				case 202:
				case 203:
				case 204:
				case 205:
				case 206:
				case 207:
				case 208:
				case 209:
					ShufangMovement(context, character);
					break;
				case 447:
					ZiWuxiaoMovement(context, character);
					break;
				case 441:
					RanchenziMovement(context, character);
					break;
				case 446:
					LongYufuMovement(context, character);
					break;
				case 521:
				case 522:
				case 523:
				case 524:
				case 525:
				case 526:
				case 527:
				case 528:
				case 529:
				case 530:
				case 531:
				case 532:
				case 533:
				case 534:
				case 535:
				case 536:
					XuehouOldManMovement(context, character);
					break;
				case 537:
				case 538:
				case 539:
					JixiMovement(context, character);
					break;
				case 543:
				case 544:
				case 545:
				case 546:
				case 547:
					SloppyTaoistMonkMovement(context, character);
					break;
				case 667:
					TripodVesselOfMedicineMovement(context, character);
					break;
				case 672:
					WudangBlackSnakeMovement(context, character);
					break;
				case 747:
					ImpersonatorBuddhistMonkMovement(context, character);
					break;
				case 781:
				case 786:
					BaihuaLeMeMovement(context, character);
					break;
				case 808:
				case 809:
					BaihuaBaiLuXuanXiaoMovement(context, character);
					break;
				case 810:
					FulongReudhLazuliMovement(context, character);
					break;
				case 812:
					FulongReudhLazuliFeatherMovement(context, character);
					break;
				case 836:
					GearMateMovement(context, character);
					break;
				}
			}
		}
		ObjectPool<List<int>>.Instance.Return(list);
	}

	private static Location CalcXiangshuMovementNextBlock(Location start, Location end, bool avoidChars, bool attractedByChars)
	{
		if (start.Equals(end))
		{
			return end;
		}
		MapBlockData rootBlock = DomainManager.Map.GetBlock(start).GetRootBlock();
		if (BlockHasSwordTombKeeper(rootBlock))
		{
			return start;
		}
		List<MapBlockData> groupBlockList = rootBlock.GroupBlockList;
		if (groupBlockList != null && groupBlockList.Count > 0)
		{
			foreach (MapBlockData groupBlock in rootBlock.GroupBlockList)
			{
				if (BlockHasSwordTombKeeper(groupBlock))
				{
					return start;
				}
			}
		}
		byte areaSize = DomainManager.Map.GetAreaSize(start.AreaId);
		_xiangshuMovementMap.InitMap(areaSize, areaSize, delegate(ByteCoordinate coord)
		{
			MapBlockData block = DomainManager.Map.GetBlock(start.AreaId, ByteCoordinate.CoordinateToIndex(coord, areaSize));
			if (avoidChars)
			{
				return (sbyte)((block.CharacterSet == null) ? 1 : 4);
			}
			return (sbyte)((!attractedByChars) ? 1 : ((sbyte)((block.CharacterSet != null) ? 1 : 4)));
		});
		List<ByteCoordinate> path = ObjectPool<List<ByteCoordinate>>.Instance.Get();
		_xiangshuMovementMap.FindWay(ByteCoordinate.IndexToCoordinate(start.BlockId, areaSize), ByteCoordinate.IndexToCoordinate(end.BlockId, areaSize), ref path);
		short blockId = ByteCoordinate.CoordinateToIndex(path[1], areaSize);
		ObjectPool<List<ByteCoordinate>>.Instance.Return(path);
		return new Location(start.AreaId, blockId);
		static bool BlockHasSwordTombKeeper(MapBlockData blockData)
		{
			if (blockData.CharacterSet == null)
			{
				return false;
			}
			foreach (int item in blockData.CharacterSet)
			{
				VillagerRoleBase villagerRole = DomainManager.Extra.GetVillagerRole(item);
				if ((!DomainManager.Character.TryGetElement_Objects(item, out var element) || !element.ReachFallenInCombat(CombatType.Die)) && villagerRole != null && villagerRole.ArrangementTemplateId == 3)
				{
					return true;
				}
			}
			return false;
		}
	}

	private void MonvMovement(DataContext context, Character character)
	{
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		Location location2 = character.GetLocation();
		Location location3 = CalcXiangshuMovementNextBlock(location2, taiwuVillageLocation, avoidChars: true, attractedByChars: false);
		if (!location2.Equals(location3))
		{
			character.SetLocation(location3, context);
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), location2, location3);
		}
		else
		{
			DomainManager.Building.XiangshuDestroyTaiwuVillageBuilding(context, location3);
		}
		DomainManager.Taiwu.UpdateSwordTombKeepersOnXiangshuAvatarMoved(context, character, location3);
		int randomCharacterInRange = GetRandomCharacterInRange(context, location3, 1, includeTaiwu: true);
		if (randomCharacterInRange >= 0)
		{
			Character character2 = _objects[randomCharacterInRange];
			Injuries injuries = character2.GetInjuries();
			PoisonInts poisoned = default(PoisonInts);
			GetOrHealRandomInjuriesWithoutChecking(context.Random, ref injuries, 3, 6);
			GetOrDetoxRandomPoisonsWithoutChecking(context.Random, ref poisoned, 3, 100, 300);
			character2.SetInjuries(injuries, context);
			character2.DirectlyChangePoisoned(context, ref poisoned);
			int currDate = DomainManager.World.GetCurrDate();
			DomainManager.LifeRecord.GetLifeRecordCollection().AddMonvBad(randomCharacterInRange, currDate, location3);
			DomainManager.World.GetMonthlyNotificationCollection().AddMonvBringDisaster(location3, randomCharacterInRange);
		}
	}

	private void DayueYaochangMovement(DataContext context, Character character)
	{
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		Location location = character.GetLocation();
		Location location2 = CalcXiangshuMovementNextBlock(location, taiwuVillageLocation, avoidChars: false, attractedByChars: false);
		if (!location.Equals(location2))
		{
			character.SetLocation(location2, context);
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), location, location2);
		}
		else
		{
			DomainManager.Building.XiangshuDestroyTaiwuVillageBuilding(context, location2);
		}
		DomainManager.Taiwu.UpdateSwordTombKeepersOnXiangshuAvatarMoved(context, character, location2);
		int randomCharacterInRange = GetRandomCharacterInRange(context, location2, 1, includeTaiwu: false);
		if (randomCharacterInRange >= 0)
		{
			DomainManager.World.GetMonthlyNotificationCollection().AddDayueYaochangBringDisaster(location2, randomCharacterInRange);
			if (randomCharacterInRange == DomainManager.Taiwu.GetTaiwuCharId())
			{
				DomainManager.World.SetTaiwuDying();
			}
			else
			{
				MakeCharacterDead(context, _objects[randomCharacterInRange], 12);
			}
		}
	}

	private void JiuhanMovement(DataContext context, Character character)
	{
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		Location location = character.GetLocation();
		Location location2 = CalcXiangshuMovementNextBlock(location, taiwuVillageLocation, avoidChars: true, attractedByChars: false);
		if (!location.Equals(location2))
		{
			character.SetLocation(location2, context);
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), location, location2);
		}
		else
		{
			DomainManager.Building.XiangshuDestroyTaiwuVillageBuilding(context, location2);
		}
		DomainManager.Taiwu.UpdateSwordTombKeepersOnXiangshuAvatarMoved(context, character, location2);
		List<MapBlockData> obj = context.AdvanceMonthRelatedData.Blocks.Occupy();
		DomainManager.Map.GetRealNeighborBlocks(location2.AreaId, location2.BlockId, obj, 1, includeCenter: true);
		foreach (MapBlockData item in obj)
		{
			if (!item.Destroyed && !item.IsCityTown() && item.TemplateId != 37 && item.RootBlockId < 0 && item.GroupBlockList == null)
			{
				item.Destroyed = true;
				item.DestroyItemsDirect(context.AdvanceMonthRelatedData.WorldItemsToBeRemoved);
				item.CurrResources.Initialize();
				DomainManager.Map.SetBlockData(context, item);
			}
		}
		context.AdvanceMonthRelatedData.Blocks.Release(ref obj);
		DomainManager.World.GetMonthlyNotificationCollection().AddJiuhanvBringDisaster(location2);
	}

	private void JinHuangerMovement(DataContext context, Character character)
	{
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		Location location2 = character.GetLocation();
		Location location3 = CalcXiangshuMovementNextBlock(location2, taiwuVillageLocation, avoidChars: false, attractedByChars: true);
		if (!location2.Equals(location3))
		{
			character.SetLocation(location3, context);
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), location2, location3);
		}
		else
		{
			DomainManager.Building.XiangshuDestroyTaiwuVillageBuilding(context, location3);
		}
		DomainManager.Taiwu.UpdateSwordTombKeepersOnXiangshuAvatarMoved(context, character, location3);
		if (!context.Random.CheckPercentProb(80))
		{
			return;
		}
		int randomCharacterInRange = GetRandomCharacterInRange(context, location3, 2, includeTaiwu: true);
		if (randomCharacterInRange < 0)
		{
			return;
		}
		List<int> obj = context.AdvanceMonthRelatedData.CharIdList.Occupy();
		obj.Add(randomCharacterInRange);
		Span<int> resultIndices = stackalloc int[7];
		RandomUtils.GetRandomUnrepeated(context.Random, 0, 6, resultIndices);
		for (int i = 0; i < 7; i++)
		{
			int num = resultIndices[i];
			if (1 == 0)
			{
			}
			int num2 = num switch
			{
				0 => ApplyUnlucky_Resource(context, obj, 1, 100), 
				1 => ApplyUnlucky_Item(context, obj, 1, 2, 100), 
				2 => ApplyUnlucky_Item(context, obj, 1, 0, 100), 
				3 => ApplyUnlucky_Item(context, obj, 1, 1, 100), 
				4 => ApplyUnlucky_CombatSkillBook(context, obj, 1, 100), 
				5 => ApplyUnlucky_LifeSkillBook(context, obj, 1, 100), 
				6 => ApplyUnlucky_Harm(context, obj, 1, 100), 
				_ => 0, 
			};
			if (1 == 0)
			{
			}
			int num3 = num2;
			if (num3 > 0)
			{
				int currDate = DomainManager.World.GetCurrDate();
				DomainManager.LifeRecord.GetLifeRecordCollection().AddJinHuangerBad(randomCharacterInRange, currDate, location3);
				DomainManager.World.GetMonthlyNotificationCollection().AddJinHuangervBringDisaster(location3, randomCharacterInRange);
				break;
			}
		}
		context.AdvanceMonthRelatedData.CharIdList.Release(ref obj);
	}

	private void YiYihouMovement(DataContext context, Character character)
	{
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		Location location = character.GetLocation();
		Location location2 = CalcXiangshuMovementNextBlock(location, taiwuVillageLocation, avoidChars: false, attractedByChars: true);
		if (!location.Equals(location2))
		{
			character.SetLocation(location2, context);
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), location, location2);
		}
		else
		{
			DomainManager.Building.XiangshuDestroyTaiwuVillageBuilding(context, location2);
		}
		DomainManager.Taiwu.UpdateSwordTombKeepersOnXiangshuAvatarMoved(context, character, location2);
		DomainManager.World.GetMonthlyNotificationCollection().AddYiYihouvBringDisaster(location2);
	}

	private void WeiQiMovement(DataContext context, Character character)
	{
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		Location location2 = character.GetLocation();
		Location location3 = CalcXiangshuMovementNextBlock(location2, taiwuVillageLocation, avoidChars: true, attractedByChars: false);
		if (!location2.Equals(location3))
		{
			character.SetLocation(location3, context);
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), location2, location3);
		}
		else
		{
			DomainManager.Building.XiangshuDestroyTaiwuVillageBuilding(context, location3);
		}
		SetAvoidDeathCharId(character.GetId(), context);
	}

	private void YixiangMovement(DataContext context, Character character)
	{
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		Location location2 = character.GetLocation();
		Location location3 = CalcXiangshuMovementNextBlock(location2, taiwuVillageLocation, avoidChars: false, attractedByChars: false);
		if (!location2.Equals(location3))
		{
			character.SetLocation(location3, context);
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), location2, location3);
		}
		else
		{
			DomainManager.Building.XiangshuDestroyTaiwuVillageBuilding(context, location3);
		}
		DomainManager.Taiwu.UpdateSwordTombKeepersOnXiangshuAvatarMoved(context, character, location3);
		int randomCharacterInRange = GetRandomCharacterInRange(context, location3, 3, includeTaiwu: true);
		if (randomCharacterInRange < 0)
		{
			DomainManager.World.GetMonthlyNotificationCollection().AddYixiangvBringDisaster(location3);
		}
	}

	private void XuefengMovement(DataContext context, Character character)
	{
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		Location location = character.GetLocation();
		Location location2 = CalcXiangshuMovementNextBlock(location, taiwuVillageLocation, avoidChars: true, attractedByChars: false);
		if (!location.Equals(location2))
		{
			character.SetLocation(location2, context);
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), location, location2);
		}
		else
		{
			DomainManager.Building.XiangshuDestroyTaiwuVillageBuilding(context, location2);
		}
		DomainManager.Taiwu.UpdateSwordTombKeepersOnXiangshuAvatarMoved(context, character, location2);
		List<MapBlockData> obj = context.AdvanceMonthRelatedData.Blocks.Occupy();
		DomainManager.Adventure.GetValidBlocksForRandomEnemy(location2.AreaId, location2.BlockId, 1, onAdventureSite: true, onSettlement: false, nearTaiwu: true, obj);
		int num = 298 + DomainManager.World.GetXiangshuLevel();
		for (int i = 0; i < 3; i++)
		{
			short enemyTemplateId = (short)Math.Clamp(context.Random.Next(num - 1, num + 2), 298, 306);
			DomainManager.Adventure.CreateTemporaryEnemiesOnValidBlocks(context, Location.Invalid, enemyTemplateId, 1, obj);
		}
		context.AdvanceMonthRelatedData.Blocks.Release(ref obj);
		DomainManager.World.GetMonthlyNotificationCollection().AddXuefengBringDisaster(location2);
	}

	private void ShufangMovement(DataContext context, Character character)
	{
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		Location location2 = character.GetLocation();
		Location location3 = CalcXiangshuMovementNextBlock(location2, taiwuVillageLocation, avoidChars: true, attractedByChars: false);
		if (!location2.Equals(location3))
		{
			character.SetLocation(location3, context);
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), location2, location3);
		}
		else
		{
			DomainManager.Building.XiangshuDestroyTaiwuVillageBuilding(context, location3);
		}
		DomainManager.Taiwu.UpdateSwordTombKeepersOnXiangshuAvatarMoved(context, character, location3);
		int randomCharacterInRange = GetRandomCharacterInRange(context, location3, 2, includeTaiwu: true);
		if (randomCharacterInRange >= 0)
		{
			Character character2 = _objects[randomCharacterInRange];
			short currAge = character2.GetCurrAge();
			short num = (short)(currAge + 1);
			character2.SetCurrAge(num, context);
			Events.RaiseCharacterAgeChanged(context, character2, currAge, num);
			int currDate = DomainManager.World.GetCurrDate();
			DomainManager.LifeRecord.GetLifeRecordCollection().AddShufangBad(randomCharacterInRange, currDate, location3);
			DomainManager.World.GetMonthlyNotificationCollection().AddShuFangvBringDisaster(location3, randomCharacterInRange);
			short num2 = -1;
			if (num == 16)
			{
				OrganizationMemberItem orgMemberConfig = OrganizationDomain.GetOrgMemberConfig(character2.GetOrganizationInfo());
				num2 = OrganizationDomain.GetRandomOrgMemberClothing(context.Random, orgMemberConfig);
			}
			else if (num == GlobalConfig.Instance.AgeBaby)
			{
				num2 = 65;
			}
			if (num2 >= 0)
			{
				character2.ForceReplaceClothing(context, num2);
			}
		}
	}

	private static void UpdateJuniorXiangshuTravelTarget(DataContext context, Character character, int duration, Func<short> getArea)
	{
		List<NpcTravelTarget> npcTravelTargets = character.GetNpcTravelTargets();
		if (npcTravelTargets.Count > 0)
		{
			NpcTravelTarget value = npcTravelTargets[0];
			value.RemainingMonth--;
			if (value.RemainingMonth <= 0)
			{
				npcTravelTargets.RemoveAt(0);
			}
			else
			{
				npcTravelTargets[0] = value;
			}
			character.SetNpcTravelTargets(npcTravelTargets, context);
		}
		if (npcTravelTargets.Count <= 0)
		{
			short areaId = getArea();
			Location targetLocation = new Location(areaId, -1);
			NpcTravelTarget target = new NpcTravelTarget(targetLocation, duration);
			character.AddTravelTarget(context, target);
		}
	}

	private static Location SelectJuniorXiangshuNextBlock(IRandomSource random, short areaId, Predicate<MapBlockData> predicate)
	{
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		if (predicate == null)
		{
			DomainManager.Map.GetPassableBlocksInArea(areaId, list);
			short blockId = list[random.Next(list.Count)].BlockId;
			ObjectPool<List<MapBlockData>>.Instance.Return(list);
			return new Location(areaId, blockId);
		}
		predicate = (Predicate<MapBlockData>)Delegate.Combine(predicate, new Predicate<MapBlockData>(MapBlockDataMatchers.IsValidForJuniorXiangshu));
		DomainManager.Map.GetMapBlocksInAreaByFilters(areaId, predicate, list);
		if (list.Count <= 0)
		{
			ObjectPool<List<MapBlockData>>.Instance.Return(list);
			return Location.Invalid;
		}
		Location result = new Location(areaId, list.GetRandom(random).BlockId);
		ObjectPool<List<MapBlockData>>.Instance.Return(list);
		return result;
	}

	private static Location SelectJuniorXiangshuRandomNextBlock(DataContext context, Location srcLocation)
	{
		List<MapBlockData> obj = context.AdvanceMonthRelatedData.Blocks.Occupy();
		DomainManager.Adventure.GetValidBlocksForRandomEnemy(srcLocation.AreaId, srcLocation.BlockId, 3, onAdventureSite: false, onSettlement: false, nearTaiwu: true, obj);
		short blockId = ((obj.Count == 0) ? srcLocation.BlockId : obj.GetRandom(context.Random).BlockId);
		context.AdvanceMonthRelatedData.Blocks.Release(ref obj);
		return new Location(srcLocation.AreaId, blockId);
	}

	private void UpdateJuniorXiangshuFollowingTarget(DataContext context, Character character, int duration, Func<Character, int> selectValue)
	{
		List<NpcTravelTarget> npcTravelTargets = character.GetNpcTravelTargets();
		if (npcTravelTargets.Count > 0)
		{
			NpcTravelTarget value = npcTravelTargets[0];
			value.RemainingMonth--;
			if (value.RemainingMonth <= 0 || !TryGetElement_Objects(value.TargetCharId, out var element) || (!element.GetLocation().IsValid() && !element.IsCrossAreaTraveling()) || DomainManager.Taiwu.IsInGroup(element.GetId()) || element.GetCreatingType() != 1)
			{
				npcTravelTargets.RemoveAt(0);
			}
			else
			{
				npcTravelTargets[0] = value;
			}
			character.SetNpcTravelTargets(npcTravelTargets, context);
		}
		if (npcTravelTargets.Count <= 0)
		{
			int num = SelectJuniorXiangshuFollowingCharacter(context.Random, selectValue);
			if (num >= 0)
			{
				NpcTravelTarget target = new NpcTravelTarget(num, duration);
				character.AddTravelTarget(context, target);
			}
		}
	}

	private int SelectJuniorXiangshuFollowingCharacter(IRandomSource random, Func<Character, int> selectValue)
	{
		int num = int.MinValue;
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		list.Clear();
		CharacterMatcherItem juniorXiangshuFollowingCharacter = CharacterMatcher.DefValue.JuniorXiangshuFollowingCharacter;
		foreach (KeyValuePair<int, Character> @object in _objects)
		{
			Character value = @object.Value;
			if (juniorXiangshuFollowingCharacter.Match(value))
			{
				int num2 = selectValue(value);
				if (num2 > num)
				{
					num = num2;
					list.Clear();
					list.Add(@object.Key);
				}
				else if (num2 == num)
				{
					list.Add(@object.Key);
				}
			}
		}
		if (list.Count <= 0)
		{
			return -1;
		}
		int random2 = list.GetRandom(random);
		ObjectPool<List<int>>.Instance.Return(list);
		return random2;
	}

	private bool CheckJuniorXiangshuAvatarForbidMovement(Character character)
	{
		if (character.GetXiangshuType() != 3)
		{
			return false;
		}
		sbyte xiangshuAvatarIdByCharacterTemplateId = XiangshuAvatarIds.GetXiangshuAvatarIdByCharacterTemplateId(character.GetTemplateId());
		XiangshuAvatarTaskStatus element_XiangshuAvatarTaskStatuses = DomainManager.World.GetElement_XiangshuAvatarTaskStatuses(xiangshuAvatarIdByCharacterTemplateId);
		short xiangshuAvatarFavorability = DomainManager.World.GetXiangshuAvatarFavorability(xiangshuAvatarIdByCharacterTemplateId);
		return element_XiangshuAvatarTaskStatuses.JuniorXiangshuTaskStatus <= 4 && FavorabilityType.GetFavorabilityType(xiangshuAvatarFavorability) >= 5;
	}

	private void JuniorMonvMovement(DataContext context, Character character)
	{
		if (!CheckJuniorXiangshuAvatarForbidMovement(character))
		{
			Location location = character.GetLocation();
			UpdateJuniorXiangshuTravelTarget(context, character, 6, () => (short)context.Random.Next(45));
			short areaId = character.GetNpcTravelTargets()[0].GetRealTargetLocation().AreaId;
			Location location2 = SelectJuniorXiangshuNextBlock(context.Random, areaId, (MapBlockData block) => block.BlockType == EMapBlockType.Developed);
			if (!location2.IsValid())
			{
				location2 = SelectJuniorXiangshuRandomNextBlock(context, location);
			}
			if (!location.Equals(location2))
			{
				Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), character.GetLocation(), location2);
				character.SetLocation(location2, context);
			}
			int randomCharacterInRange = GetRandomCharacterInRange(context, location2, 2, includeTaiwu: true);
			if (randomCharacterInRange >= 0)
			{
				Character character2 = _objects[randomCharacterInRange];
				Injuries injuries = character2.GetInjuries();
				GetOrHealRandomInjuriesWithoutChecking(context.Random, ref injuries, -6, -3);
				character2.SetInjuries(injuries, context);
				PoisonInts poisoned = character2.GetPoisoned();
				GetOrDetoxRandomPoisonsWithoutChecking(context.Random, ref poisoned, 3, -300, -100);
				character2.SetPoisoned(ref poisoned, context);
				int currDate = DomainManager.World.GetCurrDate();
				DomainManager.LifeRecord.GetLifeRecordCollection().AddMonvGood(randomCharacterInRange, currDate, location2);
				DomainManager.World.GetMonthlyNotificationCollection().AddMonvSaveSuffering(randomCharacterInRange, location2);
			}
		}
	}

	private void JuniorDayueYaochangMovement(DataContext context, Character character)
	{
		if (CheckJuniorXiangshuAvatarForbidMovement(character))
		{
			return;
		}
		Span<int> pList = stackalloc int[135];
		pList.Fill(0);
		foreach (int item in _infectedCharSet)
		{
			Character character2 = _objects[item];
			Location location = character2.GetLocation();
			if (location.IsValid() && location.AreaId < 135 && !DomainManager.Map.GetBlock(location).IsCityTown())
			{
				pList[location.AreaId]++;
			}
		}
		Location location2 = character.GetLocation();
		List<NpcTravelTarget> npcTravelTargets = character.GetNpcTravelTargets();
		if (npcTravelTargets.Count > 0)
		{
			NpcTravelTarget value = npcTravelTargets[0];
			value.RemainingMonth--;
			if (value.RemainingMonth <= 0 || pList[location2.AreaId] == 0)
			{
				npcTravelTargets.RemoveAt(0);
			}
			else
			{
				npcTravelTargets[0] = value;
			}
			character.SetNpcTravelTargets(npcTravelTargets, context);
		}
		if (npcTravelTargets.Count <= 0)
		{
			short num = (short)CollectionUtils.GetMaxIndex(pList);
			if (pList[num] == 0)
			{
				num = location2.AreaId;
			}
			Location targetLocation = new Location(num, -1);
			NpcTravelTarget target = new NpcTravelTarget(targetLocation, 6);
			character.AddTravelTarget(context, target);
		}
		Location realTargetLocation = npcTravelTargets[0].GetRealTargetLocation();
		if (location2.AreaId != realTargetLocation.AreaId || DomainManager.Map.GetBlock(location2).InfectedCharacterSet == null)
		{
			Span<MapBlockData> areaBlocks = DomainManager.Map.GetAreaBlocks(realTargetLocation.AreaId);
			short blockId = -1;
			int num2 = 0;
			Span<MapBlockData> span = areaBlocks;
			for (int i = 0; i < span.Length; i++)
			{
				MapBlockData mapBlockData = span[i];
				if (!mapBlockData.IsCityTown() && mapBlockData.InfectedCharacterSet != null && mapBlockData.InfectedCharacterSet.Count > num2)
				{
					num2 = mapBlockData.InfectedCharacterSet.Count;
					blockId = mapBlockData.BlockId;
				}
			}
			realTargetLocation = ((num2 == 0) ? SelectJuniorXiangshuRandomNextBlock(context, location2) : new Location(realTargetLocation.AreaId, blockId));
		}
		else
		{
			realTargetLocation = location2;
		}
		if (!location2.Equals(realTargetLocation))
		{
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), character.GetLocation(), realTargetLocation);
			character.SetLocation(realTargetLocation, context);
		}
		MapBlockData block = DomainManager.Map.GetBlock(realTargetLocation);
		if (block.InfectedCharacterSet == null || block.InfectedCharacterSet.Count == 0)
		{
			return;
		}
		List<int> obj = context.AdvanceMonthRelatedData.CharIdList.Occupy();
		obj.AddRange(block.InfectedCharacterSet);
		foreach (int item2 in obj)
		{
			DomainManager.World.GetMonthlyNotificationCollection().AddDayueYaochangSaveSuffering(item2, realTargetLocation);
			MakeCharacterDead(context, _objects[item2], 13);
		}
		context.AdvanceMonthRelatedData.CharIdList.Release(ref obj);
	}

	private void JuniorJiuhanMovement(DataContext context, Character character)
	{
		if (CheckJuniorXiangshuAvatarForbidMovement(character))
		{
			return;
		}
		Location location = character.GetLocation();
		UpdateJuniorXiangshuTravelTarget(context, character, 6, () => (short)context.Random.Next(45));
		short areaId = character.GetNpcTravelTargets()[0].GetRealTargetLocation().AreaId;
		Location location2 = SelectJuniorXiangshuNextBlock(context.Random, areaId, (MapBlockData block) => block.BlockType == EMapBlockType.Wild);
		if (!location2.IsValid())
		{
			location2 = SelectJuniorXiangshuRandomNextBlock(context, location);
		}
		if (!location.Equals(location2))
		{
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), character.GetLocation(), location2);
			character.SetLocation(location2, context);
		}
		List<MapBlockData> obj = context.AdvanceMonthRelatedData.Blocks.Occupy();
		DomainManager.Map.GetRealNeighborBlocks(location2.AreaId, location2.BlockId, obj, 1, includeCenter: true);
		foreach (MapBlockData item in obj)
		{
			item.CurrResources = item.MaxResources;
			DomainManager.Map.SetBlockData(context, item);
		}
		context.AdvanceMonthRelatedData.Blocks.Release(ref obj);
		DomainManager.World.GetMonthlyNotificationCollection().AddJiuhanvSaveSuffering(location2);
	}

	private void JuniorJinHuangerMovement(DataContext context, Character character)
	{
		if (CheckJuniorXiangshuAvatarForbidMovement(character))
		{
			return;
		}
		Location location = character.GetLocation();
		UpdateJuniorXiangshuFollowingTarget(context, character, 12, (Character targetChar) => targetChar.GetFame());
		List<NpcTravelTarget> npcTravelTargets = character.GetNpcTravelTargets();
		if (npcTravelTargets.Count < 0)
		{
			return;
		}
		Location realTargetLocation = npcTravelTargets[0].GetRealTargetLocation();
		if (!realTargetLocation.IsValid())
		{
			return;
		}
		List<MapBlockData> obj = context.AdvanceMonthRelatedData.Blocks.Occupy();
		DomainManager.Map.GetRealNeighborBlocks(realTargetLocation.AreaId, realTargetLocation.BlockId, obj, 2, includeCenter: true);
		MapBlockData random = obj.GetRandom(context.Random);
		context.AdvanceMonthRelatedData.Blocks.Release(ref obj);
		Location location2 = new Location(random.AreaId, random.BlockId);
		if (!location.Equals(location2))
		{
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), character.GetLocation(), location2);
			character.SetLocation(location2, context);
		}
		if (!context.Random.CheckPercentProb(40))
		{
			return;
		}
		int randomCharacterInRange = GetRandomCharacterInRange(context, location2, 2, includeTaiwu: true);
		if (randomCharacterInRange < 0)
		{
			return;
		}
		List<int> obj2 = context.AdvanceMonthRelatedData.CharIdList.Occupy();
		obj2.Add(randomCharacterInRange);
		Span<int> resultIndices = stackalloc int[7];
		RandomUtils.GetRandomUnrepeated(context.Random, 0, 6, resultIndices);
		for (int num = 0; num < 7; num++)
		{
			int num2 = resultIndices[num];
			if (1 == 0)
			{
			}
			int num3 = num2 switch
			{
				0 => ApplyLucky_Resource(context, obj2, 1, 100), 
				1 => ApplyLucky_Item(context, obj2, 1, 2, 100), 
				2 => ApplyLucky_Item(context, obj2, 1, 0, 100), 
				3 => ApplyLucky_Item(context, obj2, 1, 1, 100), 
				4 => ApplyLucky_CombatSkillBook(context, obj2, 1, 100), 
				5 => ApplyLucky_LifeSkillBook(context, obj2, 1, 100), 
				6 => ApplyLucky_Regen(context, obj2, 1, 100), 
				_ => 0, 
			};
			if (1 == 0)
			{
			}
			int num4 = num3;
			if (num4 > 0)
			{
				int currDate = DomainManager.World.GetCurrDate();
				DomainManager.LifeRecord.GetLifeRecordCollection().AddJinHuangerGood(randomCharacterInRange, currDate, location2);
				DomainManager.World.GetMonthlyNotificationCollection().AddJinHuangervSaveSuffering(randomCharacterInRange, location2);
				break;
			}
		}
		context.AdvanceMonthRelatedData.CharIdList.Release(ref obj2);
	}

	private void JuniorYiyihouMovement(DataContext context, Character character)
	{
		if (CheckJuniorXiangshuAvatarForbidMovement(character))
		{
			return;
		}
		Location location = character.GetLocation();
		UpdateJuniorXiangshuTravelTarget(context, character, 3, delegate
		{
			sbyte b = (sbyte)context.Random.Next(MapState.Instance.Count - 1);
			MapStateItem mapStateItem = MapState.Instance[b + 1];
			List<short> list = ObjectPool<List<short>>.Instance.Get();
			list.Clear();
			int num = 3;
			for (int i = 0; i < num; i++)
			{
				short num2 = (short)(b * num + i);
				if (num2 != mapStateItem.MainAreaID && num2 != mapStateItem.SectAreaID)
				{
					list.Add(num2);
				}
			}
			return list.GetRandom(context.Random);
		});
		short areaId = character.GetNpcTravelTargets()[0].GetRealTargetLocation().AreaId;
		Location location2 = SelectJuniorXiangshuNextBlock(context.Random, areaId, (MapBlockData block) => block.IsPassable());
		if (!location2.IsValid())
		{
			location2 = SelectJuniorXiangshuRandomNextBlock(context, location);
		}
		if (!location.Equals(location2))
		{
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), character.GetLocation(), location2);
			character.SetLocation(location2, context);
		}
		DomainManager.World.GetMonthlyNotificationCollection().AddYiYihouvSaveSuffering(location2);
	}

	private void JuniorWeiQiMovement(DataContext context, Character character)
	{
		if (CheckJuniorXiangshuAvatarForbidMovement(character))
		{
			return;
		}
		Location location = character.GetLocation();
		UpdateJuniorXiangshuFollowingTarget(context, character, 3, (Character targetChar) => Math.Max(targetChar.GetLifeSkillAttainment(12), targetChar.GetLifeSkillAttainment(13)));
		List<NpcTravelTarget> npcTravelTargets = character.GetNpcTravelTargets();
		if (npcTravelTargets.Count < 0)
		{
			SetAvoidDeathCharId(-1, context);
			return;
		}
		SetAvoidDeathCharId(npcTravelTargets[0].TargetCharId, context);
		Location realTargetLocation = npcTravelTargets[0].GetRealTargetLocation();
		if (realTargetLocation.IsValid())
		{
			FixedCharacterMoveInRange(context, character, realTargetLocation, 2);
		}
	}

	private void JuniorYixiangMovement(DataContext context, Character character)
	{
		if (!CheckJuniorXiangshuAvatarForbidMovement(character))
		{
			Location location = character.GetLocation();
			UpdateJuniorXiangshuTravelTarget(context, character, 3, delegate
			{
				sbyte randomSectOrgTemplateId = OrganizationDomain.GetRandomSectOrgTemplateId(context.Random, -1);
				Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(randomSectOrgTemplateId);
				return settlementByOrgTemplateId.GetLocation().AreaId;
			});
			short areaId = character.GetNpcTravelTargets()[0].GetRealTargetLocation().AreaId;
			Location location2 = SelectJuniorXiangshuNextBlock(context.Random, areaId, (MapBlockData block) => block.IsPassable());
			if (!location2.IsValid())
			{
				location2 = SelectJuniorXiangshuRandomNextBlock(context, location);
			}
			if (!location.Equals(location2))
			{
				Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), character.GetLocation(), location2);
				character.SetLocation(location2, context);
			}
			DomainManager.World.GetMonthlyNotificationCollection().AddYixiangvSaveSuffering(location2);
		}
	}

	private void JuniorXuefengMovement(DataContext context, Character character)
	{
		if (CheckJuniorXiangshuAvatarForbidMovement(character))
		{
			return;
		}
		Location location = character.GetLocation();
		UpdateJuniorXiangshuFollowingTarget(context, character, 3, (Character targetChar) => -targetChar.GetFame());
		List<NpcTravelTarget> npcTravelTargets = character.GetNpcTravelTargets();
		if (npcTravelTargets.Count < 0)
		{
			return;
		}
		int targetCharId = npcTravelTargets[0].TargetCharId;
		Character character2 = _objects[targetCharId];
		Location realTargetLocation = npcTravelTargets[0].GetRealTargetLocation();
		if (realTargetLocation.IsValid() && !character2.IsCrossAreaTraveling())
		{
			FixedCharacterMoveInRange(context, character, realTargetLocation, 2);
			if (character2.GetLocation().IsValid())
			{
				DomainManager.Character.SimulateCharacterCombat(context, character, character2, CombatType.Beat, isGroupCombat: true, 5);
				int currDate = DomainManager.World.GetCurrDate();
				DomainManager.LifeRecord.GetLifeRecordCollection().AddXuefengGood(targetCharId, currDate, realTargetLocation);
				DomainManager.World.GetMonthlyNotificationCollection().AddXuefengSaveSuffering(targetCharId, realTargetLocation);
			}
		}
	}

	private void JuniorShuFangMovement(DataContext context, Character character)
	{
		if (CheckJuniorXiangshuAvatarForbidMovement(character))
		{
			return;
		}
		Location location = character.GetLocation();
		UpdateJuniorXiangshuFollowingTarget(context, character, 12, (Character targetChar) => Math.Abs(targetChar.GetHappinessType() - 3));
		Location location2 = location;
		List<NpcTravelTarget> npcTravelTargets = character.GetNpcTravelTargets();
		Location targetLocation = ((npcTravelTargets.Count > 0) ? npcTravelTargets[0].GetRealTargetLocation() : Location.Invalid);
		if (targetLocation.IsValid())
		{
			location2 = FixedCharacterMoveInRange(context, character, targetLocation, 2);
		}
		if (context.Random.NextBool())
		{
			return;
		}
		Location location3 = DomainManager.Taiwu.GetTaiwu().GetLocation();
		List<int> obj = context.AdvanceMonthRelatedData.CharIdList.Occupy();
		List<MapBlockData> obj2 = context.AdvanceMonthRelatedData.Blocks.Occupy();
		DomainManager.Map.GetRealNeighborBlocks(location2.AreaId, location2.BlockId, obj2, 2, includeCenter: true);
		foreach (MapBlockData item in obj2)
		{
			if (item.CharacterSet != null)
			{
				foreach (int item2 in item.CharacterSet)
				{
					if (_objects[item2].GetCurrAge() > 16)
					{
						obj.Add(item2);
					}
				}
			}
			if (item.AreaId != location3.AreaId || item.BlockId != location3.BlockId)
			{
				continue;
			}
			HashSet<int> collection = DomainManager.Taiwu.GetGroupCharIds().GetCollection();
			foreach (int item3 in collection)
			{
				if (_objects[item3].GetCurrAge() > 16)
				{
					obj.Add(item3);
				}
			}
		}
		int randomOrDefault = obj.GetRandomOrDefault(context.Random, -1);
		context.AdvanceMonthRelatedData.CharIdList.Release(ref obj);
		context.AdvanceMonthRelatedData.Blocks.Release(ref obj2);
		if (randomOrDefault >= 0)
		{
			Character character2 = _objects[randomOrDefault];
			short currAge = character2.GetCurrAge();
			short num = (short)(currAge - 1);
			character2.SetCurrAge(num, context);
			Events.RaiseCharacterAgeChanged(context, character2, currAge, num);
			int currDate = DomainManager.World.GetCurrDate();
			DomainManager.LifeRecord.GetLifeRecordCollection().AddShufangGood(randomOrDefault, currDate, location2);
			DomainManager.World.GetMonthlyNotificationCollection().AddShuFangvSaveSuffering(randomOrDefault, location2);
		}
	}

	private void ZiWuxiaoMovement(DataContext context, Character character)
	{
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		FixedCharacterMoveInRange(context, character, taiwuVillageLocation, 3);
	}

	private void RanchenziMovement(DataContext context, Character character)
	{
		if (DomainManager.Character.TryGetFixedCharacterByTemplateId(447, out var character2))
		{
			Location location = character2.GetLocation();
			if (location.IsValid())
			{
				FixedCharacterMoveInRange(context, character, location, 2);
			}
		}
	}

	private void LongYufuMovement(DataContext context, Character character)
	{
		if (DomainManager.Character.TryGetFixedCharacterByTemplateId(441, out var character2))
		{
			Location location = character2.GetLocation();
			if (location.IsValid())
			{
				FixedCharacterMoveInRange(context, character, location, 2);
			}
		}
	}

	private void FulongReudhLazuliMovement(DataContext context, Character character)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(14);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongReudhLazuliAI2", ref arg);
		if (arg)
		{
			if (DomainManager.Extra.IsExtraTaskInProgress(344))
			{
				FulongReudhLazuliMovementDependMonv(context, character);
			}
		}
		else
		{
			Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(14);
			FixedCharacterMoveInSettlementRange(context, character, settlementByOrgTemplateId.GetLocation());
		}
	}

	public void FulongReudhLazuliMovementDependMonv(DataContext context, Character character)
	{
		Character character2 = null;
		Location location = Location.Invalid;
		DomainManager.Character.TryGetFixedCharacterByTemplateId(39, out var character3);
		if (character3 != null && character3.GetLocation().AreaId == DomainManager.Taiwu.GetTaiwuVillageLocation().AreaId)
		{
			character2 = character3;
		}
		for (short num = 129; num <= 137; num++)
		{
			DomainManager.Character.TryGetFixedCharacterByTemplateId(num, out var character4);
			if (character4 != null && character4.GetLocation().AreaId == DomainManager.Taiwu.GetTaiwuVillageLocation().AreaId)
			{
				character2 = character4;
				break;
			}
		}
		if (character2 != null)
		{
			List<MapBlockData> mapBlockList = ObjectPool<List<MapBlockData>>.Instance.Get();
			mapBlockList.Clear();
			DomainManager.Map.GetLocationByDistance(character2.GetLocation(), 1, 1, ref mapBlockList);
			MapBlockData random = mapBlockList.GetRandom(context.Random);
			location = random.GetLocation();
			ObjectPool<List<MapBlockData>>.Instance.Return(mapBlockList);
		}
		sbyte xiangshuAvatarIdByCharacterTemplateId = XiangshuAvatarIds.GetXiangshuAvatarIdByCharacterTemplateId(39);
		if (DomainManager.World.GetElement_XiangshuAvatarTaskStatuses(xiangshuAvatarIdByCharacterTemplateId).SwordTombStatus < 2)
		{
			for (int i = 1; i < 8; i++)
			{
				Location element_SwordTombLocations = DomainManager.Map.GetElement_SwordTombLocations(i);
				MapBlockData blockData = DomainManager.Map.GetBlockData(element_SwordTombLocations.AreaId, element_SwordTombLocations.BlockId);
				if (blockData.GetConfig().TemplateId == 128)
				{
					location = blockData.GetLocation();
					break;
				}
			}
		}
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(14);
		bool arg = false;
		sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongTravelWithLazuliMonvTalkTriggered", ref arg);
		if (!location.IsValid() || arg)
		{
			List<MapBlockData> mapBlockList2 = ObjectPool<List<MapBlockData>>.Instance.Get();
			mapBlockList2.Clear();
			Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
			DomainManager.Map.GetLocationByDistance(taiwuVillageLocation, 0, 2, ref mapBlockList2);
			MapBlockData random2 = mapBlockList2.GetRandom(context.Random);
			location = random2.GetLocation();
			ObjectPool<List<MapBlockData>>.Instance.Return(mapBlockList2);
		}
		if (!character.GetLocation().Equals(location))
		{
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), character.GetLocation(), location);
			character.SetLocation(location, context);
		}
	}

	private void FulongReudhLazuliFeatherMovement(DataContext context, Character character)
	{
		if (!DomainManager.Extra.IsExtraTaskChainInProgress(52))
		{
			EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(14);
			bool arg = false;
			sectMainStoryEventArgBox.Get("ConchShip_PresetKey_FulongReudhLazuliFeatherFollowOpen", ref arg);
			if (!arg)
			{
				Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
				FixedCharacterMoveInSettlementRange(context, character, taiwuVillageLocation);
			}
		}
	}

	private void BaihuaBaiLuXuanXiaoMovement(DataContext context, Character character)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(3);
		if (sectMainStoryEventArgBox.Contains<int>("ConchShip_PresetKey_BaihuaAnimalsBackDate"))
		{
			sbyte sectMainStoryTaskStatus = DomainManager.World.GetSectMainStoryTaskStatus(3);
			if (sectMainStoryTaskStatus == 1)
			{
				Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(3);
				Location location = settlementByOrgTemplateId.GetLocation();
				FixedCharacterMoveInSettlement(context, character, location);
			}
			else
			{
				Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
				FixedCharacterMoveInSettlementRange(context, character, taiwuVillageLocation);
			}
		}
	}

	private void BaihuaLeMeMovement(DataContext context, Character character)
	{
		if (DomainManager.World.GetSectMainStoryTaskStatus(3) != 0)
		{
			Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(3);
			Location location = settlementByOrgTemplateId.GetLocation();
			FixedCharacterMoveInSettlement(context, character, location);
		}
	}

	private Location FixedCharacterMoveInRange(DataContext context, Character character, Location targetLocation, int maxSteps)
	{
		List<MapBlockData> obj = context.AdvanceMonthRelatedData.Blocks.Occupy();
		DomainManager.Map.GetRealNeighborBlocks(targetLocation.AreaId, targetLocation.BlockId, obj, maxSteps, includeCenter: true);
		MapBlockData random = obj.GetRandom(context.Random);
		Location location = character.GetLocation();
		Location location2 = new Location(random.AreaId, random.BlockId);
		context.AdvanceMonthRelatedData.Blocks.Release(ref obj);
		if (!location.Equals(location2))
		{
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), character.GetLocation(), location2);
			character.SetLocation(location2, context);
		}
		return location2;
	}

	private void FixedCharacterMoveInSettlement(DataContext context, Character character, Location settlementLocation)
	{
		List<short> obj = context.AdvanceMonthRelatedData.BlockIds.Occupy();
		DomainManager.Map.GetSettlementBlocks(settlementLocation.AreaId, settlementLocation.BlockId, obj);
		Location location = character.GetLocation();
		short random = obj.GetRandom(context.Random);
		Location location2 = new Location(location.AreaId, random);
		context.AdvanceMonthRelatedData.BlockIds.Release(ref obj);
		if (location2 != location)
		{
			Tester.Assert(character.GetCreatingType() == 0);
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), location, location2);
			character.SetLocation(location2, context);
		}
	}

	public void CullCanSelectBlocks(List<MapBlockData> blocks)
	{
		if (blocks.Count <= 1)
		{
			return;
		}
		int num = 0;
		foreach (MapBlockData block in blocks)
		{
			if (FiveLoongDlcEntry.IsBlockLoongBlock(block))
			{
				num++;
			}
		}
		if (num == blocks.Count)
		{
			return;
		}
		for (int num2 = blocks.Count - 1; num2 >= 0; num2--)
		{
			if (FiveLoongDlcEntry.IsBlockLoongBlock(blocks[num2]))
			{
				blocks.RemoveAt(num2);
			}
		}
		num = 0;
		foreach (MapBlockData block2 in blocks)
		{
			if (block2.GetConfig().TemplateId == 124)
			{
				num++;
			}
		}
		if (num == blocks.Count)
		{
			return;
		}
		for (int num3 = blocks.Count - 1; num3 >= 0; num3--)
		{
			if (blocks[num3].GetConfig().TemplateId == 124)
			{
				blocks.RemoveAt(num3);
			}
		}
		num = 0;
		foreach (MapBlockData block3 in blocks)
		{
			if (block3.GetConfig().SubType == EMapBlockSubType.Ruin)
			{
				num++;
			}
		}
		if (num == blocks.Count)
		{
			return;
		}
		for (int num4 = blocks.Count - 1; num4 >= 0; num4--)
		{
			if (blocks[num4].GetConfig().SubType == EMapBlockSubType.Ruin)
			{
				blocks.RemoveAt(num4);
			}
		}
	}

	private void FixedCharacterMoveInSettlementRange(DataContext context, Character character, Location settlementLocation)
	{
		List<MapBlockData> obj = context.AdvanceMonthRelatedData.Blocks.Occupy();
		DomainManager.Map.GetSettlementAffiliatedBlocks(settlementLocation.AreaId, settlementLocation.BlockId, obj);
		CullCanSelectBlocks(obj);
		Location location = character.GetLocation();
		Location location2 = obj.GetRandom(context.Random).GetLocation();
		context.AdvanceMonthRelatedData.Blocks.Release(ref obj);
		if (location2 != location)
		{
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), location, location2);
			character.SetLocation(location2, context);
		}
	}

	private void ImpersonatorBuddhistMonkMovement(DataContext context, Character character)
	{
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		FixedCharacterMoveInSettlementRange(context, character, taiwuVillageLocation);
	}

	private void TripodVesselOfMedicineMovement(DataContext context, Character character)
	{
		int id = character.GetId();
		Location location = character.GetLocation();
		short lifeSkillAttainment = character.GetLifeSkillAttainment(8);
		short lifeSkillAttainment2 = character.GetLifeSkillAttainment(9);
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(10);
		short arg = -1;
		if (!sectMainStoryEventArgBox.Get("ConchShip_PresetKey_TripodVesselOfMedicineAreaId", ref arg) || arg < 0)
		{
			return;
		}
		if (location.AreaId != arg || DomainManager.Map.GetBelongSettlementBlock(location) == null)
		{
			MapAreaData element_Areas = DomainManager.Map.GetElement_Areas(arg);
			for (int i = 0; i < element_Areas.SettlementInfos.Length; i++)
			{
				SettlementInfo settlementInfo = element_Areas.SettlementInfos[i];
				if (settlementInfo.SettlementId >= 0)
				{
					List<MapBlockData> obj = context.AdvanceMonthRelatedData.Blocks.Occupy();
					DomainManager.Map.GetSettlementAffiliatedBlocks(arg, settlementInfo.BlockId, obj);
					if (obj.Count > 0)
					{
						MapBlockData random = obj.GetRandom(context.Random);
						Location location2 = random.GetLocation();
						Events.RaiseFixedCharacterLocationChanged(context, id, location, location2);
						character.SetLocation(location2, context);
						DomainManager.Map.SetBlockAndViewRangeVisible(context, location2.AreaId, location2.BlockId);
					}
					context.AdvanceMonthRelatedData.Blocks.Release(ref obj);
					break;
				}
			}
		}
		sbyte actionType = SelectTripodVesselActionType(context.Random, id);
		if (actionType < 0)
		{
			return;
		}
		DomainManager.Extra.AddAiActionCooldown(context, id, 2, actionType, 2);
		arg = character.GetLocation().AreaId;
		Span<MapBlockData> areaBlocks = DomainManager.Map.GetAreaBlocks(arg);
		Span<MapBlockData> span = areaBlocks;
		for (int j = 0; j < span.Length; j++)
		{
			MapBlockData mapBlockData = span[j];
			if (mapBlockData.CharacterSet == null)
			{
				continue;
			}
			foreach (int item in mapBlockData.CharacterSet)
			{
				ExecuteTripodVesselAction(item);
			}
		}
		if (DomainManager.Taiwu.GetTaiwu().GetLocation().AreaId == arg)
		{
			HashSet<int> collection = DomainManager.Taiwu.GetGroupCharIds().GetCollection();
			foreach (int item2 in collection)
			{
				ExecuteTripodVesselAction(item2);
			}
		}
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		Location location3 = new Location(character.GetLocation().AreaId, -1);
		switch (actionType)
		{
		case 0:
			monthlyNotificationCollection.AddSectMainStoryKongsangTripodVesselCures(location3);
			break;
		case 1:
			monthlyNotificationCollection.AddSectMainStoryKongsangTripodVesselDetoxifies(location3);
			break;
		case 2:
			monthlyNotificationCollection.AddSectMainStoryKongsangTripodVesselRestoresHealth(location3);
			break;
		case 3:
			monthlyNotificationCollection.AddSectMainStoryKongsangTripodVesselRemovesQiDisorder(location3);
			break;
		}
		void ExecuteTripodVesselAction(int targetCharId)
		{
			Character character2 = _objects[targetCharId];
			switch (actionType)
			{
			case 0:
			{
				Injuries injuries = character2.GetInjuries();
				if (injuries.HasAnyInjury())
				{
					injuries.Initialize();
					character2.SetInjuries(injuries, context);
				}
				break;
			}
			case 1:
			{
				PoisonInts poisoned = character2.GetPoisoned();
				if (poisoned.IsNonZero())
				{
					poisoned.Initialize();
					character2.SetPoisoned(ref poisoned, context);
				}
				break;
			}
			case 2:
			{
				short health = character2.GetHealth();
				short leftMaxHealth = character2.GetLeftMaxHealth();
				if (health < leftMaxHealth)
				{
					character2.SetHealth(leftMaxHealth, context);
				}
				break;
			}
			case 3:
				character2.SetDisorderOfQi(0, context);
				break;
			}
		}
		static sbyte SelectTripodVesselActionType(IRandomSource randomSource, int charId)
		{
			Span<sbyte> span2 = stackalloc sbyte[4];
			SpanList<sbyte> spanList = span2;
			for (sbyte b = 0; b < spanList.Capacity; b++)
			{
				if (!DomainManager.Extra.IsAiActionInCooldown(charId, 2, b))
				{
					spanList.Add(b);
				}
			}
			if (spanList.Count > 0)
			{
				return spanList.GetRandom(randomSource);
			}
			return -1;
		}
	}

	private void WudangBlackSnakeMovement(DataContext context, Character character)
	{
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(4);
		Location location = settlementByOrgTemplateId.GetLocation();
		List<short> obj = context.AdvanceMonthRelatedData.BlockIds.Occupy();
		DomainManager.Map.GetSettlementBlocksAndAffiliatedBlocks(location.AreaId, location.BlockId, obj);
		short random = obj.GetRandom(context.Random);
		context.AdvanceMonthRelatedData.BlockIds.Release(ref obj);
		Location location2 = character.GetLocation();
		Location location3 = new Location(location.AreaId, random);
		Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), location2, location3);
		character.SetLocation(location3, context);
	}

	private void XuehouOldManMovement(DataContext context, Character character)
	{
		Location location = character.GetLocation();
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location2 = taiwu.GetLocation();
		location2 = (location2.IsValid() ? location2 : taiwu.GetValidLocation());
		MapBlockData block = DomainManager.Map.GetBlock(location2);
		List<MapBlockData> obj = context.AdvanceMonthRelatedData.Blocks.Occupy();
		DomainManager.Map.GetRealNeighborBlocks(location.AreaId, location.BlockId, obj, 3, includeCenter: true);
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(15);
		if ((DomainManager.Extra.IsLocationContainsBloodLight(location2) || obj.Contains(block)) && DomainManager.Map.IsLocationInSettlementInfluenceRange(location2, settlementByOrgTemplateId.GetId()))
		{
			Location location3 = location2;
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), location, location3);
			character.SetLocation(location3, context);
		}
		context.AdvanceMonthRelatedData.Blocks.Release(ref obj);
	}

	private void JixiMovement(DataContext context, Character character)
	{
		if (!DomainManager.Extra.IsExtraTaskInProgress(125))
		{
			EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(15);
			if (sectMainStoryEventArgBox.GetBool("ConchShip_PresetKey_JixiFollowOpen"))
			{
				JixiMovementFollow(context, character);
			}
			else if (DomainManager.World.IsJixiFree())
			{
				JixiMovementFree(context, character);
			}
			else if (DomainManager.Extra.IsExtraTaskInProgress(135))
			{
				JixiMovementPassLegacy(context, character);
			}
			else
			{
				JixiMovementTaiwu(context, character);
			}
		}
	}

	private void JixiMovementTaiwu(DataContext context, Character character)
	{
		List<MapBlockData> obj = context.AdvanceMonthRelatedData.Blocks.Occupy();
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		DomainManager.Map.QueryRegularBelongBlocks(obj, taiwuVillageLocation, true);
		Location location = obj.GetRandom(context.Random).GetLocation();
		context.AdvanceMonthRelatedData.Blocks.Release(ref obj);
		JixiMovementChangeLocation(context, character, location);
	}

	private void JixiMovementPassLegacy(DataContext context, Character character)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(15);
		int key = sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_AwakeJixiTaiwuId");
		int num = sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_SectStory_Xuehou_Jixi_StayAtGraveMonthKey");
		if (_graves.TryGetValue(key, out var value) && num < 7)
		{
			JixiMovementChangeLocation(context, character, value.GetLocation());
			sectMainStoryEventArgBox.Set("ConchShip_PresetKey_SectStory_Xuehou_Jixi_StayAtGraveMonthKey", num + 1);
			DomainManager.Extra.SaveSectMainStoryEventArgumentBox(context, 15);
		}
		else
		{
			int currDate = DomainManager.World.GetCurrDate();
			DomainManager.World.DealSectMainStoryEnd(context, 15, 1, currDate);
			JixiMovementFree(context, character);
		}
	}

	private void JixiMovementFree(DataContext context, Character character)
	{
		UpdateJixiTravelTarget(context, character);
		Location realTargetLocation = character.GetNpcTravelTargets()[0].GetRealTargetLocation();
		List<MapBlockData> obj = context.AdvanceMonthRelatedData.Blocks.Occupy();
		DomainManager.Map.QueryRegularBelongBlocks(obj, realTargetLocation, true);
		if (!JixiMovementActionToBlocks(context, character, obj))
		{
			List<NpcTravelTarget> npcTravelTargets = character.GetNpcTravelTargets();
			npcTravelTargets.RemoveAt(0);
			character.SetNpcTravelTargets(npcTravelTargets, context);
		}
		context.AdvanceMonthRelatedData.Blocks.Release(ref obj);
	}

	private void UpdateJixiTravelTarget(DataContext context, Character character)
	{
		List<NpcTravelTarget> npcTravelTargets = character.GetNpcTravelTargets();
		if (npcTravelTargets.Count > 0)
		{
			NpcTravelTarget value = npcTravelTargets[0];
			value.RemainingMonth--;
			if (value.RemainingMonth <= 0)
			{
				npcTravelTargets.RemoveAt(0);
			}
			else
			{
				npcTravelTargets[0] = value;
			}
			character.SetNpcTravelTargets(npcTravelTargets, context);
		}
		if (npcTravelTargets.Count <= 0)
		{
			Location targetLocation = SelectJixiTravelTarget(context, character);
			short templateId = character.GetTemplateId();
			if (1 == 0)
			{
			}
			sbyte b = templateId switch
			{
				537 => 12, 
				538 => 9, 
				539 => 6, 
				_ => throw new Exception($"Template out of range: charId={character.GetId()}, templateId={character.GetTemplateId()}"), 
			};
			if (1 == 0)
			{
			}
			sbyte maxDuration = b;
			NpcTravelTarget target = new NpcTravelTarget(targetLocation, maxDuration);
			character.AddTravelTarget(context, target);
		}
	}

	private Location SelectJixiTravelTarget(DataContext context, Character character)
	{
		List<Settlement> list = ObjectPool<List<Settlement>>.Instance.Get();
		List<Location> list2 = ObjectPool<List<Location>>.Instance.Get();
		Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
		Location location = character.GetLocation();
		Location location2 = Location.Invalid;
		if (location.IsValid())
		{
			MapBlockData block = DomainManager.Map.GetBlock(location);
			if (block.BelongBlockId >= 0)
			{
				location2 = new Location(location.AreaId, block.BelongBlockId);
			}
		}
		DomainManager.Organization.GetAllCivilianSettlements(list);
		foreach (Settlement item2 in list)
		{
			Location location3 = item2.GetLocation();
			if (!(location3 == taiwuVillageLocation) && !(location3 == location2) && location3.AreaId < 45)
			{
				OrganizationItem organizationItem = Config.Organization.Instance[item2.GetOrgTemplateId()];
				if (!organizationItem.IsSect)
				{
					list2.Add(location3);
				}
			}
		}
		if (context.Random.CheckPercentProb(20))
		{
			int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
			List<Location> list3 = ObjectPool<List<Location>>.Instance.Get();
			HashSet<int> obj = context.AdvanceMonthRelatedData.RelatedCharIds.Occupy();
			GetAllRelatedCharIds(taiwuCharId, obj);
			foreach (int item3 in obj)
			{
				if (!_objects.TryGetValue(item3, out var value) || value.GetCreatingType() != 1)
				{
					continue;
				}
				Location location4 = value.GetLocation();
				if (!location4.IsValid() || location4.AreaId >= 45)
				{
					continue;
				}
				MapBlockData block2 = DomainManager.Map.GetBlock(location4);
				if (block2.BelongBlockId >= 0 && !IsCharacterRelationFriendly(taiwuCharId, item3) && IsCharacterRelationUnfriendly(taiwuCharId, item3))
				{
					Location item = new Location(location4.AreaId, block2.BelongBlockId);
					if (list2.Contains(item))
					{
						list3.Add(item);
					}
				}
			}
			if (list3.Count > 0)
			{
				list2.Clear();
				list2.AddRange(list3);
			}
			context.AdvanceMonthRelatedData.RelatedCharIds.Release(ref obj);
			ObjectPool<List<Location>>.Instance.Return(list3);
		}
		Location random = list2.GetRandom(context.Random);
		ObjectPool<List<Settlement>>.Instance.Return(list);
		ObjectPool<List<Location>>.Instance.Return(list2);
		return random;
	}

	private void JixiMovementFollow(DataContext context, Character character)
	{
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		JixiGetTaiwuNeighborBlocks(list);
		JixiMovementActionToBlocks(context, character, list);
		ObjectPool<List<MapBlockData>>.Instance.Return(list);
		JixiKillAllTemplateEnemies(context, character);
		JixiRescueTaiwu(context, character);
		JixiMovementViewRangeVisible(context, character);
	}

	public void JixiMovementFollowTaiwu(DataContext context, Character character)
	{
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		List<MapBlockData> list2 = ObjectPool<List<MapBlockData>>.Instance.Get();
		JixiGetTaiwuNeighborBlocks(list);
		foreach (MapBlockData item in list)
		{
			if (JixiMatchTemplateEnemyBlock(item))
			{
				list2.Add(item);
			}
		}
		MapBlockData mapBlockData = ((list2.Count > 0) ? list2.GetRandom(context.Random) : list.GetRandom(context.Random));
		ObjectPool<List<MapBlockData>>.Instance.Return(list2);
		ObjectPool<List<MapBlockData>>.Instance.Return(list);
		Location location = mapBlockData.GetLocation();
		JixiMovementChangeLocation(context, character, location);
		JixiKillAllTemplateEnemies(context, character);
		JixiMovementViewRangeVisible(context, character);
	}

	private void JixiGetTaiwuNeighborBlocks(List<MapBlockData> neighborBlocks)
	{
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		if (!location.IsValid())
		{
			location = taiwu.GetValidLocation();
		}
		DomainManager.Map.GetRealNeighborBlocks(location.AreaId, location.BlockId, neighborBlocks, 2);
	}

	private bool JixiMatchTemplateEnemyBlock(MapBlockData block)
	{
		if (block.TemplateEnemyList == null)
		{
			return false;
		}
		foreach (MapTemplateEnemyInfo templateEnemy in block.TemplateEnemyList)
		{
			if (Config.Character.Instance[templateEnemy.TemplateId].OrganizationInfo.OrgTemplateId != 19)
			{
				return true;
			}
		}
		return false;
	}

	private void JixiKillAllTemplateEnemies(DataContext context, Character character)
	{
		Location location = character.GetLocation();
		if (!location.IsValid())
		{
			return;
		}
		MapBlockData block = DomainManager.Map.GetBlock(location);
		if (block.TemplateEnemyList == null)
		{
			return;
		}
		for (int num = block.TemplateEnemyList.Count - 1; num >= 0; num--)
		{
			MapTemplateEnemyInfo templateEnemyInfo = block.TemplateEnemyList[num];
			if (Config.Character.Instance[templateEnemyInfo.TemplateId].OrganizationInfo.OrgTemplateId != 19)
			{
				Events.RaiseTemplateEnemyLocationChanged(context, templateEnemyInfo, location, Location.Invalid);
			}
		}
		DomainManager.Extra.SaveArgToSectMainStoryEventArgBox(context, 15, "ConchShip_PresetKey_JixiKilledEnemy", value: true);
	}

	private void JixiRescueTaiwu(DataContext context, Character character)
	{
		if (character.GetTemplateId() == 537)
		{
			return;
		}
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		short health = taiwu.GetHealth();
		short leftMaxHealth = taiwu.GetLeftMaxHealth();
		if (health < leftMaxHealth * 33 / 100 && health > 0)
		{
			short templateId = character.GetTemplateId();
			if (1 == 0)
			{
			}
			sbyte b = templateId switch
			{
				538 => 50, 
				539 => 100, 
				_ => throw new Exception($"Template out of range: charId={character.GetId()}, templateId={character.GetTemplateId()}"), 
			};
			if (1 == 0)
			{
			}
			sbyte b2 = b;
			short delta = (short)(leftMaxHealth * b2 / 100);
			taiwu.ChangeHealth(context, delta);
			DomainManager.World.JixiGrowUp(context, character.GetTemplateId(), 537);
			int currDate = DomainManager.World.GetCurrDate();
			LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
			lifeRecordCollection.AddSectMainStoryXuehouJixiRescueTaiwu(taiwu.GetId(), currDate, taiwu.GetLocation());
			MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
			monthlyNotificationCollection.AddSectMainStoryXuehouJixiRescue(taiwu.GetId());
		}
	}

	private void JixiMovementChangeLocation(DataContext context, Character character, Location dstLocation)
	{
		Location location = character.GetLocation();
		if (!(location == dstLocation))
		{
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), location, dstLocation);
			character.SetLocation(dstLocation, context);
		}
	}

	private void JixiMovementViewRangeVisible(DataContext context, Character character)
	{
		Location location = character.GetLocation();
		if (location.IsValid())
		{
			MapBlockData block = DomainManager.Map.GetBlock(location);
			if (!block.Visible)
			{
				block.SetVisible(visible: true, context);
			}
		}
	}

	private bool JixiMovementActionToBlocks(DataContext context, Character character, List<MapBlockData> targetBlocks)
	{
		if (JixiMovementKillCheckCd(character))
		{
			Location location = targetBlocks.GetRandom(context.Random).GetLocation();
			JixiMovementChangeLocation(context, character, location);
			return true;
		}
		int num = JixiMovementKillSelectTarget(context, targetBlocks);
		bool flag = num >= 0;
		Location dstLocation = (flag ? _objects[num].GetLocation() : targetBlocks.GetRandom(context.Random).GetLocation());
		JixiMovementChangeLocation(context, character, dstLocation);
		JixiMovementKillActionTarget(context, character, num);
		return flag;
	}

	private int JixiMovementKillSelectTarget(DataContext context, List<MapBlockData> validBlocks)
	{
		List<int> obj = context.AdvanceMonthRelatedData.TargetCharIdList.Occupy();
		List<int> obj2 = context.AdvanceMonthRelatedData.CharIdList.Occupy();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		CharacterMatcherItem canBeJixiKillingTarget = CharacterMatcher.DefValue.CanBeJixiKillingTarget;
		foreach (MapBlockData validBlock in validBlocks)
		{
			if (validBlock.CharacterSet == null)
			{
				continue;
			}
			foreach (int item in validBlock.CharacterSet)
			{
				Character character = _objects[item];
				if (canBeJixiKillingTarget.Match(character))
				{
					if (DomainManager.Character.IsCharacterRelationUnfriendly(taiwuCharId, item))
					{
						obj.Add(item);
					}
					else
					{
						obj2.Add(item);
					}
				}
			}
		}
		int result = ((obj.Count > 0) ? obj.GetRandom(context.Random) : ((obj2.Count > 0) ? obj2.GetRandom(context.Random) : (-1)));
		context.AdvanceMonthRelatedData.TargetCharIdList.Release(ref obj);
		context.AdvanceMonthRelatedData.CharIdList.Release(ref obj2);
		return result;
	}

	private bool JixiMovementKillCheckCd(Character character)
	{
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(15);
		int num = sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_SectStory_Xuehou_Jixi_WaitingMonth");
		int currDate = DomainManager.World.GetCurrDate();
		short templateId = character.GetTemplateId();
		if (1 == 0)
		{
		}
		sbyte b = templateId switch
		{
			537 => 0, 
			538 => 1, 
			539 => 2, 
			_ => throw new Exception($"Template out of range: charId={character.GetId()}, templateId={character.GetTemplateId()}"), 
		};
		if (1 == 0)
		{
		}
		sbyte b2 = b;
		return currDate < num + b2;
	}

	private void JixiMovementKillResetCd(DataContext context)
	{
		int currDate = DomainManager.World.GetCurrDate();
		DomainManager.Extra.SaveArgToSectMainStoryEventArgBox(context, 15, "ConchShip_PresetKey_SectStory_Xuehou_Jixi_WaitingMonth", currDate);
	}

	private void JixiMovementKillActionTarget(DataContext context, Character character, int targetCharId)
	{
		if (targetCharId >= 0 && _objects.TryGetValue(targetCharId, out var value))
		{
			EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(15);
			Location location = character.GetLocation();
			DomainManager.Character.MakeCharacterDead(context, value, 14);
			MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
			monthlyNotificationCollection.AddSectMainStoryXuehouJixiKillsPeople(location, 1);
			int num = sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_SectStory_Xuehou_Jixi_KilledCount");
			sectMainStoryEventArgBox.Set("ConchShip_PresetKey_SectStory_Xuehou_Jixi_KilledCount", ++num);
			if (1 == 0)
			{
			}
			short num2 = (short)((num < 7) ? 537 : ((num >= 14) ? 539 : 538));
			if (1 == 0)
			{
			}
			short num3 = num2;
			if (character.GetTemplateId() != num3)
			{
				List<NpcTravelTarget> npcTravelTargets = character.GetNpcTravelTargets();
				DomainManager.World.JixiGrowUp(context, character.GetTemplateId(), num3);
				character = DomainManager.Character.GetOrCreateFixedCharacterByTemplateId(context, num3);
				character.SetNpcTravelTargets(npcTravelTargets, context);
			}
			JixiMovementKillResetCd(context);
		}
	}

	private void SloppyTaoistMonkMovement(DataContext context, Character character)
	{
		Location location = character.GetLocation();
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(4);
		List<MapBlockData> obj = context.AdvanceMonthRelatedData.Blocks.Occupy();
		DomainManager.Map.QueryRootBlocks(obj, settlementByOrgTemplateId.GetLocation());
		Location location2 = obj.GetRandom(context.Random).GetLocation();
		context.AdvanceMonthRelatedData.Blocks.Release(ref obj);
		if (location != location2)
		{
			Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), location, location2);
			character.SetLocation(location2, context);
		}
	}

	public static List<short> CalcFuyuHiltMovementPath(Location start, Location end, short moveCount = -1)
	{
		if (start.Equals(end))
		{
			return null;
		}
		byte areaSize = DomainManager.Map.GetAreaSize(start.AreaId);
		_fuyuHiltMovementMap.InitMap(areaSize, areaSize, delegate(ByteCoordinate coord)
		{
			MapBlockData block = DomainManager.Map.GetBlock(start.AreaId, ByteCoordinate.CoordinateToIndex(coord, areaSize));
			return (sbyte)(block.IsPassable() ? block.MoveCost : (-1));
		});
		List<ByteCoordinate> path = ObjectPool<List<ByteCoordinate>>.Instance.Get();
		List<ByteCoordinate> list = ObjectPool<List<ByteCoordinate>>.Instance.Get();
		List<short> list2 = ObjectPool<List<short>>.Instance.Get();
		DomainManager.Map.GetAreaSettlementIds(start.AreaId, list2, containsMainCity: true, containsSect: true);
		for (int num = 0; num < list2.Count; num++)
		{
			Settlement settlement = DomainManager.Organization.GetSettlement(list2[num]);
			if (settlement.GetOrgTemplateId() != 16)
			{
				Location location = settlement.GetLocation();
				MapBlockData blockData = DomainManager.Map.GetBlockData(location.AreaId, location.BlockId);
				list.Add(blockData.GetBlockPos());
			}
		}
		_fuyuHiltMovementMap.FindWay(ByteCoordinate.IndexToCoordinate(start.BlockId, areaSize), ByteCoordinate.IndexToCoordinate(end.BlockId, areaSize), ref path, list);
		List<short> list3 = new List<short>();
		if (moveCount == -1)
		{
			moveCount = (short)(path.Count - 1);
		}
		list3.Add(ByteCoordinate.CoordinateToIndex(path[0], areaSize));
		list3.Add(ByteCoordinate.CoordinateToIndex(path[moveCount], areaSize));
		ObjectPool<List<ByteCoordinate>>.Instance.Return(path);
		ObjectPool<List<ByteCoordinate>>.Instance.Return(list);
		ObjectPool<List<short>>.Instance.Return(list2);
		return list3;
	}

	private void GearMateMovement(DataContext context, Character character)
	{
		if (!DomainManager.Extra.IsSpecialGroupMember(character))
		{
			short settlementIdByOrgTemplateId = DomainManager.Organization.GetSettlementIdByOrgTemplateId(16);
			if (!DomainManager.Map.IsLocationInSettlementInfluenceRange(character.GetLocation(), settlementIdByOrgTemplateId))
			{
				List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
				Location taiwuVillageLocation = DomainManager.Taiwu.GetTaiwuVillageLocation();
				DomainManager.Map.GetSettlementAffiliatedBlocks(taiwuVillageLocation.AreaId, taiwuVillageLocation.BlockId, list);
				MapBlockData random = list.GetRandom(context.Random);
				Events.RaiseFixedCharacterLocationChanged(context, character.GetId(), character.GetLocation(), random.GetLocation());
				character.SetLocation(random.GetLocation(), context);
				ObjectPool<List<MapBlockData>>.Instance.Return(list);
			}
		}
	}

	public void UpdateIntelligentCharacterMovements(DataContext context)
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		foreach (var (num2, character2) in _objects)
		{
			if (num2 == taiwuCharId || IsTemporaryIntelligentCharacter(num2))
			{
				continue;
			}
			byte creatingType = character2.GetCreatingType();
			byte b = creatingType;
			if (b == 1)
			{
				if (!LockMovementCharSet.Contains(num2))
				{
					character2.UpdateIntelligentCharacterMovement(context);
				}
				character2.UpdateTravelTargetRemainingMonths(context);
			}
		}
	}

	public void UpdateInfectedCharacterMovements(DataContext context)
	{
		foreach (int item in _infectedCharSet)
		{
			Character character = _objects[item];
			if (IsLockMovementChar(item) || character.GetKidnapperId() >= 0 || character.IsActiveExternalRelationState(60))
			{
				continue;
			}
			Location location = character.GetLocation();
			if (location.IsValid())
			{
				MapBlockData block = DomainManager.Map.GetBlock(location);
				if (block.InfectedCharacterSet != null && block.InfectedCharacterSet.Contains(item))
				{
					character.CompletelyInfectedCharacterMovement(context);
				}
			}
		}
	}

	public void UpdateLegendaryBookInsaneCharacterMovements(DataContext context)
	{
		for (sbyte b = 0; b < 14; b++)
		{
			int owner = DomainManager.LegendaryBook.GetOwner(b);
			if (owner >= 0 && owner != DomainManager.Taiwu.GetTaiwuCharId())
			{
				Character character = _objects[owner];
				if (character.GetLegendaryBookOwnerState() == 2 && !character.IsActiveExternalRelationState(60) && character.GetKidnapperId() < 0 && character.GetLocation().IsValid())
				{
					character.CompletelyInfectedCharacterMovement(context);
				}
			}
		}
	}

	public void RemoveCrossAreaTravelInfo(DataContext context, int charId)
	{
		if (_crossAreaMoveInfos.ContainsKey(charId))
		{
			RemoveElement_CrossAreaMoveInfos(charId, context);
		}
	}

	public void SetCrossAreaTravelInfo(DataContext context, int charId, CrossAreaMoveInfo crossAreaMoveInfo)
	{
		if (_crossAreaMoveInfos.ContainsKey(charId))
		{
			SetElement_CrossAreaMoveInfos(charId, crossAreaMoveInfo, context);
		}
		else
		{
			AddElement_CrossAreaMoveInfos(charId, crossAreaMoveInfo, context);
		}
	}

	public void GetCrossAreaTravelingCharacterIds(List<int> charIds)
	{
		charIds.Clear();
		charIds.AddRange(_crossAreaMoveInfos.Keys);
	}

	private int GetRandomCharacterInRange(DataContext context, Location centerLocation, int maxSteps, bool includeTaiwu)
	{
		List<int> obj = context.AdvanceMonthRelatedData.CharIdList.Occupy();
		GetCharactersInRange(context, centerLocation, obj, maxSteps, includeTaiwu);
		int randomOrDefault = obj.GetRandomOrDefault(context.Random, -1);
		context.AdvanceMonthRelatedData.CharIdList.Release(ref obj);
		return randomOrDefault;
	}

	private void GetCharactersInRange(DataContext context, Location centerLocation, List<int> charIds, int maxSteps, bool includeTaiwu)
	{
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		Location location = taiwu.GetLocation();
		int id = taiwu.GetId();
		List<MapBlockData> obj = context.AdvanceMonthRelatedData.Blocks.Occupy();
		DomainManager.Map.GetRealNeighborBlocks(centerLocation.AreaId, centerLocation.BlockId, obj, maxSteps, includeCenter: true);
		foreach (MapBlockData item in obj)
		{
			if (item.CharacterSet != null)
			{
				charIds.AddRange(item.CharacterSet);
			}
			if (item.InfectedCharacterSet != null)
			{
				charIds.AddRange(item.InfectedCharacterSet);
			}
			if (item.AreaId != location.AreaId || item.BlockId != location.BlockId)
			{
				continue;
			}
			if (includeTaiwu)
			{
				charIds.AddRange(DomainManager.Taiwu.GetGroupCharIds().GetCollection());
				continue;
			}
			foreach (int item2 in DomainManager.Taiwu.GetGroupCharIds().GetCollection())
			{
				if (item2 != id)
				{
					charIds.Add(item2);
				}
			}
		}
		context.AdvanceMonthRelatedData.Blocks.Release(ref obj);
	}

	public void EscapeToRandomNearbyBlock(DataContext context, Character character, int steps = 3)
	{
		int id = character.GetId();
		if (IsLockMovementChar(id) || id == DomainManager.Taiwu.GetTaiwuCharId())
		{
			return;
		}
		Location location = character.GetLocation();
		if (!location.IsValid())
		{
			return;
		}
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		DomainManager.Map.GetRealNeighborBlocks(location.AreaId, location.BlockId, list, steps);
		if (list.Count != 0)
		{
			MapBlockData random = list.GetRandom(context.Random);
			Location targetLocation = new Location(random.AreaId, random.BlockId);
			ObjectPool<List<MapBlockData>>.Instance.Return(list);
			int leaderId = character.GetLeaderId();
			if (leaderId >= 0 && leaderId != id)
			{
				LeaveGroup(context, character);
			}
			GroupMove(context, character, targetLocation);
		}
	}

	[DomainMethod]
	public FullName GenerateRandomHanName(DataContext context, int customSurnameId, short surnameId, sbyte gender)
	{
		return GenerateRandomHanName(context.Random, customSurnameId, surnameId, gender, -1);
	}

	[DomainMethod]
	public FullName GenerateRandomZangName(DataContext context, sbyte gender)
	{
		return GenerateRandomZangName(context.Random, gender);
	}

	[DomainMethod]
	public FullName GenerateRandomChildName(DataContext context, sbyte gender, FullName parentName)
	{
		if ((parentName.Type & 1) != 0)
		{
			return GenerateRandomHanName(context.Random, parentName.GetCustomSurnameId(), parentName.GetSurnameId(), gender, -1);
		}
		if ((parentName.Type & 2) != 0)
		{
			return GenerateRandomZangName(context.Random, gender);
		}
		throw new Exception("Invalid parent name");
	}

	[DomainMethod]
	public NameRelatedData GenerateRandomName(DataContext context)
	{
		sbyte gender = (sbyte)(context.Random.NextBool() ? 1 : 0);
		NameRelatedData result = new NameRelatedData();
		result.Gender = gender;
		result.FullName = GenerateRandomHanName(context.Random, -1, -1, gender, -1);
		return result;
	}

	public static FullName GenerateRandomHanName(IRandomSource random, int customSurnameId, short surnameId, sbyte gender, int elderBrothersCount)
	{
		if (customSurnameId < 0 && surnameId < 0)
		{
			surnameId = GetRandomHanSurname(random);
		}
		int num = _randomHanNameUnattachedTotalCounts[gender];
		int num2 = _randomHanNameAttachedTotalCounts[gender];
		if (elderBrothersCount >= 0)
		{
			if (elderBrothersCount == 0)
			{
				HanNameItem hanNameItem = LocalNames.Instance.AllNamesCore[0];
				num += hanNameItem.ApartMan.Length + hanNameItem.ApartNeutral.Length;
				num2 += hanNameItem.SerialMan.Length + hanNameItem.SerialNeutral.Length;
			}
			else
			{
				HanNameItem hanNameItem2 = LocalNames.Instance.AllNamesCore[elderBrothersCount];
				num = hanNameItem2.ApartMan.Length + hanNameItem2.ApartNeutral.Length;
				num2 = hanNameItem2.SerialMan.Length + hanNameItem2.SerialNeutral.Length;
			}
		}
		int num3 = random.Next(num + num2);
		bool flag = num3 < num;
		int num4 = (flag ? num3 : (num3 - num));
		int num5 = -1;
		int num6 = -1;
		if (elderBrothersCount < 0)
		{
			int num7 = LocalNames.Instance.AllNamesCore.Length;
			for (short num8 = 100; num8 < num7; num8++)
			{
				HanNameItem hanNameItem3 = LocalNames.Instance.AllNamesCore[num8];
				if (hanNameItem3 != null)
				{
					int num9 = (flag ? (((gender == 1) ? hanNameItem3.ApartMan.Length : hanNameItem3.ApartWoman.Length) + hanNameItem3.ApartNeutral.Length) : (((gender == 1) ? hanNameItem3.SerialMan.Length : hanNameItem3.SerialWoman.Length) + hanNameItem3.SerialNeutral.Length));
					if (num4 < num9)
					{
						num5 = num8;
						num6 = num4;
						break;
					}
					num4 -= num9;
				}
			}
		}
		else if (elderBrothersCount == 0)
		{
			int num10 = LocalNames.Instance.AllNamesCore.Length;
			for (short num11 = 0; num11 < num10; num11++)
			{
				if (num11 <= 0 || num11 >= 100)
				{
					HanNameItem hanNameItem4 = LocalNames.Instance.AllNamesCore[num11];
					if (hanNameItem4 != null)
					{
						int num12 = (flag ? (hanNameItem4.ApartMan.Length + hanNameItem4.ApartNeutral.Length) : (hanNameItem4.SerialMan.Length + hanNameItem4.SerialNeutral.Length));
						if (num4 < num12)
						{
							num5 = num11;
							num6 = num4;
							break;
						}
						num4 -= num12;
					}
				}
			}
		}
		else
		{
			num5 = elderBrothersCount;
			num6 = num4;
		}
		if (num5 < 0 || num6 < 0)
		{
			throw new Exception("Failed to choose given name group.");
		}
		int num13 = ((!flag) ? 2 : ((!random.CheckPercentProb(35)) ? 1 : 0));
		return new FullName(customSurnameId, -1, surnameId, (short)num5, (short)num6, (sbyte)num13);
	}

	public static FullName GenerateRandomZangName(IRandomSource random, sbyte gender)
	{
		int num = -1;
		bool flag = false;
		short num2;
		short num3;
		if (gender == 1)
		{
			num2 = LocalZangNames.Instance.MaleStart;
			num3 = LocalZangNames.Instance.MaleEnd;
		}
		else
		{
			num2 = LocalZangNames.Instance.FemaleStart;
			num3 = LocalZangNames.Instance.FemaleEnd;
		}
		int num4 = random.Next(100);
		int num5;
		if (num4 >= 25)
		{
			num5 = ((num4 >= 63) ? random.Next((int)num2, num3 + 1) : random.Next((int)LocalZangNames.Instance.MixStart, LocalZangNames.Instance.MixEnd + 1));
		}
		else
		{
			num5 = random.Next((int)LocalZangNames.Instance.SoloStart, LocalZangNames.Instance.SoloEnd + 1);
			flag = true;
		}
		if (random.CheckPercentProb(50))
		{
			int num6 = random.Next(100);
			if (num6 < 25)
			{
				if (!flag)
				{
					do
					{
						num = random.Next((int)LocalZangNames.Instance.SoloStart, LocalZangNames.Instance.SoloEnd + 1);
					}
					while (num == num5);
				}
			}
			else if (num6 < 63)
			{
				do
				{
					num = random.Next((int)LocalZangNames.Instance.MixStart, LocalZangNames.Instance.MixEnd + 1);
				}
				while (num == num5);
			}
			else
			{
				do
				{
					num = random.Next((int)num2, num3 + 1);
				}
				while (num == num5);
			}
		}
		if (num >= 0 && random.CheckPercentProb(50))
		{
			int num7 = num;
			num = num5;
			num5 = num7;
		}
		return new FullName(-1, (short)num5, (short)num);
	}

	public static MonasticTitle CreateSectMemberMonasticTitle(DataContext context, Sect sect, short mentorSeniorityId = -1)
	{
		sbyte orgTemplateId = sect.GetOrgTemplateId();
		OrganizationItem organizationItem = Config.Organization.Instance[orgTemplateId];
		short num;
		if (mentorSeniorityId >= 0)
		{
			num = OrganizationDomain.GetNextSeniorityId(organizationItem.SeniorityGroupId, mentorSeniorityId);
			if (mentorSeniorityId == sect.GetMinSeniorityId())
			{
				sect.SetMinSeniorityId(num, context);
			}
		}
		else
		{
			num = sect.GetMinSeniorityId();
		}
		List<short> availableMonasticTitleSuffixIds = sect.GetAvailableMonasticTitleSuffixIds();
		int index = context.Random.Next(availableMonasticTitleSuffixIds.Count);
		short suffixId = availableMonasticTitleSuffixIds[index];
		availableMonasticTitleSuffixIds.RemoveAt(index);
		if (availableMonasticTitleSuffixIds.Count <= 0)
		{
			(short first, short last) monasticTitleSuffixRange = OrganizationDomain.GetMonasticTitleSuffixRange(organizationItem.SeniorityGroupId);
			short item = monasticTitleSuffixRange.first;
			short item2 = monasticTitleSuffixRange.last;
			for (short num2 = item; num2 <= item2; num2++)
			{
				availableMonasticTitleSuffixIds.Add(num2);
			}
		}
		sect.SetAvailableMonasticTitleSuffixIds(availableMonasticTitleSuffixIds, context);
		return new MonasticTitle(num, suffixId);
	}

	public (string surname, string givenName) GetMonasticTitleOrDisplayName(int charId)
	{
		NameRelatedData data = new NameRelatedData();
		GetNameRelatedData(charId, ref data);
		bool isTaiwu = charId == DomainManager.Taiwu.GetTaiwuCharId();
		return data.GetMonasticTitleOrDisplayName(isTaiwu);
	}

	public (string surname, string givenName) GetRealName(int charId)
	{
		NameRelatedData data = new NameRelatedData();
		GetNameRelatedData(charId, ref data);
		return data.GetRealName();
	}

	public static (string surname, string givenName) GetRealName(Character character)
	{
		NameRelatedData data = new NameRelatedData();
		GetNameRelatedData(character, ref data);
		return data.GetRealName();
	}

	public static string FormatName(string surname, string givenName)
	{
		string curLanguageKey = LocalStringManager.CurLanguageKey;
		string text = curLanguageKey;
		if (text == "EN")
		{
			return string.IsNullOrEmpty(surname) ? givenName : (givenName + " " + surname);
		}
		return (surname ?? string.Empty) + givenName;
	}

	public static string FormatName((string, string) name)
	{
		return FormatName(name.Item1, name.Item2);
	}

	public string GetName(int charId, bool realName = false)
	{
		return FormatName(realName ? GetRealName(charId) : GetMonasticTitleOrDisplayName(charId));
	}

	[DomainMethod]
	public List<NameRelatedData> GetNameRelatedDataList(List<int> charIds)
	{
		if (charIds == null || charIds.Count == 0)
		{
			return new List<NameRelatedData>();
		}
		int count = charIds.Count;
		List<NameRelatedData> list = new List<NameRelatedData>(count);
		for (int i = 0; i < count; i++)
		{
			NameRelatedData data = new NameRelatedData();
			GetNameRelatedData(charIds[i], ref data);
			list.Add(data);
		}
		return list;
	}

	[DomainMethod]
	public NameRelatedData GetNameRelatedData(int charId)
	{
		NameRelatedData data = new NameRelatedData();
		GetNameRelatedData(charId, ref data);
		return data;
	}

	[DomainMethod]
	public List<NameAndLifeRelatedData> GetNameAndLifeRelatedDataList(List<int> charIds)
	{
		int count = charIds.Count;
		List<NameAndLifeRelatedData> list = new List<NameAndLifeRelatedData>(count);
		for (int i = 0; i < count; i++)
		{
			NameAndLifeRelatedData data = default(NameAndLifeRelatedData);
			GetNameAndLifeRelatedData(charIds[i], ref data);
			list.Add(data);
		}
		return list;
	}

	[DomainMethod]
	public NameAndLifeRelatedData GetNameAndLifeRelatedData(int charId)
	{
		NameAndLifeRelatedData data = default(NameAndLifeRelatedData);
		GetNameAndLifeRelatedData(charId, ref data);
		return data;
	}

	private static void InitializeRandomHanNameInfo()
	{
		List<short> list = new List<short>();
		List<int> list2 = new List<int>();
		int num = 0;
		int i = 0;
		for (int num2 = LocalSurnames.Instance.SurnameCore.Length; i < num2; i++)
		{
			SurnameItem surnameItem = LocalSurnames.Instance.SurnameCore[i];
			if (surnameItem != null)
			{
				num += surnameItem.Prob;
				list.Add(surnameItem.TemplateId);
				list2.Add(num);
			}
		}
		_randomHanNameSurnameIds = list.ToArray();
		_randomHanNameSurnameAccumulativeWeights = list2.ToArray();
		int num3 = 0;
		int num4 = 0;
		int num5 = 0;
		int num6 = 0;
		int num7 = LocalNames.Instance.AllNamesCore.Length;
		for (short num8 = 100; num8 < num7; num8++)
		{
			HanNameItem hanNameItem = LocalNames.Instance.AllNamesCore[num8];
			if (hanNameItem != null)
			{
				num3 += hanNameItem.ApartMan.Length + hanNameItem.ApartNeutral.Length;
				num4 += hanNameItem.SerialMan.Length + hanNameItem.SerialNeutral.Length;
				num5 += hanNameItem.ApartWoman.Length + hanNameItem.ApartNeutral.Length;
				num6 += hanNameItem.SerialWoman.Length + hanNameItem.SerialNeutral.Length;
			}
		}
		_randomHanNameUnattachedTotalCounts = new int[2] { num5, num3 };
		_randomHanNameAttachedTotalCounts = new int[2] { num6, num4 };
	}

	private unsafe static short GetRandomHanSurname(IRandomSource random)
	{
		int randomAccumulativeWeightedElement;
		fixed (int* randomHanNameSurnameAccumulativeWeights = _randomHanNameSurnameAccumulativeWeights)
		{
			randomAccumulativeWeightedElement = CollectionUtils.GetRandomAccumulativeWeightedElement(random, randomHanNameSurnameAccumulativeWeights, _randomHanNameSurnameAccumulativeWeights.Length);
		}
		return _randomHanNameSurnameIds[randomAccumulativeWeightedElement];
	}

	private void GetNameRelatedData(int charId, ref NameRelatedData data)
	{
		if (_objects.TryGetValue(charId, out var value))
		{
			GetNameRelatedData(value, ref data);
			return;
		}
		if (_deadCharacters.TryGetValue(charId, out var value2))
		{
			GetNameRelatedData(charId, value2, ref data);
			return;
		}
		data.CharTemplateId = -1;
		data.NickNameId = DomainManager.Taiwu.GetFollowingNpcNickNameId(charId);
	}

	private void GetNameAndLifeRelatedData(int charId, ref NameAndLifeRelatedData data)
	{
		DeadCharacter value2;
		if (_objects.TryGetValue(charId, out var value))
		{
			GetNameRelatedData(value, ref data.NameRelatedData);
			data.LifeState = 0;
		}
		else if (_deadCharacters.TryGetValue(charId, out value2))
		{
			GetNameRelatedData(charId, value2, ref data.NameRelatedData);
			data.LifeState = 1;
		}
		else
		{
			data.NameRelatedData.CharTemplateId = -1;
			data.LifeState = 2;
		}
	}

	public static void GetNameRelatedData(Character character, ref NameRelatedData data)
	{
		data.CharTemplateId = character.GetTemplateId();
		data.Gender = character.GetGender();
		data.MonkType = character.GetMonkType();
		data.FullName = character.GetFullName();
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		data.OrgTemplateId = organizationInfo.OrgTemplateId;
		data.OrgGrade = organizationInfo.Grade;
		data.MonasticTitle = character.GetMonasticTitle();
		data.CustomDisplayNameId = DomainManager.Extra.GetCharacterCustomDisplayName(character.GetId());
		data.NickNameId = DomainManager.Taiwu.GetFollowingNpcNickNameId(character.GetId());
		data.ExtraNameTextTemplateId = character.GetExtraNameTextTemplateId();
	}

	public static void GetNameRelatedData(AbridgedCharacter character, ref NameRelatedData data)
	{
		data.CharTemplateId = character.CharTemplateId;
		data.Gender = character.Gender;
		data.MonkType = character.MonkType;
		data.FullName = character.FullName;
		data.OrgTemplateId = character.OrganizationInfo.OrgTemplateId;
		data.OrgGrade = character.OrganizationInfo.Grade;
		data.MonasticTitle = character.MonasticTitle;
		data.CustomDisplayNameId = character.CustomDisplayNameId;
		data.NickNameId = DomainManager.Taiwu.GetFollowingNpcNickNameId(character.Id);
		data.ExtraNameTextTemplateId = -1;
	}

	public static void GetNameRelatedData(int charId, DeadCharacter deadChar, ref NameRelatedData data)
	{
		data = deadChar.GetRawNameRelatedData();
		data.CustomDisplayNameId = DomainManager.Extra.GetCharacterCustomDisplayName(charId);
		data.NickNameId = DomainManager.Taiwu.GetFollowingNpcNickNameId(charId);
	}

	[Obsolete("Use NameRelatedData.GetRealName instead.")]
	private static (string surname, string givenName) GetRealName(ref NameRelatedData data)
	{
		return data.GetRealName();
	}

	public int PackCharacter(RawDataBlock dataBlock, Character character)
	{
		CharacterDataPackage value = PackCharacter(character);
		return dataBlock.AddSerializableGameData((ISerializableGameData)(object)value);
	}

	public CharacterDataPackage PackCharacter(Character character)
	{
		CharacterDataPackage characterDataPackage = new CharacterDataPackage();
		int id = character.GetId();
		characterDataPackage.Character = character;
		characterDataPackage.ItemGroupPackage = new ItemGroupPackage();
		characterDataPackage.CombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(id);
		characterDataPackage.CombatSkillProficiencies = new Dictionary<short, int>();
		foreach (short key in characterDataPackage.CombatSkills.Keys)
		{
			CombatSkillKey elementId = new CombatSkillKey(id, key);
			if (DomainManager.Extra.TryGetElement_CombatSkillProficiencies(elementId, out var value))
			{
				characterDataPackage.CombatSkillProficiencies.Add(key, value);
			}
		}
		ItemKey[] equipment = character.GetEquipment();
		for (int i = 0; i < equipment.Length; i++)
		{
			ItemKey itemKey = equipment[i];
			if (itemKey.IsValid())
			{
				ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey);
				DomainManager.Item.PackItem(characterDataPackage.ItemGroupPackage, baseItem);
			}
		}
		Dictionary<ItemKey, int> items = character.GetInventory().Items;
		foreach (var (itemKey3, num2) in items)
		{
			if (ItemTemplateHelper.GetItemSubType(itemKey3.ItemType, itemKey3.TemplateId) != 1202)
			{
				ItemBase baseItem2 = DomainManager.Item.GetBaseItem(itemKey3);
				DomainManager.Item.PackItem(characterDataPackage.ItemGroupPackage, baseItem2);
			}
		}
		return characterDataPackage;
	}

	public Character UnpackCharacter(DataContext context, RawDataBlock block, ref int offset, bool connectWithSrc)
	{
		CharacterDataPackage data = null;
		offset += block.GetSerializableGameData(ref data, offset);
		return DomainManager.Character.UnpackCharacter(context, data, connectWithSrc);
	}

	public Character UnpackCharacter(DataContext context, CharacterDataPackage package, bool connectWithSrc = false, bool tryKeepOriginalId = false)
	{
		Character character = package.Character;
		int id = character.GetId();
		if (tryKeepOriginalId && !_objects.ContainsKey(id))
		{
			if (_graves.TryGetValue(id, out var value))
			{
				RemoveGrave(context, value);
			}
			if (_deadCharacters.ContainsKey(id))
			{
				RemoveElement_DeadCharacters(id, context);
				RemoveElement_DeadCharDeletionStates(id, context);
			}
		}
		int num = GenerateNextObjectId(context);
		int charId = (connectWithSrc ? id : (-1));
		ItemKey[] array = character.GetEquipment().ToArray();
		character.OfflineSetId(num);
		character.OfflineSetCopySource(charId);
		AddElement_Objects(num, character);
		StartCreatingCharacter(num);
		List<GameData.Domains.CombatSkill.CombatSkill> list = ObjectPool<List<GameData.Domains.CombatSkill.CombatSkill>>.Instance.Get();
		list.Clear();
		short key;
		foreach (KeyValuePair<short, GameData.Domains.CombatSkill.CombatSkill> combatSkill2 in package.CombatSkills)
		{
			combatSkill2.Deconstruct(out key, out var value2);
			short num2 = key;
			GameData.Domains.CombatSkill.CombatSkill combatSkill = value2;
			combatSkill.OfflineSetCharId(num);
			combatSkill.OfflineSetSpecialEffectId(-1L);
			list.Add(combatSkill);
		}
		DomainManager.CombatSkill.RegisterCombatSkills(num, list);
		AutoActivateReadCombatSkillNormalPages(context, list, num);
		ObjectPool<List<GameData.Domains.CombatSkill.CombatSkill>>.Instance.Return(list);
		int value3;
		foreach (KeyValuePair<short, int> combatSkillProficiency in package.CombatSkillProficiencies)
		{
			combatSkillProficiency.Deconstruct(out key, out value3);
			short skillTemplateId = key;
			int value4 = value3;
			DomainManager.Extra.SetCombatSkillProficiency(context, new CombatSkillKey(num, skillTemplateId), value4);
		}
		ItemKey[] equipment = character.GetEquipment();
		for (int i = 0; i < equipment.Length; i++)
		{
			ItemKey itemKey = array[i];
			if (itemKey.IsValid())
			{
				ItemKey itemKey2 = (equipment[i] = DomainManager.Item.UnpackItem(context, package.ItemGroupPackage, itemKey.Id));
				if (itemKey2.IsValid())
				{
					EquipmentBase baseEquipment = DomainManager.Item.GetBaseEquipment(itemKey2);
					baseEquipment.SetOwner(ItemOwnerType.CharacterEquipment, num);
					baseEquipment.SetEquippedCharId(num, context);
				}
			}
		}
		character.SetEquipment(equipment, context);
		Dictionary<ItemKey, int> items = character.GetInventory().Items;
		Inventory inventory = new Inventory();
		foreach (KeyValuePair<ItemKey, int> item in items)
		{
			item.Deconstruct(out var key2, out value3);
			ItemKey itemKey3 = key2;
			int amount = value3;
			ItemKey itemKey4 = DomainManager.Item.UnpackItem(context, package.ItemGroupPackage, itemKey3.Id);
			inventory.OfflineAdd(itemKey4, amount);
			DomainManager.Item.SetOwner(itemKey4, ItemOwnerType.CharacterInventory, num);
		}
		character.SetInventory(inventory, context);
		DomainManager.Information.RegisterInformation(num, context);
		Events.RaiseCharacterCreated(context, character);
		CompleteCreatingCharacter(num);
		if (connectWithSrc)
		{
			RegisterTemporaryIntelligentCharacter(num);
		}
		return character;
	}

	public void CreatePregnantState(DataContext context, Character mother, Character father, bool isRaped)
	{
		int id = mother.GetId();
		if (_pregnantStates.TryGetValue(id, out var value))
		{
			Logger.Warn($"PregnantState already exist for character {mother} - {value}");
			return;
		}
		value = new PregnantState(mother, father, isRaped);
		int currDate = DomainManager.World.GetCurrDate();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		if (taiwuCharId == mother.GetId() || taiwuCharId == father.GetId())
		{
			value.IsHuman = !context.Random.CheckPercentProb(DomainManager.Taiwu.GetCricketLuckPoint() / 100);
			if (value.IsHuman)
			{
				value.ExpectedBirthDate = currDate + context.Random.Next(6, 10);
			}
			else
			{
				value.ExpectedBirthDate = currDate + 42;
				DomainManager.Taiwu.SetCricketLuckPoint(0, context);
			}
		}
		else
		{
			value.ExpectedBirthDate = currDate + context.Random.Next(6, 10);
			value.IsHuman = true;
		}
		if (mother.GetLeaderId() == DomainManager.Taiwu.GetTaiwuCharId())
		{
			Events.RaiseTaiwuOrTeammatePregnant(context, mother.GetId(), mother.GetLocation());
		}
		AddElement_PregnantStates(mother.GetId(), value, context);
	}

	public PregnantState GetPregnantState(int motherCharId)
	{
		return _pregnantStates[motherCharId];
	}

	public bool TryGetPregnantState(int motherCharId, out PregnantState pregnantState)
	{
		return _pregnantStates.TryGetValue(motherCharId, out pregnantState);
	}

	public void ConvertPregnantWithCricketToHuman(DataContext context, int motherCharId)
	{
		PregnantState pregnantState = _pregnantStates[motherCharId];
		pregnantState.IsHuman = true;
		pregnantState.ExpectedBirthDate = DomainManager.World.GetCurrDate() + 3;
		SetElement_PregnantStates(motherCharId, pregnantState, context);
	}

	public void RemovePregnantLock(DataContext context, int motherCharId)
	{
		RemoveElement_PregnancyLockEndDates(motherCharId, context);
	}

	public bool CanSelectForForcePregnancy(Character character)
	{
		if (character.GetGender() != 0)
		{
			return false;
		}
		if (character.GetAgeGroup() != 2)
		{
			return false;
		}
		if (character.IsCompletelyInfected())
		{
			return false;
		}
		if (character.GetLegendaryBookOwnerState() >= 2)
		{
			return false;
		}
		if (TryGetPregnantState(character.GetId(), out var _))
		{
			return false;
		}
		return true;
	}

	public void MakePregnantWithoutMale(DataContext context, Character mother)
	{
		int currDate = DomainManager.World.GetCurrDate();
		PregnantState pregnantState = new PregnantState(mother, null, isRaped: false);
		pregnantState.ExpectedBirthDate = currDate + context.Random.Next(6, 10);
		pregnantState.IsHuman = true;
		mother.AddFeature(context, 197);
		if (mother.GetLeaderId() == DomainManager.Taiwu.GetTaiwuCharId())
		{
			Events.RaiseTaiwuOrTeammatePregnant(context, mother.GetId(), mother.GetLocation());
		}
		AddElement_PregnantStates(mother.GetId(), pregnantState, context);
	}

	public void UpdatePregnancyUnlockDates(DataContext context)
	{
		int currDate = DomainManager.World.GetCurrDate();
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		list.Clear();
		foreach (var (item, num3) in _pregnancyLockEndDates)
		{
			if (currDate >= num3)
			{
				list.Add(item);
			}
		}
		foreach (int item2 in list)
		{
			RemoveElement_PregnancyLockEndDates(item2, context);
		}
		ObjectPool<List<int>>.Instance.Return(list);
	}

	public void ParallelUpdatePregnantState(DataContext context, Character mother, PregnantStateModification mod)
	{
		PregnantState element_PregnantStates = GetElement_PregnantStates(mother.GetId());
		int currDate = DomainManager.World.GetCurrDate();
		int id = mother.GetId();
		bool flag = mother.GetXiangshuInfection() >= 200;
		IRandomSource random = context.Random;
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		if (flag || element_PregnantStates.ExpectedBirthDate > currDate)
		{
			short health = mother.GetHealth();
			short leftMaxHealth = mother.GetLeftMaxHealth();
			double num = (double)health / (double)leftMaxHealth;
			if (num < 0.30000001192092896 || flag)
			{
				GameData.Domains.Character.Ai.PersonalNeed personalNeed = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(1, leftMaxHealth - health);
				mother.OfflineAddPersonalNeed(personalNeed);
				if (flag || random.NextDouble() < 0.30000001192092896 - num)
				{
					mod.State = PregnantStateModification.ChildState.Dead;
					return;
				}
			}
			if (id == DomainManager.Taiwu.GetTaiwuCharId() && element_PregnantStates.IsHuman)
			{
				bool flag2;
				switch (element_PregnantStates.ExpectedBirthDate - currDate)
				{
				case 1:
				case 3:
				case 5:
					flag2 = true;
					break;
				default:
					flag2 = false;
					break;
				}
				if (flag2 && random.CheckPercentProb(75))
				{
					mod.PrenatalEvent = true;
				}
			}
			else if ((taiwuCharId == element_PregnantStates.FatherId || taiwuCharId == id) && !element_PregnantStates.IsHuman && element_PregnantStates.ExpectedBirthDate - currDate <= 3)
			{
				mod.DreamedOfCricket = true;
			}
		}
		else if (element_PregnantStates.IsHuman)
		{
			short health2 = mother.GetHealth();
			short leftMaxHealth2 = mother.GetLeftMaxHealth();
			double num2 = (double)health2 / (double)leftMaxHealth2;
			if (num2 < 0.30000001192092896 && random.NextDouble() < 0.30000001192092896 - num2)
			{
				int num3 = random.Next(10);
				mod.Dystocia = true;
				if (num3 < 1)
				{
					mod.LostMother = true;
					mod.State = PregnantStateModification.ChildState.Dead;
				}
				else if (num3 < 3)
				{
					mod.State = PregnantStateModification.ChildState.AliveHuman;
				}
				else if (num3 < 6)
				{
					mod.State = PregnantStateModification.ChildState.Dead;
				}
				else
				{
					mod.LostMother = true;
					mod.State = PregnantStateModification.ChildState.AliveHuman;
				}
			}
			else
			{
				mod.State = PregnantStateModification.ChildState.AliveHuman;
			}
		}
		else
		{
			mod.State = PregnantStateModification.ChildState.AliveCricket;
		}
	}

	public void ApplyPregnantStateChange(DataContext context, Character mother, PregnantStateModification mod)
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		int id = mother.GetId();
		int currDate = DomainManager.World.GetCurrDate();
		MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
		LifeRecordCollection lifeRecordCollection = DomainManager.LifeRecord.GetLifeRecordCollection();
		SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
		MonthlyEventCollection monthlyEventCollection = DomainManager.World.GetMonthlyEventCollection();
		PregnantState element_PregnantStates = GetElement_PregnantStates(id);
		Location location = mother.GetLocation();
		if (mod.State == PregnantStateModification.ChildState.Dead)
		{
			lifeRecordCollection.AddMotherLoseFetus(id, currDate, location);
			GameData.Domains.Character.Ai.PersonalNeed personalNeed = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(20, element_PregnantStates.FatherId);
			GameData.Domains.Character.Ai.PersonalNeed personalNeed2 = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed((sbyte)25, (ushort)128);
			mother.OfflineAddPersonalNeed(personalNeed);
			mother.OfflineAddPersonalNeed(personalNeed2);
			mother.SetPersonalNeeds(mother.GetPersonalNeeds(), context);
			mother.SetHappiness(mother.GetHappiness(), context);
			IntPair directedSamsaraInfo = GetDirectedSamsaraInfo(id);
			if (mod.LostMother)
			{
				if (id == taiwuCharId)
				{
					monthlyEventCollection.AddMotherFetusBothDieTaiwu(id, location);
				}
				else if (element_PregnantStates.FatherId == taiwuCharId)
				{
					monthlyEventCollection.AddMotherFetusBothDieWife(id, location);
				}
				if (directedSamsaraInfo.First >= 0)
				{
					monthlyNotificationCollection.AddMiscarriageAndReincarnationMotherDies(id, location, directedSamsaraInfo.First);
				}
			}
			else
			{
				if (id == taiwuCharId)
				{
					if (mod.Dystocia)
					{
						monthlyEventCollection.AddDystociaLoseFetusTaiwu(id, location);
					}
					else
					{
						monthlyEventCollection.AddAbortionTaiwu(id, location);
					}
				}
				else if (element_PregnantStates.FatherId == taiwuCharId)
				{
					if (mod.Dystocia)
					{
						monthlyEventCollection.AddDystociaLoseFetusWife(id, location);
					}
					else
					{
						monthlyEventCollection.AddLoseFetusWife(id, location);
					}
				}
				if (IsTaiwuPeople(id))
				{
					monthlyNotificationCollection.AddMotherLoseFetus(id, location);
				}
				if (directedSamsaraInfo.First >= 0)
				{
					monthlyNotificationCollection.AddMiscarriageAndReincarnation(id, location, directedSamsaraInfo.First);
				}
			}
			int dataOffset = secretInformationCollection.AddLoseFetus(id, location);
			int num = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
			if (element_PregnantStates.CreateFatherRelation && DomainManager.Character.TryGetElement_Objects(element_PregnantStates.FatherId, out var element))
			{
				lifeRecordCollection.AddFatherLoseFetus(element_PregnantStates.FatherId, currDate, id, location);
				personalNeed = GameData.Domains.Character.Ai.PersonalNeed.CreatePersonalNeed(20, id);
				element.OfflineAddPersonalNeed(personalNeed);
				element.OfflineAddPersonalNeed(personalNeed2);
				element.SetPersonalNeeds(element.GetPersonalNeeds(), context);
				element.SetHappiness(element.GetHappiness(), context);
			}
		}
		else if (mod.State == PregnantStateModification.ChildState.AliveCricket)
		{
			if (taiwuCharId == id)
			{
				monthlyEventCollection.AddGiveBirthToCricketTaiwu(taiwuCharId);
			}
			else if (taiwuCharId == element_PregnantStates.FatherId)
			{
				monthlyEventCollection.AddGiveBirthToCricketWife(id);
			}
			monthlyNotificationCollection.AddGiveBirthToCricket(taiwuCharId);
		}
		else if (mod.DreamedOfCricket)
		{
			if (mother.GetId() == taiwuCharId)
			{
				monthlyEventCollection.AddCricketInDream(taiwuCharId, location);
			}
			else
			{
				Character taiwu = DomainManager.Taiwu.GetTaiwu();
				monthlyEventCollection.AddCricketInDreamTaiwuPartnerPregnant(taiwuCharId, taiwu.GetLocation(), mother.GetId());
			}
		}
		else if (mod.PrenatalEvent)
		{
			monthlyEventCollection.AddPrenatalEducationTaiwu(taiwuCharId);
		}
		if (mod.State != PregnantStateModification.ChildState.Invalid)
		{
			DomainManager.Building.TryRemoveSamsaraPlatformBornData(context, id);
			ProfessionSkillHandle.BuddhistMonkSkill_TryRemoveDirectedSamsara(context, id);
			RemoveElement_PregnantStates(id, context);
			int value = currDate + context.Random.Next(12, 36);
			if (TryGetElement_PregnancyLockEndDates(id, out var _))
			{
				SetElement_PregnancyLockEndDates(id, value, context);
			}
			else
			{
				AddElement_PregnancyLockEndDates(id, value, context);
			}
		}
	}

	public void PrepareForPrioritizedAction(DataContext context)
	{
		PrepareContestForLegendaryBookPrioritizedActionData(context);
		PrepareYuanShanPrioritizedActionData(context);
		PrepareShiXiangPrioritizedActionData(context);
		PrepareInfantPrioritizedActionData(context);
		PrepareEMeiPrioritizedActionData(context);
		PrepareBaihuaPrioritizedActionData();
	}

	private void PrepareContestForLegendaryBookPrioritizedActionData(DataContext context)
	{
		if (!DomainManager.LegendaryBook.IsAnyLegendaryBookOwned())
		{
			return;
		}
		int num = 0;
		for (sbyte b = 0; b < 14; b++)
		{
			if (DomainManager.LegendaryBook.GetOwner(b) >= 0)
			{
				int count = DomainManager.Extra.GetContestForLegendaryBookCharacterSet(b).GetCount();
				int num2 = 2 - count;
				if (num2 > 0)
				{
					num += num2;
				}
			}
		}
		if (num <= 0)
		{
			return;
		}
		List<int> obj = context.AdvanceMonthRelatedData.CharIdList.Occupy();
		IList<int> values = _topThousandCharDescendingRanking.Values;
		int i = 0;
		for (int num3 = Math.Min(values.Count, 100); i < num3; i++)
		{
			obj.Add(values[i]);
		}
		for (sbyte b2 = 1; b2 <= 15; b2++)
		{
			Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(b2);
			for (int j = 1; j <= 3; j++)
			{
				long rankingInfo = settlementByOrgTemplateId.GetRankingInfo(1);
				int item = (int)(rankingInfo & 0x7FFFFFFF);
				obj.Add(item);
			}
		}
		CollectionUtils.Shuffle(context.Random, obj);
		foreach (int item2 in obj)
		{
			if (num <= 0)
			{
				break;
			}
			if (_objects.TryGetValue(item2, out var value) && value.GetAgeGroup() != 0 && !value.IsActiveExternalRelationState(60) && !value.IsActiveExternalRelationState(1) && !DomainManager.LegendaryBook.IsCharacterActingCrazy(value) && !TryGetCharacterPrioritizedAction(item2, out var _) && !DomainManager.Extra.IsPrioritizedActionInCooldown(item2, 9))
			{
				_legendaryBookChallengers.Add(item2);
				num--;
			}
		}
		context.AdvanceMonthRelatedData.CharIdList.Release(ref obj);
	}

	private void PrepareYuanShanPrioritizedActionData(DataContext context)
	{
		_yuanShanEnemyLocations.Clear();
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(5);
		if (!sectMainStoryEventArgBox.GetBool("ConchShip_PresetKey_YuanshanToFightDemon"))
		{
			return;
		}
		if (DomainManager.Character.TryGetFixedCharacterByTemplateId(585, out var character))
		{
			Location location = character.GetLocation();
			if (location.IsValid())
			{
				_yuanShanEnemyLocations.Add(location);
			}
		}
		if (DomainManager.Character.TryGetFixedCharacterByTemplateId(586, out character))
		{
			Location location2 = character.GetLocation();
			if (location2.IsValid())
			{
				_yuanShanEnemyLocations.Add(location2);
			}
		}
		if (DomainManager.Character.TryGetFixedCharacterByTemplateId(587, out character))
		{
			Location location3 = character.GetLocation();
			if (location3.IsValid())
			{
				_yuanShanEnemyLocations.Add(location3);
			}
		}
	}

	private void PrepareShiXiangPrioritizedActionData(DataContext context)
	{
		_shiXiangEnemyBlockIds.Clear();
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(6);
		if (sectMainStoryEventArgBox.GetBool("ConchShip_PresetKey_ShixiangToFightEnemy"))
		{
			SectStoryShixiangToFightEnemyAction.ResetKilledLimit(context);
			DomainManager.World.ShixiangQueryEnemyLocations(context, out _shiXiangEnemyAreaId, out _shiXiangEnemyBlockIds);
		}
	}

	private void PrepareInfantPrioritizedActionData(DataContext context)
	{
		_charactersWithInfantNearBy.Clear();
		_characterWithInfantWithBloodRelation.Clear();
		foreach (KeyValuePair<int, int> item in _infantMap)
		{
			if (!TryGetElement_Objects(item.Key, out var element) || element.GetAgeGroup() != 0 || element.GetLeaderId() >= 0 || InfantHasPotentialAdopter(item.Key) || element.GetOrganizationInfo().OrgTemplateId == 16)
			{
				continue;
			}
			Location location = element.GetLocation();
			if (!location.IsValid())
			{
				continue;
			}
			Span<MapBlockData> areaBlocks = DomainManager.Map.GetAreaBlocks(location.AreaId);
			ByteCoordinate blockPos = DomainManager.Map.GetBlock(location).GetBlockPos();
			Span<MapBlockData> span = areaBlocks;
			for (int i = 0; i < span.Length; i++)
			{
				MapBlockData mapBlockData = span[i];
				if (mapBlockData.CharacterSet == null)
				{
					continue;
				}
				foreach (int item2 in mapBlockData.CharacterSet)
				{
					if (!RelationTypeHelper.AllowAddingAdoptiveChildRelation(item2, item.Key))
					{
						_characterWithInfantWithBloodRelation[item2] = item.Key;
					}
					int manhattanDistance = blockPos.GetManhattanDistance(mapBlockData.GetBlockPos());
					if (!_charactersWithInfantNearBy.TryGetValue(item2, out var value) || value.Item2 > manhattanDistance)
					{
						_charactersWithInfantNearBy[item2] = (item.Key, manhattanDistance);
					}
					else if (value.Item2 == manhattanDistance && context.Random.CheckPercentProb(50))
					{
						_charactersWithInfantNearBy[item2] = (item.Key, manhattanDistance);
					}
				}
			}
		}
	}

	private void PrepareEMeiPrioritizedActionData(DataContext context)
	{
		_eMeiPsychotics.Clear();
		EventArgBox sectMainStoryEventArgBox = DomainManager.Extra.GetSectMainStoryEventArgBox(2);
		if (!sectMainStoryEventArgBox.Contains<int>("ConchShip_PresetKey_EmeiKillEachOtherStage"))
		{
			return;
		}
		int num = ((sectMainStoryEventArgBox.GetInt("ConchShip_PresetKey_EmeiKillEachOtherStage") == 1) ? context.Random.Next(1, 4) : context.Random.Next(3, 10));
		Settlement settlementByOrgTemplateId = DomainManager.Organization.GetSettlementByOrgTemplateId(2);
		short areaId = settlementByOrgTemplateId.GetLocation().AreaId;
		OrgMemberCollection members = settlementByOrgTemplateId.GetMembers();
		List<int> obj = context.AdvanceMonthRelatedData.CharIdList.Occupy();
		members.GetAllMembers(obj);
		foreach (int item in obj)
		{
			if (DomainManager.Extra.SectEmeiGetInsaneCharacterIdCount() >= num)
			{
				break;
			}
			if (DomainManager.Character.TryGetElement_Objects(item, out var element) && element.GetLocation().AreaId == areaId)
			{
				_eMeiPsychotics.Add(item);
			}
		}
		context.AdvanceMonthRelatedData.CharIdList.Release(ref obj);
	}

	private void PrepareBaihuaPrioritizedActionData()
	{
		BaihuaManicCharIds.Clear();
		IntList intList = DomainManager.World.BaihuaGetSpecialDebuffIntList();
		List<int> items = intList.Items;
		if (items == null || items.Count <= 0)
		{
			return;
		}
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		list.Clear();
		list.AddRange(intList.Items);
		IntList intList2 = DomainManager.World.BaihuaGetCureSpecialDebuffIntList();
		items = intList2.Items;
		if (items != null && items.Count > 0)
		{
			list.RemoveAll(intList2.Items.Contains);
		}
		list.RemoveAll(IsNotManicCharId);
		foreach (int item in list)
		{
			BaihuaManicCharIds.Add(item);
		}
		ObjectPool<List<int>>.Instance.Return(list);
	}

	private bool IsNotManicCharId(int charId)
	{
		Character element;
		return !TryGetElement_Objects(charId, out element) || IsNotManicCharacter(element);
	}

	public bool IsNotManicCharacter(Character character)
	{
		List<short> featureIds = character.GetFeatureIds();
		return !featureIds.Contains(541) && !featureIds.Contains(542);
	}

	public Location TryGetYuanShanEnemyLocation(DataContext context)
	{
		if (_yuanShanEnemyLocations.Count <= 0)
		{
			return Location.Invalid;
		}
		Location location = _yuanShanEnemyLocations[context.Random.Next(_yuanShanEnemyLocations.Count)];
		List<MapBlockData> obj = context.AdvanceMonthRelatedData.Blocks.Occupy();
		DomainManager.Map.GetNeighborBlocks(location.AreaId, location.BlockId, obj, 2);
		Location location2 = obj.GetRandom(context.Random).GetLocation();
		context.AdvanceMonthRelatedData.Blocks.Release(ref obj);
		return location2;
	}

	public Location TryGetShiXiangEnemyLocation(DataContext context)
	{
		if (_shiXiangEnemyBlockIds.Count == 0)
		{
			return Location.Invalid;
		}
		return new Location(_shiXiangEnemyAreaId, _shiXiangEnemyBlockIds.GetRandom(context.Random));
	}

	public bool TryGetClosestInfant(int charId, out (int, int) infantData)
	{
		return _charactersWithInfantNearBy.TryGetValue(charId, out infantData);
	}

	public bool TryGetBloodRelationInfant(int charId, out int infantId)
	{
		return _characterWithInfantWithBloodRelation.TryGetValue(charId, out infantId);
	}

	public bool IsEMeiCharacterPsychotic(int charId)
	{
		return _eMeiPsychotics.Contains(charId);
	}

	public bool IsCharacterTryingToContestLegendaryBook(int charId)
	{
		return _legendaryBookChallengers.Contains(charId);
	}

	public void GenerateCharacterProfession(DataContext context, Character character)
	{
		int id = character.GetId();
		if (id == DomainManager.Taiwu.GetTaiwuCharId())
		{
			return;
		}
		ProfessionData characterCurrentProfession = DomainManager.Extra.GetCharacterCurrentProfession(id);
		if (characterCurrentProfession != null)
		{
			return;
		}
		OrganizationMemberItem orgMemberConfig = OrganizationDomain.GetOrgMemberConfig(character.GetOrganizationInfo());
		IntPair[] preferProfessions = orgMemberConfig.PreferProfessions;
		if (preferProfessions == null || preferProfessions.Length <= 0)
		{
			return;
		}
		Span<IntPair> span = stackalloc IntPair[orgMemberConfig.PreferProfessions.Length];
		SpanList<IntPair> list = span;
		list.AddRange(orgMemberConfig.PreferProfessions);
		CollectionUtils.Shuffle(context.Random, list);
		SpanList<IntPair>.Enumerator enumerator = list.GetEnumerator();
		while (enumerator.MoveNext())
		{
			IntPair current = enumerator.Current;
			if (!context.Random.CheckPercentProb(current.Second))
			{
				continue;
			}
			ProfessionItem professionItem = Profession.Instance[current.First];
			int maxProfessionSeniority = character.GetMaxProfessionSeniority(current.First);
			int initSeniority = MathUtils.Clamp(professionItem.ProfessionSeniorityPerMonth[character.GetInteractionGrade()] * (character.GetCurrAge() - 16) * 12, 0, maxProfessionSeniority);
			DomainManager.Extra.SetCharacterCurrProfession(context, character.GetId(), current.First, initSeniority);
			break;
		}
	}

	[DomainMethod]
	public (ushort, ushort) GetRelationBetweenCharacters(int charId, int relatedCharId)
	{
		RelationKey key = new RelationKey(charId, relatedCharId);
		RelationKey key2 = new RelationKey(relatedCharId, charId);
		RelatedCharacter value;
		ushort item = (_relations.TryGetValue(key, out value) ? value.RelationType : ushort.MaxValue);
		RelatedCharacter value2;
		ushort item2 = (_relations.TryGetValue(key2, out value2) ? value2.RelationType : ushort.MaxValue);
		return (item, item2);
	}

	public RelatedCharacter GetRelation(int charId, int relatedCharId)
	{
		return _relations[new RelationKey(charId, relatedCharId)];
	}

	public bool TryGetRelation(int charId, int relatedCharId, out RelatedCharacter relation)
	{
		return _relations.TryGetValue(new RelationKey(charId, relatedCharId), out relation);
	}

	public bool HasRelation(int charId, int relatedCharId, ushort targetRelationType)
	{
		if (_relations.TryGetValue(new RelationKey(charId, relatedCharId), out var value))
		{
			ushort relationType = value.RelationType;
			return (targetRelationType != 0) ? RelationType.HasRelation(relationType, targetRelationType) : (relationType == 0);
		}
		return false;
	}

	public bool HasBloodGrandParentRelations(int charId, int relatedCharId)
	{
		HashSet<int> relatedCharIds = GetRelatedCharIds(charId, 1);
		HashSet<int> relatedCharIds2 = GetRelatedCharIds(relatedCharId, 2);
		return relatedCharIds.Overlaps(relatedCharIds2);
	}

	public bool IsCharacterRelationFriendly(int charIdA, int charIdB)
	{
		RelatedCharacter relation;
		bool flag = TryGetRelation(charIdA, charIdB, out relation);
		RelatedCharacter relation2;
		bool flag2 = TryGetRelation(charIdB, charIdA, out relation2);
		if (!flag && !flag2)
		{
			return false;
		}
		sbyte targetRelationCategory = AiHelper.ActionTargetRelationCategory.GetTargetRelationCategory(relation.RelationType);
		sbyte targetRelationCategory2 = AiHelper.ActionTargetRelationCategory.GetTargetRelationCategory(relation2.RelationType);
		return targetRelationCategory == 1 || targetRelationCategory2 == 1;
	}

	public bool IsCharacterRelationUnfriendly(int charIdA, int charIdB)
	{
		RelatedCharacter relation;
		bool flag = TryGetRelation(charIdA, charIdB, out relation);
		RelatedCharacter relation2;
		bool flag2 = TryGetRelation(charIdB, charIdA, out relation2);
		if (!flag && !flag2)
		{
			return false;
		}
		sbyte targetRelationCategory = AiHelper.ActionTargetRelationCategory.GetTargetRelationCategory(relation.RelationType);
		sbyte targetRelationCategory2 = AiHelper.ActionTargetRelationCategory.GetTargetRelationCategory(relation2.RelationType);
		return targetRelationCategory == 2 || targetRelationCategory2 == 2;
	}

	[DomainMethod]
	public bool IsInteractedWithTaiwu(int charId)
	{
		return DomainManager.Extra.GetIsInteractedCharacter(charId);
	}

	public sbyte GetFavorabilityType(int charId, int relatedCharId)
	{
		short favorability = GetFavorability(charId, relatedCharId);
		return FavorabilityType.GetFavorabilityType(favorability);
	}

	[DomainMethod]
	public short GetFavorability(int charId, int relatedCharId)
	{
		RelatedCharacter relation;
		return TryGetRelation(charId, relatedCharId, out relation) ? relation.Favorability : short.MinValue;
	}

	public short GetFavorabilityMaxValueToTaiwuWithDebt(int charId)
	{
		if (!_debtsToTaiwu.TryGetValue(charId, out var value))
		{
			return 30000;
		}
		return value.GetMaxFavorabilityWithDebt();
	}

	[Obsolete("Use ChangeFavorabilityOptional instead")]
	public void ChangeFavorability(DataContext context, Character character, Character relatedChar, int baseDelta)
	{
		ChangeFavorabilityOptional(context, character, relatedChar, baseDelta, -1);
	}

	public void ChangeFavorabilityOptional(DataContext context, Character character, Character relatedChar, int baseDelta, short type)
	{
		Tester.Assert(character.GetCreatingType() == 1);
		Tester.Assert(relatedChar.GetCreatingType() == 1);
		int delta = CalcFavorabilityDelta(character, relatedChar, baseDelta, type);
		DirectlyChangeFavorabilityOptional(context, character, relatedChar, delta, -1);
	}

	public void ChangeFavorabilityOptionalMonthlyEvolution(DataContext context, Character character, Character relatedChar, int baseDelta)
	{
		ChangeFavorabilityOptional(context, character, relatedChar, baseDelta, 5);
	}

	public void ChangeFavorabilityOptionalGiftItem(DataContext context, Character character, Character relatedChar, int baseDelta)
	{
		ChangeFavorabilityOptional(context, character, relatedChar, baseDelta, 1);
	}

	public void ChangeFavorabilityOptionalRepeatedEvent(DataContext context, Character character, Character relatedChar, int baseDelta)
	{
		ChangeFavorabilityOptional(context, character, relatedChar, baseDelta, 3);
	}

	[Obsolete("Use DirectlyChangeFavorabilityOptional instead")]
	public void DirectlyChangeFavorability(DataContext context, Character character, Character relatedChar, int delta)
	{
		DirectlyChangeFavorabilityOptional(context, character, relatedChar, delta, -1);
	}

	public void DirectlyChangeFavorabilityOptional(DataContext context, Character character, Character relatedChar, int delta, short type)
	{
		byte creatingType = character.GetCreatingType();
		bool condition = (uint)creatingType <= 1u;
		Tester.Assert(condition);
		creatingType = relatedChar.GetCreatingType();
		condition = (uint)creatingType <= 1u;
		Tester.Assert(condition);
		int id = character.GetId();
		int id2 = relatedChar.GetId();
		RelationKey relationKey = new RelationKey(id, id2);
		if (!_relations.TryGetValue(relationKey, out var value))
		{
			var (initialFavorability, initialFavorability2) = CalcInitialFavorabilitiesOfAliveChars(context.Random, character, relatedChar);
			CreateRelation(context, id, id2, 0, initialFavorability);
			CreateRelation(context, id2, id, 0, initialFavorability2);
			value = _relations[relationKey];
		}
		(int, bool) favorabilityChangePercent = DomainManager.World.GetFavorabilityChangePercent(type, character.IsFavorabilityGainFixed);
		delta = ((delta < 0 && favorabilityChangePercent.Item2) ? (delta * 100 / favorabilityChangePercent.Item1) : (delta * favorabilityChangePercent.Item1 / 100));
		if (id2 == DomainManager.Taiwu.GetTaiwuCharId())
		{
			value.Favorability = (short)Math.Clamp(value.Favorability + delta, -30000, GetFavorabilityMaxValueToTaiwuWithDebt(id));
			if (FavorabilityType.GetFavorabilityType(value.Favorability) >= 3)
			{
				character.SetLovingItemRevealed(lovingItemRevealed: true, context);
				character.SetHatingItemRevealed(hatingItemRevealed: true, context);
			}
		}
		else
		{
			value.Favorability = (short)Math.Clamp(value.Favorability + delta, -30000, 30000);
		}
		SetElement_Relations(relationKey, value, context);
	}

	public void DirectlySetFavorabilities(DataContext context, int charId, int relatedCharId, short value, short relatedValue)
	{
		SetFavorability(context, charId, relatedCharId, value);
		SetFavorability(context, relatedCharId, charId, relatedValue);
	}

	public void DirectlyUpgradeFavorability(DataContext context, int charA, int charB)
	{
		short favorability = DomainManager.Character.GetFavorability(charA, charB);
		sbyte favorabilityType = FavorabilityType.GetFavorabilityType(favorability);
		favorabilityType++;
		if (favorabilityType >= 6)
		{
			favorabilityType = 6;
		}
		favorability = FavorabilityType.GetRandomFavorability(context.Random, favorabilityType);
		DirectlySetFavorabilities(context, charA, charB, favorability, favorability);
	}

	public void ChangeFavorabilityTendToZero(DataContext context, int charId, int targetCharId, int delta)
	{
		short favorability = GetFavorability(charId, targetCharId);
		if ((favorability != short.MinValue && favorability != 0) || 1 == 0)
		{
			short value = ((favorability > 0) ? ((short)Math.Max(0, favorability - delta)) : ((short)Math.Min(0, favorability + delta)));
			SetFavorability(context, charId, targetCharId, value);
		}
	}

	public List<(int charId, short favorability)> ChangeFavorabilitiesOfAllRelatedCharsWhenChangingHobby(DataContext context, Character character)
	{
		int id = character.GetId();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		HashSet<int> obj = context.AdvanceMonthRelatedData.RelatedCharIds.Occupy();
		GetAllRelatedCharIds(id, obj);
		if (obj.Count <= 0)
		{
			context.AdvanceMonthRelatedData.RelatedCharIds.Release(ref obj);
			return null;
		}
		sbyte behaviorType = character.GetBehaviorType();
		(short positive, short negative) tuple = BaseChangedFavorabilitiesOfChangingHobby[behaviorType];
		short item = tuple.positive;
		short item2 = tuple.negative;
		List<(int, short)> list = new List<(int, short)>();
		foreach (int item3 in obj)
		{
			if (IsCharacterAlive(item3))
			{
				short favorability = _relations[new RelationKey(id, item3)].Favorability;
				sbyte favorabilityType = FavorabilityType.GetFavorabilityType(favorability);
				sbyte b = FavorabilityChangingFactorsOfChangingHobby[FavorabilityType.ToIndex(favorabilityType)];
				int num = ((favorabilityType >= 0) ? item : item2) * b / 100;
				short max = (short)((item3 == taiwuCharId) ? GetFavorabilityMaxValueToTaiwuWithDebt(id) : 30000);
				short num2 = (short)Math.Clamp(favorability + num, -30000, max);
				if (num2 != favorability)
				{
					list.Add((item3, num2));
				}
			}
		}
		context.AdvanceMonthRelatedData.RelatedCharIds.Release(ref obj);
		return (list.Count > 0) ? list : null;
	}

	public void ApplyFavorabilitiesOfRelatedCharsWhenChangingHobby(DataContext context, int charId, List<(int charId, short favorability)> relatedChars)
	{
		int i = 0;
		for (int count = relatedChars.Count; i < count; i++)
		{
			var (num, favorability) = relatedChars[i];
			if (IsCharacterAlive(num))
			{
				RelationKey relationKey = new RelationKey(charId, num);
				RelatedCharacter value = _relations[relationKey];
				value.Favorability = favorability;
				SetElement_Relations(relationKey, value, context);
			}
		}
	}

	public void TryEnterTaiwuDreamWhenReincarnated(int reincarnatedCharId, short settlementId)
	{
		if (settlementId < 0 || DomainManager.World.GetAdvancingMonthState() == 0)
		{
			return;
		}
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		if (TryGetRelation(reincarnatedCharId, taiwuCharId, out var relation))
		{
			sbyte favorabilityType = FavorabilityType.GetFavorabilityType(relation.Favorability);
			if (favorabilityType >= 5 || favorabilityType <= -5 || relation.RelationType != 0 || (TryGetRelation(taiwuCharId, reincarnatedCharId, out var relation2) && relation2.RelationType != 0))
			{
				MonthlyNotificationCollection monthlyNotificationCollection = DomainManager.World.GetMonthlyNotificationCollection();
				monthlyNotificationCollection.AddReincarnationNewWithLocation(taiwuCharId, reincarnatedCharId, DomainManager.Organization.GetSettlement(settlementId).GetLocation());
			}
		}
	}

	public void TransferFixedCharacterFavorability(DataContext context, int oldTaiwuCharId, int newTaiwuCharId)
	{
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		list.Clear();
		list.AddRange(_fixedCharactersCache.Values);
		foreach (int item in list)
		{
			Character character = _objects[item];
			short templateId = character.GetTemplateId();
			short num = templateId;
			short num2 = num;
			if (num2 == 810 || num2 == 812)
			{
				short favorability = GetFavorability(item, oldTaiwuCharId);
				DirectlySetFavorabilities(context, item, newTaiwuCharId, favorability, favorability);
			}
		}
		ObjectPool<List<int>>.Instance.Return(list);
	}

	public void GetPotentialRelatedCharactersInSet(PotentialRelatedCharacters canStartRelationChars, PotentialRelatedCharacters canEndRelationChars, List<Character> needToCreateRelations, Character character, HashSet<int> blockCharSet)
	{
		canStartRelationChars.OfflineClear();
		canEndRelationChars.OfflineClear();
		int id = character.GetId();
		short currAge = character.GetCurrAge();
		sbyte ageGroup = AgeGroup.GetAgeGroup(currAge);
		bool flag = GetAliveSpouse(id) >= 0 || !character.GetOrganizationInfo().Principal;
		bool flag2 = character.OrgAndMonkTypeAllowMarriage();
		sbyte behaviorType = character.GetBehaviorType();
		sbyte orgTemplateId = character.GetOrganizationInfo().OrgTemplateId;
		foreach (int item in blockCharSet)
		{
			if (id == item)
			{
				continue;
			}
			if (!TryGetRelation(id, item, out var relation))
			{
				needToCreateRelations.Add(DomainManager.Character.GetElement_Objects(item));
			}
			else
			{
				if (!TryGetRelation(item, id, out var relation2))
				{
					continue;
				}
				Character element_Objects = DomainManager.Character.GetElement_Objects(item);
				sbyte behaviorType2 = element_Objects.GetBehaviorType();
				short currAge2 = element_Objects.GetCurrAge();
				sbyte ageGroup2 = AgeGroup.GetAgeGroup(currAge2);
				if (ageGroup2 == 0 || element_Objects.GetLegendaryBookOwnerState() > 1)
				{
					continue;
				}
				if (AiHelper.Relation.CanStartRelation_Enemy(relation, behaviorType))
				{
					canStartRelationChars.Enemies.Add(item);
				}
				else if (AiHelper.Relation.CanEndRelation_Enemy(relation, behaviorType))
				{
					canEndRelationChars.Enemies.Add(item);
				}
				if (AiHelper.Relation.CanStartRelation_Friend(relation, behaviorType, relation2, behaviorType2))
				{
					canStartRelationChars.Friends.Add(item);
				}
				else if (AiHelper.Relation.CanEndRelation_Friend(relation, behaviorType))
				{
					canEndRelationChars.Friends.Add(item);
				}
				if (AiHelper.Relation.CanStartRelation_SwornBrotherOrSister(relation, behaviorType, relation2, behaviorType2))
				{
					canStartRelationChars.SwornBrothersAndSisters.Add(item);
				}
				else if (AiHelper.Relation.CanEndRelation_SwornBrotherOrSister(relation, behaviorType))
				{
					canEndRelationChars.SwornBrothersAndSisters.Add(item);
				}
				if (AiHelper.Relation.CanStartRelation_AdoptiveParent(id, relation, currAge, item, relation2, currAge2))
				{
					canStartRelationChars.AdoptiveParents.Add(item);
				}
				else if (AiHelper.Relation.CanStartRelation_AdoptiveChild(id, relation, currAge, item, relation2, currAge2))
				{
					canStartRelationChars.AdoptiveChildren.Add(item);
				}
				if (ageGroup != 2 || ageGroup2 != 2)
				{
					continue;
				}
				if (!RelationType.HasRelation(relation.RelationType, 1024))
				{
					if (AiHelper.Relation.CanStartRelation_Adored(relation, behaviorType))
					{
						canStartRelationChars.Adored.Add(item);
					}
					else if (AiHelper.Relation.CanStartRelation_BoyOrGirlFriend(relation, behaviorType, relation2, behaviorType2))
					{
						canStartRelationChars.BoyAndGirlFriends.Add(item);
					}
				}
				if (AiHelper.Relation.CanEndRelation_BoyOrGirlFriend(relation, behaviorType, relation2, behaviorType2))
				{
					canEndRelationChars.BoyAndGirlFriends.Add(item);
					continue;
				}
				if (AiHelper.Relation.CanEndRelation_HusbandOrWife(relation, behaviorType))
				{
					canEndRelationChars.HusbandsAndWives.Add(item);
					continue;
				}
				OrganizationInfo organizationInfo = element_Objects.GetOrganizationInfo();
				switch (organizationInfo.OrgTemplateId)
				{
				case 0:
					if (orgTemplateId != 0)
					{
						continue;
					}
					break;
				case 16:
					if (orgTemplateId != 16)
					{
						continue;
					}
					break;
				default:
					if ((orgTemplateId == 0 || orgTemplateId == 16) ? true : false)
					{
						continue;
					}
					break;
				}
				bool flag3 = GetAliveSpouse(item) >= 0 || !organizationInfo.Principal;
				bool flag4 = element_Objects.OrgAndMonkTypeAllowMarriage();
				if (flag2 && flag4 && !flag && !flag3 && AiHelper.Relation.CanStartRelation_HusbandOrWife(id, relation, behaviorType, item, relation2, behaviorType2))
				{
					canStartRelationChars.HusbandsAndWives.Add(item);
				}
			}
		}
	}

	public HashSet<int> GetRelatedCharIds(int charId, ushort relationType)
	{
		RelatedCharacters value;
		return _relatedCharIds.TryGetValue(charId, out value) ? value.GetCharacterSet(relationType).GetCollection() : EmptyCharacterSet;
	}

	public RelatedCharacters GetRelatedCharacters(int charId)
	{
		RelatedCharacters value;
		return _relatedCharIds.TryGetValue(charId, out value) ? value : null;
	}

	public void GetAllRelatedCharIds(int charId, HashSet<int> relatedCharIds, bool includeGeneral = true)
	{
		if (_relatedCharIds.TryGetValue(charId, out var value))
		{
			value.GetAllRelatedCharIds(relatedCharIds, includeGeneral);
		}
	}

	public void GetAllTwoWayRelatedCharIds(int charId, HashSet<int> relatedCharIds)
	{
		if (_relatedCharIds.TryGetValue(charId, out var value))
		{
			value.GetAllTwoWayRelatedCharIds(relatedCharIds);
		}
	}

	public void GetAllRelatedDeadCharIds(int charId, HashSet<int> relatedCharIds, bool includeGeneral)
	{
		relatedCharIds.Clear();
		GetAllRelatedCharIds(charId, relatedCharIds, includeGeneral);
		relatedCharIds.RemoveWhere(IsCharacterAlive);
	}

	public bool HasEnoughBloodParents(int charId)
	{
		if (!_relatedCharIds.TryGetValue(charId, out var value))
		{
			return false;
		}
		return value.BloodParents.GetCount() >= 2;
	}

	public int GetAliveMentor(int charId)
	{
		if (!_relatedCharIds.TryGetValue(charId, out var value))
		{
			return -1;
		}
		HashSet<int> collection = value.Mentors.GetCollection();
		foreach (int item in collection)
		{
			if (IsCharacterAlive(item))
			{
				return item;
			}
		}
		return -1;
	}

	public int GetAliveParent(int charId)
	{
		if (!_relatedCharIds.TryGetValue(charId, out var value))
		{
			return -1;
		}
		HashSet<int> collection = value.BloodParents.GetCollection();
		foreach (int item in collection)
		{
			if (IsCharacterAlive(item))
			{
				return item;
			}
		}
		HashSet<int> collection2 = value.AdoptiveParents.GetCollection();
		foreach (int item2 in collection2)
		{
			if (IsCharacterAlive(item2))
			{
				return item2;
			}
		}
		HashSet<int> collection3 = value.StepParents.GetCollection();
		foreach (int item3 in collection3)
		{
			if (IsCharacterAlive(item3))
			{
				return item3;
			}
		}
		return -1;
	}

	public int GetAliveChild(int charId)
	{
		if (!_relatedCharIds.TryGetValue(charId, out var value))
		{
			return -1;
		}
		HashSet<int> collection = value.BloodChildren.GetCollection();
		foreach (int item in collection)
		{
			if (IsCharacterAlive(item))
			{
				return item;
			}
		}
		HashSet<int> collection2 = value.AdoptiveChildren.GetCollection();
		foreach (int item2 in collection2)
		{
			if (IsCharacterAlive(item2))
			{
				return item2;
			}
		}
		HashSet<int> collection3 = value.StepChildren.GetCollection();
		foreach (int item3 in collection3)
		{
			if (IsCharacterAlive(item3))
			{
				return item3;
			}
		}
		return -1;
	}

	public int GetAliveSpouse(int charId)
	{
		if (!_relatedCharIds.TryGetValue(charId, out var value))
		{
			return -1;
		}
		HashSet<int> collection = value.HusbandsAndWives.GetCollection();
		foreach (int item in collection)
		{
			if (IsCharacterAlive(item))
			{
				return item;
			}
		}
		return -1;
	}

	public int GetLastSpouse(int charId)
	{
		if (!_relatedCharIds.TryGetValue(charId, out var value))
		{
			return -1;
		}
		HashSet<int> collection = value.HusbandsAndWives.GetCollection();
		foreach (int item in collection)
		{
			if (IsCharacterAlive(item))
			{
				return item;
			}
		}
		int num = int.MinValue;
		int result = -1;
		foreach (int item2 in collection)
		{
			if (!TryGetElement_DeadCharacters(item2, out var value2))
			{
				return item2;
			}
			if (value2.DeathDate > num)
			{
				num = value2.DeathDate;
				result = item2;
			}
		}
		return result;
	}

	[DomainMethod]
	public RelatedCharactersForRelations GetRelatedCharactersForRelations(int charId)
	{
		if (DomainManager.Character.TryGetElement_Objects(charId, out var element) && element.GetSrcCharId() >= 0)
		{
			charId = element.GetSrcCharId();
		}
		if (!_relatedCharIds.TryGetValue(charId, out var value))
		{
			return new RelatedCharactersForRelations();
		}
		RelatedCharactersForRelations relatedCharactersForRelations = new RelatedCharactersForRelations(value);
		relatedCharactersForRelations.RelatedAdored = GetReversedRelatedCharIds(charId, 16384);
		relatedCharactersForRelations.RelatedEnemies = GetReversedRelatedCharIds(charId, 32768);
		if (element != null && element.GetFactionId() >= 0)
		{
			relatedCharactersForRelations.FactionMembers.AddRange(DomainManager.Organization.GetElement_Factions(relatedCharactersForRelations.FactionLeaderId = element.GetFactionId()).GetCollection());
		}
		else
		{
			relatedCharactersForRelations.FactionLeaderId = -1;
		}
		return relatedCharactersForRelations;
	}

	[DomainMethod]
	public void TryCreateRelation(DataContext context, int charId, int relatedCharId)
	{
		if (charId == relatedCharId)
		{
			throw new Exception($"Cannot create relationship with oneself: {relatedCharId}");
		}
		if (!_relations.ContainsKey(new RelationKey(charId, relatedCharId)))
		{
			Character character = _objects[charId];
			Character character2 = _objects[relatedCharId];
			if (character.GetCreatingType() != 1 || character2.GetCreatingType() != 1)
			{
				throw new Exception($"Both sides must be intelligent characters: {charId}, {relatedCharId}");
			}
			var (initialFavorability, initialFavorability2) = CalcInitialFavorabilitiesOfAliveChars(context.Random, character, character2);
			CreateRelation(context, charId, relatedCharId, 0, initialFavorability);
			CreateRelation(context, relatedCharId, charId, 0, initialFavorability2);
			if (charId == DomainManager.Taiwu.GetTaiwuCharId() || relatedCharId == DomainManager.Taiwu.GetTaiwuCharId())
			{
				DomainManager.Taiwu.AddLegacyPoint(context, 0);
			}
		}
	}

	[DomainMethod]
	public void TryAddAndApplyOneWayRelation(DataContext context, int charId, int relatedCharId, ushort relationType)
	{
		if (!RelationType.IsOneWayRelation(relationType))
		{
			throw new Exception("Cannot add two way relation directly.");
		}
		if (HasRelation(charId, relatedCharId, relationType))
		{
			return;
		}
		int currDate = DomainManager.World.GetCurrDate();
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		Location validLocation = GetElement_Objects(charId).GetValidLocation();
		Location validLocation2 = GetElement_Objects(relatedCharId).GetValidLocation();
		DomainManager.Character.AddRelation(context, charId, relatedCharId, relationType, currDate);
		switch (relationType)
		{
		case 16384:
			DomainManager.LifeRecord.GetLifeRecordCollection().AddAdore(charId, currDate, relatedCharId, validLocation);
			if (DomainManager.Character.HasRelation(relatedCharId, charId, relationType))
			{
				Character element_Objects = GetElement_Objects(charId);
				Character element_Objects2 = GetElement_Objects(relatedCharId);
				DomainManager.Character.ChangeFavorabilityOptional(context, element_Objects, element_Objects2, 3000, 3);
				DomainManager.Character.ChangeFavorabilityOptional(context, element_Objects2, element_Objects, 3000, 3);
				element_Objects.ChangeHappiness(context, AiHelper.RelationsRelatedConstants.ConfessLoveSucceedHappinessChange[element_Objects.GetBehaviorType()]);
				SecretInformationCollection secretInformationCollection2 = DomainManager.Information.GetSecretInformationCollection();
				int dataOffset2 = secretInformationCollection2.AddBecomeLover(charId, relatedCharId);
				int metaDataId2 = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset2);
				if (IsTaiwuPeople(charId))
				{
					DomainManager.Information.ReceiveSecretInformation(context, metaDataId2, taiwuCharId, charId);
				}
			}
			break;
		case 32768:
		{
			DomainManager.LifeRecord.GetLifeRecordCollection().AddMakeEnemy(charId, currDate, relatedCharId, validLocation);
			SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
			int dataOffset = secretInformationCollection.AddBecomeEnemy(charId, relatedCharId);
			int metaDataId = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
			if (IsTaiwuPeople(charId))
			{
				DomainManager.Information.ReceiveSecretInformation(context, metaDataId, taiwuCharId, charId);
			}
			break;
		}
		}
		if (charId == taiwuCharId && validLocation2 != Location.Invalid)
		{
			MapBlockData block = DomainManager.Map.GetBlock(validLocation2);
			DomainManager.Map.SetBlockData(context, block);
		}
		else if (relatedCharId == taiwuCharId && validLocation != Location.Invalid)
		{
			MapBlockData block2 = DomainManager.Map.GetBlock(validLocation);
			DomainManager.Map.SetBlockData(context, block2);
		}
	}

	[DomainMethod]
	public void TryRemoveOneWayRelation(DataContext context, int charId, int relatedCharId, ushort relationType)
	{
		if (!RelationType.IsOneWayRelation(relationType))
		{
			throw new Exception("Cannot remove two way relation directly.");
		}
		if (!HasRelation(charId, relatedCharId, relationType))
		{
			return;
		}
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		Location validLocation = GetElement_Objects(charId).GetValidLocation();
		Location validLocation2 = GetElement_Objects(relatedCharId).GetValidLocation();
		switch (relationType)
		{
		case 16384:
			if (DomainManager.Character.HasRelation(relatedCharId, charId, relationType))
			{
				Character element_Objects = GetElement_Objects(charId);
				Character element_Objects2 = GetElement_Objects(relatedCharId);
				Character.ApplyBreakupWithBoyOrGirlFriend(context, element_Objects, element_Objects2, element_Objects.GetBehaviorType(), context.Random.CheckPercentProb(AiHelper.RelationsRelatedConstants.BreakupMutuallyChance[element_Objects2.GetBehaviorType()]), IsTaiwuPeople(charId), IsTaiwuPeople(relatedCharId));
			}
			else
			{
				DomainManager.Character.ChangeRelationType(context, charId, relatedCharId, relationType, 0);
			}
			break;
		case 32768:
		{
			int currDate = DomainManager.World.GetCurrDate();
			DomainManager.Character.ChangeRelationType(context, charId, relatedCharId, relationType, 0);
			DomainManager.LifeRecord.GetLifeRecordCollection().AddSeverEnemy(charId, currDate, relatedCharId, validLocation);
			SecretInformationCollection secretInformationCollection = DomainManager.Information.GetSecretInformationCollection();
			int dataOffset = secretInformationCollection.AddSeverEnemy(charId, relatedCharId);
			int metaDataId = DomainManager.Information.AddSecretInformationMetaData(context, dataOffset);
			if (IsTaiwuPeople(charId))
			{
				DomainManager.Information.ReceiveSecretInformation(context, metaDataId, taiwuCharId, charId);
			}
			break;
		}
		}
		if (charId == taiwuCharId && validLocation2 != Location.Invalid)
		{
			MapBlockData block = DomainManager.Map.GetBlock(validLocation2);
			DomainManager.Map.SetBlockData(context, block);
		}
		else if (relatedCharId == taiwuCharId && validLocation != Location.Invalid)
		{
			MapBlockData block2 = DomainManager.Map.GetBlock(validLocation);
			DomainManager.Map.SetBlockData(context, block2);
		}
	}

	public void TryCreateGeneralRelation(DataContext context, Character selfChar, Character relatedChar)
	{
		int id = selfChar.GetId();
		int id2 = relatedChar.GetId();
		if (!_relations.ContainsKey(new RelationKey(id, id2)))
		{
			if (selfChar.GetCreatingType() != 1 || relatedChar.GetCreatingType() != 1)
			{
				throw new Exception($"Both sides must be intelligent characters: {id}, {id2}");
			}
			var (initialFavorability, initialFavorability2) = CalcInitialFavorabilitiesOfAliveChars(context.Random, selfChar, relatedChar);
			CreateRelation(context, id, id2, 0, initialFavorability);
			CreateRelation(context, id2, id, 0, initialFavorability2);
		}
	}

	public void AddBloodParentRelations(DataContext context, int charId, int bloodParentCharId, int establishmentDate = int.MinValue)
	{
		AddRelation(context, charId, bloodParentCharId, 1, establishmentDate);
		HashSet<int> relatedCharIds = GetRelatedCharIds(bloodParentCharId, 2);
		foreach (int item in relatedCharIds)
		{
			if (item != charId)
			{
				AddRelation(context, charId, item, 4, establishmentDate);
			}
		}
		HashSet<int> relatedCharIds2 = GetRelatedCharIds(bloodParentCharId, 16);
		foreach (int item2 in relatedCharIds2)
		{
			AddRelation(context, charId, item2, 32, establishmentDate);
		}
		HashSet<int> relatedCharIds3 = GetRelatedCharIds(bloodParentCharId, 128);
		foreach (int item3 in relatedCharIds3)
		{
			AddRelation(context, charId, item3, 256, establishmentDate);
		}
	}

	public void AddStepParentRelations(DataContext context, int charId, int stepParentCharId, int establishmentDate = int.MinValue)
	{
		AddRelation(context, charId, stepParentCharId, 8, establishmentDate);
		HashSet<int> relatedCharIds = GetRelatedCharIds(stepParentCharId, 2);
		foreach (int item in relatedCharIds)
		{
			AddRelation(context, charId, item, 32, establishmentDate);
		}
		HashSet<int> relatedCharIds2 = GetRelatedCharIds(stepParentCharId, 16);
		foreach (int item2 in relatedCharIds2)
		{
			if (item2 != charId)
			{
				AddRelation(context, charId, item2, 32, establishmentDate);
			}
		}
		HashSet<int> relatedCharIds3 = GetRelatedCharIds(stepParentCharId, 128);
		foreach (int item3 in relatedCharIds3)
		{
			AddRelation(context, charId, item3, 256, establishmentDate);
		}
	}

	public void AddAdoptiveParentRelations(DataContext context, int charId, int adoptiveParentCharId, int establishmentDate = int.MinValue)
	{
		AddRelation(context, charId, adoptiveParentCharId, 64, establishmentDate);
		HashSet<int> relatedCharIds = GetRelatedCharIds(adoptiveParentCharId, 2);
		foreach (int item in relatedCharIds)
		{
			AddRelation(context, charId, item, 256, establishmentDate);
		}
		HashSet<int> relatedCharIds2 = GetRelatedCharIds(adoptiveParentCharId, 16);
		foreach (int item2 in relatedCharIds2)
		{
			AddRelation(context, charId, item2, 256, establishmentDate);
		}
		HashSet<int> relatedCharIds3 = GetRelatedCharIds(adoptiveParentCharId, 128);
		foreach (int item3 in relatedCharIds3)
		{
			if (item3 != charId)
			{
				AddRelation(context, charId, item3, 256, establishmentDate);
			}
		}
	}

	public void AddHusbandOrWifeRelations(DataContext context, int charId, int spouseCharId, int establishmentDate = int.MinValue)
	{
		AddRelation(context, charId, spouseCharId, 1024, establishmentDate);
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		list.Clear();
		list.AddRange(GetRelatedCharIds(charId, 2));
		List<int> list2 = ObjectPool<List<int>>.Instance.Get();
		list2.Clear();
		list2.AddRange(GetRelatedCharIds(spouseCharId, 2));
		List<int> list3 = ObjectPool<List<int>>.Instance.Get();
		list3.Clear();
		list3.AddRange(GetRelatedCharIds(charId, 16));
		List<int> list4 = ObjectPool<List<int>>.Instance.Get();
		list4.Clear();
		list4.AddRange(GetRelatedCharIds(spouseCharId, 16));
		List<int> list5 = ObjectPool<List<int>>.Instance.Get();
		list5.Clear();
		list5.AddRange(GetRelatedCharIds(charId, 128));
		List<int> list6 = ObjectPool<List<int>>.Instance.Get();
		list6.Clear();
		list6.AddRange(GetRelatedCharIds(spouseCharId, 128));
		int i = 0;
		for (int count = list.Count; i < count; i++)
		{
			if (list[i] != spouseCharId)
			{
				AddRelation(context, list[i], spouseCharId, 8, establishmentDate);
			}
		}
		int j = 0;
		for (int count2 = list2.Count; j < count2; j++)
		{
			if (list2[j] != charId)
			{
				AddRelation(context, list2[j], charId, 8, establishmentDate);
			}
		}
		int k = 0;
		for (int count3 = list3.Count; k < count3; k++)
		{
			if (list3[k] != spouseCharId)
			{
				AddRelation(context, list3[k], spouseCharId, 8, establishmentDate);
			}
		}
		int l = 0;
		for (int count4 = list4.Count; l < count4; l++)
		{
			if (list4[l] != charId)
			{
				AddRelation(context, list4[l], charId, 8, establishmentDate);
			}
		}
		int m = 0;
		for (int count5 = list5.Count; m < count5; m++)
		{
			if (list5[m] != spouseCharId)
			{
				AddRelation(context, list5[m], spouseCharId, 64, establishmentDate);
			}
		}
		int n = 0;
		for (int count6 = list6.Count; n < count6; n++)
		{
			if (list6[n] != charId)
			{
				AddRelation(context, list6[n], charId, 64, establishmentDate);
			}
		}
		int num = 0;
		for (int count7 = list.Count; num < count7; num++)
		{
			int num2 = list[num];
			int num3 = 0;
			for (int count8 = list2.Count; num3 < count8; num3++)
			{
				if (num2 != list2[num3])
				{
					AddRelation(context, num2, list2[num3], 32, establishmentDate);
				}
			}
			int num4 = 0;
			for (int count9 = list4.Count; num4 < count9; num4++)
			{
				if (num2 != list4[num4])
				{
					AddRelation(context, num2, list4[num4], 32, establishmentDate);
				}
			}
			int num5 = 0;
			for (int count10 = list6.Count; num5 < count10; num5++)
			{
				if (num2 != list6[num5])
				{
					AddRelation(context, num2, list6[num5], 256, establishmentDate);
				}
			}
		}
		int num6 = 0;
		for (int count11 = list3.Count; num6 < count11; num6++)
		{
			int num7 = list3[num6];
			int num8 = 0;
			for (int count12 = list2.Count; num8 < count12; num8++)
			{
				if (num7 != list2[num8])
				{
					AddRelation(context, num7, list2[num8], 32, establishmentDate);
				}
			}
			int num9 = 0;
			for (int count13 = list4.Count; num9 < count13; num9++)
			{
				if (num7 != list4[num9])
				{
					AddRelation(context, num7, list4[num9], 32, establishmentDate);
				}
			}
			int num10 = 0;
			for (int count14 = list6.Count; num10 < count14; num10++)
			{
				if (num7 != list6[num10])
				{
					AddRelation(context, num7, list6[num10], 256, establishmentDate);
				}
			}
		}
		int num11 = 0;
		for (int count15 = list5.Count; num11 < count15; num11++)
		{
			int num12 = list5[num11];
			int num13 = 0;
			for (int count16 = list2.Count; num13 < count16; num13++)
			{
				if (num12 != list2[num13])
				{
					AddRelation(context, num12, list2[num13], 256, establishmentDate);
				}
			}
			int num14 = 0;
			for (int count17 = list4.Count; num14 < count17; num14++)
			{
				if (num12 != list4[num14])
				{
					AddRelation(context, num12, list4[num14], 256, establishmentDate);
				}
			}
			int num15 = 0;
			for (int count18 = list6.Count; num15 < count18; num15++)
			{
				if (num12 != list6[num15])
				{
					AddRelation(context, num12, list6[num15], 256, establishmentDate);
				}
			}
		}
		ObjectPool<List<int>>.Instance.Return(list);
		ObjectPool<List<int>>.Instance.Return(list2);
		ObjectPool<List<int>>.Instance.Return(list3);
		ObjectPool<List<int>>.Instance.Return(list4);
		ObjectPool<List<int>>.Instance.Return(list5);
		ObjectPool<List<int>>.Instance.Return(list6);
	}

	public void AddRelation(DataContext context, int charId, int relatedCharId, ushort addingType, int establishmentDate = int.MinValue)
	{
		if (charId == relatedCharId)
		{
			throw new Exception($"Cannot create relationship with oneself: {charId}");
		}
		AddRelationInternal(context, charId, relatedCharId, addingType, establishmentDate);
		ushort oppositeRelationType = RelationType.GetOppositeRelationType(addingType);
		AddRelationInternal(context, relatedCharId, charId, oppositeRelationType, establishmentDate);
	}

	public void ChangeRelationType(DataContext context, int charId, int relatedCharId, ushort removingType, ushort addingType)
	{
		RelationKey relationKey = new RelationKey(charId, relatedCharId);
		RelatedCharacter value = _relations[relationKey];
		ushort relationType = RelatedCharIds_ChangeRelation(charId, relatedCharId, value.RelationType, removingType, addingType);
		DomainManager.Extra.AddRemovedSpecialRelations(context, relationKey, removingType);
		Events.RaiseRelationAdded(context, charId, relatedCharId, relationType);
		value.RelationType = relationType;
		SetElement_Relations(relationKey, value, context);
	}

	public void RemoveRelation(DataContext context, int charId, int relatedCharId)
	{
		RelationKey relationKey = new RelationKey(charId, relatedCharId);
		if (_relations.TryGetValue(relationKey, out var value))
		{
			RelatedCharIds_RemoveRelations(charId, relatedCharId, value.RelationType);
			DomainManager.Extra.ClearRemovedSpecialRelations(context, relationKey);
			RemoveElement_Relations(relationKey, context);
		}
	}

	public void RemoveAllGeneralRelations(DataContext context, int charId)
	{
		if (!_relatedCharIds.TryGetValue(charId, out var value))
		{
			return;
		}
		CharacterSet general = value.General;
		foreach (int item in general.GetCollection())
		{
			RelationKey relationKey = new RelationKey(charId, item);
			RemoveElement_Relations(relationKey, context);
			DomainManager.Extra.ClearRemovedSpecialRelations(context, relationKey);
			RelationKey relationKey2 = new RelationKey(item, charId);
			if (_relations.TryGetValue(relationKey2, out var value2) && value2.RelationType == 0)
			{
				RemoveElement_Relations(relationKey2, context);
				DomainManager.Extra.ClearRemovedSpecialRelations(context, relationKey2);
				RelatedCharIds_RemoveRelations(item, charId, 0);
			}
		}
		general.Clear();
	}

	public void RemoveAllRelations(DataContext context, int charId, bool removeRelatedRelations)
	{
		if (!_relatedCharIds.TryGetValue(charId, out var value))
		{
			return;
		}
		_relatedCharIds.Remove(charId);
		HashSet<int> hashSet = new HashSet<int>();
		value.GetAllRelatedCharIds(hashSet);
		value.OfflineClear();
		foreach (int item in hashSet)
		{
			RelationKey relationKey = new RelationKey(charId, item);
			RemoveElement_Relations(relationKey, context);
			DomainManager.Extra.ClearRemovedSpecialRelations(context, relationKey);
		}
		if (!removeRelatedRelations)
		{
			return;
		}
		foreach (int item2 in hashSet)
		{
			RemoveRelation(context, item2, charId);
		}
	}

	public bool HasTwoWayRelation(int charId, ushort relationType)
	{
		Tester.Assert(RelationType.IsOneWayRelation(relationType));
		HashSet<int> relatedCharIds = GetRelatedCharIds(charId, relationType);
		if (relatedCharIds.Count <= 0)
		{
			return false;
		}
		foreach (int item in relatedCharIds)
		{
			HashSet<int> relatedCharIds2 = GetRelatedCharIds(item, relationType);
			if (relatedCharIds2.Contains(charId))
			{
				return true;
			}
		}
		return false;
	}

	public bool HasEnemyRelationWithFamily(int charId, int relatedCharId)
	{
		HashSet<int> relatedCharIds = GetRelatedCharIds(charId, 32768);
		if (relatedCharIds.Contains(relatedCharId))
		{
			return true;
		}
		foreach (int item in relatedCharIds)
		{
			if (!TryGetRelation(item, relatedCharId, out var relation) || !RelationType.ContainBloodRelatedRelations(relation.RelationType))
			{
				continue;
			}
			return true;
		}
		return false;
	}

	public bool IsInsect(int charId, int relatedCharId)
	{
		sbyte insectDetectionGenerationCount = GlobalConfig.Instance.InsectDetectionGenerationCount;
		HashSet<int> hashSet = ObjectPool<HashSet<int>>.Instance.Get();
		hashSet.Clear();
		GetAncestors(charId, hashSet, insectDetectionGenerationCount);
		HashSet<int> hashSet2 = ObjectPool<HashSet<int>>.Instance.Get();
		hashSet2.Clear();
		GetAncestors(relatedCharId, hashSet2, insectDetectionGenerationCount);
		bool result = hashSet.Overlaps(hashSet2);
		ObjectPool<HashSet<int>>.Instance.Return(hashSet);
		ObjectPool<HashSet<int>>.Instance.Return(hashSet2);
		return result;
	}

	public unsafe void GetAncestors(int charId, HashSet<int> ancestors, int recursionCount)
	{
		ancestors.Add(charId);
		if (recursionCount <= 0)
		{
			return;
		}
		int* ptr = stackalloc int[2];
		RelatedCharacters relatedCharacters = GetRelatedCharacters(charId);
		GetActualBloodParents(charId, relatedCharacters, ptr);
		for (int i = 0; i < 2; i++)
		{
			int num = ptr[i];
			if (num >= 0)
			{
				GetAncestors(num, ancestors, recursionCount - 1);
			}
		}
	}

	public bool HasNominalBloodRelation(int charId, int relatedCharId, RelatedCharacter relation)
	{
		if (relation.RelationType != ushort.MaxValue && RelationType.ContainDirectBloodRelations(relation.RelationType))
		{
			return true;
		}
		if (_relatedCharIds.TryGetValue(charId, out var value))
		{
			if (HasNominalDirectBloodRelation(value.BloodParents, relatedCharId, exceptBloodParent: false))
			{
				return true;
			}
			if (HasNominalDirectBloodRelation(value.BloodBrothersAndSisters, relatedCharId, exceptBloodParent: false))
			{
				return true;
			}
			if (HasNominalDirectBloodRelation(value.BloodChildren, relatedCharId, exceptBloodParent: true))
			{
				return true;
			}
		}
		return false;
	}

	public bool HasActualBloodRelation(int charId, int relatedCharId)
	{
		HashSet<int> hashSet = new HashSet<int>();
		if (HasActualDirectBloodRelation(charId, relatedCharId, exceptBloodParent: false, hashSet))
		{
			return true;
		}
		RelatedCharacters relatedCharacters = GetRelatedCharacters(charId);
		foreach (int item in hashSet)
		{
			bool exceptBloodParent = IsActualBloodChildren(charId, relatedCharacters, item);
			if (HasActualDirectBloodRelation(item, relatedCharId, exceptBloodParent))
			{
				return true;
			}
		}
		return false;
	}

	public bool IsTaiwuPeople(int charId)
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		RelatedCharacter relation;
		RelatedCharacter relation2;
		return charId == taiwuCharId || DomainManager.Taiwu.IsInGroup(charId) || (TryGetRelation(taiwuCharId, charId, out relation) && relation.RelationType != 0 && TryGetRelation(taiwuCharId, charId, out relation2) && relation2.RelationType != 0);
	}

	public bool IsTaiwuPeople(int charId, ushort relationToTaiwu, ushort taiwuRelationToSelf)
	{
		return charId == DomainManager.Taiwu.GetTaiwuCharId() || DomainManager.Taiwu.IsInGroup(charId) || (relationToTaiwu != 0 && taiwuRelationToSelf != 0);
	}

	public unsafe bool IsClosePeople(IRandomSource random, Character selfChar, Character targetChar)
	{
		if (selfChar.GetId() == targetChar.GetId())
		{
			return true;
		}
		if (selfChar.GetLeaderId() >= 0 && selfChar.GetLeaderId() == targetChar.GetLeaderId())
		{
			return true;
		}
		Personalities personalities = targetChar.GetPersonalities();
		Location location = selfChar.GetLocation();
		Location location2 = targetChar.GetLocation();
		if (location.IsValid() && location2.IsValid())
		{
			if (location.Equals(location2))
			{
				return random.CheckPercentProb(30 + personalities.Items[2]);
			}
			MapBlockData block = DomainManager.Map.GetBlock(location);
			MapBlockData block2 = DomainManager.Map.GetBlock(location2);
			if (block.GetBlockPos().GetManhattanDistance(block2.GetBlockPos()) < 1)
			{
				random.CheckPercentProb(15 + personalities.Items[2] / 2);
			}
		}
		return false;
	}

	public unsafe bool IsSameBlockPeople(IRandomSource random, Character selfChar, Character targetChar)
	{
		if (selfChar.GetId() == targetChar.GetId())
		{
			return true;
		}
		if (selfChar.GetLeaderId() >= 0 && selfChar.GetLeaderId() == targetChar.GetLeaderId())
		{
			return true;
		}
		Personalities personalities = targetChar.GetPersonalities();
		if (selfChar.GetLocation().IsValid() && selfChar.GetLocation().Equals(targetChar.GetLocation()))
		{
			return random.CheckPercentProb(30 + personalities.Items[2]);
		}
		return false;
	}

	public void GetTaiwuPeople(HashSet<int> targetCharIds)
	{
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		targetCharIds.Clear();
		GetAllTwoWayRelatedCharIds(taiwuCharId, targetCharIds);
		targetCharIds.RemoveWhere((int charId) => !_objects.ContainsKey(charId));
		foreach (int item in DomainManager.Taiwu.GetGroupCharIds().GetCollection())
		{
			targetCharIds.Add(item);
			if (!_kidnappedChars.TryGetValue(item, out var value))
			{
				continue;
			}
			List<KidnappedCharacter> collection = value.GetCollection();
			foreach (KidnappedCharacter item2 in collection)
			{
				targetCharIds.Add(item2.CharId);
			}
		}
		targetCharIds.UnionWith(DomainManager.Taiwu.GetGroupCharIds().GetCollection());
	}

	public unsafe void GetSameBlockPeople(IRandomSource random, Character selfChar, HashSet<int> targetCharIds, sbyte factor = 100)
	{
		targetCharIds.Clear();
		int id = selfChar.GetId();
		targetCharIds.Add(id);
		int leaderId = selfChar.GetLeaderId();
		if (leaderId >= 0)
		{
			foreach (int item in (DomainManager.Taiwu.IsInGroup(id) ? DomainManager.Taiwu.GetGroupCharIds() : _characterGroups[leaderId]).GetCollection())
			{
				targetCharIds.Add(item);
				if (!_kidnappedChars.TryGetValue(item, out var value))
				{
					continue;
				}
				List<KidnappedCharacter> collection = value.GetCollection();
				foreach (KidnappedCharacter item2 in collection)
				{
					targetCharIds.Add(item2.CharId);
				}
			}
		}
		else if (selfChar.IsActiveExternalRelationState(2))
		{
			List<KidnappedCharacter> collection2 = _kidnappedChars[id].GetCollection();
			foreach (KidnappedCharacter item3 in collection2)
			{
				targetCharIds.Add(item3.CharId);
			}
		}
		Location location = selfChar.GetLocation();
		if (!location.IsValid())
		{
			location = selfChar.GetValidLocation();
		}
		MapBlockData block = DomainManager.Map.GetBlock(location);
		if (block.CharacterSet != null)
		{
			foreach (int item4 in block.CharacterSet)
			{
				if (!_objects.TryGetValue(item4, out var value2))
				{
					throw new Exception($"Trying to get {id}'s same/neighbor block people {item4} who is not alive at {location}.");
				}
				Personalities personalities = value2.GetPersonalities();
				if (random.CheckPercentProb((30 + personalities.Items[2]) * factor / 100))
				{
					targetCharIds.Add(item4);
				}
			}
		}
		if (!DomainManager.Taiwu.GetTaiwu().GetLocation().Equals(location))
		{
			return;
		}
		HashSet<int> collection3 = DomainManager.Taiwu.GetGroupCharIds().GetCollection();
		foreach (int item5 in collection3)
		{
			if (!_objects.TryGetValue(item5, out var value3))
			{
				throw new Exception($"Trying to get {id}'s same/neighbor block people {item5} who is not alive at {location}.");
			}
			Personalities personalities2 = value3.GetPersonalities();
			if (random.CheckPercentProb(30 + personalities2.Items[2]))
			{
				targetCharIds.Add(item5);
			}
		}
	}

	public unsafe void GetClosePeople(IRandomSource random, Character selfChar, HashSet<int> targetCharIds, sbyte factor = 100)
	{
		targetCharIds.Clear();
		int id = selfChar.GetId();
		targetCharIds.Add(id);
		int leaderId = selfChar.GetLeaderId();
		if (leaderId >= 0)
		{
			foreach (int item in (DomainManager.Taiwu.IsInGroup(id) ? DomainManager.Taiwu.GetGroupCharIds() : _characterGroups[leaderId]).GetCollection())
			{
				targetCharIds.Add(item);
				if (!_kidnappedChars.TryGetValue(item, out var value))
				{
					continue;
				}
				List<KidnappedCharacter> collection = value.GetCollection();
				foreach (KidnappedCharacter item2 in collection)
				{
					targetCharIds.Add(item2.CharId);
				}
			}
		}
		else if (selfChar.IsActiveExternalRelationState(2))
		{
			List<KidnappedCharacter> collection2 = _kidnappedChars[id].GetCollection();
			foreach (KidnappedCharacter item3 in collection2)
			{
				targetCharIds.Add(item3.CharId);
			}
		}
		Location location = selfChar.GetLocation();
		if (!location.IsValid())
		{
			location = selfChar.GetValidLocation();
		}
		MapBlockData block = DomainManager.Map.GetBlock(location);
		if (block.CharacterSet != null)
		{
			foreach (int item4 in block.CharacterSet)
			{
				if (item4 != id)
				{
					if (!_objects.TryGetValue(item4, out var value2))
					{
						throw new Exception($"Trying to get {id}'s same/neighbor block people {item4} who is not alive at {location}.");
					}
					Personalities personalities = value2.GetPersonalities();
					if (random.CheckPercentProb((30 + personalities.Items[2]) * factor / 100))
					{
						targetCharIds.Add(item4);
					}
				}
			}
		}
		Character taiwu = DomainManager.Taiwu.GetTaiwu();
		if (taiwu.GetLocation().Equals(location))
		{
			foreach (int item5 in DomainManager.Taiwu.GetGroupCharIds().GetCollection())
			{
				if (item5 != id)
				{
					if (!_objects.TryGetValue(item5, out var value3))
					{
						throw new Exception($"Trying to get {id}'s same/neighbor block people {item5} who is not alive at {location}.");
					}
					Personalities personalities2 = value3.GetPersonalities();
					if (random.CheckPercentProb((30 + personalities2.Items[2]) * factor / 100))
					{
						targetCharIds.Add(item5);
					}
				}
			}
		}
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		DomainManager.Map.GetRealNeighborBlocks(location.AreaId, location.BlockId, list);
		foreach (MapBlockData item6 in list)
		{
			if (item6.CharacterSet == null)
			{
				continue;
			}
			foreach (int item7 in item6.CharacterSet)
			{
				if (!_objects.TryGetValue(item7, out var value4))
				{
					throw new Exception($"Trying to get {id}'s same/neighbor block people {item7} who is not alive at {item6.GetLocation()}.");
				}
				Personalities personalities3 = value4.GetPersonalities();
				if (random.CheckPercentProb((15 + personalities3.Items[2] / 2) * factor / 100))
				{
					targetCharIds.Add(item7);
				}
			}
			if (!taiwu.GetLocation().Equals(new Location(item6.AreaId, item6.BlockId)))
			{
				continue;
			}
			foreach (int item8 in DomainManager.Taiwu.GetGroupCharIds().GetCollection())
			{
				if (!_objects.TryGetValue(item8, out var value5))
				{
					throw new Exception($"Trying to get {id}'s same/neighbor block people {item8} who is not alive at {item6.GetLocation()}.");
				}
				Personalities personalities4 = value5.GetPersonalities();
				if (random.CheckPercentProb(15 + personalities4.Items[2] / 2))
				{
					targetCharIds.Add(item8);
				}
			}
		}
	}

	public unsafe void GetAreaPeople(IRandomSource random, Character selfChar, HashSet<int> targetCharIds, sbyte factor = 100)
	{
		Location location = selfChar.GetLocation();
		if (!location.IsValid())
		{
			location = selfChar.GetValidLocation();
		}
		int id = selfChar.GetId();
		targetCharIds.Add(id);
		int leaderId = selfChar.GetLeaderId();
		if (leaderId >= 0)
		{
			foreach (int item in (DomainManager.Taiwu.IsInGroup(id) ? DomainManager.Taiwu.GetGroupCharIds() : _characterGroups[leaderId]).GetCollection())
			{
				targetCharIds.Add(item);
				if (!_kidnappedChars.TryGetValue(item, out var value))
				{
					continue;
				}
				List<KidnappedCharacter> collection = value.GetCollection();
				foreach (KidnappedCharacter item2 in collection)
				{
					targetCharIds.Add(item2.CharId);
				}
			}
		}
		else if (selfChar.IsActiveExternalRelationState(2))
		{
			List<KidnappedCharacter> collection2 = _kidnappedChars[id].GetCollection();
			foreach (KidnappedCharacter item3 in collection2)
			{
				targetCharIds.Add(item3.CharId);
			}
		}
		MapBlockData block = DomainManager.Map.GetBlock(location);
		if (block.CharacterSet != null)
		{
			foreach (int item4 in block.CharacterSet)
			{
				if (!_objects.TryGetValue(item4, out var value2))
				{
					throw new Exception($"Trying to get {id}'s same/neighbor block people {item4} who is not alive at {location}.");
				}
				Personalities personalities = value2.GetPersonalities();
				if (random.CheckPercentProb((60 + personalities.Items[2] * 2) * factor / 100))
				{
					targetCharIds.Add(item4);
				}
			}
		}
		Location location2 = DomainManager.Taiwu.GetTaiwu().GetLocation();
		if (location2.Equals(location))
		{
			HashSet<int> collection3 = DomainManager.Taiwu.GetGroupCharIds().GetCollection();
			foreach (int item5 in collection3)
			{
				if (!_objects.TryGetValue(item5, out var value3))
				{
					throw new Exception($"Trying to get {id}'s same/neighbor block people {item5} who is not alive at {location}.");
				}
				Personalities personalities2 = value3.GetPersonalities();
				if (random.CheckPercentProb(60 + personalities2.Items[2] * 2))
				{
					targetCharIds.Add(item5);
				}
			}
		}
		List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
		DomainManager.Map.GetRealNeighborBlocks(location.AreaId, location.BlockId, list);
		foreach (MapBlockData item6 in list)
		{
			if (item6.CharacterSet == null)
			{
				continue;
			}
			foreach (int item7 in item6.CharacterSet)
			{
				if (!_objects.TryGetValue(item7, out var value4))
				{
					throw new Exception($"Trying to get {id}'s neighbor block people {item7} who is not alive at {item6.GetLocation()}.");
				}
				Personalities personalities3 = value4.GetPersonalities();
				if (random.CheckPercentProb((30 + personalities3.Items[2]) * factor / 100))
				{
					targetCharIds.Add(item7);
				}
			}
			if (!location2.Equals(new Location(item6.AreaId, item6.BlockId)))
			{
				continue;
			}
			foreach (int item8 in DomainManager.Taiwu.GetGroupCharIds().GetCollection())
			{
				if (!_objects.TryGetValue(item8, out var value5))
				{
					throw new Exception($"Trying to get {id}'s same/neighbor block people {item8} who is not alive at {item6.GetLocation()}.");
				}
				Personalities personalities4 = value5.GetPersonalities();
				if (random.CheckPercentProb(30 + personalities4.Items[2]))
				{
					targetCharIds.Add(item8);
				}
			}
		}
		Span<MapBlockData> areaBlocks = DomainManager.Map.GetAreaBlocks(location.AreaId);
		int i = 0;
		for (int length = areaBlocks.Length; i < length; i++)
		{
			HashSet<int> characterSet = areaBlocks[i].CharacterSet;
			if (characterSet == null)
			{
				continue;
			}
			foreach (int item9 in characterSet)
			{
				if (!_objects.TryGetValue(item9, out var value6))
				{
					throw new Exception($"Trying to get {id}'s same/neighbor block people {item9} who is not alive at {areaBlocks[i].GetLocation()}.");
				}
				Personalities personalities5 = value6.GetPersonalities();
				if (random.CheckPercentProb((15 + personalities5.Items[2] / 2) * factor / 100))
				{
					targetCharIds.Add(item9);
				}
			}
		}
	}

	private void InitializeRelations()
	{
		_relatedCharIds = new Dictionary<int, RelatedCharacters>();
		foreach (var (relationKey2, relatedCharacter2) in _relations)
		{
			RelatedCharIds_AddRelations(relationKey2.CharId, relationKey2.RelatedCharId, relatedCharacter2.RelationType);
		}
	}

	private ushort RelatedCharIds_AddRelation(int charId, int relatedCharId, ushort oriTypes, ushort addingType)
	{
		Tester.Assert(addingType != 0);
		RelatedCharacters relatedCharacters = _relatedCharIds[charId];
		ushort num = RelationTypeHelper.AddRelation(relatedCharacters, relatedCharId, oriTypes, addingType);
		if (oriTypes == 0 && num != 0)
		{
			relatedCharacters.General.Remove(relatedCharId);
		}
		return num;
	}

	private ushort RelatedCharIds_ChangeRelation(int charId, int relatedCharId, ushort oriTypes, ushort removingType, ushort addingType)
	{
		RelatedCharacters relatedCharacters = _relatedCharIds[charId];
		ushort num = oriTypes;
		if (removingType != 0)
		{
			relatedCharacters.Remove(relatedCharId, removingType);
			num &= (ushort)(~removingType);
		}
		if (addingType != 0)
		{
			num = RelationTypeHelper.AddRelation(relatedCharacters, relatedCharId, num, addingType);
		}
		if (oriTypes == 0 && num != 0)
		{
			relatedCharacters.General.Remove(relatedCharId);
		}
		else if (oriTypes != 0 && num == 0)
		{
			relatedCharacters.General.Add(relatedCharId);
		}
		return num;
	}

	private void RelatedCharIds_AddRelations(int charId, int relatedCharId, ushort relationTypes)
	{
		if (!_relatedCharIds.TryGetValue(charId, out var value))
		{
			value = new RelatedCharacters();
			_relatedCharIds.Add(charId, value);
		}
		if (relationTypes == 0)
		{
			value.General.Add(relatedCharId);
			return;
		}
		for (int i = 0; i < 17; i++)
		{
			ushort num = (ushort)(1 << i);
			if ((relationTypes & num) != 0)
			{
				value.Add(relatedCharId, num);
			}
		}
	}

	private void RelatedCharIds_RemoveRelations(int charId, int relatedCharId, ushort relationTypes)
	{
		if (!_relatedCharIds.TryGetValue(charId, out var value))
		{
			return;
		}
		if (relationTypes == 0)
		{
			value.General.Remove(relatedCharId);
			return;
		}
		for (int i = 0; i < 17; i++)
		{
			ushort num = (ushort)(1 << i);
			if ((relationTypes & num) != 0)
			{
				value.Remove(relatedCharId, num);
			}
		}
	}

	private void AddRelationInternal(DataContext context, int charId, int relatedCharId, ushort addingType, int establishmentDate)
	{
		RelationKey relationKey = new RelationKey(charId, relatedCharId);
		if (_relations.TryGetValue(relationKey, out var value))
		{
			if (addingType != 0)
			{
				ushort relationType = RelatedCharIds_AddRelation(charId, relatedCharId, value.RelationType, addingType);
				value.RelationType = relationType;
				SetElement_Relations(relationKey, value, context);
				Events.RaiseRelationAdded(context, charId, relatedCharId, addingType);
			}
		}
		else
		{
			short initialFavorability = (IsAnyCharacterCreating() ? GetInitialFabricatedFavorability(context.Random, charId, addingType) : CalcInitialFavorability(context.Random, charId, relatedCharId));
			CreateRelation(context, charId, relatedCharId, addingType, initialFavorability, establishmentDate);
			Events.RaiseRelationAdded(context, charId, relatedCharId, addingType);
		}
	}

	private RelatedCharacter CreateRelation(DataContext context, int charId, int relatedCharId, ushort relationType, short initialFavorability, int establishmentDate = int.MinValue)
	{
		RelationKey elementId = new RelationKey(charId, relatedCharId);
		RelatedCharacter relatedCharacter = new RelatedCharacter(relationType, initialFavorability, (establishmentDate == int.MinValue) ? DomainManager.World.GetCurrDate() : establishmentDate);
		AddElement_Relations(elementId, relatedCharacter, context);
		if (!_relatedCharIds.TryGetValue(charId, out var value))
		{
			value = new RelatedCharacters();
			_relatedCharIds.Add(charId, value);
		}
		value.Add(relatedCharId, relationType);
		return relatedCharacter;
	}

	internal short CalcInitialFavorability(IRandomSource random, int charId, int relatedCharId)
	{
		bool flag = true;
		sbyte selfBehaviorType;
		OrganizationMemberItem organizationMemberItem;
		DeadCharacter value2;
		if (_objects.TryGetValue(charId, out var value))
		{
			flag = value.IsFavorabilityGainFixed;
			selfBehaviorType = value.GetBehaviorType();
			organizationMemberItem = OrganizationDomain.GetOrgMemberConfig(value.GetOrganizationInfo());
		}
		else if (_deadCharacters.TryGetValue(charId, out value2))
		{
			selfBehaviorType = BehaviorType.GetBehaviorType(value2.Morality);
			organizationMemberItem = OrganizationDomain.GetOrgMemberConfig(value2.OrganizationInfo);
		}
		else
		{
			selfBehaviorType = -1;
			organizationMemberItem = OrganizationMember.Instance[(short)0];
		}
		Character value3;
		DeadCharacter value4;
		(short, sbyte, sbyte, short, sbyte, sbyte, OrganizationMemberItem) tuple = (_objects.TryGetValue(relatedCharId, out value3) ? GetInitialFavorabilityRelatedDataOfAliveChar(value3) : ((!_deadCharacters.TryGetValue(charId, out value4)) ? GetDefaultInitialFavorabilityRelatedData() : GetInitialFavorabilityRelatedDataOfDeadChar(value4)));
		bool flag2 = relatedCharId == DomainManager.Taiwu.GetTaiwuCharId();
		bool flag3 = charId == DomainManager.Taiwu.GetTaiwuCharId();
		bool hasTaiwu = flag2 || flag3;
		int num = CalcInitialFavorability(organizationMemberItem, tuple.Item1, tuple.Item2, tuple.Item3, tuple.Item4, selfBehaviorType, tuple.Item5, hasTaiwu, flag);
		if (flag2)
		{
			short worldFavorabilityPercent = GetWorldFavorabilityPercent(flag);
			if (organizationMemberItem.Organization == 16)
			{
				num += 9000 * worldFavorabilityPercent / 100;
			}
			short taiwuVillageSettlementId = DomainManager.Taiwu.GetTaiwuVillageSettlementId();
			int buildingBlockEffect = DomainManager.Building.GetBuildingBlockEffect(taiwuVillageSettlementId, EBuildingScaleEffect.InitialFavorability);
			num += buildingBlockEffect * worldFavorabilityPercent / 100;
		}
		return (short)Math.Clamp(num, -30000, 30000);
	}

	private static (short favor, short relatedFavor) CalcInitialFavorabilitiesOfAliveChars(IRandomSource random, Character character, Character relatedChar)
	{
		(short, sbyte, sbyte, short, sbyte, sbyte, OrganizationMemberItem) initialFavorabilityRelatedDataOfAliveChar = GetInitialFavorabilityRelatedDataOfAliveChar(character);
		(short, sbyte, sbyte, short, sbyte, sbyte, OrganizationMemberItem) initialFavorabilityRelatedDataOfAliveChar2 = GetInitialFavorabilityRelatedDataOfAliveChar(relatedChar);
		bool isFavorabilityGainFixed = character.IsFavorabilityGainFixed;
		bool isFavorabilityGainFixed2 = relatedChar.IsFavorabilityGainFixed;
		bool flag = relatedChar.GetId() == DomainManager.Taiwu.GetTaiwuCharId();
		bool flag2 = character.GetId() == DomainManager.Taiwu.GetTaiwuCharId();
		bool hasTaiwu = flag || flag2;
		int num = CalcInitialFavorability(initialFavorabilityRelatedDataOfAliveChar.Item7, initialFavorabilityRelatedDataOfAliveChar2.Item1, initialFavorabilityRelatedDataOfAliveChar2.Item2, initialFavorabilityRelatedDataOfAliveChar2.Item3, initialFavorabilityRelatedDataOfAliveChar2.Item4, initialFavorabilityRelatedDataOfAliveChar.Item5, initialFavorabilityRelatedDataOfAliveChar2.Item5, hasTaiwu, isFavorabilityGainFixed);
		if (flag)
		{
			num = TaiwuRelatedFavorAdd(num, character);
		}
		short item = (short)Math.Clamp(num, -30000, 30000);
		int num2 = CalcInitialFavorability(initialFavorabilityRelatedDataOfAliveChar2.Item7, initialFavorabilityRelatedDataOfAliveChar.Item1, initialFavorabilityRelatedDataOfAliveChar.Item2, initialFavorabilityRelatedDataOfAliveChar.Item3, initialFavorabilityRelatedDataOfAliveChar.Item4, initialFavorabilityRelatedDataOfAliveChar2.Item5, initialFavorabilityRelatedDataOfAliveChar.Item5, hasTaiwu, isFavorabilityGainFixed2);
		if (flag2)
		{
			num2 = TaiwuRelatedFavorAdd(num2, relatedChar);
		}
		short item2 = (short)Math.Clamp(num2, -30000, 30000);
		return (favor: item, relatedFavor: item2);
		static int TaiwuRelatedFavorAdd(int initFavor, Character otherCharacter)
		{
			bool isFavorabilityGainFixed3 = otherCharacter.IsFavorabilityGainFixed;
			short worldFavorabilityPercent = GetWorldFavorabilityPercent(isFavorabilityGainFixed3);
			OrganizationInfo organizationInfo = otherCharacter.GetOrganizationInfo();
			OrganizationItem orgCfg = Config.Organization.Instance[organizationInfo.OrgTemplateId];
			if (otherCharacter.GetOrganizationInfo().OrgTemplateId == 16)
			{
				initFavor += 9000 * worldFavorabilityPercent / 100;
			}
			short taiwuVillageSettlementId = DomainManager.Taiwu.GetTaiwuVillageSettlementId();
			int buildingBlockEffect = DomainManager.Building.GetBuildingBlockEffect(taiwuVillageSettlementId, EBuildingScaleEffect.InitialFavorability);
			initFavor += buildingBlockEffect * worldFavorabilityPercent / 100;
			if (DomainManager.Extra.MartialArtistSkill0Useful(orgCfg) || DomainManager.Extra.CivilianSkill0Useful(orgCfg))
			{
				initFavor += initFavor * GlobalConfig.Instance.ProfessionInitialFavorabilitiesImprovePercent / 100;
			}
			return initFavor;
		}
	}

	private static (short attraction, sbyte fameType, sbyte gender, short clothingTemplateId, sbyte behaviorType, sbyte interactionGrade, OrganizationMemberItem orgMemberCfg) GetInitialFavorabilityRelatedDataOfAliveChar(Character character)
	{
		ItemKey itemKey = character.GetEquipment()[4];
		short item = (short)((itemKey.IsValid() && !DomainManager.Item.GetBaseItem(itemKey).IsDurabilityRunningOut()) ? itemKey.TemplateId : (-1));
		return (attraction: character.GetAttraction(), fameType: FameType.GetFameType(character.GetFame()), gender: character.GetDisplayingGender(), clothingTemplateId: item, behaviorType: character.GetBehaviorType(), interactionGrade: character.GetInteractionGrade(), orgMemberCfg: OrganizationDomain.GetOrgMemberConfig(character.GetOrganizationInfo()));
	}

	private static (short attraction, sbyte fameType, sbyte gender, short clothingTemplateId, sbyte behaviorType, sbyte interactionGrade, OrganizationMemberItem orgMemberCfg) GetInitialFavorabilityRelatedDataOfDeadChar(DeadCharacter deadCharacter)
	{
		OrganizationMemberItem orgMemberConfig = OrganizationDomain.GetOrgMemberConfig(deadCharacter.OrganizationInfo);
		return (attraction: deadCharacter.Attraction, fameType: deadCharacter.FameType, gender: deadCharacter.Avatar.GetGender(), clothingTemplateId: -1, behaviorType: BehaviorType.GetBehaviorType(deadCharacter.Morality), interactionGrade: deadCharacter.OrganizationInfo.Grade, orgMemberCfg: orgMemberConfig);
	}

	private static (short attraction, sbyte fameType, sbyte gender, short clothingTemplateId, sbyte behaviorType, sbyte interactionGrade, OrganizationMemberItem orgMemberCfg) GetDefaultInitialFavorabilityRelatedData()
	{
		return (attraction: 450, fameType: 3, gender: -1, clothingTemplateId: -1, behaviorType: -1, interactionGrade: 0, orgMemberCfg: OrganizationMember.Instance[(short)0]);
	}

	private static int CalcInitialFavorability(OrganizationMemberItem selfOrgMemberCfg, short relatedAttraction, sbyte relatedFameType, sbyte relatedGender, short relatedClothingTemplateId, sbyte selfBehaviorType, sbyte relatedBehaviorType, bool hasTaiwu, bool selfIsNotIntelligentCharacter)
	{
		int num = 100;
		num += relatedAttraction / 3;
		num += (relatedFameType - 3) * 60;
		if (relatedGender == 0)
		{
			num += 20;
		}
		if (selfOrgMemberCfg.FavoriteClothingIds.Contains(relatedClothingTemplateId))
		{
			num += 20;
			if (selfOrgMemberCfg.Organization == 13)
			{
				num += 20;
			}
		}
		else if (selfOrgMemberCfg.HatedClothingIds.Contains(relatedClothingTemplateId))
		{
			num -= 20;
		}
		if (selfBehaviorType >= 0 && relatedBehaviorType >= 0)
		{
			if (selfBehaviorType == relatedBehaviorType)
			{
				num += 60;
			}
			else if (BehaviorType.IsContradictory(selfBehaviorType, relatedBehaviorType))
			{
				num -= 60;
			}
		}
		if (hasTaiwu)
		{
			short worldFavorabilityPercent = GetWorldFavorabilityPercent(selfIsNotIntelligentCharacter);
			int num2 = num - 100;
			num2 = num2 * worldFavorabilityPercent / 100;
			num = 100 + num2;
		}
		return 3000 * num / 100;
	}

	private short GetInitialFabricatedFavorability(IRandomSource random, int charId, ushort relationType)
	{
		if (relationType == 0)
		{
			return 0;
		}
		short morality;
		sbyte orgTemplateId;
		if (_objects.TryGetValue(charId, out var value))
		{
			morality = value.GetMorality();
			orgTemplateId = value.GetOrganizationInfo().OrgTemplateId;
		}
		else
		{
			if (!_deadCharacters.TryGetValue(charId, out var value2))
			{
				return 0;
			}
			morality = value2.Morality;
			orgTemplateId = value2.OrganizationInfo.OrgTemplateId;
		}
		(short[] settings, int offset) initialFabricatedFavorabilitySettings = GetInitialFabricatedFavorabilitySettings(orgTemplateId, relationType);
		short[] item = initialFabricatedFavorabilitySettings.settings;
		int item2 = initialFabricatedFavorabilitySettings.offset;
		sbyte behaviorType = BehaviorType.GetBehaviorType(morality);
		short num = item[item2 + behaviorType];
		short num2 = item[item2 + 5];
		short num3 = item[item2 + 5 + 1];
		float stdDev = (float)(num3 - num2) / 7f;
		return (short)RedzenHelper.NormalDistribute(random, num, stdDev, num2, num3);
	}

	private static (short[] settings, int offset) GetInitialFabricatedFavorabilitySettings(sbyte orgTemplateId, ushort relationType)
	{
		if (relationType == 2048 || relationType == 4096)
		{
			sbyte largeSectIndex = OrganizationDomain.GetLargeSectIndex(orgTemplateId);
			if (largeSectIndex >= 0)
			{
				return (settings: InitialMentorFabricatedFavorOfSects, offset: largeSectIndex * 7);
			}
		}
		sbyte typeId = RelationType.GetTypeId(relationType);
		return (settings: InitialFabricatedFavorOfRelationTypes, offset: typeId * 7);
	}

	private bool HasNominalDirectBloodRelation(CharacterSet characterSet, int relatedCharId, bool exceptBloodParent)
	{
		HashSet<int> collection = characterSet.GetCollection();
		if (collection.Count <= 0)
		{
			return false;
		}
		foreach (int item in collection)
		{
			if (!_relations.TryGetValue(new RelationKey(item, relatedCharId), out var value) || !RelationType.ContainDirectBloodRelations(value.RelationType) || (exceptBloodParent && (value.RelationType & 1) != 0))
			{
				continue;
			}
			return true;
		}
		return false;
	}

	private unsafe bool HasActualDirectBloodRelation(int charId, int relatedCharId, bool exceptBloodParent, HashSet<int> actualDirectBloodCharIds = null)
	{
		_relatedCharIds.TryGetValue(charId, out var value);
		int* ptr = stackalloc int[2];
		GetActualBloodParents(charId, value, ptr);
		for (int i = 0; i < 2; i++)
		{
			int num = ptr[i];
			if (num >= 0)
			{
				if (num == relatedCharId && !exceptBloodParent)
				{
					return true;
				}
				actualDirectBloodCharIds?.Add(num);
			}
		}
		for (int j = 0; j < 2; j++)
		{
			int num2 = ptr[j];
			if (num2 >= 0)
			{
				_relatedCharIds.TryGetValue(num2, out var value2);
				if (IsActualBloodChildren(num2, value2, relatedCharId, actualDirectBloodCharIds))
				{
					return true;
				}
			}
		}
		actualDirectBloodCharIds?.Remove(charId);
		if (IsActualBloodChildren(charId, value, relatedCharId, actualDirectBloodCharIds))
		{
			return true;
		}
		return false;
	}

	private unsafe void GetActualBloodParents(int charId, RelatedCharacters relatedChars, int* pActualBloodParentIds)
	{
		int* ptr = stackalloc int[2] { -2, -1 };
		if (relatedChars != null)
		{
			HashSet<int> collection = relatedChars.BloodParents.GetCollection();
			foreach (int item in collection)
			{
				sbyte aliveOrDeadCharacterGender = GetAliveOrDeadCharacterGender(item);
				if (aliveOrDeadCharacterGender != -1)
				{
					ptr[aliveOrDeadCharacterGender] = item;
				}
				else if (*ptr < 0)
				{
					*ptr = item;
				}
				else
				{
					ptr[1] = item;
				}
			}
		}
		for (int i = 0; i < 2; i++)
		{
			int num = ptr[i];
			pActualBloodParentIds[i] = (TryGetActualBloodParent(num, charId, out var actualParentId) ? actualParentId : num);
		}
	}

	private bool IsActualBloodChildren(int charId, RelatedCharacters relatedChars, int relatedCharId, HashSet<int> actualDirectBloodCharIds = null)
	{
		if (relatedChars != null)
		{
			HashSet<int> collection = relatedChars.BloodChildren.GetCollection();
			foreach (int item in collection)
			{
				if (!TryGetActualBloodParent(charId, item, out var _))
				{
					if (item == relatedCharId)
					{
						return true;
					}
					actualDirectBloodCharIds?.Add(item);
				}
			}
		}
		List<ParentAndChild> nominalBloodParentRelations = GetNominalBloodParentRelations(charId);
		if (nominalBloodParentRelations != null)
		{
			int i = 0;
			for (int count = nominalBloodParentRelations.Count; i < count; i++)
			{
				int childId = nominalBloodParentRelations[i].ChildId;
				if (childId == relatedCharId)
				{
					return true;
				}
				actualDirectBloodCharIds?.Add(childId);
			}
		}
		return false;
	}

	private int GetAliveRemarrySpouse(int charId, int firstSpouseCharId)
	{
		if (_relatedCharIds.TryGetValue(charId, out var value))
		{
			HashSet<int> collection = value.HusbandsAndWives.GetCollection();
			foreach (int item in collection)
			{
				if (item != firstSpouseCharId && IsCharacterAlive(item))
				{
					return item;
				}
			}
		}
		return -1;
	}

	private void SetFavorability(DataContext context, int charId, int relatedCharId, short value)
	{
		value = Math.Clamp(value, (short)(-30000), (short)30000);
		RelationKey relationKey = new RelationKey(charId, relatedCharId);
		if (_relations.TryGetValue(relationKey, out var value2))
		{
			value2.Favorability = value;
			SetElement_Relations(relationKey, value2, context);
		}
		else
		{
			CreateRelation(context, charId, relatedCharId, 0, value);
		}
	}

	[DomainMethod]
	public int CalcItemsFavorabilityDelta(int characterId, int relatedCharId, Inventory items, short type)
	{
		if (items != null && items.InventoryItemTotalCount == 0)
		{
			return 0;
		}
		Character element_Objects = GetElement_Objects(characterId);
		Character element_Objects2 = GetElement_Objects(relatedCharId);
		int num = 0;
		ResourceInts values = default(ResourceInts);
		foreach (var (itemKey2, num3) in items.Items)
		{
			if (ItemTemplateHelper.IsMiscResource(itemKey2.ItemType, itemKey2.TemplateId))
			{
				sbyte miscResourceType = ItemTemplateHelper.GetMiscResourceType(itemKey2.ItemType, itemKey2.TemplateId);
				values.Add(miscResourceType, num3);
			}
			else
			{
				ItemBase baseItem = DomainManager.Item.GetBaseItem(itemKey2);
				int num4 = num3 * baseItem.GetFavorabilityChange();
				num += num4;
			}
		}
		if (values.IsNonZero())
		{
			(long positiveWorth, long negativeWorth) resourcesWorth = GetResourcesWorth(ref values);
			long item = resourcesWorth.positiveWorth;
			long item2 = resourcesWorth.negativeWorth;
			short resourceFavorabilityChange = AiHelper.GeneralActionConstants.GetResourceFavorabilityChange(6, (int)Math.Clamp(item, 0L, 2147483647L));
			num += resourceFavorabilityChange;
		}
		return CalcFavorabilityDelta(element_Objects, element_Objects2, num, type);
	}

	[DomainMethod]
	public int CalcFavorabilityDelta(int characterId, int relatedCharId, int baseDelta, short type)
	{
		Character element_Objects = GetElement_Objects(characterId);
		Character element_Objects2 = GetElement_Objects(relatedCharId);
		return CalcFavorabilityDelta(element_Objects, element_Objects2, baseDelta, type);
	}

	public static int CalcFavorabilityDelta(Character character, Character relatedChar, int baseDelta, short type)
	{
		int num = 1000;
		if (baseDelta > 0)
		{
			if (character.GetCreatingType() == 1)
			{
				sbyte behaviorType = character.GetBehaviorType();
				sbyte behaviorType2 = relatedChar.GetBehaviorType();
				if (behaviorType == behaviorType2)
				{
					num += 400;
				}
				else if (BehaviorType.IsContradictory(behaviorType, behaviorType2))
				{
					num -= 400;
				}
				short settlementId = relatedChar.GetOrganizationInfo().SettlementId;
				int buildingBlockEffect = DomainManager.Building.GetBuildingBlockEffect(settlementId, EBuildingScaleEffect.FavorIncreaseBonus);
				num += buildingBlockEffect * 10;
				int num2 = character.GetInteractionGrade() - relatedChar.GetInteractionGrade();
				num = num * FavorabilityFactorOfGradeDifferences[8 + num2] / 100;
			}
			num = num * character.GetFavorabilityChangingFactor().Outer / 100;
			(int, bool) favorabilityChangePercent = DomainManager.World.GetFavorabilityChangePercent(type, character.IsFavorabilityGainFixed);
			num = ((num < 0 && favorabilityChangePercent.Item2) ? (num * 100 / favorabilityChangePercent.Item1) : (num * favorabilityChangePercent.Item1 / 100));
		}
		else
		{
			if (relatedChar == DomainManager.Taiwu.GetTaiwu() && character.GetCreatingType() == 1)
			{
				OrganizationInfo organizationInfo = character.GetOrganizationInfo();
				if (OrganizationDomain.IsSect(organizationInfo.OrgTemplateId))
				{
					if (DomainManager.Extra.IsProfessionalSkillUnlockedAndEquipped(9) && organizationInfo.Grade <= DomainManager.Extra.GetProfessionData(3).GetSeniorityOrgGrade())
					{
						num -= 200;
					}
				}
				else if (DomainManager.Extra.IsProfessionalSkillUnlockedAndEquipped(32) && organizationInfo.Grade <= DomainManager.Extra.GetProfessionData(10).GetSeniorityOrgGrade())
				{
					num -= 200;
				}
			}
			short settlementId2 = relatedChar.GetOrganizationInfo().SettlementId;
			int buildingBlockEffect2 = DomainManager.Building.GetBuildingBlockEffect(settlementId2, EBuildingScaleEffect.FavorDecreaseReduction);
			num -= buildingBlockEffect2 * 10;
			num = num * character.GetFavorabilityChangingFactor().Inner / 100;
			(int, bool) favorabilityChangePercent2 = DomainManager.World.GetFavorabilityChangePercent(type, character.IsFavorabilityGainFixed);
			num = ((num > 0 && favorabilityChangePercent2.Item2) ? (num * 100 / favorabilityChangePercent2.Item1) : (num * favorabilityChangePercent2.Item1 / 100));
		}
		return baseDelta * num / 1000;
	}

	public CharacterSet GetReversedRelatedCharIds(int charId, ushort relationType)
	{
		CharacterSet result = default(CharacterSet);
		if (!_relatedCharIds.TryGetValue(charId, out var value))
		{
			return result;
		}
		ushort oppositeRelationType = RelationType.GetOppositeRelationType(relationType);
		if (oppositeRelationType != 0)
		{
			HashSet<int> collection = value.GetCharacterSet(oppositeRelationType).GetCollection();
			result.AddRange(collection);
		}
		else
		{
			HashSet<int> hashSet = ObjectPool<HashSet<int>>.Instance.Get();
			hashSet.Clear();
			value.GetAllRelatedCharIds(hashSet);
			foreach (int item in hashSet)
			{
				if (HasRelation(item, charId, relationType))
				{
					result.Add(item);
				}
			}
			ObjectPool<HashSet<int>>.Instance.Return(hashSet);
		}
		return result;
	}

	public int GetReversedRelatedCharIdCount(int charId, ushort relationType)
	{
		if (!_relatedCharIds.TryGetValue(charId, out var value))
		{
			return 0;
		}
		ushort oppositeRelationType = RelationType.GetOppositeRelationType(relationType);
		if (oppositeRelationType != 0)
		{
			HashSet<int> collection = value.GetCharacterSet(oppositeRelationType).GetCollection();
			return collection.Count;
		}
		HashSet<int> hashSet = ObjectPool<HashSet<int>>.Instance.Get();
		hashSet.Clear();
		value.GetAllRelatedCharIds(hashSet);
		int num = 0;
		foreach (int item in hashSet)
		{
			if (HasRelation(item, charId, relationType))
			{
				num++;
			}
		}
		ObjectPool<HashSet<int>>.Instance.Return(hashSet);
		return num;
	}

	private static short GetWorldFavorabilityPercent(bool notIntelligentCharacter)
	{
		byte favorabilityChange = DomainManager.Extra.GetFavorabilityChange();
		short index = (short)(notIntelligentCharacter ? 6 : 0);
		WorldFavorabilityItem worldFavorabilityItem = WorldFavorability.Instance[index];
		return worldFavorabilityItem.InfluenceFactors[favorabilityChange];
	}

	public void AddFavorabilityChangeInstantNotification(Character characterA, Character characterB, bool isIncrease)
	{
		int id = characterA.GetId();
		int id2 = characterB.GetId();
		if (DomainManager.Taiwu.GetTaiwuCharId() != id2)
		{
			return;
		}
		InstantNotificationCollection instantNotificationCollection = DomainManager.World.GetInstantNotificationCollection();
		short settlementId = characterA.GetOrganizationInfo().SettlementId;
		if (settlementId >= 0)
		{
			if (isIncrease)
			{
				instantNotificationCollection.AddFavorabilityIncreased(settlementId, id, id2);
			}
			else
			{
				instantNotificationCollection.AddFavorabilityDecreased(settlementId, id, id2);
			}
		}
	}

	[DomainMethod]
	public Genealogy GetGenealogy(int charId)
	{
		if (TryGetElement_Objects(charId, out var element) && element.GetSrcCharId() >= 0)
		{
			charId = element.GetSrcCharId();
		}
		Genealogy genealogy = new Genealogy
		{
			CoreCharId = charId,
			BloodFatherId = GetBloodParent(charId, 1),
			BloodMotherId = GetBloodParent(charId, 0)
		};
		if (genealogy.BloodFatherId >= 0)
		{
			genealogy.GrandfatherId = GetBloodParent(genealogy.BloodFatherId, 1);
			genealogy.GrandmotherId = GetBloodParent(genealogy.BloodFatherId, 0);
		}
		if (genealogy.BloodMotherId >= 0)
		{
			genealogy.MaternalGrandfatherId = GetBloodParent(genealogy.BloodMotherId, 1);
			genealogy.MaternalGrandmotherId = GetBloodParent(genealogy.BloodMotherId, 0);
		}
		genealogy.Parents = GetParents(charId, genealogy.BloodFatherId, genealogy.BloodMotherId);
		genealogy.BrothersAndSisters = GetBrothersAndSisters(charId);
		genealogy.Spouses = GetSpouseAndChildren(charId);
		return genealogy;
	}

	public int GetOtherBloodParent(int charId, int parentId)
	{
		HashSet<int> relatedCharIds = GetRelatedCharIds(charId, 1);
		foreach (int item in relatedCharIds)
		{
			if (item == parentId)
			{
				continue;
			}
			return item;
		}
		if (_objects.TryGetValue(parentId, out var value))
		{
			return (value.GetGender() == 0) ? (-1) : (-2);
		}
		if (_deadCharacters.TryGetValue(parentId, out var value2))
		{
			return (value2.Gender == 0) ? (-1) : (-2);
		}
		return -1;
	}

	public int GetBloodParent(int charId, sbyte parentGender)
	{
		HashSet<int> relatedCharIds = GetRelatedCharIds(charId, 1);
		List<int> list = null;
		foreach (int item in relatedCharIds)
		{
			sbyte aliveOrDeadCharacterGender = GetAliveOrDeadCharacterGender(item);
			if (aliveOrDeadCharacterGender == parentGender)
			{
				return item;
			}
			if (aliveOrDeadCharacterGender == -1)
			{
				if (list == null)
				{
					list = new List<int>();
				}
				list.Add(item);
			}
		}
		if (list != null)
		{
			int num = ((parentGender != 0) ? 1 : 0);
			return (list.Count > num) ? list[num] : (-1);
		}
		return (parentGender == 0) ? (-2) : (-1);
	}

	private List<CharIdAndRelation> GetParents(int charId, int bloodFatherId, int bloodMotherId)
	{
		List<CharIdAndRelation> list = new List<CharIdAndRelation>();
		if (bloodFatherId >= 0)
		{
			list.Add(new CharIdAndRelation(bloodFatherId, 1));
		}
		if (bloodMotherId >= 0)
		{
			list.Add(new CharIdAndRelation(bloodMotherId, 1));
		}
		foreach (int relatedCharId in GetRelatedCharIds(charId, 8))
		{
			list.Add(new CharIdAndRelation(relatedCharId, 8));
		}
		foreach (int relatedCharId2 in GetRelatedCharIds(charId, 64))
		{
			list.Add(new CharIdAndRelation(relatedCharId2, 64));
		}
		Sort(charId, list);
		return list;
	}

	private List<CharIdAndRelation> GetBrothersAndSisters(int charId)
	{
		List<CharIdAndRelation> list = new List<CharIdAndRelation>
		{
			new CharIdAndRelation(charId, ushort.MaxValue)
		};
		foreach (int relatedCharId in GetRelatedCharIds(charId, 4))
		{
			list.Add(new CharIdAndRelation(relatedCharId, 4));
		}
		foreach (int relatedCharId2 in GetRelatedCharIds(charId, 32))
		{
			list.Add(new CharIdAndRelation(relatedCharId2, 32));
		}
		foreach (int relatedCharId3 in GetRelatedCharIds(charId, 256))
		{
			list.Add(new CharIdAndRelation(relatedCharId3, 256));
		}
		Character element;
		int selfBirthDate = (TryGetElement_Objects(charId, out element) ? element.GetBirthDate() : (TryGetDeadCharacter(charId)?.BirthDate ?? (-1)));
		Sort(charId, list, selfBirthDate);
		return list;
	}

	private List<SpouseAndChildren> GetSpouseAndChildren(int charId, int depth = 0)
	{
		List<SpouseAndChildren> list = new List<SpouseAndChildren>();
		List<int> list2 = new List<int>(GetRelatedCharIds(charId, 2));
		List<int> list3 = new List<int>(GetRelatedCharIds(charId, 16));
		List<int> list4 = new List<int>(GetRelatedCharIds(charId, 128));
		foreach (int relatedCharId in GetRelatedCharIds(charId, 1024))
		{
			SpouseAndChildren spouseAndChildren = new SpouseAndChildren
			{
				SpouseCharId = relatedCharId,
				Children = new List<CharIdAndRelation>(),
				BloodChildrenSpouses = new List<SpousesAndChildren>()
			};
			HashSet<int> relatedCharIds = GetRelatedCharIds(relatedCharId, 2);
			foreach (int item in relatedCharIds)
			{
				if (list2.Contains(item))
				{
					list2.Remove(item);
					spouseAndChildren.Children.Add(new CharIdAndRelation(item, 2));
					if (depth == 0)
					{
						List<SpouseAndChildren> spouseAndChildren2 = GetSpouseAndChildren(item, depth + 1);
						spouseAndChildren.BloodChildrenSpouses.Add(new SpousesAndChildren(item, spouseAndChildren2));
					}
				}
				else if (list3.Contains(item))
				{
					list3.Remove(item);
					spouseAndChildren.Children.Add(new CharIdAndRelation(item, 16));
				}
				else
				{
					Logger.Warn($"Spouse's blood-child is neither someone's blood-child nor stepchild: ({charId}, {relatedCharId}) -> {item}");
				}
			}
			HashSet<int> relatedCharIds2 = GetRelatedCharIds(relatedCharId, 16);
			foreach (int item2 in relatedCharIds2)
			{
				if (list3.Contains(item2))
				{
					list3.Remove(item2);
					spouseAndChildren.Children.Add(new CharIdAndRelation(item2, 16));
				}
				else if (!list2.Contains(item2))
				{
					Logger.Warn($"Spouse's stepchild is neither someone's blood-child nor stepchild: ({charId}, {relatedCharId}) -> {item2}");
				}
			}
			HashSet<int> relatedCharIds3 = GetRelatedCharIds(relatedCharId, 128);
			foreach (int item3 in relatedCharIds3)
			{
				if (list4.Contains(item3))
				{
					list4.Remove(item3);
					spouseAndChildren.Children.Add(new CharIdAndRelation(item3, 128));
				}
			}
			Sort(charId, spouseAndChildren.Children);
			list.Add(spouseAndChildren);
		}
		if (list2.Count > 0 || list3.Count > 0 || list4.Count > 0)
		{
			SpouseAndChildren spouseAndChildren3 = new SpouseAndChildren
			{
				SpouseCharId = -1,
				Children = new List<CharIdAndRelation>(),
				BloodChildrenSpouses = new List<SpousesAndChildren>()
			};
			foreach (int item4 in list2)
			{
				spouseAndChildren3.Children.Add(new CharIdAndRelation(item4, 2));
				if (depth == 0)
				{
					List<SpouseAndChildren> spouseAndChildren4 = GetSpouseAndChildren(item4, depth + 1);
					spouseAndChildren3.BloodChildrenSpouses.Add(new SpousesAndChildren(item4, spouseAndChildren4));
				}
			}
			foreach (int item5 in list3)
			{
				spouseAndChildren3.Children.Add(new CharIdAndRelation(item5, 16));
			}
			foreach (int item6 in list4)
			{
				spouseAndChildren3.Children.Add(new CharIdAndRelation(item6, 128));
			}
			Sort(charId, spouseAndChildren3.Children);
			list.Add(spouseAndChildren3);
		}
		Sort(charId, list);
		return list;
	}

	private void Sort(int charId, List<CharIdAndRelation> relatedChars, int selfBirthDate = -1)
	{
		relatedChars.Sort(delegate(CharIdAndRelation lhs, CharIdAndRelation rhs)
		{
			int num = ((charId != lhs.CharId) ? DomainManager.Character.GetRelation(charId, lhs.CharId).EstablishmentDate : selfBirthDate);
			int num2 = ((charId != rhs.CharId) ? DomainManager.Character.GetRelation(charId, rhs.CharId).EstablishmentDate : selfBirthDate);
			return (num != num2) ? (num - num2) : (lhs.CharId - rhs.CharId);
		});
	}

	private void Sort(int charId, List<SpouseAndChildren> spousesAndChildren)
	{
		spousesAndChildren.Sort(delegate(SpouseAndChildren lhs, SpouseAndChildren rhs)
		{
			int num = ((lhs.SpouseCharId >= 0) ? DomainManager.Character.GetRelation(charId, lhs.SpouseCharId).EstablishmentDate : int.MaxValue);
			int num2 = ((rhs.SpouseCharId >= 0) ? DomainManager.Character.GetRelation(charId, rhs.SpouseCharId).EstablishmentDate : int.MaxValue);
			return (num != num2) ? (num - num2) : (lhs.SpouseCharId - rhs.SpouseCharId);
		});
	}

	public void AddActualBloodParent(DataContext context, int nominalParentId, int childId, int actualParentId)
	{
		ParentAndChild parentAndChild = new ParentAndChild(nominalParentId, childId);
		AddElement_ActualBloodParents(parentAndChild, actualParentId, context);
		AddNominalBloodParentRelation(actualParentId, parentAndChild);
	}

	public void AddFatherSubstitution(DataContext context, int nominalFatherId, int childId, int actualFatherId)
	{
		ParentAndChild parentAndChild = new ParentAndChild(nominalFatherId, childId);
		AddElement_ActualBloodParents(parentAndChild, actualFatherId, context);
		AddNominalBloodParentRelation(actualFatherId, parentAndChild);
	}

	public void AddImmaculateConception(DataContext context, int nominalFatherId, int childId)
	{
		ParentAndChild elementId = new ParentAndChild(nominalFatherId, childId);
		AddElement_ActualBloodParents(elementId, -1, context);
	}

	public void AddChildAbandonment(DataContext context, int nominalParentId, int childId, int actualParentId)
	{
		ParentAndChild parentAndChild = new ParentAndChild(nominalParentId, childId);
		AddElement_ActualBloodParents(parentAndChild, actualParentId, context);
		AddNominalBloodParentRelation(actualParentId, parentAndChild);
	}

	public bool TryGetActualBloodParent(int nominalParentId, int childId, out int actualParentId)
	{
		return _actualBloodParents.TryGetValue(new ParentAndChild(nominalParentId, childId), out actualParentId);
	}

	public List<ParentAndChild> GetNominalBloodParentRelations(int bloodParentId)
	{
		_nominalBloodParentRelations.TryGetValue(bloodParentId, out var value);
		return value;
	}

	public void RemoveActualBloodParent(DataContext context, int nominalParentId, int childId)
	{
		ParentAndChild parentAndChild = new ParentAndChild(nominalParentId, childId);
		int actualParentId = _actualBloodParents[parentAndChild];
		RemoveElement_ActualBloodParents(parentAndChild, context);
		RemoveNominalBloodParentRelation(actualParentId, parentAndChild);
	}

	public void RemoveObsoleteActualBloodParents(DataContext context)
	{
		List<(ParentAndChild, int)> list = new List<(ParentAndChild, int)>();
		foreach (KeyValuePair<ParentAndChild, int> actualBloodParent in _actualBloodParents)
		{
			ParentAndChild key = actualBloodParent.Key;
			int value = actualBloodParent.Value;
			if ((key.ChildId < 0 || IsCharacterDeadAndRemoved(key.ChildId)) && (key.ParentId < 0 || IsCharacterDeadAndRemoved(key.ParentId)) && (value < 0 || IsCharacterDeadAndRemoved(value)))
			{
				list.Add((key, value));
			}
		}
		int i = 0;
		for (int count = list.Count; i < count; i++)
		{
			var (parentAndChild, actualParentId) = list[i];
			RemoveElement_ActualBloodParents(parentAndChild, context);
			RemoveNominalBloodParentRelation(actualParentId, parentAndChild);
		}
	}

	private void InitializeNominalBloodParentRelations()
	{
		_nominalBloodParentRelations = new Dictionary<int, List<ParentAndChild>>();
		foreach (KeyValuePair<ParentAndChild, int> actualBloodParent in _actualBloodParents)
		{
			AddNominalBloodParentRelation(actualBloodParent.Value, actualBloodParent.Key);
		}
	}

	private void AddNominalBloodParentRelation(int actualParentId, ParentAndChild nominalRelation)
	{
		if (actualParentId >= 0)
		{
			if (!_nominalBloodParentRelations.TryGetValue(actualParentId, out var value))
			{
				value = new List<ParentAndChild>();
				_nominalBloodParentRelations.Add(actualParentId, value);
			}
			value.Add(nominalRelation);
		}
	}

	private void RemoveNominalBloodParentRelation(int actualParentId, ParentAndChild nominalRelation)
	{
		if (actualParentId >= 0)
		{
			List<ParentAndChild> list = _nominalBloodParentRelations[actualParentId];
			list.Remove(nominalRelation);
			if (list.Count <= 0)
			{
				_nominalBloodParentRelations.Remove(actualParentId);
			}
		}
	}

	public void GetSkillBookLibrary(DataContext context, Character character, List<ItemKey> combatSkillBooks, List<ItemKey> lifeSkillBooks)
	{
		int id = character.GetId();
		context.SwitchRandomSource((ulong)id);
		if (!_soldLibrarySkillBooks.TryGetValue(id, out var value))
		{
			value = GameData.Utilities.ShortList.Create();
		}
		if (value.Items == null)
		{
			value.Items = new List<short>();
		}
		List<short> items = value.Items;
		Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(id);
		foreach (KeyValuePair<short, GameData.Domains.CombatSkill.CombatSkill> item in charCombatSkills)
		{
			item.Deconstruct(out var key, out var value2);
			short index = key;
			GameData.Domains.CombatSkill.CombatSkill combatSkill = value2;
			ushort activationState = combatSkill.GetActivationState();
			if (CombatSkillStateHelper.IsBrokenOut(activationState) && CombatSkillStateHelper.CanGenerateBookFromActivationState(activationState))
			{
				short bookId = Config.CombatSkill.Instance[index].BookId;
				if (bookId >= 0 && !items.Contains(bookId))
				{
					int num = id ^ ((activationState << 16) + bookId);
					context.Random.Reinitialise((ulong)num);
					ItemKey itemKey = DomainManager.Item.CreateSkillBook(context, bookId, activationState);
					DomainManager.Item.SetOwner(itemKey, ItemOwnerType.Library, id);
					combatSkillBooks.Add(itemKey);
				}
			}
		}
		List<LifeSkillItem> learnedLifeSkills = character.GetLearnedLifeSkills();
		int i = 0;
		for (int count = learnedLifeSkills.Count; i < count; i++)
		{
			LifeSkillItem lifeSkillItem = learnedLifeSkills[i];
			if (lifeSkillItem.GetReadPagesCount() >= 3)
			{
				short skillBookId = LifeSkill.Instance[lifeSkillItem.SkillTemplateId].SkillBookId;
				if (!items.Contains(skillBookId))
				{
					int num2 = id ^ skillBookId;
					context.Random.Reinitialise((ulong)num2);
					ItemKey itemKey2 = DomainManager.Item.CreateSkillBook(context, skillBookId, -1, -1, -1, 50);
					DomainManager.Item.SetOwner(itemKey2, ItemOwnerType.Library, id);
					lifeSkillBooks.Add(itemKey2);
				}
			}
		}
		context.RestoreRandomSource();
	}

	public void DealWithSkillBookLibraryAfterTrading(DataContext context, Character character, List<ItemKey> soldSkillBooks, List<ItemKey> leftSkillBooks)
	{
		int id = character.GetId();
		GameData.Utilities.ShortList value;
		bool flag = _soldLibrarySkillBooks.TryGetValue(id, out value);
		if (!flag)
		{
			value = GameData.Utilities.ShortList.Create();
		}
		if (value.Items == null)
		{
			value.Items = new List<short>();
		}
		int i = 0;
		for (int count = soldSkillBooks.Count; i < count; i++)
		{
			short templateId = soldSkillBooks[i].TemplateId;
			value.Items.Add(templateId);
		}
		if (flag)
		{
			SetElement_SoldLibrarySkillBooks(id, value, context);
		}
		else
		{
			AddElement_SoldLibrarySkillBooks(id, value, context);
		}
		if (leftSkillBooks != null)
		{
			DomainManager.Item.RemoveItems(context, leftSkillBooks);
		}
	}

	public void RecoverSkillBookLibraries(DataContext context)
	{
		ClearSoldLibrarySkillBooks(context);
	}

	public short[] GetSkillBookLibraryGradeCount(int charId)
	{
		short[] array = new short[9];
		Character element_Objects = GetElement_Objects(charId);
		Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(charId);
		foreach (KeyValuePair<short, GameData.Domains.CombatSkill.CombatSkill> item in charCombatSkills)
		{
			item.Deconstruct(out var key, out var value);
			short index = key;
			GameData.Domains.CombatSkill.CombatSkill combatSkill = value;
			ushort activationState = combatSkill.GetActivationState();
			if (CombatSkillStateHelper.IsBrokenOut(activationState) && CombatSkillStateHelper.CanGenerateBookFromActivationState(activationState))
			{
				short bookId = Config.CombatSkill.Instance[index].BookId;
				if (bookId >= 0)
				{
					SkillBookItem skillBookItem = Config.SkillBook.Instance[bookId];
					array[skillBookItem.Grade]++;
				}
			}
		}
		List<LifeSkillItem> learnedLifeSkills = element_Objects.GetLearnedLifeSkills();
		int i = 0;
		for (int count = learnedLifeSkills.Count; i < count; i++)
		{
			LifeSkillItem lifeSkillItem = learnedLifeSkills[i];
			if (lifeSkillItem.GetReadPagesCount() >= 3)
			{
				short skillBookId = LifeSkill.Instance[lifeSkillItem.SkillTemplateId].SkillBookId;
				if (skillBookId >= 0)
				{
					SkillBookItem skillBookItem2 = Config.SkillBook.Instance[skillBookId];
					array[skillBookItem2.Grade]++;
				}
			}
		}
		return array;
	}

	private static short GetBaseTemplateId(short charTemplateId, sbyte gender)
	{
		CharacterItem characterItem = Config.Character.Instance[charTemplateId];
		if (characterItem.CreatingType != 1 || characterItem.Gender != gender)
		{
			return -1;
		}
		return (short)(charTemplateId - gender);
	}

	private static short GenerateTemplateId(short charBaseTemplateId, sbyte gender)
	{
		return (short)(charBaseTemplateId + gender);
	}

	public void BeginTemporaryModification(Character character, RevertibleCharacterPropertyType type)
	{
		if (_currTemporaryModifyingCharacter != null)
		{
			throw new Exception($"Already in modification state: {_currTemporaryModifyingCharacter.GetId()}");
		}
		_currTemporaryModifyingCharacter = character;
		BeginTemporaryModificationInternal(character, type);
	}

	public void BeginTemporaryModification(Character character, params RevertibleCharacterPropertyType[] types)
	{
		if (_currTemporaryModifyingCharacter != null)
		{
			throw new Exception($"Already in modification state: {_currTemporaryModifyingCharacter.GetId()}");
		}
		_currTemporaryModifyingCharacter = character;
		int i = 0;
		for (int num = types.Length; i < num; i++)
		{
			BeginTemporaryModificationInternal(character, types[i]);
		}
	}

	public void RecordTemporaryModification()
	{
		if (_currTemporaryModifyingCharacter == null)
		{
			throw new Exception("Not in modification state");
		}
		CharacterModificationRecords records = GetRecords(_currTemporaryModifyingCharacter.GetId());
		int i = 0;
		for (int count = _currTemporaryModifyingValues.Count; i < count; i++)
		{
			RecordTemporaryModificationInternal(i, records);
		}
		_currTemporaryModifyingCharacter = null;
		_currTemporaryModifyingValues.Clear();
	}

	public void TemporarilyModifyHappiness(DataContext context, Character character, sbyte targetValue)
	{
		sbyte happiness = character.GetHappiness();
		sbyte b = Math.Clamp(targetValue, -119, 119);
		character.SetHappiness(b, context);
		CharacterModificationRecords records = GetRecords(character.GetId());
		records.RecordHappiness(happiness, b);
	}

	public void TemporarilyModifyBaseMorality(DataContext context, Character character, short targetValue)
	{
		short baseMorality = character.GetBaseMorality();
		short num = Math.Clamp(targetValue, (short)(-500), (short)500);
		character.SetBaseMorality(num, context);
		CharacterModificationRecords records = GetRecords(character.GetId());
		records.RecordBaseMorality(baseMorality, num);
	}

	public void TemporarilyModifyFeatureIds(DataContext context, Character character, List<short> targetValue)
	{
		List<short> featureIds = character.GetFeatureIds();
		if (featureIds == targetValue)
		{
			throw new Exception("OriValue and targetValue are the same object");
		}
		character.SetFeatureIds(targetValue, context);
		CharacterModificationRecords records = GetRecords(character.GetId());
		records.RecordFeatureIds(featureIds, targetValue);
	}

	public unsafe void TemporarilyModifyBaseMainAttributes(DataContext context, Character character, MainAttributes targetValue)
	{
		MainAttributes baseMainAttributes = character.GetBaseMainAttributes();
		for (int i = 0; i < 6; i++)
		{
			targetValue.Items[i] = Math.Max(targetValue.Items[i], (short)0);
		}
		character.SetBaseMainAttributes(targetValue, context);
		CharacterModificationRecords records = GetRecords(character.GetId());
		records.RecordBaseMainAttributes(baseMainAttributes, targetValue);
	}

	public void TemporarilyModifyDisorderOfQi(DataContext context, Character character, short targetValue)
	{
		short disorderOfQi = character.GetDisorderOfQi();
		short num = Math.Clamp(targetValue, DisorderLevelOfQi.MinValue, DisorderLevelOfQi.MaxValue);
		character.SetDisorderOfQi(num, context);
		CharacterModificationRecords records = GetRecords(character.GetId());
		records.RecordDisorderOfQi(disorderOfQi, num);
	}

	public unsafe void TemporarilyModifyInjuries(DataContext context, Character character, Injuries targetValue)
	{
		Injuries injuries = character.GetInjuries();
		for (int i = 0; i < 14; i++)
		{
			targetValue.Items[i] = Math.Clamp(targetValue.Items[i], 0, 6);
		}
		character.SetInjuries(targetValue, context);
		CharacterModificationRecords records = GetRecords(character.GetId());
		records.RecordInjuries(injuries, targetValue);
	}

	public void TemporarilyModifyExtraNeili(DataContext context, Character character, int targetValue)
	{
		int extraNeili = character.GetExtraNeili();
		int num = Math.Max(targetValue, 0);
		character.SetExtraNeili(num, context);
		CharacterModificationRecords records = GetRecords(character.GetId());
		records.RecordExtraNeili(extraNeili, num);
	}

	public void TemporarilyModifyConsummateLevel(DataContext context, Character character, sbyte targetValue)
	{
		sbyte consummateLevel = character.GetConsummateLevel();
		sbyte b = Math.Clamp(targetValue, 0, sbyte.MaxValue);
		character.SetConsummateLevel(b, context);
		CharacterModificationRecords records = GetRecords(character.GetId());
		records.RecordConsummateLevel(consummateLevel, b);
	}

	public unsafe void TemporarilyModifyBaseLifeSkillQualifications(DataContext context, Character character, ref LifeSkillShorts targetValue)
	{
		ref LifeSkillShorts baseLifeSkillQualifications = ref character.GetBaseLifeSkillQualifications();
		fixed (LifeSkillShorts* ptr = &baseLifeSkillQualifications)
		{
			fixed (LifeSkillShorts* ptr2 = &targetValue)
			{
				if (ptr == ptr2)
				{
					throw new Exception("OriValue and targetValue are the same object");
				}
			}
		}
		for (int i = 0; i < 16; i++)
		{
			targetValue.Items[i] = Math.Max(targetValue.Items[i], (short)0);
		}
		character.SetBaseLifeSkillQualifications(ref targetValue, context);
		CharacterModificationRecords records = GetRecords(character.GetId());
		records.RecordBaseLifeSkillQualifications(ref baseLifeSkillQualifications, ref targetValue);
	}

	public unsafe void TemporarilyModifyBaseCombatSkillQualifications(DataContext context, Character character, ref CombatSkillShorts targetValue)
	{
		ref CombatSkillShorts baseCombatSkillQualifications = ref character.GetBaseCombatSkillQualifications();
		fixed (CombatSkillShorts* ptr = &baseCombatSkillQualifications)
		{
			fixed (CombatSkillShorts* ptr2 = &targetValue)
			{
				if (ptr == ptr2)
				{
					throw new Exception("OriValue and targetValue are the same object");
				}
			}
		}
		for (int i = 0; i < 14; i++)
		{
			targetValue.Items[i] = Math.Max(targetValue.Items[i], (short)0);
		}
		character.SetBaseCombatSkillQualifications(ref targetValue, context);
		CharacterModificationRecords records = GetRecords(character.GetId());
		records.RecordBaseCombatSkillQualifications(ref baseCombatSkillQualifications, ref targetValue);
	}

	public unsafe void TemporarilyModifyResources(DataContext context, Character character, ref ResourceInts targetValue)
	{
		ref ResourceInts resources = ref character.GetResources();
		fixed (ResourceInts* ptr = &resources)
		{
			fixed (ResourceInts* ptr2 = &targetValue)
			{
				if (ptr == ptr2)
				{
					throw new Exception("OriValue and targetValue are the same object");
				}
			}
		}
		for (int i = 0; i < 8; i++)
		{
			if (targetValue.Items[i] < 0)
			{
				throw new Exception($"{character.GetId()}'s resource amount cannot be negative: {i}, {targetValue.Items[i]}");
			}
		}
		character.SetResources(ref targetValue, context);
		CharacterModificationRecords records = GetRecords(character.GetId());
		records.RecordResources(ref resources, ref targetValue);
	}

	public unsafe void TemporarilyModifyCurrMainAttributes(DataContext context, Character character, MainAttributes targetValue)
	{
		MainAttributes currMainAttributes = character.GetCurrMainAttributes();
		for (int i = 0; i < 6; i++)
		{
			targetValue.Items[i] = Math.Max(targetValue.Items[i], (short)0);
		}
		character.SetCurrMainAttributes(targetValue, context);
		CharacterModificationRecords records = GetRecords(character.GetId());
		records.RecordCurrMainAttributes(currMainAttributes, targetValue);
	}

	public unsafe void TemporarilyModifyPoisoned(DataContext context, Character character, ref PoisonInts targetValue)
	{
		ref PoisonInts poisoned = ref character.GetPoisoned();
		fixed (PoisonInts* ptr = &poisoned)
		{
			fixed (PoisonInts* ptr2 = &targetValue)
			{
				if (ptr == ptr2)
				{
					throw new Exception("OriValue and targetValue are the same object");
				}
			}
		}
		int max = 25000;
		for (int i = 0; i < 6; i++)
		{
			targetValue.Items[i] = Math.Clamp(targetValue.Items[i], 0, max);
		}
		character.SetPoisoned(ref targetValue, context);
		CharacterModificationRecords records = GetRecords(character.GetId());
		records.RecordPoisoned(ref poisoned, ref targetValue);
	}

	public void TemporarilyModifyCurrNeili(DataContext context, Character character, int targetValue)
	{
		int currNeili = character.GetCurrNeili();
		if (targetValue < 0)
		{
			throw new Exception($"Current neili cannot be less than zero: {targetValue}");
		}
		int maxNeili = character.GetMaxNeili();
		int num = ((targetValue <= maxNeili) ? targetValue : maxNeili);
		character.SetCurrNeili(num, context);
		CharacterModificationRecords records = GetRecords(character.GetId());
		records.RecordCurrNeili(currNeili, num);
	}

	public void TemporarilyModifyExtraNeiliAllocation(DataContext context, Character character, NeiliAllocation targetValue)
	{
		NeiliAllocation extraNeiliAllocation = character.GetExtraNeiliAllocation();
		character.SetExtraNeiliAllocation(targetValue, context);
		CharacterModificationRecords records = GetRecords(character.GetId());
		records.RecordExtraNeiliAllocation(extraNeiliAllocation, targetValue);
	}

	public void TemporarilyModifyXiangshuInfection(DataContext context, Character character, byte targetValue)
	{
		byte xiangshuInfection = character.GetXiangshuInfection();
		byte b = Math.Clamp(targetValue, (byte)0, (byte)200);
		character.SetXiangshuInfection(b, context);
		CharacterModificationRecords records = GetRecords(character.GetId());
		records.RecordXiangshuInfection(xiangshuInfection, b);
	}

	public void TemporarilyModifyCurrAge(DataContext context, Character character, short targetValue)
	{
		short currAge = character.GetCurrAge();
		character.SetCurrAge(targetValue, context);
		CharacterModificationRecords records = GetRecords(character.GetId());
		records.RecordCurrAge(currAge, targetValue);
	}

	public void TemporarilyModifyHealth(DataContext context, Character character, short targetValue)
	{
		short health = character.GetHealth();
		character.SetHealth(targetValue, context);
		CharacterModificationRecords records = GetRecords(character.GetId());
		records.RecordHealth(health, targetValue);
	}

	public void CreateSavepoint(int charId)
	{
		CharacterModificationRecords records = GetRecords(charId);
		records.CreateSavepoint();
	}

	public void RevertTemporaryModificationsToSavepoint(DataContext context, Character character)
	{
		int id = character.GetId();
		if (_characterTemporaryModifications.TryGetValue(id, out var value))
		{
			RevertTemporaryModificationsToSavepoint(context, character, value);
		}
	}

	public void RevertAllTemporaryModifications(DataContext context, Character character)
	{
		int id = character.GetId();
		if (_characterTemporaryModifications.TryGetValue(id, out var value))
		{
			RevertAllTemporaryModifications(context, character, value);
			_characterTemporaryModifications.Remove(id);
		}
	}

	public void RevertAllTemporaryModificationsOfAllCharacters(DataContext context)
	{
		foreach (var (key, records) in _characterTemporaryModifications)
		{
			if (_objects.TryGetValue(key, out var value))
			{
				RevertAllTemporaryModifications(context, value, records);
			}
		}
		_characterTemporaryModifications.Clear();
	}

	public void CheckCharacterTemporaryModificationState()
	{
		if (_characterTemporaryModifications.Count <= 0)
		{
			return;
		}
		StringBuilder stringBuilder = new StringBuilder("Some characters are still in temporary modification state:\n");
		foreach (var (num2, _) in _characterTemporaryModifications)
		{
			if (TryGetElement_Objects(num2, out var element))
			{
				StringBuilder stringBuilder2 = stringBuilder;
				StringBuilder stringBuilder3 = stringBuilder2;
				StringBuilder.AppendInterpolatedStringHandler handler = new StringBuilder.AppendInterpolatedStringHandler(38, 4, stringBuilder2);
				handler.AppendLiteral("  TemplateId: ");
				handler.AppendFormatted(element.GetTemplateId());
				handler.AppendLiteral(", CreatingType: ");
				handler.AppendFormatted(element.GetCreatingType());
				handler.AppendLiteral(", Name: ");
				handler.AppendFormatted(element.GetSurname());
				handler.AppendFormatted(element.GetGivenName());
				stringBuilder3.AppendLine(ref handler);
			}
			else
			{
				StringBuilder stringBuilder2 = stringBuilder;
				StringBuilder stringBuilder4 = stringBuilder2;
				StringBuilder.AppendInterpolatedStringHandler handler = new StringBuilder.AppendInterpolatedStringHandler(37, 1, stringBuilder2);
				handler.AppendLiteral("  CharacterId: ");
				handler.AppendFormatted(num2);
				handler.AppendLiteral(" (Character not found)");
				stringBuilder4.AppendLine(ref handler);
			}
		}
		throw new Exception(stringBuilder.ToString());
	}

	private void BeginTemporaryModificationInternal(Character character, RevertibleCharacterPropertyType type)
	{
		RevertibleCharacterPropertyValue item = default(RevertibleCharacterPropertyValue);
		switch (type)
		{
		case RevertibleCharacterPropertyType.Happiness:
			item.Sbyte = character.GetHappiness();
			break;
		case RevertibleCharacterPropertyType.BaseMorality:
			item.Short = character.GetBaseMorality();
			break;
		case RevertibleCharacterPropertyType.FeatureIds:
			item.Object = new List<short>(character.GetFeatureIds());
			break;
		case RevertibleCharacterPropertyType.BaseMainAttributes:
			item.MainAttributes = character.GetBaseMainAttributes();
			break;
		case RevertibleCharacterPropertyType.DisorderOfQi:
			item.Short = character.GetDisorderOfQi();
			break;
		case RevertibleCharacterPropertyType.Injuries:
			item.Injuries = character.GetInjuries();
			break;
		case RevertibleCharacterPropertyType.ExtraNeili:
			item.Int = character.GetExtraNeili();
			break;
		case RevertibleCharacterPropertyType.ConsummateLevel:
			item.Sbyte = character.GetConsummateLevel();
			break;
		case RevertibleCharacterPropertyType.BaseLifeSkillQualifications:
			item.LifeSkills = character.GetBaseLifeSkillQualifications();
			break;
		case RevertibleCharacterPropertyType.BaseCombatSkillQualifications:
			item.CombatSkills = character.GetBaseCombatSkillQualifications();
			break;
		case RevertibleCharacterPropertyType.Resources:
			item.Resources = character.GetResources();
			break;
		case RevertibleCharacterPropertyType.CurrMainAttributes:
			item.MainAttributes = character.GetCurrMainAttributes();
			break;
		case RevertibleCharacterPropertyType.Poisoned:
			item.Poisons = character.GetPoisoned();
			break;
		case RevertibleCharacterPropertyType.CurrNeili:
			item.Int = character.GetCurrNeili();
			break;
		case RevertibleCharacterPropertyType.ExtraNeiliAllocation:
			item.ExtraNeiliAllocation = character.GetExtraNeiliAllocation();
			break;
		case RevertibleCharacterPropertyType.XiangshuInfection:
			item.Byte = character.GetXiangshuInfection();
			break;
		default:
			throw new Exception($"Unsupported RevertibleCharacterPropertyType: {type}");
		}
		_currTemporaryModifyingValues.Add((type, item));
	}

	private void RecordTemporaryModificationInternal(int index, CharacterModificationRecords records)
	{
		var (revertibleCharacterPropertyType, revertibleCharacterPropertyValue) = _currTemporaryModifyingValues[index];
		switch (revertibleCharacterPropertyType)
		{
		case RevertibleCharacterPropertyType.Happiness:
		{
			sbyte oriValue8 = revertibleCharacterPropertyValue.Sbyte;
			sbyte happiness = _currTemporaryModifyingCharacter.GetHappiness();
			records.RecordHappiness(oriValue8, happiness);
			break;
		}
		case RevertibleCharacterPropertyType.BaseMorality:
		{
			short oriValue7 = revertibleCharacterPropertyValue.Short;
			short baseMorality = _currTemporaryModifyingCharacter.GetBaseMorality();
			records.RecordBaseMorality(oriValue7, baseMorality);
			break;
		}
		case RevertibleCharacterPropertyType.FeatureIds:
		{
			List<short> oriValue6 = (List<short>)revertibleCharacterPropertyValue.Object;
			List<short> featureIds = _currTemporaryModifyingCharacter.GetFeatureIds();
			records.RecordFeatureIds(oriValue6, featureIds);
			break;
		}
		case RevertibleCharacterPropertyType.BaseMainAttributes:
		{
			MainAttributes mainAttributes2 = revertibleCharacterPropertyValue.MainAttributes;
			MainAttributes baseMainAttributes = _currTemporaryModifyingCharacter.GetBaseMainAttributes();
			records.RecordBaseMainAttributes(mainAttributes2, baseMainAttributes);
			break;
		}
		case RevertibleCharacterPropertyType.DisorderOfQi:
		{
			short oriValue5 = revertibleCharacterPropertyValue.Short;
			short disorderOfQi = _currTemporaryModifyingCharacter.GetDisorderOfQi();
			records.RecordDisorderOfQi(oriValue5, disorderOfQi);
			break;
		}
		case RevertibleCharacterPropertyType.Injuries:
		{
			Injuries injuries = revertibleCharacterPropertyValue.Injuries;
			Injuries injuries2 = _currTemporaryModifyingCharacter.GetInjuries();
			records.RecordInjuries(injuries, injuries2);
			break;
		}
		case RevertibleCharacterPropertyType.ExtraNeili:
		{
			int oriValue4 = revertibleCharacterPropertyValue.Int;
			int extraNeili = _currTemporaryModifyingCharacter.GetExtraNeili();
			records.RecordExtraNeili(oriValue4, extraNeili);
			break;
		}
		case RevertibleCharacterPropertyType.ConsummateLevel:
		{
			sbyte oriValue3 = revertibleCharacterPropertyValue.Sbyte;
			sbyte consummateLevel = _currTemporaryModifyingCharacter.GetConsummateLevel();
			records.RecordConsummateLevel(oriValue3, consummateLevel);
			break;
		}
		case RevertibleCharacterPropertyType.BaseLifeSkillQualifications:
			records.RecordBaseLifeSkillQualifications(ref revertibleCharacterPropertyValue.LifeSkills, ref _currTemporaryModifyingCharacter.GetBaseLifeSkillQualifications());
			break;
		case RevertibleCharacterPropertyType.BaseCombatSkillQualifications:
			records.RecordBaseCombatSkillQualifications(ref revertibleCharacterPropertyValue.CombatSkills, ref _currTemporaryModifyingCharacter.GetBaseCombatSkillQualifications());
			break;
		case RevertibleCharacterPropertyType.Resources:
			records.RecordResources(ref revertibleCharacterPropertyValue.Resources, ref _currTemporaryModifyingCharacter.GetResources());
			break;
		case RevertibleCharacterPropertyType.CurrMainAttributes:
		{
			MainAttributes mainAttributes = revertibleCharacterPropertyValue.MainAttributes;
			MainAttributes currMainAttributes = _currTemporaryModifyingCharacter.GetCurrMainAttributes();
			records.RecordCurrMainAttributes(mainAttributes, currMainAttributes);
			break;
		}
		case RevertibleCharacterPropertyType.Poisoned:
			records.RecordPoisoned(ref revertibleCharacterPropertyValue.Poisons, ref _currTemporaryModifyingCharacter.GetPoisoned());
			break;
		case RevertibleCharacterPropertyType.CurrNeili:
		{
			int oriValue2 = revertibleCharacterPropertyValue.Int;
			int currNeili = _currTemporaryModifyingCharacter.GetCurrNeili();
			records.RecordCurrNeili(oriValue2, currNeili);
			break;
		}
		case RevertibleCharacterPropertyType.ExtraNeiliAllocation:
		{
			NeiliAllocation extraNeiliAllocation = revertibleCharacterPropertyValue.ExtraNeiliAllocation;
			NeiliAllocation extraNeiliAllocation2 = _currTemporaryModifyingCharacter.GetExtraNeiliAllocation();
			records.RecordExtraNeiliAllocation(extraNeiliAllocation, extraNeiliAllocation2);
			break;
		}
		case RevertibleCharacterPropertyType.XiangshuInfection:
		{
			byte oriValue = revertibleCharacterPropertyValue.Byte;
			byte xiangshuInfection = _currTemporaryModifyingCharacter.GetXiangshuInfection();
			records.RecordXiangshuInfection(oriValue, xiangshuInfection);
			break;
		}
		default:
			throw new Exception($"Unsupported RevertibleCharacterPropertyType: {revertibleCharacterPropertyType}");
		}
	}

	private CharacterModificationRecords GetRecords(int charId)
	{
		if (_characterTemporaryModifications.TryGetValue(charId, out var value))
		{
			return value;
		}
		value = new CharacterModificationRecords();
		_characterTemporaryModifications.Add(charId, value);
		return value;
	}

	private unsafe static void RevertAllTemporaryModifications(DataContext context, Character character, CharacterModificationRecords records)
	{
		fixed (byte* rawData = records.RawData)
		{
			while (records.Size > 0)
			{
				var (propertyType, num, dataSize) = records.Pop(rawData);
				RevertTemporaryModification(context, character, propertyType, rawData + num, dataSize);
			}
		}
	}

	private unsafe static void RevertTemporaryModificationsToSavepoint(DataContext context, Character character, CharacterModificationRecords records)
	{
		if (records.Savepoint < 0)
		{
			throw new Exception($"Character {character.GetId()}: records have no savepoint");
		}
		fixed (byte* rawData = records.RawData)
		{
			while (records.Size > records.Savepoint)
			{
				var (propertyType, num, dataSize) = records.Pop(rawData);
				RevertTemporaryModification(context, character, propertyType, rawData + num, dataSize);
			}
		}
		if (records.Size != records.Savepoint)
		{
			throw new Exception($"Character {character.GetId()}: malformed records data");
		}
		records.DeleteSavepoint();
	}

	private unsafe static void RevertTemporaryModification(DataContext context, Character character, RevertibleCharacterPropertyType propertyType, byte* pModificationData, ushort dataSize)
	{
		switch (propertyType)
		{
		case RevertibleCharacterPropertyType.Happiness:
		{
			int num9 = CharacterModificationRecords.RetrieveHappiness(pModificationData);
			character.ChangeHappiness(context, -num9);
			break;
		}
		case RevertibleCharacterPropertyType.BaseMorality:
		{
			int num8 = CharacterModificationRecords.RetrieveBaseMorality(pModificationData);
			character.ChangeBaseMorality(context, -num8);
			break;
		}
		case RevertibleCharacterPropertyType.FeatureIds:
		{
			List<ShortListModification> modifications = CharacterModificationRecords.RetrieveFeatureIds(pModificationData, dataSize);
			character.RevertFeatures(context, modifications);
			break;
		}
		case RevertibleCharacterPropertyType.BaseMainAttributes:
			character.ChangeBaseMainAttributes(context, CharacterModificationRecords.RetrieveBaseMainAttributes(pModificationData).GetReversed());
			break;
		case RevertibleCharacterPropertyType.DisorderOfQi:
		{
			int num7 = CharacterModificationRecords.RetrieveDisorderOfQi(pModificationData);
			character.ChangeDisorderOfQi(context, (short)(-num7));
			break;
		}
		case RevertibleCharacterPropertyType.Injuries:
			character.ChangeInjuries(context, CharacterModificationRecords.RetrieveInjuries(pModificationData).GetReversed());
			break;
		case RevertibleCharacterPropertyType.ExtraNeili:
		{
			int num6 = CharacterModificationRecords.RetrieveExtraNeili(pModificationData);
			character.ChangeExtraNeili(context, -num6);
			break;
		}
		case RevertibleCharacterPropertyType.ConsummateLevel:
		{
			int num5 = CharacterModificationRecords.RetrieveConsummateLevel(pModificationData);
			character.ChangeConsummateLevel(context, -num5);
			break;
		}
		case RevertibleCharacterPropertyType.BaseLifeSkillQualifications:
		{
			LifeSkillShorts delta4 = CharacterModificationRecords.RetrieveBaseLifeSkillQualifications(pModificationData).GetReversed();
			character.ChangeBaseLifeSkillQualifications(context, ref delta4);
			break;
		}
		case RevertibleCharacterPropertyType.BaseCombatSkillQualifications:
		{
			CombatSkillShorts delta3 = CharacterModificationRecords.RetrieveBaseCombatSkillQualifications(pModificationData).GetReversed();
			character.ChangeBaseCombatSkillQualifications(context, ref delta3);
			break;
		}
		case RevertibleCharacterPropertyType.Resources:
		{
			ResourceInts delta2 = CharacterModificationRecords.RetrieveResources(pModificationData).GetReversed();
			character.ChangeResourcesWithoutChecking(context, ref delta2);
			break;
		}
		case RevertibleCharacterPropertyType.CurrMainAttributes:
			character.ChangeCurrMainAttributes(context, CharacterModificationRecords.RetrieveCurrMainAttributes(pModificationData).GetReversed());
			break;
		case RevertibleCharacterPropertyType.Poisoned:
		{
			PoisonInts delta = CharacterModificationRecords.RetrievePoisoned(pModificationData).GetReversed();
			character.DirectlyChangePoisoned(context, ref delta);
			break;
		}
		case RevertibleCharacterPropertyType.CurrNeili:
		{
			int num4 = CharacterModificationRecords.RetrieveCurrNeili(pModificationData);
			character.ChangeCurrNeiliWithoutChecking(context, -num4);
			break;
		}
		case RevertibleCharacterPropertyType.ExtraNeiliAllocation:
			character.ChangeExtraNeiliAllocation(context, CharacterModificationRecords.RetrieveExtraNeiliAllocation(pModificationData).GetReversed());
			break;
		case RevertibleCharacterPropertyType.XiangshuInfection:
		{
			int num3 = CharacterModificationRecords.RetrieveXiangshuInfection(pModificationData);
			character.ChangeXiangshuInfection(context, -num3);
			break;
		}
		case RevertibleCharacterPropertyType.CurrAge:
		{
			int num2 = CharacterModificationRecords.RetrieveCurrAge(pModificationData);
			character.SetCurrAge((short)num2, context);
			break;
		}
		case RevertibleCharacterPropertyType.Health:
		{
			int num = CharacterModificationRecords.RetrieveHealth(pModificationData);
			character.SetHealth((short)num, context);
			break;
		}
		default:
			throw new Exception($"Unsupported propertyType: {propertyType}");
		}
	}

	public static string ReportAttributesAndQualificationsStats(Character character)
	{
		(string, string) realName = GetRealName(character);
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		string name = Config.Organization.Instance[organizationInfo.OrgTemplateId].Name;
		string gradeName = OrganizationDomain.GetOrgMemberConfig(organizationInfo).GradeName;
		sbyte grade = organizationInfo.Grade;
		MainAttributes baseMainAttributes = character.GetBaseMainAttributes();
		LifeSkillShorts baseLifeSkillQualifications = character.GetBaseLifeSkillQualifications();
		CombatSkillShorts baseCombatSkillQualifications = character.GetBaseCombatSkillQualifications();
		return $"{realName.Item1}{realName.Item2}({character.GetId()}),{name},å“çº§,{grade},ä¸»å±žæ€§,{baseMainAttributes[0]},{baseMainAttributes[1]},{baseMainAttributes[2]},{baseMainAttributes[3]},{baseMainAttributes[4]},{baseMainAttributes[5]},æŠ€è‰º,{baseLifeSkillQualifications[0]},{baseLifeSkillQualifications[1]},{baseLifeSkillQualifications[2]},{baseLifeSkillQualifications[3]},{baseLifeSkillQualifications[4]},{baseLifeSkillQualifications[5]},{baseLifeSkillQualifications[6]},{baseLifeSkillQualifications[7]},{baseLifeSkillQualifications[8]},{baseLifeSkillQualifications[9]},{baseLifeSkillQualifications[10]},{baseLifeSkillQualifications[11]},{baseLifeSkillQualifications[12]},{baseLifeSkillQualifications[13]},{baseLifeSkillQualifications[14]},{baseLifeSkillQualifications[15]},æ­¦å­¦,{baseCombatSkillQualifications[0]},{baseCombatSkillQualifications[1]},{baseCombatSkillQualifications[2]},{baseCombatSkillQualifications[3]},{baseCombatSkillQualifications[4]},{baseCombatSkillQualifications[5]},{baseCombatSkillQualifications[6]},{baseCombatSkillQualifications[7]},{baseCombatSkillQualifications[8]},{baseCombatSkillQualifications[9]},{baseCombatSkillQualifications[10]},{baseCombatSkillQualifications[11]},{baseCombatSkillQualifications[12]},{baseCombatSkillQualifications[13]},";
	}

	public void ReportAllAttributesAndQualificationsStats()
	{
		foreach (Character value in _objects.Values)
		{
			AdaptableLog.Info(ReportAttributesAndQualificationsStats(value));
		}
	}

	private void Test_CharacterTemplateGroup()
	{
		foreach (CharacterItem item in (IEnumerable<CharacterItem>)Config.Character.Instance)
		{
			if (item.GroupId >= 0)
			{
				for (sbyte b = 0; b < ConsummateLevel.Instance.Count; b++)
				{
					short characterTemplateIdInGroup = GetCharacterTemplateIdInGroup(item.GroupId, b);
					CharacterItem characterItem = Config.Character.Instance[characterTemplateIdInGroup];
					Logger.Info($"taiwu level {b} - {characterItem.GivenName} ({characterItem.ConsummateLevel})");
				}
			}
		}
	}

	private void Test_SummarizeProfessions()
	{
		AccurateHistogram<int> accurateHistogram = new AccurateHistogram<int>(Profession.Instance.Select((ProfessionItem professionCfg) => professionCfg.Name).ToArray(), Profession.Instance.Select((ProfessionItem professionCfg) => professionCfg.TemplateId).ToArray());
		int num = 0;
		foreach (var (charId, character2) in _objects)
		{
			if (character2.GetCreatingType() == 1)
			{
				ProfessionData characterCurrentProfession = DomainManager.Extra.GetCharacterCurrentProfession(charId);
				if (characterCurrentProfession == null)
				{
					num++;
				}
				else
				{
					accurateHistogram.Record(characterCurrentProfession.TemplateId);
				}
			}
		}
		Logger.Info(accurateHistogram.GetTextGraph());
		Logger.Info($"No Profession Count: {num}");
	}

	private void Test_InventoryItemGroup()
	{
		Inventory inventory = new Inventory();
		inventory.OfflineAdd(new ItemKey(0, 0, 606, 0), 1);
		inventory.OfflineAdd(new ItemKey(0, 0, 608, 0), 1);
		inventory.OfflineAdd(new ItemKey(0, 0, 610, 0), 1);
		inventory.OfflineAdd(new ItemKey(0, 0, 267, 0), 1);
		inventory.OfflineAdd(new ItemKey(0, 0, 268, 0), 1);
		inventory.OfflineAdd(new ItemKey(2, 0, 227, 0), 1);
		Tester.Assert(inventory.GetItemInGroup(0, 606, 0, 8).TemplateId == 610);
		Tester.Assert(inventory.GetItemInGroup(0, 606, 0, 2).TemplateId == 608);
		Tester.Assert(inventory.GetItemInGroup(0, 606, 3, 8).TemplateId == 610);
		Tester.Assert(inventory.GetItemInGroup(0, 606, 6, 8).TemplateId == -1);
		Tester.Assert(inventory.GetItemInGroup(0, 264, 0, 2).TemplateId == -1);
		Tester.Assert(inventory.GetItemInGroup(2, 225, 0, 2).TemplateId == -1);
		Tester.Assert(inventory.GetItemInSameGroup(0, 264).TemplateId == -1);
		Tester.Assert(inventory.GetItemInSameGroup(0, 268).TemplateId == 268);
		Tester.Assert(inventory.GetItemInSameGroup(0, 267).TemplateId == 267);
		Tester.Assert(inventory.GetItemInSameGroup(0, 609).TemplateId == 608);
		Tester.Assert(inventory.GetItemInSameGroup(0, 610).TemplateId == 610);
		Tester.Assert(inventory.GetItemInSameGroup(0, 612).TemplateId == 610);
		Tester.Assert(inventory.GetItemInSameGroup(0, 614).TemplateId == 610);
		Tester.Assert(inventory.GetItemInSameGroup(0, 614, -2).TemplateId == -1);
		Tester.Assert(inventory.HasItemInGroup(0, 606, 0, 8));
		Tester.Assert(inventory.HasItemInGroup(0, 606, 4, 8));
		Tester.Assert(inventory.HasItemInGroup(0, 606, 2, 2));
		Tester.Assert(!inventory.HasItemInGroup(0, 606, 5, 8));
		Tester.Assert(!inventory.HasItemInGroup(0, 606, 3, 3));
		Tester.Assert(!inventory.HasItemInGroup(0, 588, 0, 8));
		Tester.Assert(inventory.HasItemInSameGroup(0, 606));
		Tester.Assert(inventory.HasItemInSameGroup(0, 608));
		Tester.Assert(inventory.HasItemInSameGroup(0, 610));
		Tester.Assert(inventory.HasItemInSameGroup(0, 612));
		Tester.Assert(inventory.HasItemInSameGroup(0, 614));
		Tester.Assert(!inventory.HasItemInSameGroup(0, 614, -2));
		Tester.Assert(!inventory.HasItemInSameGroup(0, 596));
		Tester.Assert(!inventory.HasItemInSameGroup(2, 225));
		Tester.Assert(!inventory.HasItemInSameGroup(2, 229));
	}

	private (int, long) Test_GeneralAction_SpendResource(DataContext context, int range)
	{
		Stopwatch stopwatch = Stopwatch.StartNew();
		int num = 0;
		HashSet<int> hashSet = new HashSet<int>();
		foreach (var (item, character2) in _objects)
		{
			hashSet.Clear();
			Location location = character2.GetLocation();
			OrganizationInfo organizationInfo = character2.GetOrganizationInfo();
			if (character2.GetCreatingType() != 1 || !location.IsValid() || character2.IsActiveExternalRelationState(60) || character2.IsCompletelyInfected() || character2.GetAgeGroup() == 0 || DomainManager.LegendaryBook.IsCharacterActingCrazy(character2) || !character2.IsInRegularSettlementRange())
			{
				continue;
			}
			MapBlockData block = DomainManager.Map.GetBlock(character2.GetLocation());
			if (range == 0)
			{
				if (block.CharacterSet != null)
				{
					hashSet.UnionWith(block.CharacterSet);
				}
			}
			else
			{
				List<MapBlockData> list = ObjectPool<List<MapBlockData>>.Instance.Get();
				DomainManager.Map.GetRealNeighborBlocks(location.AreaId, location.BlockId, list, range, includeCenter: true);
				foreach (MapBlockData item2 in list)
				{
					if (item2.CharacterSet != null)
					{
						hashSet.UnionWith(item2.CharacterSet);
					}
				}
				ObjectPool<List<MapBlockData>>.Instance.Return(list);
			}
			hashSet.Remove(item);
			Character character3 = character2.SelectMaxPriorityActionTarget(context, hashSet, delegate(Character target)
			{
				foreach (GameData.Domains.Character.Ai.PersonalNeed personalNeed in target.GetPersonalNeeds())
				{
					if (personalNeed.TemplateId == 10 && personalNeed.ItemType != 11)
					{
						return true;
					}
				}
				return false;
			}, includeBabies: true);
			if (character3 != null)
			{
				num++;
			}
		}
		long elapsedMilliseconds = stopwatch.ElapsedMilliseconds;
		stopwatch.Stop();
		return (num, elapsedMilliseconds);
	}

	private void Test_GenerateCloseFriendFeatures(DataContext context)
	{
		AdaptableLog.TagInfo("Test_GenerateCloseFriendFeatures", "Start testing close friend features.");
		for (int i = 0; i < 10000; i++)
		{
			Character character = new Character();
			short morality = (short)context.Random.Next(-500, 501);
			character.OfflineSetCloseFriendFields(context, morality);
			List<short> featureIds = character.GetFeatureIds();
			foreach (short item in featureIds)
			{
				CharacterFeatureItem characterFeatureItem = CharacterFeature.Instance[item];
				if (characterFeatureItem.CandidateGroupId == 1)
				{
					throw new Exception("Negative feature " + characterFeatureItem.Name + " generated for close friend.");
				}
			}
			if (!featureIds.Contains(164))
			{
				throw new Exception("Close friend has to contain feature " + CharacterFeature.Instance[(short)164].Name + ".");
			}
		}
		AdaptableLog.TagInfo("Test_GenerateCloseFriendFeatures", $"Total {10000} iterations executed.");
	}

	private void Test_SummarizePregeneratedCharacterSize()
	{
		int num = 0;
		int value = _pregeneratedRandomEnemies.Count + _pregeneratedCityTownGuards.Length;
		foreach (int pregeneratedRandomEnemy in _pregeneratedRandomEnemies)
		{
			Character element_Objects = DomainManager.Character.GetElement_Objects(pregeneratedRandomEnemy);
			num += Test_GetCharacterDataSize(element_Objects);
		}
		int[] pregeneratedCityTownGuards = _pregeneratedCityTownGuards;
		foreach (int objectId in pregeneratedCityTownGuards)
		{
			Character element_Objects2 = DomainManager.Character.GetElement_Objects(objectId);
			num += Test_GetCharacterDataSize(element_Objects2);
		}
		Logger.Info($"Pregenerated character count: {value}\t Total size: {num / 1024}kb");
	}

	private void Test_SummarizeAllAliveCharacterSize()
	{
		int num = 0;
		foreach (Character value in _objects.Values)
		{
			num += 4 + Test_GetCharacterDataSize(value);
		}
		Logger.Info($"Alive character count: {_objects.Count}\t Total size: {num / 1024}kb");
	}

	private void Test_PunishSectCharacters(DataContext context)
	{
		foreach (var (charId, character2) in _objects)
		{
			if (character2.GetCreatingType() != 1 || !character2.GetLocation().IsValid())
			{
				continue;
			}
			OrganizationInfo organizationInfo = character2.GetOrganizationInfo();
			if (!DomainManager.Organization.TryGetElement_Sects(organizationInfo.SettlementId, out var element))
			{
				continue;
			}
			int aliveSpouse = GetAliveSpouse(charId);
			if (aliveSpouse >= 0)
			{
				Character character3 = _objects[aliveSpouse];
				if (character3.GetOrganizationInfo().OrgTemplateId == organizationInfo.OrgTemplateId && context.Random.NextBool())
				{
					DomainManager.Organization.PunishSectMember(context, element, character2, 4, 1);
				}
			}
		}
	}

	private int Test_GetCharacterDataSize(Character character)
	{
		//IL_0049: Unknown result type (might be due to invalid IL or missing references)
		//IL_0050: Expected O, but got Unknown
		//IL_00aa: Unknown result type (might be due to invalid IL or missing references)
		//IL_00b1: Expected O, but got Unknown
		int num = character.GetSerializedSize();
		foreach (ItemKey key in character.GetInventory().Items.Keys)
		{
			if (key.IsValid())
			{
				ISerializableGameData val = (ISerializableGameData)DomainManager.Item.GetBaseItem(key);
				num += val.GetSerializedSize();
			}
		}
		ItemKey[] equipment = character.GetEquipment();
		for (int i = 0; i < equipment.Length; i++)
		{
			ItemKey itemKey = equipment[i];
			if (itemKey.IsValid())
			{
				ISerializableGameData val2 = (ISerializableGameData)DomainManager.Item.GetBaseItem(itemKey);
				num += val2.GetSerializedSize();
			}
		}
		Dictionary<short, GameData.Domains.CombatSkill.CombatSkill> charCombatSkills = DomainManager.CombatSkill.GetCharCombatSkills(character.GetId());
		foreach (GameData.Domains.CombatSkill.CombatSkill value in charCombatSkills.Values)
		{
			num += 2 + value.GetSerializedSize();
		}
		return num;
	}

	public void Test_AddPoisonToEveryone(DataContext context)
	{
		foreach (KeyValuePair<int, Character> @object in _objects)
		{
			@object.Deconstruct(out var key, out var value);
			int num = key;
			Character character = value;
			for (int i = 0; i < 80; i++)
			{
				MedicineItem medicineItem = Config.Medicine.Instance[i];
				if (medicineItem.EffectType == EMedicineEffectType.ApplyPoison)
				{
					character.CreateInventoryItem(context, medicineItem.ItemType, medicineItem.TemplateId, 1);
				}
			}
		}
	}

	private unsafe void Test_GenerateFirstGeneration(DataContext context)
	{
		StringBuilder stringBuilder = new StringBuilder();
		stringBuilder.AppendLine("é—¨æ´¾\tå“çº§\tç†æƒ³é—¨æ´¾\tæˆé•¿å“çº§\tè‡ªèº«å±žæ€§\tå±žæ€§æ€»å’Œ\tè‡ªèº«æŠ€è‰º\tæŠ€è‰ºæ€»å’Œ\tè‡ªèº«æ­¦å­¦\tæ­¦å­¦æ€»å’Œ");
		IRandomSource random = context.Random;
		List<(Character, sbyte, sbyte)> list = new List<(Character, sbyte, sbyte)>();
		foreach (OrganizationItem item in (IEnumerable<OrganizationItem>)Config.Organization.Instance)
		{
			bool flag = !item.IsSect;
			bool flag2 = flag;
			if (flag2)
			{
				sbyte templateId = item.TemplateId;
				bool flag3 = ((templateId < 21 || templateId > 35) ? true : false);
				flag2 = flag3;
			}
			if (flag2)
			{
				continue;
			}
			short[] members = item.Members;
			foreach (short index in members)
			{
				OrganizationMemberItem organizationMemberItem = OrganizationMember.Instance[index];
				int num = (organizationMemberItem.RestrictPrincipalAmount ? organizationMemberItem.Amount : (organizationMemberItem.Amount * 2));
				for (int j = 0; j < num; j++)
				{
					OrganizationInfo organizationInfo = new OrganizationInfo(item.TemplateId, organizationMemberItem.Grade, principal: true, -1);
					sbyte b = Gender.GetRandom(random);
					if (!OrganizationDomain.MeetGenderRestriction(organizationInfo.OrgTemplateId, b) || (organizationMemberItem.Gender >= 0 && organizationMemberItem.Gender != b))
					{
						b = Gender.Flip(b);
					}
					short num2 = item.CharTemplateIds[b];
					IntelligentCharacterCreationInfo creationInfo = new IntelligentCharacterCreationInfo(Location.Invalid, organizationInfo, num2);
					creationInfo.MotherCharId = -1;
					creationInfo.ActualFatherCharId = -1;
					creationInfo.GrowingSectId = -1;
					Character character = new Character(num2);
					if (character.GetIdealSect() < 0)
					{
						ReflectionExtensions.CallMethod((object)character, "OfflineGenerateRandomIdealSect", new object[1] { random });
					}
					sbyte idealSect = character.GetIdealSect();
					creationInfo.GrowingSectGrade = Math.Clamp(CharacterCreation.CalcGrowingSectGradeAndAssignWeights(random, ref creationInfo, idealSect), 0, 8);
					MainAttributes mainAttributes = CharacterCreation.CreateMainAttributes(random, ref creationInfo);
					LifeSkillShorts lifeSkillShorts = CharacterCreation.CreateLifeSkillQualifications(random, ref creationInfo);
					CombatSkillShorts combatSkillShorts = CharacterCreation.CreateCombatSkillQualifications(random, ref creationInfo);
					ReflectionExtensions.ModifyField<Character>(character, "_organizationInfo", (object)organizationInfo);
					ReflectionExtensions.ModifyField<Character>(character, "_baseMainAttributes", (object)mainAttributes);
					ReflectionExtensions.ModifyField<Character>(character, "_baseLifeSkillQualifications", (object)lifeSkillShorts);
					ReflectionExtensions.ModifyField<Character>(character, "_baseCombatSkillQualifications", (object)combatSkillShorts);
					stringBuilder.AppendFormat("{0}\t{1}\t{2}\t{3}\t", item.Name, organizationInfo.Grade, (idealSect < 0) ? ((object)(-1)) : Config.Organization.Instance[idealSect].Name, creationInfo.GrowingSectGrade);
					WriteString(mainAttributes.Items, 6, stringBuilder);
					stringBuilder.Append('\t');
					stringBuilder.Append(mainAttributes.GetSum());
					stringBuilder.Append('\t');
					WriteString(lifeSkillShorts.Items, 16, stringBuilder);
					stringBuilder.Append('\t');
					stringBuilder.Append(lifeSkillShorts.GetSum());
					stringBuilder.Append('\t');
					WriteString(combatSkillShorts.Items, 14, stringBuilder);
					stringBuilder.Append('\t');
					stringBuilder.Append(combatSkillShorts.GetSum());
					stringBuilder.AppendLine();
					list.Add((character, creationInfo.GrowingSectId, creationInfo.GrowingSectGrade));
				}
			}
		}
		File.WriteAllText(Path.Combine(Program.BaseDataDir, "Logs", "FirstGeneration.txt"), stringBuilder.ToString());
		Test_GenerateChildren(context, list);
	}

	private unsafe void Test_GenerateChildren(DataContext context, List<(Character, sbyte growingSectId, sbyte growingGrade)> characterIds)
	{
		StringBuilder stringBuilder = new StringBuilder();
		stringBuilder.AppendLine("æ¯äº²å“çº§\tçˆ¶äº²å“çº§\tå“çº§\tæ¯äº²æˆé•¿å“çº§\tçˆ¶äº²æˆé•¿å“çº§\tæˆé•¿å“çº§\té—¨æ´¾\tç†æƒ³é—¨æ´¾\tæ¯äº²å±žæ€§\tçˆ¶äº²å±žæ€§\tè‡ªèº«å±žæ€§\tå±žæ€§æ€»å’Œ\tæ¯äº²æŠ€è‰º\tçˆ¶äº²æŠ€è‰º\tè‡ªèº«æŠ€è‰º\tæŠ€è‰ºæ€»å’Œ\tæ¯äº²æ­¦å­¦\tçˆ¶äº²æ­¦å­¦\tè‡ªèº«æ­¦å­¦\tæ­¦å­¦æ€»å’Œ");
		int i = 0;
		IRandomSource random = context.Random;
		for (; i < 10000; i++)
		{
			var (character, b, value) = characterIds.GetRandom(random);
			var (character2, b2, value2) = characterIds.GetRandom(random);
			if (random.CheckPercentProb(20))
			{
				character2 = null;
			}
			Location location = character.GetLocation();
			(OrganizationInfo parentOrgInfo, short baseTemplateId, bool isAbandoned) mainParentInfo = GetMainParentInfo(character, character2, createMotherRelation: true, createFatherRelation: true, isMotherDead: false);
			OrganizationInfo item = mainParentInfo.parentOrgInfo;
			short item2 = mainParentInfo.baseTemplateId;
			bool item3 = mainParentInfo.isAbandoned;
			IntelligentCharacterCreationInfo creationInfo = new IntelligentCharacterCreationInfo(location, item, item2);
			creationInfo.MotherCharId = character.GetId();
			creationInfo.Mother = character;
			creationInfo.ActualFatherCharId = character2?.GetId() ?? (-1);
			creationInfo.ActualFather = character2;
			creationInfo.GrowingSectId = -1;
			creationInfo.AllowRandomGrowingGradeAdjust = true;
			Character character3 = new Character(item2);
			if (character3.GetIdealSect() < 0)
			{
				ReflectionExtensions.CallMethod((object)character3, "OfflineGenerateRandomIdealSect", new object[1] { random });
			}
			sbyte idealSect = character3.GetIdealSect();
			creationInfo.GrowingSectGrade = Math.Clamp(CharacterCreation.CalcGrowingSectGradeAndAssignWeights(context.Random, ref creationInfo, idealSect), 0, 8);
			stringBuilder.Append(character.GetInteractionGrade());
			stringBuilder.Append('\t');
			if (character2 != null)
			{
				stringBuilder.Append(character2.GetInteractionGrade());
			}
			else
			{
				stringBuilder.Append(-1);
			}
			stringBuilder.Append('\t');
			stringBuilder.Append(item.Grade);
			stringBuilder.Append('\t');
			stringBuilder.Append(value);
			stringBuilder.Append('\t');
			if (character2 != null)
			{
				stringBuilder.Append(value2);
			}
			else
			{
				stringBuilder.Append(-1);
			}
			stringBuilder.Append('\t');
			stringBuilder.Append(creationInfo.GrowingSectGrade);
			stringBuilder.Append('\t');
			stringBuilder.Append(Config.Organization.Instance[item.OrgTemplateId].Name);
			stringBuilder.Append('\t');
			stringBuilder.Append((idealSect < 0) ? ((object)(-1)) : Config.Organization.Instance[idealSect].Name);
			stringBuilder.Append('\t');
			MainAttributes baseMainAttributes = character.GetBaseMainAttributes();
			WriteString(baseMainAttributes.Items, 6, stringBuilder);
			stringBuilder.Append('\t');
			if (character2 != null)
			{
				MainAttributes baseMainAttributes2 = character2.GetBaseMainAttributes();
				WriteString(baseMainAttributes2.Items, 6, stringBuilder);
			}
			else
			{
				stringBuilder.Append("{}");
			}
			stringBuilder.Append('\t');
			MainAttributes mainAttributes = CharacterCreation.CreateMainAttributes(context.Random, ref creationInfo);
			WriteString(mainAttributes.Items, 6, stringBuilder);
			stringBuilder.Append('\t');
			stringBuilder.Append(mainAttributes.GetSum());
			stringBuilder.Append('\t');
			LifeSkillShorts baseLifeSkillQualifications = character.GetBaseLifeSkillQualifications();
			WriteString(baseLifeSkillQualifications.Items, 16, stringBuilder);
			stringBuilder.Append('\t');
			if (character2 != null)
			{
				LifeSkillShorts baseLifeSkillQualifications2 = character2.GetBaseLifeSkillQualifications();
				WriteString(baseLifeSkillQualifications2.Items, 16, stringBuilder);
			}
			else
			{
				stringBuilder.Append("{}");
			}
			stringBuilder.Append('\t');
			LifeSkillShorts lifeSkillShorts = CharacterCreation.CreateLifeSkillQualifications(context.Random, ref creationInfo);
			WriteString(lifeSkillShorts.Items, 16, stringBuilder);
			stringBuilder.Append('\t');
			stringBuilder.Append(baseLifeSkillQualifications.GetSum());
			stringBuilder.Append('\t');
			CombatSkillShorts baseCombatSkillQualifications = character.GetBaseCombatSkillQualifications();
			WriteString(baseCombatSkillQualifications.Items, 14, stringBuilder);
			stringBuilder.Append('\t');
			if (character2 != null)
			{
				CombatSkillShorts baseCombatSkillQualifications2 = character2.GetBaseCombatSkillQualifications();
				WriteString(baseCombatSkillQualifications2.Items, 14, stringBuilder);
			}
			else
			{
				stringBuilder.Append("{}");
			}
			stringBuilder.Append('\t');
			CombatSkillShorts combatSkillShorts = CharacterCreation.CreateCombatSkillQualifications(context.Random, ref creationInfo);
			WriteString(combatSkillShorts.Items, 14, stringBuilder);
			stringBuilder.Append('\t');
			stringBuilder.Append(combatSkillShorts.GetSum());
			stringBuilder.AppendLine();
		}
		File.WriteAllText(Path.Combine(Program.BaseDataDir, "Logs", "ChildrenGeneration.txt"), stringBuilder.ToString());
	}

	public unsafe void Test_GenerateChildren(DataContext context)
	{
		Stopwatch sw = GlobalDomain.StartTimer();
		List<(Character, Character)> list = new List<(Character, Character)>();
		float num = 0.5f;
		StringBuilder stringBuilder = new StringBuilder();
		stringBuilder.AppendLine("æ¯äº²å“çº§\tçˆ¶äº²å“çº§\tçˆ¶æ¯æœ€é«˜å“çº§\tè‡ªèº«æœªä¿®æ­£æˆé•¿å“çº§\tè‡ªèº«ä¿®æ­£åŽæˆé•¿å“çº§\tæ¯äº²å±žæ€§\tçˆ¶äº²å±žæ€§\tè‡ªèº«å±žæ€§\tå±žæ€§æ€»å’Œ\tæ¯äº²æŠ€è‰º\tçˆ¶äº²æŠ€è‰º\tè‡ªèº«æŠ€è‰º\tæŠ€è‰ºæ€»å’Œ\tæ¯äº²æ­¦å­¦\tçˆ¶äº²æ­¦å­¦\tè‡ªèº«æ­¦å­¦\tæ­¦å­¦æ€»å’Œ");
		int num2 = 0;
		while (num2 < 10000)
		{
			for (short num3 = 0; num3 < 135; num3++)
			{
				Span<MapBlockData> areaBlocks = DomainManager.Map.GetAreaBlocks(num3);
				int i = 0;
				for (int length = areaBlocks.Length; i < length; i++)
				{
					HashSet<int> characterSet = areaBlocks[i].CharacterSet;
					if (characterSet == null)
					{
						continue;
					}
					foreach (int item7 in characterSet)
					{
						Character element_Objects = DomainManager.Character.GetElement_Objects(item7);
						if (element_Objects.GetGender() == 0 && element_Objects.GetAgeGroup() == 2)
						{
							HashSet<int> relatedCharIds = DomainManager.Character.GetRelatedCharIds(item7, 1024);
							int aliveSpouse = DomainManager.Character.GetAliveSpouse(item7);
							if ((relatedCharIds.Count <= 0 || aliveSpouse >= 0) && !(context.Random.NextFloat() >= num))
							{
								Character item = ((aliveSpouse >= 0) ? DomainManager.Character.GetElement_Objects(aliveSpouse) : null);
								list.Add((element_Objects, item));
							}
						}
					}
				}
			}
			foreach (var item8 in list)
			{
				Character item2 = item8.Item1;
				Character item3 = item8.Item2;
				Location location = item2.GetLocation();
				(OrganizationInfo parentOrgInfo, short baseTemplateId, bool isAbandoned) mainParentInfo = GetMainParentInfo(item2, item3, createMotherRelation: true, createFatherRelation: true, isMotherDead: false);
				OrganizationInfo item4 = mainParentInfo.parentOrgInfo;
				short item5 = mainParentInfo.baseTemplateId;
				bool item6 = mainParentInfo.isAbandoned;
				IntelligentCharacterCreationInfo creationInfo = new IntelligentCharacterCreationInfo(location, item4, item5);
				creationInfo.MotherCharId = item2.GetId();
				creationInfo.Mother = item2;
				creationInfo.ActualFatherCharId = item3?.GetId() ?? (-1);
				creationInfo.ActualFather = item3;
				Character character = new Character(item5);
				if (character.GetIdealSect() < 0)
				{
					ReflectionExtensions.CallMethod((object)character, "OfflineGenerateRandomIdealSect", new object[1] { context.Random });
				}
				sbyte idealSect = character.GetIdealSect();
				stringBuilder.Append(item2.GetInteractionGrade());
				stringBuilder.Append('\t');
				if (item3 != null)
				{
					stringBuilder.Append(item3.GetInteractionGrade());
				}
				else
				{
					stringBuilder.Append(-1);
				}
				stringBuilder.Append('\t');
				sbyte interactionGrade = item2.GetInteractionGrade();
				if (item3 != null && item3.GetInteractionGrade() > interactionGrade)
				{
					interactionGrade = item3.GetInteractionGrade();
				}
				stringBuilder.Append(interactionGrade);
				stringBuilder.Append('\t');
				creationInfo.AllowRandomGrowingGradeAdjust = false;
				creationInfo.GrowingSectGrade = CharacterCreation.CalcGrowingSectGradeAndAssignWeights(context.Random, ref creationInfo, idealSect);
				stringBuilder.Append(creationInfo.GrowingSectGrade);
				stringBuilder.Append('\t');
				creationInfo.AllowRandomGrowingGradeAdjust = true;
				creationInfo.GrowingSectGrade = CharacterCreation.CalcGrowingSectGradeAndAssignWeights(context.Random, ref creationInfo, idealSect);
				stringBuilder.Append(creationInfo.GrowingSectGrade);
				stringBuilder.Append('\t');
				MainAttributes baseMainAttributes = item2.GetBaseMainAttributes();
				WriteString(baseMainAttributes.Items, 6, stringBuilder);
				stringBuilder.Append('\t');
				if (item3 != null)
				{
					MainAttributes baseMainAttributes2 = item3.GetBaseMainAttributes();
					WriteString(baseMainAttributes2.Items, 6, stringBuilder);
				}
				else
				{
					stringBuilder.Append("{}");
				}
				stringBuilder.Append('\t');
				MainAttributes mainAttributes = CharacterCreation.CreateMainAttributes(context.Random, ref creationInfo);
				WriteString(mainAttributes.Items, 6, stringBuilder);
				stringBuilder.Append('\t');
				stringBuilder.Append(mainAttributes.GetSum());
				stringBuilder.Append('\t');
				LifeSkillShorts baseLifeSkillQualifications = item2.GetBaseLifeSkillQualifications();
				WriteString(baseLifeSkillQualifications.Items, 16, stringBuilder);
				stringBuilder.Append('\t');
				if (item3 != null)
				{
					LifeSkillShorts baseLifeSkillQualifications2 = item3.GetBaseLifeSkillQualifications();
					WriteString(baseLifeSkillQualifications2.Items, 16, stringBuilder);
				}
				else
				{
					stringBuilder.Append("{}");
				}
				stringBuilder.Append('\t');
				LifeSkillShorts lifeSkillShorts = CharacterCreation.CreateLifeSkillQualifications(context.Random, ref creationInfo);
				WriteString(lifeSkillShorts.Items, 16, stringBuilder);
				stringBuilder.Append('\t');
				stringBuilder.Append(baseLifeSkillQualifications.GetSum());
				stringBuilder.Append('\t');
				CombatSkillShorts baseCombatSkillQualifications = item2.GetBaseCombatSkillQualifications();
				WriteString(baseCombatSkillQualifications.Items, 14, stringBuilder);
				stringBuilder.Append('\t');
				if (item3 != null)
				{
					CombatSkillShorts baseCombatSkillQualifications2 = item3.GetBaseCombatSkillQualifications();
					WriteString(baseCombatSkillQualifications2.Items, 14, stringBuilder);
				}
				else
				{
					stringBuilder.Append("{}");
				}
				stringBuilder.Append('\t');
				CombatSkillShorts combatSkillShorts = CharacterCreation.CreateCombatSkillQualifications(context.Random, ref creationInfo);
				WriteString(combatSkillShorts.Items, 14, stringBuilder);
				stringBuilder.Append('\t');
				stringBuilder.Append(combatSkillShorts.GetSum());
				stringBuilder.Append('\t');
				stringBuilder.AppendLine();
				num2++;
			}
		}
		GlobalDomain.StopTimer(sw, "New Character Stats Generation");
		File.WriteAllText(Path.Combine(Program.BaseDataDir, "Logs", "GenerationSum"), stringBuilder.ToString());
	}

	private unsafe void WriteString(short* pArr, int count, StringBuilder stringBuilder)
	{
		stringBuilder.Append('{');
		for (int i = 0; i < count; i++)
		{
			stringBuilder.Append(pArr[i]);
			if (i != count - 1)
			{
				stringBuilder.Append(',');
			}
		}
		stringBuilder.Append('}');
	}

	public void Test_SoftCheckGroups()
	{
		foreach (var (num2, characterSet2) in _characterGroups)
		{
			if (!_objects.TryGetValue(num2, out var value))
			{
				Logger.Warn($"group leader {num2} is dead.");
				continue;
			}
			HashSet<int> collection = characterSet2.GetCollection();
			foreach (int item in collection)
			{
				if (!_objects.TryGetValue(item, out var value2))
				{
					Logger.Warn($"{item} is not alive (leader {value}).");
					continue;
				}
				if (value2.GetLeaderId() != num2)
				{
					Logger.Warn($"{value2}'s leader {value2.GetLeaderId()} is not {value}");
				}
				if (item != num2 && !TryGetRelation(num2, item, out var _))
				{
					Logger.Warn($"{value2} has not relation with leader {value}");
				}
			}
		}
	}

	public void Test_HardCheckGroups()
	{
		foreach (var (num2, characterSet2) in _characterGroups)
		{
			Tester.Assert(!_objects.TryGetValue(num2, out var _));
			HashSet<int> collection = characterSet2.GetCollection();
			foreach (int item in collection)
			{
				Tester.Assert(!_objects.TryGetValue(item, out var value2));
				Tester.Assert(value2.GetLeaderId() != num2);
				if (item != num2)
				{
					Tester.Assert(TryGetRelation(num2, item, out var _));
				}
			}
		}
	}

	private void Test_LogMaxConsummateLevel()
	{
		StringBuilder builder = new StringBuilder();
		builder.AppendLine("è§’è‰²\tå“çº§\tèº«é¾„\tæ–¹æ³•ä¸€æœ€å¤§ç²¾çº¯\tæ–¹æ³•ä¸€åŠŸæ³•ç±»åž‹\tæ–¹æ³•ä¸€åŠŸæ³•é€ è¯£ç›˜\tæ–¹æ³•äºŒæœ€å¤§ç²¾çº¯\tæ–¹æ³•äºŒåŠŸæ³•ç±»åž‹\tæ–¹æ³•äºŒåŠŸæ³•é€ è¯£ç›˜\tæ–¹æ³•ä¸‰æœ€å¤§ç²¾çº¯\tæ–¹æ³•ä¸‰åŠŸæ³•ç±»åž‹\tæ–¹æ³•ä¸‰åŠŸæ³•é€ è¯£ç›˜");
		foreach (var (num2, character2) in _objects)
		{
			builder.Append(character2);
			builder.Append('\t');
			builder.Append(character2.GetOrganizationInfo().Grade);
			builder.Append('\t');
			builder.Append(character2.GetCurrAge());
			builder.Append('\t');
			short[] combatSkillAttainmentPanels = character2.GetCombatSkillAttainmentPanels();
			sbyte combatSkillType = -1;
			sbyte value = Test_CalcMaxConsummateLevel1(combatSkillAttainmentPanels, ref combatSkillType);
			builder.Append(value);
			builder.Append('\t');
			if (combatSkillType >= 0)
			{
				builder.Append(Config.CombatSkillType.Instance[combatSkillType].Name);
				builder.Append('\t');
				AppendGradesOnPanel(combatSkillAttainmentPanels, combatSkillType);
			}
			else
			{
				builder.Append("æ— ");
				builder.Append('\t');
			}
			builder.Append('\t');
			sbyte combatSkillType2 = -1;
			sbyte value2 = Test_CalcMaxConsummateLevel2(combatSkillAttainmentPanels, ref combatSkillType2);
			builder.Append(value2);
			builder.Append('\t');
			if (combatSkillType2 >= 0)
			{
				builder.Append(Config.CombatSkillType.Instance[combatSkillType2].Name);
			}
			else
			{
				builder.Append("æ— ");
			}
			builder.Append('\t');
			AppendGradesOnPanel(combatSkillAttainmentPanels, combatSkillType2);
			builder.Append('\t');
			sbyte combatSkillType3 = -1;
			sbyte value3 = Test_CalcMaxConsummateLevel3(combatSkillAttainmentPanels, ref combatSkillType3);
			builder.Append(value3);
			builder.Append('\t');
			if (combatSkillType3 >= 0)
			{
				builder.Append(Config.CombatSkillType.Instance[combatSkillType3].Name);
			}
			else
			{
				builder.Append("æ— ");
			}
			builder.Append('\t');
			AppendGradesOnPanel(combatSkillAttainmentPanels, combatSkillType3);
			builder.AppendLine();
		}
		File.WriteAllText(Path.Combine(Program.BaseDataDir, "Logs", "MaxConsummateLevel.txt"), builder.ToString());
		void AppendGradesOnPanel(short[] array, sbyte skillType)
		{
			for (sbyte b = 0; b < 9; b++)
			{
				int num3 = 9 * skillType + b;
				short num4 = array[num3];
				if (num4 >= 0)
				{
					builder.Append(b);
					builder.Append('ï¼Œ');
				}
			}
		}
	}

	private static sbyte Test_CalcMaxConsummateLevel1(short[] combatSkillAttainmentPanels, ref sbyte combatSkillType)
	{
		int num = -1;
		for (sbyte b = 0; b < 14; b++)
		{
			int num2 = -1;
			int num3 = 0;
			for (sbyte b2 = 0; b2 <= 8; b2++)
			{
				int num4 = 9 * b + b2;
				short num5 = combatSkillAttainmentPanels[num4];
				if (num5 >= 0)
				{
					if (b2 != 0)
					{
						num3++;
					}
					if (num2 + 1 == b2)
					{
						num2 = b2;
					}
				}
			}
			if (num2 > 0)
			{
				num3 += num2;
			}
			if (num < num3)
			{
				num = num3;
				combatSkillType = b;
			}
		}
		return (sbyte)Math.Clamp(num, 0, GlobalConfig.Instance.MaxConsummateLevel);
	}

	private unsafe static sbyte Test_CalcMaxConsummateLevel2(short[] combatSkillAttainmentPanels, ref sbyte combatSkillType)
	{
		short* ptr = stackalloc short[9] { 10, 10, 10, 10, 15, 15, 20, 30, 40 };
		int num = -1;
		for (sbyte b = 0; b < 14; b++)
		{
			int num2 = 0;
			for (sbyte b2 = 0; b2 <= 8; b2++)
			{
				int num3 = 9 * b + b2;
				short num4 = combatSkillAttainmentPanels[num3];
				if (num4 >= 0)
				{
					num2 += ptr[b2];
				}
			}
			int num5 = num2 / 10;
			if (num < num5)
			{
				num = num5;
				combatSkillType = b;
			}
		}
		return (sbyte)Math.Clamp(num, 0, GlobalConfig.Instance.MaxConsummateLevel);
	}

	private unsafe static sbyte Test_CalcMaxConsummateLevel3(short[] combatSkillAttainmentPanels, ref sbyte combatSkillType)
	{
		short* ptr = stackalloc short[9] { 5, 10, 15, 20, 25, 30, 35, 45, 55 };
		int num = -1;
		for (sbyte b = 0; b < 14; b++)
		{
			int num2 = 0;
			int num3 = 0;
			int num4 = 0;
			int num5 = 0;
			for (sbyte b2 = 0; b2 <= 8; b2++)
			{
				int num6 = 9 * b + b2;
				short num7 = combatSkillAttainmentPanels[num6];
				if (num7 >= 0)
				{
					if (b2 != 0)
					{
						num2++;
					}
					short val = ptr[b2];
					switch (Grade.GetGroup(b2))
					{
					case 0:
						num3 = Math.Max(val, num3);
						break;
					case 1:
						num4 = Math.Max(val, num4);
						break;
					case 2:
						num5 = Math.Max(val, num5);
						break;
					}
				}
			}
			num2 += (num3 + num4 + num5) / 10;
			if (num < num2)
			{
				num = num2;
				combatSkillType = b;
			}
		}
		return (sbyte)Math.Clamp(num, 0, GlobalConfig.Instance.MaxConsummateLevel);
	}

	public CharacterDomain()
		: base(30)
	{
		_objects = new Dictionary<int, Character>(8192);
		_nextObjectId = 0;
		_deadCharacters = new Dictionary<int, DeadCharacter>(65536);
		_deadCharDeletionStates = new Dictionary<int, DeadCharDeletionState>(0);
		_recentDeadCharacters = new SortedSetAsDictionary<IntPair>();
		_waitingReincarnationChars = new SortedSetAsDictionary<IntPair>();
		_graves = new Dictionary<int, Grave>(16384);
		_pregnantStates = new Dictionary<int, PregnantState>(0);
		_pregnancyLockEndDates = new Dictionary<int, int>(0);
		_unguardedChars = default(CharacterSet);
		_kidnappedChars = new Dictionary<int, KidnappedCharacterList>(0);
		_relations = new Dictionary<RelationKey, RelatedCharacter>(0);
		_actualBloodParents = new Dictionary<ParentAndChild, int>(0);
		_characterGroups = new Dictionary<int, CharacterSet>(0);
		_joinGroupDates = new Dictionary<int, int>(0);
		_debtsToTaiwu = new Dictionary<int, Debts>(0);
		_soldLibrarySkillBooks = new Dictionary<int, GameData.Utilities.ShortList>(0);
		_usedCombatResourceObsoletes = new Dictionary<int, CombatResourcesObsolete>(0);
		_avatarElementGrowthProgress = new Dictionary<int, AvatarElementsGrownDates>(0);
		_targetedForAssassination = string.Empty;
		_prioritizedActions = new Dictionary<int, PrioritizedActionWrapper>(0);
		_crossAreaMoveInfos = new Dictionary<int, CrossAreaMoveInfo>(0);
		_ongoingVengeances = new Dictionary<int, CharacterSet>(0);
		_mournedOthersChars = default(CharacterSet);
		_pregeneratedCityTownGuards = new int[288];
		_pregeneratedRandomEnemies = new List<int>();
		_forceRebelLocation = default(Location);
		_forceKindLocation = default(Location);
		_avoidDeathCharId = 0;
		_subscriberOrders = new Dictionary<int, CharacterList>(0);
		HelperDataObjects = new ObjectCollectionHelperData(4, 0, CacheInfluencesObjects, _dataStatesObjects, isArchive: true);
		HelperDataGraves = new ObjectCollectionHelperData(4, 6, CacheInfluencesGraves, _dataStatesGraves, isArchive: true);
		OnInitializedDomainData();
	}

	public Character GetElement_Objects(int objectId)
	{
		return _objects[objectId];
	}

	public bool TryGetElement_Objects(int objectId, out Character element)
	{
		return _objects.TryGetValue(objectId, out element);
	}

	private unsafe void AddElement_Objects(int objectId, Character instance)
	{
		instance.CollectionHelperData = HelperDataObjects;
		instance.DataStatesOffset = _dataStatesObjects.Create();
		_objects.Add(objectId, instance);
		byte* pData = OperationAdder.DynamicObjectCollection_Add(4, 0, objectId, instance.GetSerializedSize());
		instance.Serialize(pData);
	}

	private void RemoveElement_Objects(int objectId)
	{
		if (_objects.TryGetValue(objectId, out var value))
		{
			_dataStatesObjects.Remove(value.DataStatesOffset);
			_objects.Remove(objectId);
			OperationAdder.DynamicObjectCollection_Remove(4, 0, objectId);
		}
	}

	private void ClearObjects()
	{
		_dataStatesObjects.Clear();
		_objects.Clear();
		OperationAdder.DynamicObjectCollection_Clear(4, 0);
	}

	public int GetElementField_Objects(int objectId, ushort fieldId, RawDataPool dataPool, bool resetModified)
	{
		if (!_objects.TryGetValue(objectId, out var value))
		{
			AdaptableLog.TagWarning("GetElementField_Objects", $"Failed to find element {objectId} with field {fieldId}");
			return -1;
		}
		if (resetModified)
		{
			_dataStatesObjects.ResetModified(value.DataStatesOffset, fieldId);
		}
		switch (fieldId)
		{
		case 0:
			return GameData.Serializer.Serializer.Serialize(value.GetId(), dataPool);
		case 1:
			return GameData.Serializer.Serializer.Serialize(value.GetTemplateId(), dataPool);
		case 2:
			return GameData.Serializer.Serializer.Serialize(value.GetCreatingType(), dataPool);
		case 3:
			return GameData.Serializer.Serializer.Serialize(value.GetGender(), dataPool);
		case 4:
			return GameData.Serializer.Serializer.Serialize(value.GetActualAge(), dataPool);
		case 5:
			return GameData.Serializer.Serializer.Serialize(value.GetBirthMonth(), dataPool);
		case 6:
			return GameData.Serializer.Serializer.Serialize(value.GetHappiness(), dataPool);
		case 7:
			return GameData.Serializer.Serializer.Serialize(value.GetBaseMorality(), dataPool);
		case 8:
			return GameData.Serializer.Serializer.Serialize(value.GetOrganizationInfo(), dataPool);
		case 9:
			return GameData.Serializer.Serializer.Serialize(value.GetIdealSect(), dataPool);
		case 10:
			return GameData.Serializer.Serializer.Serialize(value.GetLifeSkillTypeInterest(), dataPool);
		case 11:
			return GameData.Serializer.Serializer.Serialize(value.GetCombatSkillTypeInterest(), dataPool);
		case 12:
			return GameData.Serializer.Serializer.Serialize(value.GetMainAttributeInterest(), dataPool);
		case 13:
			return GameData.Serializer.Serializer.Serialize(value.GetTransgender(), dataPool);
		case 14:
			return GameData.Serializer.Serializer.Serialize(value.GetBisexual(), dataPool);
		case 15:
			return GameData.Serializer.Serializer.Serialize(value.GetXiangshuType(), dataPool);
		case 16:
			return GameData.Serializer.Serializer.Serialize(value.GetMonkType(), dataPool);
		case 17:
			return GameData.Serializer.Serializer.Serialize(value.GetFeatureIds(), dataPool);
		case 18:
			return GameData.Serializer.Serializer.Serialize(value.GetBaseMainAttributes(), dataPool);
		case 19:
			return GameData.Serializer.Serializer.Serialize(value.GetHealth(), dataPool);
		case 20:
			return GameData.Serializer.Serializer.Serialize(value.GetBaseMaxHealth(), dataPool);
		case 21:
			return GameData.Serializer.Serializer.Serialize(value.GetDisorderOfQi(), dataPool);
		case 22:
			return GameData.Serializer.Serializer.Serialize(value.GetHaveLeftArm(), dataPool);
		case 23:
			return GameData.Serializer.Serializer.Serialize(value.GetHaveRightArm(), dataPool);
		case 24:
			return GameData.Serializer.Serializer.Serialize(value.GetHaveLeftLeg(), dataPool);
		case 25:
			return GameData.Serializer.Serializer.Serialize(value.GetHaveRightLeg(), dataPool);
		case 26:
			return GameData.Serializer.Serializer.Serialize(value.GetInjuries(), dataPool);
		case 27:
			return GameData.Serializer.Serializer.Serialize(value.GetExtraNeili(), dataPool);
		case 28:
			return GameData.Serializer.Serializer.Serialize(value.GetConsummateLevel(), dataPool);
		case 29:
			return GameData.Serializer.Serializer.Serialize(value.GetLearnedLifeSkills(), dataPool);
		case 30:
			return GameData.Serializer.Serializer.Serialize(value.GetBaseLifeSkillQualifications(), dataPool);
		case 31:
			return GameData.Serializer.Serializer.Serialize(value.GetLifeSkillQualificationGrowthType(), dataPool);
		case 32:
			return GameData.Serializer.Serializer.Serialize(value.GetBaseCombatSkillQualifications(), dataPool);
		case 33:
			return GameData.Serializer.Serializer.Serialize(value.GetCombatSkillQualificationGrowthType(), dataPool);
		case 34:
			return GameData.Serializer.Serializer.Serialize(value.GetResources(), dataPool);
		case 35:
			return GameData.Serializer.Serializer.Serialize(value.GetLovingItemSubType(), dataPool);
		case 36:
			return GameData.Serializer.Serializer.Serialize(value.GetHatingItemSubType(), dataPool);
		case 37:
			return GameData.Serializer.Serializer.Serialize(value.GetFullName(), dataPool);
		case 38:
			return GameData.Serializer.Serializer.Serialize(value.GetMonasticTitle(), dataPool);
		case 39:
			return GameData.Serializer.Serializer.Serialize(value.GetAvatar(), dataPool);
		case 40:
			return GameData.Serializer.Serializer.Serialize(value.GetPotentialFeatureIds(), dataPool);
		case 41:
			return GameData.Serializer.Serializer.Serialize(value.GetFameActionRecords(), dataPool);
		case 42:
			return GameData.Serializer.Serializer.Serialize(value.GetGenome(), dataPool);
		case 43:
			return GameData.Serializer.Serializer.Serialize(value.GetCurrMainAttributes(), dataPool);
		case 44:
			return GameData.Serializer.Serializer.Serialize(value.GetPoisoned(), dataPool);
		case 45:
			return GameData.Serializer.Serializer.Serialize(value.GetInjuriesRecoveryProgress(), dataPool);
		case 46:
			return GameData.Serializer.Serializer.Serialize(value.GetCurrNeili(), dataPool);
		case 47:
			return GameData.Serializer.Serializer.Serialize(value.GetLoopingNeigong(), dataPool);
		case 48:
			return GameData.Serializer.Serializer.Serialize(value.GetBaseNeiliAllocation(), dataPool);
		case 49:
			return GameData.Serializer.Serializer.Serialize(value.GetExtraNeiliAllocation(), dataPool);
		case 50:
			return GameData.Serializer.Serializer.Serialize(value.GetBaseNeiliProportionOfFiveElements(), dataPool);
		case 51:
			return GameData.Serializer.Serializer.Serialize(value.GetHobbyExpirationDate(), dataPool);
		case 52:
			return GameData.Serializer.Serializer.Serialize(value.GetLovingItemRevealed(), dataPool);
		case 53:
			return GameData.Serializer.Serializer.Serialize(value.GetHatingItemRevealed(), dataPool);
		case 54:
			return GameData.Serializer.Serializer.Serialize(value.GetLegitimateBoysCount(), dataPool);
		case 55:
			return GameData.Serializer.Serializer.Serialize(value.GetBirthLocation(), dataPool);
		case 56:
			return GameData.Serializer.Serializer.Serialize(value.GetLocation(), dataPool);
		case 57:
			return GameData.Serializer.Serializer.Serialize(value.GetEquipment(), dataPool);
		case 58:
			return GameData.Serializer.Serializer.Serialize(value.GetInventory(), dataPool);
		case 59:
			return GameData.Serializer.Serializer.Serialize(value.GetEatingItems(), dataPool);
		case 60:
			return GameData.Serializer.Serializer.Serialize(value.GetLearnedCombatSkills(), dataPool);
		case 61:
			return GameData.Serializer.Serializer.Serialize(value.GetEquippedCombatSkills(), dataPool);
		case 62:
			return GameData.Serializer.Serializer.Serialize(value.GetCombatSkillAttainmentPanels(), dataPool);
		case 63:
			return GameData.Serializer.Serializer.Serialize(value.GetSkillQualificationBonuses(), dataPool);
		case 64:
			return GameData.Serializer.Serializer.Serialize(value.GetPreexistenceCharIds(), dataPool);
		case 65:
			return GameData.Serializer.Serializer.Serialize(value.GetXiangshuInfection(), dataPool);
		case 66:
			return GameData.Serializer.Serializer.Serialize(value.GetCurrAge(), dataPool);
		case 67:
			return GameData.Serializer.Serializer.Serialize(value.GetExp(), dataPool);
		case 68:
			return GameData.Serializer.Serializer.Serialize(value.GetExternalRelationState(), dataPool);
		case 69:
			return GameData.Serializer.Serializer.Serialize(value.GetKidnapperId(), dataPool);
		case 70:
			return GameData.Serializer.Serializer.Serialize(value.GetLeaderId(), dataPool);
		case 71:
			return GameData.Serializer.Serializer.Serialize(value.GetFactionId(), dataPool);
		case 72:
			return GameData.Serializer.Serializer.Serialize(value.GetPersonalNeeds(), dataPool);
		case 73:
			return GameData.Serializer.Serializer.Serialize(value.GetActionEnergies(), dataPool);
		case 74:
			return GameData.Serializer.Serializer.Serialize(value.GetNpcTravelTargets(), dataPool);
		case 75:
			return GameData.Serializer.Serializer.Serialize(value.GetPrioritizedActionCooldowns(), dataPool);
		case 76:
			return GameData.Serializer.Serializer.Serialize(value.GetPhysiologicalAge(), dataPool);
		case 77:
			return GameData.Serializer.Serializer.Serialize(value.GetFame(), dataPool);
		case 78:
			return GameData.Serializer.Serializer.Serialize(value.GetMorality(), dataPool);
		case 79:
			return GameData.Serializer.Serializer.Serialize(value.GetAttraction(), dataPool);
		case 80:
			return GameData.Serializer.Serializer.Serialize(value.GetMaxMainAttributes(), dataPool);
		case 81:
			return GameData.Serializer.Serializer.Serialize(value.GetHitValues(), dataPool);
		case 82:
			return GameData.Serializer.Serializer.Serialize(value.GetPenetrations(), dataPool);
		case 83:
			return GameData.Serializer.Serializer.Serialize(value.GetAvoidValues(), dataPool);
		case 84:
			return GameData.Serializer.Serializer.Serialize(value.GetPenetrationResists(), dataPool);
		case 85:
			return GameData.Serializer.Serializer.Serialize(value.GetRecoveryOfStanceAndBreath(), dataPool);
		case 86:
			return GameData.Serializer.Serializer.Serialize(value.GetMoveSpeed(), dataPool);
		case 87:
			return GameData.Serializer.Serializer.Serialize(value.GetRecoveryOfFlaw(), dataPool);
		case 88:
			return GameData.Serializer.Serializer.Serialize(value.GetCastSpeed(), dataPool);
		case 89:
			return GameData.Serializer.Serializer.Serialize(value.GetRecoveryOfBlockedAcupoint(), dataPool);
		case 90:
			return GameData.Serializer.Serializer.Serialize(value.GetWeaponSwitchSpeed(), dataPool);
		case 91:
			return GameData.Serializer.Serializer.Serialize(value.GetAttackSpeed(), dataPool);
		case 92:
			return GameData.Serializer.Serializer.Serialize(value.GetInnerRatio(), dataPool);
		case 93:
			return GameData.Serializer.Serializer.Serialize(value.GetRecoveryOfQiDisorder(), dataPool);
		case 94:
			return GameData.Serializer.Serializer.Serialize(value.GetPoisonResists(), dataPool);
		case 95:
			return GameData.Serializer.Serializer.Serialize(value.GetMaxHealth(), dataPool);
		case 96:
			return GameData.Serializer.Serializer.Serialize(value.GetFertility(), dataPool);
		case 97:
			return GameData.Serializer.Serializer.Serialize(value.GetLifeSkillQualifications(), dataPool);
		case 98:
			return GameData.Serializer.Serializer.Serialize(value.GetLifeSkillAttainments(), dataPool);
		case 99:
			return GameData.Serializer.Serializer.Serialize(value.GetCombatSkillQualifications(), dataPool);
		case 100:
			return GameData.Serializer.Serializer.Serialize(value.GetCombatSkillAttainments(), dataPool);
		case 101:
			return GameData.Serializer.Serializer.Serialize(value.GetPersonalities(), dataPool);
		case 102:
			return GameData.Serializer.Serializer.Serialize(value.GetHobbyChangingPeriod(), dataPool);
		case 103:
			return GameData.Serializer.Serializer.Serialize(value.GetFavorabilityChangingFactor(), dataPool);
		case 104:
			return GameData.Serializer.Serializer.Serialize(value.GetMaxInventoryLoad(), dataPool);
		case 105:
			return GameData.Serializer.Serializer.Serialize(value.GetCurrInventoryLoad(), dataPool);
		case 106:
			return GameData.Serializer.Serializer.Serialize(value.GetMaxEquipmentLoad(), dataPool);
		case 107:
			return GameData.Serializer.Serializer.Serialize(value.GetCurrEquipmentLoad(), dataPool);
		case 108:
			return GameData.Serializer.Serializer.Serialize(value.GetInventoryTotalValue(), dataPool);
		case 109:
			return GameData.Serializer.Serializer.Serialize(value.GetMaxNeili(), dataPool);
		case 110:
			return GameData.Serializer.Serializer.Serialize(value.GetNeiliAllocation(), dataPool);
		case 111:
			return GameData.Serializer.Serializer.Serialize(value.GetNeiliProportionOfFiveElements(), dataPool);
		case 112:
			return GameData.Serializer.Serializer.Serialize(value.GetNeiliType(), dataPool);
		case 113:
			return GameData.Serializer.Serializer.Serialize(value.GetCombatPower(), dataPool);
		case 114:
			return GameData.Serializer.Serializer.Serialize(value.GetAttackTendencyOfInnerAndOuter(), dataPool);
		case 115:
			return GameData.Serializer.Serializer.Serialize(value.GetAllocatedNeiliEffects(), dataPool);
		case 116:
			return GameData.Serializer.Serializer.Serialize(value.GetMaxConsummateLevel(), dataPool);
		case 117:
			return GameData.Serializer.Serializer.Serialize(value.GetCombatSkillEquipment(), dataPool);
		case 118:
			return GameData.Serializer.Serializer.Serialize(value.GetDarkAshProtector(), dataPool);
		default:
			if (fieldId >= 195)
			{
				throw new Exception($"Unsupported fieldId {fieldId}");
			}
			throw new Exception($"Not allow to get readonly field data: {fieldId}");
		}
	}

	public void SetElementField_Objects(int objectId, ushort fieldId, int valueOffset, RawDataPool dataPool, DataContext context)
	{
		if (!_objects.TryGetValue(objectId, out var value))
		{
			throw new Exception($"Failed to find element {objectId} with field {fieldId}");
		}
		switch (fieldId)
		{
		case 0:
			throw new Exception($"Not allow to set readonly field data: {fieldId}");
		case 1:
			throw new Exception($"Not allow to set readonly field data: {fieldId}");
		case 2:
			throw new Exception($"Not allow to set readonly field data: {fieldId}");
		case 3:
			throw new Exception($"Not allow to set readonly field data: {fieldId}");
		case 4:
		{
			short item65 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item65);
			value.SetActualAge(item65, context);
			return;
		}
		case 5:
			throw new Exception($"Not allow to set readonly field data: {fieldId}");
		case 6:
		{
			sbyte item64 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item64);
			value.SetHappiness(item64, context);
			return;
		}
		case 7:
		{
			short item63 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item63);
			value.SetBaseMorality(item63, context);
			return;
		}
		case 8:
		{
			OrganizationInfo item62 = default(OrganizationInfo);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item62);
			value.SetOrganizationInfo(item62, context);
			return;
		}
		case 9:
		{
			sbyte item61 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item61);
			value.SetIdealSect(item61, context);
			return;
		}
		case 10:
		{
			sbyte item60 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item60);
			value.SetLifeSkillTypeInterest(item60, context);
			return;
		}
		case 11:
		{
			sbyte item59 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item59);
			value.SetCombatSkillTypeInterest(item59, context);
			return;
		}
		case 12:
		{
			sbyte item58 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item58);
			value.SetMainAttributeInterest(item58, context);
			return;
		}
		case 13:
			throw new Exception($"Not allow to set readonly field data: {fieldId}");
		case 14:
			throw new Exception($"Not allow to set readonly field data: {fieldId}");
		case 15:
			throw new Exception($"Not allow to set readonly field data: {fieldId}");
		case 16:
		{
			byte item57 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item57);
			value.SetMonkType(item57, context);
			return;
		}
		case 17:
		{
			List<short> item56 = value.GetFeatureIds();
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item56);
			value.SetFeatureIds(item56, context);
			return;
		}
		case 18:
		{
			MainAttributes item55 = default(MainAttributes);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item55);
			value.SetBaseMainAttributes(item55, context);
			return;
		}
		case 19:
		{
			short item54 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item54);
			value.SetHealth(item54, context);
			return;
		}
		case 20:
		{
			short item53 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item53);
			value.SetBaseMaxHealth(item53, context);
			return;
		}
		case 21:
		{
			short item52 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item52);
			value.SetDisorderOfQi(item52, context);
			return;
		}
		case 22:
		{
			bool item51 = false;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item51);
			value.SetHaveLeftArm(item51, context);
			return;
		}
		case 23:
		{
			bool item50 = false;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item50);
			value.SetHaveRightArm(item50, context);
			return;
		}
		case 24:
		{
			bool item49 = false;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item49);
			value.SetHaveLeftLeg(item49, context);
			return;
		}
		case 25:
		{
			bool item48 = false;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item48);
			value.SetHaveRightLeg(item48, context);
			return;
		}
		case 26:
		{
			Injuries item47 = default(Injuries);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item47);
			value.SetInjuries(item47, context);
			return;
		}
		case 27:
		{
			int item46 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item46);
			value.SetExtraNeili(item46, context);
			return;
		}
		case 28:
		{
			sbyte item45 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item45);
			value.SetConsummateLevel(item45, context);
			return;
		}
		case 29:
		{
			List<LifeSkillItem> item44 = value.GetLearnedLifeSkills();
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item44);
			value.SetLearnedLifeSkills(item44, context);
			return;
		}
		case 30:
		{
			LifeSkillShorts item43 = default(LifeSkillShorts);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item43);
			value.SetBaseLifeSkillQualifications(ref item43, context);
			return;
		}
		case 31:
		{
			sbyte item42 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item42);
			value.SetLifeSkillQualificationGrowthType(item42, context);
			return;
		}
		case 32:
		{
			CombatSkillShorts item41 = default(CombatSkillShorts);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item41);
			value.SetBaseCombatSkillQualifications(ref item41, context);
			return;
		}
		case 33:
		{
			sbyte item40 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item40);
			value.SetCombatSkillQualificationGrowthType(item40, context);
			return;
		}
		case 34:
		{
			ResourceInts item39 = default(ResourceInts);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item39);
			value.SetResources(ref item39, context);
			return;
		}
		case 35:
		{
			short item38 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item38);
			value.SetLovingItemSubType(item38, context);
			return;
		}
		case 36:
		{
			short item37 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item37);
			value.SetHatingItemSubType(item37, context);
			return;
		}
		case 37:
		{
			FullName item36 = default(FullName);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item36);
			value.SetFullName(item36, context);
			return;
		}
		case 38:
		{
			MonasticTitle item35 = default(MonasticTitle);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item35);
			value.SetMonasticTitle(item35, context);
			return;
		}
		case 39:
		{
			AvatarData item34 = value.GetAvatar();
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item34);
			value.SetAvatar(item34, context);
			return;
		}
		case 40:
		{
			List<short> item33 = value.GetPotentialFeatureIds();
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item33);
			value.SetPotentialFeatureIds(item33, context);
			return;
		}
		case 41:
		{
			List<FameActionRecord> item32 = value.GetFameActionRecords();
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item32);
			value.SetFameActionRecords(item32, context);
			return;
		}
		case 42:
			throw new Exception($"Not allow to set readonly field data: {fieldId}");
		case 43:
		{
			MainAttributes item31 = default(MainAttributes);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item31);
			value.SetCurrMainAttributes(item31, context);
			return;
		}
		case 44:
		{
			PoisonInts item30 = default(PoisonInts);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item30);
			value.SetPoisoned(ref item30, context);
			return;
		}
		case 45:
		{
			byte[] item29 = value.GetInjuriesRecoveryProgress();
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item29);
			value.SetInjuriesRecoveryProgress(item29, context);
			return;
		}
		case 46:
		{
			int item28 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item28);
			value.SetCurrNeili(item28, context);
			return;
		}
		case 47:
		{
			short item27 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item27);
			value.SetLoopingNeigong(item27, context);
			return;
		}
		case 48:
		{
			NeiliAllocation item26 = default(NeiliAllocation);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item26);
			value.SetBaseNeiliAllocation(item26, context);
			return;
		}
		case 49:
		{
			NeiliAllocation item25 = default(NeiliAllocation);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item25);
			value.SetExtraNeiliAllocation(item25, context);
			return;
		}
		case 50:
		{
			NeiliProportionOfFiveElements item24 = default(NeiliProportionOfFiveElements);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item24);
			value.SetBaseNeiliProportionOfFiveElements(item24, context);
			return;
		}
		case 51:
		{
			int item23 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item23);
			value.SetHobbyExpirationDate(item23, context);
			return;
		}
		case 52:
		{
			bool item22 = false;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item22);
			value.SetLovingItemRevealed(item22, context);
			return;
		}
		case 53:
		{
			bool item21 = false;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item21);
			value.SetHatingItemRevealed(item21, context);
			return;
		}
		case 54:
		{
			sbyte item20 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item20);
			value.SetLegitimateBoysCount(item20, context);
			return;
		}
		case 55:
			throw new Exception($"Not allow to set readonly field data: {fieldId}");
		case 56:
		{
			Location item19 = default(Location);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item19);
			value.SetLocation(item19, context);
			return;
		}
		case 57:
		{
			ItemKey[] item18 = value.GetEquipment();
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item18);
			value.SetEquipment(item18, context);
			return;
		}
		case 58:
		{
			Inventory item17 = value.GetInventory();
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item17);
			value.SetInventory(item17, context);
			return;
		}
		case 59:
		{
			EatingItems item16 = default(EatingItems);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item16);
			value.SetEatingItems(ref item16, context);
			return;
		}
		case 60:
		{
			List<short> item15 = value.GetLearnedCombatSkills();
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item15);
			value.SetLearnedCombatSkills(item15, context);
			return;
		}
		case 61:
		{
			short[] item14 = value.GetEquippedCombatSkills();
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item14);
			value.SetEquippedCombatSkills(item14, context);
			return;
		}
		case 62:
		{
			short[] item13 = value.GetCombatSkillAttainmentPanels();
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item13);
			value.SetCombatSkillAttainmentPanels(item13, context);
			return;
		}
		case 63:
		{
			List<SkillQualificationBonus> item12 = value.GetSkillQualificationBonuses();
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item12);
			value.SetSkillQualificationBonuses(item12, context);
			return;
		}
		case 64:
			throw new Exception($"Not allow to set readonly field data: {fieldId}");
		case 65:
		{
			byte item11 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item11);
			value.SetXiangshuInfection(item11, context);
			return;
		}
		case 66:
		{
			short item10 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item10);
			value.SetCurrAge(item10, context);
			return;
		}
		case 67:
		{
			int item9 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item9);
			value.SetExp(item9, context);
			return;
		}
		case 68:
		{
			byte item8 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item8);
			value.SetExternalRelationState(item8, context);
			return;
		}
		case 69:
		{
			int item7 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item7);
			value.SetKidnapperId(item7, context);
			return;
		}
		case 70:
		{
			int item6 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item6);
			value.SetLeaderId(item6, context);
			return;
		}
		case 71:
		{
			int item5 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item5);
			value.SetFactionId(item5, context);
			return;
		}
		case 72:
		{
			List<GameData.Domains.Character.Ai.PersonalNeed> item4 = value.GetPersonalNeeds();
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item4);
			value.SetPersonalNeeds(item4, context);
			return;
		}
		case 73:
		{
			ActionEnergySbytes item3 = default(ActionEnergySbytes);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item3);
			value.SetActionEnergies(item3, context);
			return;
		}
		case 74:
		{
			List<NpcTravelTarget> item2 = value.GetNpcTravelTargets();
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item2);
			value.SetNpcTravelTargets(item2, context);
			return;
		}
		case 75:
		{
			PrioritizedActionCooldownSbytes item = default(PrioritizedActionCooldownSbytes);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item);
			value.SetPrioritizedActionCooldowns(item, context);
			return;
		}
		}
		if (fieldId >= 195)
		{
			throw new Exception($"Unsupported fieldId {fieldId}");
		}
		if (fieldId >= 119)
		{
			throw new Exception($"Not allow to set readonly field data: {fieldId}");
		}
		throw new Exception($"Not allow to set cache field data: {fieldId}");
	}

	private int CheckModified_Objects(int objectId, ushort fieldId, RawDataPool dataPool)
	{
		if (!_objects.TryGetValue(objectId, out var value))
		{
			return -1;
		}
		if (fieldId >= 119)
		{
			throw new Exception($"Not allow to check readonly field data: {fieldId}");
		}
		if (!_dataStatesObjects.IsModified(value.DataStatesOffset, fieldId))
		{
			return -1;
		}
		_dataStatesObjects.ResetModified(value.DataStatesOffset, fieldId);
		return fieldId switch
		{
			0 => GameData.Serializer.Serializer.Serialize(value.GetId(), dataPool), 
			1 => GameData.Serializer.Serializer.Serialize(value.GetTemplateId(), dataPool), 
			2 => GameData.Serializer.Serializer.Serialize(value.GetCreatingType(), dataPool), 
			3 => GameData.Serializer.Serializer.Serialize(value.GetGender(), dataPool), 
			4 => GameData.Serializer.Serializer.Serialize(value.GetActualAge(), dataPool), 
			5 => GameData.Serializer.Serializer.Serialize(value.GetBirthMonth(), dataPool), 
			6 => GameData.Serializer.Serializer.Serialize(value.GetHappiness(), dataPool), 
			7 => GameData.Serializer.Serializer.Serialize(value.GetBaseMorality(), dataPool), 
			8 => GameData.Serializer.Serializer.Serialize(value.GetOrganizationInfo(), dataPool), 
			9 => GameData.Serializer.Serializer.Serialize(value.GetIdealSect(), dataPool), 
			10 => GameData.Serializer.Serializer.Serialize(value.GetLifeSkillTypeInterest(), dataPool), 
			11 => GameData.Serializer.Serializer.Serialize(value.GetCombatSkillTypeInterest(), dataPool), 
			12 => GameData.Serializer.Serializer.Serialize(value.GetMainAttributeInterest(), dataPool), 
			13 => GameData.Serializer.Serializer.Serialize(value.GetTransgender(), dataPool), 
			14 => GameData.Serializer.Serializer.Serialize(value.GetBisexual(), dataPool), 
			15 => GameData.Serializer.Serializer.Serialize(value.GetXiangshuType(), dataPool), 
			16 => GameData.Serializer.Serializer.Serialize(value.GetMonkType(), dataPool), 
			17 => GameData.Serializer.Serializer.Serialize(value.GetFeatureIds(), dataPool), 
			18 => GameData.Serializer.Serializer.Serialize(value.GetBaseMainAttributes(), dataPool), 
			19 => GameData.Serializer.Serializer.Serialize(value.GetHealth(), dataPool), 
			20 => GameData.Serializer.Serializer.Serialize(value.GetBaseMaxHealth(), dataPool), 
			21 => GameData.Serializer.Serializer.Serialize(value.GetDisorderOfQi(), dataPool), 
			22 => GameData.Serializer.Serializer.Serialize(value.GetHaveLeftArm(), dataPool), 
			23 => GameData.Serializer.Serializer.Serialize(value.GetHaveRightArm(), dataPool), 
			24 => GameData.Serializer.Serializer.Serialize(value.GetHaveLeftLeg(), dataPool), 
			25 => GameData.Serializer.Serializer.Serialize(value.GetHaveRightLeg(), dataPool), 
			26 => GameData.Serializer.Serializer.Serialize(value.GetInjuries(), dataPool), 
			27 => GameData.Serializer.Serializer.Serialize(value.GetExtraNeili(), dataPool), 
			28 => GameData.Serializer.Serializer.Serialize(value.GetConsummateLevel(), dataPool), 
			29 => GameData.Serializer.Serializer.Serialize(value.GetLearnedLifeSkills(), dataPool), 
			30 => GameData.Serializer.Serializer.Serialize(value.GetBaseLifeSkillQualifications(), dataPool), 
			31 => GameData.Serializer.Serializer.Serialize(value.GetLifeSkillQualificationGrowthType(), dataPool), 
			32 => GameData.Serializer.Serializer.Serialize(value.GetBaseCombatSkillQualifications(), dataPool), 
			33 => GameData.Serializer.Serializer.Serialize(value.GetCombatSkillQualificationGrowthType(), dataPool), 
			34 => GameData.Serializer.Serializer.Serialize(value.GetResources(), dataPool), 
			35 => GameData.Serializer.Serializer.Serialize(value.GetLovingItemSubType(), dataPool), 
			36 => GameData.Serializer.Serializer.Serialize(value.GetHatingItemSubType(), dataPool), 
			37 => GameData.Serializer.Serializer.Serialize(value.GetFullName(), dataPool), 
			38 => GameData.Serializer.Serializer.Serialize(value.GetMonasticTitle(), dataPool), 
			39 => GameData.Serializer.Serializer.Serialize(value.GetAvatar(), dataPool), 
			40 => GameData.Serializer.Serializer.Serialize(value.GetPotentialFeatureIds(), dataPool), 
			41 => GameData.Serializer.Serializer.Serialize(value.GetFameActionRecords(), dataPool), 
			42 => GameData.Serializer.Serializer.Serialize(value.GetGenome(), dataPool), 
			43 => GameData.Serializer.Serializer.Serialize(value.GetCurrMainAttributes(), dataPool), 
			44 => GameData.Serializer.Serializer.Serialize(value.GetPoisoned(), dataPool), 
			45 => GameData.Serializer.Serializer.Serialize(value.GetInjuriesRecoveryProgress(), dataPool), 
			46 => GameData.Serializer.Serializer.Serialize(value.GetCurrNeili(), dataPool), 
			47 => GameData.Serializer.Serializer.Serialize(value.GetLoopingNeigong(), dataPool), 
			48 => GameData.Serializer.Serializer.Serialize(value.GetBaseNeiliAllocation(), dataPool), 
			49 => GameData.Serializer.Serializer.Serialize(value.GetExtraNeiliAllocation(), dataPool), 
			50 => GameData.Serializer.Serializer.Serialize(value.GetBaseNeiliProportionOfFiveElements(), dataPool), 
			51 => GameData.Serializer.Serializer.Serialize(value.GetHobbyExpirationDate(), dataPool), 
			52 => GameData.Serializer.Serializer.Serialize(value.GetLovingItemRevealed(), dataPool), 
			53 => GameData.Serializer.Serializer.Serialize(value.GetHatingItemRevealed(), dataPool), 
			54 => GameData.Serializer.Serializer.Serialize(value.GetLegitimateBoysCount(), dataPool), 
			55 => GameData.Serializer.Serializer.Serialize(value.GetBirthLocation(), dataPool), 
			56 => GameData.Serializer.Serializer.Serialize(value.GetLocation(), dataPool), 
			57 => GameData.Serializer.Serializer.Serialize(value.GetEquipment(), dataPool), 
			58 => GameData.Serializer.Serializer.Serialize(value.GetInventory(), dataPool), 
			59 => GameData.Serializer.Serializer.Serialize(value.GetEatingItems(), dataPool), 
			60 => GameData.Serializer.Serializer.Serialize(value.GetLearnedCombatSkills(), dataPool), 
			61 => GameData.Serializer.Serializer.Serialize(value.GetEquippedCombatSkills(), dataPool), 
			62 => GameData.Serializer.Serializer.Serialize(value.GetCombatSkillAttainmentPanels(), dataPool), 
			63 => GameData.Serializer.Serializer.Serialize(value.GetSkillQualificationBonuses(), dataPool), 
			64 => GameData.Serializer.Serializer.Serialize(value.GetPreexistenceCharIds(), dataPool), 
			65 => GameData.Serializer.Serializer.Serialize(value.GetXiangshuInfection(), dataPool), 
			66 => GameData.Serializer.Serializer.Serialize(value.GetCurrAge(), dataPool), 
			67 => GameData.Serializer.Serializer.Serialize(value.GetExp(), dataPool), 
			68 => GameData.Serializer.Serializer.Serialize(value.GetExternalRelationState(), dataPool), 
			69 => GameData.Serializer.Serializer.Serialize(value.GetKidnapperId(), dataPool), 
			70 => GameData.Serializer.Serializer.Serialize(value.GetLeaderId(), dataPool), 
			71 => GameData.Serializer.Serializer.Serialize(value.GetFactionId(), dataPool), 
			72 => GameData.Serializer.Serializer.Serialize(value.GetPersonalNeeds(), dataPool), 
			73 => GameData.Serializer.Serializer.Serialize(value.GetActionEnergies(), dataPool), 
			74 => GameData.Serializer.Serializer.Serialize(value.GetNpcTravelTargets(), dataPool), 
			75 => GameData.Serializer.Serializer.Serialize(value.GetPrioritizedActionCooldowns(), dataPool), 
			76 => GameData.Serializer.Serializer.Serialize(value.GetPhysiologicalAge(), dataPool), 
			77 => GameData.Serializer.Serializer.Serialize(value.GetFame(), dataPool), 
			78 => GameData.Serializer.Serializer.Serialize(value.GetMorality(), dataPool), 
			79 => GameData.Serializer.Serializer.Serialize(value.GetAttraction(), dataPool), 
			80 => GameData.Serializer.Serializer.Serialize(value.GetMaxMainAttributes(), dataPool), 
			81 => GameData.Serializer.Serializer.Serialize(value.GetHitValues(), dataPool), 
			82 => GameData.Serializer.Serializer.Serialize(value.GetPenetrations(), dataPool), 
			83 => GameData.Serializer.Serializer.Serialize(value.GetAvoidValues(), dataPool), 
			84 => GameData.Serializer.Serializer.Serialize(value.GetPenetrationResists(), dataPool), 
			85 => GameData.Serializer.Serializer.Serialize(value.GetRecoveryOfStanceAndBreath(), dataPool), 
			86 => GameData.Serializer.Serializer.Serialize(value.GetMoveSpeed(), dataPool), 
			87 => GameData.Serializer.Serializer.Serialize(value.GetRecoveryOfFlaw(), dataPool), 
			88 => GameData.Serializer.Serializer.Serialize(value.GetCastSpeed(), dataPool), 
			89 => GameData.Serializer.Serializer.Serialize(value.GetRecoveryOfBlockedAcupoint(), dataPool), 
			90 => GameData.Serializer.Serializer.Serialize(value.GetWeaponSwitchSpeed(), dataPool), 
			91 => GameData.Serializer.Serializer.Serialize(value.GetAttackSpeed(), dataPool), 
			92 => GameData.Serializer.Serializer.Serialize(value.GetInnerRatio(), dataPool), 
			93 => GameData.Serializer.Serializer.Serialize(value.GetRecoveryOfQiDisorder(), dataPool), 
			94 => GameData.Serializer.Serializer.Serialize(value.GetPoisonResists(), dataPool), 
			95 => GameData.Serializer.Serializer.Serialize(value.GetMaxHealth(), dataPool), 
			96 => GameData.Serializer.Serializer.Serialize(value.GetFertility(), dataPool), 
			97 => GameData.Serializer.Serializer.Serialize(value.GetLifeSkillQualifications(), dataPool), 
			98 => GameData.Serializer.Serializer.Serialize(value.GetLifeSkillAttainments(), dataPool), 
			99 => GameData.Serializer.Serializer.Serialize(value.GetCombatSkillQualifications(), dataPool), 
			100 => GameData.Serializer.Serializer.Serialize(value.GetCombatSkillAttainments(), dataPool), 
			101 => GameData.Serializer.Serializer.Serialize(value.GetPersonalities(), dataPool), 
			102 => GameData.Serializer.Serializer.Serialize(value.GetHobbyChangingPeriod(), dataPool), 
			103 => GameData.Serializer.Serializer.Serialize(value.GetFavorabilityChangingFactor(), dataPool), 
			104 => GameData.Serializer.Serializer.Serialize(value.GetMaxInventoryLoad(), dataPool), 
			105 => GameData.Serializer.Serializer.Serialize(value.GetCurrInventoryLoad(), dataPool), 
			106 => GameData.Serializer.Serializer.Serialize(value.GetMaxEquipmentLoad(), dataPool), 
			107 => GameData.Serializer.Serializer.Serialize(value.GetCurrEquipmentLoad(), dataPool), 
			108 => GameData.Serializer.Serializer.Serialize(value.GetInventoryTotalValue(), dataPool), 
			109 => GameData.Serializer.Serializer.Serialize(value.GetMaxNeili(), dataPool), 
			110 => GameData.Serializer.Serializer.Serialize(value.GetNeiliAllocation(), dataPool), 
			111 => GameData.Serializer.Serializer.Serialize(value.GetNeiliProportionOfFiveElements(), dataPool), 
			112 => GameData.Serializer.Serializer.Serialize(value.GetNeiliType(), dataPool), 
			113 => GameData.Serializer.Serializer.Serialize(value.GetCombatPower(), dataPool), 
			114 => GameData.Serializer.Serializer.Serialize(value.GetAttackTendencyOfInnerAndOuter(), dataPool), 
			115 => GameData.Serializer.Serializer.Serialize(value.GetAllocatedNeiliEffects(), dataPool), 
			116 => GameData.Serializer.Serializer.Serialize(value.GetMaxConsummateLevel(), dataPool), 
			117 => GameData.Serializer.Serializer.Serialize(value.GetCombatSkillEquipment(), dataPool), 
			118 => GameData.Serializer.Serializer.Serialize(value.GetDarkAshProtector(), dataPool), 
			_ => throw new Exception($"Unsupported fieldId {fieldId}"), 
		};
	}

	private void ResetModifiedWrapper_Objects(int objectId, ushort fieldId)
	{
		if (_objects.TryGetValue(objectId, out var value))
		{
			if (fieldId >= 119)
			{
				throw new Exception($"Not allow to reset modification state of readonly field data: {fieldId}");
			}
			if (_dataStatesObjects.IsModified(value.DataStatesOffset, fieldId))
			{
				_dataStatesObjects.ResetModified(value.DataStatesOffset, fieldId);
			}
		}
	}

	private bool IsModifiedWrapper_Objects(int objectId, ushort fieldId)
	{
		if (!_objects.TryGetValue(objectId, out var value))
		{
			return false;
		}
		if (fieldId >= 119)
		{
			throw new Exception($"Not allow to check modification state of readonly field data: {fieldId}");
		}
		return _dataStatesObjects.IsModified(value.DataStatesOffset, fieldId);
	}

	private int GetNextObjectId()
	{
		return _nextObjectId;
	}

	private unsafe void SetNextObjectId(int value, DataContext context)
	{
		_nextObjectId = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(1, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValue_Set(4, 1, 4);
		*(int*)ptr = _nextObjectId;
		ptr += 4;
	}

	private DeadCharacter GetElement_DeadCharacters(int elementId)
	{
		return _deadCharacters[elementId];
	}

	private bool TryGetElement_DeadCharacters(int elementId, out DeadCharacter value)
	{
		return _deadCharacters.TryGetValue(elementId, out value);
	}

	private unsafe void AddElement_DeadCharacters(int elementId, DeadCharacter value, DataContext context)
	{
		_deadCharacters.Add(elementId, value);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(2, DataStates, CacheInfluences, context);
		if (value != null)
		{
			int serializedSize = value.GetSerializedSize();
			byte* ptr = OperationAdder.DynamicSingleValueCollection_Add(4, 2, elementId, serializedSize);
			ptr += value.Serialize(ptr);
		}
		else
		{
			OperationAdder.DynamicSingleValueCollection_Add(4, 2, elementId, 0);
		}
	}

	private unsafe void SetElement_DeadCharacters(int elementId, DeadCharacter value, DataContext context)
	{
		_deadCharacters[elementId] = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(2, DataStates, CacheInfluences, context);
		if (value != null)
		{
			int serializedSize = value.GetSerializedSize();
			byte* ptr = OperationAdder.DynamicSingleValueCollection_Set(4, 2, elementId, serializedSize);
			ptr += value.Serialize(ptr);
		}
		else
		{
			OperationAdder.DynamicSingleValueCollection_Set(4, 2, elementId, 0);
		}
	}

	private void RemoveElement_DeadCharacters(int elementId, DataContext context)
	{
		_deadCharacters.Remove(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(2, DataStates, CacheInfluences, context);
		OperationAdder.DynamicSingleValueCollection_Remove(4, 2, elementId);
	}

	private void ClearDeadCharacters(DataContext context)
	{
		_deadCharacters.Clear();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(2, DataStates, CacheInfluences, context);
		OperationAdder.DynamicSingleValueCollection_Clear(4, 2);
	}

	private DeadCharDeletionState GetElement_DeadCharDeletionStates(int elementId)
	{
		return _deadCharDeletionStates[elementId];
	}

	private bool TryGetElement_DeadCharDeletionStates(int elementId, out DeadCharDeletionState value)
	{
		return _deadCharDeletionStates.TryGetValue(elementId, out value);
	}

	private unsafe void AddElement_DeadCharDeletionStates(int elementId, DeadCharDeletionState value, DataContext context)
	{
		_deadCharDeletionStates.Add(elementId, value);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(3, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValueCollection_Add(4, 3, elementId, 2);
		ptr += value.Serialize(ptr);
	}

	private unsafe void SetElement_DeadCharDeletionStates(int elementId, DeadCharDeletionState value, DataContext context)
	{
		_deadCharDeletionStates[elementId] = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(3, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValueCollection_Set(4, 3, elementId, 2);
		ptr += value.Serialize(ptr);
	}

	private void RemoveElement_DeadCharDeletionStates(int elementId, DataContext context)
	{
		_deadCharDeletionStates.Remove(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(3, DataStates, CacheInfluences, context);
		OperationAdder.FixedSingleValueCollection_Remove(4, 3, elementId);
	}

	private void ClearDeadCharDeletionStates(DataContext context)
	{
		_deadCharDeletionStates.Clear();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(3, DataStates, CacheInfluences, context);
		OperationAdder.FixedSingleValueCollection_Clear(4, 3);
	}

	private VoidValue GetElement_RecentDeadCharacters(IntPair elementId)
	{
		return _recentDeadCharacters[elementId];
	}

	private bool TryGetElement_RecentDeadCharacters(IntPair elementId, out VoidValue value)
	{
		return _recentDeadCharacters.TryGetValue(elementId, out value);
	}

	private unsafe void AddElement_RecentDeadCharacters(IntPair elementId, VoidValue value, DataContext context)
	{
		_recentDeadCharacters.Add(elementId, value);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(4, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValueCollection_Add(4, 4, elementId, 0);
		ptr += value.Serialize(ptr);
	}

	private unsafe void SetElement_RecentDeadCharacters(IntPair elementId, VoidValue value, DataContext context)
	{
		_recentDeadCharacters[elementId] = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(4, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValueCollection_Set(4, 4, elementId, 0);
		ptr += value.Serialize(ptr);
	}

	private void RemoveElement_RecentDeadCharacters(IntPair elementId, DataContext context)
	{
		_recentDeadCharacters.Remove(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(4, DataStates, CacheInfluences, context);
		OperationAdder.FixedSingleValueCollection_Remove(4, 4, elementId);
	}

	private void ClearRecentDeadCharacters(DataContext context)
	{
		_recentDeadCharacters.Clear();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(4, DataStates, CacheInfluences, context);
		OperationAdder.FixedSingleValueCollection_Clear(4, 4);
	}

	private VoidValue GetElement_WaitingReincarnationChars(IntPair elementId)
	{
		return _waitingReincarnationChars[elementId];
	}

	private bool TryGetElement_WaitingReincarnationChars(IntPair elementId, out VoidValue value)
	{
		return _waitingReincarnationChars.TryGetValue(elementId, out value);
	}

	private unsafe void AddElement_WaitingReincarnationChars(IntPair elementId, VoidValue value, DataContext context)
	{
		_waitingReincarnationChars.Add(elementId, value);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(5, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValueCollection_Add(4, 5, elementId, 0);
		ptr += value.Serialize(ptr);
	}

	private unsafe void SetElement_WaitingReincarnationChars(IntPair elementId, VoidValue value, DataContext context)
	{
		_waitingReincarnationChars[elementId] = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(5, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValueCollection_Set(4, 5, elementId, 0);
		ptr += value.Serialize(ptr);
	}

	private void RemoveElement_WaitingReincarnationChars(IntPair elementId, DataContext context)
	{
		_waitingReincarnationChars.Remove(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(5, DataStates, CacheInfluences, context);
		OperationAdder.FixedSingleValueCollection_Remove(4, 5, elementId);
	}

	private void ClearWaitingReincarnationChars(DataContext context)
	{
		_waitingReincarnationChars.Clear();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(5, DataStates, CacheInfluences, context);
		OperationAdder.FixedSingleValueCollection_Clear(4, 5);
	}

	public Grave GetElement_Graves(int objectId)
	{
		return _graves[objectId];
	}

	public bool TryGetElement_Graves(int objectId, out Grave element)
	{
		return _graves.TryGetValue(objectId, out element);
	}

	private unsafe void AddElement_Graves(int objectId, Grave instance)
	{
		instance.CollectionHelperData = HelperDataGraves;
		instance.DataStatesOffset = _dataStatesGraves.Create();
		_graves.Add(objectId, instance);
		byte* pData = OperationAdder.DynamicObjectCollection_Add(4, 6, objectId, instance.GetSerializedSize());
		instance.Serialize(pData);
	}

	private void RemoveElement_Graves(int objectId)
	{
		if (_graves.TryGetValue(objectId, out var value))
		{
			_dataStatesGraves.Remove(value.DataStatesOffset);
			_graves.Remove(objectId);
			OperationAdder.DynamicObjectCollection_Remove(4, 6, objectId);
		}
	}

	private void ClearGraves()
	{
		_dataStatesGraves.Clear();
		_graves.Clear();
		OperationAdder.DynamicObjectCollection_Clear(4, 6);
	}

	public int GetElementField_Graves(int objectId, ushort fieldId, RawDataPool dataPool, bool resetModified)
	{
		if (!_graves.TryGetValue(objectId, out var value))
		{
			AdaptableLog.TagWarning("GetElementField_Graves", $"Failed to find element {objectId} with field {fieldId}");
			return -1;
		}
		if (resetModified)
		{
			_dataStatesGraves.ResetModified(value.DataStatesOffset, fieldId);
		}
		switch (fieldId)
		{
		case 0:
			return GameData.Serializer.Serializer.Serialize(value.GetId(), dataPool);
		case 1:
			return GameData.Serializer.Serializer.Serialize(value.GetLocation(), dataPool);
		case 2:
			return GameData.Serializer.Serializer.Serialize(value.GetLevel(), dataPool);
		case 3:
			return GameData.Serializer.Serializer.Serialize(value.GetDurability(), dataPool);
		case 4:
			return GameData.Serializer.Serializer.Serialize(value.GetInventory(), dataPool);
		case 5:
			return GameData.Serializer.Serializer.Serialize(value.GetResources(), dataPool);
		case 6:
			return GameData.Serializer.Serializer.Serialize(value.GetSkeletonCharId(), dataPool);
		default:
			if (fieldId >= 7)
			{
				throw new Exception($"Unsupported fieldId {fieldId}");
			}
			throw new Exception($"Not allow to get readonly field data: {fieldId}");
		}
	}

	public void SetElementField_Graves(int objectId, ushort fieldId, int valueOffset, RawDataPool dataPool, DataContext context)
	{
		if (!_graves.TryGetValue(objectId, out var value))
		{
			throw new Exception($"Failed to find element {objectId} with field {fieldId}");
		}
		switch (fieldId)
		{
		case 0:
			throw new Exception($"Not allow to set readonly field data: {fieldId}");
		case 1:
		{
			Location item3 = default(Location);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item3);
			value.SetLocation(item3, context);
			return;
		}
		case 2:
		{
			sbyte item2 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item2);
			value.SetLevel(item2, context);
			return;
		}
		case 3:
		{
			short item = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item);
			value.SetDurability(item, context);
			return;
		}
		case 4:
		{
			Inventory item6 = value.GetInventory();
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item6);
			value.SetInventory(item6, context);
			return;
		}
		case 5:
		{
			ResourceInts item5 = default(ResourceInts);
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item5);
			value.SetResources(ref item5, context);
			return;
		}
		case 6:
		{
			int item4 = 0;
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref item4);
			value.SetSkeletonCharId(item4, context);
			return;
		}
		}
		if (fieldId >= 7)
		{
			throw new Exception($"Unsupported fieldId {fieldId}");
		}
		if (fieldId >= 7)
		{
			throw new Exception($"Not allow to set readonly field data: {fieldId}");
		}
		throw new Exception($"Not allow to set cache field data: {fieldId}");
	}

	private int CheckModified_Graves(int objectId, ushort fieldId, RawDataPool dataPool)
	{
		if (!_graves.TryGetValue(objectId, out var value))
		{
			return -1;
		}
		if (fieldId >= 7)
		{
			throw new Exception($"Not allow to check readonly field data: {fieldId}");
		}
		if (!_dataStatesGraves.IsModified(value.DataStatesOffset, fieldId))
		{
			return -1;
		}
		_dataStatesGraves.ResetModified(value.DataStatesOffset, fieldId);
		return fieldId switch
		{
			0 => GameData.Serializer.Serializer.Serialize(value.GetId(), dataPool), 
			1 => GameData.Serializer.Serializer.Serialize(value.GetLocation(), dataPool), 
			2 => GameData.Serializer.Serializer.Serialize(value.GetLevel(), dataPool), 
			3 => GameData.Serializer.Serializer.Serialize(value.GetDurability(), dataPool), 
			4 => GameData.Serializer.Serializer.Serialize(value.GetInventory(), dataPool), 
			5 => GameData.Serializer.Serializer.Serialize(value.GetResources(), dataPool), 
			6 => GameData.Serializer.Serializer.Serialize(value.GetSkeletonCharId(), dataPool), 
			_ => throw new Exception($"Unsupported fieldId {fieldId}"), 
		};
	}

	private void ResetModifiedWrapper_Graves(int objectId, ushort fieldId)
	{
		if (_graves.TryGetValue(objectId, out var value))
		{
			if (fieldId >= 7)
			{
				throw new Exception($"Not allow to reset modification state of readonly field data: {fieldId}");
			}
			if (_dataStatesGraves.IsModified(value.DataStatesOffset, fieldId))
			{
				_dataStatesGraves.ResetModified(value.DataStatesOffset, fieldId);
			}
		}
	}

	private bool IsModifiedWrapper_Graves(int objectId, ushort fieldId)
	{
		if (!_graves.TryGetValue(objectId, out var value))
		{
			return false;
		}
		if (fieldId >= 7)
		{
			throw new Exception($"Not allow to check modification state of readonly field data: {fieldId}");
		}
		return _dataStatesGraves.IsModified(value.DataStatesOffset, fieldId);
	}

	private PregnantState GetElement_PregnantStates(int elementId)
	{
		return _pregnantStates[elementId];
	}

	private bool TryGetElement_PregnantStates(int elementId, out PregnantState value)
	{
		return _pregnantStates.TryGetValue(elementId, out value);
	}

	private unsafe void AddElement_PregnantStates(int elementId, PregnantState value, DataContext context)
	{
		_pregnantStates.Add(elementId, value);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(7, DataStates, CacheInfluences, context);
		if (value != null)
		{
			int serializedSize = value.GetSerializedSize();
			byte* ptr = OperationAdder.DynamicSingleValueCollection_Add(4, 7, elementId, serializedSize);
			ptr += value.Serialize(ptr);
		}
		else
		{
			OperationAdder.DynamicSingleValueCollection_Add(4, 7, elementId, 0);
		}
	}

	private unsafe void SetElement_PregnantStates(int elementId, PregnantState value, DataContext context)
	{
		_pregnantStates[elementId] = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(7, DataStates, CacheInfluences, context);
		if (value != null)
		{
			int serializedSize = value.GetSerializedSize();
			byte* ptr = OperationAdder.DynamicSingleValueCollection_Set(4, 7, elementId, serializedSize);
			ptr += value.Serialize(ptr);
		}
		else
		{
			OperationAdder.DynamicSingleValueCollection_Set(4, 7, elementId, 0);
		}
	}

	private void RemoveElement_PregnantStates(int elementId, DataContext context)
	{
		_pregnantStates.Remove(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(7, DataStates, CacheInfluences, context);
		OperationAdder.DynamicSingleValueCollection_Remove(4, 7, elementId);
	}

	private void ClearPregnantStates(DataContext context)
	{
		_pregnantStates.Clear();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(7, DataStates, CacheInfluences, context);
		OperationAdder.DynamicSingleValueCollection_Clear(4, 7);
	}

	public int GetElement_PregnancyLockEndDates(int elementId)
	{
		return _pregnancyLockEndDates[elementId];
	}

	public bool TryGetElement_PregnancyLockEndDates(int elementId, out int value)
	{
		return _pregnancyLockEndDates.TryGetValue(elementId, out value);
	}

	private unsafe void AddElement_PregnancyLockEndDates(int elementId, int value, DataContext context)
	{
		_pregnancyLockEndDates.Add(elementId, value);
		_modificationsPregnancyLockEndDates.RecordAdding(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(8, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValueCollection_Add(4, 8, elementId, 4);
		*(int*)ptr = value;
		ptr += 4;
	}

	private unsafe void SetElement_PregnancyLockEndDates(int elementId, int value, DataContext context)
	{
		_pregnancyLockEndDates[elementId] = value;
		_modificationsPregnancyLockEndDates.RecordSetting(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(8, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValueCollection_Set(4, 8, elementId, 4);
		*(int*)ptr = value;
		ptr += 4;
	}

	private void RemoveElement_PregnancyLockEndDates(int elementId, DataContext context)
	{
		_pregnancyLockEndDates.Remove(elementId);
		_modificationsPregnancyLockEndDates.RecordRemoving(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(8, DataStates, CacheInfluences, context);
		OperationAdder.FixedSingleValueCollection_Remove(4, 8, elementId);
	}

	private void ClearPregnancyLockEndDates(DataContext context)
	{
		_pregnancyLockEndDates.Clear();
		_modificationsPregnancyLockEndDates.RecordClearing();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(8, DataStates, CacheInfluences, context);
		OperationAdder.FixedSingleValueCollection_Clear(4, 8);
	}

	public CharacterSet GetUnguardedChars()
	{
		return _unguardedChars;
	}

	public unsafe void SetUnguardedChars(CharacterSet value, DataContext context)
	{
		_unguardedChars = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(9, DataStates, CacheInfluences, context);
		int serializedSize = _unguardedChars.GetSerializedSize();
		byte* ptr = OperationAdder.DynamicSingleValue_Set(4, 9, serializedSize);
		ptr += _unguardedChars.Serialize(ptr);
	}

	private KidnappedCharacterList GetElement_KidnappedChars(int elementId)
	{
		return _kidnappedChars[elementId];
	}

	private bool TryGetElement_KidnappedChars(int elementId, out KidnappedCharacterList value)
	{
		return _kidnappedChars.TryGetValue(elementId, out value);
	}

	private unsafe void AddElement_KidnappedChars(int elementId, KidnappedCharacterList value, DataContext context)
	{
		_kidnappedChars.Add(elementId, value);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(10, DataStates, CacheInfluences, context);
		if (value != null)
		{
			int serializedSize = value.GetSerializedSize();
			byte* ptr = OperationAdder.DynamicSingleValueCollection_Add(4, 10, elementId, serializedSize);
			ptr += value.Serialize(ptr);
		}
		else
		{
			OperationAdder.DynamicSingleValueCollection_Add(4, 10, elementId, 0);
		}
	}

	private unsafe void SetElement_KidnappedChars(int elementId, KidnappedCharacterList value, DataContext context)
	{
		_kidnappedChars[elementId] = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(10, DataStates, CacheInfluences, context);
		if (value != null)
		{
			int serializedSize = value.GetSerializedSize();
			byte* ptr = OperationAdder.DynamicSingleValueCollection_Set(4, 10, elementId, serializedSize);
			ptr += value.Serialize(ptr);
		}
		else
		{
			OperationAdder.DynamicSingleValueCollection_Set(4, 10, elementId, 0);
		}
	}

	private void RemoveElement_KidnappedChars(int elementId, DataContext context)
	{
		_kidnappedChars.Remove(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(10, DataStates, CacheInfluences, context);
		OperationAdder.DynamicSingleValueCollection_Remove(4, 10, elementId);
	}

	private void ClearKidnappedChars(DataContext context)
	{
		_kidnappedChars.Clear();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(10, DataStates, CacheInfluences, context);
		OperationAdder.DynamicSingleValueCollection_Clear(4, 10);
	}

	private RelatedCharacter GetElement_Relations(RelationKey elementId)
	{
		return _relations[elementId];
	}

	private bool TryGetElement_Relations(RelationKey elementId, out RelatedCharacter value)
	{
		return _relations.TryGetValue(elementId, out value);
	}

	private unsafe void AddElement_Relations(RelationKey elementId, RelatedCharacter value, DataContext context)
	{
		_relations.Add(elementId, value);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(11, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValueCollection_Add(4, 11, elementId, 8);
		ptr += value.Serialize(ptr);
	}

	private unsafe void SetElement_Relations(RelationKey elementId, RelatedCharacter value, DataContext context)
	{
		_relations[elementId] = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(11, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValueCollection_Set(4, 11, elementId, 8);
		ptr += value.Serialize(ptr);
	}

	private void RemoveElement_Relations(RelationKey elementId, DataContext context)
	{
		_relations.Remove(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(11, DataStates, CacheInfluences, context);
		OperationAdder.FixedSingleValueCollection_Remove(4, 11, elementId);
	}

	private void ClearRelations(DataContext context)
	{
		_relations.Clear();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(11, DataStates, CacheInfluences, context);
		OperationAdder.FixedSingleValueCollection_Clear(4, 11);
	}

	private int GetElement_ActualBloodParents(ParentAndChild elementId)
	{
		return _actualBloodParents[elementId];
	}

	private bool TryGetElement_ActualBloodParents(ParentAndChild elementId, out int value)
	{
		return _actualBloodParents.TryGetValue(elementId, out value);
	}

	private unsafe void AddElement_ActualBloodParents(ParentAndChild elementId, int value, DataContext context)
	{
		_actualBloodParents.Add(elementId, value);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(12, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValueCollection_Add(4, 12, elementId, 4);
		*(int*)ptr = value;
		ptr += 4;
	}

	private unsafe void SetElement_ActualBloodParents(ParentAndChild elementId, int value, DataContext context)
	{
		_actualBloodParents[elementId] = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(12, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValueCollection_Set(4, 12, elementId, 4);
		*(int*)ptr = value;
		ptr += 4;
	}

	private void RemoveElement_ActualBloodParents(ParentAndChild elementId, DataContext context)
	{
		_actualBloodParents.Remove(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(12, DataStates, CacheInfluences, context);
		OperationAdder.FixedSingleValueCollection_Remove(4, 12, elementId);
	}

	private void ClearActualBloodParents(DataContext context)
	{
		_actualBloodParents.Clear();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(12, DataStates, CacheInfluences, context);
		OperationAdder.FixedSingleValueCollection_Clear(4, 12);
	}

	private CharacterSet GetElement_CharacterGroups(int elementId)
	{
		return _characterGroups[elementId];
	}

	private bool TryGetElement_CharacterGroups(int elementId, out CharacterSet value)
	{
		return _characterGroups.TryGetValue(elementId, out value);
	}

	private unsafe void AddElement_CharacterGroups(int elementId, CharacterSet value, DataContext context)
	{
		_characterGroups.Add(elementId, value);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(13, DataStates, CacheInfluences, context);
		int serializedSize = value.GetSerializedSize();
		byte* ptr = OperationAdder.DynamicSingleValueCollection_Add(4, 13, elementId, serializedSize);
		ptr += value.Serialize(ptr);
	}

	private unsafe void SetElement_CharacterGroups(int elementId, CharacterSet value, DataContext context)
	{
		_characterGroups[elementId] = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(13, DataStates, CacheInfluences, context);
		int serializedSize = value.GetSerializedSize();
		byte* ptr = OperationAdder.DynamicSingleValueCollection_Set(4, 13, elementId, serializedSize);
		ptr += value.Serialize(ptr);
	}

	private void RemoveElement_CharacterGroups(int elementId, DataContext context)
	{
		_characterGroups.Remove(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(13, DataStates, CacheInfluences, context);
		OperationAdder.DynamicSingleValueCollection_Remove(4, 13, elementId);
	}

	private void ClearCharacterGroups(DataContext context)
	{
		_characterGroups.Clear();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(13, DataStates, CacheInfluences, context);
		OperationAdder.DynamicSingleValueCollection_Clear(4, 13);
	}

	public int GetElement_JoinGroupDates(int elementId)
	{
		return _joinGroupDates[elementId];
	}

	public bool TryGetElement_JoinGroupDates(int elementId, out int value)
	{
		return _joinGroupDates.TryGetValue(elementId, out value);
	}

	private unsafe void AddElement_JoinGroupDates(int elementId, int value, DataContext context)
	{
		_joinGroupDates.Add(elementId, value);
		_modificationsJoinGroupDates.RecordAdding(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(14, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValueCollection_Add(4, 14, elementId, 4);
		*(int*)ptr = value;
		ptr += 4;
	}

	private unsafe void SetElement_JoinGroupDates(int elementId, int value, DataContext context)
	{
		_joinGroupDates[elementId] = value;
		_modificationsJoinGroupDates.RecordSetting(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(14, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValueCollection_Set(4, 14, elementId, 4);
		*(int*)ptr = value;
		ptr += 4;
	}

	private void RemoveElement_JoinGroupDates(int elementId, DataContext context)
	{
		_joinGroupDates.Remove(elementId);
		_modificationsJoinGroupDates.RecordRemoving(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(14, DataStates, CacheInfluences, context);
		OperationAdder.FixedSingleValueCollection_Remove(4, 14, elementId);
	}

	private void ClearJoinGroupDates(DataContext context)
	{
		_joinGroupDates.Clear();
		_modificationsJoinGroupDates.RecordClearing();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(14, DataStates, CacheInfluences, context);
		OperationAdder.FixedSingleValueCollection_Clear(4, 14);
	}

	private Debts GetElement_DebtsToTaiwu(int elementId)
	{
		return _debtsToTaiwu[elementId];
	}

	private bool TryGetElement_DebtsToTaiwu(int elementId, out Debts value)
	{
		return _debtsToTaiwu.TryGetValue(elementId, out value);
	}

	private unsafe void AddElement_DebtsToTaiwu(int elementId, Debts value, DataContext context)
	{
		_debtsToTaiwu.Add(elementId, value);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(15, DataStates, CacheInfluences, context);
		if (value != null)
		{
			int serializedSize = value.GetSerializedSize();
			byte* ptr = OperationAdder.DynamicSingleValueCollection_Add(4, 15, elementId, serializedSize);
			ptr += value.Serialize(ptr);
		}
		else
		{
			OperationAdder.DynamicSingleValueCollection_Add(4, 15, elementId, 0);
		}
	}

	private unsafe void SetElement_DebtsToTaiwu(int elementId, Debts value, DataContext context)
	{
		_debtsToTaiwu[elementId] = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(15, DataStates, CacheInfluences, context);
		if (value != null)
		{
			int serializedSize = value.GetSerializedSize();
			byte* ptr = OperationAdder.DynamicSingleValueCollection_Set(4, 15, elementId, serializedSize);
			ptr += value.Serialize(ptr);
		}
		else
		{
			OperationAdder.DynamicSingleValueCollection_Set(4, 15, elementId, 0);
		}
	}

	private void RemoveElement_DebtsToTaiwu(int elementId, DataContext context)
	{
		_debtsToTaiwu.Remove(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(15, DataStates, CacheInfluences, context);
		OperationAdder.DynamicSingleValueCollection_Remove(4, 15, elementId);
	}

	private void ClearDebtsToTaiwu(DataContext context)
	{
		_debtsToTaiwu.Clear();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(15, DataStates, CacheInfluences, context);
		OperationAdder.DynamicSingleValueCollection_Clear(4, 15);
	}

	private GameData.Utilities.ShortList GetElement_SoldLibrarySkillBooks(int elementId)
	{
		return _soldLibrarySkillBooks[elementId];
	}

	private bool TryGetElement_SoldLibrarySkillBooks(int elementId, out GameData.Utilities.ShortList value)
	{
		return _soldLibrarySkillBooks.TryGetValue(elementId, out value);
	}

	private unsafe void AddElement_SoldLibrarySkillBooks(int elementId, GameData.Utilities.ShortList value, DataContext context)
	{
		_soldLibrarySkillBooks.Add(elementId, value);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(16, DataStates, CacheInfluences, context);
		int serializedSize = value.GetSerializedSize();
		byte* ptr = OperationAdder.DynamicSingleValueCollection_Add(4, 16, elementId, serializedSize);
		ptr += value.Serialize(ptr);
	}

	private unsafe void SetElement_SoldLibrarySkillBooks(int elementId, GameData.Utilities.ShortList value, DataContext context)
	{
		_soldLibrarySkillBooks[elementId] = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(16, DataStates, CacheInfluences, context);
		int serializedSize = value.GetSerializedSize();
		byte* ptr = OperationAdder.DynamicSingleValueCollection_Set(4, 16, elementId, serializedSize);
		ptr += value.Serialize(ptr);
	}

	private void RemoveElement_SoldLibrarySkillBooks(int elementId, DataContext context)
	{
		_soldLibrarySkillBooks.Remove(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(16, DataStates, CacheInfluences, context);
		OperationAdder.DynamicSingleValueCollection_Remove(4, 16, elementId);
	}

	private void ClearSoldLibrarySkillBooks(DataContext context)
	{
		_soldLibrarySkillBooks.Clear();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(16, DataStates, CacheInfluences, context);
		OperationAdder.DynamicSingleValueCollection_Clear(4, 16);
	}

	[Obsolete("DomainData _usedCombatResourceObsoletes is no longer in use.")]
	private CombatResourcesObsolete GetElement_UsedCombatResourceObsoletes(int elementId)
	{
		return _usedCombatResourceObsoletes[elementId];
	}

	[Obsolete("DomainData _usedCombatResourceObsoletes is no longer in use.")]
	private bool TryGetElement_UsedCombatResourceObsoletes(int elementId, out CombatResourcesObsolete value)
	{
		return _usedCombatResourceObsoletes.TryGetValue(elementId, out value);
	}

	[Obsolete("DomainData _usedCombatResourceObsoletes is no longer in use.")]
	private unsafe void AddElement_UsedCombatResourceObsoletes(int elementId, CombatResourcesObsolete value, DataContext context)
	{
		_usedCombatResourceObsoletes.Add(elementId, value);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(17, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValueCollection_Add(4, 17, elementId, 2);
		ptr += value.Serialize(ptr);
	}

	[Obsolete("DomainData _usedCombatResourceObsoletes is no longer in use.")]
	private unsafe void SetElement_UsedCombatResourceObsoletes(int elementId, CombatResourcesObsolete value, DataContext context)
	{
		_usedCombatResourceObsoletes[elementId] = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(17, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValueCollection_Set(4, 17, elementId, 2);
		ptr += value.Serialize(ptr);
	}

	[Obsolete("DomainData _usedCombatResourceObsoletes is no longer in use.")]
	private void RemoveElement_UsedCombatResourceObsoletes(int elementId, DataContext context)
	{
		_usedCombatResourceObsoletes.Remove(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(17, DataStates, CacheInfluences, context);
		OperationAdder.FixedSingleValueCollection_Remove(4, 17, elementId);
	}

	[Obsolete("DomainData _usedCombatResourceObsoletes is no longer in use.")]
	private void ClearUsedCombatResourceObsoletes(DataContext context)
	{
		_usedCombatResourceObsoletes.Clear();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(17, DataStates, CacheInfluences, context);
		OperationAdder.FixedSingleValueCollection_Clear(4, 17);
	}

	private AvatarElementsGrownDates GetElement_AvatarElementGrowthProgress(int elementId)
	{
		return _avatarElementGrowthProgress[elementId];
	}

	private bool TryGetElement_AvatarElementGrowthProgress(int elementId, out AvatarElementsGrownDates value)
	{
		return _avatarElementGrowthProgress.TryGetValue(elementId, out value);
	}

	private unsafe void AddElement_AvatarElementGrowthProgress(int elementId, ref AvatarElementsGrownDates value, DataContext context)
	{
		_avatarElementGrowthProgress.Add(elementId, value);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(18, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValueCollection_Add(4, 18, elementId, 28);
		ptr += value.Serialize(ptr);
	}

	private unsafe void SetElement_AvatarElementGrowthProgress(int elementId, ref AvatarElementsGrownDates value, DataContext context)
	{
		_avatarElementGrowthProgress[elementId] = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(18, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValueCollection_Set(4, 18, elementId, 28);
		ptr += value.Serialize(ptr);
	}

	private void RemoveElement_AvatarElementGrowthProgress(int elementId, DataContext context)
	{
		_avatarElementGrowthProgress.Remove(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(18, DataStates, CacheInfluences, context);
		OperationAdder.FixedSingleValueCollection_Remove(4, 18, elementId);
	}

	private void ClearAvatarElementGrowthProgress(DataContext context)
	{
		_avatarElementGrowthProgress.Clear();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(18, DataStates, CacheInfluences, context);
		OperationAdder.FixedSingleValueCollection_Clear(4, 18);
	}

	public string GetTargetedForAssassination()
	{
		return _targetedForAssassination;
	}

	public unsafe void SetTargetedForAssassination(string value, DataContext context)
	{
		_targetedForAssassination = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(19, DataStates, CacheInfluences, context);
		int length = _targetedForAssassination.Length;
		int valueSize = 2 * length;
		byte* ptr = OperationAdder.DynamicSingleValue_Set(4, 19, valueSize);
		fixed (char* targetedForAssassination = _targetedForAssassination)
		{
			for (int i = 0; i < length; i++)
			{
				((short*)ptr)[i] = (short)targetedForAssassination[i];
			}
		}
	}

	private PrioritizedActionWrapper GetElement_PrioritizedActions(int elementId)
	{
		return _prioritizedActions[elementId];
	}

	private bool TryGetElement_PrioritizedActions(int elementId, out PrioritizedActionWrapper value)
	{
		return _prioritizedActions.TryGetValue(elementId, out value);
	}

	private unsafe void AddElement_PrioritizedActions(int elementId, PrioritizedActionWrapper value, DataContext context)
	{
		_prioritizedActions.Add(elementId, value);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(20, DataStates, CacheInfluences, context);
		if (value != null)
		{
			int serializedSize = value.GetSerializedSize();
			byte* ptr = OperationAdder.DynamicSingleValueCollection_Add(4, 20, elementId, serializedSize);
			ptr += value.Serialize(ptr);
		}
		else
		{
			OperationAdder.DynamicSingleValueCollection_Add(4, 20, elementId, 0);
		}
	}

	private unsafe void SetElement_PrioritizedActions(int elementId, PrioritizedActionWrapper value, DataContext context)
	{
		_prioritizedActions[elementId] = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(20, DataStates, CacheInfluences, context);
		if (value != null)
		{
			int serializedSize = value.GetSerializedSize();
			byte* ptr = OperationAdder.DynamicSingleValueCollection_Set(4, 20, elementId, serializedSize);
			ptr += value.Serialize(ptr);
		}
		else
		{
			OperationAdder.DynamicSingleValueCollection_Set(4, 20, elementId, 0);
		}
	}

	private void RemoveElement_PrioritizedActions(int elementId, DataContext context)
	{
		_prioritizedActions.Remove(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(20, DataStates, CacheInfluences, context);
		OperationAdder.DynamicSingleValueCollection_Remove(4, 20, elementId);
	}

	private void ClearPrioritizedActions(DataContext context)
	{
		_prioritizedActions.Clear();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(20, DataStates, CacheInfluences, context);
		OperationAdder.DynamicSingleValueCollection_Clear(4, 20);
	}

	public CrossAreaMoveInfo GetElement_CrossAreaMoveInfos(int elementId)
	{
		return _crossAreaMoveInfos[elementId];
	}

	public bool TryGetElement_CrossAreaMoveInfos(int elementId, out CrossAreaMoveInfo value)
	{
		return _crossAreaMoveInfos.TryGetValue(elementId, out value);
	}

	private unsafe void AddElement_CrossAreaMoveInfos(int elementId, CrossAreaMoveInfo value, DataContext context)
	{
		_crossAreaMoveInfos.Add(elementId, value);
		_modificationsCrossAreaMoveInfos.RecordAdding(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(21, DataStates, CacheInfluences, context);
		if (value != null)
		{
			int serializedSize = value.GetSerializedSize();
			byte* ptr = OperationAdder.DynamicSingleValueCollection_Add(4, 21, elementId, serializedSize);
			ptr += value.Serialize(ptr);
		}
		else
		{
			OperationAdder.DynamicSingleValueCollection_Add(4, 21, elementId, 0);
		}
	}

	private unsafe void SetElement_CrossAreaMoveInfos(int elementId, CrossAreaMoveInfo value, DataContext context)
	{
		_crossAreaMoveInfos[elementId] = value;
		_modificationsCrossAreaMoveInfos.RecordSetting(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(21, DataStates, CacheInfluences, context);
		if (value != null)
		{
			int serializedSize = value.GetSerializedSize();
			byte* ptr = OperationAdder.DynamicSingleValueCollection_Set(4, 21, elementId, serializedSize);
			ptr += value.Serialize(ptr);
		}
		else
		{
			OperationAdder.DynamicSingleValueCollection_Set(4, 21, elementId, 0);
		}
	}

	private void RemoveElement_CrossAreaMoveInfos(int elementId, DataContext context)
	{
		_crossAreaMoveInfos.Remove(elementId);
		_modificationsCrossAreaMoveInfos.RecordRemoving(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(21, DataStates, CacheInfluences, context);
		OperationAdder.DynamicSingleValueCollection_Remove(4, 21, elementId);
	}

	private void ClearCrossAreaMoveInfos(DataContext context)
	{
		_crossAreaMoveInfos.Clear();
		_modificationsCrossAreaMoveInfos.RecordClearing();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(21, DataStates, CacheInfluences, context);
		OperationAdder.DynamicSingleValueCollection_Clear(4, 21);
	}

	private CharacterSet GetElement_OngoingVengeances(int elementId)
	{
		return _ongoingVengeances[elementId];
	}

	private bool TryGetElement_OngoingVengeances(int elementId, out CharacterSet value)
	{
		return _ongoingVengeances.TryGetValue(elementId, out value);
	}

	private unsafe void AddElement_OngoingVengeances(int elementId, CharacterSet value, DataContext context)
	{
		_ongoingVengeances.Add(elementId, value);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(22, DataStates, CacheInfluences, context);
		int serializedSize = value.GetSerializedSize();
		byte* ptr = OperationAdder.DynamicSingleValueCollection_Add(4, 22, elementId, serializedSize);
		ptr += value.Serialize(ptr);
	}

	private unsafe void SetElement_OngoingVengeances(int elementId, CharacterSet value, DataContext context)
	{
		_ongoingVengeances[elementId] = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(22, DataStates, CacheInfluences, context);
		int serializedSize = value.GetSerializedSize();
		byte* ptr = OperationAdder.DynamicSingleValueCollection_Set(4, 22, elementId, serializedSize);
		ptr += value.Serialize(ptr);
	}

	private void RemoveElement_OngoingVengeances(int elementId, DataContext context)
	{
		_ongoingVengeances.Remove(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(22, DataStates, CacheInfluences, context);
		OperationAdder.DynamicSingleValueCollection_Remove(4, 22, elementId);
	}

	private void ClearOngoingVengeances(DataContext context)
	{
		_ongoingVengeances.Clear();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(22, DataStates, CacheInfluences, context);
		OperationAdder.DynamicSingleValueCollection_Clear(4, 22);
	}

	[Obsolete("DomainData _mournedOthersChars is no longer in use.")]
	public CharacterSet GetMournedOthersChars()
	{
		return _mournedOthersChars;
	}

	[Obsolete("DomainData _mournedOthersChars is no longer in use.")]
	public unsafe void SetMournedOthersChars(CharacterSet value, DataContext context)
	{
		_mournedOthersChars = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(23, DataStates, CacheInfluences, context);
		int serializedSize = _mournedOthersChars.GetSerializedSize();
		byte* ptr = OperationAdder.DynamicSingleValue_Set(4, 23, serializedSize);
		ptr += _mournedOthersChars.Serialize(ptr);
	}

	private int[] GetPregeneratedCityTownGuards()
	{
		return _pregeneratedCityTownGuards;
	}

	private unsafe void SetPregeneratedCityTownGuards(int[] value, DataContext context)
	{
		_pregeneratedCityTownGuards = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(24, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValue_Set(4, 24, 1152);
		for (int i = 0; i < 288; i++)
		{
			((int*)ptr)[i] = _pregeneratedCityTownGuards[i];
		}
		ptr += 1152;
	}

	private List<int> GetPregeneratedRandomEnemies()
	{
		return _pregeneratedRandomEnemies;
	}

	private unsafe void SetPregeneratedRandomEnemies(List<int> value, DataContext context)
	{
		_pregeneratedRandomEnemies = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(25, DataStates, CacheInfluences, context);
		int count = _pregeneratedRandomEnemies.Count;
		int num = 4 * count;
		int valueSize = 2 + num;
		byte* ptr = OperationAdder.DynamicSingleValue_Set(4, 25, valueSize);
		*(ushort*)ptr = (ushort)count;
		ptr += 2;
		for (int i = 0; i < count; i++)
		{
			((int*)ptr)[i] = _pregeneratedRandomEnemies[i];
		}
		ptr += num;
	}

	public Location GetForceRebelLocation()
	{
		return _forceRebelLocation;
	}

	private void SetForceRebelLocation(Location value, DataContext context)
	{
		_forceRebelLocation = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(26, DataStates, CacheInfluences, context);
	}

	public Location GetForceKindLocation()
	{
		return _forceKindLocation;
	}

	private void SetForceKindLocation(Location value, DataContext context)
	{
		_forceKindLocation = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(27, DataStates, CacheInfluences, context);
	}

	public int GetAvoidDeathCharId()
	{
		return _avoidDeathCharId;
	}

	private unsafe void SetAvoidDeathCharId(int value, DataContext context)
	{
		_avoidDeathCharId = value;
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(28, DataStates, CacheInfluences, context);
		byte* ptr = OperationAdder.FixedSingleValue_Set(4, 28, 4);
		*(int*)ptr = _avoidDeathCharId;
		ptr += 4;
	}

	public CharacterList GetElement_SubscriberOrders(int elementId)
	{
		return _subscriberOrders[elementId];
	}

	public bool TryGetElement_SubscriberOrders(int elementId, out CharacterList value)
	{
		return _subscriberOrders.TryGetValue(elementId, out value);
	}

	private void AddElement_SubscriberOrders(int elementId, CharacterList value, DataContext context)
	{
		_subscriberOrders.Add(elementId, value);
		_modificationsSubscriberOrders.RecordAdding(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(29, DataStates, CacheInfluences, context);
	}

	private void SetElement_SubscriberOrders(int elementId, CharacterList value, DataContext context)
	{
		_subscriberOrders[elementId] = value;
		_modificationsSubscriberOrders.RecordSetting(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(29, DataStates, CacheInfluences, context);
	}

	private void RemoveElement_SubscriberOrders(int elementId, DataContext context)
	{
		_subscriberOrders.Remove(elementId);
		_modificationsSubscriberOrders.RecordRemoving(elementId);
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(29, DataStates, CacheInfluences, context);
	}

	private void ClearSubscriberOrders(DataContext context)
	{
		_subscriberOrders.Clear();
		_modificationsSubscriberOrders.RecordClearing();
		BaseGameDataDomain.SetModifiedAndInvalidateInfluencedCache(29, DataStates, CacheInfluences, context);
	}

	public override void OnInitializeGameDataModule()
	{
		InitializeOnInitializeGameDataModule();
	}

	public unsafe override void OnEnterNewWorld()
	{
		InitializeOnEnterNewWorld();
		InitializeInternalDataOfCollections();
		foreach (KeyValuePair<int, Character> @object in _objects)
		{
			int key = @object.Key;
			Character value = @object.Value;
			byte* pData = OperationAdder.DynamicObjectCollection_Add(4, 0, key, value.GetSerializedSize());
			value.Serialize(pData);
		}
		byte* ptr = OperationAdder.FixedSingleValue_Set(4, 1, 4);
		*(int*)ptr = _nextObjectId;
		ptr += 4;
		foreach (KeyValuePair<int, DeadCharacter> deadCharacter in _deadCharacters)
		{
			int key2 = deadCharacter.Key;
			DeadCharacter value2 = deadCharacter.Value;
			if (value2 != null)
			{
				int serializedSize = value2.GetSerializedSize();
				byte* ptr2 = OperationAdder.DynamicSingleValueCollection_Add(4, 2, key2, serializedSize);
				ptr2 += value2.Serialize(ptr2);
			}
			else
			{
				OperationAdder.DynamicSingleValueCollection_Add(4, 2, key2, 0);
			}
		}
		foreach (KeyValuePair<int, DeadCharDeletionState> deadCharDeletionState in _deadCharDeletionStates)
		{
			int key3 = deadCharDeletionState.Key;
			DeadCharDeletionState value3 = deadCharDeletionState.Value;
			byte* ptr3 = OperationAdder.FixedSingleValueCollection_Add(4, 3, key3, 2);
			ptr3 += value3.Serialize(ptr3);
		}
		foreach (KeyValuePair<IntPair, VoidValue> recentDeadCharacter in _recentDeadCharacters)
		{
			IntPair key4 = recentDeadCharacter.Key;
			VoidValue value4 = recentDeadCharacter.Value;
			byte* ptr4 = OperationAdder.FixedSingleValueCollection_Add(4, 4, key4, 0);
			ptr4 += value4.Serialize(ptr4);
		}
		foreach (KeyValuePair<IntPair, VoidValue> waitingReincarnationChar in _waitingReincarnationChars)
		{
			IntPair key5 = waitingReincarnationChar.Key;
			VoidValue value5 = waitingReincarnationChar.Value;
			byte* ptr5 = OperationAdder.FixedSingleValueCollection_Add(4, 5, key5, 0);
			ptr5 += value5.Serialize(ptr5);
		}
		foreach (KeyValuePair<int, Grave> grafe in _graves)
		{
			int key6 = grafe.Key;
			Grave value6 = grafe.Value;
			byte* pData2 = OperationAdder.DynamicObjectCollection_Add(4, 6, key6, value6.GetSerializedSize());
			value6.Serialize(pData2);
		}
		foreach (KeyValuePair<int, PregnantState> pregnantState in _pregnantStates)
		{
			int key7 = pregnantState.Key;
			PregnantState value7 = pregnantState.Value;
			if (value7 != null)
			{
				int serializedSize2 = value7.GetSerializedSize();
				byte* ptr6 = OperationAdder.DynamicSingleValueCollection_Add(4, 7, key7, serializedSize2);
				ptr6 += value7.Serialize(ptr6);
			}
			else
			{
				OperationAdder.DynamicSingleValueCollection_Add(4, 7, key7, 0);
			}
		}
		foreach (KeyValuePair<int, int> pregnancyLockEndDate in _pregnancyLockEndDates)
		{
			int key8 = pregnancyLockEndDate.Key;
			int value8 = pregnancyLockEndDate.Value;
			byte* ptr7 = OperationAdder.FixedSingleValueCollection_Add(4, 8, key8, 4);
			*(int*)ptr7 = value8;
			ptr7 += 4;
		}
		int serializedSize3 = _unguardedChars.GetSerializedSize();
		byte* ptr8 = OperationAdder.DynamicSingleValue_Set(4, 9, serializedSize3);
		ptr8 += _unguardedChars.Serialize(ptr8);
		foreach (KeyValuePair<int, KidnappedCharacterList> kidnappedChar in _kidnappedChars)
		{
			int key9 = kidnappedChar.Key;
			KidnappedCharacterList value9 = kidnappedChar.Value;
			if (value9 != null)
			{
				int serializedSize4 = value9.GetSerializedSize();
				byte* ptr9 = OperationAdder.DynamicSingleValueCollection_Add(4, 10, key9, serializedSize4);
				ptr9 += value9.Serialize(ptr9);
			}
			else
			{
				OperationAdder.DynamicSingleValueCollection_Add(4, 10, key9, 0);
			}
		}
		foreach (KeyValuePair<RelationKey, RelatedCharacter> relation in _relations)
		{
			RelationKey key10 = relation.Key;
			RelatedCharacter value10 = relation.Value;
			byte* ptr10 = OperationAdder.FixedSingleValueCollection_Add(4, 11, key10, 8);
			ptr10 += value10.Serialize(ptr10);
		}
		foreach (KeyValuePair<ParentAndChild, int> actualBloodParent in _actualBloodParents)
		{
			ParentAndChild key11 = actualBloodParent.Key;
			int value11 = actualBloodParent.Value;
			byte* ptr11 = OperationAdder.FixedSingleValueCollection_Add(4, 12, key11, 4);
			*(int*)ptr11 = value11;
			ptr11 += 4;
		}
		foreach (KeyValuePair<int, CharacterSet> characterGroup in _characterGroups)
		{
			int key12 = characterGroup.Key;
			CharacterSet value12 = characterGroup.Value;
			int serializedSize5 = value12.GetSerializedSize();
			byte* ptr12 = OperationAdder.DynamicSingleValueCollection_Add(4, 13, key12, serializedSize5);
			ptr12 += value12.Serialize(ptr12);
		}
		foreach (KeyValuePair<int, int> joinGroupDate in _joinGroupDates)
		{
			int key13 = joinGroupDate.Key;
			int value13 = joinGroupDate.Value;
			byte* ptr13 = OperationAdder.FixedSingleValueCollection_Add(4, 14, key13, 4);
			*(int*)ptr13 = value13;
			ptr13 += 4;
		}
		foreach (KeyValuePair<int, Debts> item in _debtsToTaiwu)
		{
			int key14 = item.Key;
			Debts value14 = item.Value;
			if (value14 != null)
			{
				int serializedSize6 = value14.GetSerializedSize();
				byte* ptr14 = OperationAdder.DynamicSingleValueCollection_Add(4, 15, key14, serializedSize6);
				ptr14 += value14.Serialize(ptr14);
			}
			else
			{
				OperationAdder.DynamicSingleValueCollection_Add(4, 15, key14, 0);
			}
		}
		foreach (KeyValuePair<int, GameData.Utilities.ShortList> soldLibrarySkillBook in _soldLibrarySkillBooks)
		{
			int key15 = soldLibrarySkillBook.Key;
			GameData.Utilities.ShortList value15 = soldLibrarySkillBook.Value;
			int serializedSize7 = value15.GetSerializedSize();
			byte* ptr15 = OperationAdder.DynamicSingleValueCollection_Add(4, 16, key15, serializedSize7);
			ptr15 += value15.Serialize(ptr15);
		}
		foreach (KeyValuePair<int, CombatResourcesObsolete> usedCombatResourceObsolete in _usedCombatResourceObsoletes)
		{
			int key16 = usedCombatResourceObsolete.Key;
			CombatResourcesObsolete value16 = usedCombatResourceObsolete.Value;
			byte* ptr16 = OperationAdder.FixedSingleValueCollection_Add(4, 17, key16, 2);
			ptr16 += value16.Serialize(ptr16);
		}
		foreach (KeyValuePair<int, AvatarElementsGrownDates> item2 in _avatarElementGrowthProgress)
		{
			int key17 = item2.Key;
			AvatarElementsGrownDates value17 = item2.Value;
			byte* ptr17 = OperationAdder.FixedSingleValueCollection_Add(4, 18, key17, 28);
			ptr17 += value17.Serialize(ptr17);
		}
		int length = _targetedForAssassination.Length;
		int valueSize = 2 * length;
		byte* ptr18 = OperationAdder.DynamicSingleValue_Set(4, 19, valueSize);
		fixed (char* targetedForAssassination = _targetedForAssassination)
		{
			for (int i = 0; i < length; i++)
			{
				((short*)ptr18)[i] = (short)targetedForAssassination[i];
			}
		}
		foreach (KeyValuePair<int, PrioritizedActionWrapper> prioritizedAction in _prioritizedActions)
		{
			int key18 = prioritizedAction.Key;
			PrioritizedActionWrapper value18 = prioritizedAction.Value;
			if (value18 != null)
			{
				int serializedSize8 = value18.GetSerializedSize();
				byte* ptr19 = OperationAdder.DynamicSingleValueCollection_Add(4, 20, key18, serializedSize8);
				ptr19 += value18.Serialize(ptr19);
			}
			else
			{
				OperationAdder.DynamicSingleValueCollection_Add(4, 20, key18, 0);
			}
		}
		foreach (KeyValuePair<int, CrossAreaMoveInfo> crossAreaMoveInfo in _crossAreaMoveInfos)
		{
			int key19 = crossAreaMoveInfo.Key;
			CrossAreaMoveInfo value19 = crossAreaMoveInfo.Value;
			if (value19 != null)
			{
				int serializedSize9 = value19.GetSerializedSize();
				byte* ptr20 = OperationAdder.DynamicSingleValueCollection_Add(4, 21, key19, serializedSize9);
				ptr20 += value19.Serialize(ptr20);
			}
			else
			{
				OperationAdder.DynamicSingleValueCollection_Add(4, 21, key19, 0);
			}
		}
		foreach (KeyValuePair<int, CharacterSet> ongoingVengeance in _ongoingVengeances)
		{
			int key20 = ongoingVengeance.Key;
			CharacterSet value20 = ongoingVengeance.Value;
			int serializedSize10 = value20.GetSerializedSize();
			byte* ptr21 = OperationAdder.DynamicSingleValueCollection_Add(4, 22, key20, serializedSize10);
			ptr21 += value20.Serialize(ptr21);
		}
		int serializedSize11 = _mournedOthersChars.GetSerializedSize();
		byte* ptr22 = OperationAdder.DynamicSingleValue_Set(4, 23, serializedSize11);
		ptr22 += _mournedOthersChars.Serialize(ptr22);
		byte* ptr23 = OperationAdder.FixedSingleValue_Set(4, 24, 1152);
		for (int j = 0; j < 288; j++)
		{
			((int*)ptr23)[j] = _pregeneratedCityTownGuards[j];
		}
		ptr23 += 1152;
		int count = _pregeneratedRandomEnemies.Count;
		int num = 4 * count;
		int valueSize2 = 2 + num;
		byte* ptr24 = OperationAdder.DynamicSingleValue_Set(4, 25, valueSize2);
		*(ushort*)ptr24 = (ushort)count;
		ptr24 += 2;
		for (int k = 0; k < count; k++)
		{
			((int*)ptr24)[k] = _pregeneratedRandomEnemies[k];
		}
		ptr24 += num;
		byte* ptr25 = OperationAdder.FixedSingleValue_Set(4, 28, 4);
		*(int*)ptr25 = _avoidDeathCharId;
		ptr25 += 4;
	}

	public override void OnLoadWorld()
	{
		_pendingLoadingOperationIds = new Queue<uint>();
		_pendingLoadingOperationIds.Enqueue(OperationAdder.DynamicObjectCollection_GetAllObjects(4, 0));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.FixedSingleValue_Get(4, 1));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.DynamicSingleValueCollection_GetAll(4, 2));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.FixedSingleValueCollection_GetAll(4, 3));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.FixedSingleValueCollection_GetAll(4, 4));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.FixedSingleValueCollection_GetAll(4, 5));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.DynamicObjectCollection_GetAllObjects(4, 6));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.DynamicSingleValueCollection_GetAll(4, 7));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.FixedSingleValueCollection_GetAll(4, 8));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.DynamicSingleValue_Get(4, 9));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.DynamicSingleValueCollection_GetAll(4, 10));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.FixedSingleValueCollection_GetAll(4, 11));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.FixedSingleValueCollection_GetAll(4, 12));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.DynamicSingleValueCollection_GetAll(4, 13));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.FixedSingleValueCollection_GetAll(4, 14));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.DynamicSingleValueCollection_GetAll(4, 15));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.DynamicSingleValueCollection_GetAll(4, 16));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.FixedSingleValueCollection_GetAll(4, 17));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.FixedSingleValueCollection_GetAll(4, 18));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.DynamicSingleValue_Get(4, 19));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.DynamicSingleValueCollection_GetAll(4, 20));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.DynamicSingleValueCollection_GetAll(4, 21));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.DynamicSingleValueCollection_GetAll(4, 22));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.DynamicSingleValue_Get(4, 23));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.FixedSingleValue_Get(4, 24));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.DynamicSingleValue_Get(4, 25));
		_pendingLoadingOperationIds.Enqueue(OperationAdder.FixedSingleValue_Get(4, 28));
	}

	public override int GetData(ushort dataId, ulong subId0, uint subId1, RawDataPool dataPool, bool resetModified)
	{
		switch (dataId)
		{
		case 0:
			return GetElementField_Objects((int)subId0, (ushort)subId1, dataPool, resetModified);
		case 1:
			throw new Exception($"Not allow to get value of dataId: {dataId}");
		case 2:
			throw new Exception($"Not allow to get value of dataId: {dataId}");
		case 3:
			throw new Exception($"Not allow to get value of dataId: {dataId}");
		case 4:
			throw new Exception($"Not allow to get value of dataId: {dataId}");
		case 5:
			throw new Exception($"Not allow to get value of dataId: {dataId}");
		case 6:
			return GetElementField_Graves((int)subId0, (ushort)subId1, dataPool, resetModified);
		case 7:
			throw new Exception($"Not allow to get value of dataId: {dataId}");
		case 8:
			if (resetModified)
			{
				BaseGameDataDomain.ResetModified(DataStates, 8);
				_modificationsPregnancyLockEndDates.Reset();
			}
			return GameData.Serializer.Serializer.SerializeModifications((IDictionary<int, int>)_pregnancyLockEndDates, dataPool);
		case 9:
			if (resetModified)
			{
				BaseGameDataDomain.ResetModified(DataStates, 9);
			}
			return GameData.Serializer.Serializer.Serialize(_unguardedChars, dataPool);
		case 10:
			throw new Exception($"Not allow to get value of dataId: {dataId}");
		case 11:
			throw new Exception($"Not allow to get value of dataId: {dataId}");
		case 12:
			throw new Exception($"Not allow to get value of dataId: {dataId}");
		case 13:
			throw new Exception($"Not allow to get value of dataId: {dataId}");
		case 14:
			if (resetModified)
			{
				BaseGameDataDomain.ResetModified(DataStates, 14);
				_modificationsJoinGroupDates.Reset();
			}
			return GameData.Serializer.Serializer.SerializeModifications((IDictionary<int, int>)_joinGroupDates, dataPool);
		case 15:
			throw new Exception($"Not allow to get value of dataId: {dataId}");
		case 16:
			throw new Exception($"Not allow to get value of dataId: {dataId}");
		case 17:
			throw new Exception($"Not allow to get value of dataId: {dataId}");
		case 18:
			throw new Exception($"Not allow to get value of dataId: {dataId}");
		case 19:
			if (resetModified)
			{
				BaseGameDataDomain.ResetModified(DataStates, 19);
			}
			return GameData.Serializer.Serializer.Serialize(_targetedForAssassination, dataPool);
		case 20:
			throw new Exception($"Not allow to get value of dataId: {dataId}");
		case 21:
			if (resetModified)
			{
				BaseGameDataDomain.ResetModified(DataStates, 21);
				_modificationsCrossAreaMoveInfos.Reset();
			}
			return GameData.Serializer.Serializer.SerializeModifications((IDictionary<int, CrossAreaMoveInfo>)_crossAreaMoveInfos, dataPool);
		case 22:
			throw new Exception($"Not allow to get value of dataId: {dataId}");
		case 23:
			if (resetModified)
			{
				BaseGameDataDomain.ResetModified(DataStates, 23);
			}
			return GameData.Serializer.Serializer.Serialize(_mournedOthersChars, dataPool);
		case 24:
			throw new Exception($"Not allow to get value of dataId: {dataId}");
		case 25:
			throw new Exception($"Not allow to get value of dataId: {dataId}");
		case 26:
			if (resetModified)
			{
				BaseGameDataDomain.ResetModified(DataStates, 26);
			}
			return GameData.Serializer.Serializer.Serialize(_forceRebelLocation, dataPool);
		case 27:
			if (resetModified)
			{
				BaseGameDataDomain.ResetModified(DataStates, 27);
			}
			return GameData.Serializer.Serializer.Serialize(_forceKindLocation, dataPool);
		case 28:
			if (resetModified)
			{
				BaseGameDataDomain.ResetModified(DataStates, 28);
			}
			return GameData.Serializer.Serializer.Serialize(_avoidDeathCharId, dataPool);
		case 29:
			if (resetModified)
			{
				BaseGameDataDomain.ResetModified(DataStates, 29);
				_modificationsSubscriberOrders.Reset();
			}
			return GameData.Serializer.Serializer.SerializeModifications((IDictionary<int, CharacterList>)_subscriberOrders, dataPool);
		default:
			throw new Exception($"Unsupported dataId {dataId}");
		}
	}

	public override void SetData(ushort dataId, ulong subId0, uint subId1, int valueOffset, RawDataPool dataPool, DataContext context)
	{
		switch (dataId)
		{
		case 0:
			SetElementField_Objects((int)subId0, (ushort)subId1, valueOffset, dataPool, context);
			break;
		case 1:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 2:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 3:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 4:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 5:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 6:
			SetElementField_Graves((int)subId0, (ushort)subId1, valueOffset, dataPool, context);
			break;
		case 7:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 8:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 9:
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref _unguardedChars);
			SetUnguardedChars(_unguardedChars, context);
			break;
		case 10:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 11:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 12:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 13:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 14:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 15:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 16:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 17:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 18:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 19:
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref _targetedForAssassination);
			SetTargetedForAssassination(_targetedForAssassination, context);
			break;
		case 20:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 21:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 22:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 23:
			GameData.Serializer.Serializer.Deserialize(dataPool, valueOffset, ref _mournedOthersChars);
			SetMournedOthersChars(_mournedOthersChars, context);
			break;
		case 24:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 25:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 26:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 27:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 28:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		case 29:
			throw new Exception($"Not allow to set value of dataId {dataId}");
		default:
			throw new Exception($"Unsupported dataId {dataId}");
		}
	}

	public override int CallMethod(Operation operation, RawDataPool argDataPool, RawDataPool returnDataPool, DataContext context)
	{
		int argsOffset = operation.ArgsOffset;
		switch (operation.MethodId)
		{
		case 0:
		{
			int argsCount19 = operation.ArgsCount;
			int num19 = argsCount19;
			if (num19 == 1)
			{
				ProtagonistCreationInfo item40 = null;
				argsOffset += GameData.Serializer.Serializer.DeserializeDefault(argDataPool, argsOffset, ref item40);
				int item41 = CreateProtagonist(context, item40);
				return GameData.Serializer.Serializer.Serialize(item41, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 1:
		{
			int argsCount137 = operation.ArgsCount;
			int num137 = argsCount137;
			if (num137 == 1)
			{
				int item302 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item302);
				RelatedCharactersForRelations relatedCharactersForRelations = GetRelatedCharactersForRelations(item302);
				return GameData.Serializer.Serializer.Serialize(relatedCharactersForRelations, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 2:
		{
			int argsCount46 = operation.ArgsCount;
			int num46 = argsCount46;
			if (num46 == 2)
			{
				int item98 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item98);
				int item99 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item99);
				TryCreateRelation(context, item98, item99);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 3:
		{
			int argsCount96 = operation.ArgsCount;
			int num96 = argsCount96;
			if (num96 == 1)
			{
				int item207 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item207);
				Genealogy genealogy = GetGenealogy(item207);
				return GameData.Serializer.Serializer.Serialize(genealogy, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 4:
		{
			int argsCount156 = operation.ArgsCount;
			int num156 = argsCount156;
			if (num156 == 3)
			{
				int item348 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item348);
				short item349 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item349);
				sbyte item350 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item350);
				FullName item351 = GenerateRandomHanName(context, item348, item349, item350);
				return GameData.Serializer.Serializer.Serialize(item351, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 5:
		{
			int argsCount92 = operation.ArgsCount;
			int num92 = argsCount92;
			if (num92 == 1)
			{
				sbyte item200 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item200);
				FullName item201 = GenerateRandomZangName(context, item200);
				return GameData.Serializer.Serializer.Serialize(item201, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 6:
		{
			int argsCount165 = operation.ArgsCount;
			int num165 = argsCount165;
			if (num165 == 2)
			{
				sbyte item369 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item369);
				FullName item370 = default(FullName);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item370);
				FullName item371 = GenerateRandomChildName(context, item369, item370);
				return GameData.Serializer.Serializer.Serialize(item371, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 7:
		{
			int argsCount122 = operation.ArgsCount;
			int num122 = argsCount122;
			if (num122 == 1)
			{
				List<int> item253 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item253);
				List<NameRelatedData> nameRelatedDataList = GetNameRelatedDataList(item253);
				return GameData.Serializer.Serializer.Serialize(nameRelatedDataList, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 8:
		{
			int argsCount63 = operation.ArgsCount;
			int num63 = argsCount63;
			if (num63 == 1)
			{
				int item129 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item129);
				NameRelatedData nameRelatedData = GetNameRelatedData(item129);
				return GameData.Serializer.Serializer.Serialize(nameRelatedData, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 9:
		{
			int argsCount15 = operation.ArgsCount;
			int num15 = argsCount15;
			if (num15 == 1)
			{
				List<int> item31 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item31);
				List<NameAndLifeRelatedData> nameAndLifeRelatedDataList = GetNameAndLifeRelatedDataList(item31);
				return GameData.Serializer.Serializer.Serialize(nameAndLifeRelatedDataList, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 10:
		{
			int argsCount143 = operation.ArgsCount;
			int num143 = argsCount143;
			if (num143 == 1)
			{
				int item310 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item310);
				NameAndLifeRelatedData nameAndLifeRelatedData = GetNameAndLifeRelatedData(item310);
				return GameData.Serializer.Serializer.Serialize(nameAndLifeRelatedData, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 11:
		{
			int argsCount110 = operation.ArgsCount;
			int num110 = argsCount110;
			if (num110 == 2)
			{
				int item232 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item232);
				int item233 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item233);
				short favorability = GetFavorability(item232, item233);
				return GameData.Serializer.Serializer.Serialize(favorability, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 12:
			if (operation.ArgsCount == 0)
			{
				List<List<CharacterDisplayData>> item132 = GmCmd_GetAllGroupMembers();
				return GameData.Serializer.Serializer.Serialize(item132, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		case 13:
		{
			int argsCount34 = operation.ArgsCount;
			int num34 = argsCount34;
			if (num34 == 3)
			{
				int item68 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item68);
				sbyte item69 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item69);
				int item70 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item70);
				GmCmd_GenerateRandomRefinedItemToCharacter(context, item68, item69, item70);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 14:
		{
			int argsCount2 = operation.ArgsCount;
			int num2 = argsCount2;
			if (num2 == 4)
			{
				int item4 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item4);
				bool item5 = false;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item5);
				sbyte item6 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item6);
				sbyte item7 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item7);
				GmCmd_ChangeInjury(context, item4, item5, item6, item7);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 15:
		{
			int argsCount152 = operation.ArgsCount;
			int num152 = argsCount152;
			if (num152 == 3)
			{
				int item337 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item337);
				sbyte item338 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item338);
				int item339 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item339);
				GmCmd_ChangePoisonByType(context, item337, item338, item339);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 16:
		{
			int argsCount124 = operation.ArgsCount;
			int num124 = argsCount124;
			if (num124 == 2)
			{
				int item255 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item255);
				short item256 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item256);
				GmCmd_ForgetCombatSkill(context, item255, item256);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 17:
		{
			int argsCount104 = operation.ArgsCount;
			int num104 = argsCount104;
			if (num104 == 2)
			{
				int item216 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item216);
				List<short> item217 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item217);
				GmCmd_RevokeCombatSkill(context, item216, item217);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 18:
		{
			int argsCount81 = operation.ArgsCount;
			int num81 = argsCount81;
			if (num81 == 2)
			{
				int item173 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item173);
				List<LifeSkillItem> item174 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item174);
				GmCmd_SetLearnedLifeSkills(context, item173, item174);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 19:
			switch (operation.ArgsCount)
			{
			case 2:
			{
				short item164 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item164);
				short item165 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item165);
				GmCmd_GetCricket(context, item164, item165, -1, 0, 0);
				return -1;
			}
			case 3:
			{
				short item161 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item161);
				short item162 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item162);
				int item163 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item163);
				GmCmd_GetCricket(context, item161, item162, item163, 0, 0);
				return -1;
			}
			case 4:
			{
				short item157 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item157);
				short item158 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item158);
				int item159 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item159);
				short item160 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item160);
				GmCmd_GetCricket(context, item157, item158, item159, item160, 0);
				return -1;
			}
			case 5:
			{
				short item152 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item152);
				short item153 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item153);
				int item154 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item154);
				short item155 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item155);
				short item156 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item156);
				GmCmd_GetCricket(context, item152, item153, item154, item155, item156);
				return -1;
			}
			default:
				throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
			}
		case 20:
		{
			int argsCount51 = operation.ArgsCount;
			int num51 = argsCount51;
			if (num51 == 3)
			{
				int item104 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item104);
				int item105 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item105);
				ushort item106 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item106);
				GmCmd_AddRelation(context, item104, item105, item106);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 21:
		{
			int argsCount26 = operation.ArgsCount;
			int num26 = argsCount26;
			if (num26 == 1)
			{
				int item53 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item53);
				List<int> groupSet = GetGroupSet(context, item53);
				return GameData.Serializer.Serializer.Serialize(groupSet, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 22:
		{
			int argsCount7 = operation.ArgsCount;
			int num7 = argsCount7;
			if (num7 == 4)
			{
				int item18 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item18);
				int item19 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item19);
				ResourceInts item20 = default(ResourceInts);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item20);
				bool item21 = false;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item21);
				TransferResourcesWithDebt(context, item18, item19, item20, item21);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 23:
		{
			int argsCount164 = operation.ArgsCount;
			int num164 = argsCount164;
			if (num164 == 5)
			{
				int item364 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item364);
				int item365 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item365);
				ItemKey item366 = default(ItemKey);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item366);
				int item367 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item367);
				bool item368 = false;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item368);
				TransferInventoryItemWithDebt(context, item364, item365, item366, item367, item368);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 24:
		{
			int argsCount146 = operation.ArgsCount;
			int num146 = argsCount146;
			if (num146 == 4)
			{
				int item317 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item317);
				sbyte item318 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item318);
				sbyte item319 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item319);
				ItemKey item320 = default(ItemKey);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item320);
				ChangeEquipment(context, item317, item318, item319, item320);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 25:
		{
			int argsCount132 = operation.ArgsCount;
			int num132 = argsCount132;
			if (num132 == 4)
			{
				int item281 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item281);
				sbyte item282 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item282);
				short item283 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item283);
				int item284 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item284);
				CreateInventoryItem(context, item281, item282, item283, item284);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 26:
		{
			int argsCount115 = operation.ArgsCount;
			int num115 = argsCount115;
			if (num115 == 2)
			{
				int item238 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item238);
				short item239 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item239);
				List<ItemDisplayData> inventoryItems = GetInventoryItems(item238, item239);
				return GameData.Serializer.Serializer.Serialize(inventoryItems, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 27:
		{
			int argsCount101 = operation.ArgsCount;
			int num101 = argsCount101;
			if (num101 == 1)
			{
				int item213 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item213);
				List<ItemDisplayData> allInventoryItems = GetAllInventoryItems(item213);
				return GameData.Serializer.Serializer.Serialize(allInventoryItems, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 28:
		{
			int argsCount84 = operation.ArgsCount;
			int num84 = argsCount84;
			if (num84 == 3)
			{
				int item178 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item178);
				sbyte item179 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item179);
				short item180 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item180);
				int inventoryItemAmount = GetInventoryItemAmount(item178, item179, item180);
				return GameData.Serializer.Serializer.Serialize(inventoryItemAmount, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 29:
		{
			int argsCount71 = operation.ArgsCount;
			int num71 = argsCount71;
			if (num71 == 1)
			{
				int item144 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item144);
				List<ItemDisplayData> allEquipmentItems = GetAllEquipmentItems(item144);
				return GameData.Serializer.Serializer.Serialize(allEquipmentItems, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 30:
		{
			int argsCount56 = operation.ArgsCount;
			int num56 = argsCount56;
			if (num56 == 2)
			{
				int item115 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item115);
				ItemKey item116 = default(ItemKey);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item116);
				ItemDisplayData inventoryItemDisplayData = GetInventoryItemDisplayData(item115, item116);
				return GameData.Serializer.Serializer.Serialize(inventoryItemDisplayData, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 31:
		{
			int argsCount43 = operation.ArgsCount;
			int num43 = argsCount43;
			if (num43 == 2)
			{
				int item89 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item89);
				ItemKey item90 = default(ItemKey);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item90);
				bool item91 = InventoryContainsItem(item89, item90);
				return GameData.Serializer.Serializer.Serialize(item91, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 32:
			switch (operation.ArgsCount)
			{
			case 2:
			{
				int item80 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item80);
				ItemKey item81 = default(ItemKey);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item81);
				AddEatingItem(context, item80, item81);
				return -1;
			}
			case 3:
			{
				int item77 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item77);
				ItemKey item78 = default(ItemKey);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item78);
				List<sbyte> item79 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item79);
				AddEatingItem(context, item77, item78, item79);
				return -1;
			}
			default:
				throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
			}
		case 33:
		{
			int argsCount25 = operation.ArgsCount;
			int num25 = argsCount25;
			if (num25 == 1)
			{
				int item52 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item52);
				sbyte currMaxEatingSlotsCount = GetCurrMaxEatingSlotsCount(item52);
				return GameData.Serializer.Serializer.Serialize(currMaxEatingSlotsCount, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 34:
		{
			int argsCount9 = operation.ArgsCount;
			int num9 = argsCount9;
			if (num9 == 1)
			{
				int item23 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item23);
				bool item24 = MerchantHasNewGoods(item23);
				return GameData.Serializer.Serializer.Serialize(item24, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 35:
		{
			int argsCount170 = operation.ArgsCount;
			int num170 = argsCount170;
			if (num170 == 3)
			{
				int item379 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item379);
				int item380 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item380);
				ItemKey item381 = default(ItemKey);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item381);
				AddKidnappedCharacter(context, item379, item380, item381);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 36:
		{
			int argsCount159 = operation.ArgsCount;
			int num159 = argsCount159;
			if (num159 == 3)
			{
				int item355 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item355);
				int item356 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item356);
				KidnappedCharacterList item357 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item357);
				TransferKidnappedCharacters(context, item355, item356, item357);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 37:
		{
			int argsCount150 = operation.ArgsCount;
			int num150 = argsCount150;
			if (num150 == 3)
			{
				int item328 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item328);
				int item329 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item329);
				ItemKey item330 = default(ItemKey);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item330);
				ChangeKidnappedCharacterRope(context, item328, item329, item330);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 38:
		{
			int argsCount138 = operation.ArgsCount;
			int num138 = argsCount138;
			if (num138 == 1)
			{
				int item303 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item303);
				int kidnapMaxSlotCount = GetKidnapMaxSlotCount(item303);
				return GameData.Serializer.Serializer.Serialize(kidnapMaxSlotCount, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 39:
		{
			int argsCount129 = operation.ArgsCount;
			int num129 = argsCount129;
			if (num129 == 3)
			{
				int item273 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item273);
				int item274 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item274);
				KidnappedCharacter item275 = new KidnappedCharacter();
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item275);
				TransferKidnappedCharacter(context, item273, item274, item275);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 40:
		{
			int argsCount118 = operation.ArgsCount;
			int num118 = argsCount118;
			if (num118 == 3)
			{
				int item242 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item242);
				int item243 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item243);
				bool item244 = false;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item244);
				RemoveKidnappedCharacter(context, item242, item243, item244);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 41:
		{
			int argsCount109 = operation.ArgsCount;
			int num109 = argsCount109;
			if (num109 == 1)
			{
				int item231 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item231);
				short displayingAge = GetDisplayingAge(item231);
				return GameData.Serializer.Serializer.Serialize(displayingAge, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 42:
		{
			int argsCount98 = operation.ArgsCount;
			int num98 = argsCount98;
			if (num98 == 1)
			{
				int item209 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item209);
				MainAttributes mainAttributesRecoveries = GetMainAttributesRecoveries(item209);
				return GameData.Serializer.Serializer.Serialize(mainAttributesRecoveries, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 43:
		{
			int argsCount89 = operation.ArgsCount;
			int num89 = argsCount89;
			if (num89 == 1)
			{
				int item194 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item194);
				sbyte inscriptionStatus = GetInscriptionStatus(item194);
				return GameData.Serializer.Serializer.Serialize(inscriptionStatus, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 44:
		{
			int argsCount76 = operation.ArgsCount;
			int num76 = argsCount76;
			if (num76 == 1)
			{
				int item166 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item166);
				int[] characterBirthDate = GetCharacterBirthDate(item166);
				return GameData.Serializer.Serializer.Serialize(characterBirthDate, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 45:
		{
			int argsCount68 = operation.ArgsCount;
			int num68 = argsCount68;
			if (num68 == 1)
			{
				int item140 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item140);
				long maxWorthCanBeLentToTaiwu = GetMaxWorthCanBeLentToTaiwu(item140);
				return GameData.Serializer.Serializer.Serialize(maxWorthCanBeLentToTaiwu, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 46:
		{
			int argsCount59 = operation.ArgsCount;
			int num59 = argsCount59;
			if (num59 == 2)
			{
				int item121 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item121);
				ResourceInts item122 = default(ResourceInts);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item122);
				bool item123 = CheckFavorabilityBeforeTransferring(item121, item122);
				return GameData.Serializer.Serializer.Serialize(item123, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 47:
		{
			int argsCount50 = operation.ArgsCount;
			int num50 = argsCount50;
			if (num50 == 1)
			{
				int item103 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item103);
				short clothingDisplayId = GetClothingDisplayId(item103);
				return GameData.Serializer.Serializer.Serialize(clothingDisplayId, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 48:
		{
			int argsCount39 = operation.ArgsCount;
			int num39 = argsCount39;
			if (num39 == 1)
			{
				List<int> item83 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item83);
				List<CharacterDisplayData> characterDisplayDataList = GetCharacterDisplayDataList(item83);
				return GameData.Serializer.Serializer.Serialize(characterDisplayDataList, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 49:
		{
			int argsCount31 = operation.ArgsCount;
			int num31 = argsCount31;
			if (num31 == 2)
			{
				List<int> item62 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item62);
				sbyte item63 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item63);
				List<short> characterLifeSkillAttainmentList = GetCharacterLifeSkillAttainmentList(item62, item63);
				return GameData.Serializer.Serializer.Serialize(characterLifeSkillAttainmentList, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 50:
			if (operation.ArgsCount == 0)
			{
				List<GraveDisplayData> taiwuRelatedGraveDisplayDataList = GetTaiwuRelatedGraveDisplayDataList();
				return GameData.Serializer.Serializer.Serialize(taiwuRelatedGraveDisplayDataList, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		case 51:
		{
			int argsCount13 = operation.ArgsCount;
			int num13 = argsCount13;
			if (num13 == 1)
			{
				List<int> item29 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item29);
				List<GraveDisplayData> graveDisplayDataList = GetGraveDisplayDataList(item29);
				return GameData.Serializer.Serializer.Serialize(graveDisplayDataList, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 52:
		{
			int argsCount3 = operation.ArgsCount;
			int num3 = argsCount3;
			if (num3 == 1)
			{
				List<int> item8 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item8);
				List<CharacterDisplayDataForRelations> characterDisplayDataListForRelations = GetCharacterDisplayDataListForRelations(item8);
				return GameData.Serializer.Serializer.Serialize(characterDisplayDataListForRelations, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 53:
		{
			int argsCount168 = operation.ArgsCount;
			int num168 = argsCount168;
			if (num168 == 1)
			{
				int item376 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item376);
				KidnappedCharacterList someoneKidnapCharacters = GetSomeoneKidnapCharacters(item376);
				return GameData.Serializer.Serializer.Serialize(someoneKidnapCharacters, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 54:
		{
			int argsCount161 = operation.ArgsCount;
			int num161 = argsCount161;
			if (num161 == 1)
			{
				int item360 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item360);
				CharacterAttributeDisplayData characterAttributeDisplayData = GetCharacterAttributeDisplayData(item360);
				return GameData.Serializer.Serializer.Serialize(characterAttributeDisplayData, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 55:
		{
			int argsCount155 = operation.ArgsCount;
			int num155 = argsCount155;
			if (num155 == 1)
			{
				int item347 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item347);
				CharacterSamsaraData characterSamsaraData = GetCharacterSamsaraData(item347);
				return GameData.Serializer.Serializer.Serialize(characterSamsaraData, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 56:
		{
			int argsCount147 = operation.ArgsCount;
			int num147 = argsCount147;
			if (num147 == 4)
			{
				int item321 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item321);
				sbyte item322 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item322);
				sbyte item323 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item323);
				ItemKey item324 = default(ItemKey);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item324);
				CharacterAttributeDisplayData equipmentCompareData = GetEquipmentCompareData(context, item321, item322, item323, item324);
				return GameData.Serializer.Serializer.Serialize(equipmentCompareData, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 57:
		{
			int argsCount141 = operation.ArgsCount;
			int num141 = argsCount141;
			if (num141 == 1)
			{
				List<int> item307 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item307);
				List<GroupCharDisplayData> groupCharDisplayDataList = GetGroupCharDisplayDataList(context, item307);
				return GameData.Serializer.Serializer.Serialize(groupCharDisplayDataList, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 58:
		{
			int argsCount134 = operation.ArgsCount;
			int num134 = argsCount134;
			if (num134 == 1)
			{
				List<int> item291 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item291);
				List<(int, short)> defeatMarkCountList = GetDefeatMarkCountList(item291);
				return GameData.Serializer.Serializer.Serialize(defeatMarkCountList, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 59:
		{
			int argsCount128 = operation.ArgsCount;
			int num128 = argsCount128;
			if (num128 == 2)
			{
				int item271 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item271);
				sbyte item272 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item272);
				int featureMedalValue = GetFeatureMedalValue(item271, item272);
				return GameData.Serializer.Serializer.Serialize(featureMedalValue, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 60:
		{
			int argsCount119 = operation.ArgsCount;
			int num119 = argsCount119;
			if (num119 == 2)
			{
				List<int> item245 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item245);
				sbyte item246 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item246);
				List<(int, short)> featureMedalValueList = GetFeatureMedalValueList(item245, item246);
				return GameData.Serializer.Serializer.Serialize(featureMedalValueList, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 61:
		{
			int argsCount113 = operation.ArgsCount;
			int num113 = argsCount113;
			if (num113 == 1)
			{
				short item236 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item236);
				int fixedCharacterIdByTemplateId = GetFixedCharacterIdByTemplateId(item236);
				return GameData.Serializer.Serializer.Serialize(fixedCharacterIdByTemplateId, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 62:
		{
			int argsCount106 = operation.ArgsCount;
			int num106 = argsCount106;
			if (num106 == 6)
			{
				int item219 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item219);
				int item220 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item220);
				sbyte item221 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item221);
				int item222 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item222);
				int item223 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item223);
				int item224 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item224);
				GmCmd_SimulateNpcCombat(context, item219, item220, item221, item222, item223, item224);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 63:
			if (operation.ArgsCount == 0)
			{
				List<CharIdAndName> item212 = GmCmd_GetAllCharacterName();
				return GameData.Serializer.Serializer.Serialize(item212, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		case 64:
		{
			int argsCount93 = operation.ArgsCount;
			int num93 = argsCount93;
			if (num93 == 3)
			{
				int item202 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item202);
				int item203 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item203);
				short item204 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item204);
				GmCmd_ChangeFavorability(context, item202, item203, item204);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 65:
		{
			int argsCount87 = operation.ArgsCount;
			int num87 = argsCount87;
			if (num87 == 1)
			{
				int item192 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item192);
				GmCmd_ClearFameActionRecords(context, item192);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 66:
			switch (operation.ArgsCount)
			{
			case 2:
			{
				int item188 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item188);
				short item189 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item189);
				GmCmd_RecordFameAction(context, item188, item189, -1, 1);
				return -1;
			}
			case 3:
			{
				int item185 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item185);
				short item186 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item186);
				int item187 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item187);
				GmCmd_RecordFameAction(context, item185, item186, item187, 1);
				return -1;
			}
			case 4:
			{
				int item181 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item181);
				short item182 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item182);
				int item183 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item183);
				short item184 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item184);
				GmCmd_RecordFameAction(context, item181, item182, item183, item184);
				return -1;
			}
			default:
				throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
			}
		case 67:
		{
			int argsCount79 = operation.ArgsCount;
			int num79 = argsCount79;
			if (num79 == 3)
			{
				int item169 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item169);
				sbyte item170 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item170);
				bool item171 = false;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item171);
				GmCmd_CreateRandomIntelligentCharacters(context, item169, item170, item171);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 68:
		{
			int argsCount73 = operation.ArgsCount;
			int num73 = argsCount73;
			if (num73 == 2)
			{
				int item146 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item146);
				sbyte item147 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item147);
				GmCmd_ForceChangeOrganization(context, item146, item147);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 69:
		{
			int argsCount67 = operation.ArgsCount;
			int num67 = argsCount67;
			if (num67 == 3)
			{
				int item136 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item136);
				sbyte item137 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item137);
				bool item138 = false;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item138);
				bool item139 = GmCmd_ForceChangeGrade(context, item136, item137, item138);
				return GameData.Serializer.Serializer.Serialize(item139, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 70:
		{
			int argsCount60 = operation.ArgsCount;
			int num60 = argsCount60;
			if (num60 == 1)
			{
				int item124 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item124);
				GmCmd_Die(context, item124);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 71:
		{
			int argsCount54 = operation.ArgsCount;
			int num54 = argsCount54;
			if (num54 == 1)
			{
				int item111 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item111);
				int item112 = GmCmd_GetAliveCharByPreexistenceChar(item111);
				return GameData.Serializer.Serializer.Serialize(item112, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 72:
			if (operation.ArgsCount == 0)
			{
				GmCmd_LogCharacterSamsaraInfo();
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		case 73:
		{
			int argsCount42 = operation.ArgsCount;
			int num42 = argsCount42;
			if (num42 == 2)
			{
				int item87 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item87);
				NeiliAllocation item88 = default(NeiliAllocation);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item88);
				GmCmd_EditExtraNeiliAllocation(context, item87, item88);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 74:
		{
			int argsCount35 = operation.ArgsCount;
			int num35 = argsCount35;
			if (num35 == 2)
			{
				int item71 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item71);
				int item72 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item72);
				GmCmd_MakeCharacterKidnapped(context, item71, item72);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 75:
		{
			int argsCount29 = operation.ArgsCount;
			int num29 = argsCount29;
			if (num29 == 2)
			{
				int item57 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item57);
				Location item58 = default(Location);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item58);
				bool item59 = GmCmd_MoveIntelligentCharacter(context, item57, item58);
				return GameData.Serializer.Serializer.Serialize(item59, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 76:
		{
			int argsCount22 = operation.ArgsCount;
			int num22 = argsCount22;
			if (num22 == 1)
			{
				sbyte item48 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item48);
				GmCmd_RandomizeRelationShipsInSettlement(context, item48);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 77:
		{
			int argsCount18 = operation.ArgsCount;
			int num18 = argsCount18;
			if (num18 == 4)
			{
				int item36 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item36);
				int item37 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item37);
				bool item38 = false;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item38);
				int item39 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item39);
				GmCmd_MakeCharacterHaveSex(context, item36, item37, item38, item39);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 78:
		{
			int argsCount10 = operation.ArgsCount;
			int num10 = argsCount10;
			if (num10 == 1)
			{
				int item25 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item25);
				int item26 = GmCmd_GetCharacterPregnancyLockEndDates(context, item25);
				return GameData.Serializer.Serializer.Serialize(item26, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 79:
		{
			int argsCount5 = operation.ArgsCount;
			int num5 = argsCount5;
			if (num5 == 1)
			{
				int item11 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item11);
				List<int> item12 = GmCmd_GetCharacterActualBloodParents(context, item11);
				return GameData.Serializer.Serializer.Serialize(item12, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 80:
		{
			int argsCount171 = operation.ArgsCount;
			int num171 = argsCount171;
			if (num171 == 3)
			{
				int item382 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item382);
				int item383 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item383);
				AvatarData item384 = new AvatarData();
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item384);
				bool item385 = CharacterShaveAvatar(context, item382, item383, item384);
				return GameData.Serializer.Serializer.Serialize(item385, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 81:
		{
			int argsCount167 = operation.ArgsCount;
			int num167 = argsCount167;
			if (num167 == 2)
			{
				int item374 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item374);
				byte item375 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item375);
				AllocateNeili(context, item374, item375);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 82:
		{
			int argsCount162 = operation.ArgsCount;
			int num162 = argsCount162;
			if (num162 == 2)
			{
				int item361 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item361);
				byte item362 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item362);
				DeallocateNeili(context, item361, item362);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 83:
		{
			int argsCount158 = operation.ArgsCount;
			int num158 = argsCount158;
			if (num158 == 1)
			{
				int item354 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item354);
				short changeOfQiDisorder = GetChangeOfQiDisorder(item354);
				return GameData.Serializer.Serializer.Serialize(changeOfQiDisorder, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 84:
		{
			int argsCount153 = operation.ArgsCount;
			int num153 = argsCount153;
			if (num153 == 1)
			{
				int item340 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item340);
				CombatResources usableCombatResources = GetUsableCombatResources(item340);
				return GameData.Serializer.Serializer.Serialize(usableCombatResources, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 85:
		{
			int argsCount149 = operation.ArgsCount;
			int num149 = argsCount149;
			if (num149 == 1)
			{
				int item327 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item327);
				sbyte[] combatSkillSlotCounts = GetCombatSkillSlotCounts(item327);
				return GameData.Serializer.Serializer.Serialize(combatSkillSlotCounts, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 86:
		{
			int argsCount144 = operation.ArgsCount;
			int num144 = argsCount144;
			if (num144 == 4)
			{
				int item311 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item311);
				sbyte item312 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item312);
				int item313 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item313);
				short item314 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item314);
				SetCombatSkillSlot(context, item311, item312, item313, item314);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 87:
		{
			int argsCount140 = operation.ArgsCount;
			int num140 = argsCount140;
			if (num140 == 2)
			{
				int item305 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item305);
				sbyte item306 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item306);
				(int, int) combatSkillAttainment = GetCombatSkillAttainment(item305, item306);
				return GameData.Serializer.Serializer.Serialize(combatSkillAttainment, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 88:
		{
			int argsCount135 = operation.ArgsCount;
			int num135 = argsCount135;
			if (num135 == 1)
			{
				int item292 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item292);
				int[] allCombatSkillAttainment = GetAllCombatSkillAttainment(item292);
				return GameData.Serializer.Serializer.Serialize(allCombatSkillAttainment, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 89:
		{
			int argsCount131 = operation.ArgsCount;
			int num131 = argsCount131;
			if (num131 == 2)
			{
				int item279 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item279);
				sbyte item280 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item280);
				(int, int) lifeSkillAttainment = GetLifeSkillAttainment(item279, item280);
				return GameData.Serializer.Serializer.Serialize(lifeSkillAttainment, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 90:
		{
			int argsCount126 = operation.ArgsCount;
			int num126 = argsCount126;
			if (num126 == 1)
			{
				int item269 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item269);
				int[] allLifeSkillAttainment = GetAllLifeSkillAttainment(item269);
				return GameData.Serializer.Serializer.Serialize(allLifeSkillAttainment, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 91:
			switch (operation.ArgsCount)
			{
			case 2:
			{
				int item267 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item267);
				short item268 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item268);
				LearnCombatSkill(context, item267, item268, 0);
				return -1;
			}
			case 3:
			{
				int item264 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item264);
				short item265 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item265);
				ushort item266 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item266);
				LearnCombatSkill(context, item264, item265, item266);
				return -1;
			}
			default:
				throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
			}
		case 92:
			switch (operation.ArgsCount)
			{
			case 2:
			{
				int item260 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item260);
				short item261 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item261);
				LearnLifeSkill(context, item260, item261, 0);
				return -1;
			}
			case 3:
			{
				int item257 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item257);
				short item258 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item258);
				byte item259 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item259);
				LearnLifeSkill(context, item257, item258, item259);
				return -1;
			}
			default:
				throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
			}
		case 93:
		{
			int argsCount121 = operation.ArgsCount;
			int num121 = argsCount121;
			if (num121 == 1)
			{
				int item251 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item251);
				DeadCharacter item252 = TryGetDeadCharacter(item251);
				return GameData.Serializer.Serializer.Serialize(item252, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 94:
		{
			int argsCount116 = operation.ArgsCount;
			int num116 = argsCount116;
			if (num116 == 1)
			{
				int item240 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item240);
				List<short> titles = GetTitles(item240);
				return GameData.Serializer.Serializer.Serialize(titles, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 95:
		{
			int argsCount112 = operation.ArgsCount;
			int num112 = argsCount112;
			if (num112 == 1)
			{
				int item235 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item235);
				sbyte highestGradeCombatSkillById = GetHighestGradeCombatSkillById(item235);
				return GameData.Serializer.Serializer.Serialize(highestGradeCombatSkillById, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 96:
		{
			int argsCount107 = operation.ArgsCount;
			int num107 = argsCount107;
			if (num107 == 1)
			{
				int item225 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item225);
				short leftMaxHealth = GetLeftMaxHealth(item225);
				return GameData.Serializer.Serializer.Serialize(leftMaxHealth, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 97:
		{
			int argsCount103 = operation.ArgsCount;
			int num103 = argsCount103;
			if (num103 == 1)
			{
				int item215 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item215);
				short healthRecovery = GetHealthRecovery(item215);
				return GameData.Serializer.Serializer.Serialize(healthRecovery, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 98:
		{
			int argsCount99 = operation.ArgsCount;
			int num99 = argsCount99;
			if (num99 == 1)
			{
				List<int> item210 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item210);
				List<AvatarRelatedData> avatarRelatedDataList = GetAvatarRelatedDataList(item210);
				return GameData.Serializer.Serializer.Serialize(avatarRelatedDataList, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 99:
		{
			int argsCount95 = operation.ArgsCount;
			int num95 = argsCount95;
			if (num95 == 1)
			{
				int item206 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item206);
				AvatarData avatarData = GetAvatarData(context, item206);
				return GameData.Serializer.Serializer.Serialize(avatarData, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 100:
		{
			int argsCount90 = operation.ArgsCount;
			int num90 = argsCount90;
			if (num90 == 4)
			{
				int item195 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item195);
				int item196 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item196);
				List<ItemKey> item197 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item197);
				bool item198 = false;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item198);
				TransferInventoryItemListWithDebt(context, item195, item196, item197, item198);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 101:
		{
			int argsCount86 = operation.ArgsCount;
			int num86 = argsCount86;
			if (num86 == 1)
			{
				int item191 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item191);
				sbyte fameType = GetFameType(item191);
				return GameData.Serializer.Serializer.Serialize(fameType, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 102:
		{
			int argsCount82 = operation.ArgsCount;
			int num82 = argsCount82;
			if (num82 == 1)
			{
				int item175 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item175);
				AvatarRelatedData avatarRelatedData = GetAvatarRelatedData(item175);
				return GameData.Serializer.Serializer.Serialize(avatarRelatedData, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 103:
		{
			int argsCount78 = operation.ArgsCount;
			int num78 = argsCount78;
			if (num78 == 1)
			{
				List<int> item168 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item168);
				int characterListWisdomCount = GetCharacterListWisdomCount(item168);
				return GameData.Serializer.Serializer.Serialize(characterListWisdomCount, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 104:
		{
			int argsCount74 = operation.ArgsCount;
			int num74 = argsCount74;
			if (num74 == 1)
			{
				List<int> item148 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item148);
				List<IntPair> item149 = SortCharacterListByMaxCombatSkill(item148);
				return GameData.Serializer.Serializer.Serialize(item149, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 105:
		{
			int argsCount70 = operation.ArgsCount;
			int num70 = argsCount70;
			if (num70 == 1)
			{
				int item143 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item143);
				(sbyte, short) characterMaxCombatSkillAttainment = GetCharacterMaxCombatSkillAttainment(item143);
				return GameData.Serializer.Serializer.Serialize(characterMaxCombatSkillAttainment, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 106:
		{
			int argsCount65 = operation.ArgsCount;
			int num65 = argsCount65;
			if (num65 == 1)
			{
				int item133 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item133);
				Debts debts = GetDebts(item133);
				return GameData.Serializer.Serializer.Serialize(debts, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 107:
		{
			int argsCount62 = operation.ArgsCount;
			int num62 = argsCount62;
			if (num62 == 2)
			{
				int item127 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item127);
				ItemKey item128 = default(ItemKey);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item128);
				ItemPowerInfo itemPowerInfo = GetItemPowerInfo(item127, item128);
				return GameData.Serializer.Serializer.Serialize(itemPowerInfo, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 108:
		{
			int argsCount57 = operation.ArgsCount;
			int num57 = argsCount57;
			if (num57 == 1)
			{
				int item117 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item117);
				short item118 = CalcMaxFavorabilityToTaiwuById(item117);
				return GameData.Serializer.Serializer.Serialize(item118, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 109:
		{
			int argsCount53 = operation.ArgsCount;
			int num53 = argsCount53;
			if (num53 == 2)
			{
				int item108 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item108);
				ResourceInts item109 = default(ResourceInts);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item109);
				(sbyte, short) item110 = CheckDebtChange(item108, item109);
				return GameData.Serializer.Serializer.Serialize(item110, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 110:
		{
			int argsCount48 = operation.ArgsCount;
			int num48 = argsCount48;
			if (num48 == 1)
			{
				int item101 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item101);
				int characterWisdomCountById = GetCharacterWisdomCountById(item101);
				return GameData.Serializer.Serializer.Serialize(characterWisdomCountById, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 111:
		{
			int argsCount45 = operation.ArgsCount;
			int num45 = argsCount45;
			if (num45 == 4)
			{
				int item94 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item94);
				int item95 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item95);
				ItemKey item96 = default(ItemKey);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item96);
				int item97 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item97);
				TransferInventoryItemFromAToB(context, item94, item95, item96, item97);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 112:
		{
			int argsCount40 = operation.ArgsCount;
			int num40 = argsCount40;
			if (num40 == 1)
			{
				int item84 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item84);
				GmCmd_SetCurReadingEvent(context, item84);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 113:
		{
			int argsCount37 = operation.ArgsCount;
			int num37 = argsCount37;
			if (num37 == 2)
			{
				int item75 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item75);
				int[] item76 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item76);
				GmCmd_SetAdventurePersonalities(context, item75, item76);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 114:
		{
			int argsCount32 = operation.ArgsCount;
			int num32 = argsCount32;
			if (num32 == 2)
			{
				int item64 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item64);
				short item65 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item65);
				GmCmd_AddFeature(context, item64, item65);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 115:
		{
			int argsCount28 = operation.ArgsCount;
			int num28 = argsCount28;
			if (num28 == 2)
			{
				int item55 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item55);
				List<short> item56 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item56);
				GmCmd_SetFeatures(context, item55, item56);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 116:
		{
			int argsCount23 = operation.ArgsCount;
			int num23 = argsCount23;
			if (num23 == 2)
			{
				int item49 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item49);
				short item50 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item50);
				GmCmd_RemoveFeature(context, item49, item50);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 117:
		{
			int argsCount20 = operation.ArgsCount;
			int num20 = argsCount20;
			if (num20 == 3)
			{
				int item43 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item43);
				int item44 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item44);
				ushort item45 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item45);
				GmCmd_RemoveRelation(context, item43, item44, item45);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 118:
		{
			int argsCount16 = operation.ArgsCount;
			int num16 = argsCount16;
			if (num16 == 1)
			{
				int item32 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item32);
				bool item33 = IsReclusive(item32);
				return GameData.Serializer.Serializer.Serialize(item33, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 119:
		{
			int argsCount12 = operation.ArgsCount;
			int num12 = argsCount12;
			if (num12 == 1)
			{
				int item28 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item28);
				List<ItemDisplayData> inventoryEquipment = GetInventoryEquipment(item28);
				return GameData.Serializer.Serializer.Serialize(inventoryEquipment, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 120:
			if (operation.ArgsCount == 0)
			{
				List<int> filteredCharacterCounts = GetFilteredCharacterCounts();
				return GameData.Serializer.Serializer.Serialize(filteredCharacterCounts, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		case 121:
			if (operation.ArgsCount == 0)
			{
				ClearCharacterSortFilter();
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		case 122:
		{
			int argsCount172 = operation.ArgsCount;
			int num172 = argsCount172;
			if (num172 == 1)
			{
				CharacterSortFilterSettings item386 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item386);
				CharacterList item387 = UpdateSortFilterSettings(item386);
				return GameData.Serializer.Serializer.Serialize(item387, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 123:
		{
			int argsCount169 = operation.ArgsCount;
			int num169 = argsCount169;
			if (num169 == 1)
			{
				CharacterSortFilterSettings item377 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item377);
				CharacterList item378 = InitializeCharacterSortFilter(item377);
				return GameData.Serializer.Serializer.Serialize(item378, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 124:
		{
			int argsCount166 = operation.ArgsCount;
			int num166 = argsCount166;
			if (num166 == 1)
			{
				string item372 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item372);
				CharacterList item373 = FindNameInCurrentSortFilter(item372);
				return GameData.Serializer.Serializer.Serialize(item373, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 125:
		{
			int argsCount163 = operation.ArgsCount;
			int num163 = argsCount163;
			if (num163 == 1)
			{
				List<int> item363 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item363);
				List<CharacterDisplayDataForUltimateSelect> characterDisplayDataListForUltimateSelect = GetCharacterDisplayDataListForUltimateSelect(item363);
				return GameData.Serializer.Serializer.Serialize(characterDisplayDataListForUltimateSelect, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 126:
		{
			int argsCount160 = operation.ArgsCount;
			int num160 = argsCount160;
			if (num160 == 2)
			{
				List<int> item358 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item358);
				sbyte item359 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item359);
				List<int> maxSortingTypeCharIds = GetMaxSortingTypeCharIds(item358, item359);
				return GameData.Serializer.Serializer.Serialize(maxSortingTypeCharIds, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 127:
		{
			int argsCount157 = operation.ArgsCount;
			int num157 = argsCount157;
			if (num157 == 2)
			{
				int item352 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item352);
				int item353 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item353);
				GmCmd_SetCurrNeili(context, item352, item353);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 128:
		{
			int argsCount154 = operation.ArgsCount;
			int num154 = argsCount154;
			if (num154 == 6)
			{
				int item341 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item341);
				sbyte item342 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item342);
				short item343 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item343);
				short item344 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item344);
				short item345 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item345);
				short item346 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item346);
				GmCmd_AddPoisonedInventoryItem(context, item341, item342, item343, item344, item345, item346);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 129:
		{
			int argsCount151 = operation.ArgsCount;
			int num151 = argsCount151;
			if (num151 == 6)
			{
				int item331 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item331);
				sbyte item332 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item332);
				short item333 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item333);
				short item334 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item334);
				short item335 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item335);
				short item336 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item336);
				GmCmd_AddPoisonedEatingItem(context, item331, item332, item333, item334, item335, item336);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 130:
		{
			int argsCount148 = operation.ArgsCount;
			int num148 = argsCount148;
			if (num148 == 2)
			{
				int item325 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item325);
				NeiliProportionOfFiveElements item326 = default(NeiliProportionOfFiveElements);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item326);
				GmCmd_SetCharBaseNeiliProportionOfFiveElements(context, item325, item326);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 131:
		{
			int argsCount145 = operation.ArgsCount;
			int num145 = argsCount145;
			if (num145 == 2)
			{
				int item315 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item315);
				int item316 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item316);
				(ushort, ushort) relationBetweenCharacters = GetRelationBetweenCharacters(item315, item316);
				return GameData.Serializer.Serializer.Serialize(relationBetweenCharacters, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 132:
		{
			int argsCount142 = operation.ArgsCount;
			int num142 = argsCount142;
			if (num142 == 2)
			{
				int item308 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item308);
				sbyte item309 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item309);
				List<ItemDisplayData> inventoryItemsByItemType = GetInventoryItemsByItemType(item308, item309);
				return GameData.Serializer.Serializer.Serialize(inventoryItemsByItemType, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 133:
		{
			int argsCount139 = operation.ArgsCount;
			int num139 = argsCount139;
			if (num139 == 1)
			{
				int item304 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item304);
				CharacterDisplayData characterDisplayData = GetCharacterDisplayData(item304);
				return GameData.Serializer.Serializer.Serialize(characterDisplayData, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 134:
		{
			int argsCount136 = operation.ArgsCount;
			int num136 = argsCount136;
			if (num136 == 1)
			{
				int item301 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item301);
				UnequipAllCombatSkills(context, item301);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 135:
			switch (operation.ArgsCount)
			{
			case 1:
			{
				int item300 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item300);
				AutoEquipCombatSkills(context, item300, -1);
				return -1;
			}
			case 2:
			{
				int item298 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item298);
				short item299 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item299);
				AutoEquipCombatSkills(context, item298, item299);
				return -1;
			}
			default:
				throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
			}
		case 136:
			switch (operation.ArgsCount)
			{
			case 2:
			{
				int item296 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item296);
				short item297 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item297);
				GmCmd_AddCharacterExtraTitle(context, item296, item297);
				return -1;
			}
			case 3:
			{
				int item293 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item293);
				short item294 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item294);
				int item295 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item295);
				GmCmd_AddCharacterExtraTitle(context, item293, item294, item295);
				return -1;
			}
			default:
				throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
			}
		case 137:
		{
			int argsCount133 = operation.ArgsCount;
			int num133 = argsCount133;
			if (num133 == 3)
			{
				int item288 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item288);
				int item289 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item289);
				ushort item290 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item290);
				TryAddAndApplyOneWayRelation(context, item288, item289, item290);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 138:
			switch (operation.ArgsCount)
			{
			case 1:
			{
				Location item287 = default(Location);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item287);
				MoveFuyuHiltLocation(context, item287);
				return -1;
			}
			case 2:
			{
				Location item285 = default(Location);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item285);
				bool item286 = false;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item286);
				MoveFuyuHiltLocation(context, item285, item286);
				return -1;
			}
			default:
				throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
			}
		case 139:
		{
			int argsCount130 = operation.ArgsCount;
			int num130 = argsCount130;
			if (num130 == 3)
			{
				int item276 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item276);
				int item277 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item277);
				ushort item278 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item278);
				TryRemoveOneWayRelation(context, item276, item277, item278);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 140:
		{
			int argsCount127 = operation.ArgsCount;
			int num127 = argsCount127;
			if (num127 == 1)
			{
				int item270 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item270);
				CharacterLoveAndHateItemInfo characterLoveAndHateItemInfo = GetCharacterLoveAndHateItemInfo(context, item270);
				return GameData.Serializer.Serializer.Serialize(characterLoveAndHateItemInfo, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 141:
		{
			int argsCount125 = operation.ArgsCount;
			int num125 = argsCount125;
			if (num125 == 1)
			{
				int item262 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item262);
				bool item263 = IsTemporaryIntelligentCharacter(item262);
				return GameData.Serializer.Serializer.Serialize(item263, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 142:
		{
			int argsCount123 = operation.ArgsCount;
			int num123 = argsCount123;
			if (num123 == 1)
			{
				int item254 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item254);
				int[] mixedPoisonTypeRelatedMarkCountArray = GetMixedPoisonTypeRelatedMarkCountArray(item254);
				return GameData.Serializer.Serializer.Serialize(mixedPoisonTypeRelatedMarkCountArray, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 143:
		{
			int argsCount120 = operation.ArgsCount;
			int num120 = argsCount120;
			if (num120 == 3)
			{
				int item247 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item247);
				ItemKey item248 = default(ItemKey);
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item248);
				int item249 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item249);
				SimulateEatingEffectResult item250 = SimulateEatingEffect(context, item247, item248, item249);
				return GameData.Serializer.Serializer.Serialize(item250, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 144:
		{
			int argsCount117 = operation.ArgsCount;
			int num117 = argsCount117;
			if (num117 == 1)
			{
				int item241 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item241);
				CharacterDisplayDataForTooltip characterDisplayDataForTooltip = GetCharacterDisplayDataForTooltip(item241);
				return GameData.Serializer.Serializer.Serialize(characterDisplayDataForTooltip, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 145:
		{
			int argsCount114 = operation.ArgsCount;
			int num114 = argsCount114;
			if (num114 == 1)
			{
				int item237 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item237);
				GmCmd_SetCurLoopingEvent(context, item237);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 146:
		{
			int argsCount111 = operation.ArgsCount;
			int num111 = argsCount111;
			if (num111 == 1)
			{
				int item234 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item234);
				sbyte healthType = GetHealthType(item234);
				return GameData.Serializer.Serializer.Serialize(healthType, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 147:
		{
			int argsCount108 = operation.ArgsCount;
			int num108 = argsCount108;
			if (num108 == 4)
			{
				int item226 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item226);
				int item227 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item227);
				int item228 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item228);
				short item229 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item229);
				int item230 = CalcFavorabilityDelta(item226, item227, item228, item229);
				return GameData.Serializer.Serializer.Serialize(item230, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 148:
		{
			int argsCount105 = operation.ArgsCount;
			int num105 = argsCount105;
			if (num105 == 1)
			{
				int item218 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item218);
				CharacterLocationDisplayData characterLocationDisplayData = GetCharacterLocationDisplayData(item218);
				return GameData.Serializer.Serializer.Serialize(characterLocationDisplayData, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 149:
		{
			int argsCount102 = operation.ArgsCount;
			int num102 = argsCount102;
			if (num102 == 1)
			{
				int item214 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item214);
				CharacterDisplayDataForMapBlock characterDisplayDataForMapBlock = GetCharacterDisplayDataForMapBlock(item214);
				return GameData.Serializer.Serializer.Serialize(characterDisplayDataForMapBlock, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 150:
		{
			int argsCount100 = operation.ArgsCount;
			int num100 = argsCount100;
			if (num100 == 1)
			{
				List<int> item211 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item211);
				List<int> characterWisdomList = GetCharacterWisdomList(item211);
				return GameData.Serializer.Serializer.Serialize(characterWisdomList, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 151:
		{
			int argsCount97 = operation.ArgsCount;
			int num97 = argsCount97;
			if (num97 == 1)
			{
				sbyte item208 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item208);
				int orCreateSwordTombCharacterIdForNormalInformation = GetOrCreateSwordTombCharacterIdForNormalInformation(context, item208);
				return GameData.Serializer.Serializer.Serialize(orCreateSwordTombCharacterIdForNormalInformation, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 152:
		{
			int argsCount94 = operation.ArgsCount;
			int num94 = argsCount94;
			if (num94 == 1)
			{
				int item205 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item205);
				List<ItemDisplayData> allInventoryItemsExcludeValueZero = GetAllInventoryItemsExcludeValueZero(item205);
				return GameData.Serializer.Serializer.Serialize(allInventoryItemsExcludeValueZero, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 153:
		{
			int argsCount91 = operation.ArgsCount;
			int num91 = argsCount91;
			if (num91 == 1)
			{
				int item199 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item199);
				int addConsummateLevelRequiredMonth = GetAddConsummateLevelRequiredMonth(item199);
				return GameData.Serializer.Serializer.Serialize(addConsummateLevelRequiredMonth, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 154:
		{
			int argsCount88 = operation.ArgsCount;
			int num88 = argsCount88;
			if (num88 == 1)
			{
				int item193 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item193);
				GmCmd_ResetHairGrowth(context, item193);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 155:
		{
			int argsCount85 = operation.ArgsCount;
			int num85 = argsCount85;
			if (num85 == 1)
			{
				short item190 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item190);
				List<TemplateKeyAndCount> allItemsByAreaId = GetAllItemsByAreaId(item190);
				return GameData.Serializer.Serializer.Serialize(allItemsByAreaId, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 156:
		{
			int argsCount83 = operation.ArgsCount;
			int num83 = argsCount83;
			if (num83 == 2)
			{
				int item176 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item176);
				bool item177 = false;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item177);
				SetCombatSkillPlanLock(context, item176, item177);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 157:
		{
			int argsCount80 = operation.ArgsCount;
			int num80 = argsCount80;
			if (num80 == 1)
			{
				int item172 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item172);
				AppendCombatSkillPlan(context, item172);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 158:
		{
			int argsCount77 = operation.ArgsCount;
			int num77 = argsCount77;
			if (num77 == 1)
			{
				int item167 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item167);
				DuplicateCurrentCombatSkillPlan(context, item167);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 159:
		{
			int argsCount75 = operation.ArgsCount;
			int num75 = argsCount75;
			if (num75 == 2)
			{
				int item150 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item150);
				int item151 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item151);
				UpdateCombatSkillPlan(context, item150, item151);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 160:
		{
			int argsCount72 = operation.ArgsCount;
			int num72 = argsCount72;
			if (num72 == 1)
			{
				int item145 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item145);
				(int, int) currentPlanIdAndPlanCount = GetCurrentPlanIdAndPlanCount(item145);
				return GameData.Serializer.Serializer.Serialize(currentPlanIdAndPlanCount, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 161:
		{
			int argsCount69 = operation.ArgsCount;
			int num69 = argsCount69;
			if (num69 == 2)
			{
				int item141 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item141);
				int item142 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item142);
				DeleteCombatSkillPlan(context, item141, item142);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 162:
		{
			int argsCount66 = operation.ArgsCount;
			int num66 = argsCount66;
			if (num66 == 1)
			{
				int item134 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item134);
				bool item135 = IsInteractedWithTaiwu(item134);
				return GameData.Serializer.Serializer.Serialize(item135, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 163:
		{
			int argsCount64 = operation.ArgsCount;
			int num64 = argsCount64;
			if (num64 == 1)
			{
				int item130 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item130);
				bool item131 = IsNeiliAllocationLocked(item130);
				return GameData.Serializer.Serializer.Serialize(item131, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 164:
		{
			int argsCount61 = operation.ArgsCount;
			int num61 = argsCount61;
			if (num61 == 2)
			{
				int item125 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item125);
				sbyte item126 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item126);
				AllocateGenericGrid(context, item125, item126);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 165:
		{
			int argsCount58 = operation.ArgsCount;
			int num58 = argsCount58;
			if (num58 == 2)
			{
				int item119 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item119);
				sbyte item120 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item120);
				DeallocateGenericGrid(context, item119, item120);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 166:
		{
			int argsCount55 = operation.ArgsCount;
			int num55 = argsCount55;
			if (num55 == 1)
			{
				int item113 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item113);
				bool item114 = IsCombatSkillEquipmentLocked(item113);
				return GameData.Serializer.Serializer.Serialize(item114, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 167:
		{
			int argsCount52 = operation.ArgsCount;
			int num52 = argsCount52;
			if (num52 == 1)
			{
				int item107 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item107);
				AutoAllocateNeili(context, item107);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 168:
		{
			int argsCount49 = operation.ArgsCount;
			int num49 = argsCount49;
			if (num49 == 1)
			{
				int item102 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item102);
				AutoSetCombatSkillAttainmentPanels(context, item102);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 169:
		{
			int argsCount47 = operation.ArgsCount;
			int num47 = argsCount47;
			if (num47 == 1)
			{
				int item100 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item100);
				AutoEquipItems(context, item100);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 170:
		{
			int argsCount44 = operation.ArgsCount;
			int num44 = argsCount44;
			if (num44 == 2)
			{
				int item92 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item92);
				bool item93 = false;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item93);
				SetCombatSkillAttainmentLock(context, item92, item93);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 171:
		{
			int argsCount41 = operation.ArgsCount;
			int num41 = argsCount41;
			if (num41 == 1)
			{
				int item85 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item85);
				bool item86 = IsCombatSkillAttainmentLocked(item85);
				return GameData.Serializer.Serializer.Serialize(item86, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 172:
		{
			int argsCount38 = operation.ArgsCount;
			int num38 = argsCount38;
			if (num38 == 1)
			{
				int item82 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item82);
				byte[] genericGridAllocation = GetGenericGridAllocation(item82);
				return GameData.Serializer.Serializer.Serialize(genericGridAllocation, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 173:
		{
			int argsCount36 = operation.ArgsCount;
			int num36 = argsCount36;
			if (num36 == 2)
			{
				int item73 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item73);
				bool item74 = false;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item74);
				SetNeiliAllocationLock(context, item73, item74);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 174:
		{
			int argsCount33 = operation.ArgsCount;
			int num33 = argsCount33;
			if (num33 == 2)
			{
				int item66 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item66);
				short item67 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item67);
				RemoveEquippedCombatSkill(context, item66, item67);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 175:
		{
			int argsCount30 = operation.ArgsCount;
			int num30 = argsCount30;
			if (num30 == 2)
			{
				int item60 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item60);
				short item61 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item61);
				AddEquippedCombatSkill(context, item60, item61);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 176:
		{
			int argsCount27 = operation.ArgsCount;
			int num27 = argsCount27;
			if (num27 == 1)
			{
				int item54 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item54);
				sbyte[] combatSkillExtraSlotCounts = GetCombatSkillExtraSlotCounts(item54);
				return GameData.Serializer.Serializer.Serialize(combatSkillExtraSlotCounts, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 177:
		{
			int argsCount24 = operation.ArgsCount;
			int num24 = argsCount24;
			if (num24 == 1)
			{
				int item51 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item51);
				List<bool> characterAllBodyPartExists = GetCharacterAllBodyPartExists(item51);
				return GameData.Serializer.Serializer.Serialize(characterAllBodyPartExists, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 178:
		{
			int argsCount21 = operation.ArgsCount;
			int num21 = argsCount21;
			if (num21 == 2)
			{
				int item46 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item46);
				int item47 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item47);
				GmCmd_ChangeCharDisorderOfQi(context, item46, item47);
				return -1;
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 179:
			if (operation.ArgsCount == 0)
			{
				NameRelatedData item42 = GenerateRandomName(context);
				return GameData.Serializer.Serializer.Serialize(item42, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		case 180:
		{
			int argsCount17 = operation.ArgsCount;
			int num17 = argsCount17;
			if (num17 == 2)
			{
				int item34 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item34);
				List<int> item35 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item35);
				List<CharacterDisplayDataForRelations> characterDisplayDataListForRelationsWithRelationType = GetCharacterDisplayDataListForRelationsWithRelationType(item34, item35);
				return GameData.Serializer.Serializer.Serialize(characterDisplayDataListForRelationsWithRelationType, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 181:
		{
			int argsCount14 = operation.ArgsCount;
			int num14 = argsCount14;
			if (num14 == 1)
			{
				int item30 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item30);
				short physiologicalAge = GetPhysiologicalAge(item30);
				return GameData.Serializer.Serializer.Serialize(physiologicalAge, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 182:
		{
			int argsCount11 = operation.ArgsCount;
			int num11 = argsCount11;
			if (num11 == 1)
			{
				int item27 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item27);
				byte physiologicalAgeAffector = GetPhysiologicalAgeAffector(item27);
				return GameData.Serializer.Serializer.Serialize(physiologicalAgeAffector, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 183:
		{
			int argsCount8 = operation.ArgsCount;
			int num8 = argsCount8;
			if (num8 == 1)
			{
				int item22 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item22);
				List<KidnappedCharacterDisplayData> kidnappedCharacterDisplayData = GetKidnappedCharacterDisplayData(item22);
				return GameData.Serializer.Serializer.Serialize(kidnappedCharacterDisplayData, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 184:
		{
			int argsCount6 = operation.ArgsCount;
			int num6 = argsCount6;
			if (num6 == 4)
			{
				int item13 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item13);
				int item14 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item14);
				Inventory item15 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item15);
				short item16 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item16);
				int item17 = CalcItemsFavorabilityDelta(item13, item14, item15, item16);
				return GameData.Serializer.Serializer.Serialize(item17, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 185:
		{
			int argsCount4 = operation.ArgsCount;
			int num4 = argsCount4;
			if (num4 == 1)
			{
				int item9 = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item9);
				bool item10 = IsCarrierDurabilityRunningOut(item9);
				return GameData.Serializer.Serializer.Serialize(item10, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		case 186:
		{
			int argsCount = operation.ArgsCount;
			int num = argsCount;
			if (num == 2)
			{
				int item = 0;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item);
				string item2 = null;
				argsOffset += GameData.Serializer.Serializer.Deserialize(argDataPool, argsOffset, ref item2);
				bool item3 = GmCmd_ForceChangeOrganizationByName(context, item, item2);
				return GameData.Serializer.Serializer.Serialize(item3, returnDataPool);
			}
			throw new Exception($"Unsupported argsCount of methodId: {operation.MethodId}");
		}
		default:
			throw new Exception($"Unsupported methodId {operation.MethodId}");
		}
	}

	public override void OnMonitorData(ushort dataId, ulong subId0, uint subId1, bool monitoring)
	{
		switch (dataId)
		{
		case 0:
			break;
		case 1:
			break;
		case 2:
			break;
		case 3:
			break;
		case 4:
			break;
		case 5:
			break;
		case 6:
			break;
		case 7:
			break;
		case 8:
			_modificationsPregnancyLockEndDates.ChangeRecording(monitoring);
			break;
		case 9:
			break;
		case 10:
			break;
		case 11:
			break;
		case 12:
			break;
		case 13:
			break;
		case 14:
			_modificationsJoinGroupDates.ChangeRecording(monitoring);
			break;
		case 15:
			break;
		case 16:
			break;
		case 17:
			break;
		case 18:
			break;
		case 19:
			break;
		case 20:
			break;
		case 21:
			_modificationsCrossAreaMoveInfos.ChangeRecording(monitoring);
			break;
		case 22:
			break;
		case 23:
			break;
		case 24:
			break;
		case 25:
			break;
		case 26:
			break;
		case 27:
			break;
		case 28:
			break;
		case 29:
			_modificationsSubscriberOrders.ChangeRecording(monitoring);
			break;
		default:
			throw new Exception($"Unsupported dataId {dataId}");
		}
	}

	public override int CheckModified(ushort dataId, ulong subId0, uint subId1, RawDataPool dataPool)
	{
		switch (dataId)
		{
		case 0:
			return CheckModified_Objects((int)subId0, (ushort)subId1, dataPool);
		case 1:
			throw new Exception($"Not allow to check modification of dataId {dataId}");
		case 2:
			throw new Exception($"Not allow to check modification of dataId {dataId}");
		case 3:
			throw new Exception($"Not allow to check modification of dataId {dataId}");
		case 4:
			throw new Exception($"Not allow to check modification of dataId {dataId}");
		case 5:
			throw new Exception($"Not allow to check modification of dataId {dataId}");
		case 6:
			return CheckModified_Graves((int)subId0, (ushort)subId1, dataPool);
		case 7:
			throw new Exception($"Not allow to check modification of dataId {dataId}");
		case 8:
		{
			if (!BaseGameDataDomain.IsModified(DataStates, 8))
			{
				return -1;
			}
			BaseGameDataDomain.ResetModified(DataStates, 8);
			int result2 = GameData.Serializer.Serializer.SerializeModifications(_pregnancyLockEndDates, dataPool, _modificationsPregnancyLockEndDates);
			_modificationsPregnancyLockEndDates.Reset();
			return result2;
		}
		case 9:
			if (!BaseGameDataDomain.IsModified(DataStates, 9))
			{
				return -1;
			}
			BaseGameDataDomain.ResetModified(DataStates, 9);
			return GameData.Serializer.Serializer.Serialize(_unguardedChars, dataPool);
		case 10:
			throw new Exception($"Not allow to check modification of dataId {dataId}");
		case 11:
			throw new Exception($"Not allow to check modification of dataId {dataId}");
		case 12:
			throw new Exception($"Not allow to check modification of dataId {dataId}");
		case 13:
			throw new Exception($"Not allow to check modification of dataId {dataId}");
		case 14:
		{
			if (!BaseGameDataDomain.IsModified(DataStates, 14))
			{
				return -1;
			}
			BaseGameDataDomain.ResetModified(DataStates, 14);
			int result4 = GameData.Serializer.Serializer.SerializeModifications(_joinGroupDates, dataPool, _modificationsJoinGroupDates);
			_modificationsJoinGroupDates.Reset();
			return result4;
		}
		case 15:
			throw new Exception($"Not allow to check modification of dataId {dataId}");
		case 16:
			throw new Exception($"Not allow to check modification of dataId {dataId}");
		case 17:
			throw new Exception($"Not allow to check modification of dataId {dataId}");
		case 18:
			throw new Exception($"Not allow to check modification of dataId {dataId}");
		case 19:
			if (!BaseGameDataDomain.IsModified(DataStates, 19))
			{
				return -1;
			}
			BaseGameDataDomain.ResetModified(DataStates, 19);
			return GameData.Serializer.Serializer.Serialize(_targetedForAssassination, dataPool);
		case 20:
			throw new Exception($"Not allow to check modification of dataId {dataId}");
		case 21:
		{
			if (!BaseGameDataDomain.IsModified(DataStates, 21))
			{
				return -1;
			}
			BaseGameDataDomain.ResetModified(DataStates, 21);
			int result3 = GameData.Serializer.Serializer.SerializeModifications(_crossAreaMoveInfos, dataPool, _modificationsCrossAreaMoveInfos);
			_modificationsCrossAreaMoveInfos.Reset();
			return result3;
		}
		case 22:
			throw new Exception($"Not allow to check modification of dataId {dataId}");
		case 23:
			if (!BaseGameDataDomain.IsModified(DataStates, 23))
			{
				return -1;
			}
			BaseGameDataDomain.ResetModified(DataStates, 23);
			return GameData.Serializer.Serializer.Serialize(_mournedOthersChars, dataPool);
		case 24:
			throw new Exception($"Not allow to check modification of dataId {dataId}");
		case 25:
			throw new Exception($"Not allow to check modification of dataId {dataId}");
		case 26:
			if (!BaseGameDataDomain.IsModified(DataStates, 26))
			{
				return -1;
			}
			BaseGameDataDomain.ResetModified(DataStates, 26);
			return GameData.Serializer.Serializer.Serialize(_forceRebelLocation, dataPool);
		case 27:
			if (!BaseGameDataDomain.IsModified(DataStates, 27))
			{
				return -1;
			}
			BaseGameDataDomain.ResetModified(DataStates, 27);
			return GameData.Serializer.Serializer.Serialize(_forceKindLocation, dataPool);
		case 28:
			if (!BaseGameDataDomain.IsModified(DataStates, 28))
			{
				return -1;
			}
			BaseGameDataDomain.ResetModified(DataStates, 28);
			return GameData.Serializer.Serializer.Serialize(_avoidDeathCharId, dataPool);
		case 29:
		{
			if (!BaseGameDataDomain.IsModified(DataStates, 29))
			{
				return -1;
			}
			BaseGameDataDomain.ResetModified(DataStates, 29);
			int result = GameData.Serializer.Serializer.SerializeModifications(_subscriberOrders, dataPool, _modificationsSubscriberOrders);
			_modificationsSubscriberOrders.Reset();
			return result;
		}
		default:
			throw new Exception($"Unsupported dataId {dataId}");
		}
	}

	public override void ResetModifiedWrapper(ushort dataId, ulong subId0, uint subId1)
	{
		switch (dataId)
		{
		case 0:
			ResetModifiedWrapper_Objects((int)subId0, (ushort)subId1);
			break;
		case 1:
			throw new Exception($"Not allow to reset modification state of dataId {dataId}");
		case 2:
			throw new Exception($"Not allow to reset modification state of dataId {dataId}");
		case 3:
			throw new Exception($"Not allow to reset modification state of dataId {dataId}");
		case 4:
			throw new Exception($"Not allow to reset modification state of dataId {dataId}");
		case 5:
			throw new Exception($"Not allow to reset modification state of dataId {dataId}");
		case 6:
			ResetModifiedWrapper_Graves((int)subId0, (ushort)subId1);
			break;
		case 7:
			throw new Exception($"Not allow to reset modification state of dataId {dataId}");
		case 8:
			if (BaseGameDataDomain.IsModified(DataStates, 8))
			{
				BaseGameDataDomain.ResetModified(DataStates, 8);
				_modificationsPregnancyLockEndDates.Reset();
			}
			break;
		case 9:
			if (BaseGameDataDomain.IsModified(DataStates, 9))
			{
				BaseGameDataDomain.ResetModified(DataStates, 9);
			}
			break;
		case 10:
			throw new Exception($"Not allow to reset modification state of dataId {dataId}");
		case 11:
			throw new Exception($"Not allow to reset modification state of dataId {dataId}");
		case 12:
			throw new Exception($"Not allow to reset modification state of dataId {dataId}");
		case 13:
			throw new Exception($"Not allow to reset modification state of dataId {dataId}");
		case 14:
			if (BaseGameDataDomain.IsModified(DataStates, 14))
			{
				BaseGameDataDomain.ResetModified(DataStates, 14);
				_modificationsJoinGroupDates.Reset();
			}
			break;
		case 15:
			throw new Exception($"Not allow to reset modification state of dataId {dataId}");
		case 16:
			throw new Exception($"Not allow to reset modification state of dataId {dataId}");
		case 17:
			throw new Exception($"Not allow to reset modification state of dataId {dataId}");
		case 18:
			throw new Exception($"Not allow to reset modification state of dataId {dataId}");
		case 19:
			if (BaseGameDataDomain.IsModified(DataStates, 19))
			{
				BaseGameDataDomain.ResetModified(DataStates, 19);
			}
			break;
		case 20:
			throw new Exception($"Not allow to reset modification state of dataId {dataId}");
		case 21:
			if (BaseGameDataDomain.IsModified(DataStates, 21))
			{
				BaseGameDataDomain.ResetModified(DataStates, 21);
				_modificationsCrossAreaMoveInfos.Reset();
			}
			break;
		case 22:
			throw new Exception($"Not allow to reset modification state of dataId {dataId}");
		case 23:
			if (BaseGameDataDomain.IsModified(DataStates, 23))
			{
				BaseGameDataDomain.ResetModified(DataStates, 23);
			}
			break;
		case 24:
			throw new Exception($"Not allow to reset modification state of dataId {dataId}");
		case 25:
			throw new Exception($"Not allow to reset modification state of dataId {dataId}");
		case 26:
			if (BaseGameDataDomain.IsModified(DataStates, 26))
			{
				BaseGameDataDomain.ResetModified(DataStates, 26);
			}
			break;
		case 27:
			if (BaseGameDataDomain.IsModified(DataStates, 27))
			{
				BaseGameDataDomain.ResetModified(DataStates, 27);
			}
			break;
		case 28:
			if (BaseGameDataDomain.IsModified(DataStates, 28))
			{
				BaseGameDataDomain.ResetModified(DataStates, 28);
			}
			break;
		case 29:
			if (BaseGameDataDomain.IsModified(DataStates, 29))
			{
				BaseGameDataDomain.ResetModified(DataStates, 29);
				_modificationsSubscriberOrders.Reset();
			}
			break;
		default:
			throw new Exception($"Unsupported dataId {dataId}");
		}
	}

	public override bool IsModifiedWrapper(ushort dataId, ulong subId0, uint subId1)
	{
		return dataId switch
		{
			0 => IsModifiedWrapper_Objects((int)subId0, (ushort)subId1), 
			1 => throw new Exception($"Not allow to verify modification state of dataId {dataId}"), 
			2 => throw new Exception($"Not allow to verify modification state of dataId {dataId}"), 
			3 => throw new Exception($"Not allow to verify modification state of dataId {dataId}"), 
			4 => throw new Exception($"Not allow to verify modification state of dataId {dataId}"), 
			5 => throw new Exception($"Not allow to verify modification state of dataId {dataId}"), 
			6 => IsModifiedWrapper_Graves((int)subId0, (ushort)subId1), 
			7 => throw new Exception($"Not allow to verify modification state of dataId {dataId}"), 
			8 => BaseGameDataDomain.IsModified(DataStates, 8), 
			9 => BaseGameDataDomain.IsModified(DataStates, 9), 
			10 => throw new Exception($"Not allow to verify modification state of dataId {dataId}"), 
			11 => throw new Exception($"Not allow to verify modification state of dataId {dataId}"), 
			12 => throw new Exception($"Not allow to verify modification state of dataId {dataId}"), 
			13 => throw new Exception($"Not allow to verify modification state of dataId {dataId}"), 
			14 => BaseGameDataDomain.IsModified(DataStates, 14), 
			15 => throw new Exception($"Not allow to verify modification state of dataId {dataId}"), 
			16 => throw new Exception($"Not allow to verify modification state of dataId {dataId}"), 
			17 => throw new Exception($"Not allow to verify modification state of dataId {dataId}"), 
			18 => throw new Exception($"Not allow to verify modification state of dataId {dataId}"), 
			19 => BaseGameDataDomain.IsModified(DataStates, 19), 
			20 => throw new Exception($"Not allow to verify modification state of dataId {dataId}"), 
			21 => BaseGameDataDomain.IsModified(DataStates, 21), 
			22 => throw new Exception($"Not allow to verify modification state of dataId {dataId}"), 
			23 => BaseGameDataDomain.IsModified(DataStates, 23), 
			24 => throw new Exception($"Not allow to verify modification state of dataId {dataId}"), 
			25 => throw new Exception($"Not allow to verify modification state of dataId {dataId}"), 
			26 => BaseGameDataDomain.IsModified(DataStates, 26), 
			27 => BaseGameDataDomain.IsModified(DataStates, 27), 
			28 => BaseGameDataDomain.IsModified(DataStates, 28), 
			29 => BaseGameDataDomain.IsModified(DataStates, 29), 
			_ => throw new Exception($"Unsupported dataId {dataId}"), 
		};
	}

	public override void InvalidateCache(BaseGameDataObject sourceObject, DataInfluence influence, DataContext context, bool unconditionallyInfluenceAll)
	{
		switch (influence.TargetIndicator.DataId)
		{
		case 0:
			if (!unconditionallyInfluenceAll)
			{
				List<BaseGameDataObject> list2 = InfluenceChecker.InfluencedObjectsPool.Get();
				if (!InfluenceChecker.GetScope(context, sourceObject, influence.Scope, _objects, list2))
				{
					int count3 = list2.Count;
					for (int k = 0; k < count3; k++)
					{
						BaseGameDataObject baseGameDataObject2 = list2[k];
						List<DataUid> targetUids2 = influence.TargetUids;
						int count4 = targetUids2.Count;
						for (int l = 0; l < count4; l++)
						{
							baseGameDataObject2.InvalidateSelfAndInfluencedCache((ushort)targetUids2[l].SubId1, context);
						}
					}
				}
				else
				{
					BaseGameDataDomain.InvalidateAllAndInfluencedCaches(CacheInfluencesObjects, _dataStatesObjects, influence, context);
				}
				list2.Clear();
				InfluenceChecker.InfluencedObjectsPool.Return(list2);
			}
			else
			{
				BaseGameDataDomain.InvalidateAllAndInfluencedCaches(CacheInfluencesObjects, _dataStatesObjects, influence, context);
			}
			break;
		case 6:
			if (!unconditionallyInfluenceAll)
			{
				List<BaseGameDataObject> list = InfluenceChecker.InfluencedObjectsPool.Get();
				if (!InfluenceChecker.GetScope(context, sourceObject, influence.Scope, _graves, list))
				{
					int count = list.Count;
					for (int i = 0; i < count; i++)
					{
						BaseGameDataObject baseGameDataObject = list[i];
						List<DataUid> targetUids = influence.TargetUids;
						int count2 = targetUids.Count;
						for (int j = 0; j < count2; j++)
						{
							baseGameDataObject.InvalidateSelfAndInfluencedCache((ushort)targetUids[j].SubId1, context);
						}
					}
				}
				else
				{
					BaseGameDataDomain.InvalidateAllAndInfluencedCaches(CacheInfluencesGraves, _dataStatesGraves, influence, context);
				}
				list.Clear();
				InfluenceChecker.InfluencedObjectsPool.Return(list);
			}
			else
			{
				BaseGameDataDomain.InvalidateAllAndInfluencedCaches(CacheInfluencesGraves, _dataStatesGraves, influence, context);
			}
			break;
		default:
			throw new Exception($"Unsupported dataId {influence.TargetIndicator.DataId}");
		case 1:
		case 2:
		case 3:
		case 4:
		case 5:
		case 7:
		case 8:
		case 9:
		case 10:
		case 11:
		case 12:
		case 13:
		case 14:
		case 15:
		case 16:
		case 17:
		case 18:
		case 19:
		case 20:
		case 21:
		case 22:
		case 23:
		case 24:
		case 25:
		case 26:
		case 27:
		case 28:
		case 29:
			throw new Exception($"Cannot invalidate cache state of non-cache data {influence.TargetIndicator.DataId}");
		}
	}

	public unsafe override void ProcessArchiveResponse(OperationWrapper operation, byte* pResult)
	{
		uint num;
		switch (operation.DataId)
		{
		case 0:
			ResponseProcessor.ProcessDynamicObjectCollection(operation, pResult, _objects);
			goto IL_02d1;
		case 1:
			ResponseProcessor.ProcessSingleValue_BasicType_Fixed_Value_Single(operation, pResult, ref _nextObjectId);
			goto IL_02d1;
		case 2:
			ResponseProcessor.ProcessSingleValueCollection_CustomType_Dynamic_Ref(operation, pResult, _deadCharacters);
			goto IL_02d1;
		case 3:
			ResponseProcessor.ProcessSingleValueCollection_CustomType_Fixed_Value<int, DeadCharDeletionState>(operation, pResult, (IDictionary<int, DeadCharDeletionState>)_deadCharDeletionStates, 2);
			goto IL_02d1;
		case 4:
			ResponseProcessor.ProcessSingleValueCollection_CustomType_Fixed_Value<IntPair, VoidValue>(operation, pResult, (IDictionary<IntPair, VoidValue>)_recentDeadCharacters, 0);
			goto IL_02d1;
		case 5:
			ResponseProcessor.ProcessSingleValueCollection_CustomType_Fixed_Value<IntPair, VoidValue>(operation, pResult, (IDictionary<IntPair, VoidValue>)_waitingReincarnationChars, 0);
			goto IL_02d1;
		case 6:
			ResponseProcessor.ProcessDynamicObjectCollection(operation, pResult, _graves);
			goto IL_02d1;
		case 7:
			ResponseProcessor.ProcessSingleValueCollection_CustomType_Dynamic_Ref(operation, pResult, _pregnantStates);
			goto IL_02d1;
		case 8:
			ResponseProcessor.ProcessSingleValueCollection_BasicType_Fixed_Value(operation, pResult, _pregnancyLockEndDates);
			goto IL_02d1;
		case 9:
			ResponseProcessor.ProcessSingleValue_CustomType_Dynamic_Value_Single<CharacterSet>(operation, pResult, ref _unguardedChars);
			goto IL_02d1;
		case 10:
			ResponseProcessor.ProcessSingleValueCollection_CustomType_Dynamic_Ref(operation, pResult, _kidnappedChars);
			goto IL_02d1;
		case 11:
			ResponseProcessor.ProcessSingleValueCollection_CustomType_Fixed_Value<RelationKey, RelatedCharacter>(operation, pResult, (IDictionary<RelationKey, RelatedCharacter>)_relations, 8);
			goto IL_02d1;
		case 12:
			ResponseProcessor.ProcessSingleValueCollection_BasicType_Fixed_Value(operation, pResult, _actualBloodParents);
			goto IL_02d1;
		case 13:
			ResponseProcessor.ProcessSingleValueCollection_CustomType_Dynamic_Value<int, CharacterSet>(operation, pResult, (IDictionary<int, CharacterSet>)_characterGroups);
			goto IL_02d1;
		case 14:
			ResponseProcessor.ProcessSingleValueCollection_BasicType_Fixed_Value(operation, pResult, _joinGroupDates);
			goto IL_02d1;
		case 15:
			ResponseProcessor.ProcessSingleValueCollection_CustomType_Dynamic_Ref(operation, pResult, _debtsToTaiwu);
			goto IL_02d1;
		case 16:
			ResponseProcessor.ProcessSingleValueCollection_CustomType_Dynamic_Value<int, GameData.Utilities.ShortList>(operation, pResult, (IDictionary<int, GameData.Utilities.ShortList>)_soldLibrarySkillBooks);
			goto IL_02d1;
		case 17:
			ResponseProcessor.ProcessSingleValueCollection_CustomType_Fixed_Ref(operation, pResult, _usedCombatResourceObsoletes, 2);
			goto IL_02d1;
		case 18:
			ResponseProcessor.ProcessSingleValueCollection_CustomType_Fixed_Value<int, AvatarElementsGrownDates>(operation, pResult, (IDictionary<int, AvatarElementsGrownDates>)_avatarElementGrowthProgress, 28);
			goto IL_02d1;
		case 19:
			ResponseProcessor.ProcessSingleValue_BasicType_String_Single(operation, pResult, ref _targetedForAssassination);
			goto IL_02d1;
		case 20:
			ResponseProcessor.ProcessSingleValueCollection_CustomType_Dynamic_Ref(operation, pResult, _prioritizedActions);
			goto IL_02d1;
		case 21:
			ResponseProcessor.ProcessSingleValueCollection_CustomType_Dynamic_Ref(operation, pResult, _crossAreaMoveInfos);
			goto IL_02d1;
		case 22:
			ResponseProcessor.ProcessSingleValueCollection_CustomType_Dynamic_Value<int, CharacterSet>(operation, pResult, (IDictionary<int, CharacterSet>)_ongoingVengeances);
			goto IL_02d1;
		case 23:
			ResponseProcessor.ProcessSingleValue_CustomType_Dynamic_Value_Single<CharacterSet>(operation, pResult, ref _mournedOthersChars);
			goto IL_02d1;
		case 24:
			ResponseProcessor.ProcessSingleValue_BasicType_Fixed_Value_Array(operation, pResult, _pregeneratedCityTownGuards, 288);
			goto IL_02d1;
		case 25:
			ResponseProcessor.ProcessSingleValue_BasicType_Fixed_Value_List(operation, pResult, _pregeneratedRandomEnemies);
			goto IL_02d1;
		case 28:
			ResponseProcessor.ProcessSingleValue_BasicType_Fixed_Value_Single(operation, pResult, ref _avoidDeathCharId);
			goto IL_02d1;
		default:
			throw new Exception($"Unsupported dataId {operation.DataId}");
		case 26:
		case 27:
		case 29:
			{
				throw new Exception($"Cannot process archive response of non-archive data {operation.DataId}");
			}
			IL_02d1:
			if (_pendingLoadingOperationIds == null)
			{
				break;
			}
			num = _pendingLoadingOperationIds.Peek();
			if (num == operation.Id)
			{
				_pendingLoadingOperationIds.Dequeue();
				if (_pendingLoadingOperationIds.Count <= 0)
				{
					_pendingLoadingOperationIds = null;
					InitializeInternalDataOfCollections();
					OnLoadedArchiveData();
					DomainManager.Global.CompleteLoading(4);
				}
			}
			break;
		}
	}

	private void InitializeInternalDataOfCollections()
	{
		foreach (KeyValuePair<int, Character> @object in _objects)
		{
			Character value = @object.Value;
			value.CollectionHelperData = HelperDataObjects;
			value.DataStatesOffset = _dataStatesObjects.Create();
		}
		foreach (KeyValuePair<int, Grave> grafe in _graves)
		{
			Grave value2 = grafe.Value;
			value2.CollectionHelperData = HelperDataGraves;
			value2.DataStatesOffset = _dataStatesGraves.Create();
		}
	}

	[DomainMethod]
	public int CreateProtagonist(DataContext context, ProtagonistCreationInfo info)
	{
		sbyte sectOrgTemplateIdByStateTemplateId = MapDomain.GetSectOrgTemplateIdByStateTemplateId(info.TaiwuVillageStateTemplateId);
		short memberId = OrganizationDomain.GetMemberId(sectOrgTemplateIdByStateTemplateId, 5);
		sbyte gender = info.InscribedChar?.Gender ?? info.Gender;
		short characterTemplateId = MapDomain.GetCharacterTemplateId(info.TaiwuVillageStateTemplateId, gender);
		Character character = new Character(characterTemplateId);
		Character.ProtagonistFeatureRelatedStatus protagonistFeatureRelatedStatus = character.OfflineCreateProtagonist(characterTemplateId, memberId, info, context);
		int num = GenerateNextObjectId(context);
		character.OfflineSetId(num);
		AddElement_Objects(num, character);
		StartCreatingCharacter(num);
		DomainManager.Extra.TryAddCharacterAvatarExtraData(context, character.GetId(), info.AvatarExtraData);
		DomainManager.CombatSkill.RegisterCombatSkills(num, protagonistFeatureRelatedStatus.CombatSkills);
		AutoActivateReadCombatSkillNormalPages(context, protagonistFeatureRelatedStatus.CombatSkills, num);
		DomainManager.Taiwu.SetTaiwu(context, character);
		DomainManager.Taiwu.RegisterProtagonistLifeSkillsAndCombatSkills(context, character.GetLearnedLifeSkills(), protagonistFeatureRelatedStatus.CombatSkills, protagonistFeatureRelatedStatus.ReadLifeSkillTemplateId, protagonistFeatureRelatedStatus.ReadCombatSkillTemplateId, protagonistFeatureRelatedStatus.CombatSkillBookPageTypes);
		short mainSettlementMainBlockId = DomainManager.Map.GetMainSettlementMainBlockId(135);
		Location location = new Location(135, mainSettlementMainBlockId);
		character.SetLocation(location, context);
		DomainManager.Taiwu.JoinGroup(context, num, showNotification: false);
		CreateAdoptiveFather(context, character);
		if (protagonistFeatureRelatedStatus.CreateCloseFriend)
		{
			sbyte gender2 = Gender.Flip(gender);
			short characterTemplateId2 = MapDomain.GetCharacterTemplateId(info.TaiwuVillageStateTemplateId, gender2);
			CreateCloseFriend(context, characterTemplateId2, info.Morality, character);
		}
		CreateXiangshuAvatars(context, character);
		character.UpdateHobbyExpirationDate(context);
		short selfLocationInformationId = MapBlock.Instance[MapArea.Instance[MapState.Instance[info.TaiwuVillageStateTemplateId].MainAreaID].SettlementBlockCore[0]].InformationTemplateId;
		DomainManager.Information.AddNormalInformationToCharacter(context, num, new NormalInformation(Config.Information.Instance.Where((InformationItem i) => i.IsGeneral && i.Type == 0 && i.TemplateId != selfLocationInformationId).ToArray().GetRandom(context.Random)
			.TemplateId, 4));
		Events.RaiseCharacterCreated(context, character);
		CompleteCreatingCharacter(num);
		DomainManager.Taiwu.RecordAllOwnedClothing(context);
		DomainManager.Global.OnCurrWorldArchiveDataReady(context, isNewWorld: true);
		return num;
	}

	public void ConvertFixedCharacter(DataContext context, Character fixedChar, Location location, bool recreateAttributesAndQualifications)
	{
		Tester.Assert(fixedChar.GetCreatingType() == 0);
		int id = fixedChar.GetId();
		short templateId = fixedChar.GetTemplateId();
		_fixedCharactersCache.Remove(templateId);
		_convertedFixedCharactersCache[templateId] = id;
		fixedChar.OfflineSetCreatingType(1);
		fixedChar.OfflineSetBirthLocation(location);
		FullName fullName = ConvertFixedCharacterName(context, fixedChar.GetTemplateId(), fixedChar.GetGender());
		fixedChar.SetFullName(fullName, context);
		if (recreateAttributesAndQualifications)
		{
			sbyte b = fixedChar.GetIdealSect();
			if (b < 0)
			{
				b = fixedChar.GetOrganizationInfo().OrgTemplateId;
			}
			fixedChar.OfflineRecreateByGrowingSect(context.Random, b, 4);
		}
		RemoveElement_Objects(id);
		AddElement_Objects(id, fixedChar);
		OrganizationInfo organizationInfo = fixedChar.GetOrganizationInfo();
		if (OrganizationDomain.IsSect(organizationInfo.OrgTemplateId))
		{
			organizationInfo.SettlementId = DomainManager.Organization.GetSettlementIdByOrgTemplateId(organizationInfo.OrgTemplateId);
			fixedChar.SetOrganizationInfo(organizationInfo, context);
			DomainManager.Organization.JoinOrganization(context, fixedChar, organizationInfo);
		}
		else
		{
			if (organizationInfo.OrgTemplateId == 20 || organizationInfo.OrgTemplateId == 19)
			{
				throw new Exception($"{fixedChar.GetId()} is either XiangshuInfected or XiangshuMinion, " + "thus cannot be converted from fixed character to intelligent character");
			}
			if (organizationInfo.OrgTemplateId != 0)
			{
				fixedChar.SetOrganizationInfo(OrganizationInfo.None, context);
			}
		}
		fixedChar.SetCurrMainAttributes(fixedChar.GetMaxMainAttributes(), context);
		DomainManager.Information.RegisterInformation(id, context);
		Location location2 = fixedChar.GetLocation();
		Events.RaiseFixedCharacterLocationChanged(context, id, location2, Location.Invalid);
		fixedChar.SetLocation(location, context);
		Events.RaiseCharacterLocationChanged(context, id, Location.Invalid, location);
	}

	private FullName ConvertFixedCharacterName(DataContext context, short templateId, sbyte gender)
	{
		CharacterItem characterItem = Config.Character.Instance[templateId];
		int customSurnameId = (string.IsNullOrEmpty(characterItem.Surname) ? (-1) : DomainManager.World.RegisterCustomText(context, characterItem.Surname));
		int num = (string.IsNullOrEmpty(characterItem.GivenName) ? (-1) : DomainManager.World.RegisterCustomText(context, characterItem.GivenName));
		FullName result = ((characterItem.Race == 0) ? GenerateRandomHanName(context.Random, customSurnameId, -1, gender, 0) : GenerateRandomZangName(context.Random, gender));
		if (num >= 0)
		{
			result.SetCustomGivenName(num);
		}
		return result;
	}

	public Character CreateFixedCharacter(DataContext context, short templateId)
	{
		Tester.Assert(Config.Character.Instance[templateId].CreatingType == 0);
		if (_fixedCharactersCache.ContainsKey(templateId))
		{
			throw new Exception($"FixedCharacter {templateId} has already been created.");
		}
		Character character = CreatePresetCharacter(context, templateId);
		_fixedCharactersCache.Add(templateId, character.GetId());
		DomainManager.LegendaryBook.UpdateBossCharacterLegendaryBookFeatures(context, character);
		return character;
	}

	public Character CreateFixedEnemy(DataContext context, short templateId)
	{
		Tester.Assert(Config.Character.Instance[templateId].CreatingType == 3);
		return CreatePresetCharacter(context, templateId);
	}

	public Character CreateFixedEnemyWithCreationInfo(DataContext context, short templateId, ref FixedEnemyCreationInfo creationInfo)
	{
		Character character = new Character(templateId);
		if (creationInfo.Gender != -1)
		{
			character.OfflineSetGenderInfo(creationInfo.Gender, character.GetTransgender());
		}
		List<GameData.Domains.CombatSkill.CombatSkill> combatSkills = character.OfflineCreatePresetCharacter(templateId, context);
		ComplementCreatePresetCharacter(context, character, combatSkills);
		return character;
	}

	private Character CreatePresetCharacter(DataContext context, short templateId)
	{
		Character character = new Character(templateId);
		List<GameData.Domains.CombatSkill.CombatSkill> combatSkills = character.OfflineCreatePresetCharacter(templateId, context);
		ComplementCreatePresetCharacter(context, character, combatSkills);
		return character;
	}

	private void ComplementCreatePresetCharacter(DataContext context, Character character, List<GameData.Domains.CombatSkill.CombatSkill> combatSkills)
	{
		int num = GenerateNextObjectId(context);
		character.OfflineSetId(num);
		AddElement_Objects(num, character);
		StartCreatingCharacter(num);
		DomainManager.CombatSkill.RegisterCombatSkills(num, combatSkills);
		DomainManager.Extra.InitCombatSkillProficiency(context, character);
		AutoActivateReadCombatSkillNormalPages(context, combatSkills, num);
		Events.RaiseCharacterCreated(context, character);
	}

	public void OnCharacterCreated(DataContext context, Character character)
	{
		InitializeCharacterItemOwnersOnCreation(context, character);
		InitializeEatingItems(context, character);
	}

	public Character CreateIntelligentCharacter(DataContext context, ref IntelligentCharacterCreationInfo info)
	{
		sbyte stateIdByAreaId = DomainManager.Map.GetStateIdByAreaId(info.Location.AreaId);
		info.GrowingSectGrade = DomainManager.Taiwu.PopStateNewCharacterLegacyGrowingGrade(context, stateIdByAreaId, info.GrowingSectGrade);
		CreateIntelligentCharacterModification mod = ParallelCreateIntelligentCharacter(context, ref info, recordModification: false);
		return ComplementCreateIntelligentCharacter(context, mod, autoComplement: false);
	}

	public Character CreateIntelligentCharacterFromInscription(DataContext context, InscribedCharacter inscribedChar, OrganizationInfo targetOrgInfo)
	{
		Settlement settlement = DomainManager.Organization.GetSettlement(targetOrgInfo.SettlementId);
		sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(settlement.GetLocation().AreaId);
		short characterTemplateId = OrganizationDomain.GetCharacterTemplateId(targetOrgInfo.OrgTemplateId, stateTemplateIdByAreaId, inscribedChar.Gender);
		Character character = new Character(characterTemplateId);
		CreateIntelligentCharacterModification mod = new CreateIntelligentCharacterModification
		{
			Self = character,
			FatherCharId = -1,
			MotherCharId = -1,
			CreateFatherRelation = false,
			CreateMotherRelation = false,
			ReincarnationCharId = -1
		};
		character.OfflineCreateCharacterFromInscription(context, mod, inscribedChar, targetOrgInfo);
		ComplementCreateIntelligentCharacter(context, mod, autoComplement: false);
		return character;
	}

	public static CreateIntelligentCharacterModification ParallelCreateIntelligentCharacter(DataContext context, ref IntelligentCharacterCreationInfo info, bool recordModification = true)
	{
		CreateIntelligentCharacterModification createIntelligentCharacterModification = new CreateIntelligentCharacterModification
		{
			FatherCharId = info.FatherCharId,
			MotherCharId = info.MotherCharId,
			CreateFatherRelation = (info.PregnantState != null && (info.PregnantState.CreateFatherRelation || info.FatherCharId != info.PregnantState.FatherId)),
			CreateMotherRelation = (info.PregnantState?.CreateMotherRelation ?? false),
			ReincarnationCharId = info.ReincarnationCharId,
			DisableBeReincarnatedBySavedSoul = info.DisableBeReincarnatedBySavedSoul
		};
		(createIntelligentCharacterModification.Self = new Character(info.CharTemplateId)).OfflineCreateIntelligentCharacter(context, createIntelligentCharacterModification, ref info);
		if (recordModification)
		{
			ParallelModificationsRecorder parallelModificationsRecorder = context.ParallelModificationsRecorder;
			parallelModificationsRecorder.RecordType(ParallelModificationType.CreateIntelligentCharacter);
			parallelModificationsRecorder.RecordParameterClass(createIntelligentCharacterModification);
			parallelModificationsRecorder.RecordParameterUnmanaged(value: true);
		}
		return createIntelligentCharacterModification;
	}

	public Character ComplementCreateIntelligentCharacter(DataContext context, CreateIntelligentCharacterModification mod, bool autoComplement)
	{
		mod.Father?.SetLegitimateBoysCount(mod.FathersLegitimateBoysCount, context);
		int num = GenerateNextObjectId(context);
		Character self = mod.Self;
		self.OfflineSetId(num);
		mod.ReincarnationCharId = PickReincarnationChar(context, self.GetBirthDate(), mod.ReincarnationCharId, mod.DisableBeReincarnatedBySavedSoul);
		if (mod.ReincarnationCharId >= 0)
		{
			self.OfflineSetPreexistenceCharId(context, mod.ReincarnationCharId);
		}
		ModifySavedSoulCharacter(context, mod, self);
		AddElement_Objects(num, self);
		StartCreatingCharacter(num);
		DomainManager.CombatSkill.RegisterCombatSkills(num, mod.CombatSkills);
		DomainManager.Extra.InitCombatSkillProficiency(context, self);
		AutoActivateReadCombatSkillNormalPages(context, mod.CombatSkills, num);
		self.AddEquipmentAndInventoryItems(context, mod.Equipment, mod.Inventory);
		if (mod.SkillWeaponIds != null && mod.SkillWeaponIds != null)
		{
			self.AddSkillBooksAndWeapons(context, mod.InventorySkillBooks, mod.SkillWeaponIds);
		}
		Events.RaiseCharacterLocationChanged(context, num, Location.Invalid, self.GetLocation());
		SetBloodRelatedRelations(context, num, mod.MotherCharId, mod.FatherCharId, -1, mod.CreateMotherRelation, mod.CreateFatherRelation);
		DomainManager.Organization.JoinOrganization(context, self, self.GetOrganizationInfo());
		if (self.GetCurrInventoryLoad() > self.GetMaxInventoryLoad())
		{
			CreateAccessoryForMaxLoad(context, self);
		}
		self.UpdateHobbyExpirationDate(context);
		if (mod.ReincarnationCharId >= 0)
		{
			Events.RaiseCharacterReincarnated(context, self, mod.ReincarnationCharId);
		}
		Events.RaiseCharacterCreated(context, self);
		DomainManager.Information.RegisterInformation(num, context);
		switch (self.GetAgeGroup())
		{
		case 0:
			AddInfant(num);
			break;
		case 2:
			GenerateCharacterProfession(context, self);
			break;
		}
		if (autoComplement)
		{
			CompleteCreatingCharacter(num);
		}
		return self;
	}

	public void AutoActivateReadCombatSkillNormalPages(DataContext context, IEnumerable<GameData.Domains.CombatSkill.CombatSkill> combatSkills, int charId)
	{
		foreach (GameData.Domains.CombatSkill.CombatSkill combatSkill in combatSkills)
		{
			ushort activationState = combatSkill.GetActivationState();
			if (CombatSkillStateHelper.IsBrokenOut(activationState))
			{
				continue;
			}
			ushort readingState = combatSkill.GetReadingState();
			for (byte b = 1; b < 6; b++)
			{
				byte normalPageInternalIndex = CombatSkillStateHelper.GetNormalPageInternalIndex(0, b);
				bool flag = CombatSkillStateHelper.IsPageRead(readingState, normalPageInternalIndex);
				byte normalPageInternalIndex2 = CombatSkillStateHelper.GetNormalPageInternalIndex(1, b);
				bool flag2 = CombatSkillStateHelper.IsPageRead(readingState, normalPageInternalIndex2);
				byte pageInternalIndex;
				if (flag && flag2)
				{
					pageInternalIndex = (context.Random.NextBool() ? normalPageInternalIndex : normalPageInternalIndex2);
				}
				else if (flag)
				{
					pageInternalIndex = normalPageInternalIndex;
				}
				else
				{
					if (!flag2)
					{
						continue;
					}
					pageInternalIndex = normalPageInternalIndex2;
				}
				DomainManager.CombatSkill.TryActivateCombatSkillBookPageWhenSetReadingState(context, charId, combatSkill.GetId().SkillTemplateId, pageInternalIndex);
			}
		}
	}

	public void ModifySavedSoulCharacter(DataContext context, CreateIntelligentCharacterModification mod, Character character)
	{
		if (DomainManager.Extra.IsSavedSoul(mod.ReincarnationCharId) && _deadCharacters.TryGetValue(mod.ReincarnationCharId, out var value))
		{
			character.OfflineRecreateByGrowingSect(context.Random, character.GetOrganizationInfo().OrgTemplateId, (sbyte)Math.Min(value.OrganizationInfo.Grade + 1, 8));
			sbyte gender = value.Gender;
			AvatarData avatar = value.Avatar;
			bool transgender = gender != avatar.GetGender();
			character.OfflineSetGenderInfo(gender, transgender);
			character.OfflineSetAvatar(avatar);
		}
	}

	private void CreateAccessoryForMaxLoad(DataContext context, Character character)
	{
		short num = 90;
		sbyte b = ItemDomain.GenerateRandomItemGrade(context.Random, character.GetOrganizationInfo().Grade);
		ItemKey itemKey = DomainManager.Item.CreateAccessory(context, (short)(num + b), b);
		character.AddInventoryItem(context, itemKey, 1);
	}

	public Character CreateSkeletonCharacter(DataContext context, Grave grave)
	{
		int id = grave.GetId();
		DeadCharacter deadCharacter = TryGetDeadCharacter(id);
		if (AgeGroup.GetAgeGroup(deadCharacter.CurrAge) != 2)
		{
			return null;
		}
		int num = 298 + deadCharacter.OrganizationInfo.Grade;
		Character character = CreateRandomEnemy(context, (short)num, deadCharacter);
		int id2 = character.GetId();
		grave.SetSkeletonCharId(id2, context);
		_skeletonCharacterCache.Add(id2, id);
		CompleteCreatingCharacter(id2);
		character.SetFullName(deadCharacter.FullName, context);
		character.SetMonkType(deadCharacter.MonkType, context);
		character.SetActualAge(deadCharacter.GetActualAge(), context);
		character.SetCurrAge(deadCharacter.CurrAge, context);
		character.SetMonasticTitle(deadCharacter.MonasticTitle, context);
		character.SetLocation(grave.GetLocation(), context);
		Events.RaiseEnemyCharacterLocationChanged(context, id2, Location.Invalid, character.GetLocation());
		AvatarData avatarData = new AvatarData(deadCharacter.Avatar);
		avatarData.ConvertAvatarToSkeleton();
		character.SetAvatar(avatarData, context);
		ItemKey itemKey = character.GetEquipment()[4];
		sbyte grade = deadCharacter.OrganizationInfo.Grade;
		if (1 == 0)
		{
		}
		short num2;
		switch (grade)
		{
		case 0:
		case 1:
		case 2:
			num2 = 69;
			break;
		case 3:
		case 4:
		case 5:
			num2 = 70;
			break;
		case 6:
		case 7:
		case 8:
			num2 = 71;
			break;
		default:
			throw new Exception($"dead character {id} has an invalid grade {deadCharacter.OrganizationInfo.Grade}");
		}
		if (1 == 0)
		{
		}
		short templateId = num2;
		ItemKey itemKey2 = DomainManager.Item.CreateItem(context, 3, templateId);
		character.AddInventoryItem(context, itemKey2, 1);
		character.ChangeEquipment(context, -1, 4, itemKey2);
		if (itemKey.IsValid())
		{
			character.RemoveInventoryItem(context, itemKey, 1, deleteItem: true);
		}
		return character;
	}

	public Character CreateRandomEnemy(DataContext context, short templateId, DeadCharacter deadCharacter = null)
	{
		Character character = new Character(templateId);
		if (deadCharacter != null)
		{
			character.OfflineSetGenderInfo(deadCharacter.Gender, deadCharacter.Avatar.Gender == deadCharacter.Gender);
		}
		List<GameData.Domains.CombatSkill.CombatSkill> combatSkills = character.OfflineCreateRandomEnemy(templateId, context);
		int num = GenerateNextObjectId(context);
		character.OfflineSetId(num);
		AddElement_Objects(num, character);
		StartCreatingCharacter(num);
		DomainManager.CombatSkill.RegisterCombatSkills(num, combatSkills);
		DomainManager.Extra.InitCombatSkillProficiency(context, character);
		AutoActivateReadCombatSkillNormalPages(context, combatSkills, num);
		Events.RaiseCharacterCreated(context, character);
		character.RemoveUnequippedCombatSkills(context, 25);
		return character;
	}

	public void ConvertRandomEnemy(DataContext context, Character character, Location location)
	{
		Tester.Assert(character.GetCreatingType() == 2);
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		sbyte orgTemplateId = organizationInfo.OrgTemplateId;
		if ((uint)(orgTemplateId - 19) <= 1u)
		{
			throw new Exception($"{character.GetId()} is either XiangshuInfected or XiangshuMinion, " + "thus cannot be converted from random enemy to intelligent character");
		}
		if (!location.IsValid() || location.AreaId >= 135)
		{
			location = DomainManager.Taiwu.GetTaiwuVillageLocation();
		}
		int id = character.GetId();
		short templateId = character.GetTemplateId();
		CharacterItem characterItem = Config.Character.Instance[templateId];
		sbyte gender = character.GetGender();
		sbyte stateTemplateIdByAreaId = DomainManager.Map.GetStateTemplateIdByAreaId(location.AreaId);
		sbyte sectID = MapState.Instance[stateTemplateIdByAreaId].SectID;
		short characterTemplateId = OrganizationDomain.GetCharacterTemplateId(sectID, stateTemplateIdByAreaId, gender);
		character.OfflineSetTemplateId(characterTemplateId);
		character.OfflineSetCreatingType(1);
		character.OfflineCreateRandomName(context.Random);
		character.OfflineSetBirthLocation(location);
		character.SetFullName(character.GetFullName(), context);
		List<short> featureIds = character.GetFeatureIds();
		featureIds.Remove(340);
		RemoveElement_Objects(id);
		AddElement_Objects(id, character);
		OrganizationInfo none = OrganizationInfo.None;
		character.SetOrganizationInfo(none, context);
		Events.RaiseCharacterOrganizationChanged(context, character, organizationInfo, none);
		DomainManager.Adventure.RemoveTemporaryEnemyId(id);
		DomainManager.Information.RegisterInformation(id, context);
		Location location2 = character.GetLocation();
		character.SetLocation(location, context);
		if (character.IsCompletelyInfected())
		{
			Events.RaiseInfectedCharacterLocationChanged(context, id, location2, location);
		}
		else
		{
			Events.RaiseCharacterLocationChanged(context, id, location2, location);
		}
	}

	public Character CreateTemporaryIntelligentCharacter(DataContext context, short characterFilterRulesId, Location location)
	{
		TemporaryIntelligentCharacterCreationInfo charCreationInfo = new TemporaryIntelligentCharacterCreationInfo
		{
			Location = location
		};
		GameData.Domains.Character.Filters.CharacterFilterRules.GetRandomCharacterPropertiesWithRulesId(context.Random, characterFilterRulesId, ref charCreationInfo);
		return CreateTemporaryIntelligentCharacter(context, ref charCreationInfo);
	}

	public Character CreateTemporaryIntelligentCharacter(DataContext context, ref TemporaryIntelligentCharacterCreationInfo tmpInfo)
	{
		IntelligentCharacterCreationInfo info = new IntelligentCharacterCreationInfo(tmpInfo.Location, tmpInfo.OrgInfo, tmpInfo.CharTemplateId);
		if (tmpInfo.ActualAge.HasValue)
		{
			info.Age = tmpInfo.ActualAge.Value;
		}
		if (tmpInfo.BaseAttraction.HasValue)
		{
			info.BaseAttraction = tmpInfo.BaseAttraction.Value;
		}
		Character character = new Character(info.CharTemplateId);
		CreateIntelligentCharacterModification createIntelligentCharacterModification = new CreateIntelligentCharacterModification
		{
			Self = character
		};
		character.OfflineCreateTemporaryIntelligentCharacter(context, createIntelligentCharacterModification, ref info, ref tmpInfo);
		int num = GenerateNextObjectId(context);
		character.OfflineSetId(num);
		AddElement_Objects(num, character);
		StartCreatingCharacter(num);
		if (tmpInfo.MonkType.HasValue)
		{
			SetMonkOfTemporaryIntelligentCharacter(context, character, tmpInfo.MonkType.Value);
		}
		DomainManager.CombatSkill.RegisterCombatSkills(num, createIntelligentCharacterModification.CombatSkills);
		DomainManager.Extra.InitCombatSkillProficiency(context, character);
		AutoActivateReadCombatSkillNormalPages(context, createIntelligentCharacterModification.CombatSkills, num);
		character.AddEquipmentAndInventoryItems(context, createIntelligentCharacterModification.Equipment, createIntelligentCharacterModification.Inventory);
		character.AddSkillBooksAndWeapons(context, createIntelligentCharacterModification.InventorySkillBooks, createIntelligentCharacterModification.SkillWeaponIds);
		character.ChangeResources(context, ref tmpInfo.Resources);
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		if (OrganizationDomain.IsSect(organizationInfo.OrgTemplateId) && organizationInfo.Grade == 8 && organizationInfo.Principal)
		{
			character.AddFeature(context, 405);
		}
		DomainManager.Organization.TryAddSectMemberFeature(context, character, organizationInfo);
		Events.RaiseCharacterCreated(context, character);
		CompleteCreatingCharacter(num);
		RegisterTemporaryIntelligentCharacter(num);
		return character;
	}

	public void ConvertTemporaryIntelligentCharacter(DataContext context, Character character)
	{
		int id = character.GetId();
		if (character.IsCompletelyInfected())
		{
			Events.RaiseInfectedCharacterLocationChanged(context, id, Location.Invalid, character.GetLocation());
		}
		else
		{
			Events.RaiseCharacterLocationChanged(context, id, Location.Invalid, character.GetLocation());
		}
		DomainManager.Organization.JoinOrganization(context, character, character.GetOrganizationInfo());
		DomainManager.Adventure.KeepTemporaryCharacterAfterAdventure(id);
		character.UpdateHobbyExpirationDate(context);
		UnregisterTemporaryIntelligentCharacter(id);
	}

	public Character CreateTemporaryCopyOfCharacter(DataContext context, Character srcCharacter)
	{
		int id = srcCharacter.GetId();
		Character character = GameData.Serializer.Serializer.CreateCopy(srcCharacter);
		int num = GenerateNextObjectId(context);
		character.OfflineSetId(num);
		character.OfflineSetCopySource(id);
		AddElement_Objects(num, character);
		StartCreatingCharacter(num);
		List<GameData.Domains.CombatSkill.CombatSkill> list = ObjectPool<List<GameData.Domains.CombatSkill.CombatSkill>>.Instance.Get();
		list.Clear();
		foreach (short learnedCombatSkill in srcCharacter.GetLearnedCombatSkills())
		{
			GameData.Domains.CombatSkill.CombatSkill element_CombatSkills = DomainManager.CombatSkill.GetElement_CombatSkills(new CombatSkillKey(id, learnedCombatSkill));
			GameData.Domains.CombatSkill.CombatSkill combatSkill = GameData.Serializer.Serializer.CreateCopy(element_CombatSkills);
			combatSkill.OfflineSetCharId(num);
			combatSkill.OfflineSetSpecialEffectId(-1L);
			list.Add(combatSkill);
		}
		DomainManager.CombatSkill.RegisterCombatSkills(num, list);
		AutoActivateReadCombatSkillNormalPages(context, list, num);
		DomainManager.Extra.CopyCombatSkillProficiency(context, id, num);
		ObjectPool<List<GameData.Domains.CombatSkill.CombatSkill>>.Instance.Return(list);
		ItemKey[] equipment = srcCharacter.GetEquipment();
		for (int i = 0; i < equipment.Length; i++)
		{
			ItemKey srcItemKey = equipment[i];
			if (srcItemKey.IsValid())
			{
				ItemKey itemKey = DomainManager.Item.CreateCopyOfItem(context, srcItemKey);
				character.AddInventoryItem(context, itemKey, 1);
			}
		}
		Dictionary<ItemKey, int> items = srcCharacter.GetInventory().Items;
		foreach (var (srcItemKey2, amount) in items)
		{
			if (ItemTemplateHelper.GetItemSubType(srcItemKey2.ItemType, srcItemKey2.TemplateId) != 1202)
			{
				ItemKey itemKey3 = DomainManager.Item.CreateCopyOfItem(context, srcItemKey2);
				character.AddInventoryItem(context, itemKey3, amount);
			}
		}
		character.SetLocation(srcCharacter.GetValidLocation(), context);
		DomainManager.Information.RegisterInformation(num, context);
		Events.RaiseCharacterCreated(context, character);
		CompleteCreatingCharacter(num);
		RegisterTemporaryIntelligentCharacter(num);
		return character;
	}

	public void Possession(DataContext context, int charId, DeadCharacter deadChar, Character bodyChar, AvatarData customAvatarData)
	{
		RemoveElement_Objects(charId);
		bodyChar.OfflinePossession(deadChar);
		AddElement_Objects(charId, bodyChar);
		if (customAvatarData != null)
		{
			bodyChar.SetAvatar(context, customAvatarData);
		}
	}

	public void PossessionRemoveWaitingReincarnationChar(DataContext context, int charId)
	{
		IntPair elementId = default(IntPair);
		bool flag = false;
		foreach (IntPair item in _waitingReincarnationChars.Collection)
		{
			if (item.Second == charId)
			{
				flag = true;
				elementId = item;
				break;
			}
		}
		if (flag)
		{
			RemoveElement_WaitingReincarnationChars(elementId, context);
		}
	}

	private int GenerateNextObjectId(DataContext context)
	{
		int nextObjectId = _nextObjectId;
		_nextObjectId++;
		if ((uint)_nextObjectId > 2147483647u)
		{
			_nextObjectId = 0;
		}
		SetNextObjectId(_nextObjectId, context);
		return nextObjectId;
	}

	private void InitializeCharacterItemOwnersOnCreation(DataContext context, Character character)
	{
		int id = character.GetId();
		Inventory inventory = character.GetInventory();
		foreach (var (itemKey2, _) in inventory.Items)
		{
			DomainManager.Item.SetOwner(itemKey2, ItemOwnerType.CharacterInventory, id);
		}
		ItemKey[] equipment = character.GetEquipment();
		ItemKey[] array = equipment;
		for (int i = 0; i < array.Length; i++)
		{
			ItemKey itemKey3 = array[i];
			if (itemKey3.IsValid())
			{
				EquipmentBase baseEquipment = DomainManager.Item.GetBaseEquipment(itemKey3);
				baseEquipment.SetEquippedCharId(id, context);
				baseEquipment.SetOwner(ItemOwnerType.CharacterEquipment, id);
			}
		}
	}

	private void InitializeEatingItems(DataContext context, Character character)
	{
		CharacterItem template = character.Template;
		if (template.PresetEatingItems == null)
		{
			return;
		}
		foreach (PresetItemTemplateId presetEatingItem in template.PresetEatingItems)
		{
			if (ItemTemplateHelper.IsWug(presetEatingItem.ItemType, presetEatingItem.TemplateId, includeKing: false))
			{
				character.AddWug(context, presetEatingItem.TemplateId);
				continue;
			}
			ItemKey itemKey = DomainManager.Item.CreateItem(context, presetEatingItem.ItemType, presetEatingItem.TemplateId);
			character.AddEatingItem(context, itemKey);
		}
	}

	internal int GetRandomValidAdopterInSettlement(IRandomSource random, Settlement settlement)
	{
		List<int> list = ObjectPool<List<int>>.Instance.Get();
		settlement.GetMembers().GetAllMembers(list);
		CharacterMatcherItem canAdoptChild = CharacterMatcher.DefValue.CanAdoptChild;
		for (int num = list.Count - 1; num >= 0; num--)
		{
			int objectId = list[num];
			Character element_Objects = GetElement_Objects(objectId);
			if (!canAdoptChild.Match(element_Objects))
			{
				CollectionUtils.SwapAndRemove(list, num);
			}
		}
		int random2 = list.GetRandom(random);
		ObjectPool<List<int>>.Instance.Return(list);
		return random2;
	}

	private void CreateAdoptiveFather(DataContext context, Character protagonistChar)
	{
		Character character = CreateFixedCharacter(context, 453);
		int id = character.GetId();
		int id2 = protagonistChar.GetId();
		if (!RelationTypeHelper.AllowAddingAdoptiveParentRelation(id2, id))
		{
			throw new Exception($"Failed to add adoptive parent relation: {id2} - {id}");
		}
		AddRelation(context, id2, id, 64);
		DirectlySetFavorabilities(context, id2, id, 30000, 30000);
		CompleteCreatingCharacter(id);
	}

	public Character CreateCloseFriend(DataContext context, short charTemplateId, short morality, Character protagonistChar)
	{
		short settlementIdByOrgTemplateId = DomainManager.Organization.GetSettlementIdByOrgTemplateId(0);
		IntelligentCharacterCreationInfo intelligentCharacterCreationInfo = new IntelligentCharacterCreationInfo(orgInfo: new OrganizationInfo(0, 8, principal: true, settlementIdByOrgTemplateId), location: protagonistChar.GetLocation(), charTemplateId: charTemplateId);
		intelligentCharacterCreationInfo.GrowingSectGrade = 8;
		intelligentCharacterCreationInfo.Age = 13;
		intelligentCharacterCreationInfo.BaseAttraction = 900;
		IntelligentCharacterCreationInfo info = intelligentCharacterCreationInfo;
		CreateIntelligentCharacterModification createIntelligentCharacterModification = ParallelCreateIntelligentCharacter(context, ref info, recordModification: false);
		Character self = createIntelligentCharacterModification.Self;
		self.OfflineSetCloseFriendFields(context, morality);
		FeatureCreationContext featureCreationContext = new FeatureCreationContext(self, ref info);
		featureCreationContext.IsProtagonist = true;
		featureCreationContext.AllGoodBasicFeature = true;
		FeatureCreationContext creationContext = featureCreationContext;
		CharacterCreation.CreateFeatures(context.Random, ref creationContext);
		ComplementCreateIntelligentCharacter(context, createIntelligentCharacterModification, autoComplement: false);
		int id = self.GetId();
		DomainManager.Taiwu.JoinGroup(context, id, showNotification: false);
		int id2 = protagonistChar.GetId();
		if (!RelationTypeHelper.AllowAddingFriendRelation(id2, id))
		{
			throw new Exception($"Failed to add friend relation: {id2} - {id}");
		}
		AddRelation(context, id2, id, 8192);
		DirectlySetFavorabilities(context, id2, id, 30000, 30000);
		CompleteCreatingCharacter(id);
		return self;
	}

	private void CreateXiangshuAvatars(DataContext context, Character protagonistChar)
	{
		int id = protagonistChar.GetId();
		for (int i = 0; i < 9; i++)
		{
			short templateId = XiangshuAvatarIds.JuniorXiangshuTemplateIds[i];
			Character character = CreateFixedCharacter(context, templateId);
			int id2 = character.GetId();
			CompleteCreatingCharacter(id2);
			AddRelation(context, id, id2, 0);
			DirectlySetFavorabilities(context, id, id2, 0, 0);
			XiangshuAvatarTaskStatus element_XiangshuAvatarTaskStatuses = DomainManager.World.GetElement_XiangshuAvatarTaskStatuses(i);
			element_XiangshuAvatarTaskStatuses.JuniorXiangshuCharId = id2;
			DomainManager.World.SetElement_XiangshuAvatarTaskStatuses(i, element_XiangshuAvatarTaskStatuses, context);
		}
	}

	public int CreateJuniorXiangshuCombatImage(DataContext context, sbyte xiangshuAvatarId)
	{
		sbyte xiangshuLevel = DomainManager.World.GetXiangshuLevel();
		return CreateXiangshuCombatImage(context, xiangshuAvatarId, 3, xiangshuLevel);
	}

	public int CreateXiangshuCombatImage(DataContext context, sbyte xiangshuAvatarId, sbyte xiangshuType, sbyte xiangshuLevel)
	{
		Tester.Assert(xiangshuType == 3 || xiangshuType == 4);
		XiangshuAvatarTaskStatus element_XiangshuAvatarTaskStatuses = DomainManager.World.GetElement_XiangshuAvatarTaskStatuses(xiangshuAvatarId);
		short currentLevelXiangshuTemplateId = XiangshuAvatarIds.GetCurrentLevelXiangshuTemplateId(xiangshuAvatarId, xiangshuLevel);
		Character character = _objects[element_XiangshuAvatarTaskStatuses.JuniorXiangshuCharId];
		Character character2 = CreatePresetCharacter(context, currentLevelXiangshuTemplateId);
		int id = character2.GetId();
		character2.OfflineSetXiangshuType(xiangshuType);
		CompleteCreatingCharacter(id);
		character2.SetActualAge(character.GetActualAge(), context);
		character2.SetCurrAge(character.GetCurrAge(), context);
		character2.SetHappiness(character.GetHappiness(), context);
		character2.SetHealth(character2.GetLeftMaxHealth(), context);
		int taiwuCharId = DomainManager.Taiwu.GetTaiwuCharId();
		RelatedCharacter relation = GetRelation(element_XiangshuAvatarTaskStatuses.JuniorXiangshuCharId, taiwuCharId);
		AddRelation(context, taiwuCharId, id, 0);
		DirectlySetFavorabilities(context, taiwuCharId, id, 0, relation.Favorability);
		DomainManager.Adventure.AddTemporaryEnemyId(id);
		return id;
	}

	private static (OrganizationInfo parentOrgInfo, short baseTemplateId, bool isAbandoned) GetMainParentInfo(Character mother, Character father, bool createMotherRelation, bool createFatherRelation, bool isMotherDead)
	{
		bool flag = createFatherRelation && father != null;
		bool flag2 = createMotherRelation && !isMotherDead;
		bool item = (!flag || father.GetKidnapperId() >= 0) && !flag2;
		return flag ? (parentOrgInfo: father.GetOrganizationInfo(), baseTemplateId: GetBaseTemplateId(father.GetTemplateId(), father.GetGender()), isAbandoned: item) : (parentOrgInfo: mother.GetOrganizationInfo(), baseTemplateId: GetBaseTemplateId(mother.GetTemplateId(), mother.GetGender()), isAbandoned: item);
	}

	private static (short baseAttraction, AvatarData avatar) GenerateMainChildAvatar(IRandomSource random, Character mother, Character father, DeadCharacter deadFather, sbyte mainChildGender)
	{
		short item = -1;
		AvatarData avatarData = null;
		AvatarData avatar = mother.GetAvatar();
		AvatarData avatarData2 = father?.GetAvatar() ?? deadFather?.Avatar;
		if (avatar != null || avatarData2 != null)
		{
			avatarData = AvatarManager.Instance.GetRandomAvatar(random, mainChildGender, transgender: false, -1, avatarData2, avatar);
			item = avatarData.GetBaseCharm();
		}
		return (baseAttraction: item, avatar: avatarData);
	}

	private void SetBloodRelatedRelations(DataContext context, int charId, int motherId, int fatherId, int actualFatherId, bool createMotherRelation, bool createFatherRelation)
	{
		if (motherId >= 0)
		{
			if (createMotherRelation)
			{
				AddBloodParentRelations(context, charId, motherId);
			}
			else
			{
				AddChildAbandonment(context, -2, charId, motherId);
			}
		}
		if (fatherId < 0)
		{
			return;
		}
		if (createFatherRelation)
		{
			AddBloodParentRelations(context, charId, fatherId);
			if (actualFatherId >= 0)
			{
				AddFatherSubstitution(context, fatherId, charId, actualFatherId);
			}
		}
		else
		{
			AddChildAbandonment(context, -1, charId, fatherId);
		}
	}

	private static void SetMonkOfTemporaryIntelligentCharacter(DataContext context, Character character, byte monkType)
	{
		OrganizationInfo organizationInfo = character.GetOrganizationInfo();
		if (!CheckMonkTypeCompatibility(organizationInfo, monkType))
		{
			throw new Exception($"Monk type of character is not compatible with organization: {monkType}, {organizationInfo.OrgTemplateId}");
		}
		if (monkType != 0)
		{
			if ((monkType & 0x80) == 0)
			{
				character.SetMonkType(monkType, context);
			}
			else
			{
				DomainManager.Organization.BecomeSectMonk(context, character, -1);
			}
		}
	}

	private static bool CheckMonkTypeCompatibility(OrganizationInfo orgInfo, byte selfMonkType)
	{
		OrganizationItem organizationItem = Config.Organization.Instance[orgInfo.OrgTemplateId];
		short index = organizationItem.Members[orgInfo.Grade];
		OrganizationMemberItem organizationMemberItem = OrganizationMember.Instance[index];
		if (organizationMemberItem.MonkType == 0)
		{
			if (selfMonkType == 0)
			{
				return true;
			}
			return !organizationItem.IsSect && (selfMonkType & 0x80) == 0;
		}
		if (selfMonkType == 0)
		{
			return organizationMemberItem.ProbOfBecomingMonk < 100;
		}
		return organizationMemberItem.MonkType == selfMonkType;
	}

	private void StartCreatingCharacter(int charId)
	{
		_creatingCharIds.Add(charId);
	}

	public void CompleteCreatingCharacter(int charId)
	{
		if (!_creatingCharIds.Remove(charId))
		{
			throw new Exception($"Character {charId} is not in creating state");
		}
	}

	private bool IsCharacterCreating(int charId)
	{
		return _creatingCharIds.Contains(charId);
	}

	private bool IsAnyCharacterCreating()
	{
		return _creatingCharIds.Count > 0;
	}

	private void RegisterPrevBookOwnerCopiesAsTemporaryCharacters(DataContext context, DataUid uid)
	{
		if (DomainManager.Global.GetLoadedAllArchiveData())
		{
			DomainManager.Extra.GetAllPrevLegendaryBookOwnerCopies(context, _temporaryIntelligentCharIds, onInit: true);
			GameData.GameDataBridge.GameDataBridge.RemovePostDataModificationHandler(uid, "RegisterPrevBookOwnerCopiesAsTemporaryCharacters");
		}
	}

	public void RegisterTemporaryIntelligentCharacter(int charId)
	{
		_temporaryIntelligentCharIds.Add(charId);
	}

	public void UnregisterTemporaryIntelligentCharacter(int charId)
	{
		if (!_temporaryIntelligentCharIds.Remove(charId))
		{
			throw new Exception($"Character {charId} is not temporary-intelligent-character");
		}
	}

	[DomainMethod]
	public bool IsTemporaryIntelligentCharacter(int charId)
	{
		return _temporaryIntelligentCharIds.Contains(charId);
	}

	public void CheckCharacterCreationState()
	{
		if (_creatingCharIds.Count <= 0)
		{
			return;
		}
		StringBuilder stringBuilder = new StringBuilder("Some characters are still in creating state:\n");
		foreach (int creatingCharId in _creatingCharIds)
		{
			if (TryGetElement_Objects(creatingCharId, out var element))
			{
				StringBuilder stringBuilder2 = stringBuilder;
				StringBuilder stringBuilder3 = stringBuilder2;
				StringBuilder.AppendInterpolatedStringHandler handler = new StringBuilder.AppendInterpolatedStringHandler(38, 4, stringBuilder2);
				handler.AppendLiteral("  TemplateId: ");
				handler.AppendFormatted(element.GetTemplateId());
				handler.AppendLiteral(", CreatingType: ");
				handler.AppendFormatted(element.GetCreatingType());
				handler.AppendLiteral(", Name: ");
				handler.AppendFormatted(element.GetSurname());
				handler.AppendFormatted(element.GetGivenName());
				stringBuilder3.AppendLine(ref handler);
			}
			else
			{
				StringBuilder stringBuilder2 = stringBuilder;
				StringBuilder stringBuilder4 = stringBuilder2;
				StringBuilder.AppendInterpolatedStringHandler handler = new StringBuilder.AppendInterpolatedStringHandler(37, 1, stringBuilder2);
				handler.AppendLiteral("  CharacterId: ");
				handler.AppendFormatted(creatingCharId);
				handler.AppendLiteral(" (Character not found)");
				stringBuilder4.AppendLine(ref handler);
			}
		}
		throw new Exception(stringBuilder.ToString());
	}

	public void CheckTemporaryIntelligentCharacters()
	{
		if (_temporaryIntelligentCharIds.Count <= 0)
		{
			return;
		}
		int num = 0;
		StringBuilder stringBuilder = new StringBuilder("There are still some temporary-intelligent-characters:\n");
		foreach (int temporaryIntelligentCharId in _temporaryIntelligentCharIds)
		{
			if (!DomainManager.Extra.IsPrevLegendaryBookOwnerCopy(temporaryIntelligentCharId))
			{
				if (TryGetElement_Objects(temporaryIntelligentCharId, out var element))
				{
					StringBuilder stringBuilder2 = stringBuilder;
					StringBuilder stringBuilder3 = stringBuilder2;
					StringBuilder.AppendInterpolatedStringHandler handler = new StringBuilder.AppendInterpolatedStringHandler(31, 3, stringBuilder2);
					handler.AppendFormatted(element);
					handler.AppendLiteral(" - ");
					handler.AppendLiteral("TemplateId: ");
					handler.AppendFormatted(element.GetTemplateId());
					handler.AppendLiteral(", CreatingType: ");
					handler.AppendFormatted(element.GetCreatingType());
					stringBuilder3.AppendLine(ref handler);
				}
				else
				{
					StringBuilder stringBuilder2 = stringBuilder;
					StringBuilder stringBuilder4 = stringBuilder2;
					StringBuilder.AppendInterpolatedStringHandler handler = new StringBuilder.AppendInterpolatedStringHandler(37, 1, stringBuilder2);
					handler.AppendLiteral("  CharacterId: ");
					handler.AppendFormatted(temporaryIntelligentCharId);
					handler.AppendLiteral(" (Character not found)");
					stringBuilder4.AppendLine(ref handler);
				}
				num++;
			}
		}
		if (num <= 0)
		{
			return;
		}
		throw new Exception(stringBuilder.ToString());
	}

	public int GetWorldPopulation()
	{
		return _objects.Count - _pregeneratedRandomEnemies.Count - _pregeneratedCityTownGuards.Length - _temporaryIntelligentCharIds.Count - _fixedCharactersCache.Count;
	}

	public void ShowCharactersStats()
	{
		int currDate = DomainManager.World.GetCurrDate();
		Logger.Info($"[[{currDate}]] Alive characters: {_objects.Count}, dead characters: {_deadCharacters.Count}");
	}

	public void ShowNonIntelligentCharactersStats()
	{
		List<Character> list = new List<Character>();
		HashSet<int> hashSet = new HashSet<int>();
		hashSet.UnionWith(_pregeneratedRandomEnemies);
		hashSet.UnionWith(_pregeneratedCityTownGuards);
		hashSet.UnionWith(_fixedCharactersCache.Values);
		hashSet.UnionWith(_skeletonCharacterCache.Keys);
		ICollection<int> pregeneratedFixedEnemies = DomainManager.Extra.GetPregeneratedFixedEnemies();
		hashSet.UnionWith(pregeneratedFixedEnemies);
		foreach (KeyValuePair<int, Character> @object in _objects)
		{
			@object.Deconstruct(out var key, out var value);
			int item = key;
			Character character = value;
			short templateId = character.GetTemplateId();
			if (character.GetCreatingType() != 1 && !hashSet.Contains(item))
			{
				list.Add(character);
			}
		}
		int count = list.Count;
		StringBuilder stringBuilder = new StringBuilder($"Non-intelligent characters: {count}\n");
		int num = Math.Min(count, 40);
		for (int i = 0; i < num; i++)
		{
			Character character2 = list[i];
			short templateId2 = character2.GetTemplateId();
			CharacterItem characterItem = Config.Character.Instance[templateId2];
			StringBuilder stringBuilder2 = stringBuilder;
			StringBuilder.AppendInterpolatedStringHandler handler = new StringBuilder.AppendInterpolatedStringHandler(5, 4, stringBuilder2);
			handler.AppendLiteral("  ");
			handler.AppendFormatted(character2.GetId());
			handler.AppendLiteral(": ");
			handler.AppendFormatted(templateId2);
			handler.AppendLiteral("-");
			handler.AppendFormatted(characterItem.Surname);
			handler.AppendFormatted(characterItem.GivenName);
			stringBuilder2.AppendLine(ref handler);
		}
		Logger.Info<StringBuilder>(stringBuilder);
	}
}
